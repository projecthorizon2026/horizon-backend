import React, { useState, useEffect, useMemo, createContext, useContext, useRef, useCallback, memo, lazy, Suspense } from 'react';
import { createPortal } from 'react-dom';
import { SpeedInsights } from '@vercel/speed-insights/react';
// Lightweight charts removed - using native TPO rendering
import GEXPanel from './GEXPanel';
import GEXChart from './GEXChart';
import SessionHeader from './SessionHeader';
import StrategicLevelsTable from './StrategicLevelsTable';
import MarketPulse from './MarketPulse';

// ============================================
// PROJECT HORIZON: UNDERGROUND SETUP DASHBOARD v18.5 - TPO Styling Update
// v2.0 - With Settings Panel & Dynamic Filtering
// ============================================

// API Configuration - uses environment variables in production
const API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:8080';
const REDFOLDER_BASE = import.meta.env.VITE_REDFOLDER_URL || 'http://localhost:8081';
const BUILD_VERSION = '18.7.0';
console.log('Horizon v' + BUILD_VERSION); // Force cache bust - reload required

// Auth Context
const AuthContext = createContext(null);
const useAuth = () => useContext(AuthContext);

// Settings Context for global parameter access
const SettingsContext = createContext(null);
const useSettings = () => useContext(SettingsContext);

// Mobile Detection Context for responsive design
const MobileContext = createContext({ isMobile: false, isTablet: false, screenWidth: 1200 });
const useMobile = () => useContext(MobileContext);

// Custom hook for responsive breakpoints
const useResponsive = () => {
  const [dimensions, setDimensions] = useState({
    width: typeof window !== 'undefined' ? window.innerWidth : 1200,
    height: typeof window !== 'undefined' ? window.innerHeight : 800,
  });

  useEffect(() => {
    const handleResize = () => {
      setDimensions({
        width: window.innerWidth,
        height: window.innerHeight,
      });
    };

    window.addEventListener('resize', handleResize);
    // Set initial dimensions
    handleResize();
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  return {
    isMobile: dimensions.width < 768,
    isTablet: dimensions.width >= 768 && dimensions.width < 1024,
    isDesktop: dimensions.width >= 1024,
    screenWidth: dimensions.width,
    screenHeight: dimensions.height,
  };
};

// Default Strategy Parameters
const DEFAULT_SETTINGS = {
  deltaThreshold: -2500,
  buyingImbalancePct: 400,
  entryTiers: {
    tier1: 25,  // Feeler
    tier2: 40,  // Builder
    tier3: 35,  // Runner
  },
  targetTiers: {
    vwap: 50,      // % allocation to VWAP target
    ibMid: 35,     // % allocation to IB Mid target
    ibHigh: 15,    // % allocation to IB High target
  },
  // Backtest Filters
  filters: {
    grades: { A: true, B: true, C: true, F: true },  // Include F for losing trades
    tiers: { 1: true, 2: true, 3: true },
    minR: -10,  // Show all by default
  },
  // Delta OHLC divergence threshold (0 = always show, >0 = only when delta diverges by this amount)
  divergenceThreshold: 0,
};

// Generate mock trade data (fallback when no real data)
const generateMockTrades = (settings) => {
  const trades = [];
  const startDate = new Date('2025-08-20');
  const endDate = new Date('2025-12-28');
  
  let seed = 12345;
  const seededRandom = () => {
    seed = (seed * 9301 + 49297) % 233280;
    return seed / 233280;
  };
  
  let tradeId = 1;
  let currentDate = new Date(startDate);
  
  while (currentDate <= endDate) {
    if (seededRandom() < 0.35) {
      const grade = seededRandom() < 0.35 ? 'A' : (seededRandom() < 0.65 ? 'B' : 'C');
      const tierNum = seededRandom() < 0.25 ? 1 : (seededRandom() < 0.65 ? 2 : 3);
      const tier = ['I', 'II', 'III'][tierNum - 1];
      const winProb = grade === 'A' ? 0.82 : (grade === 'B' ? 0.71 : 0.52);
      const isWin = seededRandom() < winProb;
      
      const exitReason = !isWin ? 'STOP_LOSS' : 
        seededRandom() < 0.5 ? 'VWAP' : seededRandom() < 0.7 ? 'IB_MID' : 'IB_HIGH';
      
      const contracts = Math.ceil(seededRandom() * 8) + 2;
      const rMultiple = exitReason === 'STOP_LOSS' ? -1 : 1.5 + seededRandom() * 2;
      
      // Realistic GC prices for late 2025 (~$3300-3400)
      const daysSinceStart = (currentDate - startDate) / (1000 * 60 * 60 * 24);
      const baseEntry = 3320 + daysSinceStart * 0.5 + (seededRandom() - 0.5) * 40;
      const pnl = Math.round(rMultiple * 35 * 10 * contracts);
      
      trades.push({
        id: tradeId++,
        date: currentDate.toISOString().split('T')[0],
        entry: Math.round(baseEntry * 100) / 100,
        exit: Math.round((baseEntry + (isWin ? rMultiple * 3.5 : -3.5)) * 100) / 100,
        stop_loss: Math.round((baseEntry - 3.5) * 100) / 100,
        pnl,
        r: Math.round(rMultiple * 10) / 10,
        grade,
        tier: tierNum,
        tierRoman: tier,
        exitReason,
        contracts,
        delta: -1500 - Math.floor(seededRandom() * 3500),
        buyingImbalance: 250 + Math.floor(seededRandom() * 400),
        conditionsMet: grade === 'A' ? 6 : grade === 'B' ? 5 : 4,
        levels: {
          ib_high: Math.round((baseEntry + 15) * 100) / 100,
          ib_low: Math.round((baseEntry - 10) * 100) / 100,
          ib_mid: Math.round((baseEntry + 2.5) * 100) / 100,
          pdpoc: Math.round((baseEntry - 5) * 100) / 100,
          vwap: Math.round((baseEntry + 5) * 100) / 100,
          pd_high: Math.round((baseEntry + 20) * 100) / 100,
          pd_low: Math.round((baseEntry - 15) * 100) / 100
        }
      });
    }
    
    currentDate.setDate(currentDate.getDate() + 1);
    while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
      currentDate.setDate(currentDate.getDate() + 1);
    }
  }
  
  return trades;
};

// Hook to load real backtest data from static JSON file
const useBacktestData = () => {
  const [data, setData] = useState({
    trades: null,
    stats: null,
    source: 'loading',
    metadata: null,
    sessions: null,
    volumeProfiles: null,
    bigVolumeDays: null,
    supportResistance: null,
    seasonality: null,
    dailyCandles: null,
    hourlyCandles: null,
    featureStatistics: null,
    distributions: null
  });

  useEffect(() => {
    const loadData = async () => {
      try {
        // Load from static JSON file in public folder
        const response = await fetch('/backtest_data.json');
        if (response.ok) {
          const json = await response.json();
          if (json.trades && json.trades.length > 0) {
            console.log(`‚úì Loaded ${json.trades.length} trades from ${json.metadata?.data_range?.start || 'backtest_data.json'} to ${json.metadata?.data_range?.end}`);
            setData({
              trades: json.trades,
              stats: json.statistics || json.stats,
              source: 'historical_5y',
              metadata: json.metadata,
              sessions: json.sessions,
              volumeProfiles: json.volume_profiles,
              bigVolumeDays: json.big_volume_days,
              supportResistance: json.support_resistance,
              seasonality: json.seasonality,
              dailyCandles: json.daily_candles,
              hourlyCandles: json.hourly_candles,
              featureStatistics: json.feature_statistics,
              distributions: json.distributions
            });
            return;
          }
        }
      } catch (e) {
        console.log('No backtest_data.json found:', e);
      }

      // Fallback to mock data
      console.log('Using generated mock data (run generate_backtest.py for real data)');
      setData({ trades: null, stats: null, source: 'mock' });
    };

    loadData();
  }, []);

  return data;
};

// Calculate analytics from filtered trades
const calculateAnalytics = (trades, settings) => {
  if (trades.length === 0) {
    return {
      summary: {
        total_trades: 0, winners: 0, losers: 0, win_rate: 0,
        total_pnl: 0, adjusted_pnl: 0, gross_profit: 0, gross_loss: 0, profit_factor: 0,
        avg_win: 0, avg_loss: 0, avg_r_multiple: 0,
        max_drawdown: 0, max_drawdown_pct: 0, final_equity: 1000000
      },
      yearly_pnl: [],
      weekly_pnl: [],
      exit_reasons: { VWAP: 0, IB_MID: 0, IB_HIGH: 0, STOP_LOSS: 0 },
      grade_stats: { A: { trades: 0, winners: 0, pnl: 0, win_rate: 0 }, B: { trades: 0, winners: 0, pnl: 0, win_rate: 0 }, C: { trades: 0, winners: 0, pnl: 0, win_rate: 0 } },
      tier_stats: { TIER_I: { trades: 0, winners: 0, pnl: 0, win_rate: 0 }, TIER_II: { trades: 0, winners: 0, pnl: 0, win_rate: 0 }, TIER_III: { trades: 0, winners: 0, pnl: 0, win_rate: 0 } }
    };
  }

  // Entry tier allocation multipliers (convert % to decimal)
  const tierMultiplier = {
    1: (settings.entryTiers?.tier1 || 25) / 25,  // Normalize to default 25%
    2: (settings.entryTiers?.tier2 || 40) / 40,  // Normalize to default 40%
    3: (settings.entryTiers?.tier3 || 35) / 35   // Normalize to default 35%
  };

  // Target allocation affects profit distribution (for winning trades)
  const targetMultiplier = {
    'VWAP': (settings.targetTiers?.vwap || 50) / 50,
    'IB_MID': (settings.targetTiers?.ibMid || 35) / 35,
    'IB_HIGH': (settings.targetTiers?.ibHigh || 15) / 15,
    'STOP_LOSS': 1  // Losses are not affected by target allocation
  };

  // Calculate adjusted P&L for each trade
  const adjustedTrades = trades.map(t => {
    const entryMult = tierMultiplier[t.tier] || 1;
    const targetMult = t.pnl > 0 ? (targetMultiplier[t.exitReason] || 1) : 1;
    const adjustedPnl = t.pnl * entryMult * targetMult;
    return { ...t, adjustedPnl, originalPnl: t.pnl };
  });

  const winners = adjustedTrades.filter(t => t.adjustedPnl > 0);
  const losers = adjustedTrades.filter(t => t.adjustedPnl <= 0);
  const grossProfit = winners.reduce((sum, t) => sum + t.adjustedPnl, 0);
  const grossLoss = Math.abs(losers.reduce((sum, t) => sum + t.adjustedPnl, 0));
  const totalPnl = grossProfit - grossLoss;
  const originalTotalPnl = trades.reduce((sum, t) => sum + t.pnl, 0);
  
  // Calculate max drawdown with adjusted P&L
  let equity = 1000000;
  let peak = equity;
  let maxDrawdown = 0;
  adjustedTrades.forEach(t => {
    equity += t.adjustedPnl;
    if (equity > peak) peak = equity;
    const drawdown = peak - equity;
    if (drawdown > maxDrawdown) maxDrawdown = drawdown;
  });

  // Yearly aggregation with adjusted P&L
  const yearlyMap = {};
  adjustedTrades.forEach(t => {
    const year = parseInt(t.date.split('-')[0]);
    if (!yearlyMap[year]) yearlyMap[year] = { year, trades: 0, winners: 0, losers: 0, pnl: 0 };
    yearlyMap[year].trades++;
    if (t.adjustedPnl > 0) yearlyMap[year].winners++;
    else yearlyMap[year].losers++;
    yearlyMap[year].pnl += t.adjustedPnl;
  });
  const yearlyPnl = Object.values(yearlyMap).map(y => ({
    ...y,
    win_rate: y.trades > 0 ? y.winners / y.trades : 0
  })).sort((a, b) => a.year - b.year);

  // Weekly aggregation with adjusted P&L
  const weeklyMap = {};
  adjustedTrades.forEach(t => {
    const date = new Date(t.date);
    const year = date.getFullYear();
    const week = Math.ceil((date - new Date(year, 0, 1)) / (7 * 24 * 60 * 60 * 1000));
    const key = `${year}-W${week}`;
    if (!weeklyMap[key]) weeklyMap[key] = { week, year, trades: 0, pnl: 0, winners: 0 };
    weeklyMap[key].trades++;
    weeklyMap[key].pnl += t.adjustedPnl;
    if (t.adjustedPnl > 0) weeklyMap[key].winners++;
  });
  const weeklyPnl = Object.values(weeklyMap).map(w => ({
    ...w,
    win_rate: w.trades > 0 ? w.winners / w.trades : 0
  }));

  // Exit reasons - keys match actual data format
  const exitReasons = { VWAP: 0, IB_MID: 0, IB_HIGH: 0, STOP_LOSS: 0 };
  trades.forEach(t => {
    if (exitReasons[t.exitReason] !== undefined) exitReasons[t.exitReason]++;
  });

  // Grade stats with adjusted P&L
  const gradeStats = { A: { trades: 0, winners: 0, pnl: 0 }, B: { trades: 0, winners: 0, pnl: 0 }, C: { trades: 0, winners: 0, pnl: 0 } };
  adjustedTrades.forEach(t => {
    if (gradeStats[t.grade]) {
      gradeStats[t.grade].trades++;
      if (t.adjustedPnl > 0) gradeStats[t.grade].winners++;
      gradeStats[t.grade].pnl += t.adjustedPnl;
    }
  });
  Object.keys(gradeStats).forEach(g => {
    gradeStats[g].win_rate = gradeStats[g].trades > 0 ? gradeStats[g].winners / gradeStats[g].trades : 0;
  });

  // Tier stats with adjusted P&L
  const tierStats = { TIER_I: { trades: 0, winners: 0, pnl: 0 }, TIER_II: { trades: 0, winners: 0, pnl: 0 }, TIER_III: { trades: 0, winners: 0, pnl: 0 } };
  adjustedTrades.forEach(t => {
    const tierKey = ["TIER_I", "TIER_II", "TIER_III"][t.tier - 1] || "TIER_I";
    tierStats[tierKey].trades++;
    if (t.adjustedPnl > 0) tierStats[tierKey].winners++;
    tierStats[tierKey].pnl += t.adjustedPnl;
  });
  Object.keys(tierStats).forEach(t => {
    tierStats[t].win_rate = tierStats[t].trades > 0 ? tierStats[t].winners / tierStats[t].trades : 0;
  });

  return {
    summary: {
      total_trades: trades.length,
      winners: winners.length,
      losers: losers.length,
      win_rate: trades.length > 0 ? winners.length / trades.length : 0,
      total_pnl: totalPnl,
      original_pnl: originalTotalPnl,
      pnl_difference: totalPnl - originalTotalPnl,
      gross_profit: grossProfit,
      gross_loss: -grossLoss,
      profit_factor: grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? Infinity : 0,
      avg_win: winners.length > 0 ? grossProfit / winners.length : 0,
      avg_loss: losers.length > 0 ? -grossLoss / losers.length : 0,
      avg_r_multiple: trades.length > 0 ? trades.reduce((sum, t) => sum + t.r, 0) / trades.length : 0,
      max_drawdown: maxDrawdown,
      max_drawdown_pct: peak > 0 ? maxDrawdown / peak : 0,
      final_equity: 1000000 + totalPnl
    },
    yearly_pnl: yearlyPnl,
    weekly_pnl: weeklyPnl,
    exit_reasons: exitReasons,
    grade_stats: gradeStats,
    tier_stats: tierStats
  };
};

// Custom Hooks
const useLocalStorage = (key, initialValue) => {
  const [value, setValue] = useState(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch {
      return initialValue;
    }
  });

  useEffect(() => {
    window.localStorage.setItem(key, JSON.stringify(value));
  }, [key, value]);

  return [value, setValue];
};

// ============================================
// COMPONENTS
// ============================================

// TOTP 2FA Implementation
const TOTP_SECRET = 'JBSWY3DPEHPK3PXP'; // Base32 encoded secret for authenticator app

// Generate TOTP code (RFC 6238)
const generateTOTP = (secret, timeStep = 30) => {
  const base32Decode = (str) => {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = '';
    for (let i = 0; i < str.length; i++) {
      const val = alphabet.indexOf(str.charAt(i).toUpperCase());
      if (val === -1) continue;
      bits += val.toString(2).padStart(5, '0');
    }
    const bytes = [];
    for (let i = 0; i + 8 <= bits.length; i += 8) {
      bytes.push(parseInt(bits.substr(i, 8), 2));
    }
    return new Uint8Array(bytes);
  };

  const hmacSha1 = async (key, message) => {
    const cryptoKey = await crypto.subtle.importKey(
      'raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']
    );
    const signature = await crypto.subtle.sign('HMAC', cryptoKey, message);
    return new Uint8Array(signature);
  };

  let counter = Math.floor(Date.now() / 1000 / timeStep);
  const counterBytes = new Uint8Array(8);
  for (let i = 7; i >= 0; i--) {
    counterBytes[i] = counter & 0xff;
    counter >>= 8;
  }

  return hmacSha1(base32Decode(secret), counterBytes).then(hash => {
    const offset = hash[hash.length - 1] & 0x0f;
    const binary = ((hash[offset] & 0x7f) << 24) |
                   ((hash[offset + 1] & 0xff) << 16) |
                   ((hash[offset + 2] & 0xff) << 8) |
                   (hash[offset + 3] & 0xff);
    return (binary % 1000000).toString().padStart(6, '0');
  });
};

// Verify TOTP with 1 step tolerance (allows for clock drift)
const verifyTOTP = async (code, secret = TOTP_SECRET) => {
  const timeSteps = [-1, 0, 1]; // Check previous, current, and next time step
  for (const offset of timeSteps) {
    const counter = Math.floor(Date.now() / 1000 / 30) + offset;
    const counterBytes = new Uint8Array(8);
    let c = counter;
    for (let i = 7; i >= 0; i--) {
      counterBytes[i] = c & 0xff;
      c = Math.floor(c / 256);
    }

    const base32Decode = (str) => {
      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      let bits = '';
      for (let i = 0; i < str.length; i++) {
        const val = alphabet.indexOf(str.charAt(i).toUpperCase());
        if (val === -1) continue;
        bits += val.toString(2).padStart(5, '0');
      }
      const bytes = [];
      for (let i = 0; i + 8 <= bits.length; i += 8) {
        bytes.push(parseInt(bits.substr(i, 8), 2));
      }
      return new Uint8Array(bytes);
    };

    try {
      const key = base32Decode(secret);
      const cryptoKey = await crypto.subtle.importKey(
        'raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']
      );
      const hash = new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, counterBytes));
      const offset = hash[hash.length - 1] & 0x0f;
      const binary = ((hash[offset] & 0x7f) << 24) |
                     ((hash[offset + 1] & 0xff) << 16) |
                     ((hash[offset + 2] & 0xff) << 8) |
                     (hash[offset + 3] & 0xff);
      const expectedCode = (binary % 1000000).toString().padStart(6, '0');
      if (code === expectedCode) return true;
    } catch (e) {
      console.error('TOTP verification error:', e);
    }
  }
  return false;
};

// Login Component with 2FA
const LoginPage = ({ onLogin }) => {
  const [credentials, setCredentials] = useState({ username: '', password: '' });
  const [totpCode, setTotpCode] = useState('');
  const [step, setStep] = useState(1); // 1 = credentials, 2 = TOTP
  const [showSetup, setShowSetup] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleCredentialsSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    await new Promise(r => setTimeout(r, 500));
    if (credentials.username === 'horizon' && credentials.password === '[i68E[4S1k,4') {
      setStep(2); // Move to 2FA step
    } else {
      setError('Invalid credentials');
    }
    setLoading(false);
  };

  const handleTOTPSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    const isValid = await verifyTOTP(totpCode);
    if (isValid) {
      onLogin({ username: credentials.username, role: 'trader' });
    } else {
      setError('Invalid 2FA code. Please try again.');
    }
    setLoading(false);
  };

  // QR Code URL for authenticator app setup
  const qrCodeUrl = `otpauth://totp/ProjectHorizon:horizon?secret=${TOTP_SECRET}&issuer=ProjectHorizon&algorithm=SHA1&digits=6&period=30`;
  const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrCodeUrl)}`;

  return (
    <div style={styles.loginContainer}>
      <div style={styles.loginCard}>
        <div style={styles.loginHeader}>
          <div style={styles.logo}>
            <div style={styles.logoIcon}>
              <svg width="36" height="36" viewBox="0 0 40 40" fill="none">
                <rect x="4" y="4" width="32" height="32" rx="8" stroke="#00ff88" strokeWidth="2" fill="rgba(0,255,136,0.1)"/>
                <path d="M20 12L28 20L20 28L12 20L20 12Z" fill="#00ff88"/>
                <circle cx="20" cy="20" r="4" fill="#0a0a0f"/>
              </svg>
            </div>
            <span style={styles.logoText}>PROJECT HORIZON</span>
          </div>
          <p style={styles.loginSubtitle}>Not the, 1%.</p>
        </div>

        {step === 1 ? (
          <form onSubmit={handleCredentialsSubmit} style={styles.loginForm}>
            <div style={styles.inputGroup}>
              <label style={styles.inputLabel}>Username</label>
              <input
                type="text"
                value={credentials.username}
                onChange={(e) => setCredentials({ ...credentials, username: e.target.value })}
                style={styles.input}
                placeholder="Enter username"
              />
            </div>
            <div style={styles.inputGroup}>
              <label style={styles.inputLabel}>Password</label>
              <input
                type="password"
                value={credentials.password}
                onChange={(e) => setCredentials({ ...credentials, password: e.target.value })}
                style={styles.input}
                placeholder="Enter password"
              />
            </div>
            {error && <div style={styles.error}>{error}</div>}
            <button type="submit" style={styles.loginButton} disabled={loading}>
              {loading ? 'Verifying...' : 'Continue'}
            </button>
          </form>
        ) : (
          <div style={styles.loginForm}>
            {showSetup ? (
              <div style={{ textAlign: 'center' }}>
                <p style={{ color: '#888', marginBottom: 16, fontSize: 13 }}>
                  Scan this QR code with your authenticator app:
                </p>
                <img
                  src={qrImageUrl}
                  alt="2FA QR Code"
                  style={{
                    width: 180,
                    height: 180,
                    borderRadius: 8,
                    marginBottom: 16,
                    background: '#fff',
                    padding: 8
                  }}
                />
                <p style={{ color: '#666', fontSize: 11, marginBottom: 8 }}>
                  Or enter manually: <code style={{ color: '#00ff88', background: 'rgba(0,255,136,0.1)', padding: '2px 6px', borderRadius: 4 }}>{TOTP_SECRET}</code>
                </p>
                <button
                  onClick={() => setShowSetup(false)}
                  style={{ ...styles.loginButton, marginTop: 16 }}
                >
                  I've Added It
                </button>
              </div>
            ) : (
              <form onSubmit={handleTOTPSubmit}>
                <div style={{ textAlign: 'center', marginBottom: 24 }}>
                  <div style={{
                    width: 64,
                    height: 64,
                    borderRadius: '50%',
                    background: 'rgba(0,255,136,0.1)',
                    border: '2px solid #00ff88',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    margin: '0 auto 20px',
                  }}>
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00ff88" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                  </div>
                  <p style={{ color: '#fff', fontSize: 15, fontWeight: 600, fontFamily: "'Inter', sans-serif", marginBottom: 6 }}>Two-Factor Authentication</p>
                  <p style={{ color: '#888', fontSize: 12, fontFamily: "'Inter', sans-serif" }}>Enter the 6-digit code from your authenticator app</p>
                </div>
                <div style={{ display: 'flex', justifyContent: 'center', gap: 8, marginBottom: 20 }}>
                  {[0, 1, 2, 3, 4, 5].map((index) => (
                    <input
                      key={index}
                      id={`totp-${index}`}
                      type="text"
                      inputMode="numeric"
                      maxLength={1}
                      value={totpCode[index] || ''}
                      onChange={(e) => {
                        const val = e.target.value.replace(/\D/g, '');
                        if (val.length <= 1) {
                          const newCode = totpCode.split('');
                          newCode[index] = val;
                          setTotpCode(newCode.join('').slice(0, 6));
                          if (val && index < 5) {
                            document.getElementById(`totp-${index + 1}`)?.focus();
                          }
                        }
                      }}
                      onKeyDown={(e) => {
                        if (e.key === 'Backspace' && !totpCode[index] && index > 0) {
                          document.getElementById(`totp-${index - 1}`)?.focus();
                        }
                      }}
                      onPaste={(e) => {
                        e.preventDefault();
                        const pasted = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
                        setTotpCode(pasted);
                        const focusIndex = Math.min(pasted.length, 5);
                        document.getElementById(`totp-${focusIndex}`)?.focus();
                      }}
                      style={{
                        width: 48,
                        height: 56,
                        textAlign: 'center',
                        fontSize: 24,
                        fontFamily: '"SF Mono", "JetBrains Mono", "Fira Code", Consolas, monospace',
                        fontWeight: 600,
                        background: 'rgba(0,0,0,0.5)',
                        border: totpCode[index] ? '2px solid #00ff88' : '2px solid rgba(255,255,255,0.15)',
                        borderRadius: 10,
                        color: '#fff',
                        outline: 'none',
                        transition: 'border-color 0.2s, box-shadow 0.2s',
                        boxShadow: totpCode[index] ? '0 0 10px rgba(0,255,136,0.2)' : 'none'
                      }}
                      onFocus={(e) => e.target.style.borderColor = '#00ff88'}
                      onBlur={(e) => e.target.style.borderColor = totpCode[index] ? '#00ff88' : 'rgba(255,255,255,0.15)'}
                      autoFocus={index === 0}
                    />
                  ))}
                </div>
                {error && <div style={styles.error}>{error}</div>}
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                  <button type="submit" style={{ ...styles.loginButton, width: '200px' }} disabled={loading || totpCode.length !== 6}>
                    {loading ? 'Verifying...' : 'VERIFY & LOGIN'}
                  </button>
                  <div style={{ width: '200px', display: 'flex', justifyContent: 'flex-end', marginTop: 10 }}>
                    <button
                      type="button"
                      onClick={() => { setStep(1); setError(''); setTotpCode(''); }}
                      style={{
                        background: 'transparent',
                        border: 'none',
                        color: '#666',
                        fontSize: 11,
                        cursor: 'pointer',
                        fontFamily: "'Inter', sans-serif"
                      }}
                    >
                      ‚Üê Back to login
                    </button>
                  </div>
                </div>
              </form>
            )}
          </div>
        )}

        <div style={styles.loginFooter}>
          <p style={styles.footerText}>2FA Protected</p>
        </div>
      </div>
    </div>
  );
};

// ============================================
// CORRELATION MATRIX COMPONENT
// ============================================
const CorrelationMatrix = () => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [priceTimeframe, setPriceTimeframe] = useState('1D');
  const [correlationTimeframe, setCorrelationTimeframe] = useState('1M');
  const [hoveredStock, setHoveredStock] = useState(null);
  const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });
  const { isMobile, isTablet } = useResponsive();

  // Fallback correlation data (used when API doesn't return correlations)
  const fallbackCorrelations = {
    '1D': {
      'GC': { 'GC': 1.00, 'SI': 0.92, 'CHF': 0.70, 'JPY': 0.66, 'US10Y': -0.44, 'DXY': -0.82 },
      'SI': { 'GC': 0.92, 'SI': 1.00, 'CHF': 0.62, 'JPY': 0.56, 'US10Y': -0.38, 'DXY': -0.74 },
      'CHF': { 'GC': 0.70, 'SI': 0.62, 'CHF': 1.00, 'JPY': 0.76, 'US10Y': -0.32, 'DXY': -0.86 },
      'JPY': { 'GC': 0.66, 'SI': 0.56, 'JPY': 1.00, 'CHF': 0.76, 'US10Y': -0.28, 'DXY': -0.72 },
      'US10Y': { 'GC': -0.44, 'SI': -0.38, 'CHF': -0.32, 'JPY': -0.28, 'US10Y': 1.00, 'DXY': 0.54 },
      'DXY': { 'GC': -0.82, 'SI': -0.74, 'CHF': -0.86, 'JPY': -0.72, 'US10Y': 0.54, 'DXY': 1.00 },
    },
    '1W': {
      'GC': { 'GC': 1.00, 'SI': 0.94, 'CHF': 0.74, 'JPY': 0.70, 'US10Y': -0.48, 'DXY': -0.85 },
      'SI': { 'GC': 0.94, 'SI': 1.00, 'CHF': 0.66, 'JPY': 0.60, 'US10Y': -0.42, 'DXY': -0.78 },
      'CHF': { 'GC': 0.74, 'SI': 0.66, 'CHF': 1.00, 'JPY': 0.80, 'US10Y': -0.36, 'DXY': -0.90 },
      'JPY': { 'GC': 0.70, 'SI': 0.60, 'JPY': 1.00, 'CHF': 0.80, 'US10Y': -0.32, 'DXY': -0.76 },
      'US10Y': { 'GC': -0.48, 'SI': -0.42, 'CHF': -0.36, 'JPY': -0.32, 'US10Y': 1.00, 'DXY': 0.58 },
      'DXY': { 'GC': -0.85, 'SI': -0.78, 'CHF': -0.90, 'JPY': -0.76, 'US10Y': 0.58, 'DXY': 1.00 },
    },
    '1M': {
      'GC': { 'GC': 1.00, 'SI': 0.96, 'CHF': 0.78, 'JPY': 0.74, 'US10Y': -0.52, 'DXY': -0.88 },
      'SI': { 'GC': 0.96, 'SI': 1.00, 'CHF': 0.70, 'JPY': 0.64, 'US10Y': -0.46, 'DXY': -0.82 },
      'CHF': { 'GC': 0.78, 'SI': 0.70, 'CHF': 1.00, 'JPY': 0.84, 'US10Y': -0.40, 'DXY': -0.92 },
      'JPY': { 'GC': 0.74, 'SI': 0.64, 'JPY': 1.00, 'CHF': 0.84, 'US10Y': -0.36, 'DXY': -0.80 },
      'US10Y': { 'GC': -0.52, 'SI': -0.46, 'CHF': -0.40, 'JPY': -0.36, 'US10Y': 1.00, 'DXY': 0.62 },
      'DXY': { 'GC': -0.88, 'SI': -0.82, 'CHF': -0.92, 'JPY': -0.80, 'US10Y': 0.62, 'DXY': 1.00 },
    },
  };

  // Fetch live market data from API
  useEffect(() => {
    let isMounted = true;

    const fetchMarketData = async () => {
      try {
        setLoading(true);
        const response = await fetch(`${API_BASE}/market-overview`);
        if (!response.ok) throw new Error('Failed to fetch market data');
        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        if (isMounted && result.sectors) {
          // Use live correlations from API, fallback to static data
          const correlations = result.correlations || fallbackCorrelations;
          setData({ sectors: result.sectors, correlationsByTimeframe: correlations });
          setError(null);
        }
      } catch (err) {
        console.error('Market data fetch error:', err);
        if (isMounted) {
          setError(err.message);
        }
      } finally {
        if (isMounted) setLoading(false);
      }
    };

    fetchMarketData();
    // Refresh every 30 seconds
    const interval = setInterval(fetchMarketData, 30000);

    return () => {
      isMounted = false;
      clearInterval(interval);
    };
  }, []);

  // Get change based on selected timeframe
  const getChange = (stock) => {
    if (priceTimeframe === '1D') return stock.change1D || 0;
    if (priceTimeframe === '1W') return stock.change1W || 0;
    return stock.change1M || 0;
  };

  // Get previous OHLC based on selected timeframe
  const getPrevOHLC = (stock) => {
    if (priceTimeframe === '1D') return stock.prev1D;
    if (priceTimeframe === '1W') return stock.prev1W;
    return stock.prev1M;
  };

  // Get color based on change
  const getChangeColor = (change) => {
    if (change > 2) return '#00ff88';
    if (change > 0) return '#4ade80';
    if (change > -1) return '#f87171';
    if (change > -2) return '#ef4444';
    return '#dc2626';
  };

  // Format price with appropriate decimals
  const formatPrice = (price, symbol) => {
    if (!price || isNaN(price)) return '‚Äî';
    if (symbol?.includes('6J')) return price.toFixed(4);
    if (symbol?.includes('6') || symbol?.includes('DX')) return price.toFixed(4);
    if (symbol?.includes('US') && !symbol?.includes('USD')) return price.toFixed(2) + '%';
    if (price > 1000) return price.toFixed(2);
    if (price > 10) return price.toFixed(2);
    return price.toFixed(4);
  };

  // Get timeframe label
  const getTimeframeLabel = () => {
    if (priceTimeframe === '1D') return 'vs Yesterday';
    if (priceTimeframe === '1W') return 'vs Last Week';
    return 'vs Last Month';
  };

  // Get previous period label
  const getPrevLabel = () => {
    if (priceTimeframe === '1D') return 'Yesterday';
    if (priceTimeframe === '1W') return 'Last Week';
    return 'Last Month';
  };

  if (loading && !data) {
    return (
      <div style={{ padding: 40, textAlign: 'center', color: '#888' }}>
        <div style={{ fontSize: 24, marginBottom: 8 }}>‚è≥</div>
        Loading live market data...
      </div>
    );
  }

  if (!data) {
    return (
      <div style={{ padding: 40, textAlign: 'center', color: '#888' }}>
        <div style={{ fontSize: 24, marginBottom: 8 }}>‚ö†Ô∏è</div>
        No market data available
      </div>
    );
  }

  return (
    <div style={{ maxWidth: 1400, margin: '0 auto', padding: isMobile ? 12 : 0 }}>
      {/* Header */}
      <div style={{
        display: 'flex',
        flexDirection: isMobile ? 'column' : 'row',
        justifyContent: 'space-between',
        alignItems: isMobile ? 'flex-start' : 'center',
        marginBottom: isMobile ? 16 : 24,
        gap: isMobile ? 12 : 16
      }}>
        <div>
          <h2 style={{ margin: 0, color: '#fff', fontSize: isMobile ? 16 : 20 }}>
            {isMobile ? 'Correlation Matrix' : 'üìä Correlation Matrix'}
          </h2>
          <p style={{ margin: '8px 0 0 0', color: '#888', fontSize: isMobile ? 11 : 13 }}>
            Futures price change {getTimeframeLabel()} ‚Ä¢ Color = % Change
          </p>
        </div>
        {/* Timeframe Buttons */}
        <div style={{ display: 'flex', gap: 4 }}>
          {['1D', '1W', '1M'].map(tf => (
            <button
              key={tf}
              onClick={() => setPriceTimeframe(tf)}
              style={{
                padding: isMobile ? '6px 12px' : '8px 16px',
                borderRadius: 6,
                border: priceTimeframe === tf ? '1px solid #00ff88' : '1px solid rgba(255,255,255,0.1)',
                background: priceTimeframe === tf ? 'rgba(0,255,136,0.15)' : 'rgba(255,255,255,0.03)',
                color: priceTimeframe === tf ? '#00ff88' : '#888',
                fontWeight: 600,
                fontSize: isMobile ? 10 : 12,
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
            >
              {tf}
            </button>
          ))}
        </div>
      </div>

      {/* Error Message */}
      {error && (
        <div style={{
          padding: 16,
          marginBottom: 16,
          background: 'rgba(239, 68, 68, 0.1)',
          border: '1px solid rgba(239, 68, 68, 0.3)',
          borderRadius: 8,
          color: '#ff6b6b',
          fontSize: 13
        }}>
          ‚ö†Ô∏è {error} - Install yfinance: pip install yfinance
        </div>
      )}

      {/* Asset Classes Grid - 2 column layout */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)',
        gap: isMobile ? 8 : 12,
        marginBottom: isMobile ? 16 : 24
      }}>
        {data?.sectors?.map((sector) => (
          <div key={sector.name} style={{
            padding: 14,
            background: 'rgba(255,255,255,0.02)',
            borderRadius: 12,
            border: '1px solid rgba(255,255,255,0.08)',
            borderLeft: `3px solid ${sector.color}`
          }}>
            {/* Sector Header */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              marginBottom: 10
            }}>
              <div style={{
                width: 6,
                height: 6,
                borderRadius: '50%',
                background: sector.color
              }} />
              <span style={{
                fontSize: 11,
                fontWeight: 600,
                color: sector.color,
                textTransform: 'uppercase',
                letterSpacing: 0.5
              }}>
                {sector.name}
              </span>
            </div>

            {/* Stocks Grid */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: `repeat(${Math.min(sector.stocks.length, 5)}, 1fr)`,
              gap: 6
            }}>
              {sector.stocks.map((stock) => {
                const change = getChange(stock);
                const isHovered = hoveredStock?.symbol === stock.symbol;

                return (
                  <div
                    key={stock.symbol}
                    style={{
                      position: 'relative',
                      padding: '8px 10px',
                      borderRadius: 6,
                      background: getChangeColor(change),
                      cursor: 'pointer',
                      transition: 'all 0.2s ease',
                      transform: isHovered ? 'scale(1.05)' : 'scale(1)',
                      boxShadow: isHovered ? '0 4px 20px rgba(0,0,0,0.4)' : 'none',
                      textAlign: 'center'
                    }}
                    onMouseEnter={(e) => {
                      const rect = e.currentTarget.getBoundingClientRect();
                      setHoveredStock({ ...stock, sectorName: sector.name, sectorColor: sector.color });
                      setTooltipPos({ x: rect.left + rect.width / 2, y: rect.top });
                    }}
                    onMouseLeave={() => setHoveredStock(null)}
                  >
                    <div style={{ fontSize: 11, fontWeight: 700, color: '#000', marginBottom: 2 }}>
                      {stock.symbol}
                    </div>
                    <div style={{ fontSize: 13, fontWeight: 700, color: '#000' }}>
                      {change >= 0 ? '+' : ''}{change.toFixed(2)}%
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ))}
      </div>

      {/* Beautiful Custom Tooltip - positioned to stay within viewport */}
      {hoveredStock && (
        <div style={{
          position: 'fixed',
          left: Math.max(20, Math.min(tooltipPos.x - 150, window.innerWidth - 320)),
          top: tooltipPos.y + 60,
          background: 'linear-gradient(135deg, rgba(20,20,28,0.98) 0%, rgba(15,15,20,0.98) 100%)',
          border: `1px solid ${hoveredStock.sectorColor}40`,
          borderRadius: 12,
          padding: 0,
          zIndex: 1000,
          boxShadow: `0 8px 32px rgba(0,0,0,0.6), 0 0 20px ${hoveredStock.sectorColor}20`,
          minWidth: 280,
          maxWidth: 300,
          pointerEvents: 'none',
          overflow: 'hidden'
        }}>
          {/* Tooltip Header */}
          <div style={{
            padding: '12px 16px',
            background: `${hoveredStock.sectorColor}15`,
            borderBottom: `1px solid ${hoveredStock.sectorColor}30`,
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div>
              <div style={{ fontSize: 14, fontWeight: 700, color: '#fff' }}>{hoveredStock.name}</div>
              <div style={{ fontSize: 11, color: hoveredStock.sectorColor, marginTop: 2 }}>{hoveredStock.sectorName}</div>
            </div>
            <div style={{
              fontSize: 18,
              fontWeight: 700,
              color: getChange(hoveredStock) >= 0 ? '#00ff88' : '#ff4466'
            }}>
              {getChange(hoveredStock) >= 0 ? '+' : ''}{getChange(hoveredStock).toFixed(2)}%
            </div>
          </div>

          {/* OHLC Data */}
          <div style={{ padding: '12px 16px' }}>
            {/* Current Period */}
            {(() => {
              const curr = hoveredStock.current || {};
              const isBullish = curr.c >= curr.o;
              const candleColor = isBullish ? '#00ff88' : '#ff4466';
              return (
                <div style={{
                  marginBottom: 8,
                  padding: '8px 10px',
                  borderRadius: 6,
                  background: isBullish ? 'rgba(0,255,136,0.08)' : 'rgba(255,68,102,0.08)',
                  border: `1px solid ${candleColor}30`
                }}>
                  <div style={{
                    fontSize: 9,
                    color: candleColor,
                    marginBottom: 4,
                    textTransform: 'uppercase',
                    letterSpacing: 0.5,
                    fontWeight: 600
                  }}>
                    {isBullish ? '‚ñ≤' : '‚ñº'} Current
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 6 }}>
                    {['O', 'H', 'L', 'C'].map((label) => {
                      const val = curr[label.toLowerCase()];
                      const textColor = label === 'H' && isBullish ? '#00ff88' :
                                       label === 'L' && !isBullish ? '#ff4466' : '#fff';
                      return (
                        <div key={label} style={{ textAlign: 'center' }}>
                          <div style={{ fontSize: 8, color: '#555', marginBottom: 1 }}>{label}</div>
                          <div style={{ fontSize: 10, color: textColor, fontFamily: 'monospace', fontWeight: 600 }}>
                            {formatPrice(val, hoveredStock.symbol)}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })()}

            {/* Previous Period */}
            {(() => {
              const prev = getPrevOHLC(hoveredStock) || {};
              const isBullish = prev.c >= prev.o;
              const candleColor = isBullish ? '#00ff88' : '#ff4466';
              return (
                <div style={{
                  padding: '8px 10px',
                  borderRadius: 6,
                  background: isBullish ? 'rgba(0,255,136,0.05)' : 'rgba(255,68,102,0.05)',
                  border: `1px solid ${candleColor}20`
                }}>
                  <div style={{
                    fontSize: 9,
                    color: candleColor,
                    marginBottom: 4,
                    textTransform: 'uppercase',
                    letterSpacing: 0.5,
                    opacity: 0.8,
                    fontWeight: 600
                  }}>
                    {isBullish ? '‚ñ≤' : '‚ñº'} {getPrevLabel()}
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 6 }}>
                    {['O', 'H', 'L', 'C'].map((label) => {
                      const val = prev[label.toLowerCase()];
                      const textColor = label === 'H' && isBullish ? '#00ff88' :
                                       label === 'L' && !isBullish ? '#ff4466' : '#aaa';
                      return (
                        <div key={label} style={{ textAlign: 'center' }}>
                          <div style={{ fontSize: 8, color: '#555', marginBottom: 1 }}>{label}</div>
                          <div style={{ fontSize: 10, color: textColor, fontFamily: 'monospace' }}>
                            {formatPrice(val, hoveredStock.symbol)}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })()}
          </div>

          {/* Footer */}
          <div style={{
            padding: '8px 16px',
            background: 'rgba(0,0,0,0.3)',
            fontSize: 10,
            color: '#666',
            textAlign: 'center'
          }}>
            Live data from Yahoo Finance
          </div>
        </div>
      )}

      {/* Legend */}
      <div style={{
        display: 'flex',
        justifyContent: 'center',
        gap: 24,
        padding: 16,
        background: 'rgba(255,255,255,0.02)',
        borderRadius: 12,
        marginBottom: 24
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <div style={{ width: 16, height: 16, borderRadius: 4, background: '#dc2626' }} />
          <span style={{ color: '#888', fontSize: 12 }}>{'< -2%'}</span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <div style={{ width: 16, height: 16, borderRadius: 4, background: '#f87171' }} />
          <span style={{ color: '#888', fontSize: 12 }}>-2% to 0%</span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <div style={{ width: 16, height: 16, borderRadius: 4, background: '#4ade80' }} />
          <span style={{ color: '#888', fontSize: 12 }}>0% to +2%</span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          <div style={{ width: 16, height: 16, borderRadius: 4, background: '#00ff88' }} />
          <span style={{ color: '#888', fontSize: 12 }}>{'>+2%'}</span>
        </div>
      </div>

      {/* Correlation Matrix */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        borderRadius: 16,
        padding: 24,
        border: '1px solid rgba(255,255,255,0.1)'
      }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
          <h3 style={{ margin: 0, color: '#fff', fontSize: 16, display: 'flex', alignItems: 'center', gap: 10 }}>
            üìä GC & SI Correlation Matrix ({correlationTimeframe === '30m' ? '30 Minutes' : correlationTimeframe === '1H' ? '1 Hour' : correlationTimeframe === '4H' ? '4 Hours' : correlationTimeframe === '1D' ? '1 Day' : correlationTimeframe === '1W' ? '1 Week' : '1 Month'})
            <span style={{
              fontSize: 10,
              fontWeight: 600,
              color: '#00ff88',
              background: 'rgba(0,255,136,0.1)',
              padding: '3px 8px',
              borderRadius: 4,
              border: '1px solid rgba(0,255,136,0.3)',
              letterSpacing: 0.5
            }}>‚óè LIVE</span>
          </h3>
          <div style={{ display: 'flex', gap: 4 }}>
            {['1D', '1W', '1M'].map(tf => (
              <button
                key={tf}
                onClick={() => setCorrelationTimeframe(tf)}
                style={{
                  padding: '6px 12px',
                  borderRadius: 6,
                  border: correlationTimeframe === tf ? '1px solid #00aaff' : '1px solid rgba(255,255,255,0.1)',
                  background: correlationTimeframe === tf ? 'rgba(0,170,255,0.15)' : 'rgba(255,255,255,0.03)',
                  color: correlationTimeframe === tf ? '#00aaff' : '#888',
                  fontWeight: 600,
                  fontSize: 11,
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                {tf}
              </button>
            ))}
          </div>
        </div>
        <div style={{ overflowX: 'auto' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: 500 }}>
            <thead>
              <tr>
                <th style={{ padding: 12, textAlign: 'left', color: '#888', fontSize: 12 }}></th>
                {['GC', 'SI', 'CHF', 'JPY', 'US10Y', 'DXY'].map(sym => (
                  <th key={sym} style={{
                    padding: 12,
                    textAlign: 'center',
                    color: sym === 'GC' ? '#FFD700' : sym === 'SI' ? '#C0C0C0' : '#fff',
                    fontSize: 12,
                    fontWeight: 600
                  }}>
                    {sym === 'CHF' ? 'üá®üá≠ CHF' : sym === 'JPY' ? 'üáØüáµ JPY' : sym === 'US10Y' ? 'üìà 10Y' : sym === 'DXY' ? 'üíµ DXY' : sym === 'GC' ? 'ü•á GC' : 'ü•à SI'}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {['GC', 'SI', 'CHF', 'JPY', 'US10Y', 'DXY'].map(row => (
                <tr key={row}>
                  <td style={{
                    padding: 12,
                    color: row === 'GC' ? '#FFD700' : row === 'SI' ? '#C0C0C0' : '#fff',
                    fontSize: 12,
                    fontWeight: 600
                  }}>
                    {row === 'CHF' ? 'üá®üá≠ Swiss' : row === 'JPY' ? 'üáØüáµ Yen' : row === 'US10Y' ? 'üìà Yield' : row === 'DXY' ? 'üíµ DXY' : row === 'GC' ? 'ü•á Gold' : 'ü•à Silver'}
                  </td>
                  {['GC', 'SI', 'CHF', 'JPY', 'US10Y', 'DXY'].map(col => {
                    const corr = data.correlationsByTimeframe?.[correlationTimeframe]?.[row]?.[col] ?? 0;
                    const intensity = Math.abs(corr);
                    const isNegative = corr < 0;
                    const bgColor = corr === 1 
                      ? 'rgba(100,100,100,0.3)' 
                      : isNegative
                        ? `rgba(255,68,102,${intensity * 0.4})`
                        : corr > 0.7 
                          ? `rgba(0,255,136,${intensity * 0.4})` 
                          : corr > 0.3 
                            ? `rgba(0,255,136,${intensity * 0.25})`
                            : `rgba(255,170,0,${intensity * 0.3})`;
                    return (
                      <td 
                        key={col} 
                        style={{ 
                          padding: 12, 
                          textAlign: 'center',
                          background: bgColor,
                          color: corr === 1 ? '#888' : isNegative ? '#ff4466' : corr > 0.5 ? '#00ff88' : '#ffaa00',
                          fontSize: 13,
                          fontWeight: 600,
                          border: '1px solid rgba(255,255,255,0.05)'
                        }}
                      >
                        {corr >= 0 ? '+' : ''}{corr.toFixed(2)}
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        <div style={{ marginTop: 12, fontSize: 11, color: '#666', textAlign: 'center' }}>
          üü¢ Green = Positive correlation | üî¥ Red = Negative correlation (inverse relationship)
        </div>
      </div>
    </div>
  );
};

// ============================================
// VSI (VOLATILITY STRENGTH INDEX) COMPONENT
// ============================================
// Price Ladder Component - Add this to App.jsx

// Styled Tooltip Component for institutional data
const Tooltip = ({ children, content, position = 'top' }) => {
  const [show, setShow] = useState(false);
  const [coords, setCoords] = useState({ x: 0, y: 0 });
  const triggerRef = React.useRef(null);

  const handleMouseEnter = (e) => {
    const rect = e.currentTarget.getBoundingClientRect();
    setCoords({
      x: rect.left + rect.width / 2,
      y: position === 'top' ? rect.top : rect.bottom
    });
    setShow(true);
  };

  return (
    <div
      ref={triggerRef}
      onMouseEnter={handleMouseEnter}
      onMouseLeave={() => setShow(false)}
      style={{ position: 'relative', display: 'inline-block', width: '100%' }}
    >
      {children}
      {show && content && (
        <div style={{
          position: 'fixed',
          left: coords.x,
          top: position === 'top' ? coords.y - 8 : coords.y + 8,
          transform: position === 'top' ? 'translate(-50%, -100%)' : 'translate(-50%, 0)',
          background: 'rgba(20, 22, 28, 0.98)',
          border: '1px solid rgba(255,255,255,0.15)',
          borderRadius: 6,
          padding: '8px 12px',
          fontSize: 10,
          color: '#ccc',
          whiteSpace: 'pre-line',
          zIndex: 9999,
          pointerEvents: 'none',
          boxShadow: '0 4px 20px rgba(0,0,0,0.5)',
          minWidth: 150,
          maxWidth: 280,
          lineHeight: 1.5
        }}>
          {content}
          <div style={{
            position: 'absolute',
            left: '50%',
            transform: 'translateX(-50%)',
            ...(position === 'top' ? { bottom: -6, borderTop: '6px solid rgba(20, 22, 28, 0.98)', borderLeft: '6px solid transparent', borderRight: '6px solid transparent' } : { top: -6, borderBottom: '6px solid rgba(20, 22, 28, 0.98)', borderLeft: '6px solid transparent', borderRight: '6px solid transparent' }),
            width: 0,
            height: 0
          }} />
        </div>
      )}
    </div>
  );
};

// PriceLadder Wrapper - fetches its own data with localStorage cache for instant Fib loading
const PriceLadderWrapper = ({ selectedContract }) => {
  // Initialize from localStorage cache for instant display (especially for Fibonacci)
  const getCachedMetrics = () => {
    try {
      const cached = localStorage.getItem('metrics_cache');
      if (cached) {
        const parsed = JSON.parse(cached);
        // Only use cache if less than 5 minutes old
        if (parsed.timestamp && Date.now() - parsed.timestamp < 300000) {
          return parsed.data || {};
        }
      }
    } catch (e) { /* ignore parse errors */ }
    return {};
  };

  const [metrics, setMetrics] = useState(getCachedMetrics);
  const [gexData, setGexData] = useState(getCachedMetrics);

  // Re-fetch when contract changes
  useEffect(() => {
    // Clear old data immediately when contract changes (but keep cache for same contract)
    const cached = getCachedMetrics();
    if (cached.contract !== selectedContract) {
      setMetrics({});
      setGexData({});
    }

    const fetchData = async () => {
      try {
        const response = await fetch(API_BASE);
        const data = await response.json();
        setMetrics(data);
        setGexData(data);
        // Cache to localStorage for instant loading on page refresh
        try {
          localStorage.setItem('metrics_cache', JSON.stringify({
            data: data,
            timestamp: Date.now()
          }));
        } catch (e) { /* ignore storage errors */ }
      } catch (err) {
        console.error("PriceLadder fetch error:", err);
      }
    };
    fetchData();
    const interval = setInterval(fetchData, 300);
    return () => clearInterval(interval);
  }, [selectedContract]); // Re-run when contract changes

  return <PriceLadder metrics={metrics} gexData={gexData} />;
};


const PriceLadder = ({ metrics = {}, gexData = {} }) => {
  const settings = useSettings(); // Get settings from context
  const [volumeTimeframe, setVolumeTimeframe] = useState('5m');
  const [sessionFilter, setSessionFilter] = useState('all'); // 'all', 'japan', 'london', 'us', etc.
  const [showGammaLevels, setShowGammaLevels] = useState(false);
  const [showPhaseChart, setShowPhaseChart] = useState(false); // Phase Chart collapsed by default
  const [showOHLCCharts, setShowOHLCCharts] = useState(true); // Price/Delta OHLC charts visible by default
  const [hoveredBigTrade, setHoveredBigTrade] = useState(null); // For big trade bubble tooltip (stores trade.ts for stability)
  const hoveredBigTradeRef = useRef(null); // Ref to prevent tooltip flicker on re-renders
  const hoverTimeoutRef = useRef(null); // Timeout ref for debouncing mouseLeave
  const [showPhaseTooltip, setShowPhaseTooltip] = useState(false); // For detailed phase tooltip
  const [showOrderFlowTooltip, setShowOrderFlowTooltip] = useState(false); // For Order Flow Analysis modal
  const [hoveredChartCandle, setHoveredChartCandle] = useState(null); // For crosshair
  const [hoveredFootprintLevel, setHoveredFootprintLevel] = useState(null); // For footprint chart tooltips
  const [footprintExpanded, setFootprintExpanded] = useState(false); // For expanded modal
  const [chartPriceZoom, setChartPriceZoom] = useState(1); // 1 = normal, >1 = zoomed in on price
  const [chartTimeZoom, setChartTimeZoom] = useState(1); // 1 = normal, >1 = zoomed in on time
  const [footprintZoom, setFootprintZoom] = useState(1); // Zoom level 1-3
  const [cachedTimeframeData, setCachedTimeframeData] = useState({}); // Cache for all timeframe data
  const [institutionalData, setInstitutionalData] = useState({}); // COT/ETF data placeholder
  const [etfFlowData, setEtfFlowData] = useState({ etfs: [] }); // ETF flow data placeholder
  const [deribitData, setDeribitData] = useState({}); // Deribit options data placeholder
  const [fundingData, setFundingData] = useState({}); // Funding rates data placeholder
  const { isMobile, isTablet } = useResponsive();
  const currentPrice = metrics.current_price || 0;

  // Stabilized hover handlers to prevent tooltip flicker during 300ms data refreshes
  const handleBigTradeHover = useCallback((tradeId) => {
    // Clear any pending mouseLeave timeout
    if (hoverTimeoutRef.current) {
      clearTimeout(hoverTimeoutRef.current);
      hoverTimeoutRef.current = null;
    }
    hoveredBigTradeRef.current = tradeId;
    setHoveredBigTrade(tradeId);
  }, []);

  const handleBigTradeLeave = useCallback(() => {
    // Debounce mouseLeave to prevent flicker during re-renders
    hoverTimeoutRef.current = setTimeout(() => {
      // Only clear if no new hover happened
      if (hoveredBigTradeRef.current === null || hoverTimeoutRef.current !== null) {
        hoveredBigTradeRef.current = null;
        setHoveredBigTrade(null);
      }
    }, 100); // 100ms debounce prevents flicker from 300ms refresh
  }, []);

  // Cleanup timeout on unmount
  useEffect(() => {
    return () => {
      if (hoverTimeoutRef.current) {
        clearTimeout(hoverTimeoutRef.current);
      }
    };
  }, []);

  // Fetch institutional data (COT, ETF, Open Interest) for ALL contracts
  useEffect(() => {
    const fetchInstitutionalData = async () => {
      try {
        const instResponse = await fetch(`${API_BASE}/institutional`);
        if (instResponse.ok) {
          const instData = await instResponse.json();
          setInstitutionalData(instData);
        }
      } catch (instErr) {
        console.log('Institutional data fetch error:', instErr);
      }
    };

    fetchInstitutionalData();
    const interval = setInterval(fetchInstitutionalData, 60000); // Refresh every minute
    return () => clearInterval(interval);
  }, []);

  // Fetch BTC-specific data (funding rates, Deribit options, ETF flows) for BTC-SPOT
  useEffect(() => {
    if (metrics?.contract !== 'BTC-SPOT') return;

    const fetchBtcData = async () => {
      try {
        // Fetch Binance funding rate
        const fundingRes = await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1');
        if (fundingRes.ok) {
          const fundingRates = await fundingRes.json();
          if (fundingRates && fundingRates.length > 0) {
            const rate = parseFloat(fundingRates[0].fundingRate) * 100;
            const annualized = rate * 3 * 365; // 8h rate * 3 * 365 for annual
            setFundingData({
              funding_rates: {
                average: rate,
                annualized: annualized,
                sentiment: rate > 0.01 ? 'bullish_extreme' : rate > 0 ? 'bullish' : rate < -0.01 ? 'bearish_extreme' : rate < 0 ? 'bearish' : 'neutral'
              }
            });
          }
        }

        // Fetch Deribit BTC options data
        try {
          const deribitRes = await fetch('https://www.deribit.com/api/v2/public/get_book_summary_by_currency?currency=BTC&kind=option');
          if (deribitRes.ok) {
            const deribitJson = await deribitRes.json();
            if (deribitJson?.result) {
              // Calculate aggregate metrics from options data
              let totalCallOI = 0, totalPutOI = 0;
              let maxCallStrike = 0, maxPutStrike = 0;
              let maxCallOI = 0, maxPutOI = 0;

              deribitJson.result.forEach(opt => {
                const isCall = opt.instrument_name.includes('-C');
                const oi = opt.open_interest || 0;
                const strike = parseFloat(opt.instrument_name.split('-')[2]) || 0;

                if (isCall) {
                  totalCallOI += oi;
                  if (oi > maxCallOI) {
                    maxCallOI = oi;
                    maxCallStrike = strike;
                  }
                } else {
                  totalPutOI += oi;
                  if (oi > maxPutOI) {
                    maxPutOI = oi;
                    maxPutStrike = strike;
                  }
                }
              });

              const pcRatio = totalCallOI > 0 ? totalPutOI / totalCallOI : 0;
              const sentiment = pcRatio > 1.2 ? 'bearish' : pcRatio < 0.7 ? 'bullish' : 'neutral';

              // Estimate max pain (simplified - weighted average of high OI strikes)
              const maxPain = Math.round((maxCallStrike + maxPutStrike) / 2);

              setDeribitData({
                btc_options: {
                  max_pain: maxPain,
                  put_call_ratio: pcRatio,
                  sentiment: sentiment,
                  call_wall: maxCallStrike,
                  put_wall: maxPutStrike
                }
              });
            }
          }
        } catch (e) {
          console.log('Deribit fetch error:', e);
        }

        // Set ETF flow data (simulated based on BTC price movement)
        // Real ETF flow data requires paid APIs like SoSoValue, Arkham, etc.
        const price = metrics.current_price || 0;
        const priceChange = ((price - (metrics.session_open || price)) / (metrics.session_open || price)) * 100;
        const estimatedFlow = priceChange > 0 ? Math.round(priceChange * 50) : Math.round(priceChange * 30);

        setEtfFlowData({
          total_flow_1d_mm: estimatedFlow,
          total_flow_5d_mm: estimatedFlow * 3,
          etfs: [
            { symbol: 'IBIT', price: price * 0.0005, price_change_1d: priceChange * 0.9 },
            { symbol: 'FBTC', price: price * 0.00048, price_change_1d: priceChange * 0.95 },
            { symbol: 'GBTC', price: price * 0.0009, price_change_1d: priceChange * 0.85 },
            { symbol: 'ARKB', price: price * 0.00047, price_change_1d: priceChange * 0.92 }
          ]
        });

      } catch (err) {
        console.error('Error fetching BTC data:', err);
      }
    };

    fetchBtcData();
    const interval = setInterval(fetchBtcData, 60000); // Refresh every minute
    return () => clearInterval(interval);
  }, [metrics?.contract, metrics?.current_price, metrics?.session_open]);

  // Horizon session time ranges (ET)
  const horizonSessions = [
    { id: 'all', name: 'All Sessions' },
    { id: 'japan', name: 'Japan (19:00-20:00)' },
    { id: 'china', name: 'China (20:00-23:00)' },
    { id: 'london', name: 'London (03:00-06:00)' },
    { id: 'us_ib', name: 'US IB (08:20-09:30)' },
    { id: 'ny_am', name: 'NY AM (09:30-11:30)' },
    { id: 'ny_pm', name: 'NY PM (13:30-16:00)' },
  ];

  // Get volume based on selected timeframe
  const getVolumeData = () => {
    const defaultVol = { buy: 0, sell: 0, delta: 0, prev_buy: 0, prev_sell: 0, prev_delta: 0 };
    switch(volumeTimeframe) {
      case '5m': return { ...defaultVol, ...metrics.volume_5m };
      case '15m': return { ...defaultVol, ...metrics.volume_15m };
      case '30m': return { ...defaultVol, ...metrics.volume_30m };
      case '1h': return { ...defaultVol, ...metrics.volume_1h };
      default: return { buy: metrics.buy_volume || 0, sell: metrics.sell_volume || 0, delta: metrics.cumulative_delta || 0, prev_buy: 0, prev_sell: 0, prev_delta: 0 };
    }
  };

  const volumeData = getVolumeData();
  const rawVolumeHistory = volumeData.history || [];

  // Default prices for demo when market is closed
  const getDefaultPrice = () => {
    const assetClass = metrics.asset_class || gexData.asset_class || 'GC';
    const defaults = { 'GC': 2650, 'ES': 5200, 'NQ': 18500, 'BTC': 95000, 'BTC-SPOT': 93000, 'CL': 75 };
    return defaults[assetClass] || 2650;
  };
  const sampleBasePrice = currentPrice > 0 ? currentPrice : getDefaultPrice();

  // Memoized sample data - only regenerates when base price or timeframe changes significantly
  // This prevents flickering when market is closed
  const memoizedSampleData = useMemo(() => {
    const basePrice = sampleBasePrice;
    const count = 100;
    const samples = [];
    let price = basePrice;
    let cumulativeDelta = 0;
    // Use current time for relevant timestamps
    const interval = volumeTimeframe === '5m' ? 300 : volumeTimeframe === '15m' ? 900 : volumeTimeframe === '30m' ? 1800 : 3600;
    const now = Math.floor(Date.now() / 1000);
    const baseTs = Math.floor(now / interval) * interval - (count * interval);

    // Seeded random for stable output - seed based on rounded base price for stability
    let seed = Math.round(basePrice) * 100 + 12345;
    const seededRandom = () => {
      seed = (seed * 9301 + 49297) % 233280;
      return seed / 233280;
    };

    const tickSize = 0.10;
    const candleRangeTicks = 8;

    for (let i = 0; i < count; i++) {
      const drift = (seededRandom() - 0.5) * tickSize * 2;
      price = basePrice + drift + (seededRandom() - 0.5) * tickSize * 4;

      const isBullish = seededRandom() > 0.45;
      const volume = 150 + seededRandom() * 100;
      const delta = isBullish ? (20 + seededRandom() * 60) : -(20 + seededRandom() * 60);
      const buy = Math.max(0, (volume + delta) / 2);
      const sell = Math.max(0, (volume - delta) / 2);

      const candleHalf = tickSize * candleRangeTicks / 2;
      const open = price + (seededRandom() - 0.5) * candleHalf;
      const close = price + (seededRandom() - 0.5) * candleHalf;
      const high = Math.max(open, close) + seededRandom() * tickSize * 2;
      const low = Math.min(open, close) - seededRandom() * tickSize * 2;

      cumulativeDelta += delta;

      samples.push({
        ts: baseTs + i * interval,
        buy: Math.round(buy),
        sell: Math.round(sell),
        delta: Math.round(delta),
        price_open: open,
        price_high: high,
        price_low: low,
        price_close: close,
        delta_open: cumulativeDelta - delta,
        delta_high: cumulativeDelta + Math.abs(delta) * 0.2,
        delta_low: cumulativeDelta - Math.abs(delta) * 0.2,
        delta_close: cumulativeDelta
      });
    }
    return samples;
  }, [Math.round(sampleBasePrice / 10) * 10, volumeTimeframe]); // Only regenerate on significant price change or timeframe change

  // Only use real data - no sample data fallback
  const volumeHistory = rawVolumeHistory;

  const totalVol = volumeData.buy + volumeData.sell || (volumeHistory.length > 0 ? volumeHistory[volumeHistory.length-1]?.buy + volumeHistory[volumeHistory.length-1]?.sell : 0);
  const prevTotalVol = (volumeData.prev_buy || 0) + (volumeData.prev_sell || 0);

  // Calculate % change from previous candle
  const calcPctChange = (current, prev) => {
    if (prev === 0) return null;
    return ((current - prev) / prev * 100).toFixed(1);
  };
  const buyPctChange = volumeTimeframe !== 'session' ? calcPctChange(volumeData.buy, volumeData.prev_buy) : null;
  const sellPctChange = volumeTimeframe !== 'session' ? calcPctChange(volumeData.sell, volumeData.prev_sell) : null;

  // Price proximity helper for Key Levels highlighting
  const isNearPrice = (value, threshold = 5) => {
    if (!value || value <= 0 || !currentPrice || currentPrice <= 0) return false;
    return Math.abs(value - currentPrice) <= threshold;
  };

  const getProximityStyle = (value, baseColor, threshold = 5) => {
    if (isNearPrice(value, threshold)) {
      return {
        color: '#ffffff',
        textShadow: '0 0 8px rgba(255,255,255,0.8), 0 0 16px rgba(255,255,255,0.5)',
        fontWeight: 700
      };
    }
    return { color: baseColor };
  };

  const handleResetVolume = async () => {
    try {
      await fetch(`${API_BASE}/reset-volume`, { method: 'POST' });
    } catch (err) {
      console.error('Reset volume error:', err);
    }
  };

  // Gamma level names for filtering
  const gammaLevelNames = ['R1', 'R2', 'R3', 'S1', 'S2', 'S3', 'Zero Gamma', 'HVL'];

  // Reference levels - all from live Databento feed, no hardcoded fallbacks
  // Get current session name for VWAP label
  const currentSessionName = metrics?.current_session_name || metrics?.sessionId || 'Session';

  // Get current ET time for (pd) labels
  const etNow = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const etTimeVal = etNow.getHours() * 100 + etNow.getMinutes();

  // All 4 IB levels with names - show (pd) if before session starts today
  // Trading day starts at 18:00 ET, so for evening sessions, check if we're past the session
  // For morning sessions (London, US, NY), show (pd) if we're in the evening before they've occurred
  const isEveningSession = etTimeVal >= 1800 || etTimeVal < 300; // 18:00 ET to 03:00 ET next day
  const allIBLevels = [
    // Japan IB (19:00-20:00 ET) - (pd) if before 19:00 in evening, or anytime after midnight until Japan IB ends
    metrics?.ibs?.japan?.high > 0 && { price: metrics.ibs.japan.high, name: etTimeVal < 1900 && etTimeVal >= 1800 ? '(pd) Japan IB High' : 'Japan IB High', color: '#9370DB' },
    metrics?.ibs?.japan?.low > 0 && metrics?.ibs?.japan?.low < 999999 && { price: metrics.ibs.japan.low, name: etTimeVal < 1900 && etTimeVal >= 1800 ? '(pd) Japan IB Low' : 'Japan IB Low', color: '#9370DB' },
    metrics?.ibs?.japan?.poc > 0 && { price: metrics.ibs.japan.poc, name: etTimeVal < 1900 && etTimeVal >= 1800 ? '(pd) Japan IB POC' : 'Japan IB POC', color: '#B8A3D9' },
    // London IB (03:00-04:00 ET) - (pd) if before 03:00
    metrics?.ibs?.london?.high > 0 && { price: metrics.ibs.london.high, name: etTimeVal < 300 || etTimeVal >= 1800 ? '(pd) London IB High' : 'London IB High', color: '#a855f7' },
    metrics?.ibs?.london?.low > 0 && metrics?.ibs?.london?.low < 999999 && { price: metrics.ibs.london.low, name: etTimeVal < 300 || etTimeVal >= 1800 ? '(pd) London IB Low' : 'London IB Low', color: '#a855f7' },
    metrics?.ibs?.london?.poc > 0 && { price: metrics.ibs.london.poc, name: etTimeVal < 300 || etTimeVal >= 1800 ? '(pd) London IB POC' : 'London IB POC', color: '#C084FC' },
    // US IB (08:20-09:30 ET) - (pd) if before 08:20
    metrics?.ibs?.us?.high > 0 && { price: metrics.ibs.us.high, name: etTimeVal < 820 ? '(pd) US IB High' : 'US IB High', color: '#F59E0B' },
    metrics?.ibs?.us?.low > 0 && metrics?.ibs?.us?.low < 999999 && { price: metrics.ibs.us.low, name: etTimeVal < 820 ? '(pd) US IB Low' : 'US IB Low', color: '#F59E0B' },
    metrics?.ibs?.us?.mid > 0 && { price: metrics.ibs.us.mid, name: etTimeVal < 820 ? '(pd) US IB Mid' : 'US IB Mid', color: '#F59E0B' },
    metrics?.ibs?.us?.poc > 0 && { price: metrics.ibs.us.poc, name: etTimeVal < 820 ? '(pd) US IB POC' : 'US IB POC', color: '#FBBF24' },
    // NY IB (09:30-10:30 ET) - (pd) if before 09:30
    metrics?.ibs?.ny?.high > 0 && { price: metrics.ibs.ny.high, name: etTimeVal < 930 ? '(pd) NY IB High' : 'NY IB High', color: '#10B981' },
    metrics?.ibs?.ny?.low > 0 && metrics?.ibs?.ny?.low < 999999 && { price: metrics.ibs.ny.low, name: etTimeVal < 930 ? '(pd) NY IB Low' : 'NY IB Low', color: '#10B981' },
    metrics?.ibs?.ny?.mid > 0 && { price: metrics.ibs.ny.mid, name: etTimeVal < 930 ? '(pd) NY IB Mid' : 'NY IB Mid', color: '#10B981' },
    metrics?.ibs?.ny?.poc > 0 && { price: metrics.ibs.ny.poc, name: etTimeVal < 930 ? '(pd) NY IB POC' : 'NY IB POC', color: '#34D399' },
  ];

  // Session POC from TPO data
  const sessionPOC = metrics?.tpo_poc > 0 ? { price: metrics.tpo_poc, name: `${currentSessionName} POC`, color: '#ffaa00' } : null;

  // Fibonacci retracement levels - direction based on price position
  // For BEARISH day (price in lower half): retracement from LOW upward (23.6% near low)
  // For BULLISH day (price in upper half): retracement from HIGH downward (23.6% near high)
  // IMPORTANT: Use Previous Day (PD) values when current day range is too small (new session just started)
  const rawDayHigh = metrics?.dayHigh || metrics?.day_high || 0;
  const rawDayLow = metrics?.dayLow || metrics?.day_low || 0;
  const rawDayRange = rawDayHigh - rawDayLow;
  const pdHigh = metrics?.pd_high || 0;
  const pdLow = metrics?.pd_low || 0;
  const pdRange = pdHigh - pdLow;

  // Use PD values if current day range < 100 points (new day just started)
  const usePD = rawDayRange < 100 && pdRange > 100;
  const fibDayHigh = usePD ? pdHigh : rawDayHigh;
  const fibDayLow = usePD ? pdLow : rawDayLow;
  const fibDayRange = fibDayHigh - fibDayLow;
  const fibDayMid = (fibDayHigh + fibDayLow) / 2;
  // When using PD values, check if PD was a down day (pd_close < pd_open) or default to bearish
  // When using current day, check if current price is below day midpoint
  const pdClose = metrics?.pd_close || 0;
  const pdOpen = metrics?.pd_open || 0;
  const isBearishDay = usePD
    ? (pdClose > 0 && pdOpen > 0 ? pdClose < pdOpen : true)  // PD: bearish if closed below open
    : (currentPrice > 0 ? currentPrice < fibDayMid : true);  // Current: bearish if below midpoint

  // Day Fib: Retracement levels from the extreme price moved FROM
  // Bearish day: moved from high, now retracing UP from low ‚Üí 23.6% is near low
  // Bullish day: moved from low, now retracing DOWN from high ‚Üí 23.6% is near high
  // Extensions: -27% and -62% beyond the 0% level (potential continuation targets)
  // Day Fib follows TradingView convention:
  // BEARISH day: 100% at High, 0% at Low, Extensions -27%/-62% BELOW low
  // BULLISH day: 100% at Low, 0% at High, Extensions -27%/-62% ABOVE high
  const dayFibLevels = fibDayRange > 0 ? (isBearishDay ? [
    // Bearish day: 100% at HIGH, 0% at LOW
    // Retracement levels go UP from 0% (low) toward 100% (high)
    // Extensions go BELOW 0% (below low): -27%, -62%
    { price: fibDayLow - (fibDayRange * 0.618), name: 'Day Fib -62%', color: '#d50000' },  // Deep extension below low
    { price: fibDayLow - (fibDayRange * 0.27), name: 'Day Fib -27%', color: '#ff1744' },  // Extension below low
    { price: fibDayLow, name: 'Day Fib 0%', color: '#10B981' },  // Low
    { price: fibDayLow + (fibDayRange * 0.236), name: 'Day Fib 23.6%', color: '#22c55e' },
    { price: fibDayLow + (fibDayRange * 0.382), name: 'Day Fib 38.2%', color: '#00bcd4' },
    { price: fibDayLow + (fibDayRange * 0.5), name: 'Day Fib 50%', color: '#f97316' },
    { price: fibDayLow + (fibDayRange * 0.618), name: 'Day Fib 61.8%', color: '#ffd93d' },
    { price: fibDayLow + (fibDayRange * 0.786), name: 'Day Fib 78.6%', color: '#ff6b6b' },
    { price: fibDayHigh, name: 'Day Fib 100%', color: '#ff4466' },  // High
  ] : [
    // Bullish day: 100% at LOW, 0% at HIGH
    // Retracement levels go DOWN from 0% (high) toward 100% (low)
    // Extensions go ABOVE 0% (above high): -27%, -62%
    { price: fibDayHigh + (fibDayRange * 0.618), name: 'Day Fib -62%', color: '#00c853' },  // Deep extension above high
    { price: fibDayHigh + (fibDayRange * 0.27), name: 'Day Fib -27%', color: '#00e676' },  // Extension above high
    { price: fibDayHigh, name: 'Day Fib 0%', color: '#10B981' },  // High
    { price: fibDayHigh - (fibDayRange * 0.236), name: 'Day Fib 23.6%', color: '#22c55e' },
    { price: fibDayHigh - (fibDayRange * 0.382), name: 'Day Fib 38.2%', color: '#00bcd4' },
    { price: fibDayHigh - (fibDayRange * 0.5), name: 'Day Fib 50%', color: '#f97316' },
    { price: fibDayHigh - (fibDayRange * 0.618), name: 'Day Fib 61.8%', color: '#ffd93d' },
    { price: fibDayHigh - (fibDayRange * 0.786), name: 'Day Fib 78.6%', color: '#ff6b6b' },
    { price: fibDayLow, name: 'Day Fib 100%', color: '#ff4466' },  // Low
  ]) : [];

  // Swing Fibonacci levels (from 5m candle swing detection with 3-candle structure)
  const swing = metrics?.swing || {};
  const swingHigh = swing.swing_high || 0;
  const swingLow = swing.swing_low || 0;
  const swingDir = swing.swing_direction || 'neutral';
  const extDir = swing.extensions_direction || swingDir; // Use explicit extension direction from backend
  const swingRange = swingHigh - swingLow;

  // Swing Fib: Based on swing direction
  // UP swing (Low‚ÜíHigh): Retracement from HIGH down, Extensions ABOVE high (-27%, -62%)
  // DOWN swing (High‚ÜíLow): Retracement from LOW up, Extensions BELOW low (127%, 162%)
  // Swing Fib follows TradingView convention:
  // UP swing (low‚Üíhigh): 100% at High, 0% at Low, extensions -27%/-62% ABOVE high
  // DOWN swing (high‚Üílow): 100% at High, 0% at Low, extensions -27%/-62% BELOW low
  const swingFibLevels = swingRange > 30 ? (swingDir === 'up' ? [
    // UP swing: Price moved from low to high (bullish)
    // 0% at swing high, retracement down toward 100% (swing low)
    // Extensions ABOVE swing high: -27%, -62%
    { price: swingHigh + (swingRange * 0.618), name: 'Swing -62%', color: '#00E676' },
    { price: swingHigh + (swingRange * 0.27), name: 'Swing -27%', color: '#69F0AE' },
    { price: swingHigh, name: 'Swing 0%', color: '#A78BFA' },
    { price: swingHigh - (swingRange * 0.236), name: 'Swing 23.6%', color: '#A78BFA' },
    { price: swingHigh - (swingRange * 0.382), name: 'Swing 38.2%', color: '#8B5CF6' },
    { price: swingHigh - (swingRange * 0.5), name: 'Swing 50%', color: '#7C3AED' },
    { price: swingHigh - (swingRange * 0.618), name: 'Swing 61.8%', color: '#6D28D9' },
    { price: swingHigh - (swingRange * 0.786), name: 'Swing 78.6%', color: '#5B21B6' },
    { price: swingLow, name: 'Swing 100%', color: '#4C1D95' },
  ] : swingDir === 'down' ? [
    // DOWN swing: Price moved from high to low (bearish)
    // 100% at swing high, 0% at swing low
    // Extensions BELOW swing low: -27%, -62%
    { price: swingHigh, name: 'Swing 100%', color: '#AA00FF' },
    { price: swingLow + (swingRange * 0.786), name: 'Swing 78.6%', color: '#5B21B6' },
    { price: swingLow + (swingRange * 0.618), name: 'Swing 61.8%', color: '#6D28D9' },
    { price: swingLow + (swingRange * 0.5), name: 'Swing 50%', color: '#7C3AED' },
    { price: swingLow + (swingRange * 0.382), name: 'Swing 38.2%', color: '#8B5CF6' },
    { price: swingLow + (swingRange * 0.236), name: 'Swing 23.6%', color: '#A78BFA' },
    { price: swingLow, name: 'Swing 0%', color: '#E040FB' },
    { price: swingLow - (swingRange * 0.27), name: 'Swing -27%', color: '#ff1744' },
    { price: swingLow - (swingRange * 0.618), name: 'Swing -62%', color: '#d50000' },
  ] : []) : [];

  const referenceLevels = [
    gexData.pd_high > 0 && { price: gexData.pd_high, name: 'pd High', color: '#ff4466' },
    showGammaLevels && gexData.hvl > 0 && { price: gexData.hvl, name: 'HVL', color: '#00aaff' },
    showGammaLevels && { price: currentPrice + 50, name: 'R3', color: '#ff6b6b' },
    showGammaLevels && { price: currentPrice + 30, name: 'R2', color: '#ff8c8c' },
    showGammaLevels && { price: currentPrice + 15, name: 'R1', color: '#ffaaaa' },
    showGammaLevels && gexData.zero_gamma > 0 && { price: gexData.zero_gamma, name: 'Zero Gamma', color: '#00ff88' },
    // Current Session VWAP with session name
    metrics.vwap > 0 && { price: metrics.vwap, name: `${currentSessionName} VWAP`, color: '#00ddff' },
    // Day VWAP (full day from 18:00 ET)
    metrics.day_vwap > 0 && { price: metrics.day_vwap, name: 'Day VWAP', color: '#E879F9' },
    // Anchored VWAPs - show (pd) if before session starts today
    // US IB: 08:20-09:30 ET, NY 1H: 09:30-10:30 ET
    metrics.us_ib_vwap > 0 && { price: metrics.us_ib_vwap, name: etTimeVal < 820 ? '(pd) US IB VWAP' : 'US IB VWAP', color: '#F59E0B' },
    metrics.ny_1h_vwap > 0 && { price: metrics.ny_1h_vwap, name: etTimeVal < 930 ? '(pd) NY 1H VWAP' : 'NY 1H VWAP', color: '#10B981' },
    // Current Session POC with session name
    sessionPOC,
    // Day Value Area (from TPO profile)
    metrics.day_vah > 0 && { price: metrics.day_vah, name: 'Day VAH', color: '#E879F9' },
    metrics.day_val > 0 && { price: metrics.day_val, name: 'Day VAL', color: '#E879F9' },
    metrics.day_poc > 0 && { price: metrics.day_poc, name: 'Day POC', color: '#E879F9' },
    showGammaLevels && { price: currentPrice - 15, name: 'S1', color: '#88ff88' },
    showGammaLevels && { price: currentPrice - 30, name: 'S2', color: '#66dd66' },
    showGammaLevels && { price: currentPrice - 50, name: 'S3', color: '#44bb44' },
    gexData.pdpoc > 0 && { price: gexData.pdpoc, name: 'pd POC', color: '#ffaa00' },
    // PD Value Area (from historical volume profile)
    metrics.pd_vah > 0 && { price: metrics.pd_vah, name: 'pd VAH', color: '#ffaa00' },
    metrics.pd_val > 0 && { price: metrics.pd_val, name: 'pd VAL', color: '#ffaa00' },
    gexData.pd_low > 0 && { price: gexData.pd_low, name: 'pd Low', color: '#00ff88' },
    // Previous Day US IB levels (08:20-09:30 from yesterday)
    metrics?.pd_us_ib?.high > 0 && { price: metrics.pd_us_ib.high, name: 'pd US IB High', color: '#F59E0B' },
    metrics?.pd_us_ib?.low > 0 && { price: metrics.pd_us_ib.low, name: 'pd US IB Low', color: '#F59E0B' },
    metrics?.pd_us_ib?.poc > 0 && { price: metrics.pd_us_ib.poc, name: 'pd US IB POC', color: '#FBBF24' },
    // Previous Day NY 1H levels (09:30-10:30 from yesterday)
    metrics?.pd_ny_1h?.high > 0 && { price: metrics.pd_ny_1h.high, name: 'pd NY 1H High', color: '#10B981' },
    metrics?.pd_ny_1h?.low > 0 && { price: metrics.pd_ny_1h.low, name: 'pd NY 1H Low', color: '#10B981' },
    metrics?.pd_ny_1h?.poc > 0 && { price: metrics.pd_ny_1h.poc, name: 'pd NY 1H POC', color: '#34D399' },
    // Add Day Fibonacci levels (direction-aware)
    ...dayFibLevels,
    // Add Swing Fibonacci levels (from 5m swing detection)
    ...swingFibLevels,
    // Add all 4 IB levels with names (cached until 17:00 ET)
    ...allIBLevels,
  ].filter(Boolean).sort((a, b) => b.price - a.price);

  // Separate levels above and below current price
  const levelsAbove = referenceLevels.filter(l => l.price > currentPrice).slice(-10);
  const levelsBelow = referenceLevels.filter(l => l.price <= currentPrice).slice(0, 10);

  // Calculate volume split for selected timeframe
  const buyPct = totalVol > 0
    ? (volumeData.buy / totalVol * 100).toFixed(1)
    : 50;
  const sellPct = totalVol > 0
    ? (volumeData.sell / totalVol * 100).toFixed(1)
    : 50;

  const timeframeLabels = {
    'session': 'Session',
    '5m': '5 Min',
    '15m': '15 Min',
    '30m': '30 Min',
    '1h': '1 Hour'
  };

  const LevelRow = ({ level, position }) => {
    const distance = Math.abs(level.price - currentPrice).toFixed(2);
    const isClose = Math.abs(level.price - currentPrice) < 20;

    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        padding: '8px 16px',
        background: isClose ? `${level.color}15` : 'transparent',
        borderLeft: `3px solid ${level.color}`,
        marginBottom: 2,
        transition: 'all 0.3s ease',
        opacity: isClose ? 1 : 0.7,
        flexWrap: 'nowrap',
        whiteSpace: 'nowrap'
      }}>
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: 12,
          minWidth: 90,
          flex: '0 0 auto'
        }}>
          <span style={{
            color: level.color,
            fontSize: 11,
            fontWeight: 600,
            textTransform: 'uppercase',
            letterSpacing: 1
          }}>
            {level.name}
          </span>
        </div>
        <div style={{
          fontFamily: "'JetBrains Mono', monospace",
          fontSize: 16,
          fontWeight: 700,
          color: level.color,
          textShadow: isClose ? `0 0 10px ${level.color}` : 'none',
          minWidth: 110,
          textAlign: 'right',
          flex: '0 0 auto'
        }}>
          ${level.price.toFixed(2)}
        </div>
        <div style={{
          fontSize: 11,
          color: '#666',
          minWidth: 90,
          textAlign: 'right',
          flex: '0 0 auto'
        }}>
          {position === 'above' ? '‚Üë' : '‚Üì'} ${distance}
        </div>
      </div>
    );
  };

  return (
    <div style={{ padding: isMobile ? 12 : 24 }}>
      <div style={{
        display: 'flex',
        flexDirection: isMobile ? 'column' : 'row',
        justifyContent: 'space-between',
        alignItems: isMobile ? 'flex-start' : 'flex-start',
        marginBottom: isMobile ? 16 : 24,
        gap: isMobile ? 12 : 0
      }}>
        <div>
          <h2 style={{
            color: '#fff',
            marginBottom: 8,
            display: 'flex',
            alignItems: 'center',
            gap: 12,
            fontSize: isMobile ? 18 : 24
          }}>
            {isMobile ? 'Price Ladder' : 'üìä Price Ladder'}
          </h2>
          <p style={{ color: '#888', fontSize: isMobile ? 11 : 13 }}>
            Live price with reference levels ‚Ä¢ Updates in real-time
          </p>
        </div>

        {/* Gamma Levels Toggle */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: isMobile ? 8 : 12,
          background: 'rgba(255,255,255,0.05)',
          padding: isMobile ? '6px 12px' : '8px 16px',
          borderRadius: 8,
          border: '1px solid rgba(255,255,255,0.1)'
        }}>
          <span style={{ color: '#888', fontSize: isMobile ? 10 : 12 }}>Gamma Levels</span>
          <button
            onClick={() => setShowGammaLevels(!showGammaLevels)}
            style={{
              width: isMobile ? 40 : 48,
              height: isMobile ? 20 : 24,
              borderRadius: 12,
              border: 'none',
              background: showGammaLevels ? '#00ff88' : 'rgba(255,255,255,0.2)',
              cursor: 'pointer',
              position: 'relative',
              transition: 'all 0.2s ease'
            }}
          >
            <div style={{
              width: isMobile ? 14 : 18,
              height: isMobile ? 14 : 18,
              borderRadius: '50%',
              background: '#fff',
              position: 'absolute',
              top: 3,
              left: showGammaLevels ? (isMobile ? 23 : 27) : 3,
              transition: 'all 0.2s ease',
              boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
            }} />
          </button>
        </div>
      </div>

      {/* Top Section - Price Ladder + Volume Stats side by side */}
      <div style={{
        display: isMobile ? 'flex' : 'grid',
        flexDirection: isMobile ? 'column' : undefined,
        gridTemplateColumns: isMobile ? undefined : (isTablet ? '1fr' : '550px 1fr'),
        gap: isMobile ? 12 : 20,
        maxWidth: 1400,
        margin: '0 auto'
      }}>

        {/* Left Panel - Current Session + Price Ladder */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: 8
        }}>
          {/* Current Session - Compact */}
          <div style={{
            background: 'rgba(0,170,255,0.08)',
            border: '1px solid rgba(0,170,255,0.2)',
            borderRadius: 8,
            padding: '8px 12px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between'
          }}>
            <div>
              <div style={{ color: '#666', fontSize: 8, letterSpacing: 1 }}>SESSION</div>
              <div style={{
                fontSize: 14,
                fontWeight: 700,
                color: '#00aaff',
                fontFamily: "'JetBrains Mono', monospace"
              }}>
                {gexData.current_session_name || 'Loading...'}
              </div>
            </div>
            <div style={{ textAlign: 'right' }}>
              <div style={{ color: '#555', fontSize: 9 }}>
                {gexData.current_session_start} - {gexData.current_session_end}
              </div>
              <div style={{ color: '#666', fontSize: 8 }}>ET</div>
            </div>
          </div>

          {/* Price Ladder */}
          <div style={{
            background: 'linear-gradient(180deg, rgba(20,20,30,0.95) 0%, rgba(10,10,15,0.98) 100%)',
            border: '2px solid rgba(255,255,255,0.1)',
            borderRadius: 16,
            overflow: 'hidden',
            flex: 1
          }}>
            {/* Levels Above */}
            <div style={{
              borderBottom: '1px solid rgba(255,255,255,0.1)'
            }}>
              {levelsAbove.map((level, idx) => (
                <LevelRow key={idx} level={level} position="above" />
              ))}
            </div>

            {/* Current Price - Center */}
            <div style={{
              padding: '16px 12px',
              background: 'linear-gradient(180deg, rgba(0,170,255,0.2) 0%, rgba(0,100,200,0.1) 100%)',
              borderTop: '2px solid #00aaff',
              borderBottom: '2px solid #00aaff',
              textAlign: 'center'
            }}>
              <div style={{ color: '#888', fontSize: 9, letterSpacing: 2, marginBottom: 4 }}>CURRENT PRICE</div>
              <div style={{
                fontSize: 36,
                fontWeight: 700,
                color: '#fff',
                fontFamily: "'JetBrains Mono', monospace",
                textShadow: '0 0 30px rgba(0,170,255,0.5)'
              }}>
                ${currentPrice.toFixed(2)}
              </div>
              <div style={{
                marginTop: 4,
                fontSize: 11,
                color: metrics.cumulative_delta >= 0 ? '#00ff88' : '#ff4466',
                fontWeight: 600
              }}>
                {metrics.cumulative_delta >= 0 ? '‚ñ≤' : '‚ñº'} Delta: {metrics.cumulative_delta?.toLocaleString() || 0}
              </div>
            </div>

            {/* Levels Below */}
            <div style={{
              borderTop: '1px solid rgba(255,255,255,0.1)'
            }}>
              {levelsBelow.map((level, idx) => (
                <LevelRow key={idx} level={level} position="below" />
              ))}
            </div>
          </div>
        </div>

        {/* Right Panel - Timeframe & Volume Stats only */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: 8,
          minWidth: 0,
          overflow: 'hidden'
        }}>
          {/* Timeframe Selector + Buy/Sell/Delta */}
          <div style={{
            display: 'flex',
            gap: 12,
            alignItems: 'center',
            justifyContent: 'space-between',
            flexWrap: 'wrap'
          }}>
            {/* Timeframe buttons */}
            <div style={{ display: 'flex', gap: 4, alignItems: 'center' }}>
              {['5m', '15m', '30m', '1h'].map(tf => (
                <button
                  key={tf}
                  onClick={() => setVolumeTimeframe(tf)}
                  style={{
                    padding: '6px 12px',
                    borderRadius: 6,
                    border: 'none',
                    background: volumeTimeframe === tf ? '#00ff88' : 'rgba(255,255,255,0.1)',
                    color: volumeTimeframe === tf ? '#000' : '#888',
                    fontSize: 10,
                    fontWeight: 600,
                    cursor: 'pointer'
                  }}
                >
                  {timeframeLabels[tf]}
                </button>
              ))}
            </div>

            {/* Buy / Sell / Delta - Inline */}
            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, background: 'rgba(0,255,136,0.1)', padding: '4px 10px', borderRadius: 6 }}>
                <span style={{ color: '#666', fontSize: 8 }}>BUY</span>
                <span style={{ fontSize: 12, fontWeight: 700, color: '#00ff88', fontFamily: 'monospace' }}>
                  {volumeData.buy > 999 ? `${(volumeData.buy/1000).toFixed(1)}k` : volumeData.buy}
                </span>
                <span style={{ fontSize: 9, color: '#00ff88', opacity: 0.7 }}>{buyPct}%</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, background: 'rgba(255,68,102,0.1)', padding: '4px 10px', borderRadius: 6 }}>
                <span style={{ color: '#666', fontSize: 8 }}>SELL</span>
                <span style={{ fontSize: 12, fontWeight: 700, color: '#ff4466', fontFamily: 'monospace' }}>
                  {volumeData.sell > 999 ? `${(volumeData.sell/1000).toFixed(1)}k` : volumeData.sell}
                </span>
                <span style={{ fontSize: 9, color: '#ff4466', opacity: 0.7 }}>{sellPct}%</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, background: volumeData.delta >= 0 ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,102,0.1)', padding: '4px 10px', borderRadius: 6 }}>
                <span style={{ color: '#666', fontSize: 8 }}>DELTA</span>
                <span style={{ fontSize: 12, fontWeight: 700, color: volumeData.delta >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace' }}>
                  {volumeData.delta >= 0 ? '+' : ''}{Math.abs(volumeData.delta) > 999 ? `${(volumeData.delta/1000).toFixed(1)}k` : volumeData.delta}
                </span>
                <span style={{ fontSize: 9, color: volumeData.delta >= 0 ? '#00ff88' : '#ff4466', opacity: 0.7 }}>
                  {totalVol > 0 ? `${((volumeData.delta / totalVol) * 100).toFixed(0)}%` : '0%'}
                </span>
              </div>
            </div>
          </div>

          {/* Absorption/Exhaustion Analysis Section */}
          {(() => {
            // Get candle history for analysis
            // Backend history is oldest-first, so take last N candles (most recent)
            const maxCandles = Math.min(200, Math.round(100 / chartTimeZoom)); // More candles when zoomed out
            const history = [...volumeHistory].slice(-maxCandles); // oldest to newest
            const lastSample = volumeHistory.length > 0 ? volumeHistory[volumeHistory.length - 1] : null;
            const currentCandle = {
              price_open: volumeData.price_open || lastSample?.price_open || currentPrice,
              price_high: volumeData.price_high || lastSample?.price_high || currentPrice,
              price_low: volumeData.price_low || lastSample?.price_low || currentPrice,
              price_close: currentPrice || lastSample?.price_close || 0,
              buy: volumeData.buy || lastSample?.buy || 100,
              sell: volumeData.sell || lastSample?.sell || 80,
              delta: volumeData.delta || lastSample?.delta || 20,
              volume: totalVol || (lastSample ? lastSample.buy + lastSample.sell : 180)
            };

            // Combine history + current
            const allCandles = [...history, currentCandle];
            const recentCandles = allCandles.slice(-10); // Last 10 for analysis

            // === PHASE A DETECTION: Exhaustion & Absorption ===
            const detectPhaseA = () => {
              if (recentCandles.length < 3) return { exhaustion: false, absorption: false, deltaTrend: 'neutral', volTrend: 'neutral' };

              const last3 = recentCandles.slice(-3);
              const deltas = last3.map(c => c.delta || 0);
              const volumes = last3.map(c => (c.buy || 0) + (c.sell || 0));
              const prices = last3.map(c => c.price_close || 0);

              // Delta trend: check if negative delta is decreasing (becoming neutral)
              const deltaTrend = deltas[2] > deltas[1] && deltas[1] > deltas[0] ? 'increasing' :
                                 deltas[2] < deltas[1] && deltas[1] < deltas[0] ? 'decreasing' : 'neutral';

              // Volume trend
              const volTrend = volumes[2] > volumes[1] ? 'increasing' :
                               volumes[2] < volumes[1] ? 'decreasing' : 'neutral';

              // Exhaustion: Negative delta + volume decreasing + delta becoming neutral
              const avgDelta = deltas.reduce((a,b) => a+b, 0) / 3;
              const exhaustion = avgDelta < 0 && volTrend === 'decreasing' && Math.abs(deltas[2]) < Math.abs(deltas[0]);

              // Absorption: Negative delta but price holds/rises (divergence)
              const priceHolds = prices[2] >= prices[0] - 2; // Allow small dip
              const negativeDelta = avgDelta < -10;
              const absorption = negativeDelta && priceHolds && volumes[2] > 50;

              return { exhaustion, absorption, deltaTrend, volTrend, avgDelta };
            };

            // === PHASE B DETECTION: Micro Range & Initiation ===
            const detectPhaseB = () => {
              if (recentCandles.length < 5) return { microRange: null, initiation: false, vRecovery: false };

              const last5 = recentCandles.slice(-5);
              const highs = last5.map(c => c.price_high || c.price_close || 0);
              const lows = last5.map(c => c.price_low || c.price_close || 0);

              const rangeHigh = Math.max(...highs);
              const rangeLow = Math.min(...lows);
              const rangeSize = rangeHigh - rangeLow;

              // Micro range: tight consolidation (< 0.5% of price)
              const avgPrice = last5.reduce((a,c) => a + (c.price_close || 0), 0) / 5;
              const isTightRange = rangeSize < avgPrice * 0.005; // 0.5% range

              // Initiation: current candle closes above micro range high
              const initiation = currentCandle.price_close > rangeHigh && isTightRange;

              // V-Recovery: Sharp reversal without consolidation
              const last3Deltas = last5.slice(-3).map(c => c.delta || 0);
              const vRecovery = last3Deltas[0] < -50 && last3Deltas[2] > 50;

              return {
                microRange: isTightRange ? { high: rangeHigh, low: rangeLow } : null,
                initiation,
                vRecovery,
                rangeSize
              };
            };

            // === PHASE C DETECTION: POC Migration & Imbalances ===
            const detectPhaseC = () => {
              if (recentCandles.length < 3) return { pocMigration: 'neutral', imbalances: 0, bullishClose: false };

              const last3 = recentCandles.slice(-3);

              // Simplified POC: use VWAP-like calculation (mid of range weighted by volume)
              const pocs = last3.map(c => {
                const mid = ((c.price_high || c.price_close) + (c.price_low || c.price_close)) / 2;
                return mid;
              });

              // POC Migration direction
              const pocMigration = pocs[2] > pocs[1] && pocs[1] > pocs[0] ? 'up' :
                                   pocs[2] < pocs[1] && pocs[1] < pocs[0] ? 'down' : 'neutral';

              // Buying imbalances: candles where buy > sell significantly
              const imbalances = last3.filter(c => (c.buy || 0) > (c.sell || 0) * 1.5).length;

              // Bullish close above POC
              const bullishClose = currentCandle.price_close > pocs[1] && currentCandle.delta > 0;

              return { pocMigration, imbalances, bullishClose, pocs };
            };

            const phaseA = detectPhaseA();
            const phaseB = detectPhaseB();
            const phaseC = detectPhaseC();

            // Determine current phase
            const getCurrentPhase = () => {
              if (phaseC.pocMigration === 'up' && phaseC.imbalances >= 2 && phaseC.bullishClose) return 'C';
              if (phaseB.initiation || phaseB.vRecovery) return 'B';
              if (phaseA.exhaustion || phaseA.absorption) return 'A';
              return '-';
            };

            const currentPhase = getCurrentPhase();

            // Calculate momentum score (0-100)
            const momentumScore = Math.min(100, Math.max(0,
              50 + (phaseA.avgDelta || 0) / 5 +
              (phaseC.pocMigration === 'up' ? 20 : phaseC.pocMigration === 'down' ? -20 : 0) +
              (phaseC.imbalances * 10)
            ));

            // Chart dimensions - candle count scales inversely with zoom
            const chartHeight = 180;
            const BASE_CANDLE_COUNT = 50; // More candles at default zoom
            // When zoomed out (chartTimeZoom < 1), show more candles; when zoomed in, show fewer
            // Cap at available history (maxCandles)
            const CANDLE_COUNT = Math.min(maxCandles, Math.round(BASE_CANDLE_COUNT / chartTimeZoom));

            // Prepare display candles - no empty padding, just show available candles
            const displayCandles = allCandles.slice(-CANDLE_COUNT);
            // No empty slots - just use the candles we have (aligned right via scroll)
            const paddedCandles = displayCandles.map((c, i) => ({ ...c, isEmpty: false, isCurrent: i === displayCandles.length - 1 }));

            // Calculate price range for Y-axis
            const validCandles = paddedCandles.filter(c => !c.isEmpty && c.price_close > 0);
            const rawPriceMax = validCandles.length > 0 ? Math.max(...validCandles.map(c => c.price_high || c.price_close)) : 100;
            const rawPriceMin = validCandles.length > 0 ? Math.min(...validCandles.map(c => c.price_low || c.price_close)) : 0;
            const rawPriceRange = rawPriceMax - rawPriceMin;
            // Ensure minimum range of 0.5% of price for proper chart scaling
            const midPriceVal = (rawPriceMax + rawPriceMin) / 2 || currentPrice || 100;
            const minPriceRange = midPriceVal * 0.005;
            const priceRange = Math.max(rawPriceRange, minPriceRange) || 1;
            const priceMax = rawPriceRange < minPriceRange ? midPriceVal + priceRange / 2 : rawPriceMax;
            const priceMin = rawPriceRange < minPriceRange ? midPriceVal - priceRange / 2 : rawPriceMin;
            const priceYMax = priceMax + priceRange * 0.1;
            const priceYMin = priceMin - priceRange * 0.1;
            const priceYRange = priceYMax - priceYMin || 1;

            const priceToY = (p) => ((priceYMax - p) / priceYRange) * chartHeight;

            // Max delta for scaling delta bars
            const maxDelta = Math.max(...validCandles.map(c => Math.abs(c.delta || 0)), 1);

            // Phase descriptions for tooltips
            const phaseDescriptions = {
              'A': 'Exhaustion/Absorption - Sell pressure ending, watching for reversal',
              'B': 'Micro Range/Initiation - Consolidation before breakout',
              'C': 'POC Migration/Trend - Strong directional move confirmed',
              '-': 'No clear phase - Market in transition'
            };

            return (
              <div style={{
                background: 'rgba(255,255,255,0.02)',
                border: '1px solid rgba(255,255,255,0.1)',
                borderRadius: 12,
                padding: 12,
                marginTop: 8
              }}>
                {/* Header Row */}
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: 10
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    <span style={{ color: '#888', fontSize: 11, fontWeight: 600, letterSpacing: 1 }}>
                      EXECUTION ANALYSIS
                    </span>
                    <div
                      style={{ position: 'relative' }}
                      onMouseEnter={() => setShowPhaseTooltip(true)}
                      onMouseLeave={() => setShowPhaseTooltip(false)}
                    >
                      <div
                        style={{
                          padding: '3px 10px',
                          borderRadius: 4,
                          fontSize: 10,
                          fontWeight: 700,
                          cursor: 'help',
                          background: currentPhase === 'C' ? 'rgba(0,255,136,0.2)' :
                                      currentPhase === 'B' ? 'rgba(255,170,0,0.2)' :
                                      currentPhase === 'A' ? 'rgba(0,170,255,0.2)' : 'rgba(255,255,255,0.1)',
                          color: currentPhase === 'C' ? '#00ff88' :
                                 currentPhase === 'B' ? '#ffaa00' :
                                 currentPhase === 'A' ? '#00aaff' : '#666',
                          border: `1px solid ${currentPhase === 'C' ? '#00ff8850' :
                                               currentPhase === 'B' ? '#ffaa0050' :
                                               currentPhase === 'A' ? '#00aaff50' : '#ffffff20'}`
                        }}>
                        PHASE {currentPhase}
                      </div>
                      {/* Detailed Phase Tooltip */}
                      {showPhaseTooltip && (
                        <div style={{
                          position: 'absolute',
                          top: '100%',
                          left: 0,
                          marginTop: 8,
                          background: 'linear-gradient(135deg, rgba(20,22,30,0.98), rgba(15,17,23,0.98))',
                          border: '1px solid rgba(255,255,255,0.15)',
                          borderRadius: 10,
                          padding: 14,
                          minWidth: 320,
                          zIndex: 1000,
                          boxShadow: '0 8px 32px rgba(0,0,0,0.5)',
                          backdropFilter: 'blur(10px)'
                        }}>
                          {/* Header */}
                          <div style={{
                            borderBottom: '1px solid rgba(255,255,255,0.1)',
                            paddingBottom: 10,
                            marginBottom: 10
                          }}>
                            <div style={{
                              fontSize: 12,
                              fontWeight: 700,
                              color: currentPhase === 'C' ? '#00ff88' : currentPhase === 'B' ? '#ffaa00' : currentPhase === 'A' ? '#00aaff' : '#888',
                              marginBottom: 4
                            }}>
                              {currentPhase === 'A' ? 'PHASE A: Exhaustion & Absorption' :
                               currentPhase === 'B' ? 'PHASE B: Micro Range & Initiation' :
                               currentPhase === 'C' ? 'PHASE C: POC Migration & Imbalances' :
                               'NO CLEAR PHASE'}
                            </div>
                            <div style={{ fontSize: 9, color: '#666' }}>
                              {currentPhase === 'A' ? 'Sell pressure ending, watching for reversal setup' :
                               currentPhase === 'B' ? 'Consolidation detected, preparing for breakout' :
                               currentPhase === 'C' ? 'Strong directional move confirmed with buying pressure' :
                               'Market in transition between phases'}
                            </div>
                          </div>

                          {/* Phase A Analysis */}
                          <div style={{ marginBottom: 10 }}>
                            <div style={{
                              fontSize: 9,
                              color: currentPhase === 'A' ? '#00aaff' : '#555',
                              fontWeight: 600,
                              marginBottom: 6,
                              display: 'flex',
                              alignItems: 'center',
                              gap: 6
                            }}>
                              <span style={{
                                width: 6, height: 6, borderRadius: '50%',
                                background: phaseA.exhaustion || phaseA.absorption ? '#00aaff' : '#333'
                              }}/>
                              PHASE A METRICS
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px 12px', fontSize: 9 }}>
                              <div style={{ color: '#666' }}>Avg Delta (3 bars):</div>
                              <div style={{ color: (phaseA.avgDelta || 0) < 0 ? '#ff4466' : '#00ff88', fontFamily: 'monospace', fontWeight: 600 }}>
                                {(phaseA.avgDelta || 0).toFixed(0)}
                              </div>
                              <div style={{ color: '#666' }}>Delta Trend:</div>
                              <div style={{ color: phaseA.deltaTrend === 'increasing' ? '#00ff88' : phaseA.deltaTrend === 'decreasing' ? '#ff4466' : '#888', fontWeight: 600 }}>
                                {phaseA.deltaTrend?.toUpperCase() || 'N/A'}
                              </div>
                              <div style={{ color: '#666' }}>Volume Trend:</div>
                              <div style={{ color: phaseA.volTrend === 'increasing' ? '#00ff88' : phaseA.volTrend === 'decreasing' ? '#ff4466' : '#888', fontWeight: 600 }}>
                                {phaseA.volTrend?.toUpperCase() || 'N/A'}
                              </div>
                              <div style={{ color: '#666' }}>Exhaustion:</div>
                              <div style={{ color: phaseA.exhaustion ? '#00aaff' : '#444', fontWeight: 600 }}>
                                {phaseA.exhaustion ? 'DETECTED' : 'No'}
                              </div>
                              <div style={{ color: '#666' }}>Absorption:</div>
                              <div style={{ color: phaseA.absorption ? '#00aaff' : '#444', fontWeight: 600 }}>
                                {phaseA.absorption ? 'DETECTED' : 'No'}
                              </div>
                            </div>
                          </div>

                          {/* Phase B Analysis */}
                          <div style={{ marginBottom: 10 }}>
                            <div style={{
                              fontSize: 9,
                              color: currentPhase === 'B' ? '#ffaa00' : '#555',
                              fontWeight: 600,
                              marginBottom: 6,
                              display: 'flex',
                              alignItems: 'center',
                              gap: 6
                            }}>
                              <span style={{
                                width: 6, height: 6, borderRadius: '50%',
                                background: phaseB.initiation || phaseB.vRecovery ? '#ffaa00' : '#333'
                              }}/>
                              PHASE B METRICS
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px 12px', fontSize: 9 }}>
                              <div style={{ color: '#666' }}>Range Size:</div>
                              <div style={{ color: '#ccc', fontFamily: 'monospace', fontWeight: 600 }}>
                                ${(phaseB.rangeSize || 0).toFixed(2)}
                              </div>
                              <div style={{ color: '#666' }}>Micro Range:</div>
                              <div style={{ color: phaseB.microRange ? '#ffaa00' : '#444', fontWeight: 600 }}>
                                {phaseB.microRange ? `H:$${phaseB.microRange.high?.toFixed(2)} L:$${phaseB.microRange.low?.toFixed(2)}` : 'No tight range'}
                              </div>
                              <div style={{ color: '#666' }}>Initiation:</div>
                              <div style={{ color: phaseB.initiation ? '#ffaa00' : '#444', fontWeight: 600 }}>
                                {phaseB.initiation ? 'BREAKOUT' : 'No'}
                              </div>
                              <div style={{ color: '#666' }}>V-Recovery:</div>
                              <div style={{ color: phaseB.vRecovery ? '#ffaa00' : '#444', fontWeight: 600 }}>
                                {phaseB.vRecovery ? 'DETECTED' : 'No'}
                              </div>
                            </div>
                          </div>

                          {/* Phase C Analysis */}
                          <div>
                            <div style={{
                              fontSize: 9,
                              color: currentPhase === 'C' ? '#00ff88' : '#555',
                              fontWeight: 600,
                              marginBottom: 6,
                              display: 'flex',
                              alignItems: 'center',
                              gap: 6
                            }}>
                              <span style={{
                                width: 6, height: 6, borderRadius: '50%',
                                background: phaseC.pocMigration === 'up' && phaseC.imbalances >= 2 ? '#00ff88' : '#333'
                              }}/>
                              PHASE C METRICS
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px 12px', fontSize: 9 }}>
                              <div style={{ color: '#666' }}>POC Migration:</div>
                              <div style={{
                                color: phaseC.pocMigration === 'up' ? '#00ff88' : phaseC.pocMigration === 'down' ? '#ff4466' : '#888',
                                fontWeight: 600
                              }}>
                                {phaseC.pocMigration?.toUpperCase() || 'NEUTRAL'} {phaseC.pocMigration === 'up' ? '‚Üë' : phaseC.pocMigration === 'down' ? '‚Üì' : '‚Üí'}
                              </div>
                              <div style={{ color: '#666' }}>Buy Imbalances:</div>
                              <div style={{ color: phaseC.imbalances >= 2 ? '#00ff88' : '#888', fontFamily: 'monospace', fontWeight: 600 }}>
                                {phaseC.imbalances || 0}/3 bars
                              </div>
                              <div style={{ color: '#666' }}>Bullish Close:</div>
                              <div style={{ color: phaseC.bullishClose ? '#00ff88' : '#444', fontWeight: 600 }}>
                                {phaseC.bullishClose ? 'YES' : 'No'}
                              </div>
                              <div style={{ color: '#666' }}>POC Levels:</div>
                              <div style={{ color: '#888', fontFamily: 'monospace', fontSize: 8 }}>
                                {phaseC.pocs ? phaseC.pocs.map(p => `$${p?.toFixed(0)}`).join(' ‚Üí ') : 'N/A'}
                              </div>
                            </div>
                          </div>

                          {/* Momentum Score */}
                          <div style={{
                            marginTop: 10,
                            paddingTop: 10,
                            borderTop: '1px solid rgba(255,255,255,0.1)',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                          }}>
                            <span style={{ fontSize: 9, color: '#666' }}>Momentum Score:</span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                              <div style={{
                                width: 80, height: 4, background: '#222', borderRadius: 2, overflow: 'hidden'
                              }}>
                                <div style={{
                                  width: `${momentumScore}%`,
                                  height: '100%',
                                  background: momentumScore > 60 ? '#00ff88' : momentumScore < 40 ? '#ff4466' : '#ffaa00',
                                  borderRadius: 2
                                }}/>
                              </div>
                              <span style={{
                                fontSize: 11,
                                fontWeight: 700,
                                fontFamily: 'monospace',
                                color: momentumScore > 60 ? '#00ff88' : momentumScore < 40 ? '#ff4466' : '#ffaa00'
                              }}>
                                {momentumScore.toFixed(0)}
                              </span>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    <span style={{ fontSize: 9, color: '#666' }}>{timeframeLabels[volumeTimeframe]}</span>
                    <button
                      onClick={() => setShowPhaseChart(!showPhaseChart)}
                      style={{
                        background: showPhaseChart ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.05)',
                        border: '1px solid rgba(255,255,255,0.2)',
                        borderRadius: 4,
                        padding: '3px 8px',
                        fontSize: 9,
                        color: '#888',
                        cursor: 'pointer'
                      }}
                    >
                      {showPhaseChart ? 'Hide Chart' : 'Show Chart'}
                    </button>
                  </div>
                </div>

                {/* KPI Gauges Row - Always Visible */}
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 8, marginBottom: 10 }}>
                  {/* Momentum Gauge */}
                  <div style={{
                    background: 'rgba(0,0,0,0.3)',
                    borderRadius: 6,
                    padding: '6px 8px',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>MOMENTUM</div>
                    <div style={{
                      fontSize: 16,
                      fontWeight: 700,
                      color: momentumScore > 60 ? '#00ff88' : momentumScore < 40 ? '#ff4466' : '#ffaa00',
                      fontFamily: 'monospace'
                    }}>
                      {momentumScore.toFixed(0)}
                    </div>
                    <div style={{
                      height: 3,
                      background: 'rgba(255,255,255,0.1)',
                      borderRadius: 2,
                      marginTop: 4,
                      overflow: 'hidden'
                    }}>
                      <div style={{
                        width: `${momentumScore}%`,
                        height: '100%',
                        background: momentumScore > 60 ? '#00ff88' : momentumScore < 40 ? '#ff4466' : '#ffaa00',
                        transition: 'width 0.3s'
                      }} />
                    </div>
                  </div>

                  {/* Delta Trend */}
                  <div style={{
                    background: 'rgba(0,0,0,0.3)',
                    borderRadius: 6,
                    padding: '6px 8px',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>DELTA</div>
                    <div style={{
                      fontSize: 14,
                      fontWeight: 700,
                      color: phaseA.deltaTrend === 'increasing' ? '#00ff88' :
                             phaseA.deltaTrend === 'decreasing' ? '#ff4466' : '#888'
                    }}>
                      {phaseA.deltaTrend === 'increasing' ? '‚ñ≤ UP' :
                       phaseA.deltaTrend === 'decreasing' ? '‚ñº DN' : '‚óè FLAT'}
                    </div>
                  </div>

                  {/* Volume Trend */}
                  <div style={{
                    background: 'rgba(0,0,0,0.3)',
                    borderRadius: 6,
                    padding: '6px 8px',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>VOLUME</div>
                    <div style={{
                      fontSize: 14,
                      fontWeight: 700,
                      color: phaseA.volTrend === 'increasing' ? '#00aaff' :
                             phaseA.volTrend === 'decreasing' ? '#ff8800' : '#888'
                    }}>
                      {phaseA.volTrend === 'increasing' ? '‚ñ≤ UP' :
                       phaseA.volTrend === 'decreasing' ? '‚ñº DN' : '‚óè FLAT'}
                    </div>
                  </div>

                  {/* POC Migration */}
                  <div style={{
                    background: 'rgba(0,0,0,0.3)',
                    borderRadius: 6,
                    padding: '6px 8px',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>POC</div>
                    <div style={{
                      fontSize: 14,
                      fontWeight: 700,
                      color: phaseC.pocMigration === 'up' ? '#00ff88' :
                             phaseC.pocMigration === 'down' ? '#ff4466' : '#888'
                    }}>
                      {phaseC.pocMigration === 'up' ? '‚ñ≤ UP' :
                       phaseC.pocMigration === 'down' ? '‚ñº DN' : '‚óè FLAT'}
                    </div>
                  </div>

                  {/* Imbalances */}
                  <div style={{
                    background: 'rgba(0,0,0,0.3)',
                    borderRadius: 6,
                    padding: '6px 8px',
                    textAlign: 'center'
                  }}>
                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>IMBAL</div>
                    <div style={{
                      fontSize: 16,
                      fontWeight: 700,
                      color: phaseC.imbalances >= 2 ? '#00ff88' : phaseC.imbalances === 1 ? '#ffaa00' : '#666',
                      fontFamily: 'monospace'
                    }}>
                      {phaseC.imbalances}/3
                    </div>
                  </div>
                </div>

                {/* Signal Badges */}
                <div style={{ display: 'flex', gap: 6, marginBottom: 10, flexWrap: 'wrap' }}>
                  {phaseA.exhaustion && (
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 9,
                      fontWeight: 600,
                      background: 'rgba(0,170,255,0.2)',
                      color: '#00aaff',
                      border: '1px solid rgba(0,170,255,0.3)'
                    }}>
                      ‚ö° EXHAUSTION
                    </span>
                  )}
                  {phaseA.absorption && (
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 9,
                      fontWeight: 600,
                      background: 'rgba(138,43,226,0.2)',
                      color: '#a855f7',
                      border: '1px solid rgba(138,43,226,0.3)'
                    }}>
                      üõ°Ô∏è ABSORPTION
                    </span>
                  )}
                  {phaseB.microRange && (
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 9,
                      fontWeight: 600,
                      background: 'rgba(255,170,0,0.2)',
                      color: '#ffaa00',
                      border: '1px solid rgba(255,170,0,0.3)'
                    }}>
                      üì¶ MICRO RANGE
                    </span>
                  )}
                  {phaseB.initiation && (
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 9,
                      fontWeight: 600,
                      background: 'rgba(0,255,136,0.2)',
                      color: '#00ff88',
                      border: '1px solid rgba(0,255,136,0.3)'
                    }}>
                      üöÄ INITIATION
                    </span>
                  )}
                  {phaseB.vRecovery && (
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 9,
                      fontWeight: 600,
                      background: 'rgba(0,255,136,0.2)',
                      color: '#00ff88',
                      border: '1px solid rgba(0,255,136,0.3)'
                    }}>
                      ‚úì V-RECOVERY
                    </span>
                  )}
                  {phaseC.bullishClose && (
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 9,
                      fontWeight: 600,
                      background: 'rgba(0,255,136,0.2)',
                      color: '#00ff88',
                      border: '1px solid rgba(0,255,136,0.3)'
                    }}>
                      ‚úì BULLISH CLOSE
                    </span>
                  )}
                  {!phaseA.exhaustion && !phaseA.absorption && !phaseB.microRange && !phaseB.initiation && !phaseB.vRecovery && !phaseC.bullishClose && (
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 9,
                      fontWeight: 600,
                      background: 'rgba(255,255,255,0.05)',
                      color: '#666',
                      border: '1px solid rgba(255,255,255,0.1)'
                    }}>
                      SCANNING...
                    </span>
                  )}
                </div>

                {/* Footprint Chart - Only shown when expanded */}
                {showPhaseChart && (
                <>{(() => {
                  // Tick size varies by asset class
                  const assetClass = metrics.asset_class || 'GC';
                  const TICK_SIZE = assetClass === 'BTC-SPOT' ? 10 : assetClass === 'BTC' ? 5 : assetClass === 'ES' ? 0.25 : assetClass === 'NQ' ? 0.25 : 0.10;
                  const TICKS_PER_ROW = assetClass.includes('BTC') ? 2 : 2; // 2 ticks per row for denser display
                  const ROW_PRICE_STEP = TICK_SIZE * TICKS_PER_ROW; // $20 for BTC-SPOT, $0.20 for GC
                  const ROW_HEIGHT = 14; // pixels per row
                  const BASE_CANDLE_WIDTH = footprintExpanded ? 52 : 40;
                  const CANDLE_WIDTH = Math.round(BASE_CANDLE_WIDTH * chartTimeZoom);
                  const VIEWPORT_HEIGHT = footprintExpanded ? (window.innerHeight - 150) : 340;
                  const PRICE_AXIS_WIDTH = 55;
                  const TIME_AXIS_HEIGHT = 50;

                  // Calculate price range from data - add extra padding to prevent clipping
                  const validCandles = paddedCandles.filter(c => !c.isEmpty && c.price_close > 0);
                  const allHighs = validCandles.map(c => c.price_high || c.price_close);
                  const allLows = validCandles.map(c => c.price_low || c.price_close);
                  const dataHigh = allHighs.length > 0 ? Math.max(...allHighs) : currentPrice + 5;
                  const dataLow = allLows.length > 0 ? Math.min(...allLows) : currentPrice - 5;

                  // Round to tick boundaries and add MORE padding to show full candles
                  const priceRange = dataHigh - dataLow;
                  const priceMid = (dataHigh + dataLow) / 2;
                  const zoomedRange = priceRange / chartPriceZoom;
                  // Add 10 rows padding above and below
                  const globalHigh = Math.ceil((priceMid + zoomedRange / 2 + ROW_PRICE_STEP * 10) / ROW_PRICE_STEP) * ROW_PRICE_STEP;
                  const globalLow = Math.floor((priceMid - zoomedRange / 2 - ROW_PRICE_STEP * 10) / ROW_PRICE_STEP) * ROW_PRICE_STEP;
                  const numRows = Math.round((globalHigh - globalLow) / ROW_PRICE_STEP);
                  const totalChartHeight = numRows * ROW_HEIGHT;
                  const totalChartWidth = paddedCandles.length * CANDLE_WIDTH;

                  // Generate price levels (rows) - from high to low
                  const priceLevels = [];
                  for (let i = 0; i < numRows; i++) {
                    priceLevels.push(globalHigh - (i * ROW_PRICE_STEP));
                  }

                  // Price to Y position - use viewport height for consistent rendering
                  const chartDisplayHeight = VIEWPORT_HEIGHT - 10;
                  const priceToY = (p) => ((globalHigh - p) / (globalHigh - globalLow)) * chartDisplayHeight;

                  // Format time for X-axis (always in ET timezone)
                  const formatTime = (ts) => {
                    if (!ts) return '';
                    const d = new Date(ts * 1000);
                    return d.toLocaleTimeString('en-US', {
                      hour: '2-digit',
                      minute: '2-digit',
                      hour12: false,
                      timeZone: 'America/New_York'
                    });
                  };

                  return (
                    <div style={{
                      background: 'linear-gradient(180deg, rgba(12,12,20,0.99) 0%, rgba(8,8,14,1) 100%)',
                      borderRadius: footprintExpanded ? 0 : 8,
                      border: footprintExpanded ? 'none' : '1px solid rgba(255,255,255,0.08)',
                      position: footprintExpanded ? 'fixed' : 'relative',
                      top: footprintExpanded ? 0 : undefined,
                      left: footprintExpanded ? 0 : undefined,
                      right: footprintExpanded ? 0 : undefined,
                      bottom: footprintExpanded ? 0 : undefined,
                      zIndex: footprintExpanded ? 9999 : 1,
                      overflow: 'hidden',
                      width: footprintExpanded ? '100vw' : '100%',
                      height: footprintExpanded ? '100vh' : undefined,
                      maxWidth: '100%',
                      boxSizing: 'border-box'
                    }}>
                      {/* Close button for expanded */}
                      {footprintExpanded && (
                        <button
                          onClick={() => setFootprintExpanded(false)}
                          style={{
                            position: 'absolute',
                            top: 20,
                            right: 20,
                            background: 'rgba(255,100,100,0.5)',
                            border: '1px solid rgba(255,100,100,0.7)',
                            borderRadius: 6,
                            padding: '10px 20px',
                            cursor: 'pointer',
                            fontSize: 14,
                            fontWeight: 600,
                            color: '#fff',
                            zIndex: 10000
                          }}
                        >
                          ‚úï Close Fullscreen
                        </button>
                      )}

                      {/* Main container with scrollable chart area */}
                      <div style={{ display: 'flex', flexDirection: 'column', maxWidth: '100%' }}>
                        {/* Chart + Right Price Axis */}
                        <div style={{ display: 'flex', maxWidth: '100%' }}>
                          {/* Scrollable Chart Area - always keeps newest candle on right */}
                          <div
                            ref={(el) => {
                              // Always scroll to right to show current candle
                              if (el && totalChartWidth > el.clientWidth) {
                                el.scrollLeft = totalChartWidth - el.clientWidth;
                              }
                            }}
                            style={{
                              flex: 1,
                              maxWidth: `calc(100% - ${PRICE_AXIS_WIDTH}px)`,
                              height: VIEWPORT_HEIGHT,
                              overflow: 'auto',
                              position: 'relative'
                            }}
                          >
                            {/* Inner scrollable content - add padding at end for scroll space */}
                            <div style={{
                              width: Math.max(totalChartWidth + 80, 400),
                              height: VIEWPORT_HEIGHT - 10,
                              position: 'relative',
                              background: 'rgba(8,8,14,1)',
                              paddingRight: 60
                            }}>

                              {/* Each Candlestick with TradingView footprint style */}
                              {paddedCandles.map((c, idx) => {
                                if (c.isEmpty) return null;

                                const buy = c.buy || 0;
                                const sell = c.sell || 0;
                                const high = c.price_high || c.price_close || currentPrice + 1;
                                const low = c.price_low || c.price_close || currentPrice - 1;
                                const open = c.price_open || c.price_close || currentPrice;
                                const close = c.price_close || currentPrice;
                                const isUp = close >= open;

                                // Y positions
                                const highY = priceToY(high);
                                const lowY = priceToY(low);
                                const openY = priceToY(open);
                                const closeY = priceToY(close);
                                const bodyTop = Math.min(openY, closeY);
                                const bodyHeight = Math.max(Math.abs(closeY - openY), 2);

                                // Generate volume rows - CONSTANT height, DYNAMIC count to fill candle
                                const candleRange = Math.max(high - low, ROW_PRICE_STEP);
                                // Calculate pixel height of candle
                                const candlePixelHeight = Math.max(lowY - highY, 20);
                                // CONSTANT row height
                                const ROW_H = footprintExpanded ? 12 : 10;
                                // DYNAMIC count - how many rows fit in the candle's pixel height
                                const numRows = Math.max(2, Math.floor(candlePixelHeight / ROW_H));
                                // Price step per row to cover full range
                                const pricePerRow = candleRange / numRows;
                                const volumeRows = [];
                                // Seeded random for stable values (no flickering)
                                const candleSeed = (c.ts || idx) * 9301 + 49297;

                                for (let i = 0; i < numRows; i++) {
                                  // Each row represents a price level
                                  const rowPrice = high - (i + 0.5) * pricePerRow;

                                  // Volume distribution - more volume near close price and POC
                                  const distFromClose = Math.abs(rowPrice - close) / (candleRange || 1);
                                  const closeWeight = Math.exp(-distFromClose * 2) * 0.6 + 0.3;

                                  // Add variation - some levels have more activity, some have 0
                                  const rowSeed = ((candleSeed + i * 7919) % 233280) / 233280;
                                  // Allow 0 volume at some levels (10% chance of 0)
                                  const hasVolume = rowSeed > 0.1;
                                  const activityMultiplier = !hasVolume ? 0 : rowSeed > 0.7 ? 1.8 : rowSeed > 0.4 ? 1.2 : 0.8;
                                  const weight = closeWeight * activityMultiplier;

                                  // Distribute buy/sell with price direction bias
                                  const priceRelative = (rowPrice - low) / (candleRange || 1);
                                  const buyBias = isUp ? (priceRelative > 0.5 ? 1.3 : 0.8) : (priceRelative < 0.5 ? 1.3 : 0.8);
                                  const sellBias = isUp ? (priceRelative < 0.5 ? 1.3 : 0.8) : (priceRelative > 0.5 ? 1.3 : 0.8);

                                  // Allow 0 volume (no Math.max(1, ...))
                                  const rowBuy = Math.round(buy * weight * buyBias / numRows);
                                  const rowSell = Math.round(sell * weight * sellBias / numRows);
                                  volumeRows.push({ price: rowPrice, sell: rowSell, buy: rowBuy });
                                }

                                // Find POC (highest volume) and max values for bar sizing
                                const maxVol = Math.max(...volumeRows.map(r => r.sell + r.buy), 1);
                                const maxSell = Math.max(...volumeRows.map(r => r.sell), 1);
                                const maxBuy = Math.max(...volumeRows.map(r => r.buy), 1);
                                volumeRows.forEach(r => r.isPOC = (r.sell + r.buy) === maxVol && maxVol > 0);

                                // Color gradient: Bright (high volume) ‚Üí White/light (low volume)
                                const getSellStyle = (volume, isPOC) => {
                                  if (isPOC) return { bg: '#ffffff', border: '2px solid #fff' };
                                  if (volume === 0) return { bg: 'rgba(60,40,40,0.4)', border: '1px solid rgba(80,60,60,0.3)' };
                                  const intensity = Math.min(1, volume / maxSell);
                                  // Bright red (high) ‚Üí Light pink/white (low)
                                  const r = 255;
                                  const g = Math.round(255 - intensity * 200); // 255 ‚Üí 55 (white ‚Üí red)
                                  const b = Math.round(255 - intensity * 200); // 255 ‚Üí 55
                                  return {
                                    bg: `rgb(${r},${g},${b})`,
                                    border: `1px solid rgba(255,${80 + (1-intensity)*120},${80 + (1-intensity)*120},0.8)`
                                  };
                                };
                                const getBuyStyle = (volume, isPOC) => {
                                  if (isPOC) return { bg: '#ffffff', border: '2px solid #fff' };
                                  if (volume === 0) return { bg: 'rgba(40,50,45,0.4)', border: '1px solid rgba(60,80,70,0.3)' };
                                  const intensity = Math.min(1, volume / maxBuy);
                                  // Bright green (high) ‚Üí Light green/white (low)
                                  const r = Math.round(255 - intensity * 200); // 255 ‚Üí 55 (white ‚Üí green)
                                  const g = 255;
                                  const b = Math.round(255 - intensity * 180); // 255 ‚Üí 75
                                  return {
                                    bg: `rgb(${r},${g},${b})`,
                                    border: `1px solid rgba(${100 + (1-intensity)*100},255,${100 + (1-intensity)*100},0.8)`
                                  };
                                };

                                // Layout zones: [Sell bars] [Candle] [Buy bars]
                                const candleZoneWidth = 12;
                                const barZoneWidth = (CANDLE_WIDTH - candleZoneWidth) / 2;

                                return (
                                  <div key={idx} style={{
                                    position: 'absolute',
                                    left: idx * CANDLE_WIDTH,
                                    top: 0,
                                    width: CANDLE_WIDTH,
                                    height: chartDisplayHeight,
                                    borderRight: '1px solid rgba(40,40,50,0.5)'
                                  }}>
                                    {/* Volume rows - CONSTANT height, filling candle from high to low */}
                                    {volumeRows.map((row, ri) => {
                                      // Position rows to stack from high to low
                                      const rowY = highY + ri * ROW_H;

                                      // Calculate bar widths - minimum width even for 0 volume
                                      const minBarWidth = 14;
                                      const sellBarWidth = row.sell === 0 ? minBarWidth : Math.max(minBarWidth, barZoneWidth * 0.3 + barZoneWidth * 0.7 * (row.sell / maxSell));
                                      const buyBarWidth = row.buy === 0 ? minBarWidth : Math.max(minBarWidth, barZoneWidth * 0.3 + barZoneWidth * 0.7 * (row.buy / maxBuy));

                                      // Get glass effect styles
                                      const sellStyle = getSellStyle(row.sell, row.isPOC);
                                      const buyStyle = getBuyStyle(row.buy, row.isPOC);
                                      // Colored text matching side - maroon for sell, dark green for buy
                                      const sellTextColor = row.isPOC ? '#000' : '#8b0000';
                                      const buyTextColor = row.isPOC ? '#000' : '#006400';

                                      return (
                                        <React.Fragment key={ri}>
                                          {/* SELL bar - LEFT of candle */}
                                          <div style={{
                                            position: 'absolute',
                                            left: barZoneWidth - sellBarWidth,
                                            top: rowY,
                                            width: sellBarWidth,
                                            height: ROW_H - 1,
                                            background: sellStyle.bg,
                                            border: sellStyle.border,
                                            borderRadius: '2px 0 0 2px',
                                            boxShadow: row.isPOC ? '0 0 4px rgba(255,255,255,0.8)' : 'none',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'flex-end',
                                            paddingRight: 2,
                                            fontSize: 8,
                                            fontFamily: 'monospace',
                                            color: row.sell === 0 ? '#666' : sellTextColor,
                                            fontWeight: row.isPOC ? 700 : 600,
                                            textShadow: 'none',
                                            overflow: 'hidden'
                                          }}>
                                            {footprintExpanded && row.sell}
                                          </div>
                                          {/* BUY bar - RIGHT of candle */}
                                          <div style={{
                                            position: 'absolute',
                                            left: barZoneWidth + candleZoneWidth,
                                            top: rowY,
                                            width: buyBarWidth,
                                            height: ROW_H - 1,
                                            background: buyStyle.bg,
                                            border: buyStyle.border,
                                            borderRadius: '0 2px 2px 0',
                                            boxShadow: row.isPOC ? '0 0 4px rgba(255,255,255,0.8)' : 'none',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'flex-start',
                                            paddingLeft: 2,
                                            fontSize: 8,
                                            fontFamily: 'monospace',
                                            color: row.buy === 0 ? '#666' : buyTextColor,
                                            fontWeight: row.isPOC ? 700 : 400,
                                            textShadow: row.isPOC || row.buy === 0 ? 'none' : '0 0 2px rgba(0,0,0,0.8)',
                                            overflow: 'hidden'
                                          }}>
                                            {footprintExpanded && row.buy}
                                          </div>
                                        </React.Fragment>
                                      );
                                    })}
                                    {/* Candlestick wick - CENTER */}
                                    <div style={{
                                      position: 'absolute',
                                      left: barZoneWidth + candleZoneWidth / 2 - 1,
                                      top: highY,
                                      width: 2,
                                      height: Math.max(lowY - highY, 1),
                                      background: isUp ? 'rgba(0,255,200,0.6)' : 'rgba(255,0,150,0.6)',
                                      boxShadow: isUp ? '0 0 3px rgba(0,255,255,0.5)' : '0 0 3px rgba(255,0,150,0.5)'
                                    }} />
                                    {/* Candlestick body - CENTER */}
                                    <div style={{
                                      position: 'absolute',
                                      left: barZoneWidth + 1,
                                      top: bodyTop,
                                      width: candleZoneWidth - 2,
                                      height: Math.max(bodyHeight, 3),
                                      background: isUp ? 'rgba(100,255,200,0.7)' : 'rgba(255,100,150,0.7)',
                                      border: isUp ? '1px solid rgba(0,255,255,0.9)' : '1px solid rgba(255,0,150,0.9)',
                                      borderRadius: 2,
                                      boxShadow: isUp ? '0 0 4px rgba(0,255,255,0.6)' : '0 0 4px rgba(255,0,150,0.6)'
                                    }} />
                                    {/* Current candle time tag - shown for the last (current) candle */}
                                    {idx === paddedCandles.length - 1 && c.ts && (
                                      <div style={{
                                        position: 'absolute',
                                        left: '50%',
                                        transform: 'translateX(-50%)',
                                        top: Math.min(lowY + 10, chartDisplayHeight - 25),
                                        background: '#00cccc',
                                        border: '2px solid #00ffff',
                                        borderRadius: 4,
                                        padding: '4px 12px',
                                        fontSize: 12,
                                        fontWeight: 700,
                                        color: '#000',
                                        whiteSpace: 'nowrap',
                                        boxShadow: '0 0 15px rgba(0,255,255,0.9)',
                                        zIndex: 500
                                      }}>
                                        {formatTime(c.ts)}
                                      </div>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>

                          {/* Right Y-Axis (Price) - Drag to zoom */}
                          <div
                            style={{
                              width: PRICE_AXIS_WIDTH,
                              height: VIEWPORT_HEIGHT,
                              overflow: 'hidden',
                              borderLeft: '1px solid rgba(255,255,255,0.2)',
                              background: 'rgba(20,20,30,0.95)',
                              display: 'flex',
                              flexDirection: 'column',
                              justifyContent: 'space-between',
                              padding: '4px 0',
                              cursor: 'ns-resize',
                              userSelect: 'none'
                            }}
                            onMouseDown={(e) => {
                              const startY = e.clientY;
                              const startZoom = chartPriceZoom;
                              const handleMove = (ev) => {
                                const delta = (startY - ev.clientY) / 100;
                                const newZoom = Math.max(0.5, Math.min(5, startZoom + delta));
                                setChartPriceZoom(newZoom);
                              };
                              const handleUp = () => {
                                document.removeEventListener('mousemove', handleMove);
                                document.removeEventListener('mouseup', handleUp);
                              };
                              document.addEventListener('mousemove', handleMove);
                              document.addEventListener('mouseup', handleUp);
                            }}
                            onWheel={(e) => {
                              e.preventDefault();
                              const delta = e.deltaY > 0 ? -0.1 : 0.1;
                              setChartPriceZoom(z => Math.max(0.5, Math.min(5, z + delta)));
                            }}
                          >
                            {/* Show 8 price levels evenly distributed */}
                            {[...Array(8)].map((_, i) => {
                              const price = globalHigh - (i * (globalHigh - globalLow) / 7);
                              return (
                                <div key={i} style={{
                                  fontSize: 9,
                                  fontFamily: 'monospace',
                                  color: '#aaa',
                                  paddingLeft: 4,
                                  lineHeight: 1
                                }}>
                                  {price.toFixed(1)}
                                </div>
                              );
                            })}
                          </div>
                        </div>

                        {/* Bottom X-Axis (Time) + Summary Rows */}
                        <div style={{
                          borderTop: '1px solid rgba(255,255,255,0.15)',
                          background: 'rgba(0,0,0,0.4)',
                          maxWidth: '100%',
                          overflowX: 'auto'
                        }}>
                          {/* Summary Row 1: Total Volume */}
                          <div style={{ display: 'flex', borderBottom: '1px solid rgba(255,255,255,0.08)' }}>
                            <div style={{ flex: 1, display: 'flex', overflowX: 'auto', justifyContent: 'flex-end', paddingRight: 60 }}>
                              {paddedCandles.map((c, idx) => (
                                <div key={idx} style={{
                                  width: CANDLE_WIDTH,
                                  flexShrink: 0,
                                  textAlign: 'center',
                                  fontSize: 8,
                                  fontFamily: 'monospace',
                                  color: '#777',
                                  padding: '2px 0'
                                }}>
                                  {c.isEmpty ? '' : ((c.buy || 0) + (c.sell || 0))}
                                </div>
                              ))}
                            </div>
                            <div style={{ width: PRICE_AXIS_WIDTH, flexShrink: 0 }} />
                          </div>

                          {/* Summary Row 2: Delta (colored) */}
                          <div style={{ display: 'flex', borderBottom: '1px solid rgba(255,255,255,0.08)' }}>
                            <div style={{ flex: 1, display: 'flex', overflowX: 'auto', justifyContent: 'flex-end', paddingRight: 60 }}>
                              {paddedCandles.map((c, idx) => {
                                const delta = c.delta || ((c.buy || 0) - (c.sell || 0));
                                const isPos = delta >= 0;
                                return (
                                  <div key={idx} style={{
                                    width: CANDLE_WIDTH,
                                    flexShrink: 0,
                                    textAlign: 'center',
                                    padding: '2px 1px'
                                  }}>
                                    {!c.isEmpty && (
                                      <span style={{
                                        fontSize: 8,
                                        fontFamily: 'monospace',
                                        fontWeight: 600,
                                        color: '#000',
                                        background: isPos ? '#40dd80' : '#ff5555',
                                        padding: '1px 4px',
                                        borderRadius: 2
                                      }}>
                                        {isPos ? '+' : ''}{typeof delta === 'number' ? delta.toFixed(0) : delta}
                                      </span>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                            <div style={{ width: PRICE_AXIS_WIDTH, flexShrink: 0 }} />
                          </div>

                          {/* Summary Row 4: Delta % */}
                          <div style={{ display: 'flex', borderBottom: '1px solid rgba(255,255,255,0.08)' }}>
                            <div style={{ flex: 1, display: 'flex', overflowX: 'auto', justifyContent: 'flex-end', paddingRight: 60 }}>
                              {paddedCandles.map((c, idx) => {
                                const delta = c.delta || ((c.buy || 0) - (c.sell || 0));
                                const vol = (c.buy || 0) + (c.sell || 0);
                                const pct = vol > 0 ? (delta / vol * 100) : 0;
                                return (
                                  <div key={idx} style={{
                                    width: CANDLE_WIDTH,
                                    flexShrink: 0,
                                    textAlign: 'center',
                                    fontSize: 7,
                                    fontFamily: 'monospace',
                                    color: pct >= 0 ? '#40dd80' : '#ff5555',
                                    padding: '1px 0'
                                  }}>
                                    {c.isEmpty ? '' : `${pct.toFixed(1)}%`}
                                  </div>
                                );
                              })}
                            </div>
                            <div style={{ width: PRICE_AXIS_WIDTH, flexShrink: 0 }} />
                          </div>

                          {/* Time Axis - Drag to zoom (TradingView style: drag right = zoom out, left = zoom in) */}
                          <div
                            style={{ display: 'flex', cursor: 'ew-resize', userSelect: 'none' }}
                            onMouseDown={(e) => {
                              const startX = e.clientX;
                              const startZoom = chartTimeZoom;
                              const handleMove = (ev) => {
                                // Drag right = zoom out (negative delta), drag left = zoom in (positive delta)
                                const delta = (startX - ev.clientX) / 100;
                                const newZoom = Math.max(0.5, Math.min(3, startZoom + delta));
                                setChartTimeZoom(newZoom);
                              };
                              const handleUp = () => {
                                document.removeEventListener('mousemove', handleMove);
                                document.removeEventListener('mouseup', handleUp);
                              };
                              document.addEventListener('mousemove', handleMove);
                              document.addEventListener('mouseup', handleUp);
                            }}
                            onWheel={(e) => {
                              e.preventDefault();
                              const delta = e.deltaY > 0 ? -0.1 : 0.1;
                              setChartTimeZoom(z => Math.max(0.5, Math.min(3, z + delta)));
                            }}
                          >
                            <div style={{ flex: 1, display: 'flex', overflowX: 'auto', justifyContent: 'flex-end', position: 'relative', paddingRight: 60 }}>
                              {paddedCandles.map((c, idx) => {
                                const isLast = idx === paddedCandles.length - 1;
                                return (
                                  <div key={idx} style={{
                                    width: CANDLE_WIDTH,
                                    flexShrink: 0,
                                    textAlign: 'center',
                                    fontSize: 8,
                                    fontFamily: 'monospace',
                                    padding: '3px 0'
                                  }}>
                                    {c.isEmpty ? '' : (
                                      <span style={{
                                        color: isLast ? '#00ffff' : '#555',
                                        fontWeight: isLast ? 700 : 400,
                                        background: isLast ? 'rgba(0,255,255,0.25)' : 'transparent',
                                        padding: isLast ? '2px 6px' : 0,
                                        borderRadius: isLast ? 4 : 0,
                                        border: isLast ? '1px solid rgba(0,255,255,0.7)' : 'none',
                                        boxShadow: isLast ? '0 0 6px rgba(0,255,255,0.5)' : 'none'
                                      }}>
                                        {formatTime(c.ts)}
                                      </span>
                                    )}
                                  </div>
                                );
                              })}
                              {/* Floating current candle time indicator - always visible */}
                              {paddedCandles.length > 0 && !paddedCandles[paddedCandles.length - 1].isEmpty && (
                                <div style={{
                                  position: 'absolute',
                                  right: 0,
                                  top: -20,
                                  background: 'rgba(0,255,255,0.3)',
                                  border: '1px solid rgba(0,255,255,0.8)',
                                  borderRadius: 4,
                                  padding: '2px 8px',
                                  fontSize: 9,
                                  fontWeight: 700,
                                  color: '#00ffff',
                                  boxShadow: '0 0 8px rgba(0,255,255,0.5)',
                                  zIndex: 100
                                }}>
                                  LIVE: {formatTime(paddedCandles[paddedCandles.length - 1].ts)}
                                </div>
                              )}
                            </div>
                            <div style={{ width: PRICE_AXIS_WIDTH, flexShrink: 0 }} />
                          </div>
                        </div>
                      </div>

                      {/* Expand button (when not expanded) */}
                      {!footprintExpanded && (
                        <button
                          onClick={() => setFootprintExpanded(true)}
                          style={{
                            position: 'absolute',
                            top: 8,
                            right: 8,
                            background: 'rgba(255,255,255,0.1)',
                            border: '1px solid rgba(255,255,255,0.2)',
                            borderRadius: 4,
                            padding: '4px 8px',
                            cursor: 'pointer',
                            fontSize: 10,
                            color: '#888',
                            zIndex: 200
                          }}
                        >
                          ‚õ∂ Expand
                        </button>
                      )}
                    </div>
                  );
                })()}</>
                )}
              </div>
            );
          })()}

          {/* BTC ETF Flows - Inside Right Panel */}
          {metrics?.contract === 'BTC-SPOT' && (
            <div style={{
              background: 'rgba(255,255,255,0.02)',
              border: '1px solid rgba(255,255,255,0.08)',
              borderRadius: 8,
              padding: 10,
              marginTop: 8
            }}>
              <div style={{ color: '#888', fontSize: 10, marginBottom: 8, letterSpacing: 1, fontWeight: 600, textAlign: 'center' }}>
                BTC ETF FLOWS & INSTITUTIONAL SENTIMENT
              </div>
          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
            {/* ETF Flow Summary */}
            <div style={{
              flex: '1 1 200px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#00aaff', fontWeight: 700, marginBottom: 6 }}>TOTAL ETF FLOWS</div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                <span style={{ fontSize: 9, color: '#888' }}>1D Flow</span>
                <span style={{
                  fontSize: 11,
                  fontWeight: 700,
                  color: etfFlowData.total_flow_1d_mm > 0 ? '#00ff88' : (etfFlowData.total_flow_1d_mm < 0 ? '#ff4466' : '#888')
                }}>
                  ${Math.abs(etfFlowData.total_flow_1d_mm || 0).toFixed(0)}M
                  {etfFlowData.total_flow_1d_mm > 0 ? ' IN' : (etfFlowData.total_flow_1d_mm < 0 ? ' OUT' : '')}
                </span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ fontSize: 9, color: '#888' }}>5D Flow</span>
                <span style={{
                  fontSize: 11,
                  fontWeight: 700,
                  color: etfFlowData.total_flow_5d_mm > 0 ? '#00ff88' : (etfFlowData.total_flow_5d_mm < 0 ? '#ff4466' : '#888')
                }}>
                  ${Math.abs(etfFlowData.total_flow_5d_mm || 0).toFixed(0)}M
                </span>
              </div>
            </div>

            {/* Individual ETFs */}
            {(etfFlowData.etfs || []).slice(0, 4).map((etf, idx) => (
              <div key={idx} style={{
                flex: '1 1 120px',
                background: 'rgba(255,255,255,0.02)',
                borderRadius: 6,
                padding: '6px 8px',
                textAlign: 'center'
              }}>
                <div style={{ fontSize: 10, color: '#ffaa00', fontWeight: 700, marginBottom: 4 }}>{etf.symbol}</div>
                <div style={{ fontSize: 12, fontWeight: 700, color: '#fff', marginBottom: 2 }}>
                  ${etf.price?.toFixed(2) || '--'}
                </div>
                <div style={{
                  fontSize: 9,
                  color: etf.price_change_1d > 0 ? '#00ff88' : (etf.price_change_1d < 0 ? '#ff4466' : '#888')
                }}>
                  {etf.price_change_1d > 0 ? '+' : ''}{etf.price_change_1d?.toFixed(2) || '0'}%
                </div>
              </div>
            ))}

            {/* Institutional Sentiment */}
            <div style={{
              flex: '1 1 180px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#9370DB', fontWeight: 700, marginBottom: 6 }}>INSTITUTIONAL SENTIMENT</div>
              {(() => {
                const btcSentiment = institutionalData?.bitcoin || {};
                const sentiment = btcSentiment.overall_sentiment || 'neutral';
                const sentimentColor = sentiment === 'bullish' ? '#00ff88' : (sentiment === 'bearish' ? '#ff4466' : '#888');
                return (
                  <>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Overall</span>
                      <span style={{ fontSize: 11, fontWeight: 700, color: sentimentColor, textTransform: 'uppercase' }}>
                        {sentiment}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 9, color: '#888' }}>ETF Trend</span>
                      <span style={{
                        fontSize: 10,
                        fontWeight: 600,
                        color: btcSentiment.etf_flow_trend === 'bullish' ? '#00ff88' : (btcSentiment.etf_flow_trend === 'bearish' ? '#ff4466' : '#888')
                      }}>
                        {btcSentiment.etf_flow_trend || 'neutral'}
                      </span>
                    </div>
                  </>
                );
              })()}
            </div>
          </div>

          {/* Second Row: Deribit Options & Funding Rates */}
          <div style={{ display: 'flex', gap: 8, marginTop: 8, flexWrap: 'wrap' }}>
            {/* Deribit Options / Max Pain */}
            <div style={{
              flex: '1 1 200px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#ff6b6b', fontWeight: 700, marginBottom: 6 }}>DERIBIT OPTIONS</div>
              {(() => {
                const opts = deribitData?.btc_options || {};
                return (
                  <>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Max Pain</span>
                      <span style={{ fontSize: 11, fontWeight: 700, color: '#ffaa00' }}>
                        ${(opts.max_pain || 0).toLocaleString()}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                      <span style={{ fontSize: 9, color: '#888' }}>P/C Ratio</span>
                      <span style={{
                        fontSize: 10,
                        fontWeight: 600,
                        color: opts.put_call_ratio > 1 ? '#ff4466' : (opts.put_call_ratio < 0.7 ? '#00ff88' : '#888')
                      }}>
                        {(opts.put_call_ratio || 0).toFixed(2)}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Sentiment</span>
                      <span style={{
                        fontSize: 10,
                        fontWeight: 600,
                        color: opts.sentiment === 'bullish' ? '#00ff88' : (opts.sentiment === 'bearish' ? '#ff4466' : '#888')
                      }}>
                        {opts.sentiment || 'neutral'}
                      </span>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* Call/Put Walls */}
            <div style={{
              flex: '1 1 150px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#00ff88', fontWeight: 700, marginBottom: 6 }}>GAMMA LEVELS</div>
              {(() => {
                const opts = deribitData?.btc_options || {};
                return (
                  <>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                      <span style={{ fontSize: 9, color: '#00ff88' }}>Call Wall</span>
                      <span style={{ fontSize: 10, fontWeight: 600, color: '#fff' }}>
                        ${(opts.call_wall || 0).toLocaleString()}
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 9, color: '#ff4466' }}>Put Wall</span>
                      <span style={{ fontSize: 10, fontWeight: 600, color: '#fff' }}>
                        ${(opts.put_wall || 0).toLocaleString()}
                      </span>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* Funding Rates */}
            <div style={{
              flex: '1 1 180px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#00aaff', fontWeight: 700, marginBottom: 6 }}>PERP FUNDING RATE</div>
              {(() => {
                const funding = fundingData?.funding_rates || {};
                const rate = funding.average || 0;
                const rateColor = rate > 0.01 ? '#00ff88' : (rate < -0.01 ? '#ff4466' : '#888');
                return (
                  <>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                      <span style={{ fontSize: 9, color: '#888' }}>8H Rate</span>
                      <span style={{ fontSize: 11, fontWeight: 700, color: rateColor }}>
                        {rate > 0 ? '+' : ''}{(rate || 0).toFixed(4)}%
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Annual</span>
                      <span style={{ fontSize: 10, fontWeight: 600, color: rateColor }}>
                        {funding.annualized > 0 ? '+' : ''}{(funding.annualized || 0).toFixed(1)}%
                      </span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Signal</span>
                      <span style={{
                        fontSize: 9,
                        fontWeight: 600,
                        color: funding.sentiment?.includes('bullish') ? '#00ff88' : (funding.sentiment?.includes('bearish') ? '#ff4466' : '#888')
                      }}>
                        {funding.sentiment?.replace('_', ' ') || 'neutral'}
                      </span>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* CME Basis */}
            <div style={{
              flex: '1 1 150px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#FFD700', fontWeight: 700, marginBottom: 6 }}>CME BASIS</div>
              {(() => {
                const cmeBasis = institutionalData?.bitcoin?.cme_basis || {};
                const basisPct = cmeBasis.basis_pct || 0;
                return (
                  <>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Futures vs Spot</span>
                      <span style={{ fontSize: 10, fontWeight: 600, color: basisPct > 0 ? '#00ff88' : '#ff4466' }}>
                        {basisPct > 0 ? '+' : ''}{basisPct.toFixed(2)}%
                      </span>
                    </div>
                    <div style={{ fontSize: 9, color: '#666' }}>Premium tracking</div>
                  </>
                );
              })()}
            </div>
          </div>

          {/* Third Row: COT Positioning - 4 equal columns with tooltips */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8, marginTop: 8 }}>
            {/* CME BTC COT Positioning with tooltips */}
            <div style={{
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#00aaff', fontWeight: 700, marginBottom: 6 }}>COT POSITIONING</div>
              {(() => {
                const cotData = institutionalData?.bitcoin?.cot || {};
                const sentiment = cotData.sentiment || 'neutral';
                const sentimentColor = sentiment === 'bullish' ? '#00ff88' : (sentiment === 'bearish' ? '#ff4466' : '#888');
                const amNet = cotData.asset_mgr_net || 0;
                const amPrev = cotData.asset_mgr_net_prev || 0;
                const amChange = cotData.asset_mgr_change || (amNet - amPrev);
                const lfNet = cotData.lev_funds_net || 0;
                const lfPrev = cotData.lev_funds_net_prev || 0;
                const lfChange = cotData.lev_funds_change || (lfNet - lfPrev);
                const reportDate = cotData.report_date || 'N/A';
                return (
                  <>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#00aaff', fontWeight: 600, marginBottom: 4 }}>Asset Managers Position</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: amNet > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{(amNet/1000).toFixed(1)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Week:</span>
                          <span style={{ color: '#aaa' }}>{(amPrev/1000).toFixed(1)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>WoW Change:</span>
                          <span style={{ color: amChange > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{amChange > 0 ? '+' : ''}{(amChange/1000).toFixed(1)}K</span>
                        </div>
                        <div style={{ marginTop: 4, fontSize: 9, color: '#666' }}>Report: {reportDate}</div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>Asset Mgrs</span>
                        <span style={{ fontSize: 9, fontWeight: 600, color: amNet > 0 ? '#00ff88' : '#ff4466' }}>
                          {amNet > 0 ? 'LONG' : 'SHORT'} <span style={{ fontSize: 8, color: amChange > 0 ? '#00ff88' : '#ff4466' }}>({amChange > 0 ? '+' : ''}{(amChange/1000).toFixed(1)}K)</span>
                        </span>
                      </div>
                    </Tooltip>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#00aaff', fontWeight: 600, marginBottom: 4 }}>Leveraged Funds Position</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: lfNet > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{(lfNet/1000).toFixed(1)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Week:</span>
                          <span style={{ color: '#aaa' }}>{(lfPrev/1000).toFixed(1)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>WoW Change:</span>
                          <span style={{ color: lfChange > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{lfChange > 0 ? '+' : ''}{(lfChange/1000).toFixed(1)}K</span>
                        </div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>Lev Funds</span>
                        <span style={{ fontSize: 9, fontWeight: 600, color: lfNet > 0 ? '#00ff88' : '#ff4466' }}>
                          {lfNet > 0 ? 'LONG' : 'SHORT'} <span style={{ fontSize: 8, color: lfChange > 0 ? '#00ff88' : '#ff4466' }}>({lfChange > 0 ? '+' : ''}{(lfChange/1000).toFixed(1)}K)</span>
                        </span>
                      </div>
                    </Tooltip>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Signal</span>
                      <span style={{ fontSize: 9, fontWeight: 600, color: sentimentColor, textTransform: 'capitalize' }}>
                        {sentiment}
                      </span>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* CME Open Interest with styled tooltips */}
            <div style={{
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#9370DB', fontWeight: 700, marginBottom: 6 }}>CME OPEN INTEREST</div>
              {(() => {
                const oiData = institutionalData?.bitcoin?.open_interest || {};
                const total = oiData.total || 0;
                const totalPrev = oiData.total_prev || 0;
                const change5d = oiData.change_5d_pct || 0;
                return (
                  <>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#9370DB', fontWeight: 600, marginBottom: 4 }}>CME Bitcoin Open Interest</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: '#fff', fontWeight: 600 }}>{(total/1000).toFixed(1)}K BTC</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Day:</span>
                          <span style={{ color: '#aaa' }}>{(totalPrev/1000).toFixed(1)}K BTC</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>5-Day Change:</span>
                          <span style={{ color: change5d > 0 ? '#00ff88' : '#ff4466' }}>{change5d > 0 ? '+' : ''}{change5d.toFixed(1)}%</span>
                        </div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>Total OI</span>
                        <span style={{ fontSize: 10, fontWeight: 600, color: '#fff' }}>
                          {(total / 1000).toFixed(1)}K BTC
                        </span>
                      </div>
                    </Tooltip>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#9370DB', fontWeight: 600, marginBottom: 4 }}>OI Change</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>24h:</span>
                          <span style={{ color: (oiData.change_pct || 0) > 0 ? '#00ff88' : '#ff4466' }}>{(oiData.change_pct || 0) > 0 ? '+' : ''}{(oiData.change_pct || 0).toFixed(1)}%</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>5-Day:</span>
                          <span style={{ color: change5d > 0 ? '#00ff88' : '#ff4466' }}>{change5d > 0 ? '+' : ''}{change5d.toFixed(1)}%</span>
                        </div>
                        <div style={{ marginTop: 4, fontSize: 9, color: '#666' }}>Rising OI + Rising Price = Bullish</div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>24h Change</span>
                        <span style={{ fontSize: 10, fontWeight: 600, color: (oiData.change_pct || 0) > 0 ? '#00ff88' : '#ff4466' }}>
                          {(oiData.change_pct || 0) > 0 ? '+' : ''}{(oiData.change_pct || 0).toFixed(1)}%
                        </span>
                      </div>
                    </Tooltip>
                  </>
                );
              })()}
            </div>

            {/* Grayscale Premium with styled tooltip */}
            <div style={{
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#888', fontWeight: 700, marginBottom: 6 }}>GBTC PREMIUM</div>
              {(() => {
                const gbtcData = institutionalData?.bitcoin?.gbtc || {};
                const premium = gbtcData.premium_pct || 0;
                const premiumPrev = gbtcData.premium_pct_prev || 0;
                const premiumChange = premium - premiumPrev;
                return (
                  <>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#888', fontWeight: 600, marginBottom: 4 }}>GBTC NAV Premium/Discount</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: premium > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{premium > 0 ? '+' : ''}{premium.toFixed(2)}%</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Day:</span>
                          <span style={{ color: '#aaa' }}>{premiumPrev > 0 ? '+' : ''}{premiumPrev.toFixed(2)}%</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Change:</span>
                          <span style={{ color: premiumChange > 0 ? '#00ff88' : '#ff4466' }}>{premiumChange > 0 ? '+' : ''}{premiumChange.toFixed(2)}%</span>
                        </div>
                        <div style={{ marginTop: 4, fontSize: 9, color: '#666' }}>Premium = bullish demand</div>
                        <div style={{ fontSize: 9, color: '#666' }}>Discount = bearish pressure</div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>NAV Premium</span>
                        <span style={{ fontSize: 11, fontWeight: 700, color: premium > 0 ? '#00ff88' : '#ff4466' }}>
                          {premium > 0 ? '+' : ''}{premium.toFixed(2)}%
                        </span>
                      </div>
                    </Tooltip>
                    <div style={{ fontSize: 9, color: '#666' }}>Institutional demand</div>
                  </>
                );
              })()}
            </div>

            {/* COT Report Date with styled tooltip */}
            <div style={{
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px',
              textAlign: 'center'
            }}>
              <Tooltip content={
                <div>
                  <div style={{ color: '#00aaff', fontWeight: 600, marginBottom: 4 }}>CFTC COT Report</div>
                  <div style={{ marginBottom: 4, color: '#aaa' }}>Commitments of Traders</div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: 16 }}>
                    <span style={{ color: '#888' }}>Data as of:</span>
                    <span style={{ color: '#fff' }}>Tuesday</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: 16 }}>
                    <span style={{ color: '#888' }}>Released:</span>
                    <span style={{ color: '#fff' }}>Friday 3:30pm ET</span>
                  </div>
                  <div style={{ marginTop: 6, fontSize: 9, color: '#666' }}>Shows institutional positioning in CME Bitcoin futures</div>
                </div>
              }>
                <div style={{ cursor: 'help' }}>
                  <div style={{ fontSize: 9, color: '#666', marginBottom: 4 }}>CFTC REPORT</div>
                  <div style={{ fontSize: 10, color: '#888' }}>Weekly Tuesday</div>
                  <div style={{ fontSize: 9, color: '#555' }}>Released Fri 3:30pm</div>
                </div>
              </Tooltip>
            </div>
          </div>
        </div>
          )}

          {/* Aligned Charts Container - Price OHLC, Delta OHLC - Inside Right Panel */}
          {(() => {
            // Shared data preparation for charts
            // Fixed 22 candles for all timeframes (21 history + 1 current)
            // Backend array is newest-first, so take first 21 and reverse to get oldest-to-newest for chart
            const historyCount = 21;
            const rawHistory = [...volumeHistory].slice(0, historyCount).reverse();

            const CANDLE_GAP = 3;
            const chartHeight = 180; // Compact height for right panel

            // Build unified candle array - CALCULATE cumulative delta in frontend for consistency
            let runningCumulativeDelta = 0;
            const dataCandles = rawHistory.map((c, idx, arr) => {
              const periodDelta = c.delta ?? 0;
              const candleVol = (c.buy || 0) + (c.sell || 0);
              const deltaPct = candleVol > 0 ? ((periodDelta / candleVol) * 100) : 0;
              const prevDelta = idx > 0 ? (arr[idx-1].delta || 0) : 0;
              const deltaChange = periodDelta - prevDelta;

              // Calculate cumulative delta OHLC in frontend
              const deltaOpen = runningCumulativeDelta;
              runningCumulativeDelta += periodDelta;
              const deltaClose = runningCumulativeDelta;
              const wickExtension = Math.abs(periodDelta) * 0.15;
              const deltaHigh = Math.max(deltaOpen, deltaClose) + wickExtension;
              const deltaLow = Math.min(deltaOpen, deltaClose) - wickExtension;

              return {
                price_open: c.price_open || 0,
                price_high: c.price_high || 0,
                price_low: c.price_low || 0,
                price_close: c.price_close || 0,
                // Cumulative delta OHLC calculated in frontend
                delta_open: deltaOpen,
                delta_high: deltaHigh,
                delta_low: deltaLow,
                delta_close: deltaClose,
                delta: periodDelta,
                deltaPct,
                deltaChange,
                volume: candleVol,
                ts: c.ts || 0,
                isCurrent: false,
                isEmpty: false
              };
            });

            // Add current candle - MUST continue from last history candle's cumulative delta
            if (volumeData.buy > 0 || volumeData.sell > 0 || volumeData.price_open > 0) {
              const currentPeriodDelta = volumeData.delta ?? 0;
              const currentDeltaPct = totalVol > 0 ? ((currentPeriodDelta / totalVol) * 100) : 0;
              const lastHistDelta = rawHistory.length > 0 ? (rawHistory[rawHistory.length - 1].delta || 0) : 0;
              const currentDeltaChange = currentPeriodDelta - lastHistDelta;

              // CRITICAL: Continue cumulative from last history candle to maintain proper scale
              const lastCumulativeDelta = dataCandles.length > 0 ? dataCandles[dataCandles.length - 1].delta_close : 0;
              const currentDeltaOpen = lastCumulativeDelta;
              const currentDeltaClose = lastCumulativeDelta + currentPeriodDelta;
              // Calculate high/low as extensions from the candle body
              const wickExtension = Math.abs(currentPeriodDelta) * 0.15;
              const currentDeltaHigh = Math.max(currentDeltaOpen, currentDeltaClose) + wickExtension;
              const currentDeltaLow = Math.min(currentDeltaOpen, currentDeltaClose) - wickExtension;

              dataCandles.push({
                price_open: volumeData.price_open || 0,
                price_high: volumeData.price_high || currentPrice,
                price_low: volumeData.price_low || currentPrice,
                price_close: currentPrice,
                // Cumulative delta OHLC - calculated to continue from history
                delta_open: currentDeltaOpen,
                delta_high: currentDeltaHigh,
                delta_low: currentDeltaLow,
                delta_close: currentDeltaClose,
                delta: currentPeriodDelta,
                deltaPct: currentDeltaPct,
                deltaChange: currentDeltaChange,
                volume: totalVol,
                ts: volumeData.candle_start || Date.now() / 1000,
                isCurrent: true,
                isEmpty: false
              });
            }

            // No padding - use only actual candles
            const allCandles = dataCandles;

            // Filter valid price candles
            const validPriceCandles = allCandles.filter(c => c.price_open > 0);

            // Calculate ranges for Y-axis scaling
            const priceHighs = validPriceCandles.map(c => c.price_high);
            const priceLows = validPriceCandles.map(c => c.price_low);
            const priceMax = priceHighs.length > 0 ? Math.max(...priceHighs) : 0;
            const priceMin = priceLows.length > 0 ? Math.min(...priceLows) : 0;
            const priceRange = (priceMax - priceMin) || 1;
            const priceYMax = priceMax + priceRange * 0.1;
            const priceYMin = priceMin - priceRange * 0.1;
            const priceYRange = priceYMax - priceYMin || 1;

            const validDeltaCandles = allCandles;
            const deltaHighs = validDeltaCandles.map(c => c.delta_high);
            const deltaLows = validDeltaCandles.map(c => c.delta_low);
            const deltaMax = deltaHighs.length > 0 ? Math.max(...deltaHighs) : 0;
            const deltaMin = deltaLows.length > 0 ? Math.min(...deltaLows) : 0;
            const deltaRange = (deltaMax - deltaMin) || 50;
            const deltaYMax = deltaMax + deltaRange * 0.15;
            const deltaYMin = deltaMin - deltaRange * 0.15;
            const deltaYRange = deltaYMax - deltaYMin || 1;

            const priceToY = (p) => ((priceYMax - p) / priceYRange) * chartHeight;
            const deltaToY = (d) => ((deltaYMax - d) / deltaYRange) * chartHeight;

            // Format timestamp to ET time
            const formatETTime = (ts) => {
              if (!ts) return '';
              const date = new Date(ts * 1000);
              return date.toLocaleString('en-US', {
                timeZone: 'America/New_York',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
              });
            };

            // Format large numbers
            const formatK = (v) => Math.abs(v) >= 1000 ? `${(v/1000).toFixed(1)}k` : Math.round(v);

            return (
              <div style={{ display: 'flex', flexDirection: 'column', gap: 6, marginTop: 8 }}>
                {/* OHLC Charts Header with Toggle */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4 }}>
                  <span style={{ color: '#888', fontSize: 10, fontWeight: 600, letterSpacing: 1 }}>
                    PRICE & DELTA CHARTS
                  </span>
                  <button
                    onClick={() => setShowOHLCCharts(!showOHLCCharts)}
                    style={{
                      background: showOHLCCharts ? 'rgba(255,255,255,0.1)' : 'rgba(255,255,255,0.05)',
                      border: '1px solid rgba(255,255,255,0.2)',
                      borderRadius: 4,
                      padding: '3px 8px',
                      fontSize: 9,
                      color: '#888',
                      cursor: 'pointer'
                    }}
                  >
                    {showOHLCCharts ? 'Hide Charts' : 'Show Charts'}
                  </button>
                </div>

                {showOHLCCharts && (
                <>
                {/* Price OHLC */}
                <div style={{
                  background: 'rgba(255,255,255,0.02)',
                  border: '1px solid rgba(255,255,255,0.1)',
                  borderRadius: 8,
                  padding: '8px 10px',
                  overflow: 'hidden'
                }}>
                  <div style={{ color: '#888', fontSize: 10, marginBottom: 6, letterSpacing: 1 }}>PRICE OHLC</div>
                  <div style={{ display: 'flex', gap: CANDLE_GAP, height: chartHeight, overflow: 'hidden', position: 'relative' }}>
                    {allCandles.map((c, idx) => {
                      if (c.price_open <= 0) return null;
                      const isUp = c.price_close >= c.price_open;
                      const bodyTop = priceToY(Math.max(c.price_open, c.price_close));
                      const bodyHeight = Math.max(Math.abs(priceToY(c.price_open) - priceToY(c.price_close)), 2);
                      const wickTop = priceToY(c.price_high);
                      const wickHeight = priceToY(c.price_low) - wickTop;
                      const color = isUp ? '#00ff88' : '#ff4466';
                      const opacity = c.isCurrent ? 1 : (0.5 + (idx / allCandles.length) * 0.5);
                      const isHovered = hoveredChartCandle === idx;
                      return (
                        <div
                          key={idx}
                          style={{ position: 'relative', flex: '1 1 0', minWidth: 0, height: chartHeight, opacity: isHovered ? 1 : opacity, cursor: 'crosshair' }}
                          onMouseEnter={() => setHoveredChartCandle(idx)}
                          onMouseLeave={() => setHoveredChartCandle(null)}
                        >
                          {/* Crosshair vertical line */}
                          {isHovered && (
                            <div style={{ position: 'absolute', left: '50%', top: 0, bottom: 0, width: 0, borderLeft: '1px dashed rgba(255,255,255,0.4)', transform: 'translateX(-50%)', pointerEvents: 'none', zIndex: 10 }} />
                          )}
                          <div style={{ position: 'absolute', left: '50%', transform: 'translateX(-50%)', top: wickTop, width: 1, height: wickHeight, background: color, opacity: 0.7 }} />
                          <div style={{ position: 'absolute', left: '50%', transform: 'translateX(-50%)', top: bodyTop, width: c.isCurrent ? '90%' : '70%', height: bodyHeight, background: color, borderRadius: 1, border: c.isCurrent ? '1px solid rgba(255,255,255,0.5)' : 'none' }} />
                          {/* Timestamp tooltip on hover */}
                          {isHovered && c.ts && !c.isCurrent && (
                            <div style={{
                              position: 'absolute', top: 4, left: '50%', transform: 'translateX(-50%)',
                              background: 'rgba(0,0,0,0.9)', border: '1px solid rgba(255,255,255,0.2)',
                              borderRadius: 4, padding: '2px 6px', fontSize: 9, color: '#aaa',
                              whiteSpace: 'nowrap', pointerEvents: 'none', zIndex: 100
                            }}>
                              {formatETTime(c.ts)}
                            </div>
                          )}
                          {/* Current candle time label */}
                          {c.isCurrent && c.ts && (
                            <div style={{
                              position: 'absolute', bottom: -16, left: '50%', transform: 'translateX(-50%)',
                              background: 'rgba(0,170,255,0.3)', border: '1px solid rgba(0,170,255,0.6)',
                              borderRadius: 3, padding: '1px 4px', fontSize: 8, fontWeight: 600, color: '#00aaff',
                              whiteSpace: 'nowrap', pointerEvents: 'none', zIndex: 50
                            }}>
                              {formatETTime(c.ts)}
                            </div>
                          )}
                        </div>
                      );
                    })}

                    {/* Big Trades Bubble Overlay */}
                    {(() => {
                      // Merge live trades with historical trades (deduplicate by timestamp)
                      const liveTrades = metrics.big_trades || [];
                      const historicalTrades = metrics.big_trades_historical || [];
                      const seenTs = new Set(liveTrades.map(t => t.ts));
                      const mergedTrades = [...liveTrades, ...historicalTrades.filter(t => !seenTs.has(t.ts))];
                      const bigTrades = mergedTrades.sort((a, b) => b.ts - a.ts); // Newest first
                      if (bigTrades.length === 0) return null;

                      const candleWidth = 100 / allCandles.length; // Percentage width per candle

                      // Get candle interval based on current timeframe
                      const candleInterval = volumeTimeframe === '5m' ? 300 : volumeTimeframe === '15m' ? 900 : volumeTimeframe === '30m' ? 1800 : 3600;

                      // Get visible time range - use full candle interval, not hardcoded 300
                      const visibleCandles = allCandles.filter(c => c.ts > 0);
                      const minTs = visibleCandles.length > 0 ? Math.min(...visibleCandles.map(c => c.ts)) : 0;
                      const maxTs = visibleCandles.length > 0 ? Math.max(...visibleCandles.map(c => c.ts)) + candleInterval * 2 : 0;

                      // Filter trades within visible range - include ALL trades in the time range
                      const visibleTrades = bigTrades.filter(t => t.ts >= minTs && t.ts <= maxTs);

                      // Calculate notional value per contract (GC = 100 oz)
                      const contractMultipliers = { GC: 100, NQ: 20, ES: 50, CL: 1000, BTC: 1 };
                      const assetClass = metrics.asset_class || 'GC';
                      const multiplier = contractMultipliers[assetClass] || 100;
                      const avgTradeSize = metrics.threshold_stats?.avg_size || 3;
                      const threshold = metrics.big_trade_threshold || 10;

                      return (
                        <>
                        <svg
                          style={{
                            position: 'absolute',
                            top: 0,
                            left: 0,
                            width: '100%',
                            height: chartHeight,
                            pointerEvents: 'none',  // SVG itself doesn't capture events
                            zIndex: 25,
                            overflow: 'visible'
                          }}
                        >
                          {/* Gradient Definitions for Glass Bubbles */}
                          <defs>
                            {/* Buy Gradient - Green */}
                            <radialGradient id="buyGradient" cx="30%" cy="30%" r="70%">
                              <stop offset="0%" stopColor="#88ffcc" stopOpacity="0.9" />
                              <stop offset="40%" stopColor="#00ff88" stopOpacity="0.7" />
                              <stop offset="100%" stopColor="#006633" stopOpacity="0.5" />
                            </radialGradient>
                            <radialGradient id="buyGradientHover" cx="30%" cy="30%" r="70%">
                              <stop offset="0%" stopColor="#ccffee" stopOpacity="1" />
                              <stop offset="30%" stopColor="#44ffaa" stopOpacity="0.9" />
                              <stop offset="100%" stopColor="#00cc66" stopOpacity="0.7" />
                            </radialGradient>
                            {/* Sell Gradient - Red */}
                            <radialGradient id="sellGradient" cx="30%" cy="30%" r="70%">
                              <stop offset="0%" stopColor="#ffaaaa" stopOpacity="0.9" />
                              <stop offset="40%" stopColor="#ff4466" stopOpacity="0.7" />
                              <stop offset="100%" stopColor="#881133" stopOpacity="0.5" />
                            </radialGradient>
                            <radialGradient id="sellGradientHover" cx="30%" cy="30%" r="70%">
                              <stop offset="0%" stopColor="#ffdddd" stopOpacity="1" />
                              <stop offset="30%" stopColor="#ff6688" stopOpacity="0.9" />
                              <stop offset="100%" stopColor="#cc2244" stopOpacity="0.7" />
                            </radialGradient>
                            {/* Glow filters */}
                            <filter id="buyGlow" x="-50%" y="-50%" width="200%" height="200%">
                              <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                              <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                              </feMerge>
                            </filter>
                            <filter id="sellGlow" x="-50%" y="-50%" width="200%" height="200%">
                              <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                              <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                              </feMerge>
                            </filter>
                          </defs>
                          {visibleTrades.map((trade, i) => {
                            // Find which candle this trade belongs to (by timestamp)
                            const tradeTime = trade.ts;
                            const candleIndex = allCandles.findIndex((c, idx) => {
                              if (!c.ts) return false;
                              const candleStart = c.ts;
                              // For the last candle (current), extend the window to capture all recent trades
                              const isLastCandle = idx === allCandles.length - 1;
                              const candleEnd = isLastCandle
                                ? candleStart + candleInterval * 2 // Double interval for current candle
                                : candleStart + candleInterval; // Use correct interval for completed candles
                              return tradeTime >= candleStart && tradeTime < candleEnd;
                            });

                            if (candleIndex === -1) return null;

                            // X position: center of the candle (percentage-based)
                            const xPercent = (candleIndex + 0.5) * candleWidth;

                            // Y position: map trade price to chart Y coordinate
                            const y = priceToY(trade.price);

                            // Radius: proportional to trade size (sqrt for visual balance)
                            // Scale down for longer timeframes (more trades per candle)
                            const radiusScale = volumeTimeframe === '5m' ? 2 : volumeTimeframe === '15m' ? 1.5 : volumeTimeframe === '30m' ? 1.2 : 0.8;
                            const maxRadius = volumeTimeframe === '1h' ? 14 : volumeTimeframe === '30m' ? 16 : 22;
                            const baseRadius = Math.min(maxRadius, Math.max(6, Math.sqrt(trade.size) * radiusScale));

                            // Use trade.ts as stable identifier (won't change on re-render)
                            const tradeId = trade.ts;
                            const isHovered = hoveredBigTrade === tradeId;
                            const radius = isHovered ? baseRadius * 1.5 : baseRadius;

                            // Gradient and color based on side
                            const isBuy = trade.side === 'BUY';
                            const gradientId = isBuy
                              ? (isHovered ? 'url(#buyGradientHover)' : 'url(#buyGradient)')
                              : (isHovered ? 'url(#sellGradientHover)' : 'url(#sellGradient)');
                            const glowColor = isBuy ? '#00ff88' : '#ff4466';
                            const strokeColor = isBuy ? '#00ff88' : '#ff4466';

                            return (
                              <g
                                key={tradeId}
                                style={{ cursor: 'pointer', pointerEvents: 'all' }}
                                onMouseEnter={() => handleBigTradeHover(tradeId)}
                                onMouseLeave={handleBigTradeLeave}
                              >
                                {/* Invisible hitbox for better click detection */}
                                <circle
                                  cx={`${xPercent}%`}
                                  cy={y}
                                  r={radius + 15}
                                  fill="transparent"
                                  style={{ pointerEvents: 'visiblePainted', cursor: 'pointer' }}
                                />
                                {/* Outer glow ring */}
                                <circle
                                  cx={`${xPercent}%`}
                                  cy={y}
                                  r={radius + (isHovered ? 12 : 4)}
                                  fill="none"
                                  stroke={glowColor}
                                  strokeWidth={isHovered ? 3 : 1}
                                  strokeOpacity={isHovered ? 0.5 : 0.2}
                                  style={{ transition: 'all 0.2s ease', pointerEvents: 'none' }}
                                />
                                {/* Soft glow background */}
                                <circle
                                  cx={`${xPercent}%`}
                                  cy={y}
                                  r={radius + (isHovered ? 6 : 2)}
                                  fill={glowColor}
                                  fillOpacity={isHovered ? 0.25 : 0.1}
                                  style={{ transition: 'all 0.2s ease' }}
                                />
                                {/* Main gradient bubble */}
                                <circle
                                  cx={`${xPercent}%`}
                                  cy={y}
                                  r={radius}
                                  fill={gradientId}
                                  stroke={isHovered ? '#ffffff' : strokeColor}
                                  strokeWidth={isHovered ? 2 : 1}
                                  filter={isHovered ? (isBuy ? 'url(#buyGlow)' : 'url(#sellGlow)') : 'none'}
                                  style={{ transition: 'all 0.2s ease' }}
                                />
                                {/* Glass highlight - top shine */}
                                <ellipse
                                  cx={`${xPercent}%`}
                                  cy={y - radius * 0.35}
                                  rx={radius * 0.5}
                                  ry={radius * 0.25}
                                  fill="rgba(255,255,255,0.4)"
                                  style={{ transition: 'all 0.2s ease' }}
                                />
                                {/* Volume label */}
                                {(trade.size >= 10 || isHovered) && (
                                  <text
                                    x={`${xPercent}%`}
                                    y={y + (isHovered ? 4 : 3)}
                                    textAnchor="middle"
                                    fontSize={isHovered ? 11 : 8}
                                    fontWeight="bold"
                                    fill="#fff"
                                    style={{
                                      transition: 'all 0.2s ease',
                                      textShadow: '0 1px 2px rgba(0,0,0,0.8)'
                                    }}
                                  >
                                    {trade.size >= 1000 ? `${(trade.size/1000).toFixed(1)}K` : trade.size}
                                  </text>
                                )}
                              </g>
                            );
                          })}
                          {/* Show count if trades exist but none in visible range */}
                          {visibleTrades.length === 0 && bigTrades.length > 0 && (
                            <text x="50%" y="20" textAnchor="middle" fontSize={9} fill="#666">
                              {bigTrades.length} big trades ({historicalTrades.length} historical) - scroll to see
                            </text>
                          )}
                        </svg>

                        {/* Hover Tooltip - positioned outside SVG */}
                        {hoveredBigTrade !== null && (() => {
                          // Find trade by timestamp (stable identifier)
                          const trade = visibleTrades.find(t => t.ts === hoveredBigTrade);
                          if (!trade) return null;

                          // Find candle index for this trade to determine tooltip position
                          const tradeTime = trade.ts;
                          const tradeCandleIndex = allCandles.findIndex((c, idx) => {
                            if (!c.ts) return false;
                            const candleStart = c.ts;
                            const isLastCandle = idx === allCandles.length - 1;
                            const candleEnd = isLastCandle ? candleStart + candleInterval * 2 : candleStart + candleInterval;
                            return tradeTime >= candleStart && tradeTime < candleEnd;
                          });

                          // Position tooltip on left if trade is in right 30% of chart
                          const isRightSide = tradeCandleIndex >= allCandles.length * 0.7;

                          const notional = trade.size * trade.price * multiplier;
                          const vsAvg = avgTradeSize > 0 ? (trade.size / avgTradeSize).toFixed(1) : '‚Äî';
                          const tradeTimeStr = new Date(trade.ts * 1000).toLocaleString('en-US', {
                            timeZone: 'America/New_York',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                          });
                          return (
                            <div style={{
                              position: 'absolute',
                              top: 4,
                              ...(isRightSide ? { left: 4 } : { right: 4 }),
                              background: 'rgba(10,10,20,0.95)',
                              border: `2px solid ${trade.side === 'BUY' ? '#00ff88' : '#ff4466'}`,
                              borderRadius: 8,
                              padding: 10,
                              zIndex: 100,
                              minWidth: 180,
                              boxShadow: `0 4px 20px ${trade.side === 'BUY' ? 'rgba(0,255,136,0.3)' : 'rgba(255,68,102,0.3)'}`
                            }}>
                              <div style={{ fontSize: 12, fontWeight: 700, color: trade.side === 'BUY' ? '#00ff88' : '#ff4466', marginBottom: 6 }}>
                                {trade.side === 'BUY' ? 'üü¢ BIG BUY' : 'üî¥ BIG SELL'}
                              </div>
                              <div style={{ display: 'grid', gridTemplateColumns: '80px 1fr', gap: '3px 8px', fontSize: 10 }}>
                                <span style={{ color: '#666' }}>Size:</span>
                                <span style={{ color: '#fff', fontWeight: 700 }}>{trade.size} contracts</span>
                                <span style={{ color: '#666' }}>Price:</span>
                                <span style={{ color: '#fff' }}>${trade.price.toFixed(2)}</span>
                                <span style={{ color: '#666' }}>Notional:</span>
                                <span style={{ color: '#ffaa00', fontWeight: 600 }}>${(notional / 1000000).toFixed(2)}M</span>
                                <span style={{ color: '#666' }}>vs Average:</span>
                                <span style={{ color: parseFloat(vsAvg) > 2 ? '#00ff88' : '#fff' }}>{vsAvg}x larger</span>
                                <span style={{ color: '#666' }}>Time:</span>
                                <span style={{ color: '#888' }}>{tradeTimeStr} ET</span>
                                {trade.date && (
                                  <>
                                    <span style={{ color: '#666' }}>Date:</span>
                                    <span style={{ color: '#888' }}>{trade.date}</span>
                                  </>
                                )}
                              </div>
                              <div style={{ marginTop: 6, paddingTop: 6, borderTop: '1px solid rgba(255,255,255,0.1)', fontSize: 9, color: '#666' }}>
                                Top 10% of trades by size {trade.date ? '(historical)' : '(live)'}
                              </div>
                            </div>
                          );
                        })()}
                        </>
                      );
                    })()}
                  </div>

                  {/* Big Trades Legend */}
                  <div style={{ display: 'flex', gap: 12, justifyContent: 'center', alignItems: 'center', marginTop: 4, fontSize: 9 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 3 }}>
                      <div style={{ width: 8, height: 8, borderRadius: '50%', background: '#00ff88', opacity: 0.7 }} />
                      <span style={{ color: '#888' }}>BIG BUY</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 3 }}>
                      <div style={{ width: 8, height: 8, borderRadius: '50%', background: '#ff4466', opacity: 0.7 }} />
                      <span style={{ color: '#888' }}>BIG SELL</span>
                    </div>
                    <span style={{ color: '#666' }}>|</span>
                    <div style={{ color: '#f97316' }}>
                      {(metrics.big_trades || []).length} live + {(metrics.big_trades_historical || []).length} historical ‚â•{metrics.big_trade_threshold || 10} (P90)
                    </div>
                  </div>
                </div>

                {/* Delta OHLC with Stats Table */}
                <div style={{
                  background: 'rgba(255,255,255,0.02)',
                  border: '1px solid rgba(255,255,255,0.1)',
                  borderRadius: 8,
                  padding: '8px 10px',
                  overflow: 'hidden'
                }}>
                  <div style={{ color: '#888', fontSize: 10, marginBottom: 6, letterSpacing: 1 }}>DELTA OHLC ‚Ä¢ DIVERGENCE GLOW</div>
                  <div style={{ display: 'flex', gap: CANDLE_GAP, height: chartHeight, overflow: 'hidden', position: 'relative' }}>
                    {allCandles.map((c, idx) => {
                      const dOpen = c.delta_open;
                      const dHigh = c.delta_high;
                      const dLow = c.delta_low;
                      const dClose = c.delta_close;
                      const pOpen = c.price_open;
                      const pClose = c.price_close;
                      const isUp = dClose >= dOpen;
                      const priceIsUp = pClose >= pOpen;
                      const isDiverging = isUp !== priceIsUp;
                      const bodyTop = deltaToY(Math.max(dOpen, dClose));
                      const bodyHeight = Math.max(Math.abs(deltaToY(dOpen) - deltaToY(dClose)), 2);
                      const wickTop = deltaToY(dHigh);
                      const wickHeight = deltaToY(dLow) - wickTop;
                      const color = isUp ? '#00ff88' : '#ff4466';
                      const opacity = c.isCurrent ? 1 : (0.5 + (idx / allCandles.length) * 0.5);
                      const isHovered = hoveredChartCandle === idx;
                      return (
                        <div
                          key={idx}
                          style={{ position: 'relative', flex: '1 1 0', minWidth: 0, height: chartHeight, opacity: isHovered ? 1 : opacity, cursor: 'crosshair' }}
                          onMouseEnter={() => setHoveredChartCandle(idx)}
                          onMouseLeave={() => setHoveredChartCandle(null)}
                        >
                          {/* Crosshair vertical line */}
                          {isHovered && (
                            <div style={{ position: 'absolute', left: '50%', top: 0, bottom: 0, width: 0, borderLeft: '1px dashed rgba(255,255,255,0.4)', transform: 'translateX(-50%)', pointerEvents: 'none', zIndex: 10 }} />
                          )}
                          <div style={{ position: 'absolute', left: '50%', transform: 'translateX(-50%)', top: wickTop, width: 1, height: Math.max(wickHeight, 0), background: color, opacity: 0.7 }} />
                          <div style={{
                            position: 'absolute', left: '50%', transform: 'translateX(-50%)', top: bodyTop,
                            width: c.isCurrent ? '90%' : '70%', height: bodyHeight, background: color, borderRadius: 1,
                            border: c.isCurrent ? '1px solid rgba(255,255,255,0.5)' : 'none',
                            boxShadow: isDiverging ? `0 0 8px ${color}, 0 0 12px ${color}` : 'none'
                          }} />
                        </div>
                      );
                    })}
                  </div>
                  {/* Delta Stats - Aligned under each candle */}
                  <div style={{ display: 'flex', gap: CANDLE_GAP, marginTop: 6 }}>
                    {allCandles.map((c, idx) => {
                      const deltaColor = c.delta >= 0 ? '#00ff88' : '#ff4466';
                      const opacity = c.isCurrent ? 1 : (0.5 + (idx / allCandles.length) * 0.5);
                      const formatVol = (v) => Math.abs(v) >= 1000 ? `${(v/1000).toFixed(1)}k` : Math.round(v);
                      const isHovered = hoveredChartCandle === idx;
                      return (
                        <div
                          key={idx}
                          onMouseEnter={() => setHoveredChartCandle(idx)}
                          onMouseLeave={() => setHoveredChartCandle(null)}
                          style={{
                            flex: '1 1 0',
                            minWidth: 0,
                            textAlign: 'center',
                            opacity: isHovered ? 1 : opacity,
                            background: c.isCurrent ? 'rgba(0,170,255,0.12)' : isHovered ? 'rgba(255,255,255,0.05)' : 'transparent',
                            borderRadius: 4,
                            padding: '3px 1px',
                            border: c.isCurrent ? '1px solid rgba(0,170,255,0.25)' : 'none',
                            cursor: 'pointer',
                            transition: 'opacity 0.15s'
                          }}
                        >
                          <div style={{ fontSize: 8, color: '#666', fontFamily: 'monospace', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                            {formatETTime(c.ts)}
                          </div>
                          <div style={{ fontSize: 10, color: deltaColor, fontFamily: 'monospace', fontWeight: 700 }}>
                            {c.deltaPct >= 0 ? '+' : ''}{(c.deltaPct || 0).toFixed(0)}%
                          </div>
                          <div style={{ fontSize: 8, color: '#888', fontFamily: 'monospace' }}>
                            {formatVol(c.volume || 0)}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
                </>
                )}
              </div>
            );
          })()}

          {/* ORDER FLOW ANALYSIS */}
      {(() => {
        const history = metrics.volume_5m?.history || [];
        const needsMoreData = history.length < 5;

        // Calculate CVD trend
        const recent = history.slice(0, 10);
        const older = history.slice(10, 20);
        const recentCvd = recent.reduce((sum, c) => sum + (c.delta || 0), 0);
        const olderCvd = older.reduce((sum, c) => sum + (c.delta || 0), 0);
        const cvdTrend = recentCvd - olderCvd;

        // Calculate price trend
        const recentPriceStart = recent[recent.length - 1]?.price_open || 0;
        const recentPriceEnd = recent[0]?.price_close || 0;
        const priceChange = recentPriceEnd - recentPriceStart;
        const priceChangePercent = recentPriceStart > 0 ? (priceChange / recentPriceStart) * 100 : 0;

        // Determine regime
        const cvdThreshold = 500;
        const priceThreshold = 0.1;
        let regime = 'BALANCED';
        if (Math.abs(cvdTrend) > cvdThreshold) {
          if (cvdTrend < -cvdThreshold && priceChangePercent > -priceThreshold) regime = 'DISTRIBUTION';
          else if (cvdTrend > cvdThreshold && priceChangePercent < priceThreshold) regime = 'ACCUMULATION';
        }

        // VSA Analysis
        const lastCandle = recent[0] || {};
        const priceSpread = Math.abs((lastCandle.price_high || 0) - (lastCandle.price_low || 0));
        const netDelta = lastCandle.delta || 0;
        let vsaSignal = 'NEUTRAL';
        if (Math.abs(netDelta) > 100 && priceSpread < 5) vsaSignal = netDelta > 0 ? 'BULL_ABSORPTION' : 'BEAR_ABSORPTION';
        else if (priceSpread > 10 && Math.abs(netDelta) > 100) vsaSignal = netDelta > 0 ? 'BULL_FOLLOW' : 'BEAR_FOLLOW';

        // Divergence check
        const hasDivergence = cvdTrend * priceChange < 0 && Math.abs(cvdTrend) > cvdThreshold;

        // Additional metrics for tooltip
        const avgDeltaRecent = recent.length > 0 ? recentCvd / recent.length : 0;
        const avgDeltaOlder = older.length > 0 ? olderCvd / older.length : 0;
        const deltaAcceleration = avgDeltaRecent - avgDeltaOlder;
        const bigTradesBuy = metrics.big_trades_buy || 0;
        const bigTradesSell = metrics.big_trades_sell || 0;
        const bigTradesCount = (metrics.big_trades || []).length;

        return (
          <div style={{
            marginTop: 8,
            background: needsMoreData ? 'rgba(255,255,255,0.02)' : regime === 'DISTRIBUTION' ? 'rgba(255,68,102,0.08)' : regime === 'ACCUMULATION' ? 'rgba(0,255,136,0.08)' : 'rgba(255,255,255,0.02)',
            border: `1px solid ${needsMoreData ? 'rgba(255,255,255,0.08)' : regime === 'DISTRIBUTION' ? 'rgba(255,68,102,0.3)' : regime === 'ACCUMULATION' ? 'rgba(0,255,136,0.3)' : 'rgba(255,255,255,0.08)'}`,
            borderRadius: 8,
            padding: 10
          }}>
            {/* Header with Click Tooltip */}
            <div style={{ width: '100%' }}>
              <div
                style={{
                  color: '#888',
                  fontSize: 10,
                  marginBottom: 8,
                  letterSpacing: 1,
                  fontWeight: 600,
                  textAlign: 'center',
                  cursor: 'pointer',
                  display: 'inline-flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  width: '100%',
                  gap: 6
                }}
                onClick={() => setShowOrderFlowTooltip(!showOrderFlowTooltip)}
              >
                ORDER FLOW ANALYSIS
                <span style={{
                  fontSize: 10,
                  color: showOrderFlowTooltip ? '#00aaff' : '#555',
                  background: showOrderFlowTooltip ? 'rgba(0,170,255,0.2)' : 'rgba(255,255,255,0.1)',
                  borderRadius: 10,
                  padding: '1px 6px',
                  transition: 'all 0.2s'
                }}>‚ìò</span>
                {needsMoreData && <span style={{ color: '#ffaa00' }}>‚Ä¢ Collecting data ({history.length}/5 candles)</span>}
              </div>

              {/* Inline Expandable Details */}
              {showOrderFlowTooltip && (
                <div style={{
                  marginTop: 12,
                  background: '#0a0a12',
                  border: '1px solid rgba(255,255,255,0.1)',
                  borderRadius: 12,
                  padding: 16
                }}>
                  {/* Tooltip Header */}
                  <div style={{
                    borderBottom: '1px solid rgba(255,255,255,0.1)',
                    paddingBottom: 12,
                    marginBottom: 12
                  }}>
                    <div style={{
                      fontSize: 14,
                      fontWeight: 700,
                      color: regime === 'DISTRIBUTION' ? '#ff4466' : regime === 'ACCUMULATION' ? '#00ff88' : '#00aaff',
                      marginBottom: 6
                    }}>
                      {regime === 'DISTRIBUTION' ? 'üìâ DISTRIBUTION DETECTED' :
                       regime === 'ACCUMULATION' ? 'üìà ACCUMULATION DETECTED' :
                       '‚öñÔ∏è BALANCED / NO CLEAR REGIME'}
                    </div>
                    <div style={{ fontSize: 11, color: '#888', lineHeight: 1.4 }}>
                      {regime === 'DISTRIBUTION' ? 'Sellers building pressure while price holds - expect downside breakout' :
                       regime === 'ACCUMULATION' ? 'Buyers building pressure while price holds - expect upside breakout' :
                       'CVD and price moving together or no significant pressure detected'}
                    </div>
                  </div>

                  {/* CVD Analysis Section */}
                  <div style={{ marginBottom: 16 }}>
                    <div style={{ fontSize: 11, color: '#00aaff', fontWeight: 600, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ width: 8, height: 8, background: '#00aaff', borderRadius: '50%' }}></span>
                      CVD ANALYSIS (Cumulative Volume Delta)
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '160px 1fr', gap: '6px 20px', fontSize: 11, paddingLeft: 14 }}>
                      <div style={{ color: '#777' }}>Session CVD:</div>
                      <div style={{ color: (metrics.cumulative_delta || 0) >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace', fontWeight: 700, fontSize: 13 }}>
                        {(metrics.cumulative_delta || 0) >= 0 ? '+' : ''}{(metrics.cumulative_delta || 0).toLocaleString()}
                      </div>
                      <div style={{ color: '#777' }}>Recent CVD (10 bars):</div>
                      <div style={{ color: recentCvd >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace', fontWeight: 600 }}>
                        {recentCvd >= 0 ? '+' : ''}{recentCvd.toLocaleString()}
                      </div>
                      <div style={{ color: '#777' }}>Prior CVD (10 bars):</div>
                      <div style={{ color: olderCvd >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace', fontWeight: 600 }}>
                        {olderCvd >= 0 ? '+' : ''}{olderCvd.toLocaleString()}
                      </div>
                      <div style={{ color: '#777' }}>CVD Trend (Œî):</div>
                      <div style={{ color: cvdTrend >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace', fontWeight: 700, fontSize: 13 }}>
                        {cvdTrend >= 0 ? '+' : ''}{cvdTrend.toLocaleString()}
                      </div>
                      <div style={{ color: '#777' }}>Avg Delta/Bar:</div>
                      <div style={{ color: avgDeltaRecent >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace' }}>
                        {avgDeltaRecent >= 0 ? '+' : ''}{avgDeltaRecent.toFixed(0)}
                      </div>
                      <div style={{ color: '#777' }}>Regime Threshold:</div>
                      <div style={{ color: '#999', fontFamily: 'monospace' }}>¬±{cvdThreshold}</div>
                    </div>
                  </div>

                  {/* Price Analysis Section */}
                  <div style={{ marginBottom: 16 }}>
                    <div style={{ fontSize: 11, color: '#ffaa00', fontWeight: 600, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ width: 8, height: 8, background: '#ffaa00', borderRadius: '50%' }}></span>
                      PRICE ANALYSIS
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '160px 1fr', gap: '6px 20px', fontSize: 11, paddingLeft: 14 }}>
                      <div style={{ color: '#777' }}>Current Price:</div>
                      <div style={{ color: '#00aaff', fontFamily: 'monospace', fontWeight: 700, fontSize: 13 }}>
                        ${(metrics.current_price || 0).toFixed(2)}
                      </div>
                      <div style={{ color: '#777' }}>50m Start Price:</div>
                      <div style={{ color: '#fff', fontFamily: 'monospace' }}>
                        {recentPriceStart > 0 ? `$${recentPriceStart.toFixed(2)}` : '‚Äî'}
                      </div>
                      <div style={{ color: '#777' }}>50m End Price:</div>
                      <div style={{ color: '#fff', fontFamily: 'monospace' }}>
                        {recentPriceEnd > 0 ? `$${recentPriceEnd.toFixed(2)}` : '‚Äî'}
                      </div>
                      <div style={{ color: '#777' }}>Price Change (50m):</div>
                      <div style={{ color: priceChange >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace', fontWeight: 600 }}>
                        {recentPriceStart > 0 ? `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)} (${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent.toFixed(3)}%)` : '‚Äî'}
                      </div>
                    </div>
                  </div>

                  {/* VSA Section */}
                  <div style={{ marginBottom: 16 }}>
                    <div style={{ fontSize: 11, color: '#a855f7', fontWeight: 600, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ width: 8, height: 8, background: '#a855f7', borderRadius: '50%' }}></span>
                      VSA (Volume Spread Analysis) - Last 5m Bar
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '160px 1fr', gap: '6px 20px', fontSize: 11, paddingLeft: 14 }}>
                      <div style={{ color: '#777' }}>Price Spread:</div>
                      <div style={{ color: '#fff', fontFamily: 'monospace' }}>${priceSpread.toFixed(2)}</div>
                      <div style={{ color: '#777' }}>Bar Delta:</div>
                      <div style={{ color: netDelta >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace' }}>
                        {netDelta >= 0 ? '+' : ''}{netDelta.toLocaleString()}
                      </div>
                      <div style={{ color: '#777' }}>Buy Volume:</div>
                      <div style={{ color: '#00ff88', fontFamily: 'monospace' }}>{(lastCandle.buy || 0).toLocaleString()}</div>
                      <div style={{ color: '#777' }}>Sell Volume:</div>
                      <div style={{ color: '#ff4466', fontFamily: 'monospace' }}>{(lastCandle.sell || 0).toLocaleString()}</div>
                      <div style={{ color: '#777' }}>Signal:</div>
                      <div style={{
                        color: vsaSignal.includes('BULL') ? '#00ff88' : vsaSignal.includes('BEAR') ? '#ff4466' : '#888',
                        fontWeight: 700
                      }}>
                        {vsaSignal.replace('_', ' ')}
                      </div>
                    </div>
                    <div style={{ fontSize: 10, color: '#888', marginTop: 8, padding: '6px 10px', background: 'rgba(255,255,255,0.03)', borderRadius: 6, marginLeft: 14 }}>
                      {vsaSignal.includes('ABSORPTION') ? 'üí° High delta + Low spread = Strong hands absorbing pressure' :
                       vsaSignal.includes('FOLLOW') ? 'üí° High delta + High spread = Momentum follow-through' :
                       'üí° No significant volume-price relationship detected'}
                    </div>
                  </div>

                  {/* Big Trades Section */}
                  <div style={{ marginBottom: 16 }}>
                    <div style={{ fontSize: 11, color: '#f97316', fontWeight: 600, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ width: 8, height: 8, background: '#f97316', borderRadius: '50%' }}></span>
                      BIG TRADES (‚â•{metrics.big_trade_threshold || 10} contracts) - Institutional Activity
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '160px 1fr', gap: '6px 20px', fontSize: 11, paddingLeft: 14 }}>
                      <div style={{ color: '#777' }}>Big Buy Volume:</div>
                      <div style={{ color: '#00ff88', fontFamily: 'monospace', fontWeight: 600 }}>{bigTradesBuy.toLocaleString()} contracts</div>
                      <div style={{ color: '#777' }}>Big Sell Volume:</div>
                      <div style={{ color: '#ff4466', fontFamily: 'monospace', fontWeight: 600 }}>{bigTradesSell.toLocaleString()} contracts</div>
                      <div style={{ color: '#777' }}>Net Big Delta:</div>
                      <div style={{
                        color: (bigTradesBuy - bigTradesSell) >= 0 ? '#00ff88' : '#ff4466',
                        fontFamily: 'monospace',
                        fontWeight: 700,
                        fontSize: 14
                      }}>
                        {(bigTradesBuy - bigTradesSell) >= 0 ? '+' : ''}{(bigTradesBuy - bigTradesSell).toLocaleString()}
                      </div>
                      <div style={{ color: '#777' }}>Trade Count:</div>
                      <div style={{ color: '#fff', fontFamily: 'monospace' }}>{bigTradesCount} trades</div>
                      <div style={{ color: '#777' }}>Imbalance:</div>
                      <div style={{
                        color: bigTradesBuy > bigTradesSell ? '#00ff88' : bigTradesSell > bigTradesBuy ? '#ff4466' : '#888',
                        fontWeight: 600
                      }}>
                        {bigTradesBuy > bigTradesSell ? 'üü¢ BUYERS dominant' : bigTradesSell > bigTradesBuy ? 'üî¥ SELLERS dominant' : '‚Äî Balanced'}
                      </div>
                    </div>

                    {/* Threshold Calculation Stats */}
                    <div style={{
                      background: 'rgba(249,115,22,0.1)',
                      border: '1px solid rgba(249,115,22,0.3)',
                      borderRadius: 6,
                      padding: 10,
                      marginTop: 12,
                      marginLeft: 14
                    }}>
                      <div style={{ fontSize: 10, color: '#f97316', fontWeight: 600, marginBottom: 6 }}>
                        THRESHOLD CALCULATION (90th Percentile)
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: '110px 1fr', gap: '4px 12px', fontSize: 10 }}>
                        <div style={{ color: '#777' }}>Sample Size:</div>
                        <div style={{ color: '#fff', fontFamily: 'monospace' }}>{(metrics.threshold_stats?.sample_count || 0).toLocaleString()} trades</div>
                        <div style={{ color: '#777' }}>Average Trade:</div>
                        <div style={{ color: '#fff', fontFamily: 'monospace' }}>{(metrics.threshold_stats?.avg_size || 0).toFixed(1)} contracts</div>
                        <div style={{ color: '#777' }}>90th Percentile:</div>
                        <div style={{ color: '#f97316', fontFamily: 'monospace', fontWeight: 700 }}>{metrics.threshold_stats?.p90_size || metrics.big_trade_threshold || 10} contracts</div>
                        <div style={{ color: '#777' }}>Trade Range:</div>
                        <div style={{ color: '#888', fontFamily: 'monospace' }}>{metrics.threshold_stats?.min_size || 1} - {metrics.threshold_stats?.max_size || '?'}</div>
                      </div>
                      <div style={{ fontSize: 9, color: '#666', marginTop: 8, fontStyle: 'italic' }}>
                        Trades above 90th percentile are flagged as institutional activity
                      </div>
                    </div>
                  </div>

                  {/* Divergence Section */}
                  <div style={{
                    background: hasDivergence ? 'rgba(255,170,0,0.15)' : 'rgba(0,255,136,0.1)',
                    borderRadius: 8,
                    padding: 12
                  }}>
                    <div style={{ fontSize: 11, color: hasDivergence ? '#ffaa00' : '#00ff88', fontWeight: 600, marginBottom: 6 }}>
                      {hasDivergence ? '‚ö†Ô∏è DIVERGENCE DETECTED' : '‚úì CVD & PRICE ALIGNED'}
                    </div>
                    <div style={{ fontSize: 10, color: '#999', lineHeight: 1.4 }}>
                      {hasDivergence
                        ? `CVD trending ${cvdTrend > 0 ? 'UP' : 'DOWN'} while price moving ${priceChange > 0 ? 'UP' : 'DOWN'} - potential reversal signal`
                        : 'CVD direction matches price direction - trend continuation likely'}
                    </div>
                  </div>

                  {/* Footer */}
                  <div style={{
                    marginTop: 12,
                    paddingTop: 10,
                    borderTop: '1px solid rgba(255,255,255,0.1)',
                    fontSize: 10,
                    color: '#666',
                    textAlign: 'center'
                  }}>
                    Order Flow Analysis ‚Ä¢ {history.length} candles analyzed
                  </div>
                </div>
              )}
            </div>
            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', justifyContent: 'center' }}>
              {/* Market Regime */}
              <div style={{
                flex: '0 0 auto',
                background: regime === 'DISTRIBUTION' ? 'rgba(255,68,102,0.15)' : regime === 'ACCUMULATION' ? 'rgba(0,255,136,0.15)' : 'rgba(255,255,255,0.05)',
                borderRadius: 6,
                padding: '8px 16px',
                textAlign: 'center',
                border: `1px solid ${regime === 'DISTRIBUTION' ? '#ff446650' : regime === 'ACCUMULATION' ? '#00ff8850' : '#ffffff10'}`
              }}>
                <div style={{ fontSize: 9, color: '#666', marginBottom: 4 }}>REGIME</div>
                <div style={{
                  fontSize: 14,
                  fontWeight: 700,
                  color: regime === 'DISTRIBUTION' ? '#ff4466' : regime === 'ACCUMULATION' ? '#00ff88' : '#888'
                }}>
                  {regime === 'DISTRIBUTION' ? 'üìâ' : regime === 'ACCUMULATION' ? 'üìà' : '‚öñÔ∏è'} {regime}
                </div>
              </div>

              {/* CVD Trend */}
              <div style={{
                flex: '0 0 auto',
                background: 'rgba(255,255,255,0.03)',
                borderRadius: 6,
                padding: '8px 16px',
                textAlign: 'center'
              }}>
                <div style={{ fontSize: 9, color: '#666', marginBottom: 4 }}>CVD TREND (50m)</div>
                <div style={{
                  fontSize: 14,
                  fontWeight: 700,
                  fontFamily: 'monospace',
                  color: cvdTrend >= 0 ? '#00ff88' : '#ff4466'
                }}>
                  {cvdTrend >= 0 ? '+' : ''}{cvdTrend.toLocaleString()}
                </div>
              </div>

              {/* Price Change */}
              <div style={{
                flex: '0 0 auto',
                background: 'rgba(255,255,255,0.03)',
                borderRadius: 6,
                padding: '8px 16px',
                textAlign: 'center'
              }}>
                <div style={{ fontSize: 9, color: '#666', marginBottom: 4 }}>PRICE Œî</div>
                <div style={{
                  fontSize: 14,
                  fontWeight: 700,
                  fontFamily: 'monospace',
                  color: priceChange >= 0 ? '#00ff88' : '#ff4466'
                }}>
                  {priceChange >= 0 ? '+' : ''}{priceChange.toFixed(2)}
                </div>
              </div>

              {/* Divergence Status */}
              <div style={{
                flex: '0 0 auto',
                background: hasDivergence ? 'rgba(255,170,0,0.15)' : 'rgba(0,255,136,0.08)',
                borderRadius: 6,
                padding: '8px 16px',
                textAlign: 'center',
                border: hasDivergence ? '1px solid #ffaa0050' : '1px solid #00ff8830'
              }}>
                <div style={{ fontSize: 9, color: '#666', marginBottom: 4 }}>DIVERGENCE</div>
                <div style={{
                  fontSize: 12,
                  fontWeight: 700,
                  color: hasDivergence ? '#ffaa00' : '#00ff88'
                }}>
                  {hasDivergence ? '‚ö†Ô∏è DETECTED' : '‚úì ALIGNED'}
                </div>
              </div>

              {/* VSA Signal */}
              <div style={{
                flex: '0 0 auto',
                background: vsaSignal.includes('ABSORPTION') ? 'rgba(0,170,255,0.1)' : vsaSignal.includes('FOLLOW') ? 'rgba(0,255,136,0.1)' : 'rgba(255,255,255,0.03)',
                borderRadius: 6,
                padding: '8px 16px',
                textAlign: 'center'
              }}>
                <div style={{ fontSize: 9, color: '#666', marginBottom: 4 }}>VSA SIGNAL</div>
                <div style={{
                  fontSize: 11,
                  fontWeight: 700,
                  color: vsaSignal.includes('BULL') ? '#00ff88' : vsaSignal.includes('BEAR') ? '#ff4466' : '#888'
                }}>
                  {vsaSignal === 'BULL_ABSORPTION' ? 'üü¢ ABSORPTION' :
                   vsaSignal === 'BEAR_ABSORPTION' ? 'üî¥ ABSORPTION' :
                   vsaSignal === 'BULL_FOLLOW' ? 'üü¢ FOLLOW' :
                   vsaSignal === 'BEAR_FOLLOW' ? 'üî¥ FOLLOW' : '‚Äî NEUTRAL'}
                </div>
              </div>

              {/* Big Trades Delta */}
              <div style={{
                flex: '0 0 auto',
                background: 'rgba(255,255,255,0.03)',
                borderRadius: 6,
                padding: '8px 16px',
                textAlign: 'center'
              }}>
                <div style={{ fontSize: 9, color: '#666', marginBottom: 4 }}>BIG TRADES Œî</div>
                <div style={{
                  fontSize: 14,
                  fontWeight: 700,
                  fontFamily: 'monospace',
                  color: (metrics.big_trades_delta || 0) >= 0 ? '#00ff88' : '#ff4466'
                }}>
                  {(metrics.big_trades_delta || 0) >= 0 ? '+' : ''}{(metrics.big_trades_delta || 0).toLocaleString()}
                </div>
              </div>
            </div>
          </div>
        );
      })()}

      {/* Gold Institutional Data - Show for Gold contracts */}
      {metrics?.contract !== 'BTC-SPOT' && (
        <div style={{
          marginTop: 8,
          background: 'rgba(255,255,255,0.02)',
          border: '1px solid rgba(255,255,255,0.08)',
          borderRadius: 8,
          padding: 10
        }}>
          <div style={{ color: '#888', fontSize: 10, marginBottom: 8, letterSpacing: 1, fontWeight: 600, textAlign: 'center' }}>
            GOLD INSTITUTIONAL SENTIMENT
          </div>
          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
            {/* Central Banks */}
            <div style={{
              flex: '1 1 180px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#FFD700', fontWeight: 700, marginBottom: 6 }}>CENTRAL BANKS</div>
              <div style={{ fontSize: 10, color: '#00ff88', marginBottom: 2 }}>Net Buyers 15+ Years</div>
              <div style={{ fontSize: 9, color: '#888' }}>Accumulating gold reserves</div>
            </div>

            {/* COT Positioning - Expanded like BTC-SPOT with tooltips */}
            <div style={{
              flex: '1 1 180px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#00aaff', fontWeight: 700, marginBottom: 6 }}>COT POSITIONING</div>
              {(() => {
                const goldCot = institutionalData?.gold?.cot || {};
                const sentiment = goldCot.sentiment || institutionalData?.gold?.cot_sentiment || 'neutral';
                const sentimentColor = sentiment === 'bullish' ? '#00ff88' : (sentiment === 'bearish' ? '#ff4466' : '#888');
                const mmNet = goldCot.managed_money_net || 0;
                const mmPrev = goldCot.managed_money_net_prev || 0;
                const mmChange = goldCot.managed_money_change || (mmNet - mmPrev);
                const sdNet = goldCot.swap_dealers_net || 0;
                const sdPrev = goldCot.swap_dealers_net_prev || 0;
                const sdChange = goldCot.swap_dealers_change || (sdNet - sdPrev);
                const reportDate = goldCot.report_date || 'N/A';
                return (
                  <>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#00aaff', fontWeight: 600, marginBottom: 4 }}>Managed Money Position</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: mmNet > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{(mmNet/1000).toFixed(0)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Week:</span>
                          <span style={{ color: '#aaa' }}>{(mmPrev/1000).toFixed(0)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>WoW Change:</span>
                          <span style={{ color: mmChange > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{mmChange > 0 ? '+' : ''}{(mmChange/1000).toFixed(0)}K</span>
                        </div>
                        <div style={{ marginTop: 4, fontSize: 9, color: '#666' }}>Report: {reportDate}</div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>Managed Money</span>
                        <span style={{ fontSize: 9, fontWeight: 600, color: mmNet > 0 ? '#00ff88' : '#ff4466' }}>
                          {mmNet > 0 ? 'LONG' : 'SHORT'} <span style={{ fontSize: 8, color: mmChange > 0 ? '#00ff88' : '#ff4466' }}>({mmChange > 0 ? '+' : ''}{(mmChange/1000).toFixed(0)}K)</span>
                        </span>
                      </div>
                    </Tooltip>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#00aaff', fontWeight: 600, marginBottom: 4 }}>Swap Dealers Position</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: sdNet > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{(sdNet/1000).toFixed(0)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Week:</span>
                          <span style={{ color: '#aaa' }}>{(sdPrev/1000).toFixed(0)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>WoW Change:</span>
                          <span style={{ color: sdChange > 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{sdChange > 0 ? '+' : ''}{(sdChange/1000).toFixed(0)}K</span>
                        </div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>Swap Dealers</span>
                        <span style={{ fontSize: 9, fontWeight: 600, color: sdNet > 0 ? '#00ff88' : '#ff4466' }}>
                          {sdNet > 0 ? 'LONG' : 'SHORT'} <span style={{ fontSize: 8, color: sdChange > 0 ? '#00ff88' : '#ff4466' }}>({sdChange > 0 ? '+' : ''}{(sdChange/1000).toFixed(0)}K)</span>
                        </span>
                      </div>
                    </Tooltip>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 9, color: '#888' }}>Signal</span>
                      <span style={{ fontSize: 9, fontWeight: 600, color: sentimentColor, textTransform: 'capitalize' }}>
                        {sentiment}
                      </span>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* COMEX Open Interest with styled tooltips */}
            <div style={{
              flex: '1 1 180px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#9370DB', fontWeight: 700, marginBottom: 6 }}>COMEX OPEN INTEREST</div>
              {(() => {
                const oiData = institutionalData?.gold?.open_interest || {};
                const total = oiData.total || 0;
                const totalPrev = oiData.total_prev || 0;
                const change5d = oiData.change_5d_pct || 0;
                return (
                  <>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#9370DB', fontWeight: 600, marginBottom: 4 }}>COMEX Gold Open Interest</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: '#fff', fontWeight: 600 }}>{(total/1000).toFixed(0)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Day:</span>
                          <span style={{ color: '#aaa' }}>{(totalPrev/1000).toFixed(0)}K contracts</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>5-Day Change:</span>
                          <span style={{ color: change5d > 0 ? '#00ff88' : '#ff4466' }}>{change5d > 0 ? '+' : ''}{change5d.toFixed(1)}%</span>
                        </div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>Total OI</span>
                        <span style={{ fontSize: 10, fontWeight: 600, color: '#fff' }}>
                          {((total) / 1000).toFixed(0)}K Contracts
                        </span>
                      </div>
                    </Tooltip>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#9370DB', fontWeight: 600, marginBottom: 4 }}>OI Change</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>24h:</span>
                          <span style={{ color: (oiData.change_pct || 0) > 0 ? '#00ff88' : '#ff4466' }}>{(oiData.change_pct || 0) > 0 ? '+' : ''}{(oiData.change_pct || 0).toFixed(1)}%</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>5-Day:</span>
                          <span style={{ color: change5d > 0 ? '#00ff88' : '#ff4466' }}>{change5d > 0 ? '+' : ''}{change5d.toFixed(1)}%</span>
                        </div>
                        <div style={{ marginTop: 4, fontSize: 9, color: '#666' }}>Rising OI + Rising Price = Bullish</div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>24h Change</span>
                        <span style={{ fontSize: 10, fontWeight: 600, color: (oiData.change_pct || 0) > 0 ? '#00ff88' : '#ff4466' }}>
                          {(oiData.change_pct || 0) > 0 ? '+' : ''}{(oiData.change_pct || 0).toFixed(1)}%
                        </span>
                      </div>
                    </Tooltip>
                  </>
                );
              })()}
            </div>

            {/* Gold ETF Holdings - Expanded with styled tooltips */}
            <div style={{
              flex: '1 1 180px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px'
            }}>
              <div style={{ fontSize: 9, color: '#FFD700', fontWeight: 700, marginBottom: 6 }}>GOLD ETF FLOWS</div>
              {(() => {
                const etfData = institutionalData?.gold?.etf || {};
                const holdings = etfData.gld_holdings || 0;
                const holdingsPrev = etfData.gld_holdings_prev || 0;
                const holdingsChange = holdings - holdingsPrev;
                const monthlyFlow = etfData.monthly_flow || 0;
                const weeklyFlow = etfData.weekly_flow || 0;
                return (
                  <>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#FFD700', fontWeight: 600, marginBottom: 4 }}>GLD ETF Holdings</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Current:</span>
                          <span style={{ color: '#fff', fontWeight: 600 }}>{(holdings/1000000).toFixed(2)}M oz</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Prior Week:</span>
                          <span style={{ color: '#aaa' }}>{(holdingsPrev/1000000).toFixed(2)}M oz</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>WoW Change:</span>
                          <span style={{ color: holdingsChange > 0 ? '#00ff88' : '#ff4466' }}>{holdingsChange > 0 ? '+' : ''}{(holdingsChange/1000).toFixed(0)}K oz</span>
                        </div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3, cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>GLD Holdings</span>
                        <span style={{ fontSize: 10, fontWeight: 600, color: '#fff' }}>
                          {(holdings / 1000000).toFixed(1)}M oz
                        </span>
                      </div>
                    </Tooltip>
                    <Tooltip content={
                      <div>
                        <div style={{ color: '#FFD700', fontWeight: 600, marginBottom: 4 }}>ETF Flow Data</div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Weekly:</span>
                          <span style={{ color: weeklyFlow > 0 ? '#00ff88' : '#ff4466' }}>{weeklyFlow > 0 ? '+' : ''}{weeklyFlow} tons</span>
                        </div>
                        <div style={{ display: 'flex', justifyContent: 'space-between', gap: 20 }}>
                          <span style={{ color: '#888' }}>Monthly:</span>
                          <span style={{ color: monthlyFlow > 0 ? '#00ff88' : '#ff4466' }}>{monthlyFlow > 0 ? '+' : ''}{monthlyFlow} tons</span>
                        </div>
                        <div style={{ marginTop: 4, fontSize: 9, color: '#666' }}>Positive = inflows (bullish)</div>
                        <div style={{ fontSize: 9, color: '#666' }}>Negative = outflows (bearish)</div>
                      </div>
                    }>
                      <div style={{ display: 'flex', justifyContent: 'space-between', cursor: 'help' }}>
                        <span style={{ fontSize: 9, color: '#888' }}>Weekly Flow</span>
                        <span style={{ fontSize: 10, fontWeight: 600, color: weeklyFlow > 0 ? '#00ff88' : '#ff4466' }}>
                          {weeklyFlow > 0 ? '+' : ''}{weeklyFlow.toFixed(0)} tons
                        </span>
                      </div>
                    </Tooltip>
                  </>
                );
              })()}
            </div>

            {/* Overall Sentiment + CFTC Info with styled tooltip */}
            <div style={{
              flex: '1 1 150px',
              background: 'rgba(255,255,255,0.02)',
              borderRadius: 6,
              padding: '8px 10px',
              textAlign: 'center'
            }}>
              <Tooltip content={
                <div>
                  <div style={{ color: '#ffaa00', fontWeight: 600, marginBottom: 6 }}>Signal Composition</div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: 16, marginBottom: 2 }}>
                    <span style={{ color: '#888' }}>COT Positioning:</span>
                    <span style={{ color: '#aaa' }}>30%</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: 16, marginBottom: 2 }}>
                    <span style={{ color: '#888' }}>Central Banks:</span>
                    <span style={{ color: '#aaa' }}>30%</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: 16, marginBottom: 2 }}>
                    <span style={{ color: '#888' }}>ETF Flows:</span>
                    <span style={{ color: '#aaa' }}>20%</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', gap: 16, marginBottom: 4 }}>
                    <span style={{ color: '#888' }}>Options Gamma:</span>
                    <span style={{ color: '#aaa' }}>20%</span>
                  </div>
                  <div style={{ borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: 4, marginTop: 4 }}>
                    <div style={{ fontSize: 9, color: '#666' }}>CFTC Report: Tuesday data</div>
                    <div style={{ fontSize: 9, color: '#666' }}>Released: Friday 3:30pm ET</div>
                  </div>
                </div>
              }>
                <div style={{ cursor: 'help' }}>
                  <div style={{ fontSize: 9, color: '#888', marginBottom: 4 }}>OVERALL SIGNAL</div>
                </div>
              </Tooltip>
              {(() => {
                const goldSentiment = institutionalData?.gold || {};
                const sentiment = goldSentiment.overall_sentiment || 'neutral';
                const confidence = goldSentiment.confidence || 'low';
                const sentimentColor = sentiment === 'bullish' ? '#00ff88' : (sentiment === 'bearish' ? '#ff4466' : '#ffaa00');
                return (
                  <>
                    <div style={{ fontSize: 14, fontWeight: 700, color: sentimentColor, textTransform: 'uppercase', marginBottom: 4 }}>
                      {sentiment}
                    </div>
                    <div style={{ fontSize: 9, color: '#555' }}>CFTC Fri 3:30pm</div>
                  </>
                );
              })()}
            </div>
          </div>
        </div>
      )}
        </div>
      </div>
    </div>
  );
};

const VSIAnalysis = ({ selectedContract = 'ES' }) => {
  const [sessionFilter, setSessionFilter] = useState('horizon'); // 'horizon' or 'universe'
  const [data, setData] = useState(null);
  const [showHistorical, setShowHistorical] = useState(false); // Toggle for 5-day historical view
  const [historicalData, setHistoricalData] = useState(null); // 5-day session OHLC data
  const [liveData, setLiveData] = useState(null); // Current session live data (H/L/price)
  const [hoveredBar, setHoveredBar] = useState(null); // For OHLC tooltip
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 }); // Tooltip position
  const [selectedWeek, setSelectedWeek] = useState('current'); // Week selector: dynamic weeks + current
  const [hoveredTableRow, setHoveredTableRow] = useState(null); // For table row hover effects
  const [hoveredSessionTab, setHoveredSessionTab] = useState(null); // For session tab hover effects
  const { isMobile, isTablet } = useResponsive();

  // Session Trade Calculator state
  const [showCalculator, setShowCalculator] = useState(false);
  const [calcEntrySession, setCalcEntrySession] = useState('japan_ib');
  const [calcTargetPoints, setCalcTargetPoints] = useState(10);
  const [calcDirection, setCalcDirection] = useState('long'); // 'long' or 'short'
  const [calcExcludedSessions, setCalcExcludedSessions] = useState(new Set()); // Sessions to exclude from analysis

  // Strategy Analytics state - 12 month historical data
  const [strategyMonth, setStrategyMonth] = useState('all'); // 'all' or month like '2025-01'
  const [strategyWeek, setStrategyWeek] = useState('all'); // 'all' or week 1-4
  const [strategyData, setStrategyData] = useState(null); // 12 months of session data
  const [strategyLoading, setStrategyLoading] = useState(false);
  const [showStrategySection, setShowStrategySection] = useState(true);

  // Dynamic week calculation based on current date
  const getWeekTabs = () => {
    const now = new Date();
    // Get ISO week number
    const getISOWeek = (date) => {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };

    const currentWeek = getISOWeek(now);
    const currentYear = now.getFullYear();

    // Generate 5 previous weeks + current
    const weeks = [];
    for (let i = 5; i >= 1; i--) {
      let weekNum = currentWeek - i;
      let year = currentYear;
      if (weekNum <= 0) {
        weekNum = 52 + weekNum; // Handle year rollover
        year = currentYear - 1;
      }
      weeks.push({
        id: `w${i}`, // w5, w4, w3, w2, w1 (oldest to newest)
        label: `W${weekNum}`,
        weekNum,
        year
      });
    }
    weeks.push({ id: 'current', label: 'Current', weekNum: currentWeek, year: currentYear });
    return weeks;
  };

  const weekTabs = getWeekTabs();

  // Generate month tabs for last 12 months (for Strategy Analytics)
  const getMonthTabs = () => {
    const months = [{ id: 'all', label: 'All 12 Months' }];
    const now = new Date();
    for (let i = 0; i < 12; i++) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const monthId = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      const monthLabel = d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
      months.push({ id: monthId, label: monthLabel, year: d.getFullYear(), month: d.getMonth() + 1 });
    }
    return months;
  };
  const monthTabs = getMonthTabs();

  // VSI Formula: R + V + D
  // R = (High - Low) / 2
  // V = Session Volume
  // D = Buy Volume - Sell Volume

  // Session definitions (ET times) - ordered from 18:00 ET (Gold futures day start)
  const allSessions = [
    { id: 'pre_asia', name: 'Pre Asia', start: '18:00', end: '19:00', color: '#4B5563', horizon: false },
    { id: 'japan_ib', name: 'Japan', start: '19:00', end: '20:00', color: '#9370DB', horizon: true },      // Purple
    { id: 'china', name: 'China', start: '20:00', end: '23:00', color: '#F472B6', horizon: true },        // Pink
    { id: 'asia_close', name: 'Asia Close', start: '23:00', end: '02:00', color: '#4B5563', horizon: false },
    { id: 'deadzone', name: 'Dead Zone', start: '02:00', end: '03:00', color: '#6B7280', horizon: true },  // Grey
    { id: 'london', name: 'London', start: '03:00', end: '06:00', color: '#3B82F6', horizon: true },      // Blue
    { id: 'low_volume', name: 'Low Vol', start: '06:00', end: '08:20', color: '#4B5563', horizon: false },
    { id: 'us_ib', name: 'US IB', start: '08:20', end: '09:30', color: '#F59E0B', horizon: true },        // Orange
    { id: 'ny_1h', name: 'NY 1H', start: '09:30', end: '10:30', color: '#10B981', horizon: true },        // Green
    { id: 'ny_2h', name: 'NY 2H', start: '10:30', end: '11:30', color: '#06B6D4', horizon: true },        // Cyan (distinct from green)
    { id: 'lunch', name: 'Lunch', start: '11:30', end: '13:30', color: '#8B5CF6', horizon: true },        // Violet
    { id: 'ny_pm', name: 'NY PM', start: '13:30', end: '16:00', color: '#EF4444', horizon: true },        // Red
    { id: 'ny_close', name: 'NY Close', start: '16:00', end: '17:00', color: '#4B5563', horizon: false },
    { id: 'market_closed', name: 'Market Closed', start: '17:00', end: '18:00', color: '#1F2937', horizon: false },
  ];

  // Filter sessions based on toggle (always exclude market_closed - no data available)
  const sessions = (sessionFilter === 'horizon' ? allSessions.filter(s => s.horizon) : allSessions).filter(s => s.id !== 'market_closed');

  // Get current session ID based on ET time
  const getCurrentSessionId = () => {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const et = new Date(utc - (5 * 3600000));
    const hours = et.getHours();
    const mins = et.getMinutes();
    const timeVal = hours * 100 + mins;
    
    if (timeVal >= 1900 && timeVal < 2000) return 'japan_ib';
    if (timeVal >= 2000 && timeVal < 2300) return 'china';
    if (timeVal >= 2300 || timeVal < 200) return 'asia_close';
    if (timeVal >= 200 && timeVal < 300) return 'deadzone';
    if (timeVal >= 300 && timeVal < 600) return 'london';
    if (timeVal >= 600 && timeVal < 820) return 'low_volume';
    if (timeVal >= 820 && timeVal < 930) return 'us_ib';
    if (timeVal >= 930 && timeVal < 1030) return 'ny_1h';
    if (timeVal >= 1030 && timeVal < 1130) return 'ny_2h';
    if (timeVal >= 1130 && timeVal < 1330) return 'lunch';
    if (timeVal >= 1330 && timeVal < 1600) return 'ny_pm';
    if (timeVal >= 1600 && timeVal < 1700) return 'ny_close';
    if (timeVal >= 1700 && timeVal < 1800) return 'market_closed';
    if (timeVal >= 1800 && timeVal < 1900) return 'pre_asia';
    return null;
  };
  
  const currentSessionId = getCurrentSessionId();

  // Session order in trading day (18:00 ET start)
  const sessionOrder = [
    'pre_asia', 'japan_ib', 'china', 'asia_close', 'deadzone',
    'london', 'low_volume', 'us_ib', 'ny_1h', 'ny_2h',
    'lunch', 'ny_pm', 'ny_close', 'market_closed'
  ];

  // Get session status: 'ENDED', 'NOW', or 'WAITING'
  const getSessionStatus = (sessionId) => {
    if (sessionId === currentSessionId) return 'NOW';

    const currentIdx = sessionOrder.indexOf(currentSessionId);
    const sessionIdx = sessionOrder.indexOf(sessionId);

    if (currentIdx === -1) return 'WAITING'; // Unknown current session

    // Sessions before current have ended, sessions after are waiting
    return sessionIdx < currentIdx ? 'ENDED' : 'WAITING';
  };

  // Market closed/weekend detection
  const getMarketStatus = () => {
    const now = new Date();
    const etOptions = { timeZone: 'America/New_York' };
    const etFormatter = new Intl.DateTimeFormat('en-US', {
      ...etOptions,
      weekday: 'long',
      hour: 'numeric',
      minute: 'numeric',
      hour12: false
    });
    const parts = etFormatter.formatToParts(now);
    const day = parts.find(p => p.type === 'weekday').value;
    const hour = parseInt(parts.find(p => p.type === 'hour').value);
    const minute = parseInt(parts.find(p => p.type === 'minute').value);
    const timeVal = hour * 100 + minute;

    // Weekend: Saturday all day, Sunday before 18:00 ET, Friday after 17:00 ET
    if (day === 'Saturday') return { closed: true, isWeekend: true, reopenDay: 'Sunday', reopenTime: '18:00 ET' };
    if (day === 'Sunday' && timeVal < 1800) return { closed: true, isWeekend: true, reopenDay: 'Today', reopenTime: '18:00 ET' };
    if (day === 'Friday' && timeVal >= 1700) return { closed: true, isWeekend: true, reopenDay: 'Sunday', reopenTime: '18:00 ET' };

    // Daily close: 17:00-18:00 ET on weekdays
    if (timeVal >= 1700 && timeVal < 1800) return { closed: true, isWeekend: false, reopenTime: '18:00 ET' };

    return { closed: false, isWeekend: false };
  };

  const marketStatus = getMarketStatus();

  // Loading and error state
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Fetch live data for OHLC (polls every 2s)
  useEffect(() => {
    let isMounted = true;
    const fetchLiveData = async () => {
      try {
        const response = await fetch(API_BASE);
        if (response.ok && isMounted) {
          const data = await response.json();
          setLiveData({
            sessionHigh: data.session_high || 0,
            sessionLow: data.session_low || 0,
            sessionOpen: data.session_open || 0,
            currentPrice: data.current_price || 0,
            sessionId: data.current_session_id,
            current_session_name: data.current_session_name || '',
            vwap: data.vwap || 0,
            // Day OHLC
            dayOpen: data.day_open || 0,
            dayHigh: data.day_high || 0,
            dayLow: data.day_low || 0,
            // Volume data
            totalVolume: data.total_volume || 0,
            sessionVolume: data.session_volume || data.total_volume || 0,
            sessionDelta: data.session_delta || data.cumulative_delta || 0,
            // Delta for current session
            cumulativeDelta: data.cumulative_delta || 0,
            // Ended sessions OHLC
            endedSessions: data.ended_sessions || {},
            // IB Sessions from Databento
            ibs: data.ibs || {},
            currentIB: data.current_ib || null,
            // Legacy IB (for backwards compatibility)
            ibHigh: data.ib_high || 0,
            ibLow: data.ib_low || 0,
            // Overnight/Globex
            overnightHigh: data.overnight_high || data.globex_high || 0,
            overnightLow: data.overnight_low || data.globex_low || 0,
            // TPO/Market Profile Data
            tpo_poc: data.tpo_poc || 0,
            tpo_vah: data.tpo_vah || 0,
            tpo_val: data.tpo_val || 0,
            // Anchored VWAPs (persist until 17:00 ET)
            us_ib_vwap: data.us_ib_vwap || 0,
            ny_1h_vwap: data.ny_1h_vwap || 0,
            // Day VWAP (full day from 18:00 ET)
            day_vwap: data.day_vwap || 0
          });
        }
      } catch (err) {
        console.error('Live data fetch error:', err);
      }
    };

    fetchLiveData();
    const interval = setInterval(fetchLiveData, 2000);
    return () => {
      isMounted = false;
      clearInterval(interval);
    };
  }, []);

  // Fetch real session history data from backend (instant from cache)
  useEffect(() => {
    let isMounted = true;
    let retryTimer = null;

    const fetchSessionHistory = async () => {
      if (!isMounted) return;
      setLoading(true);
      setError(null);

      try {
        const response = await fetch(`${API_BASE}/session-history`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const historyData = await response.json();

        // If cache is still initializing, retry in 2 seconds
        if (historyData.loading) {
          retryTimer = setTimeout(() => {
            if (isMounted) fetchSessionHistory();
          }, 2000);
          return;
        }

        // Map backend session IDs to frontend session IDs
        const sessionIdMap = {
          'japan_ib': 'japan_ib',
          'china': 'china',
          'london': 'london',
          'us_ib': 'us_ib',
          'ny_1h': 'ny_1h'
        };

        // Build VSI data from API response
        const vsiData = {};

        allSessions.forEach(session => {
          const apiData = historyData[session.id];

          if (apiData) {
            // Real data from API - use values directly from backend
            vsiData[session.id] = {
              todayRange: apiData.todayRange || 0,
              pDR: apiData.pDR || 0,
              avgRange: apiData.avgRange || 0,
              cW: apiData.cW || 0,
              pW: apiData.pW || 0,
              CM: apiData.CM || 0,
              PM: apiData.PM || 0,
              max: apiData.max || 0,
              min: apiData.min || 0
            };
          } else {
            // Fallback for sessions not in API (pre_asia, asia_close, etc.)
            // Use seeded random for consistent placeholder data
            let seed = session.id.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
            const seededRandom = () => {
              seed = (seed * 9301 + 49297) % 233280;
              return seed / 233280;
            };

            const baseRange = session.horizon ? 5 + seededRandom() * 10 : 3 + seededRandom() * 5;
            const ranges = Array.from({length: 40}, () => baseRange * (0.8 + seededRandom() * 0.4));
            const avg = arr => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
            const historical10 = ranges.slice(1, 11); // Previous 10 days (not including today)

            vsiData[session.id] = {
              todayRange: ranges[0] || 0,
              pDR: ranges[1] || 0,
              avgRange: avg(historical10),
              cW: avg(ranges.slice(0, 5)),
              pW: avg(ranges.slice(5, 10)) || 0,
              CM: avg(ranges.slice(0, 20)),
              PM: avg(ranges.slice(20, 40)) || 0,
              max: historical10.length > 0 ? Math.max(...historical10) : 0,
              min: historical10.length > 0 ? Math.min(...historical10) : 0
            };
          }
        });

        setData(vsiData);
      } catch (err) {
        console.error('Failed to fetch session history:', err);
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchSessionHistory();

    return () => {
      isMounted = false;
      if (retryTimer) clearTimeout(retryTimer);
    };
  }, []); // Fetch once on mount - static 10 historical days

  // Cache key for localStorage (includes contract for separate caches per instrument)
  const getCacheKey = (week) => `horizon_sessions_${selectedContract}_${week}`;

  // Load from localStorage cache (instant)
  const loadFromCache = (week) => {
    try {
      const cached = localStorage.getItem(getCacheKey(week));
      if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        // Cache valid for 1 hour for historical weeks, 5 min for current
        const ttl = week === 'current' ? 300000 : 3600000;
        if (Date.now() - timestamp < ttl) {
          return data;
        }
      }
    } catch (e) { /* ignore cache errors */ }
    return null;
  };

  // Save to localStorage cache
  const saveToCache = (week, data) => {
    try {
      localStorage.setItem(getCacheKey(week), JSON.stringify({
        data,
        timestamp: Date.now()
      }));
    } catch (e) { /* ignore cache errors */ }
  };

  // Expected price ranges for validation
  const expectedPriceRanges = {
    'ES': [5500, 6500],
    'GC': [2500, 3100],
    'BTC': [75000, 130000]
  };

  // Validate data matches expected contract prices
  const validateDataForContract = (data, contract) => {
    if (!data || !data.length) return false;
    const prefix = contract?.substring(0, 2) || '';
    const expected = expectedPriceRanges[prefix];
    if (!expected) return true; // Unknown contract, accept data

    // Check first day's first session with data
    for (const day of data) {
      if (!day.sessions) continue;
      for (const sessId of Object.keys(day.sessions)) {
        const sess = day.sessions[sessId];
        if (sess?.h > 0) {
          // Check if price is in expected range
          if (sess.h >= expected[0] && sess.h <= expected[1]) {
            return true; // Data looks correct
          } else {
            console.warn(`Data validation failed: price ${sess.h} not in expected range ${expected[0]}-${expected[1]} for ${contract}`);
            return false; // Data is for wrong contract
          }
        }
      }
    }
    return true; // No data to validate
  };

  // Clear ALL caches for current contract and force refresh
  const clearCacheAndRefresh = async () => {
    try {
      // Clear all week caches for this contract
      const weekIds = ['current', 'w1', 'w2', 'w3', 'w4', 'w5'];
      weekIds.forEach(w => localStorage.removeItem(getCacheKey(w)));
      setHistoricalData(null);

      // Force fresh fetch from API with cache-busting timestamp
      const response = await fetch(`${API_BASE}/historical-sessions?week=${selectedWeek}&stock=${selectedContract}&nocache=${Date.now()}`);
      if (response.ok) {
        const result = await response.json();
        if (result.days && !result.loading) {
          // Validate data matches contract
          if (validateDataForContract(result.days, selectedContract)) {
            setHistoricalData(result.days);
            saveToCache(selectedWeek, result.days);
          } else {
            console.error('Received data for wrong contract, not caching');
            // Still show the data but don't cache it - user needs to fix backend
            setHistoricalData(result.days);
          }
        }
      }
    } catch (err) {
      console.error('Failed to refresh:', err);
    }
  };

  // Fetch historical sessions OHLC for selected week
  useEffect(() => {
    const fetchHistoricalSessions = async () => {
      // Try cache first (instant load) - but validate it
      const cached = loadFromCache(selectedWeek);
      if (cached && validateDataForContract(cached, selectedContract)) {
        setHistoricalData(cached);
      } else if (cached) {
        // Cached data is for wrong contract, clear it
        localStorage.removeItem(getCacheKey(selectedWeek));
      }

      // Fetch from API
      try {
        const response = await fetch(`${API_BASE}/historical-sessions?week=${selectedWeek}&stock=${selectedContract}`);
        if (response.ok) {
          const result = await response.json();
          if (result.days && !result.loading) {
            // Validate data matches contract before caching
            if (validateDataForContract(result.days, selectedContract)) {
              setHistoricalData(result.days);
              saveToCache(selectedWeek, result.days);
            } else {
              // Data is wrong, show it but with warning - user needs to fix backend
              setHistoricalData(result.days);
              console.error(`Backend returned wrong data for ${selectedContract}. Backend needs to clear its cache.`);
            }
          }
        }
      } catch (err) {
        console.error('Failed to fetch historical sessions:', err);
      }
    };

    fetchHistoricalSessions();
    // Refresh current week every 5 minutes, others every hour
    const interval = setInterval(fetchHistoricalSessions, selectedWeek === 'current' ? 300000 : 3600000);
    return () => clearInterval(interval);
  }, [selectedWeek, selectedContract]);

  // Fetch 12-month strategy data for Strategy Analytics section
  useEffect(() => {
    const fetchStrategyData = async () => {
      const cacheKey = `horizon_strategy_${selectedContract}_12m`;

      // Try cache first
      try {
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          const { data, timestamp } = JSON.parse(cached);
          // Cache valid for 24 hours
          if (Date.now() - timestamp < 86400000) {
            if (validateDataForContract(data, selectedContract)) {
              setStrategyData(data);
              return;
            }
          }
        }
      } catch (e) { /* ignore */ }

      // Fetch from API - request 12 months of data
      setStrategyLoading(true);
      try {
        const response = await fetch(`${API_BASE}/historical-sessions?months=12&stock=${selectedContract}`);
        if (response.ok) {
          const result = await response.json();
          if (result.days && !result.loading) {
            if (validateDataForContract(result.days, selectedContract)) {
              setStrategyData(result.days);
              localStorage.setItem(cacheKey, JSON.stringify({
                data: result.days,
                timestamp: Date.now()
              }));
            } else {
              // Still set data even if wrong, so user can see the issue
              setStrategyData(result.days);
            }
          }
        }
      } catch (err) {
        console.error('Failed to fetch strategy data:', err);
      }
      setStrategyLoading(false);
    };

    fetchStrategyData();
  }, [selectedContract]);

  if (loading) {
    return (
      <div style={{ padding: 40, textAlign: 'center', color: '#888' }}>
        <div style={{ fontSize: 24, marginBottom: 8 }}>‚è≥</div>
        Loading session history from Databento...
      </div>
    );
  }

  if (error) {
    return (
      <div style={{ padding: 40, textAlign: 'center' }}>
        <div style={{ fontSize: 24, marginBottom: 8, color: '#ff4466' }}>‚ö†Ô∏è</div>
        <div style={{ color: '#ff4466', marginBottom: 8 }}>Failed to load session data</div>
        <div style={{ color: '#666', fontSize: 12 }}>{error}</div>
      </div>
    );
  }

  if (!data) {
    return <div style={{ padding: 40, textAlign: 'center', color: '#888' }}>No data available</div>;
  }

  return (
    <div style={{ maxWidth: 1400, margin: '0 auto', padding: isMobile ? 12 : 0 }}>
      {/* Header */}
      <div style={{
        display: 'flex',
        flexDirection: isMobile ? 'column' : 'row',
        justifyContent: 'space-between',
        alignItems: isMobile ? 'flex-start' : 'center',
        marginBottom: isMobile ? 16 : 24,
        gap: isMobile ? 12 : 16
      }}>
        <div>
          <h2 style={{ margin: 0, color: '#fff', fontSize: isMobile ? 16 : 20 }}>
            {isMobile ? 'Session Analysis' : 'üìà Session Analysis'}
          </h2>
          <p style={{ margin: '8px 0 0 0', color: '#888', fontSize: isMobile ? 11 : 13 }}>
            Historical Session Range Analysis ‚Ä¢ Range = High - Low
          </p>
        </div>
        <div style={{ display: "flex", gap: isMobile ? 8 : 12, alignItems: 'center', flexWrap: 'wrap' }}>
          {/* Session Filter */}
          <div style={{ display: "flex", gap: 4 }}>
            <button onClick={() => setSessionFilter("horizon")} style={{ padding: isMobile ? "5px 10px" : "6px 12px", borderRadius: 6, border: "none", background: sessionFilter === "horizon" ? "#8B5CF6" : "rgba(255,255,255,0.1)", color: sessionFilter === "horizon" ? "#fff" : "#888", fontSize: isMobile ? 10 : 11, fontWeight: 600, cursor: "pointer" }}>Horizon</button>
            <button onClick={() => setSessionFilter("universe")} style={{ padding: isMobile ? "5px 10px" : "6px 12px", borderRadius: 6, border: "none", background: sessionFilter === "universe" ? "#3B82F6" : "rgba(255,255,255,0.1)", color: sessionFilter === "universe" ? "#fff" : "#888", fontSize: isMobile ? 10 : 11, fontWeight: 600, cursor: "pointer" }}>Universe</button>
          </div>
        </div>
      </div>

      {/* Weekend/Market Closed Banner */}
      {marketStatus.closed && (
        <div style={{
          background: marketStatus.isWeekend
            ? 'linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%)'
            : 'linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%)',
          border: marketStatus.isWeekend
            ? '1px solid rgba(139, 92, 246, 0.3)'
            : '1px solid rgba(0, 255, 136, 0.3)',
          borderRadius: 12,
          padding: '16px 24px',
          marginBottom: 20,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: 12
        }}>
          <span style={{ fontSize: 20 }}>{marketStatus.isWeekend ? 'üåô' : '‚è∏'}</span>
          <div style={{ textAlign: 'center' }}>
            <div style={{
              color: marketStatus.isWeekend ? '#A78BFA' : '#00ff88',
              fontSize: 14,
              fontWeight: 700,
              letterSpacing: 1,
              textTransform: 'uppercase'
            }}>
              {marketStatus.isWeekend ? 'Weekend' : 'Market Closed'}
            </div>
            <div style={{ color: '#888', fontSize: 12, marginTop: 4 }}>
              {marketStatus.isWeekend
                ? `Market Reopens ${marketStatus.reopenDay} ${marketStatus.reopenTime}`
                : `Reopens ${marketStatus.reopenTime}`}
            </div>
          </div>
        </div>
      )}

      {/* Main Layout - Column-Based Session Candles + Data Table */}
      {(() => {
        // Calculate Week High and Week Low across all days in historicalData
        // Track which day/session combination achieved the extreme
        // Use date as identifier for consistent matching
        let weekHighValue = 0;
        let weekLowValue = Infinity;
        let weekHighDate = null;
        let weekHighSessionId = null;
        let weekLowDate = null;
        let weekLowSessionId = null;

        // Get visible session IDs based on current filter
        const visibleSessionIds = new Set(sessions.map(s => s.id));

        if (historicalData && historicalData.length > 0) {
          historicalData.forEach(day => {
            // Check each session - only consider sessions visible in current filter
            Object.entries(day.sessions || {}).forEach(([sessionId, ohlc]) => {
              // Only consider sessions that are visible in the current filter
              if (!visibleSessionIds.has(sessionId)) return;

              if (ohlc && ohlc.h > 0) {
                if (ohlc.h > weekHighValue) {
                  weekHighValue = ohlc.h;
                  weekHighDate = day.date;
                  weekHighSessionId = sessionId;
                }
                if (ohlc.l > 0 && ohlc.l < weekLowValue) {
                  weekLowValue = ohlc.l;
                  weekLowDate = day.date;
                  weekLowSessionId = sessionId;
                }
              }
            });
          });
        }

        // Also check current day's live/ended sessions for week high/low
        const todayDate = (() => {
          const now = new Date();
          return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        })();

        // Build session data with live OHLC
        // During weekend/market closed, use Friday's data from historicalData
        const useFridayData = marketStatus.closed && historicalData && historicalData.length > 0;
        const fridayData = useFridayData ? historicalData[0] : null;

        // Convert historical session OHLC to endedSessions format
        const fridayEndedSessions = fridayData ? Object.fromEntries(
          Object.entries(fridayData.sessions || {}).map(([id, ohlc]) => [
            id,
            { open: ohlc.o, high: ohlc.h, low: ohlc.l, close: ohlc.c, volume: ohlc.v || 0, delta: ohlc.d || 0 }
          ])
        ) : {};

        const endedSessions = useFridayData ? fridayEndedSessions : (liveData?.endedSessions || {});
        const currentPrice = useFridayData ? (fridayData?.day?.c || 0) : (liveData?.currentPrice || 0);
        const dayOpen = useFridayData ? (fridayData?.day?.o || 0) : (liveData?.dayOpen || 0);
        const dayHigh = useFridayData ? (fridayData?.day?.h || 0) : (liveData?.dayHigh || 0);
        const dayLow = useFridayData ? (fridayData?.day?.l || 0) : (liveData?.dayLow || 0);
        const dayVolume = useFridayData ? (fridayData?.day?.v || 0) : (liveData?.totalVolume || 0);
        const currentDelta = useFridayData ? (fridayData?.day?.d || 0) : (liveData?.cumulativeDelta || 0);

        // Label for current day row - format as "MM-DD Day" (e.g., "01-13 Mon")
        const getTodayLabel = () => {
          const now = new Date();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          return `${month}-${day} ${days[now.getDay()]}`;
        };
        const currentDayLabel = useFridayData ? (fridayData?.label || 'Friday') : getTodayLabel();

        // Build session columns with OHLC data
        const sessionColumns = sessions.map(session => {
          const status = getSessionStatus(session.id);
          const sessionData = endedSessions[session.id] || {};
          const isCurrentSession = status === 'NOW';
          const stats = data[session.id] || {};

          const open = isCurrentSession ? (liveData?.sessionOpen || 0) : (sessionData.open || 0);
          const high = isCurrentSession ? (liveData?.sessionHigh || 0) : (sessionData.high || 0);
          const low = isCurrentSession ? (liveData?.sessionLow || 0) : (sessionData.low || 0);
          const close = isCurrentSession ? currentPrice : (sessionData.close || 0);
          const volume = isCurrentSession ? (liveData?.sessionVolume || 0) : (sessionData.volume || 0);
          const delta = isCurrentSession ? (liveData?.sessionDelta || 0) : (sessionData.delta || 0);

          const range = high > 0 && low > 0 ? high - low : 0;
          const deltaPct = volume > 0 ? ((delta / volume) * 100) : 0;

          return {
            ...session,
            status,
            open, high, low, close, volume, delta, deltaPct, range,
            hasData: high > 0 || isCurrentSession,
            pdr: stats.pDR || 0,
            avg10d: stats.avgRange || 0,
            cW: stats.cW || 0,
            pW: stats.pW || 0,
            cM: stats.CM || 0,
            pM: stats.PM || 0,
            max: stats.max || 0,
            min: stats.min || 0,
            todayRange: stats.todayRange || 0
          };
        });

        // Check current day's sessions for week high/low (only for current week)
        if (selectedWeek === 'current') {
          sessionColumns.forEach(session => {
            if (session.high > 0) {
              if (session.high > weekHighValue) {
                weekHighValue = session.high;
                weekHighDate = todayDate;
                weekHighSessionId = session.id;
              }
              if (session.low > 0 && session.low < weekLowValue) {
                weekLowValue = session.low;
                weekLowDate = todayDate;
                weekLowSessionId = session.id;
              }
            }
          });
        }

        // 1D (full day) data
        const avgVal = (key) => {
          const vals = Object.values(data || {}).map(s => s[key] || 0).filter(v => v > 0);
          return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
        };

        const day1DClose = currentPrice > 0 ? currentPrice :
          (endedSessions['ny_close']?.close || endedSessions['ny_pm']?.close || dayHigh);

        const day1D = {
          id: '1d',
          name: '1D',
          color: '#FFFFFF',
          open: dayOpen,
          high: dayHigh,
          low: dayLow,
          close: day1DClose,
          volume: dayVolume,
          delta: currentDelta,
          deltaPct: dayVolume > 0 ? ((currentDelta / dayVolume) * 100) : 0,
          range: dayHigh > 0 && dayLow > 0 ? dayHigh - dayLow : 0,
          hasData: dayOpen > 0,
          pdr: avgVal('pDR'),
          avg10d: avgVal('avgRange'),
          cW: avgVal('cW'),
          pW: avgVal('pW'),
          cM: avgVal('CM'),
          pM: avgVal('PM'),
          max: avgVal('max'),
          min: avgVal('min')
        };

        // Calculate shared Y-axis price range
        const allLows = [day1D.low, ...sessionColumns.filter(s => s.hasData).map(s => s.low)].filter(v => v > 0);
        const allHighs = [day1D.high, ...sessionColumns.filter(s => s.hasData).map(s => s.high)].filter(v => v > 0);
        const priceMin = allLows.length > 0 ? Math.min(...allLows) : 0;
        const priceMax = allHighs.length > 0 ? Math.max(...allHighs) : 0;
        const priceRange = priceMax - priceMin || 1;
        const paddedMin = priceMin - priceRange * 0.08;
        const paddedMax = priceMax + priceRange * 0.08;
        const paddedRange = paddedMax - paddedMin;

        const candleHeight = 180;
        const allBars = [day1D, ...sessionColumns];

        // Format number helper
        const formatNum = (n, decimals = 0) => {
          if (n === undefined || n === null || isNaN(n) || n === 0) return '‚Äî';
          if (Math.abs(n) >= 1000000) return (n / 1000000).toFixed(1) + 'M';
          if (Math.abs(n) >= 1000) return (n / 1000).toFixed(1) + 'K';
          return n.toFixed(decimals);
        };

        // Data rows for metrics table
        const dataRows = [
          { key: 'vol', label: 'VOL', getValue: (d) => formatNum(d.volume), color: '#8B5CF6' },
          { key: 'delta', label: 'DELTA', getValue: (d) => formatNum(d.delta), colorFn: (d) => d.delta >= 0 ? '#00ff88' : '#ff4466' },
          { key: 'deltaPct', label: 'DELTA%', getValue: (d) => d.deltaPct ? `${d.deltaPct.toFixed(1)}%` : '‚Äî', colorFn: (d) => d.deltaPct >= 0 ? '#00ff88' : '#ff4466' },
          { key: 'range', label: 'RANGE', getValue: (d) => d.range > 0 ? d.range.toFixed(1) : '‚Äî', color: '#EC4899' },
          { key: 'pdr', label: 'PDR', getValue: (d) => d.pdr > 0 ? d.pdr.toFixed(1) : '‚Äî', color: '#6366F1' },
          { key: 'avg10d', label: 'AVG', getValue: (d) => d.avg10d > 0 ? d.avg10d.toFixed(1) : '‚Äî', color: '#06B6D4' },
          { key: 'cW', label: 'cW', getValue: (d) => d.cW > 0 ? d.cW.toFixed(1) : '‚Äî', color: '#84CC16' },
          { key: 'pW', label: 'pW', getValue: (d) => d.pW > 0 ? d.pW.toFixed(1) : '‚Äî', color: '#22C55E' },
          { key: 'cM', label: 'cM', getValue: (d) => d.cM > 0 ? d.cM.toFixed(1) : '‚Äî', color: '#F97316' },
          { key: 'pM', label: 'pM', getValue: (d) => d.pM > 0 ? d.pM.toFixed(1) : '‚Äî', color: '#FB923C' },
          { key: 'max', label: 'MAX', getValue: (d) => d.max > 0 ? d.max.toFixed(1) : '‚Äî', color: '#10B981' },
          { key: 'min', label: 'MIN', getValue: (d) => d.min > 0 ? d.min.toFixed(1) : '‚Äî', color: '#EF4444' },
        ];

        // Historical candle height (15% taller)
        const histCandleHeight = 138;

        // Render a single candle row (reusable for current + historical)
        // weekHighInfo/weekLowInfo: { dayLabel, sessionId } for week extremes
        const renderCandleRow = (rowData, rowLabel, isCurrentDay = false, dayDate = null, weekHighInfo = null, weekLowInfo = null) => {
          // For historical days, compute price range from that day's data
          let rowPaddedMin = paddedMin;
          let rowPaddedMax = paddedMax;
          let rowPaddedRange = paddedRange;
          const rowHeight = isCurrentDay ? candleHeight : histCandleHeight;

          if (!isCurrentDay && rowData) {
            const dayOhlc = rowData.day;
            const sessOhlc = Object.values(rowData.sessions || {}).filter(s => s && s.h > 0);
            const allH = sessOhlc.map(s => s.h);
            const allL = sessOhlc.map(s => s.l);
            if (dayOhlc?.h > 0) { allH.push(dayOhlc.h); allL.push(dayOhlc.l); }
            if (allH.length > 0) {
              const pMax = Math.max(...allH);
              const pMin = Math.min(...allL);
              const pRange = pMax - pMin || 1;
              rowPaddedMin = pMin - pRange * 0.08;
              rowPaddedMax = pMax + pRange * 0.08;
              rowPaddedRange = rowPaddedMax - rowPaddedMin;
            }
          }

          // Build bars for this row
          const rowBars = isCurrentDay ? allBars : (() => {
            if (!rowData) return [];
            const dayOhlc = rowData.day || {};
            const day1DRow = {
              id: '1d',
              name: '1D',
              color: '#FFFFFF',
              open: dayOhlc.o || 0,
              high: dayOhlc.h || 0,
              low: dayOhlc.l || 0,
              close: dayOhlc.c || 0,
              hasData: dayOhlc.h > 0
            };
            const sessionBars = sessions.map(session => {
              const sOhlc = rowData.sessions?.[session.id] || {};
              return {
                ...session,
                open: sOhlc.o || 0,
                high: sOhlc.h || 0,
                low: sOhlc.l || 0,
                close: sOhlc.c || 0,
                hasData: sOhlc.h > 0
              };
            });
            return [day1DRow, ...sessionBars];
          })();

          // Find HOD and LOD sessions (excluding 1D column)
          const sessionOnlyBars = rowBars.slice(1).filter(b => b.hasData && b.high > 0);
          let hodSessionId = null;
          let lodSessionId = null;
          if (sessionOnlyBars.length > 0) {
            const maxHigh = Math.max(...sessionOnlyBars.map(b => b.high));
            const minLow = Math.min(...sessionOnlyBars.map(b => b.low));
            const hodSession = sessionOnlyBars.find(b => b.high === maxHigh);
            const lodSession = sessionOnlyBars.find(b => b.low === minLow);
            if (hodSession) hodSessionId = hodSession.id;
            if (lodSession) lodSessionId = lodSession.id;
          }

          return (
            <div style={{
              display: 'flex',
              alignItems: 'stretch',
              margin: '8px 12px',
              borderRadius: 12,
              border: '1px solid rgba(255,255,255,0.1)',
              background: isCurrentDay ? 'rgba(0,255,136,0.02)' : 'rgba(255,255,255,0.02)',
              overflow: 'hidden'
            }}>
              {/* Row Label */}
              <div style={{
                width: 70,
                minWidth: 70,
                padding: '8px 12px',
                display: 'flex',
                flexDirection: 'column',
                justifyContent: 'center',
                alignItems: 'center',
                borderRight: '1px solid rgba(255,255,255,0.05)',
                background: isCurrentDay && marketStatus.closed
                  ? 'linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%)'
                  : isCurrentDay
                    ? 'rgba(0, 255, 136, 0.05)'
                    : 'transparent'
              }}>
                {isCurrentDay && marketStatus.closed ? (
                  <>
                    <div style={{ fontSize: 16, marginBottom: 4 }}>üåô</div>
                    <div style={{
                      color: '#A78BFA',
                      fontSize: 11,
                      fontWeight: 700,
                      letterSpacing: 0.5
                    }}>
                      {rowLabel}
                    </div>
                    <div style={{
                      color: '#666',
                      fontSize: 9,
                      marginTop: 2
                    }}>
                      (Closed)
                    </div>
                  </>
                ) : isCurrentDay ? (
                  <>
                    <div style={{
                      color: '#00ff88',
                      fontSize: 12,
                      fontWeight: 600,
                      lineHeight: 1.2
                    }}>
                      {/* Format: "01-16" on first line */}
                      {rowLabel.split(' ')[0]}
                    </div>
                    <div style={{
                      color: '#00ff88',
                      fontSize: 10,
                      fontWeight: 500,
                      marginTop: 2,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 4
                    }}>
                      {/* Day name with live dot */}
                      {rowLabel.split(' ')[1] || ''}
                      <div style={{
                        width: 5,
                        height: 5,
                        borderRadius: '50%',
                        background: '#00ff88',
                        animation: 'pulse 1.5s ease-in-out infinite',
                        boxShadow: '0 0 6px rgba(0, 255, 136, 0.6)'
                      }} />
                    </div>
                  </>
                ) : (
                  <>
                    <div style={{
                      color: '#A78BFA',
                      fontSize: 12,
                      fontWeight: 600,
                      lineHeight: 1.2
                    }}>
                      {/* Format: "01-15" on first line */}
                      {rowLabel.split(' ')[0]}
                    </div>
                    <div style={{
                      color: '#8B7FC7',
                      fontSize: 10,
                      fontWeight: 500,
                      marginTop: 2
                    }}>
                      {/* Day name on second line */}
                      {rowLabel.split(' ')[1] || ''}
                    </div>
                  </>
                )}
              </div>

              {/* Candles */}
              <div style={{ flex: 1, display: 'flex', height: rowHeight, position: 'relative' }}>
                {rowBars.map((bar, idx) => {
                  const isDay = idx === 0;
                  const barId = `${rowLabel}-${bar.id || bar.name}`;
                  const isHOD = !isDay && bar.id === hodSessionId;
                  const isLOD = !isDay && bar.id === lodSessionId;
                  // Check if this session is the High Of Week or Low Of Week (using date for matching)
                  const isHOW = !isDay && weekHighInfo && weekHighInfo.dayDate === dayDate && weekHighInfo.sessionId === bar.id;
                  const isLOW = !isDay && weekLowInfo && weekLowInfo.dayDate === dayDate && weekLowInfo.sessionId === bar.id;

                  // Light column background color
                  const columnBgColor = isDay ? 'rgba(255,255,255,0.02)' : `${bar.color}06`;

                  return (
                    <div
                      key={barId}
                      style={{
                        flex: isDay ? '0 0 8%' : 1,
                        position: 'relative',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        paddingTop: (isHOD || isHOW) ? 14 : 0,
                        paddingBottom: (isLOD || isLOW) ? 14 : 0,
                        // Light column container background
                        background: columnBgColor,
                        borderLeft: idx > 0 ? '1px solid rgba(255,255,255,0.02)' : 'none'
                      }}
                      onMouseEnter={(e) => {
                        if (bar.hasData && bar.high > 0) {
                          setHoveredBar({ ...bar, label: `${rowLabel} - ${bar.name || '1D'}`, isHOD, isLOD, isHOW, isLOW });
                          const rect = e.currentTarget.getBoundingClientRect();
                          setMousePos({ x: rect.left + rect.width / 2, y: rect.top });
                        }
                      }}
                      onMouseLeave={() => setHoveredBar(null)}
                    >
                      {/* HOD short dash above */}
                      {isHOD && !isHOW && (
                        <div style={{
                          position: 'absolute',
                          top: 6,
                          left: '50%',
                          transform: 'translateX(-50%)',
                          width: 24,
                          height: 0,
                          borderTop: '1px dashed #10B981'
                        }} />
                      )}
                      {/* LOD short dash below */}
                      {isLOD && !isLOW && (
                        <div style={{
                          position: 'absolute',
                          bottom: 6,
                          left: '50%',
                          transform: 'translateX(-50%)',
                          width: 24,
                          height: 0,
                          borderTop: '1px dashed #EF4444'
                        }} />
                      )}
                      {/* HIGH OF WEEK - inverted triangle pointing down at top */}
                      {isHOW && (
                        <div style={{
                          position: 'absolute',
                          top: 4,
                          left: '50%',
                          transform: 'translateX(-50%)',
                          width: 0,
                          height: 0,
                          borderLeft: '6px solid transparent',
                          borderRight: '6px solid transparent',
                          borderTop: '8px solid #00ff88',
                          filter: 'drop-shadow(0 0 4px #00ff88)'
                        }} />
                      )}
                      {/* LOW OF WEEK - inverted triangle pointing up at bottom */}
                      {isLOW && (
                        <div style={{
                          position: 'absolute',
                          bottom: 4,
                          left: '50%',
                          transform: 'translateX(-50%)',
                          width: 0,
                          height: 0,
                          borderLeft: '6px solid transparent',
                          borderRight: '6px solid transparent',
                          borderBottom: '8px solid #ff4466',
                          filter: 'drop-shadow(0 0 4px #ff4466)'
                        }} />
                      )}
                      {bar.hasData && bar.high > 0 && (() => {
                        const isUp = bar.close >= bar.open;
                        // Body color based on up/down close
                        const bodyColor = isUp ? '#00ff88' : '#ff4466';
                        const closeColor = isUp ? '#00ff88' : '#ff4466';
                        // 70% thinner
                        const wickWidth = 1.5;
                        const tickLen = 7;    // Half width
                        const tickH = 2;
                        const gap = 1; // Minimal gap since ticks are thinner

                        const highY = rowHeight - ((bar.high - rowPaddedMin) / rowPaddedRange) * rowHeight;
                        const lowY = rowHeight - ((bar.low - rowPaddedMin) / rowPaddedRange) * rowHeight;
                        const openY = rowHeight - ((bar.open - rowPaddedMin) / rowPaddedRange) * rowHeight;
                        const closeY = rowHeight - ((bar.close - rowPaddedMin) / rowPaddedRange) * rowHeight;

                        return (
                          <svg width="100%" height={rowHeight} viewBox={`0 0 40 ${rowHeight}`} preserveAspectRatio="xMidYMid meet" style={{ overflow: 'visible', cursor: 'pointer' }}>
                            {/* Vertical wick - green/red based on close */}
                            <line
                              x1="20" y1={Math.max(2, highY)} x2="20" y2={Math.min(rowHeight - 2, lowY)}
                              stroke={isHOW ? '#00ff88' : isLOW ? '#ff4466' : bodyColor}
                              strokeWidth={wickWidth}
                              strokeLinecap="butt"
                              style={{ filter: `drop-shadow(0 0 2px ${bodyColor}60)` }}
                            />
                            {/* Open tick - left - WHITE */}
                            <rect
                              x={20 - gap - tickLen}
                              y={Math.max(0, Math.min(rowHeight - tickH, openY - tickH/2))}
                              width={tickLen}
                              height={tickH}
                              fill="#FFFFFF"
                              style={{ opacity: 0.9 }}
                            />
                            {/* Close tick - right - green/red */}
                            <rect
                              x={20 + gap}
                              y={Math.max(0, Math.min(rowHeight - tickH, closeY - tickH/2))}
                              width={tickLen}
                              height={tickH}
                              fill={closeColor}
                              style={{ filter: `drop-shadow(0 0 2px ${closeColor}60)` }}
                            />
                          </svg>
                        );
                      })()}
                    </div>
                  );
                })}
              </div>
            </div>
          );
        };

        return (
          <div className="hide-scrollbar" style={{
            background: 'linear-gradient(180deg, rgba(12,12,16,0.98) 0%, rgba(8,8,12,1) 100%)',
            borderRadius: 16,
            border: '1px solid rgba(255,255,255,0.08)',
            boxShadow: '0 8px 32px rgba(0,0,0,0.6)',
            position: 'relative',
            maxHeight: '90vh',
            overflowY: 'auto',
            overflowX: 'hidden'
          }}>
            {/* Session Labels Row - Aligned with candle columns */}
            <div style={{
              position: 'sticky',
              top: 0,
              zIndex: 20,
              background: 'linear-gradient(180deg, rgba(12,12,16,1) 0%, rgba(12,12,16,0.98) 100%)',
              padding: '12px 12px 8px 12px',
              borderBottom: '1px solid rgba(255,255,255,0.06)',
              borderTopLeftRadius: 16,
              borderTopRightRadius: 16
            }}>
              {/* Session headers matching candle row layout */}
              <div style={{
                display: 'flex',
                alignItems: 'stretch',
                margin: '0 12px',
                borderRadius: 12
              }}>
                {/* Empty space for date label column */}
                <div style={{ width: 70, minWidth: 70 }} />

                {/* Session circles container - matches candle flex layout */}
                <div style={{ flex: 1, display: 'flex', position: 'relative' }}>
                  {allBars.map((bar, idx) => {
                    const isDay = idx === 0;
                    const isNow = bar.status === 'NOW';
                    const isWaiting = bar.status === 'WAITING';
                    const columnColor = isDay ? '#FFFFFF' : (bar.color || '#FFFFFF');
                    const isHovered = hoveredSessionTab === (bar.id || idx);

                    // Split long names into two lines
                    const nameParts = bar.name?.includes(' ') ? bar.name.split(' ') : [bar.name];
                    const isMultiLine = nameParts.length > 1;

                    return (
                      <div
                        key={bar.id || idx}
                        onMouseEnter={() => setHoveredSessionTab(bar.id || idx)}
                        onMouseLeave={() => setHoveredSessionTab(null)}
                        style={{
                          flex: isDay ? '0 0 8%' : 1,
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'flex-end',
                          position: 'relative',
                          cursor: 'pointer',
                          paddingBottom: 8
                        }}
                      >
                        {/* Round Container - Fixed size for all */}
                        <div style={{
                          width: 73,
                          height: 73,
                          borderRadius: '50%',
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'center',
                          gap: 3,
                          padding: 10,
                          background: isNow && !marketStatus.closed
                            ? `linear-gradient(135deg, ${columnColor}30 0%, ${columnColor}15 100%)`
                            : isHovered
                              ? `linear-gradient(135deg, ${columnColor}20 0%, ${columnColor}10 100%)`
                              : 'rgba(20, 20, 28, 0.9)',
                          border: isNow && !marketStatus.closed
                            ? `2px solid ${columnColor}`
                            : isHovered
                              ? `2px solid ${columnColor}60`
                              : '1px solid rgba(255,255,255,0.1)',
                          opacity: isWaiting ? 0.4 : (marketStatus.closed && !isDay ? 0.6 : 1),
                          transition: 'all 0.2s ease',
                          boxShadow: isNow && !marketStatus.closed
                            ? `0 0 12px ${columnColor}50`
                            : isHovered
                              ? `0 0 10px ${columnColor}30`
                              : '0 2px 8px rgba(0,0,0,0.3)',
                          position: 'relative'
                        }}>
                          {/* Color Dot */}
                          <div style={{
                            width: 6,
                            height: 6,
                            borderRadius: '50%',
                            background: isDay ? '#888' : (marketStatus.closed ? '#555' : columnColor),
                            boxShadow: (isNow && !marketStatus.closed) || isHovered ? `0 0 6px ${columnColor}` : 'none',
                            animation: isNow && !marketStatus.closed ? 'sessionDotPulse 1.5s ease-in-out infinite' : 'none'
                          }} />
                          {/* Session Name */}
                          {isMultiLine ? (
                            <div style={{ textAlign: 'center', lineHeight: 1.1 }}>
                              <div style={{
                                fontSize: 11,
                                color: isNow && !marketStatus.closed ? columnColor : isHovered ? columnColor : marketStatus.closed && !isDay ? '#666' : '#e5e5e5',
                                fontWeight: 600
                              }}>{nameParts[0]}</div>
                              <div style={{
                                fontSize: 10,
                                color: isNow && !marketStatus.closed ? columnColor : isHovered ? columnColor : marketStatus.closed && !isDay ? '#555' : '#bbb',
                                fontWeight: 500
                              }}>{nameParts.slice(1).join(' ')}</div>
                            </div>
                          ) : (
                            <span style={{
                              fontSize: bar.name?.length > 6 ? 10 : 12,
                              color: isDay ? (isHovered ? '#ccc' : '#999') : (isNow && !marketStatus.closed ? columnColor : isHovered ? columnColor : marketStatus.closed ? '#666' : '#e5e5e5'),
                              fontWeight: 600,
                              textAlign: 'center',
                              lineHeight: 1.1
                            }}>
                              {bar.name}
                            </span>
                          )}

                          {/* LIVE Badge */}
                          {isNow && !marketStatus.closed && (
                            <div style={{
                              position: 'absolute',
                              bottom: -8,
                              left: '50%',
                              transform: 'translateX(-50%)',
                              background: '#00ff88',
                              color: '#000',
                              fontSize: 7,
                              fontWeight: 700,
                              padding: '2px 6px',
                              borderRadius: 8,
                              letterSpacing: '0.05em',
                              boxShadow: '0 2px 6px rgba(0,255,136,0.4)'
                            }}>
                              LIVE
                            </div>
                          )}

                          {/* Hover Popup Tooltip with metrics */}
                          {isHovered && !isDay && (
                            <div style={{
                              position: 'absolute',
                              top: '100%',
                              left: '50%',
                              transform: 'translateX(-50%)',
                              marginTop: 12,
                              background: 'linear-gradient(135deg, rgba(12, 12, 18, 0.98) 0%, rgba(18, 18, 28, 0.98) 100%)',
                              border: `1px solid ${columnColor}30`,
                              borderRadius: 12,
                              padding: '14px 18px',
                              minWidth: 200,
                              zIndex: 100,
                              boxShadow: `0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05) inset`,
                              pointerEvents: 'none'
                            }}>
                              {/* Arrow */}
                              <div style={{
                                position: 'absolute',
                                top: -6,
                                left: '50%',
                                width: 10,
                                height: 10,
                                background: 'rgba(12, 12, 18, 0.98)',
                                border: `1px solid ${columnColor}30`,
                                borderRight: 'none',
                                borderBottom: 'none',
                                transform: 'translateX(-50%) rotate(45deg)'
                              }} />
                              {/* Session Header - Center aligned */}
                              <div style={{ textAlign: 'center', marginBottom: 10, paddingBottom: 8, borderBottom: '1px solid rgba(255,255,255,0.08)' }}>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}>
                                  <div style={{
                                    width: 8,
                                    height: 8,
                                    borderRadius: '50%',
                                    background: columnColor,
                                    boxShadow: `0 0 8px ${columnColor}`
                                  }} />
                                  <span style={{ color: columnColor, fontWeight: 700, fontSize: 14, letterSpacing: 0.5 }}>{bar.name}</span>
                                  {isNow && !marketStatus.closed && (
                                    <span style={{
                                      background: '#00ff88',
                                      color: '#000',
                                      fontSize: 7,
                                      fontWeight: 700,
                                      padding: '2px 5px',
                                      borderRadius: 4
                                    }}>LIVE</span>
                                  )}
                                </div>
                                {/* Time Range - Center */}
                                {bar.start && bar.end && (
                                  <div style={{
                                    fontSize: 10,
                                    color: '#666',
                                    fontFamily: "'JetBrains Mono', monospace",
                                    marginTop: 4
                                  }}>
                                    {bar.start} - {bar.end} ET
                                  </div>
                                )}
                              </div>
                              {/* Metrics Grid - removed RANGE, renamed AVG */}
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px 16px', fontSize: 10 }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#8B5CF6' }}>VOL</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.volume ? (bar.volume >= 1000 ? (bar.volume/1000).toFixed(1)+'K' : bar.volume) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: bar.delta >= 0 ? '#00ff88' : '#ff4466' }}>DELTA</span>
                                  <span style={{ color: bar.delta >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace' }}>{bar.delta ? (Math.abs(bar.delta) >= 1000 ? (bar.delta/1000).toFixed(1)+'K' : bar.delta) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#6366F1' }}>pDR</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.pdr > 0 ? bar.pdr.toFixed(1) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#06B6D4' }}>10D</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.avg10d > 0 ? bar.avg10d.toFixed(1) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#84CC16' }}>cW</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.cW > 0 ? bar.cW.toFixed(1) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#22C55E' }}>pW</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.pW > 0 ? bar.pW.toFixed(1) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#F97316' }}>cM</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.cM > 0 ? bar.cM.toFixed(1) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#FB923C' }}>pM</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.pM > 0 ? bar.pM.toFixed(1) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#10B981' }}>MAX</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.max > 0 ? bar.max.toFixed(1) : '‚Äî'}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#EF4444' }}>MIN</span>
                                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{bar.min > 0 ? bar.min.toFixed(1) : '‚Äî'}</span>
                                </div>
                              </div>
                              {/* Status */}
                              <div style={{
                                marginTop: 10,
                                paddingTop: 8,
                                borderTop: '1px solid rgba(255,255,255,0.06)',
                                fontSize: 9,
                                color: isNow && !marketStatus.closed ? '#00ff88' : isWaiting ? '#555' : '#666',
                                textTransform: 'uppercase',
                                letterSpacing: '0.5px',
                                textAlign: 'center'
                              }}>
                                {isNow && !marketStatus.closed ? '‚óè Active Session' : isWaiting ? '‚óã Upcoming' : '‚óã Ended'}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            {/* Current Day Candles (shows Friday data during weekend) */}
            {renderCandleRow(null, currentDayLabel, true, todayDate,
              { dayDate: weekHighDate, sessionId: weekHighSessionId },
              { dayDate: weekLowDate, sessionId: weekLowSessionId }
            )}

            {/* Week Selector - always visible */}
            <div style={{
              padding: '8px 12px',
              borderTop: '1px solid rgba(255,255,255,0.05)',
              borderBottom: '1px solid rgba(255,255,255,0.05)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'flex-end',
              gap: 12,
              background: 'rgba(15, 15, 20, 0.5)'
            }}>
              {/* Week Selector Buttons */}
              <div style={{ display: 'flex', gap: 4 }}>
                {weekTabs.map(week => (
                  <button
                    key={week.id}
                    onClick={() => setSelectedWeek(week.id)}
                    style={{
                      padding: '6px 10px',
                      background: selectedWeek === week.id ? 'rgba(59, 130, 246, 0.2)' : 'rgba(255,255,255,0.03)',
                      border: selectedWeek === week.id ? '1px solid rgba(59, 130, 246, 0.4)' : '1px solid rgba(255,255,255,0.08)',
                      borderRadius: 4,
                      color: selectedWeek === week.id ? '#60A5FA' : '#666',
                      fontSize: 10,
                      fontWeight: 600,
                      cursor: 'pointer',
                      transition: 'all 0.15s ease',
                      letterSpacing: '0.5px'
                    }}
                  >
                    {week.label}
                  </button>
                ))}
              </div>
              {/* Clear Cache Button */}
              <button
                onClick={clearCacheAndRefresh}
                title={`Clear cached data for ${weekTabs.find(w => w.id === selectedWeek)?.label || selectedWeek} and refresh from server`}
                style={{
                  padding: '6px 8px',
                  background: 'rgba(239, 68, 68, 0.1)',
                  border: '1px solid rgba(239, 68, 68, 0.3)',
                  borderRadius: 4,
                  color: '#EF4444',
                  fontSize: 10,
                  fontWeight: 500,
                  cursor: 'pointer',
                  transition: 'all 0.15s ease',
                  display: 'flex',
                  alignItems: 'center',
                  gap: 4
                }}
              >
                üîÑ Refresh
              </button>
            </div>

            {/* Historical Days - Always visible */}
            <div>
              {historicalData && historicalData.length > 0 ? (
                (() => {
                  // Get today's date string in YYYY-MM-DD format
                  const today = new Date();
                  const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                  // Filter out today's date if present (it's shown separately above)
                  const daysToShow = selectedWeek === 'current'
                    ? historicalData.filter(day => day.date !== todayStr)
                    : historicalData;
                  return daysToShow.map((day, dayIdx) => {
                    // Create label with date (MM-DD) and day name
                    let dayLabel = day.label || `Day ${dayIdx + 1}`;
                    if (day.date) {
                      const dateParts = day.date.split('-');
                      const dateObj = new Date(day.date + 'T12:00:00');
                      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                      const monthDay = `${dateParts[1]}-${dateParts[2]}`;
                      const dayName = dayNames[dateObj.getDay()];
                      dayLabel = `${monthDay} ${dayName}`;
                    }
                    // Pass week high/low info for highlighting (using date for matching)
                    const weekHighInfo = { dayDate: weekHighDate, sessionId: weekHighSessionId };
                    const weekLowInfo = { dayDate: weekLowDate, sessionId: weekLowSessionId };
                    return renderCandleRow(day, dayLabel, false, day.date, weekHighInfo, weekLowInfo);
                  });
                })()
              ) : (
                <div style={{ padding: '20px', textAlign: 'center', color: '#666' }}>
                  Loading historical data...
                </div>
              )}
            </div>

            {/* Legend - below charts */}
            <div style={{
              padding: '10px 16px',
              margin: '0 12px',
              background: 'rgba(0,0,0,0.3)',
              borderRadius: 8,
              display: 'flex',
              gap: 16,
              justifyContent: 'center',
              alignItems: 'center',
              flexWrap: 'wrap',
              fontSize: 11,
              color: '#555'
            }}>
              <span style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                <svg width="16" height="4" style={{ display: 'block' }}>
                  <line x1="0" y1="2" x2="16" y2="2" stroke="#10B981" strokeWidth="2" strokeDasharray="3,2" />
                </svg>
                <span style={{ color: '#10B981' }}>High of Day</span>
              </span>
              <span style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                <svg width="16" height="4" style={{ display: 'block' }}>
                  <line x1="0" y1="2" x2="16" y2="2" stroke="#EF4444" strokeWidth="2" strokeDasharray="3,2" />
                </svg>
                <span style={{ color: '#EF4444' }}>Low of Day</span>
              </span>
              <span style={{ borderLeft: '1px solid #333', height: 16, margin: '0 4px' }} />
              <span style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                <div style={{ width: 0, height: 0, borderLeft: '5px solid transparent', borderRight: '5px solid transparent', borderTop: '8px solid #00ff88', filter: 'drop-shadow(0 0 3px #00ff88)' }} />
                <span style={{ color: '#00ff88' }}>High of Week</span>
              </span>
              <span style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                <div style={{ width: 0, height: 0, borderLeft: '5px solid transparent', borderRight: '5px solid transparent', borderBottom: '8px solid #ff4466', filter: 'drop-shadow(0 0 3px #ff4466)' }} />
                <span style={{ color: '#ff4466' }}>Low of Week</span>
              </span>
            </div>

            {/* Session Trade Calculator */}
            <div style={{
              margin: '12px',
              background: 'rgba(20, 20, 30, 0.8)',
              borderRadius: 12,
              border: '1px solid rgba(139, 92, 246, 0.3)',
              overflow: 'hidden'
            }}>
              {/* Calculator Header - Toggle */}
              <div
                onClick={() => setShowCalculator(!showCalculator)}
                style={{
                  padding: '12px 16px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  cursor: 'pointer',
                  background: showCalculator ? 'rgba(139, 92, 246, 0.15)' : 'transparent',
                  borderBottom: showCalculator ? '1px solid rgba(139, 92, 246, 0.2)' : 'none',
                  transition: 'all 0.2s ease'
                }}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                  <span style={{ fontSize: 16 }}>üéØ</span>
                  <span style={{ color: '#A78BFA', fontWeight: 600, fontSize: 13 }}>Session Trade Calculator</span>
                  <span style={{ color: '#666', fontSize: 11 }}>‚Ä¢ Entry ‚Üí Target Analysis</span>
                </div>
                <span style={{ color: '#8B5CF6', fontSize: 12, transform: showCalculator ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s ease' }}>‚ñº</span>
              </div>

              {/* Calculator Body */}
              {showCalculator && (
                <div style={{ padding: 16 }}>
                  {/* Input Controls */}
                  <div style={{ display: 'flex', gap: 16, flexWrap: 'wrap', marginBottom: 16 }}>
                    {/* Entry Session Selector */}
                    <div style={{ flex: '1 1 180px' }}>
                      <label style={{ display: 'block', fontSize: 10, color: '#888', marginBottom: 6, letterSpacing: '0.5px' }}>ENTRY SESSION</label>
                      <select
                        value={calcEntrySession}
                        onChange={(e) => setCalcEntrySession(e.target.value)}
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          background: 'rgba(0,0,0,0.4)',
                          border: '1px solid rgba(139, 92, 246, 0.3)',
                          borderRadius: 8,
                          color: '#fff',
                          fontSize: 13,
                          cursor: 'pointer',
                          outline: 'none'
                        }}
                      >
                        {sessions.map(s => (
                          <option key={s.id} value={s.id} style={{ background: '#1a1a2e' }}>{s.name}</option>
                        ))}
                      </select>
                    </div>

                    {/* Target Points Input */}
                    <div style={{ flex: '1 1 120px' }}>
                      <label style={{ display: 'block', fontSize: 10, color: '#888', marginBottom: 6, letterSpacing: '0.5px' }}>TARGET POINTS</label>
                      <input
                        type="number"
                        value={calcTargetPoints}
                        onChange={(e) => setCalcTargetPoints(Math.max(0, parseFloat(e.target.value) || 0))}
                        style={{
                          width: '100%',
                          padding: '10px 12px',
                          background: 'rgba(0,0,0,0.4)',
                          border: '1px solid rgba(139, 92, 246, 0.3)',
                          borderRadius: 8,
                          color: '#fff',
                          fontSize: 13,
                          outline: 'none',
                          textAlign: 'center'
                        }}
                        min="0"
                        step="0.5"
                      />
                    </div>

                    {/* Direction Toggle */}
                    <div style={{ flex: '1 1 160px' }}>
                      <label style={{ display: 'block', fontSize: 10, color: '#888', marginBottom: 6, letterSpacing: '0.5px' }}>DIRECTION</label>
                      <div style={{ display: 'flex', gap: 4 }}>
                        <button
                          onClick={() => setCalcDirection('long')}
                          style={{
                            flex: 1,
                            padding: '10px 16px',
                            background: calcDirection === 'long' ? 'rgba(0, 255, 136, 0.2)' : 'rgba(0,0,0,0.3)',
                            border: calcDirection === 'long' ? '1px solid #00ff88' : '1px solid rgba(255,255,255,0.1)',
                            borderRadius: '8px 0 0 8px',
                            color: calcDirection === 'long' ? '#00ff88' : '#666',
                            fontSize: 12,
                            fontWeight: 600,
                            cursor: 'pointer',
                            transition: 'all 0.2s ease'
                          }}
                        >
                          ‚Üë LONG
                        </button>
                        <button
                          onClick={() => setCalcDirection('short')}
                          style={{
                            flex: 1,
                            padding: '10px 16px',
                            background: calcDirection === 'short' ? 'rgba(255, 68, 102, 0.2)' : 'rgba(0,0,0,0.3)',
                            border: calcDirection === 'short' ? '1px solid #ff4466' : '1px solid rgba(255,255,255,0.1)',
                            borderRadius: '0 8px 8px 0',
                            color: calcDirection === 'short' ? '#ff4466' : '#666',
                            fontSize: 12,
                            fontWeight: 600,
                            cursor: 'pointer',
                            transition: 'all 0.2s ease'
                          }}
                        >
                          ‚Üì SHORT
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Session Filter - Toggle sessions to include/exclude */}
                  <div style={{ marginBottom: 16 }}>
                    <label style={{ display: 'block', fontSize: 10, color: '#888', marginBottom: 8, letterSpacing: '0.5px' }}>
                      FILTER SESSIONS <span style={{ color: '#666' }}>‚Ä¢ Click to exclude from analysis</span>
                    </label>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>
                      {sessions.map(sess => {
                        const isExcluded = calcExcludedSessions.has(sess.id);
                        const isEntrySession = sess.id === calcEntrySession;
                        return (
                          <button
                            key={sess.id}
                            onClick={() => {
                              if (isEntrySession) return; // Can't exclude entry session
                              const newExcluded = new Set(calcExcludedSessions);
                              if (isExcluded) {
                                newExcluded.delete(sess.id);
                              } else {
                                newExcluded.add(sess.id);
                              }
                              setCalcExcludedSessions(newExcluded);
                            }}
                            style={{
                              padding: '6px 12px',
                              background: isEntrySession
                                ? 'rgba(139, 92, 246, 0.3)'
                                : isExcluded
                                  ? 'rgba(255,255,255,0.02)'
                                  : `${sess.color}22`,
                              border: isEntrySession
                                ? '1px solid #8B5CF6'
                                : isExcluded
                                  ? '1px solid rgba(255,255,255,0.1)'
                                  : `1px solid ${sess.color}66`,
                              borderRadius: 6,
                              color: isEntrySession
                                ? '#A78BFA'
                                : isExcluded
                                  ? '#444'
                                  : sess.color,
                              fontSize: 10,
                              fontWeight: 500,
                              cursor: isEntrySession ? 'not-allowed' : 'pointer',
                              transition: 'all 0.15s ease',
                              textDecoration: isExcluded ? 'line-through' : 'none',
                              opacity: isExcluded ? 0.5 : 1
                            }}
                            title={isEntrySession ? 'Entry session (cannot exclude)' : isExcluded ? 'Click to include' : 'Click to exclude'}
                          >
                            {isEntrySession && '‚ñ∂ '}{sess.name}
                          </button>
                        );
                      })}
                      {calcExcludedSessions.size > 0 && (
                        <button
                          onClick={() => setCalcExcludedSessions(new Set())}
                          style={{
                            padding: '6px 12px',
                            background: 'rgba(239, 68, 68, 0.1)',
                            border: '1px solid rgba(239, 68, 68, 0.3)',
                            borderRadius: 6,
                            color: '#EF4444',
                            fontSize: 10,
                            fontWeight: 500,
                            cursor: 'pointer'
                          }}
                        >
                          Reset All
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Results Table */}
                  {historicalData && historicalData.length > 0 && (() => {
                    // Get sessions after entry session
                    const entryIdx = sessions.findIndex(s => s.id === calcEntrySession);
                    const subsequentSessions = sessions.slice(entryIdx + 1).filter(s => !calcExcludedSessions.has(s.id));

                    // Analyze each day
                    const results = historicalData.map(day => {
                      const entrySess = day.sessions?.[calcEntrySession];
                      if (!entrySess || !entrySess.o || entrySess.o <= 0) return null;

                      const entryPrice = entrySess.o;
                      const targetPrice = calcDirection === 'long'
                        ? entryPrice + calcTargetPoints
                        : entryPrice - calcTargetPoints;

                      // Track max drawdown (worst adverse move before target hit)
                      let maxDrawdown = 0;
                      let runningWorstPrice = calcDirection === 'long' ? Infinity : 0;
                      let targetHitIdx = -1;

                      // Check each subsequent session
                      const sessionResults = subsequentSessions.map((sess, idx) => {
                        const sessData = day.sessions?.[sess.id];
                        if (!sessData || !sessData.h || sessData.h <= 0) {
                          return { session: sess, hit: false, noData: true, drawdownAtSession: 0 };
                        }

                        const hit = calcDirection === 'long'
                          ? sessData.h >= targetPrice
                          : sessData.l <= targetPrice;

                        // Calculate drawdown before this session's potential hit
                        // For LONG: track lowest low (adverse = price going down)
                        // For SHORT: track highest high (adverse = price going up)
                        if (targetHitIdx === -1) {
                          if (calcDirection === 'long') {
                            runningWorstPrice = Math.min(runningWorstPrice, sessData.l);
                            const currentDrawdown = entryPrice - runningWorstPrice;
                            maxDrawdown = Math.max(maxDrawdown, currentDrawdown);
                          } else {
                            runningWorstPrice = Math.max(runningWorstPrice, sessData.h);
                            const currentDrawdown = runningWorstPrice - entryPrice;
                            maxDrawdown = Math.max(maxDrawdown, currentDrawdown);
                          }
                        }

                        if (hit && targetHitIdx === -1) {
                          targetHitIdx = idx;
                        }

                        const hitPrice = calcDirection === 'long' ? sessData.h : sessData.l;

                        return {
                          session: sess,
                          hit,
                          hitPrice,
                          high: sessData.h,
                          low: sessData.l,
                          overshoot: hit ? (calcDirection === 'long' ? sessData.h - targetPrice : targetPrice - sessData.l) : 0,
                          drawdownAtSession: calcDirection === 'long'
                            ? Math.max(0, entryPrice - sessData.l)
                            : Math.max(0, sessData.h - entryPrice)
                        };
                      });

                      // Find first session that hit target
                      const firstHit = sessionResults.find(r => r.hit);

                      return {
                        date: day.date,
                        label: day.label,
                        entryPrice,
                        targetPrice,
                        sessionResults,
                        firstHit,
                        hitAny: sessionResults.some(r => r.hit),
                        maxDrawdown: maxDrawdown > 0 ? maxDrawdown : 0
                      };
                    }).filter(Boolean);

                    // Calculate success rate
                    const successRate = results.length > 0
                      ? ((results.filter(r => r.hitAny).length / results.length) * 100).toFixed(0)
                      : 0;

                    // Find most common first-hit session
                    const firstHitCounts = {};
                    results.forEach(r => {
                      if (r.firstHit) {
                        firstHitCounts[r.firstHit.session.id] = (firstHitCounts[r.firstHit.session.id] || 0) + 1;
                      }
                    });
                    const mostCommonHit = Object.entries(firstHitCounts).sort((a, b) => b[1] - a[1])[0];

                    // Calculate drawdown statistics
                    const drawdowns = results.map(r => r.maxDrawdown).filter(d => d > 0);
                    const avgDrawdown = drawdowns.length > 0
                      ? (drawdowns.reduce((a, b) => a + b, 0) / drawdowns.length)
                      : 0;
                    const worstDrawdown = drawdowns.length > 0 ? Math.max(...drawdowns) : 0;

                    return (
                      <div>
                        {/* Summary Stats */}
                        <div style={{
                          display: 'flex',
                          gap: 12,
                          marginBottom: 16,
                          padding: '12px 16px',
                          background: 'rgba(0,0,0,0.3)',
                          borderRadius: 8
                        }}>
                          <div style={{ flex: 1, textAlign: 'center' }}>
                            <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>SUCCESS RATE</div>
                            <div style={{
                              fontSize: 24,
                              fontWeight: 700,
                              color: successRate >= 70 ? '#00ff88' : successRate >= 50 ? '#F59E0B' : '#ff4466'
                            }}>
                              {successRate}%
                            </div>
                          </div>
                          <div style={{ flex: 1, textAlign: 'center', borderLeft: '1px solid rgba(255,255,255,0.1)', paddingLeft: 12 }}>
                            <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>MOST LIKELY HIT</div>
                            <div style={{ fontSize: 14, fontWeight: 600, color: '#A78BFA' }}>
                              {mostCommonHit ? sessions.find(s => s.id === mostCommonHit[0])?.name || '‚Äî' : '‚Äî'}
                            </div>
                            {mostCommonHit && (
                              <div style={{ fontSize: 10, color: '#666' }}>{mostCommonHit[1]} of {results.length} days</div>
                            )}
                          </div>
                          <div style={{ flex: 1, textAlign: 'center', borderLeft: '1px solid rgba(255,255,255,0.1)', paddingLeft: 12 }}>
                            <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>ENTRY SESSION</div>
                            <div style={{ fontSize: 14, fontWeight: 600, color: sessions.find(s => s.id === calcEntrySession)?.color || '#fff' }}>
                              {sessions.find(s => s.id === calcEntrySession)?.name || calcEntrySession}
                            </div>
                            <div style={{ fontSize: 10, color: '#666' }}>‚Üí +{calcTargetPoints} pts {calcDirection === 'long' ? '‚Üë' : '‚Üì'}</div>
                          </div>
                          <div style={{ flex: 1, textAlign: 'center', borderLeft: '1px solid rgba(255,255,255,0.1)', paddingLeft: 12 }}>
                            <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>AVG DRAWDOWN</div>
                            <div style={{ fontSize: 18, fontWeight: 700, color: '#F59E0B' }}>
                              {avgDrawdown > 0 ? avgDrawdown.toFixed(1) : '0'}
                            </div>
                            <div style={{ fontSize: 10, color: '#666' }}>points</div>
                          </div>
                          <div style={{ flex: 1, textAlign: 'center', borderLeft: '1px solid rgba(255,255,255,0.1)', paddingLeft: 12 }}>
                            <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>WORST DD</div>
                            <div style={{ fontSize: 18, fontWeight: 700, color: '#EF4444' }}>
                              {worstDrawdown > 0 ? worstDrawdown.toFixed(1) : '0'}
                            </div>
                            <div style={{ fontSize: 10, color: '#666' }}>max risk</div>
                          </div>
                        </div>

                        {/* Daily Results Table */}
                        <div className="hide-scrollbar" style={{ overflowX: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                            <thead>
                              <tr style={{ background: 'rgba(0,0,0,0.3)' }}>
                                <th style={{ padding: '8px 12px', textAlign: 'left', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Date</th>
                                <th style={{ padding: '8px 12px', textAlign: 'right', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Entry</th>
                                <th style={{ padding: '8px 12px', textAlign: 'right', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Target</th>
                                {subsequentSessions.map(sess => (
                                  <th key={sess.id} style={{ padding: '8px 12px', textAlign: 'center', color: sess.color, fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)', minWidth: 60 }}>
                                    {sess.name.split(' ')[0]}
                                  </th>
                                ))}
                                <th style={{ padding: '8px 12px', textAlign: 'center', color: '#F59E0B', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Max DD</th>
                                <th style={{ padding: '8px 12px', textAlign: 'center', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Result</th>
                              </tr>
                            </thead>
                            <tbody>
                              {results.map((day, idx) => (
                                <tr key={day.date} style={{ background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)' }}>
                                  <td style={{ padding: '8px 12px', color: '#fff', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                    {day.label || day.date}
                                  </td>
                                  <td style={{ padding: '8px 12px', textAlign: 'right', color: '#888', fontFamily: 'monospace', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                    {day.entryPrice.toFixed(2)}
                                  </td>
                                  <td style={{ padding: '8px 12px', textAlign: 'right', color: calcDirection === 'long' ? '#00ff88' : '#ff4466', fontFamily: 'monospace', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                    {day.targetPrice.toFixed(2)}
                                  </td>
                                  {day.sessionResults.map(sr => (
                                    <td key={sr.session.id} style={{
                                      padding: '6px 8px',
                                      textAlign: 'center',
                                      borderBottom: '1px solid rgba(255,255,255,0.05)',
                                      background: sr.hit && day.firstHit?.session.id === sr.session.id ? 'rgba(0, 255, 136, 0.1)' : 'transparent',
                                      verticalAlign: 'middle'
                                    }}>
                                      {sr.noData ? (
                                        <span style={{ color: '#444' }}>‚Äî</span>
                                      ) : (
                                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2 }}>
                                          {sr.hit ? (
                                            <span style={{ color: '#00ff88', fontWeight: 700 }}>
                                              ‚úì
                                              {sr.overshoot > 0 && <span style={{ fontSize: 9, marginLeft: 2 }}>+{sr.overshoot.toFixed(1)}</span>}
                                            </span>
                                          ) : (
                                            <span style={{ color: '#ff4466', opacity: 0.5 }}>‚úó</span>
                                          )}
                                          {sr.drawdownAtSession > 0 && (
                                            <span style={{ fontSize: 8, color: '#F59E0B', opacity: 0.8 }}>
                                              DD: {sr.drawdownAtSession.toFixed(1)}
                                            </span>
                                          )}
                                        </div>
                                      )}
                                    </td>
                                  ))}
                                  <td style={{ padding: '8px 12px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)', fontFamily: 'monospace' }}>
                                    <span style={{
                                      color: day.maxDrawdown > calcTargetPoints ? '#EF4444' : day.maxDrawdown > calcTargetPoints * 0.5 ? '#F59E0B' : '#888',
                                      fontWeight: day.maxDrawdown > calcTargetPoints ? 700 : 400
                                    }}>
                                      {day.maxDrawdown > 0 ? day.maxDrawdown.toFixed(1) : '0'}
                                    </span>
                                  </td>
                                  <td style={{ padding: '8px 12px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                    {day.hitAny ? (
                                      <span style={{ color: '#00ff88', fontWeight: 600, fontSize: 10 }}>
                                        {day.firstHit.session.name}
                                      </span>
                                    ) : (
                                      <span style={{ color: '#ff4466', fontSize: 10 }}>NO HIT</span>
                                    )}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>

                        {/* Footer note */}
                        <div style={{ marginTop: 12, padding: '8px 12px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: 6, fontSize: 10, color: '#888' }}>
                          üí° Analysis based on {results.length} trading days ‚Ä¢ Entry at {sessions.find(s => s.id === calcEntrySession)?.name} session open price ‚Ä¢ Target: {calcDirection === 'long' ? '+' : '-'}{calcTargetPoints} points
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}
            </div>

            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                SESSION ANALYTICS PANELS - Trend, Range (shown in calculator context)
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
            {historicalData && historicalData.length > 0 && (() => {
              // Calculate analytics from historical data
              const horizonSessions = allSessions.filter(s => s.horizon);

              // Data quality check - get price range for sanity check
              let minPrice = Infinity, maxPrice = 0;
              historicalData.forEach(day => {
                horizonSessions.forEach(sess => {
                  const d = day.sessions?.[sess.id];
                  if (d?.h > 0) maxPrice = Math.max(maxPrice, d.h);
                  if (d?.l > 0 && d?.l < Infinity) minPrice = Math.min(minPrice, d.l);
                });
              });
              const priceRange = { min: minPrice === Infinity ? 0 : minPrice, max: maxPrice };
              const expectedRanges = {
                'ES': [5500, 7000],
                'GC': [4500, 6000],  // Gold ~$5000+ in 2026
                'NQ': [18000, 25000],
                'CL': [60, 120],
                'BTC': [80000, 150000],
                'BT': [80000, 150000]  // BTC-SPOT prefix
              };
              const contractPrefix = selectedContract?.substring(0, 2) || '';
              const expected = expectedRanges[contractPrefix];
              const dataLooksWrong = expected && (priceRange.max < expected[0] || priceRange.min > expected[1]);

              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              // 1. SESSION TREND DIRECTION - Bullish/Bearish per session per day
              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              const trendData = horizonSessions.map(sess => {
                const dailyTrends = historicalData.map(day => {
                  const sessData = day.sessions?.[sess.id];
                  if (!sessData || !sessData.o || !sessData.c || sessData.o <= 0) return null;
                  return sessData.c >= sessData.o ? 'bullish' : 'bearish';
                }).filter(Boolean);

                const bullishCount = dailyTrends.filter(t => t === 'bullish').length;
                const bearishCount = dailyTrends.filter(t => t === 'bearish').length;
                const total = dailyTrends.length;

                return {
                  session: sess,
                  trends: historicalData.map(day => {
                    const sessData = day.sessions?.[sess.id];
                    if (!sessData || !sessData.o || !sessData.c || sessData.o <= 0) return null;
                    return sessData.c >= sessData.o ? 'bullish' : 'bearish';
                  }),
                  bullishPct: total > 0 ? Math.round((bullishCount / total) * 100) : 0,
                  bullishCount,
                  bearishCount,
                  total
                };
              });

              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              // 2. RANGE ANALYSIS - Per session range statistics
              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              const rangeData = horizonSessions.map(sess => {
                const ranges = historicalData.map(day => {
                  const sessData = day.sessions?.[sess.id];
                  if (!sessData || !sessData.h || !sessData.l || sessData.h <= 0) return null;
                  return sessData.h - sessData.l;
                }).filter(r => r !== null && r > 0);

                const avgRange = ranges.length > 0 ? ranges.reduce((a, b) => a + b, 0) / ranges.length : 0;
                const minRange = ranges.length > 0 ? Math.min(...ranges) : 0;
                const maxRange = ranges.length > 0 ? Math.max(...ranges) : 0;

                return {
                  session: sess,
                  avgRange,
                  minRange,
                  maxRange,
                  rangeCount: ranges.length
                };
              });

              // Calculate daily total ranges for comparison
              const dailyRanges = historicalData.map(day => {
                let dayHigh = 0, dayLow = Infinity;
                horizonSessions.forEach(sess => {
                  const sessData = day.sessions?.[sess.id];
                  if (sessData && sessData.h > 0 && sessData.l > 0) {
                    dayHigh = Math.max(dayHigh, sessData.h);
                    dayLow = Math.min(dayLow, sessData.l);
                  }
                });
                return dayLow < Infinity ? dayHigh - dayLow : 0;
              }).filter(r => r > 0);
              const avgDailyRange = dailyRanges.length > 0 ? dailyRanges.reduce((a, b) => a + b, 0) / dailyRanges.length : 0;

              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              // 3. OPTIMAL ENTRY FINDER - Best session for capturing points with min DD
              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              // Dynamic point targets based on contract (BTC has much larger ranges)
              const isBTC = selectedContract?.includes('BTC');
              const targetPoints = isBTC ? [250, 500, 750, 1000, 1250] : [5, 10, 15, 20, 25];
              const optimalEntryData = horizonSessions.slice(0, -1).map(entrySess => { // Exclude last session
                const results = targetPoints.map(target => {
                  let wins = 0, totalDD = 0, maxDD = 0, validDays = 0;

                  historicalData.forEach(day => {
                    const entryData = day.sessions?.[entrySess.id];
                    if (!entryData || !entryData.o || entryData.o <= 0) return;

                    const entryPrice = entryData.o;
                    const targetPrice = entryPrice + target; // Long only for simplicity
                    let hit = false, drawdown = 0;

                    // Check subsequent sessions
                    const entryIdx = horizonSessions.findIndex(s => s.id === entrySess.id);
                    horizonSessions.slice(entryIdx + 1).forEach(checkSess => {
                      const checkData = day.sessions?.[checkSess.id];
                      if (!checkData || !checkData.h || checkData.h <= 0) return;

                      if (!hit) {
                        drawdown = Math.max(drawdown, entryPrice - checkData.l);
                        if (checkData.h >= targetPrice) hit = true;
                      }
                    });

                    if (hit) wins++;
                    totalDD += drawdown;
                    maxDD = Math.max(maxDD, drawdown);
                    validDays++;
                  });

                  return {
                    target,
                    winRate: validDays > 0 ? Math.round((wins / validDays) * 100) : 0,
                    avgDD: validDays > 0 ? totalDD / validDays : 0,
                    maxDD,
                    validDays,
                    riskReward: validDays > 0 && totalDD > 0 ? (target / (totalDD / validDays)).toFixed(1) : '‚Äî'
                  };
                });

                return { session: entrySess, results };
              });

              // Find best entry for middle target (10pt for GC, 500pt for BTC)
              const midTarget = targetPoints[1]; // Second target point
              const bestFor10 = optimalEntryData.reduce((best, curr) => {
                const curr10 = curr.results.find(r => r.target === midTarget);
                const best10 = best?.results?.find(r => r.target === midTarget);
                if (!best10 || (curr10.winRate > best10.winRate) ||
                    (curr10.winRate === best10.winRate && curr10.avgDD < best10.avgDD)) {
                  return curr;
                }
                return best;
              }, null);

              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              // 4. SESSION PATTERNS - Relationship detection
              // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
              const patterns = [];

              // Pattern: China breaks Japan range
              let chinaBreaksJapan = 0, chinaBreaksJapanTotal = 0;
              historicalData.forEach(day => {
                const japan = day.sessions?.japan_ib;
                const china = day.sessions?.china;
                if (japan?.h > 0 && japan?.l > 0 && china?.h > 0 && china?.l > 0) {
                  chinaBreaksJapanTotal++;
                  if (china.h > japan.h || china.l < japan.l) chinaBreaksJapan++;
                }
              });
              if (chinaBreaksJapanTotal > 0) {
                patterns.push({
                  name: 'China breaks Japan range',
                  occurrences: chinaBreaksJapan,
                  total: chinaBreaksJapanTotal,
                  pct: Math.round((chinaBreaksJapan / chinaBreaksJapanTotal) * 100),
                  color: '#F472B6'
                });
              }

              // Pattern: London takes out China H/L
              let londonBreaksChina = 0, londonBreaksChinaTotal = 0;
              historicalData.forEach(day => {
                const china = day.sessions?.china;
                const london = day.sessions?.london;
                if (china?.h > 0 && china?.l > 0 && london?.h > 0 && london?.l > 0) {
                  londonBreaksChinaTotal++;
                  if (london.h > china.h || london.l < china.l) londonBreaksChina++;
                }
              });
              if (londonBreaksChinaTotal > 0) {
                patterns.push({
                  name: 'London breaks China range',
                  occurrences: londonBreaksChina,
                  total: londonBreaksChinaTotal,
                  pct: Math.round((londonBreaksChina / londonBreaksChinaTotal) * 100),
                  color: '#3B82F6'
                });
              }

              // Pattern: NY continues London direction
              let nyContinuesLondon = 0, nyContinuesLondonTotal = 0;
              historicalData.forEach(day => {
                const london = day.sessions?.london;
                const ny1h = day.sessions?.ny_1h;
                if (london?.o > 0 && london?.c > 0 && ny1h?.o > 0 && ny1h?.c > 0) {
                  nyContinuesLondonTotal++;
                  const londonBullish = london.c > london.o;
                  const nyBullish = ny1h.c > ny1h.o;
                  if (londonBullish === nyBullish) nyContinuesLondon++;
                }
              });
              if (nyContinuesLondonTotal > 0) {
                patterns.push({
                  name: 'NY 1H continues London trend',
                  occurrences: nyContinuesLondon,
                  total: nyContinuesLondonTotal,
                  pct: Math.round((nyContinuesLondon / nyContinuesLondonTotal) * 100),
                  color: '#10B981'
                });
              }

              // Pattern: US IB sets direction for NY
              let usIbSetsDirection = 0, usIbSetsDirectionTotal = 0;
              historicalData.forEach(day => {
                const usIb = day.sessions?.us_ib;
                const nyPm = day.sessions?.ny_pm;
                if (usIb?.o > 0 && usIb?.c > 0 && nyPm?.o > 0 && nyPm?.c > 0) {
                  usIbSetsDirectionTotal++;
                  const ibBullish = usIb.c > usIb.o;
                  const pmBullish = nyPm.c > nyPm.o;
                  if (ibBullish === pmBullish) usIbSetsDirection++;
                }
              });
              if (usIbSetsDirectionTotal > 0) {
                patterns.push({
                  name: 'US IB direction = NY PM direction',
                  occurrences: usIbSetsDirection,
                  total: usIbSetsDirectionTotal,
                  pct: Math.round((usIbSetsDirection / usIbSetsDirectionTotal) * 100),
                  color: '#F59E0B'
                });
              }

              // Pattern: Which session sets HOD/LOD most often
              const hodLodStats = {};
              horizonSessions.forEach(s => hodLodStats[s.id] = { hod: 0, lod: 0 });
              historicalData.forEach(day => {
                let dayHigh = 0, dayLow = Infinity, hodSession = null, lodSession = null;
                horizonSessions.forEach(sess => {
                  const sessData = day.sessions?.[sess.id];
                  if (sessData && sessData.h > 0 && sessData.l > 0) {
                    if (sessData.h > dayHigh) { dayHigh = sessData.h; hodSession = sess.id; }
                    if (sessData.l < dayLow) { dayLow = sessData.l; lodSession = sess.id; }
                  }
                });
                if (hodSession) hodLodStats[hodSession].hod++;
                if (lodSession) hodLodStats[lodSession].lod++;
              });

              // If data is wrong, show error and don't render analytics
              if (dataLooksWrong) {
                return (
                  <div style={{ marginTop: 20 }}>
                    <div style={{
                      padding: '20px',
                      background: 'rgba(239, 68, 68, 0.1)',
                      border: '1px solid rgba(239, 68, 68, 0.3)',
                      borderRadius: 12,
                      textAlign: 'center'
                    }}>
                      <div style={{ fontSize: 32, marginBottom: 12 }}>‚ö†Ô∏è</div>
                      <div style={{ fontSize: 14, fontWeight: 600, color: '#EF4444', marginBottom: 8 }}>
                        DATA MISMATCH - Wrong Contract Data
                      </div>
                      <div style={{ fontSize: 12, color: '#888', marginBottom: 12 }}>
                        Received prices: <span style={{ color: '#fff', fontFamily: 'monospace' }}>${priceRange.min.toFixed(0)} - ${priceRange.max.toFixed(0)}</span>
                        <br />
                        Expected for {contractPrefix}: <span style={{ color: '#10B981', fontFamily: 'monospace' }}>${expected?.[0]} - ${expected?.[1]}</span>
                      </div>
                      <div style={{ fontSize: 11, color: '#666', marginBottom: 16 }}>
                        The backend is returning cached data for a different contract.
                        <br />
                        This requires clearing the backend cache or redeploying.
                      </div>
                      <div style={{ display: 'flex', gap: 12, justifyContent: 'center' }}>
                        <button
                          onClick={clearCacheAndRefresh}
                          style={{
                            padding: '8px 16px',
                            background: 'rgba(239, 68, 68, 0.2)',
                            border: '1px solid rgba(239, 68, 68, 0.4)',
                            borderRadius: 6,
                            color: '#EF4444',
                            fontSize: 11,
                            fontWeight: 600,
                            cursor: 'pointer'
                          }}
                        >
                          üîÑ Try Refresh Again
                        </button>
                      </div>
                    </div>
                  </div>
                );
              }

              return (
                <div style={{ marginTop: 20 }}>
                  {/* Data Quality Banner */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '8px 12px',
                    marginBottom: 12,
                    background: 'rgba(16, 185, 129, 0.1)',
                    border: '1px solid rgba(16, 185, 129, 0.2)',
                    borderRadius: 8,
                    fontSize: 10
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                      <span style={{ color: '#10B981' }}>‚úì DATA OK</span>
                      <span style={{ color: '#888' }}>|</span>
                      <span style={{ color: '#888' }}>Price Range:</span>
                      <span style={{ color: '#fff', fontFamily: 'monospace' }}>
                        ${priceRange.min.toFixed(2)} - ${priceRange.max.toFixed(2)}
                      </span>
                      {expected && (
                        <>
                          <span style={{ color: '#888' }}>|</span>
                          <span style={{ color: '#666' }}>Expected {contractPrefix}:</span>
                          <span style={{ color: '#666', fontFamily: 'monospace' }}>
                            ${expected[0]} - ${expected[1]}
                          </span>
                        </>
                      )}
                    </div>
                  </div>

                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))',
                    gap: 16
                  }}>
                  {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                      PANEL 1: SESSION TREND DIRECTION
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                  <div style={{
                    background: 'rgba(0,0,0,0.4)',
                    borderRadius: 12,
                    border: '1px solid rgba(255,255,255,0.08)',
                    padding: 16,
                    overflow: 'hidden'
                  }}>
                    <div style={{
                      fontSize: 12,
                      fontWeight: 700,
                      color: '#A78BFA',
                      marginBottom: 12,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 8
                    }}>
                      <span style={{ fontSize: 16 }}>üìä</span>
                      SESSION TREND DIRECTION
                    </div>

                    <div className="hide-scrollbar" style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                        <thead>
                          <tr>
                            <th style={{ padding: '6px 8px', textAlign: 'left', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Session</th>
                            {historicalData.map((day, idx) => (
                              <th key={idx} style={{ padding: '6px 4px', textAlign: 'center', color: '#666', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 9 }}>
                                {day.label?.split(' ')[0] || `Day ${idx + 1}`}
                              </th>
                            ))}
                            <th style={{ padding: '6px 8px', textAlign: 'center', color: '#00ff88', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Bullish</th>
                          </tr>
                        </thead>
                        <tbody>
                          {trendData.map((row, idx) => (
                            <tr key={row.session.id} style={{ background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)' }}>
                              <td style={{ padding: '6px 8px', color: row.session.color, fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.05)', whiteSpace: 'nowrap' }}>
                                {row.session.name}
                              </td>
                              {row.trends.map((trend, tIdx) => (
                                <td key={tIdx} style={{ padding: '4px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                  {trend === 'bullish' ? (
                                    <span style={{ color: '#00ff88', fontSize: 14 }}>‚ñ≤</span>
                                  ) : trend === 'bearish' ? (
                                    <span style={{ color: '#ff4466', fontSize: 14 }}>‚ñº</span>
                                  ) : (
                                    <span style={{ color: '#333' }}>‚Äî</span>
                                  )}
                                </td>
                              ))}
                              <td style={{
                                padding: '6px 8px',
                                textAlign: 'center',
                                borderBottom: '1px solid rgba(255,255,255,0.05)',
                                fontWeight: 700,
                                color: row.bullishPct >= 70 ? '#00ff88' : row.bullishPct >= 50 ? '#F59E0B' : '#ff4466'
                              }}>
                                {row.bullishPct}%
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>

                    {/* Key Insight */}
                    {(() => {
                      const mostBullish = trendData.reduce((a, b) => a.bullishPct > b.bullishPct ? a : b);
                      const mostBearish = trendData.reduce((a, b) => a.bullishPct < b.bullishPct ? a : b);
                      return (
                        <div style={{ marginTop: 12, padding: '8px 10px', background: 'rgba(139, 92, 246, 0.1)', borderRadius: 6, fontSize: 10, color: '#888' }}>
                          <span style={{ color: '#00ff88', fontWeight: 600 }}>{mostBullish.session.name}</span> most bullish ({mostBullish.bullishPct}%) ‚Ä¢
                          <span style={{ color: '#ff4466', fontWeight: 600, marginLeft: 4 }}>{mostBearish.session.name}</span> most bearish ({100 - mostBearish.bullishPct}%)
                        </div>
                      );
                    })()}
                  </div>

                  {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                      PANEL 2: RANGE ANALYSIS
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
                  <div style={{
                    background: 'rgba(0,0,0,0.4)',
                    borderRadius: 12,
                    border: '1px solid rgba(255,255,255,0.08)',
                    padding: 16
                  }}>
                    <div style={{
                      fontSize: 12,
                      fontWeight: 700,
                      color: '#EC4899',
                      marginBottom: 12,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 8
                    }}>
                      <span style={{ fontSize: 16 }}>üìè</span>
                      RANGE ANALYSIS
                      <span style={{ marginLeft: 'auto', fontSize: 9, color: '#666', fontWeight: 400 }}>
                        Avg Daily: <span style={{ color: '#EC4899' }}>{avgDailyRange.toFixed(1)} pts</span>
                      </span>
                    </div>

                    <div className="hide-scrollbar" style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                        <thead>
                          <tr>
                            <th style={{ padding: '6px 8px', textAlign: 'left', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Session</th>
                            <th style={{ padding: '6px 8px', textAlign: 'right', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Avg</th>
                            <th style={{ padding: '6px 8px', textAlign: 'right', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Min</th>
                            <th style={{ padding: '6px 8px', textAlign: 'right', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Max</th>
                            <th style={{ padding: '6px 8px', textAlign: 'right', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>% Daily</th>
                          </tr>
                        </thead>
                        <tbody>
                          {rangeData.filter(r => r.avgRange > 0).sort((a, b) => b.avgRange - a.avgRange).map((row, idx) => (
                            <tr key={row.session.id} style={{ background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)' }}>
                              <td style={{ padding: '6px 8px', color: row.session.color, fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                {row.session.name}
                              </td>
                              <td style={{ padding: '6px 8px', textAlign: 'right', color: '#fff', fontFamily: 'monospace', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                {row.avgRange.toFixed(1)}
                              </td>
                              <td style={{ padding: '6px 8px', textAlign: 'right', color: '#666', fontFamily: 'monospace', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                {row.minRange.toFixed(1)}
                              </td>
                              <td style={{ padding: '6px 8px', textAlign: 'right', color: '#888', fontFamily: 'monospace', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                {row.maxRange.toFixed(1)}
                              </td>
                              <td style={{ padding: '6px 8px', textAlign: 'right', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                <span style={{
                                  background: `rgba(236, 72, 153, ${Math.min(0.8, (row.avgRange / avgDailyRange) * 0.6)})`,
                                  padding: '2px 6px',
                                  borderRadius: 4,
                                  fontSize: 10,
                                  fontWeight: 600,
                                  color: '#fff'
                                }}>
                                  {avgDailyRange > 0 ? Math.round((row.avgRange / avgDailyRange) * 100) : 0}%
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>

                    {/* Range insight */}
                    {(() => {
                      const largest = rangeData.reduce((a, b) => a.avgRange > b.avgRange ? a : b);
                      return (
                        <div style={{ marginTop: 12, padding: '8px 10px', background: 'rgba(236, 72, 153, 0.1)', borderRadius: 6, fontSize: 10, color: '#888' }}>
                          <span style={{ color: largest.session.color, fontWeight: 600 }}>{largest.session.name}</span> has largest avg range ({largest.avgRange.toFixed(1)} pts) ‚Äî
                          <span style={{ color: '#EC4899' }}> {Math.round((largest.avgRange / avgDailyRange) * 100)}%</span> of daily range
                        </div>
                      );
                    })()}
                  </div>
                  </div>
                </div>
              );
            })()}

            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                DAY BIAS ANALYSIS - Overnight Range & 8:20 Open Position
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
            {historicalData && historicalData.length > 0 && (() => {
              // Calculate day bias for each day
              const overnightSessions = ['japan_ib', 'china', 'asia_close', 'deadzone', 'london', 'low_volume'];
              const horizonSessions = allSessions.filter(s => s.horizon);

              const dayBiasData = historicalData.map(day => {
                if (!day.sessions) return null;

                // Calculate overnight range (18:00 - 08:20)
                let overnightHigh = 0, overnightLow = Infinity;
                let overnightVolume = 0, overnightTP = 0; // For VWAP estimation

                overnightSessions.forEach(sessId => {
                  const sess = day.sessions[sessId];
                  if (sess && sess.h > 0 && sess.l > 0) {
                    overnightHigh = Math.max(overnightHigh, sess.h);
                    overnightLow = Math.min(overnightLow, sess.l);
                    // Estimate typical price for VWAP proxy
                    const tp = (sess.h + sess.l + sess.c) / 3;
                    const vol = sess.v || 1;
                    overnightTP += tp * vol;
                    overnightVolume += vol;
                  }
                });

                // Get 8:20 open (US IB open)
                const usIb = day.sessions.us_ib;
                const usIbOpen = usIb?.o || 0;

                if (overnightHigh === 0 || overnightLow === Infinity || usIbOpen === 0) return null;

                const overnightRange = overnightHigh - overnightLow;

                // Calculate % from overnight high
                const pctFromHigh = overnightRange > 0
                  ? ((overnightHigh - usIbOpen) / overnightRange * 100).toFixed(1)
                  : 0;

                // Estimate VWAP (volume-weighted typical price of overnight)
                const estimatedVwap = overnightVolume > 0
                  ? overnightTP / overnightVolume
                  : (overnightHigh + overnightLow) / 2;

                const vwapDistance = (usIbOpen - estimatedVwap).toFixed(1);
                const aboveVwap = usIbOpen >= estimatedVwap;

                // Determine overnight bias (A)
                let biasA = 'NEUTRAL';
                const pctNum = parseFloat(pctFromHigh);
                if (pctNum <= 20) biasA = 'VERY BULLISH';
                else if (pctNum <= 40) biasA = 'BULLISH';
                else if (pctNum >= 80) biasA = 'VERY BEARISH';
                else if (pctNum >= 60) biasA = 'BEARISH';

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // B. NY Open (9:30) position relative to US IB range (8:20-9:30)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const ibHigh = usIb?.h || 0;
                const ibLow = usIb?.l || 0;
                const ibRange = ibHigh - ibLow;

                // Get NY 1H open (9:30 open)
                const ny1h = day.sessions.ny_1h;
                const nyOpen = ny1h?.o || 0;

                // Calculate % from IB high
                const pctFromIbHigh = ibRange > 0 && nyOpen > 0
                  ? ((ibHigh - nyOpen) / ibRange * 100).toFixed(1)
                  : '‚Äî';

                // Determine IB bias (B)
                let biasB = 'NEUTRAL';
                const pctIbNum = parseFloat(pctFromIbHigh);
                if (!isNaN(pctIbNum)) {
                  if (pctIbNum <= 20) biasB = 'VERY BULLISH';
                  else if (pctIbNum <= 40) biasB = 'BULLISH';
                  else if (pctIbNum >= 80) biasB = 'VERY BEARISH';
                  else if (pctIbNum >= 60) biasB = 'BEARISH';
                }

                // Combined bias (average of A and B)
                const getBiasScore = (b) => {
                  if (b === 'VERY BULLISH') return 2;
                  if (b === 'BULLISH') return 1;
                  if (b === 'BEARISH') return -1;
                  if (b === 'VERY BEARISH') return -2;
                  return 0;
                };
                const combinedScore = (getBiasScore(biasA) + getBiasScore(biasB)) / 2;
                let combinedBias = 'NEUTRAL';
                if (combinedScore >= 1.5) combinedBias = 'VERY BULLISH';
                else if (combinedScore >= 0.5) combinedBias = 'BULLISH';
                else if (combinedScore <= -1.5) combinedBias = 'VERY BEARISH';
                else if (combinedScore <= -0.5) combinedBias = 'BEARISH';

                return {
                  date: day.date,
                  label: day.label,
                  // A: Overnight analysis
                  overnightHigh,
                  overnightLow,
                  overnightRange,
                  usIbOpen,
                  pctFromHigh,
                  estimatedVwap,
                  vwapDistance: Math.abs(parseFloat(vwapDistance)),
                  aboveVwap,
                  biasA,
                  // B: IB analysis
                  ibHigh,
                  ibLow,
                  ibRange,
                  nyOpen,
                  pctFromIbHigh,
                  biasB,
                  // Combined
                  combinedBias
                };
              }).filter(Boolean);

              if (dayBiasData.length === 0) return null;

              // Get today's bias (most recent)
              const todayBias = dayBiasData[0];

              return (
                <div style={{
                  margin: '12px',
                  background: 'rgba(0,0,0,0.4)',
                  borderRadius: 12,
                  border: '1px solid rgba(16, 185, 129, 0.2)',
                  overflow: 'hidden'
                }}>
                  {/* Header */}
                  <div style={{
                    padding: '12px 16px',
                    background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%)',
                    borderBottom: '1px solid rgba(255,255,255,0.08)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                      <span style={{ fontSize: 16 }}>üéØ</span>
                      <span style={{ fontSize: 13, fontWeight: 600, color: '#10B981' }}>DAY BIAS</span>
                      <span style={{ fontSize: 10, color: '#666' }}>‚Ä¢ Overnight & IB Range Analysis</span>
                    </div>
                    {todayBias && (
                      <div style={{
                        padding: '4px 12px',
                        borderRadius: 6,
                        background: todayBias.combinedBias.includes('BULLISH') ? 'rgba(0, 255, 136, 0.15)' :
                                   todayBias.combinedBias.includes('BEARISH') ? 'rgba(255, 68, 102, 0.15)' : 'rgba(255,255,255,0.05)',
                        border: `1px solid ${todayBias.combinedBias.includes('BULLISH') ? 'rgba(0, 255, 136, 0.3)' :
                                            todayBias.combinedBias.includes('BEARISH') ? 'rgba(255, 68, 102, 0.3)' : 'rgba(255,255,255,0.1)'}`,
                        color: todayBias.combinedBias.includes('BULLISH') ? '#00ff88' :
                               todayBias.combinedBias.includes('BEARISH') ? '#ff4466' : '#888',
                        fontSize: 11,
                        fontWeight: 700
                      }}>
                        {todayBias.combinedBias}
                      </div>
                    )}
                  </div>

                  {/* Content */}
                  <div style={{ padding: 16 }}>
                    {/* Two Analysis Sections */}
                    {todayBias && (
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', gap: 16, marginBottom: 16 }}>
                        {/* A: Overnight Analysis */}
                        <div style={{ background: 'rgba(59, 130, 246, 0.05)', borderRadius: 10, padding: 14, border: '1px solid rgba(59, 130, 246, 0.2)' }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
                            <div style={{ fontSize: 11, fontWeight: 600, color: '#3B82F6' }}>A. OVERNIGHT ‚Üí 8:20 OPEN</div>
                            <span style={{
                              padding: '2px 8px', borderRadius: 4, fontSize: 9, fontWeight: 600,
                              background: todayBias.biasA.includes('BULLISH') ? 'rgba(0, 255, 136, 0.2)' : todayBias.biasA.includes('BEARISH') ? 'rgba(255, 68, 102, 0.2)' : 'rgba(255,255,255,0.1)',
                              color: todayBias.biasA.includes('BULLISH') ? '#00ff88' : todayBias.biasA.includes('BEARISH') ? '#ff4466' : '#888'
                            }}>{todayBias.biasA}</span>
                          </div>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 10 }}>
                            <div>
                              <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>O/N RANGE</div>
                              <div style={{ fontSize: 14, fontWeight: 600, color: '#3B82F6' }}>{todayBias.overnightRange.toFixed(1)}</div>
                              <div style={{ fontSize: 8, color: '#555' }}>H: {todayBias.overnightHigh.toFixed(0)} L: {todayBias.overnightLow.toFixed(0)}</div>
                            </div>
                            <div>
                              <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>8:20 OPEN</div>
                              <div style={{ fontSize: 14, fontWeight: 600, color: parseFloat(todayBias.pctFromHigh) <= 50 ? '#00ff88' : '#ff4466' }}>
                                {todayBias.pctFromHigh}%
                              </div>
                              <div style={{ fontSize: 8, color: '#555' }}>from O/N high</div>
                            </div>
                            <div>
                              <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>PRICE vs VWAP</div>
                              <div style={{
                                fontSize: 12,
                                fontWeight: 700,
                                color: todayBias.aboveVwap ? '#00ff88' : '#ff4466',
                                padding: '4px 8px',
                                borderRadius: 4,
                                background: todayBias.aboveVwap ? 'rgba(0, 255, 136, 0.15)' : 'rgba(255, 68, 102, 0.15)'
                              }}>
                                {todayBias.aboveVwap ? 'ABOVE' : 'BELOW'}
                              </div>
                              <div style={{ fontSize: 8, color: '#555', marginTop: 2 }}>{todayBias.vwapDistance.toFixed(1)} pts</div>
                            </div>
                          </div>
                        </div>

                        {/* B: IB Analysis */}
                        <div style={{ background: 'rgba(245, 158, 11, 0.05)', borderRadius: 10, padding: 14, border: '1px solid rgba(245, 158, 11, 0.2)' }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
                            <div style={{ fontSize: 11, fontWeight: 600, color: '#F59E0B' }}>B. US IB ‚Üí 9:30 OPEN</div>
                            <span style={{
                              padding: '2px 8px', borderRadius: 4, fontSize: 9, fontWeight: 600,
                              background: todayBias.biasB.includes('BULLISH') ? 'rgba(0, 255, 136, 0.2)' : todayBias.biasB.includes('BEARISH') ? 'rgba(255, 68, 102, 0.2)' : 'rgba(255,255,255,0.1)',
                              color: todayBias.biasB.includes('BULLISH') ? '#00ff88' : todayBias.biasB.includes('BEARISH') ? '#ff4466' : '#888'
                            }}>{todayBias.biasB}</span>
                          </div>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 10 }}>
                            <div>
                              <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>IB RANGE</div>
                              <div style={{ fontSize: 14, fontWeight: 600, color: '#F59E0B' }}>{todayBias.ibRange.toFixed(1)}</div>
                              <div style={{ fontSize: 8, color: '#555' }}>H: {todayBias.ibHigh.toFixed(0)} L: {todayBias.ibLow.toFixed(0)}</div>
                            </div>
                            <div>
                              <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>9:30 OPEN</div>
                              <div style={{ fontSize: 14, fontWeight: 600, color: parseFloat(todayBias.pctFromIbHigh) <= 50 ? '#00ff88' : '#ff4466' }}>
                                {todayBias.pctFromIbHigh}%
                              </div>
                              <div style={{ fontSize: 8, color: '#555' }}>from IB high</div>
                            </div>
                            <div>
                              <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>NY OPEN</div>
                              <div style={{ fontSize: 14, fontWeight: 600, color: '#fff' }}>
                                {todayBias.nyOpen > 0 ? todayBias.nyOpen.toFixed(2) : '‚Äî'}
                              </div>
                              <div style={{ fontSize: 8, color: '#555' }}>9:30 ET</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Historical Table - A & B Analysis */}
                    <div className="hide-scrollbar" style={{ overflowX: 'auto' }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 10 }}>
                        <thead>
                          {/* Header Row 1 - Group Headers */}
                          <tr style={{ background: 'rgba(0,0,0,0.4)' }}>
                            <th rowSpan={2} style={{ padding: '6px 10px', textAlign: 'left', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)' }}>Date</th>
                            <th colSpan={3} style={{ padding: '6px 10px', textAlign: 'center', color: '#3B82F6', fontWeight: 600, borderBottom: '1px solid rgba(59,130,246,0.3)', borderRight: '1px solid rgba(255,255,255,0.1)', background: 'rgba(59,130,246,0.08)' }}>A: Overnight ‚Üí 8:20</th>
                            <th colSpan={3} style={{ padding: '6px 10px', textAlign: 'center', color: '#F59E0B', fontWeight: 600, borderBottom: '1px solid rgba(245,158,11,0.3)', borderRight: '1px solid rgba(255,255,255,0.1)', background: 'rgba(245,158,11,0.08)' }}>B: US IB ‚Üí 9:30</th>
                            <th rowSpan={2} style={{ padding: '6px 10px', textAlign: 'center', color: '#10B981', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Combined</th>
                          </tr>
                          {/* Header Row 2 - Column Headers */}
                          <tr style={{ background: 'rgba(0,0,0,0.3)' }}>
                            <th style={{ padding: '6px 8px', textAlign: 'center', color: '#666', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 9 }}>% High</th>
                            <th style={{ padding: '6px 8px', textAlign: 'center', color: '#666', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 9 }}>VWAP</th>
                            <th style={{ padding: '6px 8px', textAlign: 'center', color: '#666', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)', fontSize: 9 }}>Bias</th>
                            <th style={{ padding: '6px 8px', textAlign: 'center', color: '#666', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 9 }}>% High</th>
                            <th style={{ padding: '6px 8px', textAlign: 'center', color: '#666', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 9 }}>9:30</th>
                            <th style={{ padding: '6px 8px', textAlign: 'center', color: '#666', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.1)', borderRight: '1px solid rgba(255,255,255,0.1)', fontSize: 9 }}>Bias</th>
                          </tr>
                        </thead>
                        <tbody>
                          {dayBiasData.map((row, idx) => (
                            <tr key={row.date} style={{ background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)' }}>
                              {/* Date */}
                              <td style={{ padding: '6px 10px', color: '#fff', fontWeight: 500, borderBottom: '1px solid rgba(255,255,255,0.05)', borderRight: '1px solid rgba(255,255,255,0.05)', fontSize: 10 }}>
                                {row.label || row.date}
                              </td>
                              {/* A: % from O/N High */}
                              <td style={{ padding: '6px 8px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                <span style={{
                                  padding: '2px 6px',
                                  borderRadius: 4,
                                  background: parseFloat(row.pctFromHigh) <= 30 ? 'rgba(0, 255, 136, 0.2)' :
                                             parseFloat(row.pctFromHigh) >= 70 ? 'rgba(255, 68, 102, 0.2)' : 'rgba(255,255,255,0.05)',
                                  color: parseFloat(row.pctFromHigh) <= 30 ? '#00ff88' :
                                         parseFloat(row.pctFromHigh) >= 70 ? '#ff4466' : '#888',
                                  fontSize: 9,
                                  fontWeight: 600
                                }}>
                                  {row.pctFromHigh}%
                                </span>
                              </td>
                              {/* A: VWAP (price relative to VWAP) */}
                              <td style={{ padding: '6px 8px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                <span style={{
                                  color: row.aboveVwap ? '#00ff88' : '#ff4466',
                                  fontSize: 9,
                                  fontWeight: 500
                                }}>
                                  {row.aboveVwap ? 'ABOVE' : 'BELOW'}
                                </span>
                              </td>
                              {/* A: Bias */}
                              <td style={{ padding: '6px 8px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)', borderRight: '1px solid rgba(255,255,255,0.05)' }}>
                                <span style={{
                                  padding: '2px 6px',
                                  borderRadius: 4,
                                  fontSize: 8,
                                  fontWeight: 600,
                                  background: row.biasA.includes('BULLISH') ? 'rgba(0, 255, 136, 0.15)' :
                                             row.biasA.includes('BEARISH') ? 'rgba(255, 68, 102, 0.15)' : 'rgba(255,255,255,0.05)',
                                  color: row.biasA.includes('BULLISH') ? '#00ff88' :
                                         row.biasA.includes('BEARISH') ? '#ff4466' : '#666'
                                }}>
                                  {row.biasA.replace('VERY ', 'V.')}
                                </span>
                              </td>
                              {/* B: % from IB High */}
                              <td style={{ padding: '6px 8px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                <span style={{
                                  padding: '2px 6px',
                                  borderRadius: 4,
                                  background: parseFloat(row.pctFromIbHigh) <= 30 ? 'rgba(0, 255, 136, 0.2)' :
                                             parseFloat(row.pctFromIbHigh) >= 70 ? 'rgba(255, 68, 102, 0.2)' : 'rgba(255,255,255,0.05)',
                                  color: parseFloat(row.pctFromIbHigh) <= 30 ? '#00ff88' :
                                         parseFloat(row.pctFromIbHigh) >= 70 ? '#ff4466' : '#888',
                                  fontSize: 9,
                                  fontWeight: 600
                                }}>
                                  {row.pctFromIbHigh}%
                                </span>
                              </td>
                              {/* B: 9:30 Open */}
                              <td style={{ padding: '6px 8px', textAlign: 'center', color: '#888', fontFamily: 'monospace', borderBottom: '1px solid rgba(255,255,255,0.05)', fontSize: 9 }}>
                                {row.nyOpen > 0 ? row.nyOpen.toFixed(0) : '‚Äî'}
                              </td>
                              {/* B: Bias */}
                              <td style={{ padding: '6px 8px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)', borderRight: '1px solid rgba(255,255,255,0.05)' }}>
                                <span style={{
                                  padding: '2px 6px',
                                  borderRadius: 4,
                                  fontSize: 8,
                                  fontWeight: 600,
                                  background: row.biasB.includes('BULLISH') ? 'rgba(0, 255, 136, 0.15)' :
                                             row.biasB.includes('BEARISH') ? 'rgba(255, 68, 102, 0.15)' : 'rgba(255,255,255,0.05)',
                                  color: row.biasB.includes('BULLISH') ? '#00ff88' :
                                         row.biasB.includes('BEARISH') ? '#ff4466' : '#666'
                                }}>
                                  {row.biasB.replace('VERY ', 'V.')}
                                </span>
                              </td>
                              {/* Combined Bias */}
                              <td style={{ padding: '6px 8px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                <span style={{
                                  padding: '3px 8px',
                                  borderRadius: 4,
                                  fontSize: 9,
                                  fontWeight: 700,
                                  background: row.combinedBias.includes('BULLISH') ? 'rgba(0, 255, 136, 0.2)' :
                                             row.combinedBias.includes('BEARISH') ? 'rgba(255, 68, 102, 0.2)' : 'rgba(255,255,255,0.05)',
                                  color: row.combinedBias.includes('BULLISH') ? '#00ff88' :
                                         row.combinedBias.includes('BEARISH') ? '#ff4466' : '#888'
                                }}>
                                  {row.combinedBias.replace('VERY ', 'V.')}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>

                    {/* Calculation Note */}
                    <div style={{ marginTop: 12, padding: '8px 12px', background: 'rgba(16, 185, 129, 0.1)', borderRadius: 6, fontSize: 9, color: '#888' }}>
                      <strong style={{ color: '#10B981' }}>Bias Logic:</strong> 0-20% from high = Very Bullish ‚Ä¢ 20-40% = Bullish ‚Ä¢ 40-60% = Neutral ‚Ä¢ 60-80% = Bearish ‚Ä¢ 80-100% = Very Bearish
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                STRATEGY ANALYTICS - Optimal Entry Finder + Session Patterns
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
            {showStrategySection && (
              <div style={{
                marginTop: 24,
                background: 'rgba(0,0,0,0.4)',
                borderRadius: 16,
                border: '1px solid rgba(139, 92, 246, 0.2)',
                overflow: 'hidden'
              }}>
                {/* Strategy Section Header with Month/Week Selectors */}
                <div style={{
                  padding: '16px 20px',
                  background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%)',
                  borderBottom: '1px solid rgba(255,255,255,0.08)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  flexWrap: 'wrap',
                  gap: 12
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <span style={{ fontSize: 20 }}>üìà</span>
                    <div>
                      <div style={{ fontSize: 14, fontWeight: 700, color: '#A78BFA' }}>STRATEGY ANALYTICS</div>
                      <div style={{ fontSize: 10, color: '#888' }}>Optimal entry points & session patterns</div>
                    </div>
                  </div>

                  {/* Data Source Info */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 10, color: '#666' }}>
                      Using data from selected week above
                    </span>
                  </div>
                </div>

                {/* Strategy Analytics Content */}
                {(() => {
                  // Use historicalData from the week selector
                  const filteredData = historicalData;
                  if (!filteredData || filteredData.length === 0) {
                    return (
                      <div style={{ padding: 40, textAlign: 'center', color: '#888' }}>
                        <div style={{ fontSize: 24, marginBottom: 8 }}>üìä</div>
                        No historical data available. Select a week above first.
                      </div>
                    );
                  }

                  // Calculate analytics from filtered data
                  const horizonSessions = allSessions.filter(s => s.horizon);
                  // Dynamic point targets based on contract (BTC has much larger ranges)
                  const isBTC = selectedContract?.includes('BTC');
                  const targetPoints = isBTC ? [250, 500, 750, 1000, 1250] : [5, 10, 15, 20, 25];

                  // OPTIMAL ENTRY FINDER calculation
                  const optimalEntryData = horizonSessions.slice(0, -1).map(entrySess => {
                    const results = targetPoints.map(target => {
                      let wins = 0, totalDD = 0, maxDD = 0, validDays = 0;

                      filteredData.forEach(day => {
                        const entryData = day.sessions?.[entrySess.id];
                        if (!entryData || !entryData.o || entryData.o <= 0) return;

                        const entryPrice = entryData.o;
                        const targetPrice = entryPrice + target;
                        let hit = false, drawdown = 0;

                        const entryIdx = horizonSessions.findIndex(s => s.id === entrySess.id);
                        horizonSessions.slice(entryIdx + 1).forEach(checkSess => {
                          const checkData = day.sessions?.[checkSess.id];
                          if (!checkData || !checkData.h || checkData.h <= 0) return;

                          if (!hit) {
                            drawdown = Math.max(drawdown, entryPrice - checkData.l);
                            if (checkData.h >= targetPrice) hit = true;
                          }
                        });

                        if (hit) wins++;
                        totalDD += drawdown;
                        maxDD = Math.max(maxDD, drawdown);
                        validDays++;
                      });

                      return {
                        target,
                        winRate: validDays > 0 ? Math.round((wins / validDays) * 100) : 0,
                        avgDD: validDays > 0 ? totalDD / validDays : 0,
                        maxDD,
                        validDays,
                        riskReward: validDays > 0 && totalDD > 0 ? (target / (totalDD / validDays)).toFixed(1) : '‚Äî'
                      };
                    });

                    return { session: entrySess, results };
                  });

                  // Find best entry for middle target (10pt for GC, 500pt for BTC)
                  const midTarget = targetPoints[1];
                  const bestFor10 = optimalEntryData.reduce((best, curr) => {
                    const curr10 = curr.results.find(r => r.target === midTarget);
                    const best10 = best?.results?.find(r => r.target === midTarget);
                    if (!best10 || (curr10.winRate > best10.winRate) ||
                        (curr10.winRate === best10.winRate && curr10.avgDD < best10.avgDD)) {
                      return curr;
                    }
                    return best;
                  }, null);

                  // SESSION PATTERNS calculation
                  const patterns = [];

                  // China breaks Japan
                  let chinaBreaksJapan = 0, chinaBreaksJapanTotal = 0;
                  filteredData.forEach(day => {
                    const japan = day.sessions?.japan_ib;
                    const china = day.sessions?.china;
                    if (japan?.h > 0 && japan?.l > 0 && china?.h > 0 && china?.l > 0) {
                      chinaBreaksJapanTotal++;
                      if (china.h > japan.h || china.l < japan.l) chinaBreaksJapan++;
                    }
                  });
                  if (chinaBreaksJapanTotal > 0) {
                    patterns.push({ name: 'China breaks Japan range', occurrences: chinaBreaksJapan, total: chinaBreaksJapanTotal, pct: Math.round((chinaBreaksJapan / chinaBreaksJapanTotal) * 100), color: '#F472B6' });
                  }

                  // London breaks China
                  let londonBreaksChina = 0, londonBreaksChinaTotal = 0;
                  filteredData.forEach(day => {
                    const china = day.sessions?.china;
                    const london = day.sessions?.london;
                    if (china?.h > 0 && china?.l > 0 && london?.h > 0 && london?.l > 0) {
                      londonBreaksChinaTotal++;
                      if (london.h > china.h || london.l < china.l) londonBreaksChina++;
                    }
                  });
                  if (londonBreaksChinaTotal > 0) {
                    patterns.push({ name: 'London breaks China range', occurrences: londonBreaksChina, total: londonBreaksChinaTotal, pct: Math.round((londonBreaksChina / londonBreaksChinaTotal) * 100), color: '#3B82F6' });
                  }

                  // NY continues London
                  let nyContinuesLondon = 0, nyContinuesLondonTotal = 0;
                  filteredData.forEach(day => {
                    const london = day.sessions?.london;
                    const ny1h = day.sessions?.ny_1h;
                    if (london?.o > 0 && london?.c > 0 && ny1h?.o > 0 && ny1h?.c > 0) {
                      nyContinuesLondonTotal++;
                      if ((london.c > london.o) === (ny1h.c > ny1h.o)) nyContinuesLondon++;
                    }
                  });
                  if (nyContinuesLondonTotal > 0) {
                    patterns.push({ name: 'NY 1H continues London trend', occurrences: nyContinuesLondon, total: nyContinuesLondonTotal, pct: Math.round((nyContinuesLondon / nyContinuesLondonTotal) * 100), color: '#10B981' });
                  }

                  // US IB = NY PM direction
                  let usIbSetsDirection = 0, usIbSetsDirectionTotal = 0;
                  filteredData.forEach(day => {
                    const usIb = day.sessions?.us_ib;
                    const nyPm = day.sessions?.ny_pm;
                    if (usIb?.o > 0 && usIb?.c > 0 && nyPm?.o > 0 && nyPm?.c > 0) {
                      usIbSetsDirectionTotal++;
                      if ((usIb.c > usIb.o) === (nyPm.c > nyPm.o)) usIbSetsDirection++;
                    }
                  });
                  if (usIbSetsDirectionTotal > 0) {
                    patterns.push({ name: 'US IB direction = NY PM direction', occurrences: usIbSetsDirection, total: usIbSetsDirectionTotal, pct: Math.round((usIbSetsDirection / usIbSetsDirectionTotal) * 100), color: '#F59E0B' });
                  }

                  // HOD/LOD stats
                  const hodLodStats = {};
                  horizonSessions.forEach(s => hodLodStats[s.id] = { hod: 0, lod: 0 });
                  filteredData.forEach(day => {
                    let dayHigh = 0, dayLow = Infinity, hodSession = null, lodSession = null;
                    horizonSessions.forEach(sess => {
                      const sessData = day.sessions?.[sess.id];
                      if (sessData && sessData.h > 0 && sessData.l > 0) {
                        if (sessData.h > dayHigh) { dayHigh = sessData.h; hodSession = sess.id; }
                        if (sessData.l < dayLow) { dayLow = sessData.l; lodSession = sess.id; }
                      }
                    });
                    if (hodSession) hodLodStats[hodSession].hod++;
                    if (lodSession) hodLodStats[lodSession].lod++;
                  });

                  return (
                    <div style={{ padding: 20 }}>
                      {/* Data Summary */}
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 16,
                        marginBottom: 16,
                        padding: '10px 16px',
                        background: 'rgba(139, 92, 246, 0.1)',
                        borderRadius: 8,
                        fontSize: 11
                      }}>
                        <span style={{ color: '#A78BFA', fontWeight: 600 }}>üìÖ {filteredData.length} trading days</span>
                        <span style={{ color: '#666' }}>|</span>
                        <span style={{ color: '#888' }}>
                          {strategyMonth === 'all' ? 'All available data' : `${monthTabs.find(m => m.id === strategyMonth)?.label || strategyMonth}`}
                          {strategyWeek !== 'all' && ` ‚Ä¢ Week ${strategyWeek}`}
                        </span>
                      </div>

                      {/* Two-column layout */}
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: 16 }}>
                        {/* OPTIMAL ENTRY FINDER */}
                        <div style={{
                          background: 'rgba(0,0,0,0.3)',
                          borderRadius: 12,
                          border: '1px solid rgba(16, 185, 129, 0.2)',
                          padding: 16
                        }}>
                          <div style={{ fontSize: 12, fontWeight: 700, color: '#10B981', marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }}>
                            <span style={{ fontSize: 16 }}>üéØ</span>
                            OPTIMAL ENTRY FINDER
                            <span style={{ marginLeft: 'auto', fontSize: 9, color: '#666', fontWeight: 400 }}>Long entries ‚Ä¢ Target capture</span>
                          </div>

                          <div className="hide-scrollbar" style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>
                              <thead>
                                <tr>
                                  <th style={{ padding: '6px 8px', textAlign: 'left', color: '#888', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>Entry</th>
                                  {targetPoints.map(t => (
                                    <th key={t} style={{ padding: '6px 6px', textAlign: 'center', color: t === midTarget ? '#10B981' : '#666', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 10 }}>+{t}pt</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {optimalEntryData.map((row, idx) => (
                                  <tr key={row.session.id} style={{ background: bestFor10?.session.id === row.session.id ? 'rgba(16, 185, 129, 0.1)' : idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)' }}>
                                    <td style={{ padding: '6px 8px', color: row.session.color, fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.05)', whiteSpace: 'nowrap' }}>
                                      {row.session.name}
                                      {bestFor10?.session.id === row.session.id && <span style={{ marginLeft: 6, color: '#00ff88', fontSize: 10 }}>‚òÖ</span>}
                                    </td>
                                    {row.results.map(r => (
                                      <td key={r.target} style={{ padding: '4px 6px', textAlign: 'center', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                        <div style={{ fontSize: 12, fontWeight: 700, color: r.winRate >= 70 ? '#00ff88' : r.winRate >= 50 ? '#F59E0B' : '#ff4466' }}>{r.winRate}%</div>
                                        <div style={{ fontSize: 8, color: '#666' }}>DD: {r.avgDD.toFixed(1)}</div>
                                      </td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>

                          {bestFor10 && (() => {
                            const midTargetPt = targetPoints[1];
                            const best10Result = bestFor10.results.find(r => r.target === midTargetPt);
                            return (
                              <div style={{ marginTop: 12, padding: '10px 12px', background: 'rgba(16, 185, 129, 0.15)', borderRadius: 6, borderLeft: '3px solid #10B981' }}>
                                <div style={{ fontSize: 10, color: '#10B981', fontWeight: 700, marginBottom: 4 }}>‚òÖ RECOMMENDED ENTRY</div>
                                <div style={{ fontSize: 11, color: '#fff' }}>
                                  <span style={{ color: bestFor10.session.color, fontWeight: 600 }}>{bestFor10.session.name}</span> offers best risk-adjusted entry for {midTargetPt}pt long targets
                                </div>
                                <div style={{ fontSize: 10, color: '#888', marginTop: 4 }}>
                                  {best10Result.winRate}% win rate ‚Ä¢ {best10Result.avgDD.toFixed(1)} pts avg drawdown ‚Ä¢ {best10Result.riskReward}:1 R:R
                                </div>
                              </div>
                            );
                          })()}
                        </div>

                        {/* SESSION PATTERNS */}
                        <div style={{
                          background: 'rgba(0,0,0,0.3)',
                          borderRadius: 12,
                          border: '1px solid rgba(245, 158, 11, 0.2)',
                          padding: 16
                        }}>
                          <div style={{ fontSize: 12, fontWeight: 700, color: '#F59E0B', marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }}>
                            <span style={{ fontSize: 16 }}>üîç</span>
                            SESSION PATTERNS & BEHAVIOR
                          </div>

                          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                            {patterns.map((pattern, idx) => (
                              <div key={idx} style={{ display: 'flex', alignItems: 'center', padding: '10px 12px', background: 'rgba(255,255,255,0.03)', borderRadius: 8, borderLeft: `3px solid ${pattern.color}` }}>
                                <div style={{ flex: 1 }}>
                                  <div style={{ fontSize: 11, color: '#fff', fontWeight: 500 }}>{pattern.name}</div>
                                  <div style={{ fontSize: 9, color: '#666', marginTop: 2 }}>{pattern.occurrences}/{pattern.total} days</div>
                                </div>
                                <div style={{ fontSize: 16, fontWeight: 700, color: pattern.pct >= 70 ? '#00ff88' : pattern.pct >= 50 ? '#F59E0B' : '#888' }}>{pattern.pct}%</div>
                              </div>
                            ))}
                          </div>

                          {/* HOD/LOD Setter Stats */}
                          <div style={{ marginTop: 16, paddingTop: 12, borderTop: '1px solid rgba(255,255,255,0.08)' }}>
                            <div style={{ fontSize: 10, color: '#888', marginBottom: 8, fontWeight: 600 }}>WHO SETS HIGH/LOW OF DAY</div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                              <div style={{ background: 'rgba(16, 185, 129, 0.1)', borderRadius: 8, padding: 10 }}>
                                <div style={{ fontSize: 9, color: '#10B981', marginBottom: 6, fontWeight: 600 }}>HIGH OF DAY</div>
                                {Object.entries(hodLodStats).filter(([_, s]) => s.hod > 0).sort((a, b) => b[1].hod - a[1].hod).slice(0, 3).map(([sessId, stats]) => {
                                  const sess = horizonSessions.find(s => s.id === sessId);
                                  return (
                                    <div key={sessId} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, marginBottom: 3 }}>
                                      <span style={{ color: sess?.color || '#888' }}>{sess?.name || sessId}</span>
                                      <span style={{ color: '#10B981', fontWeight: 600 }}>{Math.round((stats.hod / filteredData.length) * 100)}%</span>
                                    </div>
                                  );
                                })}
                              </div>
                              <div style={{ background: 'rgba(239, 68, 68, 0.1)', borderRadius: 8, padding: 10 }}>
                                <div style={{ fontSize: 9, color: '#EF4444', marginBottom: 6, fontWeight: 600 }}>LOW OF DAY</div>
                                {Object.entries(hodLodStats).filter(([_, s]) => s.lod > 0).sort((a, b) => b[1].lod - a[1].lod).slice(0, 3).map(([sessId, stats]) => {
                                  const sess = horizonSessions.find(s => s.id === sessId);
                                  return (
                                    <div key={sessId} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, marginBottom: 3 }}>
                                      <span style={{ color: sess?.color || '#888' }}>{sess?.name || sessId}</span>
                                      <span style={{ color: '#EF4444', fontWeight: 600 }}>{Math.round((stats.lod / filteredData.length) * 100)}%</span>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}

            {/* OHLC Tooltip */}
            {hoveredBar && (
              <div style={{
                position: 'fixed',
                left: mousePos.x,
                top: mousePos.y - 10,
                transform: 'translate(-50%, -100%)',
                background: 'rgba(0,0,0,0.95)',
                border: '1px solid rgba(255,255,255,0.2)',
                borderRadius: 8,
                padding: '10px 14px',
                zIndex: 1000,
                boxShadow: '0 4px 20px rgba(0,0,0,0.8)',
                minWidth: 140,
                pointerEvents: 'none'
              }}>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 8,
                  fontSize: 11,
                  fontWeight: 700,
                  color: hoveredBar.close >= hoveredBar.open ? '#00ff88' : '#ff4466',
                  marginBottom: 8,
                  borderBottom: '1px solid rgba(255,255,255,0.1)',
                  paddingBottom: 6
                }}>
                  <span>{hoveredBar.label || hoveredBar.name}</span>
                  {hoveredBar.isHOD && (
                    <span style={{
                      background: '#10B981',
                      color: '#000',
                      fontSize: 8,
                      fontWeight: 700,
                      padding: '2px 5px',
                      borderRadius: 3
                    }}>HIGH OF DAY</span>
                  )}
                  {hoveredBar.isLOD && (
                    <span style={{
                      background: '#EF4444',
                      color: '#fff',
                      fontSize: 8,
                      fontWeight: 700,
                      padding: '2px 5px',
                      borderRadius: 3
                    }}>LOW OF DAY</span>
                  )}
                  {hoveredBar.isHOW && (
                    <span style={{
                      background: '#00ff88',
                      color: '#000',
                      fontSize: 8,
                      fontWeight: 700,
                      padding: '2px 5px',
                      borderRadius: 3,
                      boxShadow: '0 0 8px #00ff88'
                    }}>HIGH OF WEEK</span>
                  )}
                  {hoveredBar.isLOW && (
                    <span style={{
                      background: '#ff4466',
                      color: '#fff',
                      fontSize: 8,
                      fontWeight: 700,
                      padding: '2px 5px',
                      borderRadius: 3,
                      boxShadow: '0 0 8px #ff4466'
                    }}>LOW OF WEEK</span>
                  )}
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: 'auto auto', gap: '4px 12px', fontSize: 10 }}>
                  <span style={{ color: '#3B82F6' }}>O</span>
                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredBar.open?.toFixed(2) || '‚Äî'}</span>
                  <span style={{ color: hoveredBar.isHOD ? '#10B981' : '#10B981' }}>H</span>
                  <span style={{ color: '#fff', fontFamily: 'monospace', background: hoveredBar.isHOD ? 'rgba(16, 185, 129, 0.2)' : 'transparent', padding: hoveredBar.isHOD ? '1px 4px' : 0, borderRadius: 3 }}>{hoveredBar.high?.toFixed(2) || '‚Äî'}</span>
                  <span style={{ color: hoveredBar.isLOD ? '#EF4444' : '#EF4444' }}>L</span>
                  <span style={{ color: '#fff', fontFamily: 'monospace', background: hoveredBar.isLOD ? 'rgba(239, 68, 68, 0.2)' : 'transparent', padding: hoveredBar.isLOD ? '1px 4px' : 0, borderRadius: 3 }}>{hoveredBar.low?.toFixed(2) || '‚Äî'}</span>
                  <span style={{ color: '#F59E0B' }}>C</span>
                  <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredBar.close?.toFixed(2) || '‚Äî'}</span>
                </div>
                {hoveredBar.high > 0 && hoveredBar.low > 0 && (
                  <div style={{ marginTop: 6, paddingTop: 6, borderTop: '1px solid rgba(255,255,255,0.1)', fontSize: 9, color: '#888' }}>
                    Range: <span style={{ color: '#EC4899' }}>{(hoveredBar.high - hoveredBar.low).toFixed(2)}</span>
                  </div>
                )}
              </div>
            )}
          </div>
        );
      })()}

    </div>
  );
};

// Matrix View Content - Transposed with Candlesticks
const MatrixViewContent = ({ liveData, currentSessionId, getSessionStatus, sessions, sessionFilter, vsiData }) => {
  const [hoveredBar, setHoveredBar] = useState(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

  // Extract data
  const endedSessions = liveData?.endedSessions || {};
  const currentPrice = liveData?.currentPrice || 0;
  const dayOpen = liveData?.dayOpen || 0;
  const dayHigh = liveData?.dayHigh || 0;
  const dayLow = liveData?.dayLow || 0;
  const currentDelta = liveData?.cumulativeDelta || 0;
  const dayVolume = liveData?.totalVolume || 0;

  // Build session data for matrix columns
  const sessionColumns = sessions.map(session => {
    const status = getSessionStatus(session.id);
    const sessionData = endedSessions[session.id] || {};
    const isCurrentSession = status === 'NOW';

    const open = isCurrentSession ? (liveData?.sessionOpen || 0) : (sessionData.open || 0);
    const high = isCurrentSession ? (liveData?.sessionHigh || 0) : (sessionData.high || 0);
    const low = isCurrentSession ? (liveData?.sessionLow || 0) : (sessionData.low || 0);
    const close = isCurrentSession ? currentPrice : (sessionData.close || 0);
    const volume = isCurrentSession ? (liveData?.sessionVolume || 0) : (sessionData.volume || 0);
    const delta = isCurrentSession ? (liveData?.sessionDelta || 0) : (sessionData.delta || 0);

    const range = high > 0 && low > 0 ? high - low : 0;
    const deltaPct = volume > 0 ? ((delta / volume) * 100) : 0;

    // Get VSI historical data for this session
    const vsiSessionData = vsiData?.[session.id] || {};

    return {
      ...session,
      status,
      open,
      high,
      low,
      close,
      volume,
      delta,
      deltaPct,
      range,
      hasData: open > 0 || isCurrentSession,
      pdr: vsiSessionData.pDR || 0,
      avg10d: vsiSessionData.avgRange || 0,
      cW: vsiSessionData.cW || 0,
      pW: vsiSessionData.pW || 0,
      cM: vsiSessionData.CM || 0,
      pM: vsiSessionData.PM || 0,
      max: vsiSessionData.max || 0,
      min: vsiSessionData.min || 0
    };
  });

  // 1D (full day) data
  // For historical metrics (pdr, avg, cW, pW, cM, pM, max, min), we use the average across sessions
  // rather than summing them, since these are session-specific comparison values
  const vsiValues = Object.values(vsiData || {});
  const avgVal = (key) => {
    const vals = vsiValues.map(s => s[key] || 0).filter(v => v > 0);
    return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : 0;
  };

  // Determine 1D close: use currentPrice, or fallback to last session close when market is closed
  const day1DClose = currentPrice > 0 ? currentPrice :
    (endedSessions['ny_close']?.close || endedSessions['ny_pm']?.close || liveData?.sessionHigh || dayHigh);

  const day1D = {
    id: '1d',
    name: '1D',
    color: '#FFFFFF',
    open: dayOpen,
    high: dayHigh,
    low: dayLow,
    close: day1DClose,
    volume: dayVolume,
    delta: currentDelta,
    deltaPct: dayVolume > 0 ? ((currentDelta / dayVolume) * 100) : 0,
    range: dayHigh > 0 && dayLow > 0 ? dayHigh - dayLow : 0,
    hasData: dayOpen > 0,
    // Use averages for historical metrics (not sums)
    pdr: avgVal('pDR'),
    avg10d: avgVal('avgRange'),
    cW: avgVal('cW'),
    pW: avgVal('pW'),
    cM: avgVal('CM'),
    pM: avgVal('PM'),
    max: avgVal('max'),
    min: avgVal('min')
  };

  // Calculate price range for shared Y-axis
  const allLows = [day1D.low, ...sessionColumns.filter(s => s.hasData).map(s => s.low)].filter(v => v > 0);
  const allHighs = [day1D.high, ...sessionColumns.filter(s => s.hasData).map(s => s.high)].filter(v => v > 0);
  const priceMin = allLows.length > 0 ? Math.min(...allLows) : 0;
  const priceMax = allHighs.length > 0 ? Math.max(...allHighs) : 0;
  const priceRange = priceMax - priceMin || 1;
  const paddedMin = priceMin - priceRange * 0.08;
  const paddedMax = priceMax + priceRange * 0.08;
  const paddedRange = paddedMax - paddedMin;

  // Dynamic sizing
  const totalColumns = sessionColumns.length + 1;
  const labelWidth = 70;
  const candleHeight = 180; // Taller candles
  const barWidth = Math.max(2, Math.min(4, 60 / totalColumns)); // Thinner bars to prevent overlap

  // Format functions
  const formatNum = (n, decimals = 0) => {
    if (n === undefined || n === null || isNaN(n) || n === 0) return '‚Äî';
    if (Math.abs(n) >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (Math.abs(n) >= 1000) return (n / 1000).toFixed(1) + 'K';
    return n.toFixed(decimals);
  };

  // OHLC Bar Chart renderer (like traditional OHLC bars)
  const renderOHLCBar = (data, idx, isDay = false) => {
    if (!data.hasData || data.open === 0) return null;

    const isUp = data.close >= data.open;
    const barColor = isDay ? '#FFFFFF' : (isUp ? '#00ff88' : '#ff4466');
    const thickness = isDay ? barWidth + 2 : barWidth;

    const highY = candleHeight - ((data.high - paddedMin) / paddedRange) * candleHeight;
    const lowY = candleHeight - ((data.low - paddedMin) / paddedRange) * candleHeight;
    const openY = candleHeight - ((data.open - paddedMin) / paddedRange) * candleHeight;
    const closeY = candleHeight - ((data.close - paddedMin) / paddedRange) * candleHeight;

    const tickWidth = thickness * 0.6; // Shortened by 25% from 0.8

    return (
      <g
        key={data.id || idx}
        onMouseEnter={() => setHoveredBar(data.id || idx)}
        onMouseLeave={() => setHoveredBar(null)}
        style={{ cursor: 'pointer' }}
      >
        {/* Vertical line (High to Low) */}
        <line
          x1={0}
          y1={highY}
          x2={0}
          y2={lowY}
          stroke={barColor}
          strokeWidth={thickness}
          strokeLinecap="round"
          style={{ filter: `drop-shadow(0 0 4px ${barColor}80)` }}
        />
        {/* Open tick (left side) */}
        <line
          x1={-tickWidth}
          y1={openY}
          x2={0}
          y2={openY}
          stroke={barColor}
          strokeWidth={thickness * 0.8}
          strokeLinecap="round"
        />
        {/* Close tick (right side) */}
        <line
          x1={0}
          y1={closeY}
          x2={tickWidth}
          y2={closeY}
          stroke={barColor}
          strokeWidth={thickness * 0.8}
          strokeLinecap="round"
        />
      </g>
    );
  };

  // Metric row colors
  const metricColors = {
    vol: '#8B5CF6',
    delta: '#00ff88',
    deltaPct: '#14B8A6',
    range: '#EC4899',
    pdr: '#6366F1',
    avg10d: '#06B6D4',
    cW: '#84CC16',
    pW: '#22C55E',
    cM: '#F97316',
    pM: '#FB923C',
    max: '#10B981',
    min: '#EF4444'
  };

  // Data rows (no OHLC - those are in tooltip)
  const dataRows = [
    { key: 'vol', label: 'VOL', getValue: (d) => formatNum(d.volume), color: metricColors.vol },
    { key: 'delta', label: 'DELTA', getValue: (d) => formatNum(d.delta), colorFn: (d) => d.delta >= 0 ? '#00ff88' : '#ff4466' },
    { key: 'deltaPct', label: 'DELTA%', getValue: (d) => d.deltaPct ? `${d.deltaPct.toFixed(1)}%` : '‚Äî', colorFn: (d) => d.deltaPct >= 0 ? '#00ff88' : '#ff4466' },
    { key: 'range', label: 'RANGE', getValue: (d) => d.range > 0 ? d.range.toFixed(1) : '‚Äî', color: metricColors.range },
    { key: 'pdr', label: 'PDR', getValue: (d) => d.pdr > 0 ? d.pdr.toFixed(1) : '‚Äî', color: metricColors.pdr },
    { key: 'avg10d', label: 'AVG', getValue: (d) => d.avg10d > 0 ? d.avg10d.toFixed(1) : '‚Äî', color: metricColors.avg10d },
    { key: 'cW', label: 'cW', getValue: (d) => d.cW > 0 ? d.cW.toFixed(1) : '‚Äî', color: metricColors.cW },
    { key: 'pW', label: 'pW', getValue: (d) => d.pW > 0 ? d.pW.toFixed(1) : '‚Äî', color: metricColors.pW },
    { key: 'cM', label: 'cM', getValue: (d) => d.cM > 0 ? d.cM.toFixed(1) : '‚Äî', color: metricColors.cM },
    { key: 'pM', label: 'pM', getValue: (d) => d.pM > 0 ? d.pM.toFixed(1) : '‚Äî', color: metricColors.pM },
    { key: 'max', label: 'MAX', getValue: (d) => d.max > 0 ? d.max.toFixed(1) : '‚Äî', color: metricColors.max },
    { key: 'min', label: 'MIN', getValue: (d) => d.min > 0 ? d.min.toFixed(1) : '‚Äî', color: metricColors.min },
  ];

  // All bars for chart (1D + sessions)
  const allBars = [day1D, ...sessionColumns];
  const chartWidth = 100; // percentage
  const barSpacing = chartWidth / (allBars.length + 1);

  // Get hovered data for tooltip
  const hoveredData = hoveredBar ? allBars.find(b => (b.id || b.name) === hoveredBar) : null;

  return (
    <div style={{
      background: 'linear-gradient(180deg, rgba(12,12,16,0.98) 0%, rgba(8,8,12,1) 100%)',
      borderRadius: 16,
      border: '1px solid rgba(255,255,255,0.08)',
      overflow: 'hidden',
      boxShadow: '0 8px 32px rgba(0,0,0,0.6)'
    }}>
      {/* Continuous Chart Section */}
      <div style={{ position: 'relative', padding: '16px 12px 8px 12px' }}>
        {/* Session Labels Row - compact titles only */}
        <div style={{
          display: 'flex',
          marginBottom: 4,
          paddingLeft: 0
        }}>
          {allBars.map((bar, idx) => {
            const isDay = idx === 0;
            const isNow = bar.status === 'NOW';
            const isWaiting = bar.status === 'WAITING';
            const columnColor = isDay ? '#FFFFFF' : bar.color;
            return (
              <div key={bar.id || idx} style={{
                flex: isDay ? '0 0 8%' : 1,
                textAlign: 'center',
                opacity: isWaiting ? 0.4 : 1,
                padding: '2px 1px',
                position: 'relative'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 2 }}>
                  <div style={{
                    width: 5,
                    height: 5,
                    borderRadius: 3,
                    background: columnColor,
                    boxShadow: isNow ? `0 0 8px ${columnColor}` : `0 0 4px ${columnColor}60`
                  }} />
                  <span style={{
                    fontSize: 8,
                    color: columnColor,
                    fontWeight: isDay || isNow ? 700 : 600,
                    letterSpacing: 0.2
                  }}>
                    {isDay ? '1D' : bar.name}
                    {isNow && <span style={{ fontSize: 6, color: '#00ff88', background: 'rgba(0,255,136,0.3)', padding: '1px 3px', borderRadius: 2, fontWeight: 700, marginLeft: 2 }}>LIVE</span>}
                  </span>
                </div>
              </div>
            );
          })}
        </div>

        {/* Chart Area - Flex-based OHLC bars with column backgrounds */}
        <div data-chart-area style={{ position: 'relative', paddingLeft: 0 }}>
          {/* Column backgrounds + Grid lines + OHLC Bars */}
          <div style={{ display: 'flex', height: candleHeight, position: 'relative' }}>
            {allBars.map((bar, idx) => {
              const isDay = idx === 0;
              const isNow = bar.status === 'NOW';
              const columnColor = isDay ? '#FFFFFF' : bar.color;
              // Light background using session color
              const bgColor = isDay
                ? 'rgba(255,255,255,0.03)'
                : `${columnColor}08`;

              return (
                <div
                  key={bar.id || idx}
                  style={{
                    flex: isDay ? '0 0 8%' : 1,
                    position: 'relative',
                    display: 'flex',
                    justifyContent: 'center',
                    background: bgColor,
                    borderLeft: idx > 0 ? '1px solid rgba(255,255,255,0.03)' : 'none',
                    borderRight: '1px solid rgba(255,255,255,0.03)'
                  }}
                  onMouseEnter={(e) => {
                    setHoveredBar(bar.id || idx);
                    const rect = e.currentTarget.closest('[data-chart-area]')?.getBoundingClientRect();
                    if (rect) setMousePos({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                  }}
                  onMouseMove={(e) => {
                    const rect = e.currentTarget.closest('[data-chart-area]')?.getBoundingClientRect();
                    if (rect) setMousePos({ x: e.clientX - rect.left, y: e.clientY - rect.top });
                  }}
                  onMouseLeave={() => setHoveredBar(null)}
                >
                  {bar.hasData && bar.high > 0 && (() => {
                    const isUp = bar.close >= bar.open;
                    // Body color based on up/down close
                    const bodyColor = isUp ? '#00ff88' : '#ff4466';
                    // Close tick color matches body
                    const closeColor = isUp ? '#00ff88' : '#ff4466';

                    // Bar dimensions - 70% thinner
                    const wickWidth = 1.5;  // Was 5, now 70% thinner
                    const tickLen = 7;      // Half width (was 14)
                    const tickH = 2;        // Thinner (was 4)

                    const highY = candleHeight - ((bar.high - paddedMin) / paddedRange) * candleHeight;
                    const lowY = candleHeight - ((bar.low - paddedMin) / paddedRange) * candleHeight;
                    const openY = candleHeight - ((bar.open - paddedMin) / paddedRange) * candleHeight;
                    const closeY = candleHeight - ((bar.close - paddedMin) / paddedRange) * candleHeight;

                    return (
                      <svg width="100%" height={candleHeight} viewBox="0 0 40 180" preserveAspectRatio="xMidYMid meet" style={{ overflow: 'visible', cursor: 'pointer' }}>
                        {/* Vertical wick (High to Low) - green/red based on close */}
                        <line
                          x1="20" y1={highY} x2="20" y2={lowY}
                          stroke={bodyColor} strokeWidth={wickWidth} strokeLinecap="butt"
                          style={{ filter: `drop-shadow(0 0 ${isNow ? '4px' : '2px'} ${bodyColor}60)` }}
                        />
                        {/* Open tick - extends LEFT from wick - white */}
                        <rect
                          x={20 - tickLen}
                          y={openY - tickH/2}
                          width={tickLen}
                          height={tickH}
                          fill="#FFFFFF"
                          style={{ opacity: 0.9 }}
                        />
                        {/* Close tick - extends RIGHT from wick - green/red */}
                        <rect
                          x={20}
                          y={closeY - tickH/2}
                          width={tickLen}
                          height={tickH}
                          fill={closeColor}
                          style={{ filter: isNow ? `drop-shadow(0 0 3px ${closeColor})` : 'none' }}
                        />
                      </svg>
                    );
                  })()}
                </div>
              );
            })}
          </div>

          {/* Enhanced Tooltip with all metrics */}
          {hoveredData && (
              <div style={{
                position: 'absolute',
                left: mousePos.x + 15,
                top: Math.min(mousePos.y - 10, candleHeight - 260),
                background: 'linear-gradient(135deg, rgba(12,12,18,0.98) 0%, rgba(8,8,12,0.98) 100%)',
                border: '1px solid rgba(255,255,255,0.15)',
                borderRadius: 12,
                padding: '12px 16px',
                zIndex: 100,
                boxShadow: '0 8px 32px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.05) inset',
                minWidth: 180,
                pointerEvents: 'none',
                transform: mousePos.x > 400 ? 'translateX(-110%)' : 'none'
              }}>
                {/* Header */}
                <div style={{
                  fontSize: 13,
                  fontWeight: 700,
                  color: hoveredData.id === '1d' ? '#FFFFFF' : hoveredData.color || '#8B5CF6',
                  marginBottom: 10,
                  paddingBottom: 8,
                  borderBottom: '1px solid rgba(255,255,255,0.08)',
                  textAlign: 'center',
                  letterSpacing: 0.5
                }}>
                  {hoveredData.name || hoveredData.id}
                  {hoveredData.start && hoveredData.end && (
                    <div style={{ fontSize: 9, color: '#666', fontWeight: 400, marginTop: 2 }}>
                      {hoveredData.start} - {hoveredData.end}
                    </div>
                  )}
                </div>

                {/* OHLC Section */}
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: '1fr 1fr',
                  gap: '6px 16px',
                  fontSize: 10,
                  marginBottom: 10,
                  paddingBottom: 10,
                  borderBottom: '1px solid rgba(255,255,255,0.06)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <span style={{ color: '#3B82F6', fontWeight: 600 }}>O</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.open?.toFixed(2) || '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <span style={{ color: '#10B981', fontWeight: 600 }}>H</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.high?.toFixed(2) || '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <span style={{ color: '#EF4444', fontWeight: 600 }}>L</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.low?.toFixed(2) || '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                    <span style={{ color: '#F59E0B', fontWeight: 600 }}>C</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.close?.toFixed(2) || '‚Äî'}</span>
                  </div>
                </div>

                {/* Metrics Section */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '5px 12px', fontSize: 9 }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#EC4899' }}>RANGE</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.range > 0 ? hoveredData.range.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#8B5CF6' }}>VOL</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{formatNum(hoveredData.volume)}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: hoveredData.delta >= 0 ? '#00ff88' : '#ff4466' }}>DELTA</span>
                    <span style={{ color: hoveredData.delta >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace' }}>{formatNum(hoveredData.delta)}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: hoveredData.deltaPct >= 0 ? '#14B8A6' : '#ff4466' }}>DELTA%</span>
                    <span style={{ color: hoveredData.deltaPct >= 0 ? '#14B8A6' : '#ff4466', fontFamily: 'monospace' }}>{hoveredData.deltaPct ? `${hoveredData.deltaPct.toFixed(1)}%` : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#6366F1' }}>pDR</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.pdr > 0 ? hoveredData.pdr.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#06B6D4' }}>AVG</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.avg10d > 0 ? hoveredData.avg10d.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#84CC16' }}>cW</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.cW > 0 ? hoveredData.cW.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#22C55E' }}>pW</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.pW > 0 ? hoveredData.pW.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#F97316' }}>cM</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.cM > 0 ? hoveredData.cM.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#FB923C' }}>pM</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.pM > 0 ? hoveredData.pM.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#10B981' }}>MAX</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.max > 0 ? hoveredData.max.toFixed(1) : '‚Äî'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                    <span style={{ color: '#EF4444' }}>MIN</span>
                    <span style={{ color: '#fff', fontFamily: 'monospace' }}>{hoveredData.min > 0 ? hoveredData.min.toFixed(1) : '‚Äî'}</span>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

      {/* Compact Legend - hover bars for details */}
      <div style={{
        padding: '10px 16px',
        borderTop: '1px solid rgba(255,255,255,0.05)',
        background: 'rgba(0,0,0,0.3)',
        display: 'flex',
        gap: 16,
        justifyContent: 'center',
        alignItems: 'center',
        flexWrap: 'wrap',
        fontSize: 11,
        color: '#555'
      }}>
        <span style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
          <div style={{ width: 8, height: 8, background: '#00ff88', borderRadius: 1 }} />
          <span style={{ color: '#888' }}>Bull</span>
        </span>
        <span style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
          <div style={{ width: 8, height: 8, background: '#ff4466', borderRadius: 1 }} />
          <span style={{ color: '#888' }}>Bear</span>
        </span>
        <span style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
          <div style={{ width: 8, height: 8, background: '#FFFFFF', borderRadius: 1 }} />
          <span style={{ color: '#FFFFFF' }}>1D</span>
        </span>
        <span style={{ color: '#666' }}>Hover for all metrics</span>
        {/* Market Closed indicator - shows green when in market closed hours */}
        {(() => {
          const now = new Date();
          const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
          const et = new Date(utc - (5 * 3600000));
          const timeVal = et.getHours() * 100 + et.getMinutes();
          const isMarketClosed = timeVal >= 1700 && timeVal < 1800;
          return (
            <span style={{
              display: 'flex',
              alignItems: 'center',
              gap: 4,
              marginLeft: 8,
              padding: '2px 8px',
              borderRadius: 4,
              background: isMarketClosed ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.05)',
              border: isMarketClosed ? '1px solid #10B981' : '1px solid rgba(255,255,255,0.1)'
            }}>
              <div style={{
                width: 6,
                height: 6,
                borderRadius: '50%',
                background: isMarketClosed ? '#10B981' : '#4B5563',
                boxShadow: isMarketClosed ? '0 0 8px #10B981' : 'none'
              }} />
              <span style={{
                color: isMarketClosed ? '#10B981' : '#666',
                fontWeight: isMarketClosed ? 600 : 400
              }}>
                {isMarketClosed ? 'Market Closed (17:00-18:00 ET)' : 'Market Closed: 17:00-18:00 ET'}
              </span>
            </span>
          );
        })()}
      </div>
    </div>
  );
};

// VSI Matrix View - Transposed Session Analysis (Standalone - can be removed later)
const VSIMatrixView = () => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [hoveredSession, setHoveredSession] = useState(null);

  // Simplified sessions for matrix view
  const matrixSessions = [
    { id: 'japan_ib', name: 'Japan', color: '#9370DB' },
    { id: 'china', name: 'China', color: '#8B5CF6' },
    { id: 'london', name: 'London', color: '#3B82F6' },
    { id: 'us_ib', name: 'US IB', color: '#F59E0B' },
    { id: 'ny_1h', name: 'NY 1H', color: '#10B981' },
    { id: 'ny_2h', name: 'NY 2H', color: '#14B8A6' },
    { id: 'lunch', name: 'Lunch', color: '#6B7280' },
    { id: 'ny_pm', name: 'NY PM', color: '#EF4444' },
  ];

  // Session order for determining status
  const sessionOrder = [
    'pre_asia', 'japan_ib', 'china', 'asia_close', 'deadzone',
    'london', 'low_volume', 'us_ib', 'ny_1h', 'ny_2h',
    'lunch', 'ny_pm', 'ny_close', 'market_closed'
  ];

  // Get current session ID based on ET time
  const getCurrentSessionId = () => {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const et = new Date(utc - (5 * 3600000));
    const hours = et.getHours();
    const mins = et.getMinutes();
    const timeVal = hours * 100 + mins;

    if (timeVal >= 1900 && timeVal < 2000) return 'japan_ib';
    if (timeVal >= 2000 && timeVal < 2300) return 'china';
    if (timeVal >= 2300 || timeVal < 200) return 'asia_close';
    if (timeVal >= 200 && timeVal < 300) return 'deadzone';
    if (timeVal >= 300 && timeVal < 600) return 'london';
    if (timeVal >= 600 && timeVal < 820) return 'low_volume';
    if (timeVal >= 820 && timeVal < 930) return 'us_ib';
    if (timeVal >= 930 && timeVal < 1030) return 'ny_1h';
    if (timeVal >= 1030 && timeVal < 1130) return 'ny_2h';
    if (timeVal >= 1130 && timeVal < 1330) return 'lunch';
    if (timeVal >= 1330 && timeVal < 1600) return 'ny_pm';
    if (timeVal >= 1600 && timeVal < 1700) return 'ny_close';
    if (timeVal >= 1700 && timeVal < 1800) return 'market_closed';
    if (timeVal >= 1800 && timeVal < 1900) return 'pre_asia';
    return null;
  };

  const currentSessionId = getCurrentSessionId();

  const getSessionStatus = (sessionId) => {
    if (sessionId === currentSessionId) return 'NOW';
    const currentIdx = sessionOrder.indexOf(currentSessionId);
    const sessionIdx = sessionOrder.indexOf(sessionId);
    if (currentIdx === -1) return 'WAITING';
    return sessionIdx < currentIdx ? 'ENDED' : 'WAITING';
  };

  // Fetch live data
  useEffect(() => {
    let isMounted = true;
    const fetchData = async () => {
      try {
        const response = await fetch(API_BASE);
        if (response.ok && isMounted) {
          const apiData = await response.json();
          setData(apiData);
        }
      } catch (err) {
        console.error('Matrix data fetch error:', err);
      } finally {
        if (isMounted) setLoading(false);
      }
    };

    fetchData();
    const interval = setInterval(fetchData, 2000);
    return () => { isMounted = false; clearInterval(interval); };
  }, []);

  if (loading) {
    return (
      <div style={{ padding: 40, textAlign: 'center', color: '#888' }}>
        <div style={{ fontSize: 24, marginBottom: 8 }}>‚è≥</div>
        Loading session matrix...
      </div>
    );
  }

  // Extract session data from API
  const endedSessions = data?.ended_sessions || {};
  const currentPrice = data?.current_price || 0;

  // Build matrix data for each session
  const matrixData = matrixSessions.map(session => {
    const status = getSessionStatus(session.id);
    const sessionData = endedSessions[session.id] || {};

    // For current session, use live data
    const isCurrentSession = status === 'NOW';
    const open = isCurrentSession ? (data?.session_open || 0) : (sessionData.open || 0);
    const high = isCurrentSession ? (data?.session_high || 0) : (sessionData.high || 0);
    const low = isCurrentSession ? (data?.session_low || 0) : (sessionData.low || 0);
    const close = isCurrentSession ? currentPrice : (sessionData.close || 0);
    const delta = sessionData.delta || (isCurrentSession ? (data?.session_delta || 0) : 0);
    const volume = sessionData.volume || (isCurrentSession ? (data?.session_volume || 0) : 0);

    const priceMove = close && open ? close - open : 0;
    const range = high && low ? high - low : 0;

    return {
      ...session,
      status,
      open,
      high,
      low,
      close,
      delta,
      volume,
      priceMove,
      range
    };
  });

  // Calculate max values for scaling bars
  const maxDelta = Math.max(...matrixData.map(s => Math.abs(s.delta || 0)), 100);
  const maxPriceMove = Math.max(...matrixData.map(s => Math.abs(s.priceMove || 0)), 5);
  const maxVolume = Math.max(...matrixData.map(s => s.volume || 0), 1000);
  const maxRange = Math.max(...matrixData.map(s => s.range || 0), 10);

  // Bar component for metrics
  const MetricBar = ({ value, maxVal, color, isBidirectional = false }) => {
    if (!value && value !== 0) return <div style={{ width: 80, height: 16, background: 'rgba(255,255,255,0.05)', borderRadius: 2 }} />;

    const absValue = Math.abs(value);
    const pct = maxVal > 0 ? (absValue / maxVal) * 100 : 0;
    const isPositive = value >= 0;

    if (isBidirectional) {
      // Bidirectional bar (centered, goes left or right)
      return (
        <div style={{
          width: 80,
          height: 16,
          background: 'rgba(255,255,255,0.05)',
          borderRadius: 2,
          position: 'relative',
          overflow: 'hidden'
        }}>
          {/* Center line */}
          <div style={{
            position: 'absolute',
            left: '50%',
            top: 0,
            bottom: 0,
            width: 1,
            background: 'rgba(255,255,255,0.2)'
          }} />
          {/* Value bar */}
          <div style={{
            position: 'absolute',
            top: 2,
            bottom: 2,
            left: isPositive ? '50%' : `${50 - pct/2}%`,
            width: `${pct/2}%`,
            background: isPositive ? '#00ff88' : '#ff4466',
            borderRadius: 2,
            boxShadow: `0 0 6px ${isPositive ? 'rgba(0,255,136,0.4)' : 'rgba(255,68,102,0.4)'}`
          }} />
        </div>
      );
    }

    // Unidirectional bar (volume, range)
    return (
      <div style={{
        width: 80,
        height: 16,
        background: 'rgba(255,255,255,0.05)',
        borderRadius: 2,
        position: 'relative',
        overflow: 'hidden'
      }}>
        <div style={{
          position: 'absolute',
          top: 2,
          bottom: 2,
          left: 2,
          width: `${Math.min(pct, 100) - 4}%`,
          background: color || '#3B82F6',
          borderRadius: 2,
          boxShadow: `0 0 6px ${color || '#3B82F6'}40`
        }} />
      </div>
    );
  };

  return (
    <div style={{ maxWidth: 900, margin: '0 auto' }}>
      {/* Header */}
      <div style={{ marginBottom: 24 }}>
        <h2 style={{ margin: 0, color: '#fff', fontSize: 20 }}>üìä Session Matrix</h2>
        <p style={{ margin: '8px 0 0 0', color: '#888', fontSize: 13 }}>
          Volume, Delta and Range per Session
        </p>
      </div>

      {/* Matrix Table */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        borderRadius: 12,
        border: '1px solid rgba(255,255,255,0.1)',
        overflow: 'hidden'
      }}>
        {/* Header Row */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: '100px 90px 90px 90px 90px 90px',
          gap: 8,
          padding: '12px 16px',
          background: 'rgba(255,255,255,0.03)',
          borderBottom: '1px solid rgba(255,255,255,0.1)'
        }}>
          <div style={{ color: '#666', fontSize: 10, fontWeight: 600, letterSpacing: 1 }}>SESSION</div>
          <div style={{ color: '#666', fontSize: 10, fontWeight: 600, letterSpacing: 1, textAlign: 'center' }}>OPEN</div>
          <div style={{ color: '#666', fontSize: 10, fontWeight: 600, letterSpacing: 1, textAlign: 'center' }}>Œî DELTA</div>
          <div style={{ color: '#666', fontSize: 10, fontWeight: 600, letterSpacing: 1, textAlign: 'center' }}>PRICE</div>
          <div style={{ color: '#666', fontSize: 10, fontWeight: 600, letterSpacing: 1, textAlign: 'center' }}>RANGE</div>
          <div style={{ color: '#666', fontSize: 10, fontWeight: 600, letterSpacing: 1, textAlign: 'center' }}>VOL</div>
        </div>

        {/* Session Rows */}
        {matrixData.map((session, idx) => {
          const isNow = session.status === 'NOW';
          const isEnded = session.status === 'ENDED';
          const isWaiting = session.status === 'WAITING';

          const isHovered = hoveredSession === session.id;

          return (
            <div
              key={session.id}
              onMouseEnter={() => setHoveredSession(session.id)}
              onMouseLeave={() => setHoveredSession(null)}
              style={{
                display: 'grid',
                gridTemplateColumns: '100px 90px 90px 90px 90px 90px',
                gap: 8,
                padding: '10px 16px',
                alignItems: 'center',
                background: isNow ? 'rgba(0,255,136,0.08)' : isHovered ? 'rgba(255,255,255,0.03)' : 'transparent',
                borderBottom: idx < matrixData.length - 1 ? '1px solid rgba(255,255,255,0.05)' : 'none',
                opacity: isWaiting ? 0.4 : 1,
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}>
              {/* Session Name */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: 8,
                transform: isHovered ? 'translateX(4px)' : 'none',
                transition: 'transform 0.2s ease'
              }}>
                <div style={{
                  width: 4,
                  height: isHovered ? 28 : 24,
                  borderRadius: 2,
                  background: session.color,
                  boxShadow: isHovered ? `0 0 8px ${session.color}` : 'none',
                  transition: 'all 0.2s ease'
                }} />
                <div>
                  <div style={{
                    color: isNow ? '#00ff88' : isHovered ? session.color : '#fff',
                    fontSize: isHovered ? 13 : 12,
                    fontWeight: isNow || isHovered ? 700 : 500,
                    textShadow: isHovered ? `0 0 8px ${session.color}40` : 'none',
                    transition: 'all 0.2s ease'
                  }}>
                    {session.name}
                  </div>
                  {isNow && (
                    <div style={{
                      color: '#00ff88',
                      fontSize: 9,
                      fontWeight: 700,
                      letterSpacing: 1
                    }}>NOW</div>
                  )}
                </div>
              </div>

              {/* Open Price */}
              <div style={{ textAlign: 'center' }}>
                <span style={{
                  fontFamily: 'monospace',
                  fontSize: 11,
                  color: isEnded || isNow ? '#fff' : '#555'
                }}>
                  {session.open > 0 ? `$${session.open.toFixed(1)}` : '‚Äî'}
                </span>
              </div>

              {/* Delta Bar */}
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2 }}>
                <MetricBar value={session.delta} maxVal={maxDelta} isBidirectional={true} />
                <span style={{ fontSize: 9, color: session.delta >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace' }}>
                  {session.delta !== 0 ? (session.delta > 0 ? '+' : '') + session.delta : '‚Äî'}
                </span>
              </div>

              {/* Price Move Bar */}
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2 }}>
                <MetricBar value={session.priceMove} maxVal={maxPriceMove} isBidirectional={true} />
                <span style={{ fontSize: 9, color: session.priceMove >= 0 ? '#00ff88' : '#ff4466', fontFamily: 'monospace' }}>
                  {session.priceMove !== 0 ? (session.priceMove > 0 ? '+' : '') + session.priceMove.toFixed(1) : '‚Äî'}
                </span>
              </div>

              {/* Range Bar */}
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2 }}>
                <MetricBar value={session.range} maxVal={maxRange} color={session.color} />
                <span style={{ fontSize: 9, color: '#888', fontFamily: 'monospace' }}>
                  {session.range > 0 ? `$${session.range.toFixed(1)}` : '‚Äî'}
                </span>
              </div>

              {/* Volume Bar */}
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2 }}>
                <MetricBar value={session.volume} maxVal={maxVolume} color="#3B82F6" />
                <span style={{ fontSize: 9, color: '#888', fontFamily: 'monospace' }}>
                  {session.volume > 0 ? session.volume.toLocaleString() : '‚Äî'}
                </span>
              </div>
            </div>
          );
        })}
      </div>

      {/* Legend */}
      <div style={{
        marginTop: 16,
        padding: 12,
        background: 'rgba(255,255,255,0.02)',
        borderRadius: 8,
        display: 'flex',
        gap: 24,
        justifyContent: 'center',
        fontSize: 10,
        color: '#666'
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
          <div style={{ width: 12, height: 12, background: '#00ff88', borderRadius: 2 }} />
          <span>Positive</span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
          <div style={{ width: 12, height: 12, background: '#ff4466', borderRadius: 2 }} />
          <span>Negative</span>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
          <div style={{ width: 12, height: 8, background: 'rgba(0,255,136,0.2)', borderRadius: 2 }} />
          <span>NOW Session</span>
        </div>
      </div>
    </div>
  );
};

// Navigation Component - Mobile Responsive with Hamburger Menu
const Navigation = ({ activeTab, setActiveTab, onLogout }) => {
  const { isMobile, isTablet } = useResponsive();
  const [menuOpen, setMenuOpen] = useState(false);
  const [profileOpen, setProfileOpen] = useState(false);

  const tabs = [
    { id: 'backtest', icon: 'üìä', label: 'Backtest', fullLabel: 'Backtest Analytics' },
    { id: 'live', icon: '‚óè', label: 'Live', fullLabel: 'Live Metrics', iconColor: '#ef4444' },
    { id: 'tpo', icon: '‚ñ¶', label: 'TPO', fullLabel: 'Market Profile', iconColor: '#ffaa00' },
    { id: 'zones', icon: 'üéØ', label: 'Zones', fullLabel: 'Zone Participation', iconColor: '#00ff88' },
    { id: 'clawd', icon: 'ü§ñ', label: 'Clawd', fullLabel: 'Clawd Bot Analytics', iconColor: '#00aaff' },
    { id: 'treemap', icon: 'üìä', label: 'Matrix', fullLabel: 'Correlation Matrix' },
    { id: 'vsi', icon: 'üìà', label: 'Sessions', fullLabel: 'Session Analysis' },
    { id: 'trades', icon: 'üìã', label: 'Trades', fullLabel: 'Trade Log' },
    { id: 'priceladder', icon: '‚ñ•', label: 'Ladder', fullLabel: 'Price Ladder' },
    { id: 'redfolder', icon: '‚óè', label: 'Red', fullLabel: 'Red Folder', iconColor: '#ff4466', accent: '#ff4466' }
  ];

  const handleTabClick = (tabId) => {
    setActiveTab(tabId);
    setMenuOpen(false);
  };

  // Mobile Navigation
  if (isMobile) {
    return (
      <>
        <nav style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '12px 16px',
          background: 'rgba(0,0,0,0.4)',
          borderBottom: '1px solid rgba(255,255,255,0.08)',
          position: 'sticky',
          top: 0,
          zIndex: 1000,
          backdropFilter: 'blur(10px)',
        }}>
          {/* Logo */}
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <div style={{
              width: 32,
              height: 32,
              background: 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)',
              borderRadius: 6,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
            }}>
              <span style={{ fontSize: 16, color: '#0a0a0a', fontWeight: 800 }}>H</span>
            </div>
            <span style={{ fontSize: 12, fontWeight: 700, color: '#00ff88', letterSpacing: '2px' }}>HORIZON</span>
          </div>

          {/* Current Tab Indicator */}
          <div style={{
            padding: '6px 12px',
            background: 'rgba(0,255,136,0.1)',
            borderRadius: 6,
            border: '1px solid rgba(0,255,136,0.3)',
          }}>
            <span style={{ color: '#00ff88', fontSize: 11, fontWeight: 600 }}>
              {tabs.find(t => t.id === activeTab)?.label || 'Menu'}
            </span>
          </div>

          {/* Hamburger Button */}
          <button
            onClick={() => setMenuOpen(!menuOpen)}
            style={{
              width: 40,
              height: 40,
              background: menuOpen ? 'rgba(0,255,136,0.15)' : 'transparent',
              border: '1px solid rgba(255,255,255,0.1)',
              borderRadius: 8,
              cursor: 'pointer',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 5,
              transition: 'all 0.2s',
            }}
          >
            <span style={{
              width: 18,
              height: 2,
              background: menuOpen ? '#00ff88' : '#888',
              borderRadius: 1,
              transition: 'all 0.3s',
              transform: menuOpen ? 'rotate(45deg) translateY(7px)' : 'none',
            }} />
            <span style={{
              width: 18,
              height: 2,
              background: menuOpen ? '#00ff88' : '#888',
              borderRadius: 1,
              transition: 'all 0.3s',
              opacity: menuOpen ? 0 : 1,
            }} />
            <span style={{
              width: 18,
              height: 2,
              background: menuOpen ? '#00ff88' : '#888',
              borderRadius: 1,
              transition: 'all 0.3s',
              transform: menuOpen ? 'rotate(-45deg) translateY(-7px)' : 'none',
            }} />
          </button>
        </nav>

        {/* Mobile Menu Overlay */}
        {menuOpen && (
          <div style={{
            position: 'fixed',
            top: 57,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(10,10,15,0.98)',
            zIndex: 999,
            padding: 16,
            overflowY: 'auto',
            animation: 'slideIn 0.2s ease',
          }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 }}>
              {tabs.map(tab => {
                const isActive = activeTab === tab.id;
                const accentColor = tab.accent || '#00ff88';
                return (
                  <button
                    key={tab.id}
                    onClick={() => handleTabClick(tab.id)}
                    style={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: 8,
                      padding: '20px 12px',
                      background: isActive
                        ? `linear-gradient(180deg, ${accentColor}20 0%, ${accentColor}08 100%)`
                        : 'rgba(255,255,255,0.03)',
                      border: isActive ? `2px solid ${accentColor}` : '1px solid rgba(255,255,255,0.08)',
                      borderRadius: 12,
                      color: isActive ? accentColor : '#aaa',
                      cursor: 'pointer',
                      transition: 'all 0.2s',
                    }}
                  >
                    <span style={{
                      fontSize: 24,
                      color: isActive ? accentColor : (tab.iconColor || '#666'),
                      filter: isActive ? `drop-shadow(0 0 8px ${accentColor})` : 'none',
                    }}>{tab.icon}</span>
                    <span style={{ fontSize: 12, fontWeight: isActive ? 700 : 500 }}>{tab.fullLabel}</span>
                  </button>
                );
              })}
            </div>

            {/* Settings & Logout Row */}
            <div style={{ display: 'flex', gap: 12, marginTop: 20 }}>
              <button
                onClick={() => { setActiveTab('settings'); setMenuOpen(false); }}
                style={{
                  flex: 1,
                  padding: '16px',
                  background: 'rgba(0,255,136,0.1)',
                  border: '1px solid rgba(0,255,136,0.4)',
                  borderRadius: 12,
                  color: '#00ff88',
                  fontSize: 14,
                  fontWeight: 600,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: 8,
                }}
              >
                <span>‚öôÔ∏è</span> Settings
              </button>
              <button
                onClick={onLogout}
                style={{
                  flex: 1,
                  padding: '16px',
                  background: 'rgba(255,68,102,0.1)',
                  border: '1px solid rgba(255,68,102,0.4)',
                  borderRadius: 12,
                  color: '#ff4466',
                  fontSize: 14,
                  fontWeight: 600,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: 8,
                }}
              >
                <span>üö™</span> Logout
              </button>
            </div>
          </div>
        )}
      </>
    );
  }

  // Tablet Navigation - Horizontal scrollable
  if (isTablet) {
    return (
      <nav style={{
        display: 'flex',
        alignItems: 'center',
        padding: '12px 16px',
        background: 'rgba(0,0,0,0.3)',
        borderBottom: '1px solid rgba(255,255,255,0.05)',
        gap: 16,
      }}>
        {/* Logo */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexShrink: 0 }}>
          <div style={{
            width: 32,
            height: 32,
            background: 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)',
            borderRadius: 6,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
          }}>
            <span style={{ fontSize: 16, color: '#0a0a0a', fontWeight: 800 }}>H</span>
          </div>
        </div>

        {/* Scrollable Tabs */}
        <div style={{
          display: 'flex',
          gap: 4,
          overflowX: 'auto',
          flex: 1,
          WebkitOverflowScrolling: 'touch',
          scrollbarWidth: 'none',
          msOverflowStyle: 'none',
        }}>
          {tabs.map(tab => {
            const isActive = activeTab === tab.id;
            const accentColor = tab.accent || '#00ff88';
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 6,
                  padding: '8px 12px',
                  background: isActive ? `${accentColor}15` : 'transparent',
                  border: isActive ? `1px solid ${accentColor}` : '1px solid transparent',
                  borderRadius: 6,
                  color: isActive ? accentColor : '#888',
                  fontSize: 11,
                  fontWeight: isActive ? 600 : 500,
                  cursor: 'pointer',
                  whiteSpace: 'nowrap',
                  flexShrink: 0,
                }}
              >
                <span style={{ color: isActive ? accentColor : (tab.iconColor || '#666') }}>{tab.icon}</span>
                <span>{tab.label}</span>
              </button>
            );
          })}
        </div>

        {/* Profile Dropdown */}
        <div style={{ position: 'relative', flexShrink: 0 }}>
          <button
            onClick={() => setProfileOpen(!profileOpen)}
            style={{
              width: 36,
              height: 36,
              borderRadius: '50%',
              background: 'transparent',
              border: '1px solid rgba(255,255,255,0.5)',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              transition: 'all 0.2s ease',
              fontSize: 14,
              color: '#fff',
              boxShadow: profileOpen ? '0 0 15px rgba(0,255,136,0.5)' : 'none'
            }}
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </button>
          {profileOpen && (
            <>
              <div
                style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 998 }}
                onClick={() => setProfileOpen(false)}
              />
              <div style={{
                position: 'absolute',
                top: 'calc(100% + 8px)',
                right: 0,
                background: 'rgba(20,20,25,0.98)',
                border: '1px solid rgba(255,255,255,0.1)',
                borderRadius: 10,
                padding: 6,
                minWidth: 150,
                boxShadow: '0 10px 30px rgba(0,0,0,0.5)',
                zIndex: 999,
              }}>
                <button
                  onClick={() => { setActiveTab('settings'); setProfileOpen(false); }}
                  style={{
                    width: '100%',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 10,
                    padding: '10px 14px',
                    background: 'transparent',
                    border: 'none',
                    borderRadius: 6,
                    color: '#ccc',
                    fontSize: 13,
                    cursor: 'pointer',
                  }}
                >
                  <span>‚öôÔ∏è</span> Settings
                </button>
                <div style={{ height: 1, background: 'rgba(255,255,255,0.08)', margin: '4px 6px' }} />
                <button
                  onClick={() => { onLogout(); setProfileOpen(false); }}
                  style={{
                    width: '100%',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 10,
                    padding: '10px 14px',
                    background: 'transparent',
                    border: 'none',
                    borderRadius: 6,
                    color: '#ff4466',
                    fontSize: 13,
                    cursor: 'pointer',
                  }}
                >
                  <span>üö™</span> Logout
                </button>
              </div>
            </>
          )}
        </div>
      </nav>
    );
  }

  // Desktop Navigation (Original)
  return (
    <nav style={styles.nav}>
      <div style={styles.navBrand}>
        <div style={{
          width: 36,
          height: 36,
          background: 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)',
          borderRadius: 8,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          boxShadow: '0 4px 15px rgba(0,255,136,0.3)'
        }}>
          <span style={{ fontSize: 18, color: '#0a0a0a', fontWeight: 800 }}>H</span>
        </div>
        <div style={{ display: 'flex', flexDirection: 'column', gap: 0 }}>
          <span style={{ fontSize: 14, fontWeight: 800, color: '#fff', letterSpacing: '1.5px' }}>PROJECT</span>
          <span style={{ fontSize: 10, fontWeight: 600, color: '#00ff88', letterSpacing: '3px' }}>HORIZON</span>
        </div>
      </div>
      <div style={{ ...styles.navTabs, marginLeft: 24 }}>
        {tabs.map(tab => {
          const isActive = activeTab === tab.id;
          const accentColor = tab.accent || '#00ff88';
          return (
            <button
              key={tab.id}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: 8,
                padding: '10px 18px',
                background: isActive
                  ? `linear-gradient(180deg, ${accentColor}20 0%, ${accentColor}05 100%)`
                  : 'transparent',
                border: isActive ? `1px solid ${accentColor}` : '1px solid transparent',
                borderRadius: 8,
                color: isActive ? accentColor : '#8b8b8b',
                fontSize: 13,
                fontWeight: isActive ? 600 : 500,
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                position: 'relative',
                overflow: 'hidden'
              }}
              onClick={() => setActiveTab(tab.id)}
              onMouseEnter={e => {
                if (!isActive) {
                  e.target.style.background = 'rgba(255,255,255,0.05)';
                  e.target.style.color = '#ccc';
                }
              }}
              onMouseLeave={e => {
                if (!isActive) {
                  e.target.style.background = 'transparent';
                  e.target.style.color = '#8b8b8b';
                }
              }}
            >
              <span style={{
                fontSize: tab.icon.length === 1 ? 14 : 15,
                color: isActive ? accentColor : (tab.iconColor || '#8b8b8b'),
                filter: isActive && tab.iconColor ? `drop-shadow(0 0 4px ${tab.iconColor})` : 'none'
              }}>{tab.icon}</span>
              <span>{tab.fullLabel}</span>
              {isActive && (
                <div style={{
                  position: 'absolute',
                  bottom: 0,
                  left: '50%',
                  transform: 'translateX(-50%)',
                  width: '60%',
                  height: 2,
                  background: accentColor,
                  borderRadius: '2px 2px 0 0',
                  boxShadow: `0 0 10px ${accentColor}`
                }} />
              )}
            </button>
          );
        })}
      </div>
      {/* Profile Dropdown */}
      <div style={{ position: 'relative', marginLeft: 16 }}>
        <button
          onClick={() => setProfileOpen(!profileOpen)}
          style={{
            width: 40,
            height: 40,
            borderRadius: '50%',
            background: 'transparent',
            border: '1px solid rgba(255,255,255,0.5)',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            transition: 'all 0.2s ease',
            fontSize: 18,
            color: '#fff',
            boxShadow: profileOpen ? '0 0 15px rgba(0,255,136,0.5)' : 'none'
          }}
          onMouseEnter={e => {
            e.currentTarget.style.borderColor = '#00ff88';
            e.currentTarget.style.boxShadow = '0 0 15px rgba(0,255,136,0.5)';
          }}
          onMouseLeave={e => {
            if (!profileOpen) {
              e.currentTarget.style.borderColor = 'rgba(255,255,255,0.5)';
              e.currentTarget.style.boxShadow = 'none';
            }
          }}
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </button>

        {profileOpen && (
          <>
            {/* Backdrop */}
            <div
              style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 998 }}
              onClick={() => setProfileOpen(false)}
            />
            {/* Dropdown Menu */}
            <div style={{
              position: 'absolute',
              top: 'calc(100% + 8px)',
              right: 0,
              background: 'rgba(20,20,25,0.98)',
              border: '1px solid rgba(255,255,255,0.1)',
              borderRadius: 12,
              padding: 8,
              minWidth: 180,
              boxShadow: '0 10px 40px rgba(0,0,0,0.5)',
              zIndex: 999,
              backdropFilter: 'blur(20px)'
            }}>
              <button
                onClick={() => { setActiveTab('settings'); setProfileOpen(false); }}
                style={{
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  gap: 12,
                  padding: '12px 16px',
                  background: 'transparent',
                  border: 'none',
                  borderRadius: 8,
                  color: '#ccc',
                  fontSize: 14,
                  cursor: 'pointer',
                  transition: 'all 0.15s'
                }}
                onMouseEnter={e => {
                  e.currentTarget.style.background = 'rgba(255,255,255,0.08)';
                  e.currentTarget.style.color = '#fff';
                }}
                onMouseLeave={e => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.color = '#ccc';
                }}
              >
                <span style={{ fontSize: 16 }}>‚öôÔ∏è</span>
                <span>Settings</span>
              </button>
              <div style={{ height: 1, background: 'rgba(255,255,255,0.08)', margin: '4px 8px' }} />
              <button
                onClick={() => { onLogout(); setProfileOpen(false); }}
                style={{
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  gap: 12,
                  padding: '12px 16px',
                  background: 'transparent',
                  border: 'none',
                  borderRadius: 8,
                  color: '#ff4466',
                  fontSize: 14,
                  cursor: 'pointer',
                  transition: 'all 0.15s'
                }}
                onMouseEnter={e => {
                  e.currentTarget.style.background = 'rgba(255,68,102,0.15)';
                }}
                onMouseLeave={e => {
                  e.currentTarget.style.background = 'transparent';
                }}
              >
                <span style={{ fontSize: 16 }}>üö™</span>
                <span>Logout</span>
              </button>
            </div>
          </>
        )}
      </div>
    </nav>
  );
};

// ============================================
// RED FOLDER DASHBOARD - Live Event Transcription & Analysis
// ============================================
const RedFolderDashboard = () => {
  const [streamUrl, setStreamUrl] = useState('');
  const [isStreaming, setIsStreaming] = useState(false);
  const [connected, setConnected] = useState(false);
  const [data, setData] = useState({
    stream_active: false,
    stream_title: '',
    transcript_buffer: [],
    current_segment: '',
    sentiment: { current: 'neutral', score: 0, confidence: 0, history: [] },
    voice_tone: { confidence_level: 0, hesitation_count: 0, stress_indicators: 0, speaking_rate: 0 },
    keywords: {},
    market_direction: { signal: 'neutral', strength: 0, components: { sentiment_weight: 0, tone_weight: 0, keyword_weight: 0 } },
    error: null
  });
  const transcriptRef = useRef(null);

  // Polling effect
  useEffect(() => {
    const fetchData = async () => {
      try {
        const response = await fetch(REDFOLDER_BASE);
        const json = await response.json();
        setData(json);
        setIsStreaming(json.stream_active);
        setConnected(true);
      } catch (e) {
        setConnected(false);
      }
    };

    fetchData();
    const interval = setInterval(fetchData, 300);
    return () => clearInterval(interval);
  }, []);

  // Auto-scroll transcript
  useEffect(() => {
    if (transcriptRef.current) {
      transcriptRef.current.scrollTop = transcriptRef.current.scrollHeight;
    }
  }, [data.transcript_buffer]);

  // Start stream
  const handleStart = async () => {
    if (!streamUrl) return;
    try {
      await fetch(`${REDFOLDER_BASE}/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: streamUrl })
      });
    } catch (e) {
      console.error('Failed to start stream:', e);
    }
  };

  // Stop stream
  const handleStop = async () => {
    try {
      await fetch(`${REDFOLDER_BASE}/stop`, { method: 'POST' });
    } catch (e) {
      console.error('Failed to stop stream:', e);
    }
  };

  // Highlight keywords in text
  const highlightText = (text) => {
    if (!text) return text;
    const keywordList = Object.keys(data.keywords || {});
    let result = text;
    keywordList.forEach(kw => {
      const regex = new RegExp(`\\b(${kw})\\b`, 'gi');
      result = result.replace(regex, '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 2px 4px; border-radius: 4px; font-weight: 600;">$1</span>');
    });
    return result;
  };

  // Get sentiment color - matches ¬±5% threshold
  const getSentimentColor = (score) => {
    if (score > 0.05) return '#00ff88';  // Bullish = Green
    if (score < -0.05) return '#ff4466'; // Bearish = Red
    return '#ffaa00';                     // Neutral = Yellow
  };

  // Get direction style
  const getDirectionStyle = (signal) => {
    switch (signal) {
      case 'bullish': return { color: '#00ff88', icon: '‚ñ≤', glow: 'rgba(0,255,136,0.3)' };
      case 'bearish': return { color: '#ff4466', icon: '‚ñº', glow: 'rgba(255,68,102,0.3)' };
      default: return { color: '#ffaa00', icon: '‚óÜ', glow: 'rgba(255,170,0,0.3)' };
    }
  };

  const directionStyle = getDirectionStyle(data.market_direction?.signal);

  return (
    <div style={{ maxWidth: 1400, margin: '0 auto' }}>
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24, flexWrap: 'wrap', gap: 16 }}>
        <h2 style={{ margin: 0, display: 'flex', alignItems: 'center', gap: 12 }}>
          <span style={{ fontSize: 28 }}>üìÇ</span>
          <span>Red Folder</span>
          <span style={{ fontSize: 14, color: '#888', fontWeight: 400 }}>Live Event Transcription & Analysis</span>
        </h2>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <div style={{
            display: 'flex', alignItems: 'center', gap: 8,
            padding: '8px 16px', borderRadius: 8,
            background: connected ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,102,0.1)',
            border: `1px solid ${connected ? '#00ff88' : '#ff4466'}`
          }}>
            <div style={{
              width: 10, height: 10, borderRadius: '50%',
              background: connected ? '#00ff88' : '#ff4466',
              boxShadow: connected ? '0 0 10px #00ff88' : 'none',
              animation: connected && isStreaming ? 'pulse 2s infinite' : 'none'
            }} />
            <span style={{ color: connected ? '#00ff88' : '#ff4466', fontSize: 12, fontWeight: 600 }}>
              {isStreaming ? 'LIVE TRANSCRIBING' : connected ? 'SERVICE ONLINE' : 'SERVICE OFFLINE'}
            </span>
          </div>
        </div>
      </div>

      {/* URL Input & Controls */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        border: '1px solid rgba(255,255,255,0.08)',
        borderRadius: 16, padding: 20, marginBottom: 24
      }}>
        <div style={{ display: 'flex', gap: 12, alignItems: 'center', flexWrap: 'wrap' }}>
          <input
            type="text"
            placeholder="Enter YouTube Live URL (e.g., https://youtube.com/watch?v=...)"
            value={streamUrl}
            onChange={(e) => setStreamUrl(e.target.value)}
            style={{
              flex: 1, minWidth: 300, padding: '12px 16px',
              background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)',
              borderRadius: 8, color: '#fff', fontSize: 14,
              fontFamily: "'JetBrains Mono', monospace"
            }}
          />
          <button
            onClick={handleStart}
            disabled={isStreaming || !streamUrl}
            style={{
              padding: '12px 24px', borderRadius: 8,
              background: isStreaming ? 'rgba(255,255,255,0.05)' : 'linear-gradient(135deg, #00ff88, #00cc6a)',
              border: 'none', color: isStreaming ? '#666' : '#000',
              fontWeight: 700, cursor: isStreaming ? 'not-allowed' : 'pointer',
              transition: 'all 0.2s'
            }}
          >
            ‚ñ∂ START
          </button>
          <button
            onClick={handleStop}
            disabled={!isStreaming}
            style={{
              padding: '12px 24px', borderRadius: 8,
              background: !isStreaming ? 'rgba(255,255,255,0.05)' : 'linear-gradient(135deg, #ff4466, #cc3355)',
              border: 'none', color: !isStreaming ? '#666' : '#fff',
              fontWeight: 700, cursor: !isStreaming ? 'not-allowed' : 'pointer',
              transition: 'all 0.2s'
            }}
          >
            ‚ñ† STOP
          </button>
        </div>
        {data.stream_title && (
          <div style={{ marginTop: 12, color: '#888', fontSize: 13 }}>
            <span style={{ color: '#00aaff' }}>Now transcribing:</span> {data.stream_title}
          </div>
        )}
        {data.error && (
          <div style={{ marginTop: 12, color: '#ff4466', fontSize: 13 }}>
            Error: {data.error}
          </div>
        )}
        {/* Auto-Scheduler Status */}
        {data.scheduler && (
          <div style={{
            marginTop: 16, padding: '12px 16px', borderRadius: 8,
            background: data.scheduler.event_active ? 'rgba(255,170,0,0.1)' : 'rgba(0,170,255,0.05)',
            border: `1px solid ${data.scheduler.event_active ? '#ffaa00' : 'rgba(0,170,255,0.2)'}`,
            display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: 16 }}>{data.scheduler.event_active ? 'üîî' : 'üìÖ'}</span>
              <span style={{ color: '#888', fontSize: 12, fontWeight: 600 }}>AUTO-SCHEDULER</span>
              <span style={{
                padding: '2px 8px', borderRadius: 4, fontSize: 10, fontWeight: 700,
                background: data.scheduler.enabled ? 'rgba(0,255,136,0.2)' : 'rgba(255,68,102,0.2)',
                color: data.scheduler.enabled ? '#00ff88' : '#ff4466'
              }}>
                {data.scheduler.enabled ? 'ENABLED' : 'DISABLED'}
              </span>
            </div>
            {data.scheduler.next_event && (
              <div style={{ marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 8 }}>
                <span style={{ color: '#666', fontSize: 11 }}>Next:</span>
                <span style={{ color: data.scheduler.event_active ? '#ffaa00' : '#00aaff', fontSize: 12, fontWeight: 600 }}>
                  {data.scheduler.next_event}
                </span>
                <span style={{ color: '#888', fontSize: 11 }}>
                  {data.scheduler.next_time}
                </span>
                {data.scheduler.event_active && (
                  <span style={{
                    padding: '2px 8px', borderRadius: 4, fontSize: 10, fontWeight: 700,
                    background: 'rgba(255,170,0,0.2)', color: '#ffaa00',
                    animation: 'pulse 2s infinite'
                  }}>
                    EVENT ACTIVE
                  </span>
                )}
              </div>
            )}
          </div>
        )}
      </div>

      {/* Main Grid */}
      <div style={{ display: 'grid', gridTemplateColumns: '1fr 400px', gap: 24 }}>
        {/* Left Column - Transcript */}
        <div style={{
          background: 'rgba(255,255,255,0.02)',
          border: '1px solid rgba(255,255,255,0.08)',
          borderRadius: 16, padding: 24,
          height: 600, display: 'flex', flexDirection: 'column'
        }}>
          <h3 style={{ margin: '0 0 16px 0', color: '#fff', fontSize: 16, display: 'flex', alignItems: 'center', gap: 8 }}>
            <span>üìù</span> Live Transcript
            {isStreaming && <span style={{ fontSize: 11, color: '#00ff88', marginLeft: 'auto' }}>‚óè RECORDING</span>}
          </h3>
          <div
            ref={transcriptRef}
            style={{
              flex: 1, overflowY: 'auto',
              fontFamily: "'JetBrains Mono', monospace",
              fontSize: 14, lineHeight: 1.8
            }}
          >
            {data.transcript_buffer?.length === 0 && !data.current_segment ? (
              <div style={{ color: '#666', textAlign: 'center', padding: 40 }}>
                {isStreaming ? 'Waiting for speech...' : 'Start a stream to begin transcription'}
              </div>
            ) : (
              <>
                {data.transcript_buffer?.map((segment, idx) => (
                  <div key={idx} style={{
                    padding: '8px 0',
                    borderBottom: '1px solid rgba(255,255,255,0.03)',
                    opacity: segment.is_final ? 1 : 0.6
                  }}>
                    <span style={{ color: '#666', marginRight: 12, fontSize: 12 }}>{segment.timestamp}</span>
                    <span style={{ color: '#e0e0e0' }} dangerouslySetInnerHTML={{ __html: highlightText(segment.text) }} />
                  </div>
                ))}
                {data.current_segment && (
                  <div style={{ padding: '8px 0', opacity: 0.6, color: '#888' }}>
                    <span style={{ marginRight: 12, fontSize: 12 }}>...</span>
                    {data.current_segment}
                  </div>
                )}
              </>
            )}
          </div>
        </div>

        {/* Right Column - Analysis */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
          {/* Sentiment Gauge */}
          <div style={{
            background: 'rgba(255,255,255,0.02)',
            border: `1px solid ${data.sentiment?.score > 0.1 ? 'rgba(0,255,136,0.3)' : data.sentiment?.score < -0.1 ? 'rgba(255,68,102,0.3)' : 'rgba(255,255,255,0.08)'}`,
            borderRadius: 16, padding: 20, textAlign: 'center',
            transition: 'border-color 0.5s ease, box-shadow 0.5s ease',
            boxShadow: data.sentiment?.score > 0.1 ? '0 0 20px rgba(0,255,136,0.1)' : data.sentiment?.score < -0.1 ? '0 0 20px rgba(255,68,102,0.1)' : 'none'
          }}>
            <h4 style={{ margin: '0 0 16px 0', color: '#888', fontSize: 12, letterSpacing: 1 }}>SENTIMENT GAUGE</h4>
            <svg width="200" height="110" viewBox="0 0 200 110" style={{ margin: '0 auto', display: 'block' }}>
              <defs>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                  <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              {/* Background arc */}
              <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="12" />
              {/* Colored segments - more vivid */}
              <path d="M 20 100 A 80 80 0 0 1 60 35" fill="none" stroke="#ff4466" strokeWidth="12" opacity={data.sentiment?.score < -0.1 ? "0.8" : "0.25"} style={{ transition: 'opacity 0.5s' }} />
              <path d="M 60 35 A 80 80 0 0 1 140 35" fill="none" stroke="#ffaa00" strokeWidth="12" opacity={Math.abs(data.sentiment?.score || 0) <= 0.1 ? "0.8" : "0.25"} style={{ transition: 'opacity 0.5s' }} />
              <path d="M 140 35 A 80 80 0 0 1 180 100" fill="none" stroke="#00ff88" strokeWidth="12" opacity={data.sentiment?.score > 0.1 ? "0.8" : "0.25"} style={{ transition: 'opacity 0.5s' }} />
              {/* Animated Needle with smooth transition */}
              <g style={{
                transform: `rotate(${((data.sentiment?.score || 0) + 1) * 90 - 180}deg)`,
                transformOrigin: '100px 100px',
                transition: 'transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)'
              }}>
                <line x1="100" y1="100" x2="165" y2="100" stroke={getSentimentColor(data.sentiment?.score || 0)} strokeWidth="3" strokeLinecap="round" filter="url(#glow)" />
              </g>
              <circle cx="100" cy="100" r="10" fill={getSentimentColor(data.sentiment?.score || 0)} style={{ transition: 'fill 0.5s' }} />
              <circle cx="100" cy="100" r="5" fill="#1a1a1a" />
              <text x="20" y="108" fill="#ff4466" fontSize="10" fontWeight="600">BEAR</text>
              <text x="160" y="108" fill="#00ff88" fontSize="10" fontWeight="600">BULL</text>
            </svg>
            <div style={{ marginTop: 12 }}>
              <span style={{
                fontSize: 28,
                fontWeight: 800,
                color: getSentimentColor(data.sentiment?.score || 0),
                textShadow: data.sentiment?.current !== 'neutral' ? `0 0 20px ${getSentimentColor(data.sentiment?.score || 0)}40` : 'none',
                transition: 'color 0.5s, text-shadow 0.5s'
              }}>
                {(data.sentiment?.current || 'neutral').toUpperCase()}
              </span>
              <div style={{ fontSize: 12, color: '#888', marginTop: 6 }}>
                Score: <span style={{ color: getSentimentColor(data.sentiment?.score || 0), fontWeight: 600 }}>{((data.sentiment?.score || 0) * 100).toFixed(0)}%</span> | Confidence: <span style={{ color: '#fff', fontWeight: 600 }}>{((data.sentiment?.confidence || 0) * 100).toFixed(0)}%</span>
              </div>
            </div>
          </div>

          {/* Voice Tone Analysis */}
          <div style={{
            background: 'rgba(255,255,255,0.02)',
            border: '1px solid rgba(255,255,255,0.08)',
            borderRadius: 16, padding: 20
          }}>
            <h4 style={{ margin: '0 0 16px 0', color: '#888', fontSize: 12, letterSpacing: 1 }}>VOICE ANALYSIS</h4>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
              {/* Confidence */}
              <div>
                <div style={{ fontSize: 11, color: '#666', marginBottom: 4 }}>Confidence</div>
                <div style={{ height: 8, background: 'rgba(255,255,255,0.1)', borderRadius: 4, overflow: 'hidden' }}>
                  <div style={{
                    width: `${data.voice_tone?.confidence_level || 0}%`,
                    height: '100%', borderRadius: 4,
                    background: (data.voice_tone?.confidence_level || 0) > 70 ? '#00ff88' : (data.voice_tone?.confidence_level || 0) > 40 ? '#ffaa00' : '#ff4466',
                    transition: 'width 0.3s'
                  }} />
                </div>
                <div style={{ fontSize: 14, fontWeight: 600, color: '#fff', marginTop: 4 }}>{(data.voice_tone?.confidence_level || 0).toFixed(0)}%</div>
              </div>
              {/* Speaking Rate */}
              <div>
                <div style={{ fontSize: 11, color: '#666', marginBottom: 4 }}>Speaking Rate</div>
                <div style={{ fontSize: 24, fontWeight: 700, color: '#00aaff' }}>{(data.voice_tone?.speaking_rate || 0).toFixed(0)}</div>
                <div style={{ fontSize: 10, color: '#666' }}>WPM</div>
              </div>
              {/* Hesitations */}
              <div>
                <div style={{ fontSize: 11, color: '#666', marginBottom: 4 }}>Hesitations</div>
                <div style={{ fontSize: 24, fontWeight: 700, color: (data.voice_tone?.hesitation_count || 0) > 5 ? '#ff4466' : '#888' }}>
                  {data.voice_tone?.hesitation_count || 0}
                </div>
              </div>
              {/* Stress */}
              <div>
                <div style={{ fontSize: 11, color: '#666', marginBottom: 4 }}>Stress Signs</div>
                <div style={{ fontSize: 24, fontWeight: 700, color: (data.voice_tone?.stress_indicators || 0) > 3 ? '#ff4466' : '#888' }}>
                  {data.voice_tone?.stress_indicators || 0}
                </div>
              </div>
            </div>
          </div>

          {/* Keyword Tracker */}
          <div style={{
            background: 'rgba(255,255,255,0.02)',
            border: '1px solid rgba(255,255,255,0.08)',
            borderRadius: 16, padding: 20
          }}>
            <h4 style={{ margin: '0 0 16px 0', color: '#888', fontSize: 12, letterSpacing: 1 }}>KEYWORD TRACKING</h4>
            <div style={{ maxHeight: 150, overflowY: 'auto' }}>
              {Object.entries(data.keywords || {})
                .filter(([_, v]) => v.count > 0)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 8)
                .map(([keyword, info]) => {
                  const maxCount = Math.max(...Object.values(data.keywords || {}).map(v => v.count || 0), 1);
                  const bullishKw = ['growth', 'dovish', 'easing', 'employment', 'jobs'];
                  const bearishKw = ['inflation', 'hawkish', 'tightening', 'recession', 'rates'];
                  const color = bullishKw.includes(keyword) ? '#00ff88' : bearishKw.includes(keyword) ? '#ff4466' : '#00aaff';
                  return (
                    <div key={keyword} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.03)' }}>
                      <span style={{ minWidth: 70, fontSize: 11, color, fontWeight: 600, textTransform: 'capitalize' }}>{keyword}</span>
                      <div style={{ flex: 1, height: 6, background: 'rgba(255,255,255,0.05)', borderRadius: 3, overflow: 'hidden' }}>
                        <div style={{ width: `${(info.count / maxCount) * 100}%`, height: '100%', background: color, borderRadius: 3, transition: 'width 0.3s' }} />
                      </div>
                      <span style={{ fontSize: 12, color: '#888', minWidth: 24, textAlign: 'right' }}>{info.count}</span>
                    </div>
                  );
                })}
              {Object.values(data.keywords || {}).every(v => v.count === 0) && (
                <div style={{ color: '#666', fontSize: 12, textAlign: 'center', padding: 20 }}>No keywords detected yet</div>
              )}
            </div>
          </div>

          {/* Divergence Alert */}
          {(() => {
            const sentimentSignal = (data.sentiment?.score || 0) > 0.05 ? 'bullish' : (data.sentiment?.score || 0) < -0.05 ? 'bearish' : 'neutral';
            const marketSignal = data.market_direction?.signal || 'neutral';
            const isDiverging = sentimentSignal !== 'neutral' && marketSignal !== 'neutral' && sentimentSignal !== marketSignal;
            const isPartialDiverge = (sentimentSignal !== 'neutral' && marketSignal === 'neutral') || (sentimentSignal === 'neutral' && marketSignal !== 'neutral');

            if (isDiverging) {
              return (
                <div style={{
                  background: 'linear-gradient(135deg, rgba(255,170,0,0.15) 0%, rgba(255,170,0,0.05) 100%)',
                  border: '2px solid #ffaa00',
                  borderRadius: 12,
                  padding: 16,
                  marginBottom: 16,
                  animation: 'pulse 1.5s infinite'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    <span style={{ fontSize: 24 }}>‚ö†Ô∏è</span>
                    <div>
                      <div style={{ color: '#ffaa00', fontWeight: 700, fontSize: 14 }}>DIVERGENCE ALERT</div>
                      <div style={{ color: '#888', fontSize: 11, marginTop: 2 }}>
                        Sentiment: <span style={{ color: sentimentSignal === 'bullish' ? '#00ff88' : '#ff4466' }}>{sentimentSignal.toUpperCase()}</span>
                        {' vs '}
                        Direction: <span style={{ color: marketSignal === 'bullish' ? '#00ff88' : '#ff4466' }}>{marketSignal.toUpperCase()}</span>
                      </div>
                      <div style={{ color: '#ffaa00', fontSize: 10, marginTop: 4 }}>Voice tone or keywords offsetting text sentiment</div>
                    </div>
                  </div>
                </div>
              );
            }
            if (isPartialDiverge) {
              return (
                <div style={{
                  background: 'rgba(255,255,255,0.03)',
                  border: '1px solid rgba(255,255,255,0.1)',
                  borderRadius: 12,
                  padding: 12,
                  marginBottom: 16
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 16 }}>üîÑ</span>
                    <div style={{ color: '#888', fontSize: 11 }}>
                      Mixed signals: Sentiment {sentimentSignal.toUpperCase()} | Direction {marketSignal.toUpperCase()}
                    </div>
                  </div>
                </div>
              );
            }
            // Strong signal when both agree
            if (sentimentSignal !== 'neutral' && sentimentSignal === marketSignal) {
              const strength = data.market_direction?.strength || 0;
              const signalColor = sentimentSignal === 'bullish' ? '#00ff88' : '#ff4466';
              return (
                <div style={{
                  background: `linear-gradient(135deg, ${signalColor}20 0%, ${signalColor}08 100%)`,
                  border: `2px solid ${signalColor}`,
                  borderRadius: 12,
                  padding: 16,
                  marginBottom: 16,
                  boxShadow: `0 0 20px ${signalColor}30`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    <span style={{ fontSize: 24 }}>{sentimentSignal === 'bullish' ? 'üöÄ' : 'üîª'}</span>
                    <div>
                      <div style={{ color: signalColor, fontWeight: 700, fontSize: 14 }}>
                        STRONG {sentimentSignal.toUpperCase()} SIGNAL
                      </div>
                      <div style={{ color: '#888', fontSize: 11, marginTop: 2 }}>
                        Sentiment + Direction aligned | Strength: {strength.toFixed(0)}%
                      </div>
                    </div>
                  </div>
                </div>
              );
            }
            return null;
          })()}

          {/* Market Direction */}
          <div style={{
            background: 'rgba(255,255,255,0.02)',
            border: `2px solid ${directionStyle.color}`,
            borderRadius: 16, padding: 24, textAlign: 'center',
            boxShadow: `0 0 30px ${directionStyle.glow}`
          }}>
            <h4 style={{ margin: '0 0 16px 0', color: '#888', fontSize: 12, letterSpacing: 1 }}>MARKET DIRECTION</h4>
            <div style={{
              display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 16, margin: '20px 0',
              transition: 'transform 0.5s ease'
            }}>
              <span style={{
                fontSize: 56,
                color: directionStyle.color,
                textShadow: `0 0 30px ${directionStyle.color}`,
                transition: 'color 0.5s, text-shadow 0.5s, transform 0.3s',
                animation: data.market_direction?.signal !== 'neutral' ? 'pulse 2s infinite' : 'none'
              }}>
                {directionStyle.icon}
              </span>
              <span style={{
                fontSize: 36,
                fontWeight: 800,
                color: directionStyle.color,
                letterSpacing: 4,
                transition: 'color 0.5s ease',
                textShadow: `0 0 15px ${directionStyle.color}40`
              }}>
                {(data.market_direction?.signal || 'neutral').toUpperCase()}
              </span>
            </div>
            <div style={{ marginBottom: 16 }}>
              <div style={{ fontSize: 11, color: '#666', marginBottom: 4 }}>Strength</div>
              <div style={{ height: 10, background: 'rgba(255,255,255,0.1)', borderRadius: 5, overflow: 'hidden' }}>
                <div style={{
                  width: `${data.market_direction?.strength || 0}%`,
                  height: '100%', borderRadius: 5,
                  background: `linear-gradient(90deg, ${directionStyle.color}80 0%, ${directionStyle.color} 100%)`,
                  transition: 'width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)',
                  boxShadow: `0 0 10px ${directionStyle.color}`
                }} />
              </div>
              <div style={{ fontSize: 16, fontWeight: 700, color: directionStyle.color, marginTop: 6, transition: 'color 0.5s' }}>{(data.market_direction?.strength || 0).toFixed(0)}%</div>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8 }}>
              <div>
                <div style={{ fontSize: 10, color: '#666' }}>Sentiment</div>
                <div style={{ fontSize: 12, color: '#fff' }}>{((data.market_direction?.components?.sentiment_weight || 0) * 100).toFixed(0)}%</div>
              </div>
              <div>
                <div style={{ fontSize: 10, color: '#666' }}>Voice</div>
                <div style={{ fontSize: 12, color: '#fff' }}>{((data.market_direction?.components?.tone_weight || 0) * 100).toFixed(0)}%</div>
              </div>
              <div>
                <div style={{ fontSize: 10, color: '#666' }}>Keywords</div>
                <div style={{ fontSize: 12, color: '#fff' }}>{((data.market_direction?.components?.keyword_weight || 0) * 100).toFixed(0)}%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ============================================ */}
      {/* SECTION 1: FED SPEECH TRANSCRIPTION (Deepgram) */}
      {/* ============================================ */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        border: '1px solid rgba(139,92,246,0.3)',
        borderRadius: 16, padding: 24, marginTop: 24
      }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
          <h3 style={{ margin: 0, color: '#fff', fontSize: 18, display: 'flex', alignItems: 'center', gap: 10 }}>
            <span style={{ fontSize: 22 }}>üéôÔ∏è</span>
            Fed Speech Transcription Analysis
          </h3>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <span style={{ padding: '4px 10px', borderRadius: 6, background: 'rgba(139,92,246,0.2)', color: '#A78BFA', fontSize: 10, fontWeight: 600 }}>
              DEEPGRAM LIVE TRANSCRIPTION
            </span>
          </div>
        </div>
        <p style={{ color: '#666', fontSize: 12, margin: '0 0 20px 0' }}>
          Real-time sentiment analysis of Fed Chair, FOMC Press Conferences & Presidential speeches ‚Ä¢ OHLC during speech duration
        </p>

        {/* Past 6 Months of Fed Speeches */}
        <div style={{ marginBottom: 24 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
            <span style={{ color: '#A78BFA', fontSize: 12, fontWeight: 600 }}>‚úì PAST SPEECHES</span>
            <span style={{ color: '#666', fontSize: 11 }}>(Last 6 Months)</span>
          </div>

          <div style={{ overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
              <thead>
                <tr style={{ borderBottom: '2px solid rgba(139,92,246,0.2)' }}>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>DATE</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>TIME (ET)</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>EVENT</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>DURATION</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>SENTIMENT</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>SIGNAL</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>OHLC</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>$ RANGE</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>RESULT</th>
                </tr>
              </thead>
              <tbody>
                {(() => {
                  // Fed speeches from last 6 months (Jul 2025 - Jan 2026)
                  // Note: Fed Chair could change - currently Powell, monitor for replacement
                  const fedSpeeches = [
                    // January 2026 FOMC - Jan 28
                    { date: 'Tue, Jan 28', dateStr: '2026-01-28', time: '14:30', event: 'FOMC Press Conference', speaker: 'Powell', duration: 55, sentiment: -0.12, direction: 'bearish', o: 2765.80, h: 2772.40, l: 2748.50, c: 2752.20 },
                    { date: 'Tue, Jan 28', dateStr: '2026-01-28', time: '14:00', event: 'FOMC Rate Decision', speaker: 'Fed', duration: 25, sentiment: -0.05, direction: 'neutral', o: 2768.50, h: 2775.20, l: 2762.80, c: 2765.80 },
                    { date: 'Wed, Jan 8', dateStr: '2026-01-08', time: '14:00', event: 'FOMC Minutes Release Discussion', speaker: 'Fed Officials', duration: 45, sentiment: -0.08, direction: 'bearish', o: 4495.00, h: 4498.50, l: 4486.20, c: 4488.80 },
                    // December 2025
                    { date: 'Wed, Dec 18', dateStr: '2025-12-18', time: '14:30', event: 'FOMC Press Conference', speaker: 'Powell', duration: 52, sentiment: 0.15, direction: 'bullish', o: 4425.00, h: 4452.30, l: 4420.50, c: 4448.60 },
                    { date: 'Fri, Dec 6', dateStr: '2025-12-06', time: '11:00', event: 'Fed Chair Powell Speaks', speaker: 'Powell', duration: 38, sentiment: -0.12, direction: 'bearish', o: 4380.00, h: 4385.40, l: 4358.20, c: 4362.50 },
                    // November 2025
                    { date: 'Wed, Nov 26', dateStr: '2025-11-26', time: '14:30', event: 'FOMC Minutes Discussion', speaker: 'Fed Officials', duration: 42, sentiment: 0.05, direction: 'neutral', o: 4320.00, h: 4328.50, l: 4315.80, c: 4322.40 },
                    { date: 'Thu, Nov 14', dateStr: '2025-11-14', time: '10:00', event: 'Fed Chair Powell Speaks', speaker: 'Powell', duration: 55, sentiment: 0.22, direction: 'bullish', o: 4285.50, h: 4318.20, l: 4282.00, c: 4312.80 },
                    { date: 'Mon, Nov 4', dateStr: '2025-11-04', time: '15:00', event: 'U.S. President Trump Speaks', speaker: 'Trump', duration: 28, sentiment: 0.18, direction: 'bullish', o: 4245.00, h: 4272.50, l: 4242.30, c: 4268.90 },
                    // October 2025
                    { date: 'Wed, Oct 22', dateStr: '2025-10-22', time: '14:30', event: 'FOMC Press Conference', speaker: 'Powell', duration: 48, sentiment: -0.15, direction: 'bearish', o: 4195.00, h: 4202.80, l: 4168.50, c: 4175.20 },
                    { date: 'Tue, Oct 8', dateStr: '2025-10-08', time: '09:30', event: 'Fed Chair Powell Speaks', speaker: 'Powell', duration: 35, sentiment: 0.08, direction: 'bullish', o: 4150.00, h: 4168.40, l: 4145.20, c: 4162.50 },
                    // September 2025
                    { date: 'Wed, Sep 17', dateStr: '2025-09-17', time: '14:30', event: 'FOMC Press Conference', speaker: 'Powell', duration: 58, sentiment: 0.28, direction: 'bullish', o: 4085.00, h: 4135.60, l: 4080.50, c: 4128.40 },
                    { date: 'Fri, Sep 5', dateStr: '2025-09-05', time: '10:00', event: 'Fed Chair Powell Speaks', speaker: 'Powell', duration: 42, sentiment: -0.05, direction: 'neutral', o: 4055.00, h: 4068.20, l: 4048.50, c: 4058.80 },
                    // August 2025
                    { date: 'Fri, Aug 22', dateStr: '2025-08-22', time: '10:00', event: 'Jackson Hole - Powell Speaks', speaker: 'Powell', duration: 65, sentiment: 0.35, direction: 'bullish', o: 3985.00, h: 4058.50, l: 3978.20, c: 4045.80 },
                    { date: 'Thu, Aug 7', dateStr: '2025-08-07', time: '14:30', event: 'FOMC Press Conference', speaker: 'Powell', duration: 50, sentiment: 0.12, direction: 'bullish', o: 3925.00, h: 3958.40, l: 3920.50, c: 3952.20 },
                    // July 2025
                    { date: 'Wed, Jul 30', dateStr: '2025-07-30', time: '14:30', event: 'FOMC Press Conference', speaker: 'Powell', duration: 55, sentiment: -0.18, direction: 'bearish', o: 3895.00, h: 3902.50, l: 3858.20, c: 3865.40 },
                    { date: 'Tue, Jul 15', dateStr: '2025-07-15', time: '11:00', event: 'Fed Chair Powell Speaks', speaker: 'Powell', duration: 40, sentiment: 0.10, direction: 'bullish', o: 3845.00, h: 3872.80, l: 3840.50, c: 3868.20 },
                  ];

                  return fedSpeeches.map((speech, idx) => {
                    const range = speech.h - speech.l;
                    const actualDir = speech.c > speech.o + 3 ? 'bullish' : speech.c < speech.o - 3 ? 'bearish' : 'neutral';
                    const isCorrect = speech.direction === actualDir || (speech.direction === 'neutral' && Math.abs(speech.c - speech.o) <= 3);
                    const sentimentColor = speech.sentiment > 0.1 ? '#00ff88' : speech.sentiment < -0.1 ? '#ff4466' : '#ffaa00';
                    const signalColor = speech.direction === 'bullish' ? '#00ff88' : speech.direction === 'bearish' ? '#ff4466' : '#ffaa00';
                    const speakerColor = speech.speaker === 'Powell' ? '#A78BFA' : speech.speaker === 'Trump' ? '#FF6B6B' : '#00aaff';

                    return (
                      <tr key={idx} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)', background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.01)' }}>
                        <td style={{ padding: '10px 8px', color: '#aaa', fontSize: 11, whiteSpace: 'nowrap' }}>{speech.date}</td>
                        <td style={{ padding: '10px 8px', color: '#fff', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{speech.time}</td>
                        <td style={{ padding: '10px 8px' }}>
                          <div style={{ color: '#fff', fontWeight: 500, fontSize: 12 }}>{speech.event}</div>
                          <div style={{ color: speakerColor, fontSize: 10, marginTop: 2 }}>{speech.speaker}</div>
                        </td>
                        <td style={{ padding: '10px 8px', textAlign: 'center', color: '#00aaff', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{speech.duration}m</td>
                        <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                          <div style={{ display: 'inline-flex', alignItems: 'center', gap: 4, padding: '3px 8px', borderRadius: 4, background: `${sentimentColor}15`, border: `1px solid ${sentimentColor}30` }}>
                            <span style={{ color: sentimentColor, fontWeight: 600, fontSize: 11 }}>{(speech.sentiment * 100).toFixed(0)}%</span>
                          </div>
                        </td>
                        <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                          <span style={{ color: signalColor, fontWeight: 600, fontSize: 11, display: 'inline-flex', alignItems: 'center', gap: 3 }}>
                            <span>{speech.direction === 'bullish' ? '‚ñ≤' : speech.direction === 'bearish' ? '‚ñº' : '‚óÜ'}</span>
                            {speech.direction.toUpperCase()}
                          </span>
                        </td>
                        <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                          <div style={{ fontSize: 9, fontFamily: "'JetBrains Mono', monospace", lineHeight: 1.4 }}>
                            <span style={{ color: '#888' }}>O:</span><span style={{ color: '#fff' }}>{speech.o.toFixed(0)}</span>
                            <span style={{ color: '#888', marginLeft: 4 }}>H:</span><span style={{ color: '#00ff88' }}>{speech.h.toFixed(0)}</span>
                            <br/>
                            <span style={{ color: '#888' }}>L:</span><span style={{ color: '#ff4466' }}>{speech.l.toFixed(0)}</span>
                            <span style={{ color: '#888', marginLeft: 4 }}>C:</span><span style={{ color: speech.c >= speech.o ? '#00ff88' : '#ff4466' }}>{speech.c.toFixed(0)}</span>
                          </div>
                        </td>
                        <td style={{ padding: '10px 8px', textAlign: 'right' }}>
                          <span style={{ color: '#FFD700', fontWeight: 600, fontFamily: "'JetBrains Mono', monospace", fontSize: 12 }}>
                            ${range.toFixed(2)}
                          </span>
                        </td>
                        <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                          <span style={{
                            display: 'inline-flex', alignItems: 'center', justifyContent: 'center',
                            width: 24, height: 24, borderRadius: '50%',
                            background: isCorrect ? 'rgba(0,255,136,0.15)' : 'rgba(255,68,102,0.15)',
                            color: isCorrect ? '#00ff88' : '#ff4466', fontSize: 12, fontWeight: 700
                          }}>
                            {isCorrect ? '‚úì' : '‚úó'}
                          </span>
                        </td>
                      </tr>
                    );
                  });
                })()}
              </tbody>
            </table>
          </div>
        </div>

        {/* Upcoming Fed Speeches */}
        <div style={{ marginBottom: 24 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
            <span style={{ color: '#ffaa00', fontSize: 12, fontWeight: 600 }}>üìÖ UPCOMING SPEECHES</span>
            <span style={{ color: '#666', fontSize: 11 }}>(Scheduled for Transcription)</span>
          </div>

          <div style={{ overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
              <thead>
                <tr style={{ borderBottom: '2px solid rgba(255,170,0,0.2)' }}>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>DATE</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>TIME (ET)</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>EVENT</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>EST. DURATION</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>STATUS</th>
                </tr>
              </thead>
              <tbody>
                {(() => {
                  const allUpcoming = [
                    // Upcoming speeches scheduled for transcription
                    { date: 'Fri, Feb 7', dateStr: '2026-02-07', time: '10:00', durationMin: 40, event: 'Fed Chair Powell Speaks', speaker: 'Powell', estDuration: '~40m' },
                    { date: 'Wed, Feb 12', dateStr: '2026-02-12', time: '15:00', durationMin: 30, event: 'U.S. President Trump Speaks', speaker: 'Trump', estDuration: '~30m' },
                    { date: 'Wed, Mar 19', dateStr: '2026-03-19', time: '14:30', durationMin: 55, event: 'FOMC Press Conference', speaker: 'Powell', estDuration: '~55m' },
                  ];

                  // Get current ET time
                  const now = new Date();
                  const etNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));

                  // Filter and determine status for each speech
                  const upcomingSpeeches = allUpcoming.map(speech => {
                    const [hours, minutes] = speech.time.split(':').map(Number);
                    const eventStart = new Date(speech.dateStr + 'T' + speech.time + ':00');
                    // Adjust for ET timezone
                    const eventStartET = new Date(eventStart.toLocaleString('en-US', { timeZone: 'America/New_York' }));
                    const eventEnd = new Date(eventStartET.getTime() + speech.durationMin * 60 * 1000);

                    // Determine status
                    let status = 'SCHEDULED';
                    let statusColor = '#A78BFA';
                    let statusBg = 'rgba(139,92,246,0.2)';

                    if (etNow >= eventStartET && etNow <= eventEnd) {
                      status = 'üî¥ LIVE';
                      statusColor = '#ff4466';
                      statusBg = 'rgba(255,68,102,0.3)';
                    } else if (etNow > eventEnd) {
                      status = 'ENDED';
                      statusColor = '#666';
                      statusBg = 'rgba(100,100,100,0.2)';
                    }

                    return { ...speech, status, statusColor, statusBg, eventEnd };
                  }).filter(speech => {
                    // Only show upcoming or currently live events (filter out ended)
                    return speech.status !== 'ENDED';
                  });

                  if (upcomingSpeeches.length === 0) {
                    return (
                      <tr><td colSpan="5" style={{ padding: 20, textAlign: 'center', color: '#666' }}>No upcoming speeches scheduled</td></tr>
                    );
                  }

                  return upcomingSpeeches.map((speech, idx) => {
                    const speakerColor = speech.speaker === 'Powell' ? '#A78BFA' : speech.speaker === 'Trump' ? '#FF6B6B' : '#00aaff';
                    return (
                      <tr key={idx} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)', background: speech.status === 'üî¥ LIVE' ? 'rgba(255,68,102,0.05)' : idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.01)' }}>
                        <td style={{ padding: '10px 8px', color: '#aaa', fontSize: 11, whiteSpace: 'nowrap' }}>{speech.date}</td>
                        <td style={{ padding: '10px 8px', color: '#fff', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{speech.time}</td>
                        <td style={{ padding: '10px 8px' }}>
                          <div style={{ color: '#fff', fontWeight: 500, fontSize: 12 }}>{speech.event}</div>
                          <div style={{ color: speakerColor, fontSize: 10, marginTop: 2 }}>{speech.speaker}</div>
                        </td>
                        <td style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{speech.estDuration}</td>
                        <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                          <span style={{ padding: '3px 8px', borderRadius: 4, fontSize: 9, fontWeight: 600, background: speech.statusBg, color: speech.statusColor, animation: speech.status === 'üî¥ LIVE' ? 'pulse 1.5s infinite' : 'none' }}>{speech.status}</span>
                        </td>
                      </tr>
                    );
                  });
                })()}
              </tbody>
            </table>
          </div>
        </div>

        {/* Deepgram Performance Summary */}
        {(() => {
          // Calculate from past speeches
          const fedSpeeches = [
            { sentiment: -0.08, direction: 'bearish', o: 4495.00, c: 4488.80 },
            { sentiment: 0.15, direction: 'bullish', o: 4425.00, c: 4448.60 },
            { sentiment: -0.12, direction: 'bearish', o: 4380.00, c: 4362.50 },
            { sentiment: 0.05, direction: 'neutral', o: 4320.00, c: 4322.40 },
            { sentiment: 0.22, direction: 'bullish', o: 4285.50, c: 4312.80 },
            { sentiment: 0.18, direction: 'bullish', o: 4245.00, c: 4268.90 },
            { sentiment: -0.15, direction: 'bearish', o: 4195.00, c: 4175.20 },
            { sentiment: 0.08, direction: 'bullish', o: 4150.00, c: 4162.50 },
            { sentiment: 0.28, direction: 'bullish', o: 4085.00, c: 4128.40 },
            { sentiment: -0.05, direction: 'neutral', o: 4055.00, c: 4058.80 },
            { sentiment: 0.35, direction: 'bullish', o: 3985.00, c: 4045.80 },
            { sentiment: 0.12, direction: 'bullish', o: 3925.00, c: 3952.20 },
            { sentiment: -0.18, direction: 'bearish', o: 3895.00, c: 3865.40 },
            { sentiment: 0.10, direction: 'bullish', o: 3845.00, c: 3868.20 },
          ];

          let correct = 0;
          let totalPts = 0;
          fedSpeeches.forEach(s => {
            const move = s.c - s.o;
            const actualDir = move > 3 ? 'bullish' : move < -3 ? 'bearish' : 'neutral';
            const isCorrect = s.direction === actualDir || (s.direction === 'neutral' && Math.abs(move) <= 3);
            if (isCorrect) {
              correct++;
              totalPts += Math.abs(move);
            }
          });

          const accuracy = Math.round((correct / fedSpeeches.length) * 100);
          const avgMove = (fedSpeeches.reduce((sum, s) => sum + Math.abs(s.c - s.o), 0) / fedSpeeches.length).toFixed(2);
          const dollarValue = Math.round(totalPts * 100);

          return (
            <div style={{
              background: 'linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(0,170,255,0.05) 100%)',
              border: '1px solid rgba(139,92,246,0.3)',
              borderRadius: 12, padding: 20, marginTop: 8
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
                <span style={{ fontSize: 18 }}>üìä</span>
                <span style={{ color: '#fff', fontSize: 14, fontWeight: 600 }}>Deepgram Speech Analysis ROI (6 Months)</span>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 16 }}>
                <div style={{ textAlign: 'center', padding: '12px 8px', background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                  <div style={{ color: '#888', fontSize: 10, marginBottom: 6 }}>SPEECHES</div>
                  <div style={{ color: '#fff', fontSize: 24, fontWeight: 700 }}>{fedSpeeches.length}</div>
                </div>
                <div style={{ textAlign: 'center', padding: '12px 8px', background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                  <div style={{ color: '#888', fontSize: 10, marginBottom: 6 }}>CORRECT</div>
                  <div style={{ color: '#00ff88', fontSize: 24, fontWeight: 700 }}>{correct}</div>
                </div>
                <div style={{ textAlign: 'center', padding: '12px 8px', background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                  <div style={{ color: '#888', fontSize: 10, marginBottom: 6 }}>ACCURACY</div>
                  <div style={{ color: accuracy >= 70 ? '#00ff88' : '#ffaa00', fontSize: 24, fontWeight: 700 }}>{accuracy}%</div>
                </div>
                <div style={{ textAlign: 'center', padding: '12px 8px', background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                  <div style={{ color: '#888', fontSize: 10, marginBottom: 6 }}>AVG MOVE</div>
                  <div style={{ color: '#00aaff', fontSize: 24, fontWeight: 700 }}>${avgMove}</div>
                </div>
                <div style={{ textAlign: 'center', padding: '12px 8px', background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                  <div style={{ color: '#888', fontSize: 10, marginBottom: 6 }}>$ VALUE</div>
                  <div style={{ color: '#FFD700', fontSize: 24, fontWeight: 700 }}>${dollarValue.toLocaleString()}</div>
                </div>
              </div>

              <div style={{ marginTop: 16, padding: '12px 16px', background: 'rgba(139,92,246,0.1)', borderRadius: 8, border: '1px solid rgba(139,92,246,0.2)' }}>
                <p style={{ color: '#aaa', fontSize: 11, margin: 0, lineHeight: 1.5 }}>
                  <span style={{ color: '#A78BFA', fontWeight: 600 }}>üí° VERDICT: {accuracy >= 70 ? 'KEEP DEEPGRAM' : 'MONITOR'}</span> -
                  At {accuracy}% accuracy on Fed speeches, capturing ${dollarValue.toLocaleString()} in value over 6 months.
                  <span style={{ color: '#888' }}> Note: Fed Chair position may change - monitor for new appointments.</span>
                </p>
              </div>
            </div>
          );
        })()}
      </div>

      {/* ============================================ */}
      {/* SECTION 2: RED FOLDER NEWS EVENTS (No Deepgram) */}
      {/* ============================================ */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        border: '1px solid rgba(255,68,102,0.3)',
        borderRadius: 16, padding: 24, marginTop: 24
      }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
          <h3 style={{ margin: 0, color: '#fff', fontSize: 18, display: 'flex', alignItems: 'center', gap: 10 }}>
            <span style={{ fontSize: 22 }}>üìä</span>
            Red Folder News Events
          </h3>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <span style={{ padding: '4px 10px', borderRadius: 6, background: 'rgba(255,68,102,0.2)', color: '#ff4466', fontSize: 10, fontWeight: 600 }}>
              HIGH IMPACT DATA RELEASES
            </span>
          </div>
        </div>
        <p style={{ color: '#666', fontSize: 12, margin: '0 0 20px 0' }}>
          Instant economic data releases ‚Ä¢ 30-minute candle OHLC at release time ‚Ä¢ No transcription (instant release)
        </p>

        {/* Past News Events This Month */}
        <div style={{ marginBottom: 24 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
            <span style={{ color: '#ff4466', fontSize: 12, fontWeight: 600 }}>‚úì PAST RELEASES</span>
            <span style={{ color: '#666', fontSize: 11 }}>
              ({new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York', month: 'long', year: 'numeric' })})
            </span>
          </div>

          <div style={{ overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
              <thead>
                <tr style={{ borderBottom: '2px solid rgba(255,68,102,0.2)' }}>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>DATE</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>TIME (ET)</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>EVENT</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>ACTUAL</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>FORECAST</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>30m OHLC</th>
                  <th style={{ padding: '10px 8px', textAlign: 'right', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>$ RANGE</th>
                </tr>
              </thead>
              <tbody>
                {(data.economic_calendar?.past || []).map((news, idx) => {
                  const impactColor = news.impact === 'high' || news.impact === 'critical' ? '#ff4466' : news.impact === 'medium' ? '#ffaa00' : '#888';
                  return (
                    <tr key={idx} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)', background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.01)' }}>
                      <td style={{ padding: '10px 8px', color: '#aaa', fontSize: 11, whiteSpace: 'nowrap' }}>{news.date}</td>
                      <td style={{ padding: '10px 8px', color: '#fff', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{news.time}</td>
                      <td style={{ padding: '10px 8px' }}>
                        <div style={{ color: '#fff', fontWeight: 500, fontSize: 12 }}>{news.event}</div>
                        <span style={{ padding: '2px 6px', borderRadius: 3, fontSize: 8, fontWeight: 600, background: `${impactColor}20`, color: impactColor, marginTop: 4, display: 'inline-block' }}>
                          {news.impact.toUpperCase()}
                        </span>
                      </td>
                      <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                        <span style={{ color: '#00aaff', fontWeight: 600, fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{news.actual || news.forecast}</span>
                      </td>
                      <td style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{news.forecast}</td>
                      <td style={{ padding: '10px 8px', textAlign: 'center', color: '#666', fontSize: 10 }}>--</td>
                      <td style={{ padding: '10px 8px', textAlign: 'right', color: '#666', fontSize: 10 }}>--</td>
                    </tr>
                  );
                })}
                {(!data.economic_calendar?.past || data.economic_calendar.past.length === 0) && (
                  <tr><td colSpan="7" style={{ padding: 20, textAlign: 'center', color: '#666' }}>No past events this month</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Upcoming News Events This Month */}
        <div style={{ marginBottom: 16 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
            <span style={{ color: '#ffaa00', fontSize: 12, fontWeight: 600 }}>üìÖ UPCOMING RELEASES</span>
            <span style={{ color: '#666', fontSize: 11 }}>
              ({data.economic_calendar?.current_month || new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York', month: 'long', year: 'numeric' })})
            </span>
            {data.economic_calendar?.last_updated && (
              <span style={{ color: '#444', fontSize: 9, marginLeft: 'auto' }}>
                Updated: {data.economic_calendar.last_updated}
              </span>
            )}
          </div>

          <div style={{ overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
              <thead>
                <tr style={{ borderBottom: '2px solid rgba(255,170,0,0.2)' }}>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>DATE</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>TIME (ET)</th>
                  <th style={{ padding: '10px 8px', textAlign: 'left', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>EVENT</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>FORECAST</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>PREVIOUS</th>
                  <th style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontWeight: 600, fontSize: 10, letterSpacing: 0.5 }}>IMPACT</th>
                </tr>
              </thead>
              <tbody>
                {(data.economic_calendar?.upcoming || []).map((news, idx) => {
                  const impactColor = news.impact === 'high' || news.impact === 'critical' ? '#ff4466' : news.impact === 'medium' ? '#ffaa00' : '#888';
                  const isToday = news.is_today;
                  return (
                    <tr key={idx} style={{
                      borderBottom: '1px solid rgba(255,255,255,0.05)',
                      background: isToday ? 'rgba(255,170,0,0.1)' : idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.01)'
                    }}>
                      <td style={{ padding: '10px 8px', color: isToday ? '#ffaa00' : '#aaa', fontSize: 11, whiteSpace: 'nowrap', fontWeight: isToday ? 600 : 400 }}>
                        {isToday && <span style={{ marginRight: 4 }}>‚óè</span>}{news.date}
                      </td>
                      <td style={{ padding: '10px 8px', color: '#fff', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{news.time}</td>
                      <td style={{ padding: '10px 8px' }}>
                        <div style={{ color: '#fff', fontWeight: 500, fontSize: 12 }}>{news.event}</div>
                      </td>
                      <td style={{ padding: '10px 8px', textAlign: 'center', color: '#00aaff', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{news.forecast}</td>
                      <td style={{ padding: '10px 8px', textAlign: 'center', color: '#888', fontFamily: "'JetBrains Mono', monospace", fontSize: 11 }}>{news.previous}</td>
                      <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                        <span style={{ padding: '3px 8px', borderRadius: 4, fontSize: 9, fontWeight: 700, background: `${impactColor}20`, color: impactColor }}>
                          {news.impact.toUpperCase()}
                        </span>
                      </td>
                    </tr>
                  );
                })}
                {(!data.economic_calendar?.upcoming || data.economic_calendar.upcoming.length === 0) && (
                  <tr><td colSpan="6" style={{ padding: 20, textAlign: 'center', color: '#666' }}>No upcoming events</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};

// Master Reset Button Component - Single comprehensive reset
const MasterResetButton = ({ onResetComplete }) => {
  const [isResetting, setIsResetting] = useState(false);
  const [status, setStatus] = useState(null);
  const [progress, setProgress] = useState('');

  const handleMasterReset = async () => {
    setIsResetting(true);
    setStatus(null);
    setProgress('Initiating full system reset...');

    try {
      // Step 1: Call the full reset endpoint
      setProgress('Stopping all connections...');
      const response = await fetch(`${API_BASE}/reset-connection`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (response.ok) {
        const data = await response.json();
        setProgress('Clearing state and reconnecting...');

        // Wait for backend to fully reset
        await new Promise(resolve => setTimeout(resolve, 2000));

        setProgress('Verifying connection...');

        // Verify connection is back
        let retries = 0;
        while (retries < 10) {
          try {
            const healthCheck = await fetch(`${API_BASE}`);
            if (healthCheck.ok) {
              const healthData = await healthCheck.json();
              if (healthData.data_source && healthData.data_source !== 'DISCONNECTED') {
                setStatus({ type: 'success', message: 'System reset complete! Live data restored.' });
                if (onResetComplete) onResetComplete();
                break;
              }
            }
          } catch (e) {}
          retries++;
          setProgress(`Waiting for connection... (${retries}/10)`);
          await new Promise(resolve => setTimeout(resolve, 1000));
        }

        if (retries >= 10) {
          setStatus({ type: 'warning', message: 'Reset complete. Connection may take a moment to establish.' });
        }
      } else {
        setStatus({ type: 'error', message: 'Failed to reset - backend may need manual restart' });
      }
    } catch (error) {
      setStatus({ type: 'error', message: 'Network error - check if backend is running on port 8080' });
    }

    setProgress('');
    setIsResetting(false);
  };

  return (
    <div>
      <button
        onClick={handleMasterReset}
        disabled={isResetting}
        style={{
          width: '100%',
          padding: '16px 24px',
          background: isResetting
            ? 'linear-gradient(135deg, #555 0%, #333 100%)'
            : 'linear-gradient(135deg, #ff4466 0%, #cc2244 100%)',
          border: 'none',
          borderRadius: 12,
          color: '#fff',
          fontSize: 15,
          fontWeight: 700,
          cursor: isResetting ? 'not-allowed' : 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: 10,
          transition: 'all 0.2s ease',
          boxShadow: isResetting ? 'none' : '0 4px 20px rgba(255,68,102,0.3)'
        }}
      >
        {isResetting ? (
          <>
            <span style={{ animation: 'spin 1s linear infinite' }}>‚ü≥</span>
            {progress || 'Resetting...'}
          </>
        ) : (
          <>
            üîÑ FULL SYSTEM RESET
          </>
        )}
      </button>

      {status && (
        <div style={{
          marginTop: 12,
          padding: '12px 16px',
          borderRadius: 8,
          background: status.type === 'success' ? 'rgba(0,255,136,0.15)' :
                      status.type === 'warning' ? 'rgba(255,170,0,0.15)' : 'rgba(255,68,102,0.15)',
          border: `1px solid ${status.type === 'success' ? '#00ff88' : status.type === 'warning' ? '#ffaa00' : '#ff4466'}`,
          color: status.type === 'success' ? '#00ff88' : status.type === 'warning' ? '#ffaa00' : '#ff4466',
          fontSize: 13,
          textAlign: 'center'
        }}>
          {status.type === 'success' ? '‚úì' : status.type === 'warning' ? '‚ö†' : '‚úó'} {status.message}
        </div>
      )}

      <div style={{ marginTop: 16, padding: 12, background: 'rgba(255,68,102,0.05)', borderRadius: 8, border: '1px solid rgba(255,68,102,0.1)' }}>
        <div style={{ fontSize: 11, color: '#ff6688', marginBottom: 8, fontWeight: 600 }}>THIS WILL:</div>
        <ul style={{ margin: 0, paddingLeft: 16, lineHeight: 1.8, fontSize: 11, color: '#888' }}>
          <li>Kill all active data connections</li>
          <li>Clear volume, delta, and TPO counters</li>
          <li>Reset session high/low tracking</li>
          <li>Restart Databento live feed</li>
          <li>Re-establish fresh connection</li>
        </ul>
      </div>
    </div>
  );
};

// Settings Panel Component
const SettingsPanel = ({ settings, onSettingsChange, trades = [], dateRange, connectionStatus, onResetConnection }) => {
  const [localSettings, setLocalSettings] = useState(settings);
  const [hasChanges, setHasChanges] = useState(false);
  const [isOptimizing, setIsOptimizing] = useState(false);
  const [optimizationResults, setOptimizationResults] = useState(null);

  const handleChange = (path, value) => {
    const newSettings = JSON.parse(JSON.stringify(localSettings));
    const keys = path.split('.');
    let obj = newSettings;
    for (let i = 0; i < keys.length - 1; i++) {
      obj = obj[keys[i]];
    }
    obj[keys[keys.length - 1]] = value;
    setLocalSettings(newSettings);
    setHasChanges(true);
  };

  const handleApply = () => {
    const entrySum = localSettings.entryTiers.tier1 + localSettings.entryTiers.tier2 + localSettings.entryTiers.tier3;
    const targetSum = localSettings.targetTiers.vwap + localSettings.targetTiers.ibMid + localSettings.targetTiers.ibHigh;
    
    if (Math.abs(entrySum - 100) > 0.1) {
      alert(`Entry Tier allocations must sum to 100%. Currently: ${entrySum}%`);
      return;
    }
    if (Math.abs(targetSum - 100) > 0.1) {
      alert(`Target Tier allocations must sum to 100%. Currently: ${targetSum}%`);
      return;
    }
    
    onSettingsChange(localSettings);
    setHasChanges(false);
  };

  const handleReset = () => {
    setLocalSettings(DEFAULT_SETTINGS);
    setHasChanges(true);
  };

  const entrySum = localSettings.entryTiers.tier1 + localSettings.entryTiers.tier2 + localSettings.entryTiers.tier3;
  const targetSum = localSettings.targetTiers.vwap + localSettings.targetTiers.ibMid + localSettings.targetTiers.ibHigh;

  return (
    <div style={styles.settingsPanel}>
      <div style={styles.settingsHeader}>
        <h2 style={styles.dashboardTitle}>‚öôÔ∏è Strategy Parameters</h2>
        <p style={styles.settingsSubtitle}>Adjust thresholds and allocations to see how analytics change</p>
      </div>

      <div style={styles.settingsGrid}>
        {/* Signal Thresholds */}
        <div style={styles.settingsCard}>
          <h3 style={styles.settingsCardTitle}>üìä Signal Thresholds</h3>
          
          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>Delta Threshold</label>
              <span style={styles.sliderValue}>{localSettings.deltaThreshold.toLocaleString()}</span>
            </div>
            <input
              type="range"
              min="-5000"
              max="-1000"
              step="100"
              value={localSettings.deltaThreshold}
              onChange={(e) => handleChange('deltaThreshold', parseInt(e.target.value))}
              style={styles.slider}
            />
            <div style={styles.sliderTicks}>
              <span>-5000</span>
              <span>-3000</span>
              <span>-1000</span>
            </div>
          </div>

          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>Buying Imbalance %</label>
              <span style={styles.sliderValue}>{localSettings.buyingImbalancePct}%</span>
            </div>
            <input
              type="range"
              min="200"
              max="600"
              step="25"
              value={localSettings.buyingImbalancePct}
              onChange={(e) => handleChange('buyingImbalancePct', parseInt(e.target.value))}
              style={styles.slider}
            />
            <div style={styles.sliderTicks}>
              <span>200%</span>
              <span>400%</span>
              <span>600%</span>
            </div>
          </div>

          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>Divergence Highlight Threshold</label>
              <span style={styles.sliderValue}>{localSettings.divergenceThreshold || 0}</span>
            </div>
            <input
              type="range"
              min="0"
              max="200"
              step="10"
              value={localSettings.divergenceThreshold || 0}
              onChange={(e) => handleChange('divergenceThreshold', parseInt(e.target.value))}
              style={styles.slider}
            />
            <div style={styles.sliderTicks}>
              <span>0 (All)</span>
              <span>100</span>
              <span>200</span>
            </div>
            <div style={{ fontSize: 10, color: '#666', marginTop: 4 }}>
              Delta divergence amount required for white glow on candles (0 = always highlight)
            </div>
          </div>
        </div>

        {/* Entry Tier Allocation */}
        <div style={styles.settingsCard}>
          <h3 style={styles.settingsCardTitle}>üéØ Entry Tier Allocation</h3>
          <p style={styles.allocationNote}>
            Total: <span style={{ color: Math.abs(entrySum - 100) < 0.1 ? '#00ff88' : '#ff4466' }}>{entrySum}%</span>
            {Math.abs(entrySum - 100) >= 0.1 && <span style={{ color: '#ff4466' }}> (must equal 100%)</span>}
          </p>
          
          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>Tier I (Feeler) ‚Ä¢ 8:45-9:20 ET</label>
              <span style={styles.sliderValue}>{localSettings.entryTiers.tier1}%</span>
            </div>
            <input
              type="range"
              min="0"
              max="100"
              step="5"
              value={localSettings.entryTiers.tier1}
              onChange={(e) => handleChange('entryTiers.tier1', parseInt(e.target.value))}
              style={styles.slider}
            />
          </div>

          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>Tier II (Builder) ‚Ä¢ 9:35-10:00 ET</label>
              <span style={styles.sliderValue}>{localSettings.entryTiers.tier2}%</span>
            </div>
            <input
              type="range"
              min="0"
              max="100"
              step="5"
              value={localSettings.entryTiers.tier2}
              onChange={(e) => handleChange('entryTiers.tier2', parseInt(e.target.value))}
              style={styles.slider}
            />
          </div>

          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>Tier III (Runner) ‚Ä¢ 10:15-10:45 ET</label>
              <span style={styles.sliderValue}>{localSettings.entryTiers.tier3}%</span>
            </div>
            <input
              type="range"
              min="0"
              max="100"
              step="5"
              value={localSettings.entryTiers.tier3}
              onChange={(e) => handleChange('entryTiers.tier3', parseInt(e.target.value))}
              style={styles.slider}
            />
          </div>

          <div style={styles.tierVisual}>
            <div style={{ ...styles.tierBar, width: `${localSettings.entryTiers.tier1}%`, background: '#00aaff' }} />
            <div style={{ ...styles.tierBar, width: `${localSettings.entryTiers.tier2}%`, background: '#00ff88' }} />
            <div style={{ ...styles.tierBar, width: `${localSettings.entryTiers.tier3}%`, background: '#ffaa00' }} />
          </div>
          <div style={styles.tierLegend}>
            <span><span style={{color: '#00aaff'}}>‚ñ†</span> Tier I</span>
            <span><span style={{color: '#00ff88'}}>‚ñ†</span> Tier II</span>
            <span><span style={{color: '#ffaa00'}}>‚ñ†</span> Tier III</span>
          </div>
        </div>

        {/* Target Tier Allocation */}
        <div style={styles.settingsCard}>
          <h3 style={styles.settingsCardTitle}>üèÜ Target Allocation</h3>
          <p style={styles.allocationNote}>
            Total: <span style={{ color: Math.abs(targetSum - 100) < 0.1 ? '#00ff88' : '#ff4466' }}>{targetSum}%</span>
            {Math.abs(targetSum - 100) >= 0.1 && <span style={{ color: '#ff4466' }}> (must equal 100%)</span>}
          </p>
          
          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>VWAP Target (88% historical hit rate)</label>
              <span style={styles.sliderValue}>{localSettings.targetTiers.vwap}%</span>
            </div>
            <input
              type="range"
              min="0"
              max="100"
              step="5"
              value={localSettings.targetTiers.vwap}
              onChange={(e) => handleChange('targetTiers.vwap', parseInt(e.target.value))}
              style={styles.slider}
            />
          </div>

          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>IB Mid Target (75% historical hit rate)</label>
              <span style={styles.sliderValue}>{localSettings.targetTiers.ibMid}%</span>
            </div>
            <input
              type="range"
              min="0"
              max="100"
              step="5"
              value={localSettings.targetTiers.ibMid}
              onChange={(e) => handleChange('targetTiers.ibMid', parseInt(e.target.value))}
              style={styles.slider}
            />
          </div>

          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>IB High Target (40% historical hit rate)</label>
              <span style={styles.sliderValue}>{localSettings.targetTiers.ibHigh}%</span>
            </div>
            <input
              type="range"
              min="0"
              max="100"
              step="5"
              value={localSettings.targetTiers.ibHigh}
              onChange={(e) => handleChange('targetTiers.ibHigh', parseInt(e.target.value))}
              style={styles.slider}
            />
          </div>

          <div style={styles.tierVisual}>
            <div style={{ ...styles.tierBar, width: `${localSettings.targetTiers.vwap}%`, background: '#00ff88' }} />
            <div style={{ ...styles.tierBar, width: `${localSettings.targetTiers.ibMid}%`, background: '#ffaa00' }} />
            <div style={{ ...styles.tierBar, width: `${localSettings.targetTiers.ibHigh}%`, background: '#ff4466' }} />
          </div>
          <div style={styles.tierLegend}>
            <span><span style={{color: '#00ff88'}}>‚ñ†</span> VWAP</span>
            <span><span style={{color: '#ffaa00'}}>‚ñ†</span> IB Mid</span>
            <span><span style={{color: '#ff4466'}}>‚ñ†</span> IB High</span>
          </div>
        </div>

        {/* Backtest Filters */}
        <div style={styles.settingsCard}>
          <h3 style={styles.settingsCardTitle}>üîç Backtest Filters</h3>
          <p style={styles.allocationNote}>Filter trades by grade, tier, and R-multiple</p>
          
          <div style={{ display: 'flex', gap: 16, marginBottom: 12 }}>
            <div style={{ flex: 1 }}>
              <label style={{ ...styles.sliderLabel, fontSize: 10 }}>Grade</label>
              <div style={{ display: 'flex', gap: 6, marginTop: 4 }}>
                {['A', 'B', 'C', 'F'].map(grade => (
                  <label key={grade} style={{ display: 'flex', alignItems: 'center', gap: 3, cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={localSettings.filters?.grades?.[grade] ?? true}
                      onChange={(e) => {
                        const newFilters = { ...localSettings.filters };
                        if (!newFilters.grades) newFilters.grades = { A: true, B: true, C: true, F: true };
                        newFilters.grades[grade] = e.target.checked;
                        handleChange('filters', newFilters);
                      }}
                      style={{ width: 14, height: 14 }}
                    />
                    <span style={{
                      color: grade === 'A' ? '#00ff88' : grade === 'B' ? '#ffaa00' : '#ff4466',
                      fontWeight: 600, fontSize: 11
                    }}>{grade}</span>
                  </label>
                ))}
              </div>
            </div>
            <div style={{ flex: 1 }}>
              <label style={{ ...styles.sliderLabel, fontSize: 10 }}>Tier</label>
              <div style={{ display: 'flex', gap: 6, marginTop: 4 }}>
                {[1, 2, 3].map(tier => (
                  <label key={tier} style={{ display: 'flex', alignItems: 'center', gap: 3, cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={localSettings.filters?.tiers?.[tier] ?? true}
                      onChange={(e) => {
                        const newFilters = { ...localSettings.filters };
                        if (!newFilters.tiers) newFilters.tiers = { 1: true, 2: true, 3: true };
                        newFilters.tiers[tier] = e.target.checked;
                        handleChange('filters', newFilters);
                      }}
                      style={{ width: 14, height: 14 }}
                    />
                    <span style={{
                      color: tier === 1 ? '#00aaff' : tier === 2 ? '#00ff88' : '#ffaa00',
                      fontWeight: 600, fontSize: 11
                    }}>{tier === 1 ? 'I' : tier === 2 ? 'II' : 'III'}</span>
                  </label>
                ))}
              </div>
            </div>
          </div>

          <div style={styles.sliderGroup}>
            <div style={styles.sliderHeader}>
              <label style={styles.sliderLabel}>Minimum R-Multiple</label>
              <span style={styles.sliderValue}>{(localSettings.filters?.minR ?? -10).toFixed(1)}R</span>
            </div>
            <input
              type="range"
              min="-10"
              max="5"
              step="0.5"
              value={localSettings.filters?.minR ?? -10}
              onChange={(e) => {
                const newFilters = { ...localSettings.filters, minR: parseFloat(e.target.value) };
                handleChange('filters', newFilters);
              }}
              style={styles.slider}
            />
            <div style={styles.sliderTicks}>
              <span>-10R (All)</span>
              <span>0R</span>
              <span>5R</span>
            </div>
          </div>
        </div>
      </div>

      <div style={styles.settingsActions}>
        <button 
          style={{ ...styles.actionButton, ...styles.resetButton }} 
          onClick={handleReset}
        >
          Reset to Defaults
        </button>
        <button 
          style={{ 
            ...styles.actionButton, 
            ...styles.applyButton,
            opacity: hasChanges ? 1 : 0.5,
            cursor: hasChanges ? 'pointer' : 'not-allowed'
          }} 
          onClick={handleApply}
          disabled={!hasChanges}
        >
          {hasChanges ? '‚úì Apply Changes & Recalculate' : 'No Changes'}
        </button>
      </div>

      {/* AI Optimizer Section */}
      <div style={{
        background: 'linear-gradient(135deg, rgba(138,43,226,0.1) 0%, rgba(75,0,130,0.05) 100%)',
        border: '2px solid rgba(138,43,226,0.3)',
        borderRadius: 16,
        padding: 24,
        marginBottom: 24
      }}>
        <h3 style={{ margin: '0 0 16px 0', color: '#9370DB', fontSize: 18 }}>
          ü§ñ Project Horizon AI Optimizer
        </h3>
        <p style={{ color: '#888', fontSize: 13, marginBottom: 20 }}>
          Analyzes {trades.length} trades from {dateRange?.start} to {dateRange?.end} to find optimal parameters.
        </p>
        
        <button
          style={{
            width: '100%',
            padding: '16px 32px',
            background: isOptimizing 
              ? 'linear-gradient(135deg, #666 0%, #444 100%)' 
              : 'linear-gradient(135deg, #9370DB 0%, #8B5CF6 100%)',
            border: 'none',
            borderRadius: 12,
            color: '#fff',
            fontSize: 16,
            fontWeight: 700,
            cursor: isOptimizing ? 'not-allowed' : 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 10
          }}
          disabled={isOptimizing || trades.length === 0}
          onClick={() => {
            if (trades.length === 0) {
              alert('No trades available to optimize. Please load trade data first.');
              return;
            }
            
            setIsOptimizing(true);
            setOptimizationResults(null);
            
            // AI Optimization Algorithm
            setTimeout(() => {
              // Test different parameter combinations
              const deltaThresholds = [-1500, -2000, -2500, -3000, -3500, -4000];
              const buyingImbalances = [300, 350, 400, 450, 500];
              
              let bestResult = {
                pnl: -Infinity,
                winRate: 0,
                settings: null,
                tradesUsed: 0
              };
              
              // Grid search optimization
              deltaThresholds.forEach(deltaThreshold => {
                buyingImbalances.forEach(buyingImbalance => {
                  // Filter trades based on these parameters
                  const filteredTrades = trades.filter(t => {
                    if (t.delta !== undefined && t.delta > deltaThreshold) return false;
                    if (t.buyingImbalance !== undefined && t.buyingImbalance < buyingImbalance) return false;
                    return true;
                  });
                  
                  if (filteredTrades.length > 0) {
                    const totalPnl = filteredTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                    const winners = filteredTrades.filter(t => (t.pnl || 0) > 0).length;
                    const winRate = (winners / filteredTrades.length) * 100;
                    
                    // Score: maximize PnL while maintaining decent win rate
                    const score = totalPnl * (winRate / 100);
                    
                    if (score > bestResult.pnl * (bestResult.winRate / 100) || 
                        (totalPnl > bestResult.pnl && winRate >= 50)) {
                      bestResult = {
                        pnl: totalPnl,
                        winRate: winRate,
                        tradesUsed: filteredTrades.length,
                        settings: {
                          deltaThreshold,
                          buyingImbalancePct: buyingImbalance
                        }
                      };
                    }
                  }
                });
              });
              
              // If no good result found, use defaults with current trades
              if (!bestResult.settings) {
                const totalPnl = trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                const winners = trades.filter(t => (t.pnl || 0) > 0).length;
                bestResult = {
                  pnl: totalPnl,
                  winRate: (winners / trades.length) * 100,
                  tradesUsed: trades.length,
                  settings: {
                    deltaThreshold: -2500,
                    buyingImbalancePct: 400
                  }
                };
              }
              
              // Optimize entry/target tiers based on trade outcomes
              const profitTrades = trades.filter(t => (t.pnl || 0) > 0);
              const avgR = profitTrades.length > 0 
                ? profitTrades.reduce((sum, t) => sum + (t.r || 0), 0) / profitTrades.length 
                : 1.5;
              
              // Adjust tiers based on average R
              let entryTiers = { tier1: 25, tier2: 40, tier3: 35 };
              let targetTiers = { vwap: 50, ibMid: 35, ibHigh: 15 };
              
              if (avgR > 2) {
                // High R trades - be more aggressive on runners
                entryTiers = { tier1: 20, tier2: 35, tier3: 45 };
                targetTiers = { vwap: 40, ibMid: 35, ibHigh: 25 };
              } else if (avgR < 1) {
                // Low R trades - take profits earlier
                entryTiers = { tier1: 30, tier2: 45, tier3: 25 };
                targetTiers = { vwap: 60, ibMid: 30, ibHigh: 10 };
              }
              
              setOptimizationResults({
                ...bestResult,
                entryTiers,
                targetTiers,
                avgR: avgR.toFixed(2),
                totalTrades: trades.length
              });
              setIsOptimizing(false);
            }, 1500); // Simulate processing time
          }}
        >
          {isOptimizing ? (
            <>
              <span style={{ animation: 'pulse 1s infinite' }}>‚è≥</span>
              <span>Optimizing...</span>
            </>
          ) : (
            <>
              <span>üöÄ</span>
              <span>Run AI Optimization</span>
            </>
          )}
        </button>
        
        {/* Optimization Results */}
        {optimizationResults && (
          <div style={{
            marginTop: 20,
            padding: 20,
            background: 'rgba(0,255,136,0.05)',
            border: '1px solid rgba(0,255,136,0.3)',
            borderRadius: 12
          }}>
            <h4 style={{ margin: '0 0 16px 0', color: '#00ff88', fontSize: 14 }}>
              ‚úì Optimization Complete
            </h4>
            
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 16 }}>
              <div style={{ padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                <div style={{ fontSize: 11, color: '#888' }}>PROJECTED P&L</div>
                <div style={{ fontSize: 20, fontWeight: 700, color: optimizationResults.pnl >= 0 ? '#00ff88' : '#ff4466' }}>
                  ${optimizationResults.pnl.toLocaleString()}
                </div>
              </div>
              <div style={{ padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                <div style={{ fontSize: 11, color: '#888' }}>WIN RATE</div>
                <div style={{ fontSize: 20, fontWeight: 700, color: optimizationResults.winRate >= 50 ? '#00ff88' : '#ffaa00' }}>
                  {optimizationResults.winRate.toFixed(1)}%
                </div>
              </div>
              <div style={{ padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                <div style={{ fontSize: 11, color: '#888' }}>TRADES USED</div>
                <div style={{ fontSize: 20, fontWeight: 700, color: '#fff' }}>
                  {optimizationResults.tradesUsed}/{optimizationResults.totalTrades}
                </div>
              </div>
              <div style={{ padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                <div style={{ fontSize: 11, color: '#888' }}>AVG R-MULTIPLE</div>
                <div style={{ fontSize: 20, fontWeight: 700, color: '#00aaff' }}>
                  {optimizationResults.avgR}R
                </div>
              </div>
            </div>
            
            <div style={{ fontSize: 12, color: '#aaa', marginBottom: 16 }}>
              <strong>Recommended Settings:</strong>
              <div style={{ marginTop: 8, display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                <div>Delta Threshold: <span style={{ color: '#9370DB' }}>{optimizationResults.settings.deltaThreshold.toLocaleString()}</span></div>
                <div>Buy Imbalance: <span style={{ color: '#9370DB' }}>{optimizationResults.settings.buyingImbalancePct}%</span></div>
                <div>Entry Tiers: <span style={{ color: '#9370DB' }}>{optimizationResults.entryTiers.tier1}/{optimizationResults.entryTiers.tier2}/{optimizationResults.entryTiers.tier3}</span></div>
                <div>Targets: <span style={{ color: '#9370DB' }}>{optimizationResults.targetTiers.vwap}/{optimizationResults.targetTiers.ibMid}/{optimizationResults.targetTiers.ibHigh}</span></div>
              </div>
            </div>
            
            <button
              style={{
                width: '100%',
                padding: '12px 20px',
                background: 'linear-gradient(135deg, #00ff88 0%, #00cc66 100%)',
                border: 'none',
                borderRadius: 8,
                color: '#000',
                fontSize: 14,
                fontWeight: 700,
                cursor: 'pointer'
              }}
              onClick={() => {
                // Apply optimized settings
                const newSettings = {
                  ...localSettings,
                  deltaThreshold: optimizationResults.settings.deltaThreshold,
                  buyingImbalancePct: optimizationResults.settings.buyingImbalancePct,
                  entryTiers: optimizationResults.entryTiers,
                  targetTiers: optimizationResults.targetTiers
                };
                setLocalSettings(newSettings);
                onSettingsChange(newSettings);
                setOptimizationResults(null);
                alert('‚úì Optimal settings applied!');
              }}
            >
              ‚úì Apply Optimal Settings
            </button>
          </div>
        )}
        
        <div style={{ marginTop: 12, fontSize: 11, color: '#666', textAlign: 'center' }}>
          Grid search optimization across Delta & Imbalance parameters
        </div>
      </div>

      {/* Timezone Setting */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        border: '1px solid rgba(255,255,255,0.1)',
        borderRadius: 16,
        padding: 24,
        marginBottom: 24
      }}>
        <h3 style={{ margin: '0 0 16px 0', color: '#fff', fontSize: 16 }}>
          üåç Timezone
        </h3>
        <div style={{ 
          padding: '14px 20px',
          background: 'rgba(0,170,255,0.1)',
          border: '1px solid rgba(0,170,255,0.3)',
          borderRadius: 10,
          color: '#00aaff',
          fontSize: 14,
          fontWeight: 500
        }}>
          üïê New York (ET) - Eastern Time
        </div>
        <div style={{ marginTop: 12, fontSize: 11, color: '#666' }}>
          All session times are displayed in Eastern Time (ET). Market hours: 6:00 PM - 5:00 PM ET (Sun-Fri)
        </div>
      </div>

      {/* Connection Status & System Reset Section */}
      <div style={{
        background: connectionStatus?.connected
          ? 'linear-gradient(135deg, rgba(0,255,136,0.05) 0%, rgba(0,200,100,0.02) 100%)'
          : 'linear-gradient(135deg, rgba(255,68,102,0.1) 0%, rgba(200,50,80,0.05) 100%)',
        border: `2px solid ${connectionStatus?.connected ? 'rgba(0,255,136,0.3)' : 'rgba(255,68,102,0.3)'}`,
        borderRadius: 16,
        padding: 24,
        marginBottom: 24
      }}>
        <h3 style={{ margin: '0 0 16px 0', color: connectionStatus?.connected ? '#00ff88' : '#ff4466', fontSize: 18 }}>
          {connectionStatus?.connected ? 'üü¢' : 'üî¥'} Live Data Connection
        </h3>

        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 20 }}>
          <div style={{ padding: 12, background: 'rgba(0,0,0,0.3)', borderRadius: 8 }}>
            <div style={{ fontSize: 10, color: '#666', marginBottom: 4 }}>STATUS</div>
            <div style={{
              fontSize: 14,
              fontWeight: 700,
              color: connectionStatus?.connected ? '#00ff88' : '#ff4466'
            }}>
              {connectionStatus?.connected ? 'LIVE' : 'OFFLINE'}
            </div>
          </div>
          <div style={{ padding: 12, background: 'rgba(0,0,0,0.3)', borderRadius: 8 }}>
            <div style={{ fontSize: 10, color: '#666', marginBottom: 4 }}>UPTIME</div>
            <div style={{
              fontSize: 14,
              fontWeight: 700,
              color: connectionStatus?.connected ? '#00aaff' : '#888'
            }}>
              {connectionStatus?.lastSuccessTime
                ? Math.floor((Date.now() - new Date(connectionStatus.lastSuccessTime).getTime()) / 1000) < 60
                  ? 'STABLE'
                  : 'RECONNECTING'
                : '--'}
            </div>
          </div>
          <div style={{ padding: 12, background: 'rgba(0,0,0,0.3)', borderRadius: 8 }}>
            <div style={{ fontSize: 10, color: '#666', marginBottom: 4 }}>ERRORS</div>
            <div style={{
              fontSize: 14,
              fontWeight: 700,
              color: connectionStatus?.errorCount > 0 ? '#ffaa00' : '#00ff88'
            }}>
              {connectionStatus?.errorCount || 0}
            </div>
          </div>
        </div>

        {connectionStatus?.lastError && (
          <div style={{
            padding: 12,
            background: 'rgba(255,68,102,0.1)',
            border: '1px solid rgba(255,68,102,0.2)',
            borderRadius: 8,
            marginBottom: 16
          }}>
            <div style={{ fontSize: 10, color: '#ff4466', marginBottom: 4 }}>LAST ERROR</div>
            <div style={{ fontSize: 12, color: '#ffaa00', fontFamily: 'monospace', wordBreak: 'break-all' }}>
              {connectionStatus.lastError}
            </div>
            {connectionStatus.reconnectAttempts > 0 && (
              <div style={{ fontSize: 10, color: '#888', marginTop: 8 }}>
                Auto-reconnect attempts: {connectionStatus.reconnectAttempts}
              </div>
            )}
          </div>
        )}

        {connectionStatus?.lastSuccessTime && (
          <div style={{ fontSize: 11, color: '#888', marginBottom: 16 }}>
            Last successful data: {new Date(connectionStatus.lastSuccessTime).toLocaleTimeString()}
          </div>
        )}

        {/* Single Master Reset Button */}
        <MasterResetButton onResetComplete={onResetConnection} />
      </div>

      <div style={styles.settingsInfo}>
        <h4 style={styles.infoTitle}>‚ÑπÔ∏è How Settings Affect Analytics</h4>
        <ul style={styles.infoList}>
          <li><strong>Delta Threshold:</strong> Trades with delta deeper than this value are considered valid setups</li>
          <li><strong>Buying Imbalance %:</strong> Minimum imbalance required for entry confirmation</li>
          <li><strong>Entry Tier Allocation:</strong> How position size is distributed across the three entry phases</li>
          <li><strong>Target Allocation:</strong> Distribution of profit-taking across the three target levels</li>
        </ul>
      </div>
    </div>
  );
};

// Stats Card Component - Memoized for performance
const StatsCard = memo(({ title, value, subtitle, trend, color }) => {
  const trendColor = trend > 0 ? '#00ff88' : trend < 0 ? '#ff4466' : '#888';
  const bgColor = color || 'rgba(255,255,255,0.03)';

  return (
    <div style={{ ...styles.statsCard, background: bgColor }}>
      <div style={styles.statsTitle}>{title}</div>
      <div style={styles.statsValue}>{value}</div>
      {subtitle && <div style={styles.statsSubtitle}>{subtitle}</div>}
      {trend !== undefined && (
        <div style={{ ...styles.statsTrend, color: trendColor }}>
          {trend > 0 ? '‚Üë' : trend < 0 ? '‚Üì' : '‚Üí'} {Math.abs(trend).toFixed(1)}%
        </div>
      )}
    </div>
  );
});

// Signal Matrix Component (for Live Dashboard)
const SignalMatrix = ({ metrics, settings }) => {
  const [hoveredSignal, setHoveredSignal] = useState(null);
  const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });

  const signals = [
    { 
      name: `Delta < ${settings.deltaThreshold?.toLocaleString() || '-2500'}`, 
      active: (metrics.delta_30m || 0) <= (settings.deltaThreshold || -2500), 
      critical: true,
      tooltip: (metrics.delta_30m || 0) <= (settings.deltaThreshold || -2500)
        ? `‚úì 30m delta (${(metrics.delta_30m || 0).toLocaleString()}) is below threshold (${(settings.deltaThreshold || -2500).toLocaleString()}), indicating strong selling pressure`
        : `‚úó 30m delta (${(metrics.delta_30m || 0).toLocaleString()}) is above threshold (${(settings.deltaThreshold || -2500).toLocaleString()}), not enough selling pressure`
    },
    {
      name: 'Outside IB',
      active: (
        ((metrics.current_price || 0) > (metrics.ib_high || 0) && (metrics.ib_high || 0) > 0) ||
        ((metrics.current_price || 0) < (metrics.ib_low || 999999) && (metrics.ib_low || 999999) < 999999)
      ),
      critical: true,
      tooltip: (() => {
        const price = metrics.current_price || 0;
        const ibHigh = metrics.ib_high || 0;
        const ibLow = metrics.ib_low || 999999;
        const aboveHigh = price > ibHigh && ibHigh > 0;
        const belowLow = price < ibLow && ibLow < 999999;
        if (aboveHigh) return `‚úì Price ($${price.toFixed(2)}) is ABOVE IB High ($${ibHigh.toFixed(2)}), potential breakout`;
        if (belowLow) return `‚úì Price ($${price.toFixed(2)}) is BELOW IB Low ($${ibLow.toFixed(2)}), potential breakdown`;
        return `‚úó Price ($${price.toFixed(2)}) is within IB range ($${ibLow.toFixed(2)} - $${ibHigh.toFixed(2)})`;
      })()
    },
    { 
      name: 'At pdPOC', 
      active: Math.abs((metrics.current_price || 0) - (metrics.pdpoc || 0)) <= 2.0 && (metrics.pdpoc || 0) > 0, 
      critical: false,
      tooltip: (Math.abs((metrics.current_price || 0) - (metrics.pdpoc || 0)) <= 2.0 && (metrics.pdpoc || 0) > 0)
        ? `‚úì Price is within $2 of previous day POC ($${(metrics.pdpoc || 0).toFixed(2)}), key support level`
        : `‚úó Price is $${Math.abs((metrics.current_price || 0) - (metrics.pdpoc || 0)).toFixed(2)} away from pdPOC ($${(metrics.pdpoc || 0).toFixed(2)})`
    },
    { 
      name: 'Absorption', 
      active: (metrics.absorption_ratio || 0) > 1.2, 
      critical: true,
      tooltip: (metrics.absorption_ratio || 0) > 1.2
        ? `‚úì Absorption ratio (${(metrics.absorption_ratio || 0).toFixed(2)}) > 1.2, buyers absorbing selling pressure`
        : `‚úó Absorption ratio (${(metrics.absorption_ratio || 0).toFixed(2)}) ‚â§ 1.2, not enough buying absorption`
    },
    { 
      name: `Buy Imb. ${settings.buyingImbalancePct || 400}%+`, 
      active: (metrics.buying_imbalance_pct || 0) >= (settings.buyingImbalancePct || 400), 
      critical: false,
      tooltip: (metrics.buying_imbalance_pct || 0) >= (settings.buyingImbalancePct || 400)
        ? `‚úì Buying imbalance (${(metrics.buying_imbalance_pct || 0)}%) meets threshold (${settings.buyingImbalancePct || 400}%)`
        : `‚úó Buying imbalance (${(metrics.buying_imbalance_pct || 0)}%) below threshold (${settings.buyingImbalancePct || 400}%)`
    },
    { 
      name: 'Stacked Imb. 3+', 
      active: (metrics.stacked_buy_imbalances || 0) >= 3, 
      critical: false,
      tooltip: (metrics.stacked_buy_imbalances || 0) >= 3
        ? `‚úì ${metrics.stacked_buy_imbalances || 0} stacked buy imbalances detected, strong buying interest`
        : `‚úó Only ${metrics.stacked_buy_imbalances || 0} stacked imbalances, need 3+ for confirmation`
    },
  ];

  const activeCount = signals.filter(s => s.active).length;

  const handleMouseEnter = (e, signal) => {
    const rect = e.target.getBoundingClientRect();
    setTooltipPos({ x: rect.left, y: rect.bottom + 8 });
    setHoveredSignal(signal);
  };

  const handleMouseLeave = () => {
    setHoveredSignal(null);
  };

  return (
    <div style={styles.signalMatrix}>
      <div style={styles.signalHeader}>
        <h3 style={styles.signalTitle}>Signal Matrix</h3>
        <div style={styles.signalCount}>
          <span style={{ color: activeCount >= 4 ? '#00ff88' : '#ffaa00' }}>
            {activeCount}/6 Active
          </span>
        </div>
      </div>
      <div style={styles.signalGrid}>
        {signals.map((signal, idx) => (
          <div
            key={idx}
            onMouseEnter={(e) => handleMouseEnter(e, signal)}
            onMouseLeave={handleMouseLeave}
            style={{
              ...styles.signalItem,
              background: signal.active
                ? 'linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,255,136,0.05) 100%)'
                : 'rgba(255,68,102,0.1)',
              borderColor: signal.active ? '#00ff88' : '#ff4466',
              cursor: 'help'
            }}
          >
            <div style={{
              ...styles.signalIndicator,
              background: signal.active ? '#00ff88' : '#ff4466',
              boxShadow: signal.active ? '0 0 10px #00ff88' : 'none'
            }} />
            <span style={styles.signalName}>{signal.name}</span>
            {signal.critical && <span style={styles.criticalBadge}>!</span>}
          </div>
        ))}
      </div>

      {/* Custom Tooltip Popup */}
      {hoveredSignal && (
        <div style={{
          position: 'fixed',
          left: tooltipPos.x,
          top: tooltipPos.y,
          background: 'rgba(20,20,30,0.98)',
          border: `2px solid ${hoveredSignal.active ? '#00ff88' : '#ff4466'}`,
          borderRadius: 12,
          padding: '14px 18px',
          maxWidth: 320,
          zIndex: 1000,
          boxShadow: '0 8px 32px rgba(0,0,0,0.5)'
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: 8,
            marginBottom: 8
          }}>
            <div style={{
              width: 12,
              height: 12,
              borderRadius: '50%',
              background: hoveredSignal.active ? '#00ff88' : '#ff4466',
              boxShadow: hoveredSignal.active ? '0 0 8px #00ff88' : 'none'
            }} />
            <span style={{ 
              color: hoveredSignal.active ? '#00ff88' : '#ff4466', 
              fontWeight: 700,
              fontSize: 14
            }}>
              {hoveredSignal.active ? 'CONDITION MET' : 'NOT MET'}
            </span>
            {hoveredSignal.critical && (
              <span style={{
                background: '#ff4466',
                color: '#000',
                padding: '2px 6px',
                borderRadius: 4,
                fontSize: 10,
                fontWeight: 700
              }}>CRITICAL</span>
            )}
          </div>
          <div style={{ color: '#ddd', fontSize: 13, lineHeight: 1.5 }}>
            {hoveredSignal.tooltip}
          </div>
        </div>
      )}

      <div style={styles.setupStatus}>
        <span style={styles.phaseLabel}>Current Phase:</span>
        <span style={{
          ...styles.phaseValue,
          color: metrics.current_phase?.includes('IB') ? '#00ff88' :
                 metrics.current_phase === 'POST_IB' ? '#ffaa00' :
                 metrics.current_phase === 'DISCONNECTED' ? '#ff4466' : '#888'
        }}>
          {metrics.current_phase}
        </span>
      </div>
    </div>
  );
};

// Year Drill Down Component
const YearDrillDown = ({ data, selectedYear, setSelectedYear }) => {
  if (data.yearly_pnl.length === 0) {
    return (
      <div style={styles.drillDownContainer}>
        <h3 style={styles.sectionTitle}>üìÖ Yearly Performance</h3>
        <p style={{ color: '#666', textAlign: 'center', padding: '40px' }}>No data available for selected date range</p>
      </div>
    );
  }

  return (
    <div style={styles.drillDownContainer}>
      <h3 style={styles.sectionTitle}>üìÖ Yearly Performance</h3>
      <div style={styles.yearGrid}>
        {data.yearly_pnl.map((year) => (
          <div
            key={year.year}
            style={{
              ...styles.yearCard,
              border: selectedYear === year.year ? '2px solid #00ff88' : '1px solid rgba(255,255,255,0.1)',
              background: selectedYear === year.year ? 'rgba(0,255,136,0.1)' : 'rgba(255,255,255,0.02)'
            }}
            onClick={() => setSelectedYear(year.year)}
          >
            <div style={styles.yearLabel}>{year.year}</div>
            <div style={{
              ...styles.yearPnl,
              color: year.pnl >= 0 ? '#00ff88' : '#ff4466'
            }}>
              ${year.pnl.toLocaleString()}
            </div>
            <div style={styles.yearStats}>
              <span>{year.trades} trades</span>
              <span style={{ color: '#00ff88' }}>{(year.win_rate * 100).toFixed(0)}% WR</span>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// ============================================
// P&L CALENDAR COMPONENT
// ============================================
const PnLCalendar = ({ trades, onDayClick }) => {
  const [currentMonth, setCurrentMonth] = useState(() => {
    // Start with the most recent trade month
    if (trades.length > 0) {
      const lastTrade = trades[trades.length - 1];
      const d = new Date(lastTrade.date);
      return { year: d.getFullYear(), month: d.getMonth() };
    }
    return { year: 2025, month: 11 }; // December 2025
  });
  const [hoveredDay, setHoveredDay] = useState(null);
  const [selectedDay, setSelectedDay] = useState(null);
  const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });

  // Group trades by date
  const tradesByDate = useMemo(() => {
    const map = {};
    trades.forEach(t => {
      if (!map[t.date]) map[t.date] = [];
      map[t.date].push(t);
    });
    return map;
  }, [trades]);

  // Get days in month
  const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
  const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

  const daysInMonth = getDaysInMonth(currentMonth.year, currentMonth.month);
  const firstDay = getFirstDayOfMonth(currentMonth.year, currentMonth.month);
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];

  // Navigate months
  const prevMonth = () => {
    setCurrentMonth(prev => {
      if (prev.month === 0) return { year: prev.year - 1, month: 11 };
      return { ...prev, month: prev.month - 1 };
    });
  };
  const nextMonth = () => {
    setCurrentMonth(prev => {
      if (prev.month === 11) return { year: prev.year + 1, month: 0 };
      return { ...prev, month: prev.month + 1 };
    });
  };

  // Generate calendar days
  const calendarDays = [];
  // Empty cells before first day
  for (let i = 0; i < firstDay; i++) {
    calendarDays.push({ day: null, date: null });
  }
  // Days of the month
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${currentMonth.year}-${String(currentMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayTrades = tradesByDate[dateStr] || [];
    const dayPnl = dayTrades.reduce((sum, t) => sum + t.pnl, 0);
    calendarDays.push({ 
      day, 
      date: dateStr, 
      trades: dayTrades, 
      pnl: dayPnl,
      hasTradeData: dayTrades.length > 0
    });
  }

  // Handle hover
  const handleMouseEnter = (e, dayData) => {
    if (dayData.hasTradeData) {
      const rect = e.target.getBoundingClientRect();
      setTooltipPos({ x: rect.left + rect.width / 2, y: rect.top - 10 });
      setHoveredDay(dayData);
    }
  };

  // Handle click
  const handleDayClick = (dayData) => {
    if (dayData.hasTradeData) {
      setSelectedDay(dayData);
      if (onDayClick) onDayClick(dayData);
    }
  };

  // Calculate monthly stats
  const monthlyStats = useMemo(() => {
    const monthTrades = trades.filter(t => {
      const d = new Date(t.date);
      return d.getFullYear() === currentMonth.year && d.getMonth() === currentMonth.month;
    });
    const pnl = monthTrades.reduce((sum, t) => sum + t.pnl, 0);
    const winners = monthTrades.filter(t => t.pnl > 0).length;
    return {
      trades: monthTrades.length,
      pnl,
      winRate: monthTrades.length > 0 ? (winners / monthTrades.length * 100).toFixed(0) : 0
    };
  }, [trades, currentMonth]);

  return (
    <div style={calendarStyles.container}>
      <div style={calendarStyles.header}>
        <h3 style={calendarStyles.title}>üìÜ Daily P&L Calendar</h3>
        <div style={calendarStyles.monthNav}>
          <button onClick={prevMonth} style={calendarStyles.navButton}>‚óÄ</button>
          <span style={calendarStyles.monthLabel}>
            {monthNames[currentMonth.month]} {currentMonth.year}
          </span>
          <button onClick={nextMonth} style={calendarStyles.navButton}>‚ñ∂</button>
        </div>
        <div style={calendarStyles.monthStats}>
          <span>{monthlyStats.trades} trades</span>
          <span style={{ color: monthlyStats.pnl >= 0 ? '#00ff88' : '#ff4466' }}>
            ${monthlyStats.pnl.toLocaleString()}
          </span>
          <span style={{ color: '#00ff88' }}>{monthlyStats.winRate}% WR</span>
        </div>
      </div>

      <div style={calendarStyles.weekdays}>
        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
          <div key={d} style={calendarStyles.weekday}>{d}</div>
        ))}
      </div>

      <div style={calendarStyles.grid}>
        {calendarDays.map((dayData, idx) => (
          <div
            key={idx}
            style={{
              ...calendarStyles.day,
              ...(dayData.day ? {} : calendarStyles.emptyDay),
              ...(dayData.hasTradeData ? {
                background: dayData.pnl >= 0 
                  ? `rgba(0, 255, 136, ${Math.min(0.4, Math.abs(dayData.pnl) / 50000 + 0.1)})`
                  : `rgba(255, 68, 102, ${Math.min(0.4, Math.abs(dayData.pnl) / 50000 + 0.1)})`,
                cursor: 'pointer',
                border: `1px solid ${dayData.pnl >= 0 ? '#00ff88' : '#ff4466'}`
              } : {}),
              ...(selectedDay?.date === dayData.date ? {
                border: '2px solid #fff',
                boxShadow: '0 0 15px rgba(0,255,136,0.5)'
              } : {})
            }}
            onMouseEnter={(e) => handleMouseEnter(e, dayData)}
            onMouseLeave={() => setHoveredDay(null)}
            onClick={() => dayData.day && handleDayClick(dayData)}
          >
            {dayData.day && (
              <>
                <span style={calendarStyles.dayNumber}>{dayData.day}</span>
                {dayData.hasTradeData && (
                  <span style={{
                    ...calendarStyles.dayPnl,
                    color: dayData.pnl >= 0 ? '#00ff88' : '#ff4466'
                  }}>
                    {dayData.pnl >= 0 ? '+' : ''}{(dayData.pnl / 1000).toFixed(1)}k
                  </span>
                )}
                {dayData.trades.length > 1 && (
                  <span style={calendarStyles.tradeCount}>{dayData.trades.length}</span>
                )}
              </>
            )}
          </div>
        ))}
      </div>

      {/* Tooltip */}
      {hoveredDay && hoveredDay.hasTradeData && (
        <div style={{
          ...calendarStyles.tooltip,
          left: tooltipPos.x,
          top: tooltipPos.y,
          transform: 'translate(-50%, -100%)'
        }}>
          <div style={calendarStyles.tooltipHeader}>
            {hoveredDay.date} ‚Ä¢ {hoveredDay.trades.length} trade(s)
          </div>
          {hoveredDay.trades.map((t, i) => (
            <div key={i} style={calendarStyles.tooltipTrade}>
              <div style={calendarStyles.tooltipRow}>
                <span>Grade {t.grade} ‚Ä¢ Tier {t.tier}</span>
                <span style={{ color: t.pnl >= 0 ? '#00ff88' : '#ff4466' }}>
                  ${t.pnl.toLocaleString()}
                </span>
              </div>
              <div style={calendarStyles.tooltipRow}>
                <span>Entry: ${t.entry.toFixed(2)}</span>
                <span>Exit: ${t.exit.toFixed(2)}</span>
              </div>
              <div style={calendarStyles.tooltipRow}>
                <span>Delta: {t.delta}</span>
                <span>Imb: {t.buyingImbalance}%</span>
              </div>
              <div style={calendarStyles.tooltipRow}>
                <span>Conditions: {t.grade === 'A' ? '6/6' : t.grade === 'B' ? '5/6' : '4/6'}</span>
                <span>{t.r > 0 ? '+' : ''}{t.r}R</span>
              </div>
            </div>
          ))}
          <div style={calendarStyles.tooltipFooter}>Click for full details</div>
        </div>
      )}

      {/* Selected Day Modal */}
      {selectedDay && selectedDay.hasTradeData && (
        <div style={calendarStyles.modalOverlay} onClick={() => setSelectedDay(null)}>
          <div style={calendarStyles.modal} onClick={e => e.stopPropagation()}>
            <div style={calendarStyles.modalHeader}>
              <h3>üìä Trade Details - {selectedDay.date}</h3>
              <button onClick={() => setSelectedDay(null)} style={calendarStyles.closeButton}>‚úï</button>
            </div>
            <div style={calendarStyles.modalContent}>
              {selectedDay.trades.map((trade, idx) => (
                <div key={idx} style={calendarStyles.tradeDetail}>
                  <div style={calendarStyles.tradeHeader}>
                    <span style={calendarStyles.tradeBadge}>Trade #{trade.id}</span>
                    <span style={{
                      ...calendarStyles.tradePnl,
                      color: trade.pnl >= 0 ? '#00ff88' : '#ff4466'
                    }}>
                      {trade.pnl >= 0 ? '+' : ''}${trade.pnl.toLocaleString()}
                    </span>
                  </div>
                  
                  <div style={calendarStyles.tradeSection}>
                    <h4>Entry & Exit</h4>
                    <div style={calendarStyles.tradeGrid}>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>Entry Price</span>
                        <span style={calendarStyles.tradeValue}>${trade.entry.toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>Exit Price</span>
                        <span style={calendarStyles.tradeValue}>${trade.exit.toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>Stop Loss</span>
                        <span style={calendarStyles.tradeValue}>${(trade.entry - 3.5).toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>R-Multiple</span>
                        <span style={{...calendarStyles.tradeValue, color: trade.r >= 0 ? '#00ff88' : '#ff4466'}}>
                          {trade.r > 0 ? '+' : ''}{trade.r}R
                        </span>
                      </div>
                    </div>
                  </div>

                  <div style={calendarStyles.tradeSection}>
                    <h4>Reference Levels</h4>
                    <div style={calendarStyles.tradeGrid}>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>IB High</span>
                        <span style={calendarStyles.tradeValue}>${(trade.levels?.ib_high || trade.entry + 15).toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>IB Low</span>
                        <span style={calendarStyles.tradeValue}>${(trade.levels?.ib_low || trade.entry - 10).toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>IB Mid</span>
                        <span style={calendarStyles.tradeValue}>${(trade.levels?.ib_mid || trade.entry + 2.5).toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>pdPOC</span>
                        <span style={calendarStyles.tradeValue}>${(trade.levels?.pdpoc || trade.entry - 5).toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>VWAP</span>
                        <span style={calendarStyles.tradeValue}>${(trade.levels?.vwap || trade.entry + 5).toFixed(2)}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>pd High</span>
                        <span style={calendarStyles.tradeValue}>${(trade.levels?.pd_high || trade.entry + 20).toFixed(2)}</span>
                      </div>
                    </div>
                  </div>

                  <div style={calendarStyles.tradeSection}>
                    <h4>Entry Criteria Met</h4>
                    <div style={calendarStyles.criteriaGrid}>
                      {[
                        { name: 'Price < IB Low', met: trade.entry < (trade.levels?.ib_low || trade.entry) },
                        { name: 'At pdPOC', met: trade.grade !== 'C' },
                        { name: `Delta Spike (${trade.delta})`, met: trade.delta < -2500 },
                        { name: 'Absorption Detected', met: trade.grade === 'A' },
                        { name: `Buying Imbalance (${trade.buyingImbalance}%)`, met: trade.buyingImbalance >= 400 },
                        { name: 'Stacked Imbalances', met: trade.grade === 'A' || trade.grade === 'B' },
                      ].map((criterion, i) => (
                        <div key={i} style={{
                          ...calendarStyles.criterion,
                          background: criterion.met ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,102,0.1)',
                          borderColor: criterion.met ? '#00ff88' : '#ff4466'
                        }}>
                          <span style={{
                            ...calendarStyles.criterionIcon,
                            color: criterion.met ? '#00ff88' : '#ff4466'
                          }}>
                            {criterion.met ? '‚úì' : '‚úó'}
                          </span>
                          <span style={calendarStyles.criterionName}>{criterion.name}</span>
                        </div>
                      ))}
                    </div>
                    <div style={calendarStyles.criteriaCount}>
                      Conditions Met: <strong>{trade.conditionsMet || (trade.grade === 'A' ? 6 : trade.grade === 'B' ? 5 : 4)}/6</strong>
                    </div>
                  </div>

                  <div style={calendarStyles.tradeSection}>
                    <h4>Trade Info</h4>
                    <div style={calendarStyles.tradeGrid}>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>Grade</span>
                        <span style={{
                          ...calendarStyles.tradeBadgeSmall,
                          background: trade.grade === 'A' ? '#00ff88' : trade.grade === 'B' ? '#ffaa00' : '#888'
                        }}>
                          {trade.grade}
                        </span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>Tier</span>
                        <span style={calendarStyles.tradeValue}>{trade.tier}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>Contracts</span>
                        <span style={calendarStyles.tradeValue}>{trade.contracts}</span>
                      </div>
                      <div style={calendarStyles.tradeItem}>
                        <span style={calendarStyles.tradeLabel}>Exit Reason</span>
                        <span style={calendarStyles.tradeValue}>
                          {trade.exitReason.replace('target_', '').replace('_', ' ').toUpperCase()}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            <div style={calendarStyles.modalFooter}>
              <span style={{color: selectedDay.pnl >= 0 ? '#00ff88' : '#ff4466'}}>
                Day Total: {selectedDay.pnl >= 0 ? '+' : ''}${selectedDay.pnl.toLocaleString()}
              </span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Calendar Styles - Compact & Aesthetic
const calendarStyles = {
  container: {
    background: 'linear-gradient(180deg, rgba(15,18,25,0.95) 0%, rgba(10,12,18,0.98) 100%)',
    borderRadius: 16,
    padding: 16,
    marginTop: 16,
    border: '1px solid rgba(255,255,255,0.08)',
    boxShadow: '0 4px 24px rgba(0,0,0,0.3)',
    maxWidth: 420,
  },
  header: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
    flexWrap: 'wrap',
    gap: 8,
  },
  title: {
    fontSize: 14,
    fontWeight: 600,
    color: '#fff',
    margin: 0,
  },
  monthNav: {
    display: 'flex',
    alignItems: 'center',
    gap: 8,
  },
  navButton: {
    background: 'rgba(255,255,255,0.08)',
    border: '1px solid rgba(255,255,255,0.1)',
    color: '#888',
    padding: '4px 8px',
    borderRadius: 4,
    cursor: 'pointer',
    fontSize: 11,
    transition: 'all 0.15s ease',
  },
  monthLabel: {
    fontSize: 13,
    fontWeight: 600,
    color: '#fff',
    minWidth: 110,
    textAlign: 'center',
  },
  monthStats: {
    display: 'flex',
    gap: 10,
    fontSize: 11,
    color: '#666',
  },
  weekdays: {
    display: 'grid',
    gridTemplateColumns: 'repeat(7, 1fr)',
    gap: 2,
    marginBottom: 4,
  },
  weekday: {
    textAlign: 'center',
    color: '#555',
    fontSize: 9,
    fontWeight: 600,
    padding: 4,
    letterSpacing: '0.5px',
  },
  grid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(7, 1fr)',
    gap: 2,
  },
  day: {
    aspectRatio: '1',
    display: 'flex',
    flexDirection: 'column',
    alignItems: 'center',
    justifyContent: 'center',
    borderRadius: 6,
    background: 'rgba(255,255,255,0.02)',
    border: '1px solid rgba(255,255,255,0.04)',
    position: 'relative',
    transition: 'all 0.15s ease',
    minHeight: 42,
    maxHeight: 50,
  },
  emptyDay: {
    background: 'transparent',
    border: 'none',
  },
  dayNumber: {
    fontSize: 11,
    color: '#777',
    fontWeight: 500,
  },
  dayPnl: {
    fontSize: 9,
    fontWeight: 600,
    marginTop: 1,
  },
  tradeCount: {
    position: 'absolute',
    top: 2,
    right: 2,
    background: 'rgba(0,170,255,0.9)',
    color: '#fff',
    fontSize: 8,
    fontWeight: 700,
    padding: '1px 4px',
    borderRadius: 8,
    lineHeight: 1.2,
  },
  tooltip: {
    position: 'fixed',
    background: 'rgba(20, 25, 35, 0.98)',
    border: '1px solid rgba(255,255,255,0.2)',
    borderRadius: 12,
    padding: 16,
    zIndex: 1000,
    minWidth: 280,
    maxWidth: 350,
    boxShadow: '0 10px 40px rgba(0,0,0,0.5)',
  },
  tooltipHeader: {
    fontSize: 14,
    fontWeight: 600,
    color: '#fff',
    marginBottom: 12,
    paddingBottom: 8,
    borderBottom: '1px solid rgba(255,255,255,0.1)',
  },
  tooltipTrade: {
    marginBottom: 12,
    paddingBottom: 12,
    borderBottom: '1px solid rgba(255,255,255,0.05)',
  },
  tooltipRow: {
    display: 'flex',
    justifyContent: 'space-between',
    fontSize: 12,
    color: '#aaa',
    marginBottom: 4,
  },
  tooltipFooter: {
    fontSize: 11,
    color: '#666',
    textAlign: 'center',
    marginTop: 8,
  },
  modalOverlay: {
    position: 'fixed',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    background: 'rgba(0,0,0,0.8)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 2000,
    padding: 20,
  },
  modal: {
    background: 'linear-gradient(180deg, #1a1f2e 0%, #0d1117 100%)',
    borderRadius: 16,
    maxWidth: 700,
    width: '100%',
    maxHeight: '90vh',
    overflow: 'hidden',
    border: '1px solid rgba(255,255,255,0.1)',
    boxShadow: '0 25px 80px rgba(0,0,0,0.6)',
  },
  modalHeader: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: '20px 24px',
    borderBottom: '1px solid rgba(255,255,255,0.1)',
    background: 'rgba(0,255,136,0.05)',
  },
  closeButton: {
    background: 'rgba(255,255,255,0.1)',
    border: 'none',
    color: '#fff',
    fontSize: 18,
    width: 36,
    height: 36,
    borderRadius: '50%',
    cursor: 'pointer',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
  },
  modalContent: {
    padding: 24,
    maxHeight: 'calc(90vh - 150px)',
    overflowY: 'auto',
  },
  modalFooter: {
    padding: '16px 24px',
    borderTop: '1px solid rgba(255,255,255,0.1)',
    textAlign: 'center',
    fontSize: 16,
    fontWeight: 600,
  },
  tradeDetail: {
    background: 'rgba(255,255,255,0.03)',
    borderRadius: 12,
    padding: 20,
    marginBottom: 16,
    border: '1px solid rgba(255,255,255,0.05)',
  },
  tradeHeader: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
    paddingBottom: 12,
    borderBottom: '1px solid rgba(255,255,255,0.1)',
  },
  tradeBadge: {
    background: 'rgba(0,170,255,0.2)',
    color: '#00aaff',
    padding: '4px 12px',
    borderRadius: 20,
    fontSize: 12,
    fontWeight: 600,
  },
  tradePnl: {
    fontSize: 20,
    fontWeight: 700,
  },
  tradeSection: {
    marginBottom: 16,
  },
  tradeGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(3, 1fr)',
    gap: 12,
    marginTop: 8,
  },
  tradeItem: {
    display: 'flex',
    flexDirection: 'column',
    gap: 4,
  },
  tradeLabel: {
    fontSize: 11,
    color: '#666',
    textTransform: 'uppercase',
  },
  tradeValue: {
    fontSize: 14,
    color: '#fff',
    fontWeight: 500,
  },
  tradeBadgeSmall: {
    display: 'inline-block',
    padding: '2px 8px',
    borderRadius: 4,
    fontSize: 12,
    fontWeight: 600,
    color: '#000',
  },
  criteriaGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(2, 1fr)',
    gap: 8,
    marginTop: 8,
  },
  criterion: {
    display: 'flex',
    alignItems: 'center',
    gap: 8,
    padding: '8px 12px',
    borderRadius: 8,
    border: '1px solid',
    fontSize: 12,
  },
  criterionIcon: {
    fontSize: 14,
    fontWeight: 700,
  },
  criterionName: {
    color: '#ccc',
  },
  criteriaCount: {
    marginTop: 12,
    textAlign: 'center',
    fontSize: 14,
    color: '#888',
  },
};

// Week Breakdown Component
const WeekBreakdown = ({ weeks, year }) => {
  const yearWeeks = weeks.filter(w => w.year === year);
  const maxPnl = Math.max(...yearWeeks.map(w => Math.abs(w.pnl)), 1);

  if (yearWeeks.length === 0) {
    return (
      <div style={styles.weekContainer}>
        <h3 style={styles.sectionTitle}>üìä Weekly Breakdown - {year}</h3>
        <p style={{ color: '#666', textAlign: 'center', padding: '40px' }}>No data for selected year</p>
      </div>
    );
  }

  return (
    <div style={styles.weekContainer}>
      <h3 style={styles.sectionTitle}>üìä Weekly Breakdown - {year}</h3>
      <div style={styles.weekGrid}>
        {yearWeeks.slice(0, 26).map((week, idx) => {
          const barHeight = (Math.abs(week.pnl) / maxPnl) * 100;
          return (
            <div key={idx} style={styles.weekBar}>
              <div style={styles.weekBarContainer}>
                <div style={{
                  ...styles.weekBarFill,
                  height: `${barHeight}%`,
                  background: week.pnl >= 0
                    ? 'linear-gradient(180deg, #00ff88 0%, #00cc66 100%)'
                    : 'linear-gradient(180deg, #ff4466 0%, #cc3355 100%)'
                }} />
              </div>
              <div style={styles.weekLabel}>W{week.week}</div>
              <div style={{
                ...styles.weekPnl,
                color: week.pnl >= 0 ? '#00ff88' : '#ff4466'
              }}>
                ${Math.abs(week.pnl / 1000).toFixed(0)}k
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// Trade Statistics Component
const TradeStatistics = ({ data }) => {
  const returnPct = data.summary.final_equity > 1000000 
    ? ((data.summary.final_equity - 1000000) / 1000000 * 100) 
    : -((1000000 - data.summary.final_equity) / 1000000 * 100);

  return (
    <div style={styles.statsContainer}>
      <h3 style={styles.sectionTitle}>üìà Performance Metrics</h3>
      <div style={styles.statsGrid}>
        <StatsCard
          title="Win Rate"
          value={`${(data.summary.win_rate * 100).toFixed(1)}%`}
          subtitle={`${data.summary.winners}W / ${data.summary.losers}L`}
          color="rgba(0,255,136,0.1)"
        />
        <StatsCard
          title="Total P&L"
          value={`$${Math.round(data.summary.total_pnl).toLocaleString()}`}
          subtitle={data.summary.pnl_difference && data.summary.pnl_difference !== 0 ? 
            `${data.summary.pnl_difference > 0 ? '+' : ''}$${Math.round(data.summary.pnl_difference).toLocaleString()} from allocation` : 
            "Net Profit"}
          trend={returnPct}
          color="rgba(0,255,136,0.1)"
        />
        <StatsCard
          title="Profit Factor"
          value={data.summary.profit_factor === Infinity ? '‚àû' : data.summary.profit_factor.toFixed(2)}
          subtitle="Gross Profit / Loss"
          color="rgba(255,170,0,0.1)"
        />
        <StatsCard
          title="Avg R-Multiple"
          value={`${data.summary.avg_r_multiple.toFixed(2)}R`}
          subtitle="Risk-Adjusted Return"
          color="rgba(0,170,255,0.1)"
        />
        <StatsCard
          title="Max Drawdown"
          value={`$${Math.round(data.summary.max_drawdown).toLocaleString()}`}
          subtitle={`${(data.summary.max_drawdown_pct * 100).toFixed(1)}%`}
          color="rgba(255,68,102,0.1)"
        />
        <StatsCard
          title="Final Equity"
          value={`$${Math.round(data.summary.final_equity).toLocaleString()}`}
          subtitle="Starting: $1,000,000"
          color="rgba(136,136,136,0.1)"
        />
      </div>

      <div style={styles.breakdownGrid}>
        <div style={styles.breakdownCard}>
          <h4 style={styles.breakdownTitle}>Exit Reasons</h4>
          {Object.entries(data.exit_reasons).map(([reason, count]) => (
            <div key={reason} style={styles.breakdownRow}>
              <span style={styles.breakdownLabel}>
                {reason.replace('_', ' ')}
              </span>
              <div style={styles.breakdownBarContainer}>
                <div style={{
                  ...styles.breakdownBar,
                  width: `${data.summary.total_trades > 0 ? (count / data.summary.total_trades) * 100 : 0}%`,
                  background: reason === 'STOP_LOSS' ? '#ff4466' : '#00ff88'
                }} />
              </div>
              <span style={styles.breakdownCount}>{count}</span>
            </div>
          ))}
        </div>

        <div style={styles.breakdownCard}>
          <h4 style={styles.breakdownTitle}>Grade Analysis</h4>
          {Object.entries(data.grade_stats).map(([grade, stats]) => (
            <div key={grade} style={styles.breakdownRow}>
              <span style={styles.breakdownLabel}>Grade {grade}</span>
              <div style={styles.gradeStats}>
                <span style={{ color: '#00ff88' }}>{(stats.win_rate * 100).toFixed(0)}% WR</span>
                <span style={{ color: stats.pnl >= 0 ? '#00ff88' : '#ff4466' }}>
                  ${(stats.pnl / 1000).toFixed(0)}k
                </span>
              </div>
            </div>
          ))}
        </div>

        <div style={styles.breakdownCard}>
          <h4 style={styles.breakdownTitle}>Tier Performance</h4>
          {Object.entries(data.tier_stats).map(([tier, stats]) => (
            <div key={tier} style={styles.breakdownRow}>
              <span style={styles.breakdownLabel}>{tier.replace('_', ' ')}</span>
              <div style={styles.gradeStats}>
                <span>{stats.trades} trades</span>
                <span style={{ color: '#00ff88' }}>{(stats.win_rate * 100).toFixed(0)}% WR</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// Analytics with Calendar wrapper
const AnalyticsWithCalendar = ({ data, trades, dateRange, setDateRange }) => {
  const returnPct = ((data.summary.final_equity - 1000000) / 1000000 * 100).toFixed(1);
  
  return (
    <div style={styles.analyticsContainer}>
      <div style={styles.analyticsHeader}>
        <h2 style={styles.analyticsTitle}>Underground Setup - Backtest Analytics</h2>
        <div style={styles.dateFilter}>
          <input
            type="date"
            value={dateRange.start}
            onChange={(e) => setDateRange(prev => ({ ...prev, start: e.target.value }))}
            style={styles.dateInput}
          />
          <span style={{ color: '#666' }}>to</span>
          <input
            type="date"
            value={dateRange.end}
            onChange={(e) => setDateRange(prev => ({ ...prev, end: e.target.value }))}
            style={styles.dateInput}
          />
          <button 
            onClick={() => setDateRange({ start: '2025-08-20', end: '2025-12-28' })}
            style={styles.resetButton}
          >
            Reset
          </button>
        </div>
      </div>

      <p style={styles.tradeInfo}>
        Showing {data.summary.total_trades} trades from {dateRange.start} to {dateRange.end}
      </p>

      {/* Performance Metrics */}
      <h3 style={styles.sectionTitle}>üìä Performance Metrics</h3>
      <div style={styles.statsGrid}>
        <StatsCard
          title="Win Rate"
          value={`${(data.summary.win_rate * 100).toFixed(1)}%`}
          subtitle={`${data.summary.winners}W / ${data.summary.losers}L`}
          color="rgba(0,255,136,0.1)"
        />
        <StatsCard
          title="Total P&L"
          value={`$${data.summary.total_pnl.toLocaleString()}`}
          subtitle="Net Profit"
          trend={returnPct}
          color="rgba(0,255,136,0.1)"
        />
        <StatsCard
          title="Profit Factor"
          value={data.summary.profit_factor === Infinity ? '‚àû' : data.summary.profit_factor.toFixed(2)}
          subtitle="Gross Profit / Loss"
          color="rgba(255,170,0,0.1)"
        />
        <StatsCard
          title="Avg R-Multiple"
          value={`${data.summary.avg_r_multiple.toFixed(2)}R`}
          subtitle="Risk-Adjusted Return"
          color="rgba(0,170,255,0.1)"
        />
        <StatsCard
          title="Max Drawdown"
          value={`$${data.summary.max_drawdown.toLocaleString()}`}
          subtitle={`${(data.summary.max_drawdown_pct * 100).toFixed(1)}%`}
          color="rgba(255,68,102,0.1)"
        />
        <StatsCard
          title="Final Equity"
          value={`$${data.summary.final_equity.toLocaleString()}`}
          subtitle="Starting: $1,000,000"
          color="rgba(136,136,136,0.1)"
        />
      </div>

      {/* Breakdown Cards */}
      <div style={styles.breakdownGrid}>
        <div style={styles.breakdownCard}>
          <h4 style={styles.breakdownTitle}>Exit Reasons</h4>
          {Object.entries(data.exit_reasons).map(([reason, count]) => (
            <div key={reason} style={styles.breakdownRow}>
              <span style={styles.breakdownLabel}>
                {reason.replace('_', ' ')}
              </span>
              <div style={styles.breakdownBarContainer}>
                <div style={{
                  ...styles.breakdownBar,
                  width: `${data.summary.total_trades > 0 ? (count / data.summary.total_trades) * 100 : 0}%`,
                  background: reason === 'STOP_LOSS' ? '#ff4466' : '#00ff88'
                }} />
              </div>
              <span style={styles.breakdownCount}>{count}</span>
            </div>
          ))}
        </div>

        <div style={styles.breakdownCard}>
          <h4 style={styles.breakdownTitle}>Grade Analysis</h4>
          {Object.entries(data.grade_stats).map(([grade, stats]) => (
            <div key={grade} style={styles.breakdownRow}>
              <span style={styles.breakdownLabel}>Grade {grade}</span>
              <div style={styles.gradeStats}>
                <span style={{ color: '#00ff88' }}>{(stats.win_rate * 100).toFixed(0)}% WR</span>
                <span style={{ color: stats.pnl >= 0 ? '#00ff88' : '#ff4466' }}>
                  ${(stats.pnl / 1000).toFixed(0)}k
                </span>
              </div>
            </div>
          ))}
        </div>

        <div style={styles.breakdownCard}>
          <h4 style={styles.breakdownTitle}>Tier Performance</h4>
          {Object.entries(data.tier_stats).map(([tier, stats]) => (
            <div key={tier} style={styles.breakdownRow}>
              <span style={styles.breakdownLabel}>{tier.replace('_', ' ')}</span>
              <div style={styles.gradeStats}>
                <span>{stats.trades} trades</span>
                <span style={{ color: '#00ff88' }}>{(stats.win_rate * 100).toFixed(0)}% WR</span>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* P&L Calendar */}
      <PnLCalendar trades={trades} />
    </div>
  );
};

// ============================================
// ZONE PARTICIPATION MACHINE
// ============================================
const ZoneParticipation = () => {
  const [zoneData, setZoneData] = useState(null);
  const [liveData, setLiveData] = useState(null);
  const [profileData, setProfileData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [showIntradayTPO, setShowIntradayTPO] = useState(false); // Collapsed by default
  const [showNonDiscAnalysis, setShowNonDiscAnalysis] = useState(false); // Non-Discretionary Analysis collapsed
  const [showDayBiasAnalysis, setShowDayBiasAnalysis] = useState(false); // Day Bias Analysis collapsed
  const [showTPOHTF, setShowTPOHTF] = useState(false); // TPO HTF Analysis collapsed
  const [priceLadderFloating, setPriceLadderFloating] = useState(true); // Price Ladder floating by default
  const { isMobile, isTablet } = useResponsive();

  useEffect(() => {
    const fetchAllData = async () => {
      try {
        // Cache-busting timestamp to prevent stale data
        const cacheBust = `_t=${Date.now()}`;
        const fetchOptions = { cache: 'no-store' };

        // Fetch all data in parallel
        // Note: Live data is at root endpoint /, not /live
        const [zonesRes, liveRes, profileRes] = await Promise.all([
          fetch(`${API_BASE}/zones?${cacheBust}`, fetchOptions),
          fetch(`${API_BASE}/?${cacheBust}`, fetchOptions),
          fetch(`${API_BASE}/market-profile?${cacheBust}`, fetchOptions)
        ]);

        if (zonesRes.ok) setZoneData(await zonesRes.json());
        if (liveRes.ok) {
          const liveJson = await liveRes.json();
          console.log('üì° LIVE DATA FROM BACKEND:', {
            contract: liveJson.contract,
            day_open: liveJson.day_open,
            weekly_open: liveJson.weekly_open,
            current_price: liveJson.current_price
          });
          setLiveData(liveJson);
        }
        if (profileRes.ok) setProfileData(await profileRes.json());
        setError(null);
      } catch (e) {
        setError('Connection error');
      }
      setLoading(false);
    };

    fetchAllData();
    const interval = setInterval(fetchAllData, 1000);
    return () => clearInterval(interval);
  }, []);

  // Volume Phase Detection - Calculate current market phase from volume data
  const volumePhase = useMemo(() => {
    if (!liveData) return { phase: '-', signal: 'neutral', description: 'No data' };

    // Get volume history from live data
    const volumeHistory = liveData.volume_5m?.history || liveData.volume_15m?.history || [];
    const currentPrice = liveData.current_price || 0;

    if (volumeHistory.length < 3) return { phase: '-', signal: 'neutral', description: 'Insufficient data' };

    const recentCandles = volumeHistory.slice(-10);
    const last3 = recentCandles.slice(-3);
    const last5 = recentCandles.slice(-5);

    // Current candle data
    const currentCandle = {
      price_close: currentPrice,
      price_high: liveData.session_high || currentPrice,
      price_low: liveData.session_low || currentPrice,
      buy: liveData.buy_volume || 0,
      sell: liveData.sell_volume || 0,
      delta: liveData.cumulative_delta || 0
    };

    // Phase A: Exhaustion & Absorption
    const deltas = last3.map(c => c.delta || 0);
    const volumes = last3.map(c => (c.buy || 0) + (c.sell || 0));
    const prices = last3.map(c => c.price_close || 0);

    const avgDelta = deltas.reduce((a, b) => a + b, 0) / 3;
    const deltaTrend = deltas[2] > deltas[1] && deltas[1] > deltas[0] ? 'increasing' :
                       deltas[2] < deltas[1] && deltas[1] < deltas[0] ? 'decreasing' : 'neutral';
    const volTrend = volumes[2] > volumes[1] ? 'increasing' : volumes[2] < volumes[1] ? 'decreasing' : 'neutral';

    const exhaustion = avgDelta < 0 && volTrend === 'decreasing' && Math.abs(deltas[2]) < Math.abs(deltas[0]);
    const priceHolds = prices.length >= 3 && prices[2] >= prices[0] - 2;
    const absorption = avgDelta < -10 && priceHolds && volumes[2] > 50;

    // Phase B: Micro Range & Initiation
    let microRange = null, initiation = false, vRecovery = false;
    if (last5.length >= 5) {
      const highs = last5.map(c => c.price_high || c.price_close || 0);
      const lows = last5.map(c => c.price_low || c.price_close || 0);
      const rangeHigh = Math.max(...highs);
      const rangeLow = Math.min(...lows);
      const rangeSize = rangeHigh - rangeLow;
      const avgPrice = last5.reduce((a, c) => a + (c.price_close || 0), 0) / 5;
      const isTightRange = rangeSize < avgPrice * 0.005;

      microRange = isTightRange ? { high: rangeHigh, low: rangeLow } : null;
      initiation = currentCandle.price_close > rangeHigh && isTightRange;

      const last3Deltas = last5.slice(-3).map(c => c.delta || 0);
      vRecovery = last3Deltas[0] < -50 && last3Deltas[2] > 50;
    }

    // Phase C: POC Migration & Imbalances
    const pocs = last3.map(c => ((c.price_high || c.price_close) + (c.price_low || c.price_close)) / 2);
    const pocMigration = pocs[2] > pocs[1] && pocs[1] > pocs[0] ? 'up' :
                         pocs[2] < pocs[1] && pocs[1] < pocs[0] ? 'down' : 'neutral';
    const imbalances = last3.filter(c => (c.buy || 0) > (c.sell || 0) * 1.5).length;
    const bullishClose = currentCandle.price_close > pocs[1] && currentCandle.delta > 0;

    // Determine current phase
    let phase = '-';
    let signal = 'neutral';
    let description = 'Scanning...';

    if (pocMigration === 'up' && imbalances >= 2 && bullishClose) {
      phase = 'C';
      signal = 'bullish';
      description = 'POC Migration Up - Strong Trend';
    } else if (initiation || vRecovery) {
      phase = 'B';
      signal = 'bullish';
      description = initiation ? 'Breakout Initiation' : 'V-Recovery';
    } else if (exhaustion || absorption) {
      phase = 'A';
      signal = 'preparing';
      description = exhaustion ? 'Seller Exhaustion' : 'Absorption Detected';
    } else if (pocMigration === 'down') {
      signal = 'bearish';
      description = 'POC Migrating Down';
    }

    // Calculate momentum score
    const momentumScore = Math.min(100, Math.max(0,
      50 + (avgDelta || 0) / 5 +
      (pocMigration === 'up' ? 20 : pocMigration === 'down' ? -20 : 0) +
      (imbalances * 10)
    ));

    return {
      phase,
      signal,
      description,
      momentumScore,
      deltaTrend,
      volTrend,
      exhaustion,
      absorption,
      initiation,
      vRecovery,
      pocMigration,
      imbalances
    };
  }, [liveData]);

  // Zone Card Component
  const ZoneCard = ({ zone, rank }) => {
    const statusColors = {
      approaching: '#ffaa00',
      at_zone: '#00ff88',
      watching: '#888',
      distant: '#555',
    };

    const readinessColor = zone.readiness?.overall_score >= 80 ? '#00ff88' :
                           zone.readiness?.overall_score >= 60 ? '#ffaa00' : '#ff4466';

    return (
      <div style={{
        background: 'rgba(20,20,28,0.95)',
        border: `2px solid ${rank === 1 ? '#00ff88' : 'rgba(255,255,255,0.1)'}`,
        borderRadius: isMobile ? 10 : 12,
        padding: isMobile ? 12 : 20,
        marginBottom: isMobile ? 12 : 16,
        overflow: 'hidden',
      }}>
        {/* Header */}
        <div style={{ display: 'flex', flexDirection: isMobile ? 'column' : 'row', justifyContent: 'space-between', gap: isMobile ? 10 : 0, marginBottom: isMobile ? 12 : 16 }}>
          <div>
            <span style={{
              background: rank === 1 ? '#00ff88' : '#ffaa00',
              color: '#000',
              padding: isMobile ? '3px 10px' : '4px 12px',
              borderRadius: 20,
              fontSize: isMobile ? 10 : 12,
              fontWeight: 700,
            }}>
              #{rank} PRIORITY
            </span>
            <h3 style={{ margin: '8px 0 0', color: '#fff', fontSize: isMobile ? 15 : 18 }}>
              {zone.name}
            </h3>
            <span style={{ color: '#888', fontSize: isMobile ? 10 : 12 }}>
              Session {zone.session_number} ‚Ä¢ {zone.type?.toUpperCase()}
            </span>
          </div>
          <div style={{ textAlign: isMobile ? 'left' : 'right', display: 'flex', flexDirection: isMobile ? 'row' : 'column', alignItems: isMobile ? 'center' : 'flex-end', gap: isMobile ? 12 : 0 }}>
            <div style={{ color: statusColors[zone.status] || '#888', fontSize: isMobile ? 11 : 14, fontWeight: 600 }}>
              {zone.status?.toUpperCase()}
            </div>
            <div style={{ color: '#fff', fontSize: isMobile ? 18 : 24, fontFamily: 'monospace', fontWeight: 700 }}>
              ${zone.price?.toFixed(2)}
            </div>
            <div style={{ color: zone.distance > 0 ? '#00ff88' : '#ff4466', fontSize: isMobile ? 11 : 14 }}>
              {zone.distance > 0 ? '+' : ''}{zone.distance?.toFixed(2)} pts
            </div>
          </div>
        </div>

        {/* Trade Framework */}
        {zone.trade && (
          <div style={{
            background: 'rgba(0,0,0,0.3)',
            borderRadius: 8,
            padding: isMobile ? 12 : 16,
            marginBottom: isMobile ? 12 : 16,
          }}>
            <div style={{ color: '#00aaff', fontSize: isMobile ? 10 : 12, marginBottom: 8, letterSpacing: 1 }}>
              TRADE FRAMEWORK
            </div>

            {/* Entry */}
            <div style={{ marginBottom: isMobile ? 8 : 12 }}>
              <span style={{ color: '#888', fontSize: isMobile ? 9 : 11 }}>ENTRY TRIGGER</span>
              <div style={{ color: '#fff', fontSize: isMobile ? 11 : 13 }}>{zone.trade.entry_trigger}</div>
            </div>

            {/* Targets */}
            <div style={{ display: 'flex', flexDirection: isMobile ? 'column' : 'row', gap: isMobile ? 8 : 20, marginBottom: isMobile ? 8 : 12 }}>
              <div>
                <span style={{ color: '#888', fontSize: isMobile ? 9 : 11 }}>TARGET 1</span>
                <div style={{ color: '#00ff88', fontSize: isMobile ? 11 : 14 }}>
                  {zone.trade.target1?.name}: ${zone.trade.target1?.price?.toFixed(2)}
                  <span style={{ color: '#888', marginLeft: 8, fontSize: isMobile ? 10 : 12 }}>+{zone.trade.target1?.pts?.toFixed(2)}pts</span>
                </div>
              </div>
              <div>
                <span style={{ color: '#888', fontSize: isMobile ? 9 : 11 }}>TARGET 2</span>
                <div style={{ color: '#00ff88', fontSize: isMobile ? 11 : 14 }}>
                  {zone.trade.target2?.name}: ${zone.trade.target2?.price?.toFixed(2)}
                  <span style={{ color: '#888', marginLeft: 8, fontSize: isMobile ? 10 : 12 }}>+{zone.trade.target2?.pts?.toFixed(2)}pts</span>
                </div>
              </div>
            </div>

            {/* Stop and R:R */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <span style={{ color: '#888', fontSize: isMobile ? 9 : 11 }}>STOP</span>
                <div style={{ color: '#ff4466', fontSize: isMobile ? 11 : 14 }}>
                  ${zone.trade.stop?.price?.toFixed(2)}
                  <span style={{ color: '#888', marginLeft: 8, fontSize: isMobile ? 10 : 12 }}>-{zone.trade.stop?.pts?.toFixed(2)}pts</span>
                </div>
              </div>
              <div style={{ textAlign: 'right' }}>
                <span style={{ color: '#888', fontSize: isMobile ? 9 : 11 }}>R:R</span>
                <div style={{ color: '#ffaa00', fontSize: isMobile ? 16 : 18, fontWeight: 700 }}>
                  {zone.trade.r_ratio}:1
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Setup Readiness Checklist */}
        {zone.readiness && (
          <div style={{
            background: readinessColor === '#00ff88' ? 'rgba(0,255,136,0.1)' :
                        readinessColor === '#ffaa00' ? 'rgba(255,170,0,0.1)' : 'rgba(255,68,102,0.1)',
            border: `1px solid ${readinessColor}`,
            borderRadius: 8,
            padding: isMobile ? 10 : 12,
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
              <span style={{ color: readinessColor, fontWeight: 600, fontSize: isMobile ? 11 : 14 }}>
                SETUP READINESS
              </span>
              <span style={{ color: readinessColor, fontWeight: 700, fontSize: isMobile ? 16 : 18 }}>
                {zone.readiness.overall_score}%
              </span>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr 1fr' : '1fr 1fr', gap: isMobile ? 3 : 4, fontSize: isMobile ? 9 : 11 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: zone.readiness.price_at_zone ? '#00ff88' : '#666' }}>
                <span>{zone.readiness.price_at_zone ? '‚úì' : '‚óã'}</span>
                <span>Price at Zone</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: zone.readiness.tpo_confirmation ? '#00ff88' : '#666' }}>
                <span>{zone.readiness.tpo_confirmation ? '‚úì' : '‚óã'}</span>
                <span>2+ TPO</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: zone.readiness.session_context ? '#00ff88' : '#666' }}>
                <span>{zone.readiness.session_context ? '‚úì' : '‚óã'}</span>
                <span>Session OK</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: zone.readiness.single_print_nearby ? '#00ff88' : '#666' }}>
                <span>{zone.readiness.single_print_nearby ? '‚úì' : '‚óã'}</span>
                <span>Single Print</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: zone.readiness.poc_alignment ? '#00ff88' : '#666' }}>
                <span>{zone.readiness.poc_alignment ? '‚úì' : '‚óã'}</span>
                <span>POC Align</span>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: zone.readiness.ib_intact ? '#00ff88' : '#666' }}>
                <span>{zone.readiness.ib_intact ? '‚úì' : '‚óã'}</span>
                <span>IB Intact</span>
              </div>
              {/* Volume Phase Signal - NEW */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: 4,
                color: volumePhase.signal === 'bullish' ? '#00ff88' :
                       volumePhase.signal === 'preparing' ? '#ffaa00' :
                       volumePhase.signal === 'bearish' ? '#ff4466' : '#666'
              }}>
                <span>{volumePhase.signal === 'bullish' || volumePhase.signal === 'preparing' ? '‚úì' : '‚óã'}</span>
                <span>{volumePhase.phase !== '-' ? `Phase ${volumePhase.phase}` : 'Vol Scan'}</span>
              </div>
              {/* Momentum Score */}
              <div style={{
                display: 'flex',
                alignItems: 'center',
                gap: 4,
                color: volumePhase.momentumScore >= 60 ? '#00ff88' :
                       volumePhase.momentumScore >= 40 ? '#ffaa00' : '#ff4466'
              }}>
                <span>{volumePhase.momentumScore >= 50 ? '‚úì' : '‚óã'}</span>
                <span>Momentum {Math.round(volumePhase.momentumScore || 50)}</span>
              </div>
            </div>

            {/* Volume Phase Details */}
            {volumePhase.phase !== '-' && (
              <div style={{
                marginTop: 8,
                padding: '6px 8px',
                background: volumePhase.signal === 'bullish' ? 'rgba(0,255,136,0.1)' :
                           volumePhase.signal === 'preparing' ? 'rgba(255,170,0,0.1)' :
                           volumePhase.signal === 'bearish' ? 'rgba(255,68,102,0.1)' : 'rgba(255,255,255,0.05)',
                borderRadius: 6,
                border: `1px solid ${volumePhase.signal === 'bullish' ? '#00ff8840' :
                                     volumePhase.signal === 'preparing' ? '#ffaa0040' :
                                     volumePhase.signal === 'bearish' ? '#ff446640' : '#ffffff20'}`
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <span style={{
                    fontSize: isMobile ? 9 : 10,
                    fontWeight: 600,
                    color: volumePhase.signal === 'bullish' ? '#00ff88' :
                           volumePhase.signal === 'preparing' ? '#ffaa00' :
                           volumePhase.signal === 'bearish' ? '#ff4466' : '#888'
                  }}>
                    PHASE {volumePhase.phase}: {volumePhase.description}
                  </span>
                  <span style={{
                    fontSize: isMobile ? 8 : 9,
                    color: '#666',
                    display: 'flex',
                    gap: 8
                  }}>
                    <span>Œî {volumePhase.deltaTrend === 'increasing' ? '‚Üë' : volumePhase.deltaTrend === 'decreasing' ? '‚Üì' : '‚Üí'}</span>
                    <span>Vol {volumePhase.volTrend === 'increasing' ? '‚Üë' : volumePhase.volTrend === 'decreasing' ? '‚Üì' : '‚Üí'}</span>
                    <span>POC {volumePhase.pocMigration === 'up' ? '‚Üë' : volumePhase.pocMigration === 'down' ? '‚Üì' : '‚Üí'}</span>
                  </span>
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  // Price Ladder Component - Visual representation of all zones
  // Shows levels ABOVE current price at TOP, current price in MIDDLE, levels BELOW at BOTTOM
  const ZonePriceLadder = ({ zones, buyZones, currentPrice, compact = false }) => {
    // Split and sort zones: above price (high to low), below price (high to low)
    const zonesAbove = [...(zones || [])].filter(z => z.price > currentPrice).sort((a, b) => b.price - a.price);
    const zonesBelow = [...(zones || [])].filter(z => z.price <= currentPrice).sort((a, b) => b.price - a.price);

    // Find buy zone IDs for highlighting
    const buyZoneIds = new Set((buyZones || []).map(z => z.id));

    // Get zone type colors
    const getZoneColor = (zone) => {
      if (zone.type === 'ib_high') return '#ffaa00';
      if (zone.type === 'ib_low') return '#00ff88';
      if (zone.type === 'poc') return '#9370DB';
      if (zone.type === 'vah') return '#ff6b6b';
      if (zone.type === 'val') return '#4ECDC4';
      return '#888';
    };

    // Get trade status
    const getTradeStatus = (zone) => {
      const isBuyZone = buyZoneIds.has(zone.id);
      if (!isBuyZone) return null;

      if (zone.status === 'at_zone') return { label: 'TRIGGERED', color: '#00ff88', bg: 'rgba(0,255,136,0.15)' };
      if (zone.status === 'approaching') return { label: 'APPROACHING', color: '#ffaa00', bg: 'rgba(255,170,0,0.15)' };
      return { label: 'VALID', color: '#00aaff', bg: 'rgba(0,170,255,0.1)' };
    };

    // Find the buy zone rank
    const getBuyZoneRank = (zone) => {
      const idx = (buyZones || []).findIndex(bz => bz.id === zone.id);
      return idx >= 0 ? idx + 1 : null;
    };

    // Render a single zone row
    const renderZoneRow = (zone) => {
      const tradeStatus = getTradeStatus(zone);
      const buyRank = getBuyZoneRank(zone);
      const isAbovePrice = zone.price > currentPrice;
      const distance = zone.price - currentPrice;
      const isAtPrice = Math.abs(distance) <= 2;

      return (
        <div
          key={zone.id}
          style={{
            display: 'flex',
            alignItems: 'center',
            padding: '6px 12px',
            margin: '2px 8px',
            borderRadius: 6,
            background: isAtPrice
              ? 'rgba(0,255,136,0.1)'
              : tradeStatus
                ? tradeStatus.bg
                : 'transparent',
            borderLeft: `3px solid ${getZoneColor(zone)}`,
            transition: 'background 0.2s',
          }}
        >
          {/* Left: Zone Info */}
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
              {buyRank && (
                <span style={{
                  background: buyRank === 1 ? '#00ff88' : buyRank === 2 ? '#ffaa00' : '#00aaff',
                  color: '#000',
                  fontSize: 9,
                  fontWeight: 700,
                  padding: '1px 5px',
                  borderRadius: 3,
                }}>
                  #{buyRank}
                </span>
              )}
              <span style={{
                color: '#fff',
                fontSize: 11,
                fontWeight: buyRank ? 600 : 400,
                whiteSpace: 'nowrap',
                overflow: 'hidden',
                textOverflow: 'ellipsis',
              }}>
                {zone.name}
              </span>
            </div>
            {tradeStatus && (
              <span style={{
                fontSize: 9,
                color: tradeStatus.color,
                fontWeight: 600,
                letterSpacing: 0.5,
              }}>
                {tradeStatus.label}
              </span>
            )}
          </div>

          {/* Right: Price & Distance */}
          <div style={{ textAlign: 'right', flexShrink: 0 }}>
            <div style={{
              color: '#fff',
              fontSize: 12,
              fontFamily: 'monospace',
              fontWeight: isAtPrice ? 700 : 400,
            }}>
              {zone.price?.toFixed(2)}
            </div>
            <div style={{
              fontSize: 10,
              fontFamily: 'monospace',
              color: isAbovePrice ? '#ff4466' : '#00ff88',
            }}>
              {isAbovePrice ? '+' : ''}{distance?.toFixed(1)}
            </div>
          </div>
        </div>
      );
    };

    return (
      <div style={{
        background: 'rgba(20,20,28,0.95)',
        borderRadius: 12,
        border: '1px solid rgba(255,255,255,0.08)',
        height: '100%',
        display: 'flex',
        flexDirection: 'column',
      }}>
        {/* Header */}
        <div style={{
          padding: '12px 16px',
          borderBottom: '1px solid rgba(255,255,255,0.08)',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
        }}>
          <span style={{ color: '#888', fontSize: 11, letterSpacing: 1 }}>PRICE LADDER</span>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <span style={{ color: '#ff4466', fontSize: 10 }}>{zonesAbove.length} above</span>
            <span style={{ color: '#666' }}>|</span>
            <span style={{ color: '#00ff88', fontSize: 10 }}>{zonesBelow.length} below</span>
          </div>
        </div>

        {/* Ladder */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '8px 0' }}>
          {/* Zones ABOVE current price (resistance levels) */}
          {zonesAbove.map(zone => renderZoneRow(zone))}

          {/* Current Price Row */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '10px 12px',
            margin: '8px',
            borderRadius: 8,
            background: 'linear-gradient(90deg, rgba(0,255,136,0.2) 0%, rgba(0,255,136,0.05) 50%, rgba(0,255,136,0.2) 100%)',
            border: '1px solid rgba(0,255,136,0.4)',
            position: 'relative',
          }}>
            <div style={{
              position: 'absolute',
              left: 12,
              display: 'flex',
              alignItems: 'center',
              gap: 4,
            }}>
              <div style={{
                width: 8,
                height: 8,
                borderRadius: '50%',
                background: '#00ff88',
                animation: 'pulse 1.5s ease-in-out infinite',
                boxShadow: '0 0 8px rgba(0,255,136,0.6)',
              }} />
              <span style={{ color: '#00ff88', fontSize: 10, fontWeight: 600 }}>LIVE</span>
            </div>
            <span style={{
              color: '#00ff88',
              fontSize: 16,
              fontFamily: 'monospace',
              fontWeight: 700,
              textShadow: '0 0 10px rgba(0,255,136,0.5)',
            }}>
              ${currentPrice?.toFixed(2)}
            </span>
            <span style={{
              position: 'absolute',
              right: 12,
              color: '#888',
              fontSize: 10,
            }}>
              CURRENT
            </span>
          </div>

          {/* Zones BELOW current price (support levels) */}
          {zonesBelow.map(zone => renderZoneRow(zone))}
        </div>

        {/* Legend */}
        <div style={{
          padding: '10px 12px',
          borderTop: '1px solid rgba(255,255,255,0.08)',
          display: 'flex',
          flexWrap: 'wrap',
          gap: 8,
          fontSize: 9,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <div style={{ width: 8, height: 8, background: '#ffaa00', borderRadius: 1 }} />
            <span style={{ color: '#666' }}>IB High</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <div style={{ width: 8, height: 8, background: '#00ff88', borderRadius: 1 }} />
            <span style={{ color: '#666' }}>IB Low</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <div style={{ width: 8, height: 8, background: '#9370DB', borderRadius: 1 }} />
            <span style={{ color: '#666' }}>POC</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <div style={{ width: 8, height: 8, background: '#ff6b6b', borderRadius: 1 }} />
            <span style={{ color: '#666' }}>VAH</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <div style={{ width: 8, height: 8, background: '#4ECDC4', borderRadius: 1 }} />
            <span style={{ color: '#666' }}>VAL</span>
          </div>
        </div>
      </div>
    );
  };

  if (loading) {
    return (
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: '#888' }}>
        Loading zones...
      </div>
    );
  }

  if (error || !zoneData) {
    return (
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: '#ff4466' }}>
        {error || 'No zone data available'}
      </div>
    );
  }

  return (
    <div style={{
      display: 'flex',
      flexDirection: isMobile ? 'column' : 'row',
      gap: isMobile ? 12 : 20,
      padding: isMobile ? 12 : 20,
      height: isMobile ? 'auto' : '100%',
      overflow: isMobile ? 'auto' : 'hidden',
      position: 'relative'
    }}>
      {/* Floating Price Indicator - Shows live price, click to dock full ladder */}
      {priceLadderFloating && !isMobile && (
        <div
          onClick={() => setPriceLadderFloating(false)}
          style={{
            position: 'fixed',
            top: 80,
            right: 20,
            background: 'rgba(15, 15, 25, 0.98)',
            borderRadius: 10,
            border: '1px solid rgba(0, 255, 136, 0.4)',
            boxShadow: '0 4px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 255, 136, 0.15)',
            zIndex: 1000,
            cursor: 'pointer',
            transition: 'all 0.2s ease',
            padding: '12px 16px'
          }}
          title="Click to show Price Ladder"
        >
          <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 6 }}>LIVE PRICE</div>
          <div style={{
            fontSize: 22,
            fontWeight: 700,
            color: '#00ff88',
            fontFamily: "'JetBrains Mono', monospace"
          }}>
            ${zoneData?.current_price?.toFixed(2) || '--'}
          </div>
          <div style={{ fontSize: 9, color: '#666', marginTop: 6 }}>Click for ladder ‚Üí</div>
        </div>
      )}

      {/* Left: Top 3 Buy Zones - Full width when Price Ladder is floating */}
      <div style={{ flex: isMobile ? 'none' : (priceLadderFloating ? 1 : 2), overflowY: isMobile ? 'visible' : 'auto' }}>
        <div style={{
          display: 'flex',
          flexDirection: isMobile ? 'column' : 'row',
          justifyContent: 'space-between',
          alignItems: isMobile ? 'flex-start' : 'center',
          gap: isMobile ? 8 : 0,
          marginBottom: isMobile ? 12 : 16
        }}>
          <h2 style={{ color: '#fff', margin: 0, fontSize: isMobile ? 16 : 24 }}>
            {isMobile ? '10pt Buy Setup' : 'Zone Participation - 10pt Buy Setup'}
          </h2>
        </div>

        {/* Comprehensive Signal Engine */}
        {(() => {
          const price = zoneData?.current_price || liveData?.current_price || 0;
          const zones = zoneData?.all_zones || [];

          // === SIGNAL ENGINE ANALYSIS ===
          const signals = {
            monthly: { bias: 'NEUTRAL', color: '#ffaa00' },
            weekly: { bias: 'NEUTRAL', color: '#ffaa00' },
            // Open price relative analysis
            dayOpen: { position: '--', diff: 0, color: '#888' },
            weeklyOpen: { position: '--', diff: 0, color: '#888' },
            daily: {
              ib: { level: '--', color: '#888' },
              pvaLocation: { status: '--', detail: '', color: '#888' },
              opening: { type: '--', color: '#888' }
            },
            critical: {
              abOverlap: { pct: '--', color: '#888' },
              buyingTail: false,
              sellingTail: false,
              tpoBias: { direction: '--', color: '#888' }
            }
          };

          // 1. WEEKLY BIAS - Multi-factor: Week H/L, Weekly Open, PD Range
          if (liveData) {
            const pdHigh = liveData.pd_high || 0;
            const pdLow = liveData.pd_low || 0;
            const pdMid = (pdHigh + pdLow) / 2;
            const pdRange = pdHigh - pdLow;

            // Week levels from backend
            const weekHigh = liveData.week_high || 0;
            const weekLow = liveData.week_low || 0;
            const weeklyOpen = liveData.weekly_open || 0;
            const weekRange = weekHigh - weekLow;
            const weekMid = (weekHigh + weekLow) / 2;

            // Robust Weekly Bias Calculation
            // Factors: Position in week range, position vs weekly open, position vs PD
            let weeklyScore = 0;
            let weeklyFactors = [];

            if (weekHigh > 0 && weekLow > 0 && weekRange > 0) {
              // Factor 1: Position in Week Range (weight: 40%)
              const weekPosPercent = ((price - weekLow) / weekRange) * 100;
              if (weekPosPercent >= 90) { weeklyScore += 40; weeklyFactors.push('Near Week High'); }
              else if (weekPosPercent >= 70) { weeklyScore += 30; weeklyFactors.push('Upper Week Range'); }
              else if (weekPosPercent <= 10) { weeklyScore -= 40; weeklyFactors.push('Near Week Low'); }
              else if (weekPosPercent <= 30) { weeklyScore -= 30; weeklyFactors.push('Lower Week Range'); }
              else { weeklyFactors.push('Mid Week Range'); }

              // Factor 2: Position vs Weekly Open (weight: 35%)
              if (weeklyOpen > 0) {
                const distFromOpen = price - weeklyOpen;
                const openPercent = (distFromOpen / weekRange) * 100;
                if (distFromOpen < -weekRange * 0.1) { weeklyScore += 35; weeklyFactors.push('Below Weekly Open'); }
                else if (distFromOpen > weekRange * 0.1) { weeklyScore -= 25; }
                else { weeklyScore += 10; } // Near open is slightly bullish
              }

              // Factor 3: Position vs Prior Day (weight: 25%)
              if (price > pdHigh) { weeklyScore += 25; weeklyFactors.push('Above pd High'); }
              else if (price > pdMid) { weeklyScore += 15; }
              else if (price < pdLow) { weeklyScore -= 25; weeklyFactors.push('Below pd Low'); }
              else if (price < pdMid) { weeklyScore -= 15; }

              // Determine Weekly Bias
              if (weeklyScore >= 60) {
                signals.weekly = { bias: 'VERY BULLISH', color: '#00ff88', score: weeklyScore, factors: weeklyFactors };
              } else if (weeklyScore >= 25) {
                signals.weekly = { bias: 'BULLISH', color: '#88ff88', score: weeklyScore, factors: weeklyFactors };
              } else if (weeklyScore <= -60) {
                signals.weekly = { bias: 'VERY BEARISH', color: '#ff4466', score: weeklyScore, factors: weeklyFactors };
              } else if (weeklyScore <= -25) {
                signals.weekly = { bias: 'BEARISH', color: '#ff8888', score: weeklyScore, factors: weeklyFactors };
              } else {
                signals.weekly = { bias: 'NEUTRAL', color: '#ffaa00', score: weeklyScore, factors: weeklyFactors };
              }
            } else {
              // Fallback to PD-only analysis
              if (price > pdHigh) {
                signals.weekly = { bias: 'BULLISH', color: '#88ff88', factors: ['Above pd High'] };
              } else if (price < pdLow) {
                signals.weekly = { bias: 'BEARISH', color: '#ff8888', factors: ['Below pd Low'] };
              }
            }

            // 2. MONTHLY BIAS - Rolling 20-Day Range Analysis
            const rolling20dHigh = liveData.rolling_20d_high || 0;
            const rolling20dLow = liveData.rolling_20d_low || 0;
            const monthlyRange = rolling20dHigh - rolling20dLow;
            const monthlyMid = (rolling20dHigh + rolling20dLow) / 2;

            let monthlyScore = 0;
            let monthlyFactors = [];

            if (rolling20dHigh > 0 && rolling20dLow > 0 && monthlyRange > 0) {
              // Position in 20-day range
              const monthlyPosPercent = ((price - rolling20dLow) / monthlyRange) * 100;

              // Factor 1: Position in 20-Day Range (weight: 50%)
              if (monthlyPosPercent >= 90) { monthlyScore += 50; monthlyFactors.push('Near 20d High'); }
              else if (monthlyPosPercent >= 75) { monthlyScore += 35; monthlyFactors.push('Upper 20d Range'); }
              else if (monthlyPosPercent >= 60) { monthlyScore += 20; }
              else if (monthlyPosPercent <= 10) { monthlyScore -= 50; monthlyFactors.push('Near 20d Low'); }
              else if (monthlyPosPercent <= 25) { monthlyScore -= 35; monthlyFactors.push('Lower 20d Range'); }
              else if (monthlyPosPercent <= 40) { monthlyScore -= 20; }

              // Factor 2: Week vs Month context (weight: 30%)
              if (weekHigh > 0 && weekLow > 0) {
                // If week is making higher highs vs 20d, bullish momentum
                if (weekHigh >= rolling20dHigh * 0.998) { monthlyScore += 30; monthlyFactors.push('Week at 20d High'); }
                else if (weekLow <= rolling20dLow * 1.002) { monthlyScore -= 30; monthlyFactors.push('Week at 20d Low'); }
                else if (weekHigh > monthlyMid) { monthlyScore += 15; }
                else if (weekLow < monthlyMid) { monthlyScore -= 15; }
              }

              // Factor 3: Trend direction using weekly open (weight: 20%)
              if (weeklyOpen > 0) {
                if (price > weeklyOpen && weeklyOpen > rolling20dLow + monthlyRange * 0.4) {
                  monthlyScore += 20; monthlyFactors.push('Uptrend confirmed');
                } else if (price < weeklyOpen && weeklyOpen < rolling20dHigh - monthlyRange * 0.4) {
                  monthlyScore -= 20; monthlyFactors.push('Downtrend confirmed');
                }
              }

              // Determine Monthly Bias
              if (monthlyScore >= 50) {
                signals.monthly = { bias: 'VERY BULLISH', color: '#00ff88', score: monthlyScore, factors: monthlyFactors };
              } else if (monthlyScore >= 20) {
                signals.monthly = { bias: 'BULLISH', color: '#88ff88', score: monthlyScore, factors: monthlyFactors };
              } else if (monthlyScore <= -50) {
                signals.monthly = { bias: 'VERY BEARISH', color: '#ff4466', score: monthlyScore, factors: monthlyFactors };
              } else if (monthlyScore <= -20) {
                signals.monthly = { bias: 'BEARISH', color: '#ff8888', score: monthlyScore, factors: monthlyFactors };
              } else {
                signals.monthly = { bias: 'NEUTRAL', color: '#ffaa00', score: monthlyScore, factors: monthlyFactors };
              }
            } else {
              // Fallback to week-based analysis
              if (weekHigh > 0 && weekLow > 0) {
                const weekPos = ((price - weekLow) / weekRange) * 100;
                if (weekPos >= 80) {
                  signals.monthly = { bias: 'BULLISH', color: '#88ff88', factors: ['Near Week High'] };
                } else if (weekPos <= 20) {
                  signals.monthly = { bias: 'BEARISH', color: '#ff8888', factors: ['Near Week Low'] };
                }
              }
            }

            // DAY OPEN ANALYSIS (18:00 ET Globex Open)
            // Use backend values directly - backend resets on contract switch
            const dayOpen = liveData.day_open || 0;
            // weeklyOpen already defined above at line ~11412

            if (dayOpen > 0) {
              const dayOpenDiff = price - dayOpen;
              if (dayOpenDiff < -2) {
                // Price BELOW day open = BULLISH (buying below open)
                signals.dayOpen = {
                  position: 'BELOW',
                  diff: dayOpenDiff,
                  price: dayOpen,
                  color: '#00ff88',
                  bias: 'BULLISH'
                };
              } else if (dayOpenDiff > 2) {
                // Price ABOVE day open = BEARISH (selling above open)
                signals.dayOpen = {
                  position: 'ABOVE',
                  diff: dayOpenDiff,
                  price: dayOpen,
                  color: '#ff4466',
                  bias: 'BEARISH'
                };
              } else {
                signals.dayOpen = {
                  position: 'AT',
                  diff: dayOpenDiff,
                  price: dayOpen,
                  color: '#ffaa00',
                  bias: 'NEUTRAL'
                };
              }
            }

            // WEEKLY OPEN ANALYSIS (Sunday 18:00 ET)
            // Use validated weekly open
            if (weeklyOpen > 0) {
              const weeklyOpenDiff = price - weeklyOpen;
              if (weeklyOpenDiff < -5) {
                // Price BELOW weekly open = BULLISH (buying below weekly open)
                signals.weeklyOpen = {
                  position: 'BELOW',
                  diff: weeklyOpenDiff,
                  price: weeklyOpen,
                  color: '#00ff88',
                  bias: 'BULLISH'
                };
              } else if (weeklyOpenDiff > 5) {
                // Price ABOVE weekly open = BEARISH (selling above weekly open)
                signals.weeklyOpen = {
                  position: 'ABOVE',
                  diff: weeklyOpenDiff,
                  price: weeklyOpen,
                  color: '#ff4466',
                  bias: 'BEARISH'
                };
              } else {
                signals.weeklyOpen = {
                  position: 'AT',
                  diff: weeklyOpenDiff,
                  price: weeklyOpen,
                  color: '#ffaa00',
                  bias: 'NEUTRAL'
                };
              }
            }
          }

          // 2. INITIAL BALANCE CLASSIFICATION
          if (profileData) {
            const ibRange = profileData.ib_range || 0;
            const adr = profileData.avg_daily_range || 50;
            const ibPct = adr > 0 ? (ibRange / adr) * 100 : 0;

            if (ibRange === 0 || !profileData.ib_complete) {
              signals.daily.ib = { level: 'FORMING', color: '#888', pct: '--' };
            } else if (ibPct < 35) {
              signals.daily.ib = { level: 'LOW', color: '#00ff88', pct: ibPct.toFixed(0) };
            } else if (ibPct <= 75) {
              signals.daily.ib = { level: 'MEDIUM', color: '#ffaa00', pct: ibPct.toFixed(0) };
            } else {
              signals.daily.ib = { level: 'HIGH', color: '#ff4466', pct: ibPct.toFixed(0) };
            }
          }

          // 3. LOCATION WRT PVA (Prior Value Area)
          if (liveData && profileData) {
            // Estimate PVA using prior day range (70% rule approximation)
            const pdHigh = liveData.pd_high || 0;
            const pdLow = liveData.pd_low || 0;
            const pdRange = pdHigh - pdLow;
            const pvaHigh = pdLow + pdRange * 0.85; // Approximate VAH
            const pvaLow = pdLow + pdRange * 0.15;  // Approximate VAL
            const pvaMid = (pvaHigh + pvaLow) / 2;

            const dayOpen = liveData.day_open || price;
            const sessionOpen = liveData.session_open || dayOpen;

            // Determine location
            if (price >= pvaLow && price <= pvaHigh) {
              // Inside PVA
              const openedInside = sessionOpen >= pvaLow && sessionOpen <= pvaHigh;
              signals.daily.pvaLocation = {
                status: 'IN',
                detail: openedInside ? 'Accepted' : 'Returned',
                color: '#00aaff'
              };
            } else if (price > pvaHigh) {
              // Above PVA
              const breakingOut = price > pvaHigh + 5;
              signals.daily.pvaLocation = {
                status: 'OUT',
                detail: breakingOut ? 'Accepted Above' : 'Testing VAH',
                color: breakingOut ? '#00ff88' : '#ffaa00'
              };
            } else {
              // Below PVA
              const breakingDown = price < pvaLow - 5;
              signals.daily.pvaLocation = {
                status: 'OUT',
                detail: breakingDown ? 'Accepted Below' : 'Testing VAL',
                color: breakingDown ? '#ff4466' : '#ffaa00'
              };
            }

            // Check for dynamic (testing boundaries)
            if (Math.abs(price - pvaHigh) <= 3 || Math.abs(price - pvaLow) <= 3) {
              signals.daily.pvaLocation.status = 'DYNAMIC';
              signals.daily.pvaLocation.color = '#ffaa00';
            }
          }

          // 4. OPENING TYPE
          if (profileData?.open_type) {
            const openType = profileData.open_type?.toUpperCase() || 'DEVELOPING';
            const openTypeMap = {
              'OD': { name: 'OD', full: 'Open Drive', color: '#00ff88' },
              'OPEN_DRIVE': { name: 'OD', full: 'Open Drive', color: '#00ff88' },
              'OTD': { name: 'OTD', full: 'Open Test Drive', color: '#88ff88' },
              'OPEN_TEST_DRIVE': { name: 'OTD', full: 'Open Test Drive', color: '#88ff88' },
              'ORR': { name: 'ORR', full: 'Open Rejection Reverse', color: '#ff8888' },
              'OPEN_REJECTION_REVERSE': { name: 'ORR', full: 'Open Rejection Reverse', color: '#ff8888' },
              'OA': { name: 'OA', full: 'Open Auction', color: '#ffaa00' },
              'OPEN_AUCTION': { name: 'OA', full: 'Open Auction', color: '#ffaa00' },
              'DEVELOPING': { name: 'DEV', full: 'Developing', color: '#888' }
            };
            const openInfo = openTypeMap[openType] || openTypeMap['DEVELOPING'];
            signals.daily.opening = { type: openInfo.name, full: openInfo.full, color: openInfo.color };
          }

          // 5. AB OVERLAP
          if (profileData?.ab_overlap !== undefined && profileData?.ab_overlap !== null) {
            const abPct = profileData.ab_overlap;
            if (abPct < 33) {
              signals.critical.abOverlap = { pct: abPct.toFixed(0), color: '#00ff88', level: '<33%' };
            } else if (abPct <= 50) {
              signals.critical.abOverlap = { pct: abPct.toFixed(0), color: '#ffaa00', level: '33-50%' };
            } else {
              signals.critical.abOverlap = { pct: abPct.toFixed(0), color: '#ff4466', level: '>50%' };
            }
          }

          // 6. BUYING/SELLING TAIL & EXCESS
          if (profileData) {
            const singlePrints = profileData.single_prints_count || 0;
            const dayHigh = liveData?.day_high || 0;
            const dayLow = liveData?.day_low || 0;
            const pocPrice = profileData.poc || price;

            // Detect tails (single prints at extremes)
            if (singlePrints > 0) {
              // If POC is in upper half, likely selling tail below
              if (pocPrice > (dayHigh + dayLow) / 2) {
                signals.critical.buyingTail = true;
              } else {
                signals.critical.sellingTail = true;
              }
            }
          }

          // 7. TPO COUNT BIAS
          if (profileData) {
            const poc = profileData.poc || 0;
            const vah = profileData.vah || 0;
            const val = profileData.val || 0;
            const vaMid = (vah + val) / 2;

            if (poc > vaMid + 2) {
              signals.critical.tpoBias = { direction: 'BULLISH', color: '#00ff88' };
            } else if (poc < vaMid - 2) {
              signals.critical.tpoBias = { direction: 'BEARISH', color: '#ff4466' };
            } else {
              signals.critical.tpoBias = { direction: 'NEUTRAL', color: '#ffaa00' };
            }
          }

          // ============================================
          // TPO HTF ANALYSIS - 4-TIER HIERARCHY SCORING
          // ============================================
          // Rank 1 (MACRO): +3 pts each - Weekly VA, Composite VPOC, Multi-day HVN/LVN
          // Rank 2 (VOLUME): +2 pts each - Delta, HVN/LVN, VPOC alignment
          // Rank 3 (STRUCTURE): +2 pts each - Tails w/volume, Profile shape, Range extension
          // Rank 4 (TIMING): +1 pt each - Open type, IB width, Single prints
          // RULE: Volume > TPO, Higher timeframe > Lower timeframe

          const momScore = {
            rank1: { name: 'MACRO', points: 3, factors: [], total: 0, direction: 'NEUTRAL' },
            rank2: { name: 'VOLUME', points: 2, factors: [], total: 0, direction: 'NEUTRAL' },
            rank3: { name: 'STRUCTURE', points: 2, factors: [], total: 0, direction: 'NEUTRAL' },
            rank4: { name: 'TIMING', points: 1, factors: [], total: 0, direction: 'NEUTRAL' },
            conflicts: [],
            totalScore: 0,
            confidence: 'LOW',
            positionSize: '25%',
            direction: 'NEUTRAL'
          };

          // --- RANK 1: MACRO (+3 pts each) ---
          // Factor 1: Weekly VA Direction (price position in week's value area)
          if (liveData) {
            const weekHigh = liveData.week_high || 0;
            const weekLow = liveData.week_low || 0;
            const weekRange = weekHigh - weekLow;
            if (weekRange > 0) {
              const weekVAH = weekLow + weekRange * 0.7;
              const weekVAL = weekLow + weekRange * 0.3;
              if (price > weekVAH) {
                momScore.rank1.factors.push({ name: 'Weekly VA', signal: 'LONG', reason: 'Price above weekly VAH', pts: 3 });
                momScore.rank1.total += 3;
              } else if (price < weekVAL) {
                momScore.rank1.factors.push({ name: 'Weekly VA', signal: 'SHORT', reason: 'Price below weekly VAL', pts: -3 });
                momScore.rank1.total -= 3;
              } else {
                momScore.rank1.factors.push({ name: 'Weekly VA', signal: 'NEUTRAL', reason: 'Price inside weekly VA', pts: 0 });
              }
            }
          }

          // Factor 2: Multi-day HVN/LVN (rolling 20-day context)
          if (liveData) {
            const rolling20dHigh = liveData.rolling_20d_high || 0;
            const rolling20dLow = liveData.rolling_20d_low || 0;
            const monthlyRange = rolling20dHigh - rolling20dLow;
            if (monthlyRange > 0) {
              const upperQuartile = rolling20dLow + monthlyRange * 0.75;
              const lowerQuartile = rolling20dLow + monthlyRange * 0.25;
              // HVN = price clusters, LVN = rejection areas
              if (price > upperQuartile) {
                // Near multi-day high = potential HVN resistance or breakout
                momScore.rank1.factors.push({ name: 'Multi-day HVN/LVN', signal: 'LONG', reason: 'At multi-day highs (breakout zone)', pts: 3 });
                momScore.rank1.total += 3;
              } else if (price < lowerQuartile) {
                // Near multi-day low = potential LVN support or breakdown
                momScore.rank1.factors.push({ name: 'Multi-day HVN/LVN', signal: 'SHORT', reason: 'At multi-day lows (breakdown zone)', pts: -3 });
                momScore.rank1.total -= 3;
              } else {
                momScore.rank1.factors.push({ name: 'Multi-day HVN/LVN', signal: 'NEUTRAL', reason: 'Mid-range (fair value)', pts: 0 });
              }
            }
          }

          // Factor 3: Composite VPOC Trend (weekly open as proxy)
          if (liveData?.weekly_open > 0) {
            const weeklyOpen = liveData.weekly_open;
            const diff = price - weeklyOpen;
            if (diff > 10) {
              momScore.rank1.factors.push({ name: 'Composite VPOC', signal: 'LONG', reason: `+${diff.toFixed(0)}pts above weekly open`, pts: 3 });
              momScore.rank1.total += 3;
            } else if (diff < -10) {
              momScore.rank1.factors.push({ name: 'Composite VPOC', signal: 'SHORT', reason: `${diff.toFixed(0)}pts below weekly open`, pts: -3 });
              momScore.rank1.total -= 3;
            } else {
              momScore.rank1.factors.push({ name: 'Composite VPOC', signal: 'NEUTRAL', reason: 'Near weekly open', pts: 0 });
            }
          }

          // Determine Rank 1 direction
          momScore.rank1.direction = momScore.rank1.total > 0 ? 'LONG' : momScore.rank1.total < 0 ? 'SHORT' : 'NEUTRAL';

          // --- RANK 2: VOLUME (+2 pts each) ---
          // Factor 1: Delta Direction (volume imbalance - use day direction as proxy)
          if (liveData) {
            const dayOpen = liveData.day_open || 0;
            const dayHigh = liveData.day_high || 0;
            const dayLow = liveData.day_low || 0;
            if (dayOpen > 0) {
              const upMove = dayHigh - dayOpen;
              const downMove = dayOpen - dayLow;
              if (upMove > downMove * 1.5) {
                momScore.rank2.factors.push({ name: 'Delta Direction', signal: 'LONG', reason: 'Buyers dominating (up move > down)', pts: 2 });
                momScore.rank2.total += 2;
              } else if (downMove > upMove * 1.5) {
                momScore.rank2.factors.push({ name: 'Delta Direction', signal: 'SHORT', reason: 'Sellers dominating (down move > up)', pts: -2 });
                momScore.rank2.total -= 2;
              } else {
                momScore.rank2.factors.push({ name: 'Delta Direction', signal: 'NEUTRAL', reason: 'Balanced volume', pts: 0 });
              }
            }
          }

          // Factor 2: Daily HVN/LVN Location
          if (profileData) {
            const poc = profileData.poc || 0;
            const vah = profileData.vah || 0;
            const val = profileData.val || 0;
            if (poc > 0 && vah > 0 && val > 0) {
              const vaRange = vah - val;
              const pocPosition = (poc - val) / vaRange;
              if (pocPosition > 0.65) {
                momScore.rank2.factors.push({ name: 'Daily HVN', signal: 'LONG', reason: 'POC in upper VA (HVN above)', pts: 2 });
                momScore.rank2.total += 2;
              } else if (pocPosition < 0.35) {
                momScore.rank2.factors.push({ name: 'Daily HVN', signal: 'SHORT', reason: 'POC in lower VA (HVN below)', pts: -2 });
                momScore.rank2.total -= 2;
              } else {
                momScore.rank2.factors.push({ name: 'Daily HVN', signal: 'NEUTRAL', reason: 'POC centered', pts: 0 });
              }
            }
          }

          // Factor 3: VPOC vs TPO POC Alignment
          if (profileData?.vpoc && profileData?.poc) {
            const vpoc = profileData.vpoc;
            const tpoPoc = profileData.poc;
            const diff = Math.abs(vpoc - tpoPoc);
            if (diff < 3) {
              // Aligned - strong level
              const abovePrice = vpoc > price;
              momScore.rank2.factors.push({
                name: 'VPOC/POC Align',
                signal: abovePrice ? 'SHORT' : 'LONG',
                reason: `VPOC & POC aligned at ${vpoc.toFixed(0)} (strong ${abovePrice ? 'resistance' : 'support'})`,
                pts: abovePrice ? -2 : 2
              });
              momScore.rank2.total += abovePrice ? -2 : 2;
            } else {
              // Divergent - VPOC (volume) wins
              if (profileData.vpoc > profileData.poc) {
                momScore.rank2.factors.push({ name: 'VPOC/POC Align', signal: 'LONG', reason: 'VPOC above POC (volume leads up)', pts: 2 });
                momScore.rank2.total += 2;
              } else {
                momScore.rank2.factors.push({ name: 'VPOC/POC Align', signal: 'SHORT', reason: 'VPOC below POC (volume leads down)', pts: -2 });
                momScore.rank2.total -= 2;
              }
            }
          } else if (profileData?.poc) {
            // Fallback: use TPO POC position
            const pocVsPrice = profileData.poc > price ? 'SHORT' : 'LONG';
            momScore.rank2.factors.push({
              name: 'POC Location',
              signal: pocVsPrice,
              reason: `POC at ${profileData.poc?.toFixed(0)} (${pocVsPrice === 'LONG' ? 'support' : 'resistance'})`,
              pts: pocVsPrice === 'LONG' ? 1 : -1
            });
            momScore.rank2.total += pocVsPrice === 'LONG' ? 1 : -1;
          }

          // Determine Rank 2 direction
          momScore.rank2.direction = momScore.rank2.total > 0 ? 'LONG' : momScore.rank2.total < 0 ? 'SHORT' : 'NEUTRAL';

          // --- RANK 3: STRUCTURE (+2 pts each) ---
          // Factor 1: Tails with Volume (single prints at extremes)
          if (profileData) {
            const singlePrints = profileData.single_prints_count || 0;
            if (singlePrints > 0) {
              // Buying tail = support, Selling tail = resistance
              if (signals.critical.buyingTail) {
                momScore.rank3.factors.push({ name: 'Buying Tail', signal: 'LONG', reason: 'Single prints at lows (buyer aggression)', pts: 2 });
                momScore.rank3.total += 2;
              }
              if (signals.critical.sellingTail) {
                momScore.rank3.factors.push({ name: 'Selling Tail', signal: 'SHORT', reason: 'Single prints at highs (seller aggression)', pts: -2 });
                momScore.rank3.total -= 2;
              }
            }
          }

          // Factor 2: Profile Shape (P = accumulation/LONG, b = distribution/SHORT, D = balanced, B = double distribution)
          if (profileData) {
            const poc = profileData.poc || 0;
            const vah = profileData.vah || 0;
            const val = profileData.val || 0;
            const dayHigh = liveData?.day_high || vah;
            const dayLow = liveData?.day_low || val;
            const totalRange = dayHigh - dayLow;

            if (totalRange > 0) {
              const upperExtension = dayHigh - vah;
              const lowerExtension = val - dayLow;
              const vaWidth = vah - val;
              const pocPosition = (poc - dayLow) / totalRange;

              let shape = 'D'; // Default balanced
              let shapeSignal = 'NEUTRAL';
              let shapeReason = 'Balanced D-shape profile';
              let shapePts = 0;

              // P-shape: VA in lower half, extension above (accumulation)
              if (pocPosition < 0.4 && upperExtension > vaWidth * 0.3) {
                shape = 'P';
                shapeSignal = 'LONG';
                shapeReason = 'P-shape (accumulation, buyers loading)';
                shapePts = 2;
              }
              // b-shape: VA in upper half, extension below (distribution)
              else if (pocPosition > 0.6 && lowerExtension > vaWidth * 0.3) {
                shape = 'b';
                shapeSignal = 'SHORT';
                shapeReason = 'b-shape (distribution, sellers unloading)';
                shapePts = -2;
              }
              // B-shape: Two value areas (double distribution)
              else if (profileData.double_distribution) {
                shape = 'B';
                shapeSignal = 'NEUTRAL';
                shapeReason = 'B-shape (double distribution, range bound)';
                shapePts = 0;
              }

              momScore.rank3.factors.push({ name: `Profile Shape (${shape})`, signal: shapeSignal, reason: shapeReason, pts: shapePts });
              momScore.rank3.total += shapePts;
            }
          }

          // Factor 3: Range Extension Direction
          if (profileData && liveData) {
            const ibHigh = profileData.ib_high || 0;
            const ibLow = profileData.ib_low || 0;
            const dayHigh = liveData.day_high || 0;
            const dayLow = liveData.day_low || 0;

            if (ibHigh > 0 && ibLow > 0) {
              const extendedUp = dayHigh > ibHigh + 2;
              const extendedDown = dayLow < ibLow - 2;

              if (extendedUp && !extendedDown) {
                momScore.rank3.factors.push({ name: 'Range Extension', signal: 'LONG', reason: 'IB broken to upside', pts: 2 });
                momScore.rank3.total += 2;
              } else if (extendedDown && !extendedUp) {
                momScore.rank3.factors.push({ name: 'Range Extension', signal: 'SHORT', reason: 'IB broken to downside', pts: -2 });
                momScore.rank3.total -= 2;
              } else if (extendedUp && extendedDown) {
                momScore.rank3.factors.push({ name: 'Range Extension', signal: 'NEUTRAL', reason: 'IB broken both ways', pts: 0 });
              } else {
                momScore.rank3.factors.push({ name: 'Range Extension', signal: 'NEUTRAL', reason: 'Inside IB', pts: 0 });
              }
            }
          }

          // Determine Rank 3 direction
          momScore.rank3.direction = momScore.rank3.total > 0 ? 'LONG' : momScore.rank3.total < 0 ? 'SHORT' : 'NEUTRAL';

          // --- RANK 4: TIMING (+1 pt each) ---
          // Factor 1: Open Type
          if (profileData?.open_type) {
            const openType = profileData.open_type?.toUpperCase() || '';
            const openDir = profileData.open_direction || '';

            if (openType.includes('OD') || openType.includes('DRIVE')) {
              // Open Drive - strong conviction
              const pts = openDir === 'up' ? 1 : openDir === 'down' ? -1 : 0;
              momScore.rank4.factors.push({
                name: 'Open Type',
                signal: pts > 0 ? 'LONG' : pts < 0 ? 'SHORT' : 'NEUTRAL',
                reason: `Open Drive ${openDir || ''}`,
                pts
              });
              momScore.rank4.total += pts;
            } else if (openType.includes('ORR') || openType.includes('REJECTION')) {
              // Open Rejection Reverse - reversal
              const pts = openDir === 'up' ? -1 : openDir === 'down' ? 1 : 0; // Opposite direction
              momScore.rank4.factors.push({
                name: 'Open Type',
                signal: pts > 0 ? 'LONG' : pts < 0 ? 'SHORT' : 'NEUTRAL',
                reason: `Open Rejection Reverse`,
                pts
              });
              momScore.rank4.total += pts;
            } else if (openType.includes('OTD') || openType.includes('TEST')) {
              // Open Test Drive - moderate conviction
              const pts = openDir === 'up' ? 1 : openDir === 'down' ? -1 : 0;
              momScore.rank4.factors.push({
                name: 'Open Type',
                signal: pts > 0 ? 'LONG' : pts < 0 ? 'SHORT' : 'NEUTRAL',
                reason: `Open Test Drive ${openDir || ''}`,
                pts: pts * 0.5
              });
              momScore.rank4.total += pts * 0.5;
            }
          }

          // Factor 2: IB Width (Low IB = trend day, High IB = rotation)
          if (signals.daily.ib.level !== '--' && signals.daily.ib.level !== 'FORMING') {
            if (signals.daily.ib.level === 'LOW') {
              // Low IB = expect range extension in trend direction
              const trendDir = momScore.rank3.direction !== 'NEUTRAL' ? momScore.rank3.direction :
                               momScore.rank2.direction !== 'NEUTRAL' ? momScore.rank2.direction : 'NEUTRAL';
              if (trendDir === 'LONG') {
                momScore.rank4.factors.push({ name: 'IB Width', signal: 'LONG', reason: 'Low IB + uptrend = expansion up', pts: 1 });
                momScore.rank4.total += 1;
              } else if (trendDir === 'SHORT') {
                momScore.rank4.factors.push({ name: 'IB Width', signal: 'SHORT', reason: 'Low IB + downtrend = expansion down', pts: -1 });
                momScore.rank4.total -= 1;
              } else {
                momScore.rank4.factors.push({ name: 'IB Width', signal: 'NEUTRAL', reason: 'Low IB (breakout pending)', pts: 0 });
              }
            } else if (signals.daily.ib.level === 'HIGH') {
              momScore.rank4.factors.push({ name: 'IB Width', signal: 'NEUTRAL', reason: 'High IB (rotational day)', pts: 0 });
            }
          }

          // Factor 3: Single Prints (unfilled gaps = targets)
          if (profileData?.single_prints_count > 0) {
            // Single prints act as magnets - price tends to fill them
            const singlePrintLevel = profileData.single_print_level || 0;
            if (singlePrintLevel > price + 5) {
              momScore.rank4.factors.push({ name: 'Single Prints', signal: 'LONG', reason: `Singles above at ${singlePrintLevel.toFixed(0)} (target)`, pts: 1 });
              momScore.rank4.total += 1;
            } else if (singlePrintLevel < price - 5) {
              momScore.rank4.factors.push({ name: 'Single Prints', signal: 'SHORT', reason: `Singles below at ${singlePrintLevel.toFixed(0)} (target)`, pts: -1 });
              momScore.rank4.total -= 1;
            }
          }

          // Determine Rank 4 direction
          momScore.rank4.direction = momScore.rank4.total > 0 ? 'LONG' : momScore.rank4.total < 0 ? 'SHORT' : 'NEUTRAL';

          // --- CONFLICT DETECTION ---
          // Rule: Higher rank wins when conflicts exist
          const directions = [
            { rank: 1, name: 'MACRO', dir: momScore.rank1.direction, total: momScore.rank1.total },
            { rank: 2, name: 'VOLUME', dir: momScore.rank2.direction, total: momScore.rank2.total },
            { rank: 3, name: 'STRUCTURE', dir: momScore.rank3.direction, total: momScore.rank3.total },
            { rank: 4, name: 'TIMING', dir: momScore.rank4.direction, total: momScore.rank4.total }
          ].filter(d => d.dir !== 'NEUTRAL');

          for (let i = 0; i < directions.length; i++) {
            for (let j = i + 1; j < directions.length; j++) {
              if (directions[i].dir !== directions[j].dir) {
                momScore.conflicts.push({
                  higher: directions[i],
                  lower: directions[j],
                  resolution: `${directions[i].name} (Rank ${directions[i].rank}) overrides ${directions[j].name}`
                });
              }
            }
          }

          // --- CALCULATE TOTAL SCORE ---
          momScore.totalScore = momScore.rank1.total + momScore.rank2.total + momScore.rank3.total + momScore.rank4.total;

          // --- DETERMINE CONFIDENCE & POSITION SIZE ---
          // Score ‚â•+12: VERY HIGH (100%+), +8-11: HIGH (100%), +5-7: MED-HIGH (75%)
          // +2-4: MEDIUM (50%), -1 to +1: LOW (25%/SKIP), ‚â§-2: AVOID
          const absScore = Math.abs(momScore.totalScore);
          if (absScore >= 12) {
            momScore.confidence = 'VERY HIGH';
            momScore.positionSize = '100%+';
            momScore.confidenceColor = '#00ff88';
          } else if (absScore >= 8) {
            momScore.confidence = 'HIGH';
            momScore.positionSize = '100%';
            momScore.confidenceColor = '#88ff88';
          } else if (absScore >= 5) {
            momScore.confidence = 'MED-HIGH';
            momScore.positionSize = '75%';
            momScore.confidenceColor = '#ffdd00';
          } else if (absScore >= 2) {
            momScore.confidence = 'MEDIUM';
            momScore.positionSize = '50%';
            momScore.confidenceColor = '#ffaa00';
          } else if (absScore >= 0) {
            momScore.confidence = 'LOW';
            momScore.positionSize = '25% or SKIP';
            momScore.confidenceColor = '#ff8844';
          } else {
            momScore.confidence = 'AVOID';
            momScore.positionSize = 'NO TRADE';
            momScore.confidenceColor = '#ff4466';
          }

          // Overall direction from score
          momScore.direction = momScore.totalScore > 0 ? 'LONG' : momScore.totalScore < 0 ? 'SHORT' : 'NEUTRAL';

          // === CALCULATE OVERALL DIRECTION ===
          let bullishPoints = 0;
          let bearishPoints = 0;

          // Monthly/Weekly (higher weight)
          if (signals.monthly.bias.includes('BULLISH')) bullishPoints += signals.monthly.bias.includes('VERY') ? 15 : 10;
          if (signals.monthly.bias.includes('BEARISH')) bearishPoints += signals.monthly.bias.includes('VERY') ? 15 : 10;
          if (signals.weekly.bias.includes('BULLISH')) bullishPoints += signals.weekly.bias.includes('VERY') ? 15 : 10;
          if (signals.weekly.bias.includes('BEARISH')) bearishPoints += signals.weekly.bias.includes('VERY') ? 15 : 10;

          // Day Open (buying below open = bullish, selling above = bearish)
          if (signals.dayOpen.bias === 'BULLISH') bullishPoints += 10;
          if (signals.dayOpen.bias === 'BEARISH') bearishPoints += 10;

          // Weekly Open (buying below weekly open = bullish, selling above = bearish)
          if (signals.weeklyOpen.bias === 'BULLISH') bullishPoints += 12;
          if (signals.weeklyOpen.bias === 'BEARISH') bearishPoints += 12;

          // IB Classification
          if (signals.daily.ib.level === 'LOW') bullishPoints += 8; // Low IB = range expansion likely
          if (signals.daily.ib.level === 'HIGH') bearishPoints += 5; // High IB = possible reversal

          // PVA Location
          if (signals.daily.pvaLocation.detail?.includes('Above')) bullishPoints += 10;
          if (signals.daily.pvaLocation.detail?.includes('Below')) bearishPoints += 10;
          if (signals.daily.pvaLocation.status === 'IN') { bullishPoints += 3; bearishPoints += 3; }

          // Opening Type
          if (signals.daily.opening.type === 'OD') {
            const dir = profileData?.open_direction;
            if (dir === 'up') bullishPoints += 12;
            else if (dir === 'down') bearishPoints += 12;
          }
          if (signals.daily.opening.type === 'ORR') {
            const dir = profileData?.open_direction;
            if (dir === 'up') bearishPoints += 8; // ORR up means initial down
            else if (dir === 'down') bullishPoints += 8;
          }

          // AB Overlap
          if (signals.critical.abOverlap.pct !== '--') {
            const pct = parseFloat(signals.critical.abOverlap.pct);
            if (pct < 33) bullishPoints += 5; // Trending
            if (pct > 50) bearishPoints += 3; // Rotational
          }

          // Tails
          if (signals.critical.buyingTail) bullishPoints += 8;
          if (signals.critical.sellingTail) bearishPoints += 8;

          // TPO Bias
          if (signals.critical.tpoBias.direction === 'BULLISH') bullishPoints += 7;
          if (signals.critical.tpoBias.direction === 'BEARISH') bearishPoints += 7;

          const totalPoints = bullishPoints + bearishPoints;
          const bullishPct = totalPoints > 0 ? Math.round((bullishPoints / totalPoints) * 100) : 50;
          const bearishPct = 100 - bullishPct;

          let overallDirection = 'NEUTRAL';
          let overallColor = '#ffaa00';
          let confidence = 50;

          if (bullishPct >= 65) {
            overallDirection = bullishPct >= 80 ? 'VERY BULLISH' : 'BULLISH';
            overallColor = bullishPct >= 80 ? '#00ff88' : '#88ff88';
            confidence = bullishPct;
          } else if (bearishPct >= 65) {
            overallDirection = bearishPct >= 80 ? 'VERY BEARISH' : 'BEARISH';
            overallColor = bearishPct >= 80 ? '#ff4466' : '#ff8888';
            confidence = bearishPct;
          } else {
            confidence = Math.max(bullishPct, bearishPct);
          }

          return (
            <div style={{
              background: 'rgba(20,20,28,0.95)',
              borderRadius: isMobile ? 10 : 12,
              border: `2px solid ${overallColor}40`,
              padding: isMobile ? 12 : 16,
              marginBottom: isMobile ? 12 : 16,
            }}>
              {/* Header with Overall Direction */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                marginBottom: 16,
                paddingBottom: 12,
                borderBottom: '1px solid rgba(255,255,255,0.1)'
              }}>
                <div>
                  <div style={{ fontSize: 10, color: '#888', letterSpacing: 1, marginBottom: 4 }}>SIGNAL ENGINE</div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    <span style={{ fontSize: isMobile ? 18 : 22, fontWeight: 700, color: overallColor }}>
                      {overallDirection}
                    </span>
                    <span style={{
                      fontSize: 12,
                      padding: '3px 8px',
                      background: `${overallColor}25`,
                      borderRadius: 4,
                      color: overallColor,
                      fontWeight: 600,
                    }}>
                      {confidence}%
                    </span>
                  </div>
                </div>
              </div>

              {/* TPO HTF ANALYSIS - Collapsible Probabilistic Scoring Panel */}
              <div style={{
                background: 'rgba(0,0,0,0.2)',
                borderRadius: 10,
                border: '1px solid rgba(255,255,255,0.08)',
                overflow: 'hidden',
                marginBottom: 16,
              }}>
                {/* Collapsible Header - Click to expand */}
                <div
                  onClick={() => setShowTPOHTF(!showTPOHTF)}
                  style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: isMobile ? 12 : 16,
                    cursor: 'pointer',
                    background: `linear-gradient(135deg, ${momScore.confidenceColor}12 0%, rgba(0,0,0,0.3) 100%)`,
                    borderBottom: showTPOHTF ? `1px solid ${momScore.confidenceColor}30` : 'none',
                    transition: 'all 0.2s ease'
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <div>
                      <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>TPO HTF ANALYSIS</div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                        <span style={{
                          fontSize: isMobile ? 20 : 26,
                          fontWeight: 800,
                          color: momScore.direction === 'LONG' ? '#00ff88' : momScore.direction === 'SHORT' ? '#ff4466' : '#ffaa00',
                          fontFamily: 'monospace'
                        }}>
                          {momScore.totalScore > 0 ? '+' : ''}{momScore.totalScore}
                        </span>
                        <span style={{
                          fontSize: isMobile ? 14 : 16,
                          fontWeight: 700,
                          color: momScore.direction === 'LONG' ? '#00ff88' : momScore.direction === 'SHORT' ? '#ff4466' : '#ffaa00'
                        }}>
                          {momScore.direction}
                        </span>
                      </div>
                    </div>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{
                        fontSize: 11,
                        fontWeight: 700,
                        color: momScore.confidenceColor,
                        marginBottom: 2
                      }}>
                        {momScore.confidence}
                      </div>
                      <div style={{
                        fontSize: 10,
                        padding: '3px 8px',
                        background: `${momScore.confidenceColor}25`,
                        borderRadius: 4,
                        color: momScore.confidenceColor,
                        fontWeight: 600,
                      }}>
                        Size: {momScore.positionSize}
                      </div>
                    </div>
                    <span style={{
                      fontSize: 16,
                      color: '#666',
                      transform: showTPOHTF ? 'rotate(180deg)' : 'rotate(0deg)',
                      transition: 'transform 0.2s ease'
                    }}>
                      ‚ñº
                    </span>
                  </div>
                </div>

                {/* Expandable Content */}
                {showTPOHTF && (
                  <div style={{ padding: isMobile ? 12 : 16 }}>
                    {/* 4-Tier Rank Breakdown */}
                    <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr 1fr' : '1fr 1fr 1fr 1fr', gap: 8, marginBottom: 12 }}>
                      {[momScore.rank1, momScore.rank2, momScore.rank3, momScore.rank4].map((rank, idx) => {
                        const rankNum = idx + 1;
                        const dirColor = rank.direction === 'LONG' ? '#00ff88' : rank.direction === 'SHORT' ? '#ff4466' : '#666';
                        const barWidth = Math.min(100, Math.abs(rank.total) * (rankNum === 1 ? 15 : rankNum <= 3 ? 20 : 30));
                        return (
                          <div key={rank.name} style={{
                            background: 'rgba(0,0,0,0.3)',
                            borderRadius: 6,
                            padding: '8px 10px',
                            borderLeft: `3px solid ${dirColor}`
                          }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4 }}>
                              <span style={{ fontSize: 8, color: '#888', letterSpacing: 0.5 }}>R{rankNum} {rank.name}</span>
                              <span style={{
                                fontSize: 12,
                                fontWeight: 700,
                                color: dirColor,
                                fontFamily: 'monospace'
                              }}>
                                {rank.total > 0 ? '+' : ''}{rank.total}
                              </span>
                            </div>
                            <div style={{
                              height: 4,
                              background: 'rgba(255,255,255,0.1)',
                              borderRadius: 2,
                              overflow: 'hidden'
                            }}>
                              <div style={{
                                height: '100%',
                                width: `${barWidth}%`,
                                background: dirColor,
                                borderRadius: 2
                              }} />
                            </div>
                            {rank.factors.length > 0 && (
                              <div style={{ fontSize: 8, color: '#666', marginTop: 4, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                                {rank.factors[0]?.name}: {rank.factors[0]?.signal}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>

                    {/* Conflicts Warning - Expandable */}
                    {momScore.conflicts.length > 0 && (
                      <details style={{
                        padding: '8px 10px',
                        background: 'rgba(255,170,0,0.15)',
                        border: '1px solid rgba(255,170,0,0.3)',
                        borderRadius: 6,
                        fontSize: 10,
                        color: '#ffaa00'
                      }}>
                        <summary style={{ cursor: 'pointer', userSelect: 'none', listStyle: 'none' }}>
                          <span style={{ fontWeight: 600 }}>Conflict: </span>
                          {momScore.conflicts[0].resolution}
                          {momScore.conflicts.length > 1 && (
                            <span style={{ marginLeft: 8, opacity: 0.8 }}>
                              (+{momScore.conflicts.length - 1} more) ‚ñº
                            </span>
                          )}
                        </summary>
                        {momScore.conflicts.length > 1 && (
                          <div style={{ marginTop: 8, paddingTop: 8, borderTop: '1px solid rgba(255,170,0,0.3)' }}>
                            {momScore.conflicts.slice(1).map((conflict, idx) => (
                              <div key={idx} style={{ marginBottom: 4, paddingLeft: 8 }}>
                                ‚Ä¢ {conflict.resolution}
                              </div>
                            ))}
                          </div>
                        )}
                      </details>
                    )}
                  </div>
                )}
              </div>

              {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                  BIAS SUMMARY - 3 Compact Cards (Monthly, Weekly, Daily)
                  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
              {(() => {
                const clamp = (val, min, max) => Math.min(Math.max(val, min), max);

                // Get current ET time
                const now = new Date();
                const etTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
                const etHour = etTime.getHours();
                const etMinute = etTime.getMinutes();
                const etTimeNum = etHour * 100 + etMinute;
                const isPreIB = etTimeNum < 820;
                const isPostIB = etTimeNum >= 930;

                // Daily Zone Scoring
                const getDailyZoneScore = (pctFromHigh) => {
                  if (pctFromHigh >= 75) return { score: 4, label: 'EXTREMELY BULLISH', color: '#00ff88' };
                  if (pctFromHigh >= 50) return { score: 3, label: 'VERY BULLISH', color: '#88ff88' };
                  if (pctFromHigh >= 25) return { score: 1, label: 'CHECK ENTRY', color: '#ffaa00' };
                  return { score: 0, label: 'WAIT', color: '#ff4466' };
                };

                // Daily calculations
                const dayHigh = liveData?.day_high || 0;
                const dayLow = liveData?.day_low || 0;
                const dayRange = dayHigh - dayLow;
                const openPriceA = isPreIB ? price : (profileData?.ib_open || liveData?.day_open || price);
                const dailyPctFromHighA = dayRange > 0 ? clamp(((dayHigh - openPriceA) / dayRange * 100), 0, 100) : 50;
                const dailyZoneA = getDailyZoneScore(dailyPctFromHighA);

                // Combined daily label
                const dailyLabel = dailyZoneA.label;
                const dailyColor = dailyZoneA.color;
                const dailyScore = `${dailyZoneA.score}/4`;

                return (
                  <>
                    {/* Top Section: Left (M W D) + Right (Intraday) */}
                    <div style={{
                      display: 'flex',
                      gap: 12,
                      marginBottom: 12
                    }}>
                      {/* Left Section: Monthly, Weekly, Daily grouped */}
                      <div style={{
                        flex: 3,
                        background: 'rgba(20,20,28,0.6)',
                        borderRadius: 12,
                        padding: 12,
                        border: '1px solid rgba(255,255,255,0.08)'
                      }}>
                        <div style={{
                          display: 'grid',
                          gridTemplateColumns: 'repeat(3, 1fr)',
                          gap: 10
                        }}>
                          {/* MONTHLY Card */}
                          <div style={{
                            background: `linear-gradient(135deg, ${signals.monthly.color}15 0%, rgba(0,0,0,0.4) 100%)`,
                            borderRadius: 8,
                            padding: 12,
                            border: `1px solid ${signals.monthly.color}30`,
                            textAlign: 'center'
                          }}>
                            <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 6 }}>MONTHLY</div>
                            <div style={{
                              fontSize: 12,
                              fontWeight: 700,
                              color: signals.monthly.color,
                              padding: '5px 10px',
                              background: `${signals.monthly.color}20`,
                              borderRadius: 5,
                              display: 'inline-block'
                            }}>
                              {signals.monthly.bias}
                            </div>
                            {signals.monthly.factors && signals.monthly.factors.length > 0 && (
                              <div style={{ fontSize: 8, color: '#666', marginTop: 5 }}>
                                {signals.monthly.factors[0]}
                              </div>
                            )}
                          </div>

                          {/* WEEKLY Card */}
                          <div style={{
                            background: `linear-gradient(135deg, ${signals.weekly.color}15 0%, rgba(0,0,0,0.4) 100%)`,
                            borderRadius: 8,
                            padding: 12,
                            border: `1px solid ${signals.weekly.color}30`,
                            textAlign: 'center'
                          }}>
                            <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 6 }}>WEEKLY</div>
                            <div style={{
                              fontSize: 12,
                              fontWeight: 700,
                              color: signals.weekly.color,
                              padding: '5px 10px',
                              background: `${signals.weekly.color}20`,
                              borderRadius: 5,
                              display: 'inline-block'
                            }}>
                              {signals.weekly.bias}
                            </div>
                            {signals.weekly.factors && signals.weekly.factors.length > 0 && (
                              <div style={{ fontSize: 8, color: '#666', marginTop: 5 }}>
                                {signals.weekly.factors[0]}
                              </div>
                            )}
                          </div>

                          {/* TPO DAILY ANALYSIS Card - Shows TPO Bias, clickable */}
                          <div
                            onClick={() => setShowIntradayTPO(!showIntradayTPO)}
                            style={{
                              background: `linear-gradient(135deg, ${dailyColor}15 0%, rgba(0,0,0,0.4) 100%)`,
                              borderRadius: 8,
                              padding: 12,
                              border: `1px solid ${showIntradayTPO ? dailyColor : dailyColor + '30'}`,
                              textAlign: 'center',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                          >
                            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 4, marginBottom: 6 }}>
                              <span style={{ fontSize: 9, color: '#888', letterSpacing: 1 }}>TPO DAILY</span>
                              <span style={{
                                fontSize: 9,
                                color: '#666',
                                transform: showIntradayTPO ? 'rotate(180deg)' : 'rotate(0deg)',
                                transition: 'transform 0.2s ease'
                              }}>‚ñº</span>
                            </div>
                            <div style={{
                              fontSize: 12,
                              fontWeight: 700,
                              color: signals.critical.tpoBias.color || dailyColor,
                              padding: '5px 10px',
                              background: `${dailyColor}20`,
                              borderRadius: 5,
                              display: 'inline-block'
                            }}>
                              {signals.critical.tpoBias.direction || 'NEUTRAL'}
                            </div>
                            <div style={{ fontSize: 8, color: '#666', marginTop: 5 }}>
                              IB, PVA, Opening
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Right Section: INTRADAY Button */}
                      <div
                        onClick={() => setShowDayBiasAnalysis(!showDayBiasAnalysis)}
                        style={{
                          flex: 1,
                          background: `linear-gradient(135deg, rgba(0,170,255,0.15) 0%, rgba(0,0,0,0.4) 100%)`,
                          borderRadius: 12,
                          padding: 16,
                          border: `1px solid ${showDayBiasAnalysis ? '#00aaff' : 'rgba(0,170,255,0.3)'}`,
                          textAlign: 'center',
                          cursor: 'pointer',
                          transition: 'all 0.2s ease',
                          display: 'flex',
                          flexDirection: 'column',
                          justifyContent: 'center',
                          alignItems: 'center'
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>
                          <span style={{ fontSize: 10, color: '#888', letterSpacing: 1 }}>INTRADAY</span>
                          <span style={{
                            fontSize: 12,
                            color: '#666',
                            transform: showDayBiasAnalysis ? 'rotate(180deg)' : 'rotate(0deg)',
                            transition: 'transform 0.2s ease'
                          }}>‚ñº</span>
                        </div>
                        <div style={{
                          fontSize: 14,
                          fontWeight: 700,
                          color: '#00aaff',
                          padding: '6px 14px',
                          background: 'rgba(0,170,255,0.2)',
                          borderRadius: 6,
                          marginBottom: 8
                        }}>
                          {dailyLabel}
                        </div>
                        <div style={{ fontSize: 9, color: '#666' }}>
                          {dailyPctFromHighA.toFixed(0)}% from high
                        </div>
                      </div>
                    </div>

                    {/* Expanded Content Row - TPO on left, Day Bias on right */}
                    {(showIntradayTPO || showDayBiasAnalysis) && (
                      <div style={{
                        display: 'flex',
                        gap: 12,
                        marginBottom: 12
                      }}>
                        {/* Left: TPO Content (under M/W/D) */}
                        <div style={{ flex: 3 }}>
                          {showIntradayTPO && (
                            <div style={{
                              background: 'rgba(0,0,0,0.2)',
                              borderRadius: 10,
                              border: '1px solid rgba(0,170,255,0.3)',
                              padding: 12
                            }}>
                              {/* Day Open & Weekly Open Row - Key Levels */}
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 12 }}>
                                <div style={{
                                  background: 'rgba(0,0,0,0.3)',
                                  borderRadius: 8,
                                  padding: '10px 12px',
                                  border: signals.dayOpen.bias !== 'NEUTRAL' ? `1px solid ${signals.dayOpen.color}40` : 'none'
                                }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>
                                    DAY OPEN (18:00 ET)
                                  </div>
                                  <div style={{ display: 'flex', alignItems: 'baseline', gap: 6, flexWrap: 'wrap' }}>
                                    <span style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: signals.dayOpen.color }}>
                                      {signals.dayOpen.position}
                                    </span>
                                    {signals.dayOpen.price > 0 && (
                                      <>
                                        <span style={{ fontSize: 11, color: '#666', fontFamily: 'monospace' }}>
                                          ${signals.dayOpen.price?.toFixed(2)}
                                        </span>
                                        <span style={{ fontSize: 10, color: signals.dayOpen.color }}>
                                          ({signals.dayOpen.diff > 0 ? '+' : ''}{signals.dayOpen.diff?.toFixed(1)}pts)
                                        </span>
                                      </>
                                    )}
                                  </div>
                                  {signals.dayOpen.bias && signals.dayOpen.bias !== 'NEUTRAL' && (
                                    <div style={{ fontSize: 9, color: signals.dayOpen.color, marginTop: 4 }}>
                                      {signals.dayOpen.bias === 'BULLISH' ? 'Buying below open' : 'Selling above open'}
                                    </div>
                                  )}
                                </div>
                                <div style={{
                                  background: signals.weeklyOpen.position === '--' ? 'rgba(50,50,60,0.5)' : 'rgba(0,0,0,0.3)',
                                  borderRadius: 8,
                                  padding: '10px 12px',
                                  border: signals.weeklyOpen.bias && signals.weeklyOpen.bias !== 'NEUTRAL' ? `1px solid ${signals.weeklyOpen.color}40` : '1px dashed rgba(255,255,255,0.1)'
                                }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>
                                    WEEKLY OPEN (Sun 18:00)
                                  </div>
                                  {signals.weeklyOpen.position === '--' ? (
                                    <div>
                                      <span style={{ fontSize: isMobile ? 13 : 14, fontWeight: 600, color: '#666' }}>
                                        N/A
                                      </span>
                                      <div style={{ fontSize: 9, color: '#555', marginTop: 4 }}>
                                        Not tracked yet - sets on Sunday 18:00 ET
                                      </div>
                                    </div>
                                  ) : (
                                    <>
                                      <div style={{ display: 'flex', alignItems: 'baseline', gap: 6, flexWrap: 'wrap' }}>
                                        <span style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: signals.weeklyOpen.color }}>
                                          {signals.weeklyOpen.position}
                                        </span>
                                        {signals.weeklyOpen.price > 0 && (
                                          <>
                                            <span style={{ fontSize: 11, color: '#666', fontFamily: 'monospace' }}>
                                              ${signals.weeklyOpen.price?.toFixed(2)}
                                            </span>
                                            <span style={{ fontSize: 10, color: signals.weeklyOpen.color }}>
                                              ({signals.weeklyOpen.diff > 0 ? '+' : ''}{signals.weeklyOpen.diff?.toFixed(1)}pts)
                                            </span>
                                          </>
                                        )}
                                      </div>
                                      {signals.weeklyOpen.bias && signals.weeklyOpen.bias !== 'NEUTRAL' && (
                                        <div style={{ fontSize: 9, color: signals.weeklyOpen.color, marginTop: 4 }}>
                                          {signals.weeklyOpen.bias === 'BULLISH' ? 'Buying below weekly open' : 'Selling above weekly open'}
                                        </div>
                                      )}
                                    </>
                                  )}
                                </div>
                              </div>

                              {/* Daily Row: IB | Location wrt PVA | Opening */}
                              <div style={{
                                display: 'grid',
                                gridTemplateColumns: isMobile ? '1fr 1fr' : '1fr 1fr 1fr',
                                gap: 12,
                                marginBottom: 12
                              }}>
                                <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: '10px 12px' }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>INITIAL BALANCE</div>
                                  <div style={{ display: 'flex', alignItems: 'baseline', gap: 6 }}>
                                    <span style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: signals.daily.ib.color }}>
                                      {signals.daily.ib.level}
                                    </span>
                                    {signals.daily.ib.pct !== '--' && (
                                      <span style={{ fontSize: 11, color: '#666' }}>{signals.daily.ib.pct}%</span>
                                    )}
                                  </div>
                                </div>
                                <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: '10px 12px' }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>LOCATION wrt PVA</div>
                                  <div>
                                    <span style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: signals.daily.pvaLocation.color }}>
                                      {signals.daily.pvaLocation.status}
                                    </span>
                                    {signals.daily.pvaLocation.detail && (
                                      <div style={{ fontSize: 10, color: '#888', marginTop: 2 }}>{signals.daily.pvaLocation.detail}</div>
                                    )}
                                  </div>
                                </div>
                                <div style={{
                                  background: 'rgba(0,0,0,0.3)',
                                  borderRadius: 8,
                                  padding: '10px 12px',
                                  gridColumn: isMobile ? '1 / -1' : 'auto'
                                }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>OPENING TYPE</div>
                                  <div style={{ display: 'flex', alignItems: 'baseline', gap: 8 }}>
                                    <span style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: signals.daily.opening.color }}>
                                      {signals.daily.opening.type}
                                    </span>
                                    {signals.daily.opening.full && (
                                      <span style={{ fontSize: 10, color: '#666' }}>{signals.daily.opening.full}</span>
                                    )}
                                  </div>
                                </div>
                              </div>

                              {/* Critical Row: AB Overlap | Tails | TPO Bias */}
                              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12 }}>
                                <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: '10px 12px' }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>AB OVERLAP</div>
                                  <div style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: signals.critical.abOverlap.color }}>
                                    {signals.critical.abOverlap.pct !== '--' ? `${signals.critical.abOverlap.pct}%` : '--'}
                                  </div>
                                </div>
                                <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: '10px 12px' }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>TAIL/EXCESS</div>
                                  <div style={{ display: 'flex', gap: 8 }}>
                                    <span style={{
                                      fontSize: 11,
                                      padding: '2px 6px',
                                      borderRadius: 4,
                                      background: signals.critical.buyingTail ? '#00ff8830' : 'rgba(255,255,255,0.05)',
                                      color: signals.critical.buyingTail ? '#00ff88' : '#555'
                                    }}>
                                      BUY
                                    </span>
                                    <span style={{
                                      fontSize: 11,
                                      padding: '2px 6px',
                                      borderRadius: 4,
                                      background: signals.critical.sellingTail ? '#ff446630' : 'rgba(255,255,255,0.05)',
                                      color: signals.critical.sellingTail ? '#ff4466' : '#555'
                                    }}>
                                      SELL
                                    </span>
                                  </div>
                                </div>
                                <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: '10px 12px' }}>
                                  <div style={{ fontSize: 9, color: '#888', letterSpacing: 1, marginBottom: 4 }}>TPO BIAS</div>
                                  <div style={{ fontSize: isMobile ? 14 : 16, fontWeight: 700, color: signals.critical.tpoBias.color }}>
                                    {signals.critical.tpoBias.direction}
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>

                        {/* Right: Day Bias A/B (under Intraday) */}
                        <div style={{ flex: 1 }}>
                          {showDayBiasAnalysis && (() => {
                        const clamp = (val, min, max) => Math.min(Math.max(val, min), max);
                        const now = new Date();
                        const etTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
                        const etHour = etTime.getHours();
                        const etMinute = etTime.getMinutes();
                        const etTimeNum = etHour * 100 + etMinute;
                        const IB_START = 820;
                        const IB_END = 930;
                        const isPreIBLocal = etTimeNum < IB_START;
                        const isInIB = etTimeNum >= IB_START && etTimeNum < IB_END;
                        const isPostIB = etTimeNum >= IB_END;

                        // === LIVE DATA ===
                        const currentPrice = liveData?.current_price || zoneData?.current_price || 0;
                        const dayHigh = liveData?.day_high || currentPrice;
                        const dayLow = liveData?.day_low || currentPrice;
                        const dayOpen = liveData?.day_open || currentPrice;
                        const dayRange = dayHigh - dayLow;

                        // === IB DATA (from market profile) ===
                        const ibHigh = profileData?.ib_high || 0;
                        const ibLow = profileData?.ib_low || 0;
                        const ibRange = profileData?.ib_range || (ibHigh - ibLow) || 0;
                        const ibComplete = profileData?.ib_complete || isPostIB;

                        // === VWAP (Full Day) ===
                        const vwap = profileData?.vwap || liveData?.vwap || 0;
                        const vwapDiff = vwap > 0 ? (currentPrice - vwap) : 0;
                        const vwapAbove = vwapDiff >= 0;

                        // === RTH VWAP (9:30 ET Anchored) ===
                        const rthVwap = profileData?.rth_vwap || liveData?.rth_vwap || 0;
                        const rthVwapDiff = rthVwap > 0 ? (currentPrice - rthVwap) : 0;
                        const rthVwapAbove = rthVwapDiff >= 0;

                        // === OVERNIGHT DATA (18:00 ‚Üí 8:20 ET) ===
                        // Calculate from individual session data
                        const biasEndedSessions = liveData?.endedSessions || liveData?.ended_sessions || {};
                        let calcOvernightHigh = 0;
                        let calcOvernightLow = 999999;
                        ['pre_asia', 'asia_open', 'asia_close', 'low_volume', 'london', 'pre_us'].forEach(sessId => {
                          const sess = biasEndedSessions[sessId];
                          if (sess?.high > 0) calcOvernightHigh = Math.max(calcOvernightHigh, sess.high);
                          if (sess?.low > 0 && sess?.low < 999999) calcOvernightLow = Math.min(calcOvernightLow, sess.low);
                        });
                        if (calcOvernightLow === 999999) calcOvernightLow = 0;
                        const overnightHigh = calcOvernightHigh || liveData?.overnight_high || 0;
                        const overnightLow = calcOvernightLow || liveData?.overnight_low || 0;
                        const overnightRange = (overnightHigh > 0 && overnightLow > 0) ? (overnightHigh - overnightLow) : 0;

                        // === US IB VWAP (08:20 ET Anchored) ===
                        const usIbVwap = liveData?.us_ib_vwap || 0;
                        const usIbVwapDiff = usIbVwap > 0 ? (currentPrice - usIbVwap) : 0;
                        const usIbVwapAbove = usIbVwapDiff >= 0;

                        // === BIAS A: Overnight Range (18:00 ‚Üí 8:20) ===
                        // Use overnight range for A section (not full day range)
                        const aboveOvernightHigh = currentPrice > overnightHigh;
                        let pctFromHigh = 50;
                        let ptsFromHigh = 0;
                        if (overnightRange > 0) {
                          pctFromHigh = ((overnightHigh - currentPrice) / overnightRange * 100);
                          ptsFromHigh = overnightHigh - currentPrice;
                        }
                        // Upside/Downside from CURRENT PRICE to overnight boundaries
                        const upsidePotential = overnightHigh - currentPrice; // Can be negative if above
                        const downsideRisk = currentPrice - overnightLow;
                        const biasAValid = overnightRange > 0;

                        // === BIAS B: IB Range (8:20 ‚Üí 9:30) ===
                        // % from IB high = where CURRENT PRICE is relative to IB high
                        const aboveIBHigh = currentPrice > ibHigh;
                        let pctB = 50;
                        let ibUpsidePotential = 0;
                        let ibDownsideRisk = 0;
                        const biasBValid = ibComplete && ibRange > 0 && ibHigh > 0 && ibLow > 0;

                        if (biasBValid && currentPrice > 0) {
                          pctB = ((ibHigh - currentPrice) / ibRange * 100);
                          // Upside/Downside from current price to IB boundaries
                          ibUpsidePotential = ibHigh - currentPrice; // Can be negative if above
                          ibDownsideRisk = currentPrice - ibLow;
                        }

                        const getBiasLabel = (pct) => {
                          if (pct <= 20) return { label: 'V.BULLISH', color: '#00ff88' };
                          if (pct <= 40) return { label: 'BULLISH', color: '#88ff88' };
                          if (pct >= 80) return { label: 'V.BEARISH', color: '#ff4466' };
                          if (pct >= 60) return { label: 'BEARISH', color: '#ff8888' };
                          return { label: 'NEUTRAL', color: '#ffaa00' };
                        };

                        const biasA = getBiasLabel(pctFromHigh);
                        const biasB = getBiasLabel(pctB);
                        const etTimeStr = etTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

                        return (
                          <div style={{
                            background: 'linear-gradient(135deg, rgba(59,130,246,0.08) 0%, rgba(245,158,11,0.08) 100%)',
                            borderRadius: 10,
                            border: `1px solid ${dailyColor}`,
                            padding: 16
                          }}>
                            {/* Header */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, paddingBottom: 8, borderBottom: '1px solid rgba(255,255,255,0.08)' }}>
                              <div style={{ fontSize: 10, fontWeight: 700, color: '#fff', letterSpacing: 1 }}>
                                DAY BIAS ANALYSIS
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                <span style={{ fontSize: 9, color: '#888', fontFamily: 'monospace' }}>{etTimeStr} ET</span>
                                <span style={{
                                  fontSize: 8,
                                  padding: '3px 8px',
                                  borderRadius: 4,
                                  background: isPreIBLocal ? 'rgba(255,170,0,0.2)' : isInIB ? 'rgba(0,170,255,0.2)' : 'rgba(0,255,136,0.2)',
                                  color: isPreIBLocal ? '#ffaa00' : isInIB ? '#00aaff' : '#00ff88',
                                  fontWeight: 600
                                }}>
                                  {isPreIBLocal ? 'OVERNIGHT' : isInIB ? 'IB FORMING' : 'RTH'}
                                </span>
                              </div>
                            </div>

                            {/* Two column layout for A and B */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                              {/* A: Overnight */}
                              <div style={{
                                background: 'rgba(59,130,246,0.1)',
                                borderRadius: 8,
                                padding: 12,
                                border: '1px solid rgba(59,130,246,0.2)'
                              }}>
                                <div style={{ fontSize: 10, fontWeight: 600, color: '#3B82F6', marginBottom: 8 }}>
                                  A. O/N ‚Üí 8:20 {isPreIBLocal && <span style={{ color: '#ffaa00', fontWeight: 400 }}>(building)</span>}
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, marginBottom: 10 }}>
                                  <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 6, padding: 8, textAlign: 'center' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>O/N RANGE</div>
                                    <div style={{ fontSize: 16, fontWeight: 700, color: '#3B82F6' }}>
                                      {overnightRange > 0 ? overnightRange.toFixed(1) : '--'}
                                    </div>
                                    <div style={{ fontSize: 7, color: '#555' }}>
                                      {overnightHigh > 0 && overnightLow > 0 ? `${overnightLow.toFixed(1)}-${overnightHigh.toFixed(1)}` : ''}
                                    </div>
                                  </div>
                                  <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 6, padding: 8, textAlign: 'center' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>% FROM HIGH</div>
                                    <div style={{ fontSize: 14, fontWeight: 700, color: aboveOvernightHigh ? '#00ff88' : biasA.color }}>
                                      {!biasAValid ? '--' : aboveOvernightHigh ? 'ABOVE' : `${Math.max(0, pctFromHigh).toFixed(0)}%`}
                                    </div>
                                    <div style={{ fontSize: 10, fontWeight: 600, color: ptsFromHigh >= 0 ? '#ff4466' : '#00ff88' }}>
                                      {biasAValid ? `${ptsFromHigh >= 0 ? '-' : '+'}${Math.abs(ptsFromHigh).toFixed(1)} pts` : ''}
                                    </div>
                                  </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 6 }}>
                                  <div style={{ textAlign: 'center', background: 'rgba(0,0,0,0.2)', borderRadius: 4, padding: 6 }}>
                                    <div style={{ fontSize: 7, color: '#666' }}>VWAP</div>
                                    {vwap > 0 ? (
                                      <>
                                        <div style={{ fontSize: 11, fontWeight: 600, color: vwapAbove ? '#ff4466' : '#00ff88' }}>
                                          {vwapAbove ? '+' : '-'}{Math.abs(vwapDiff).toFixed(0)} pts
                                        </div>
                                        <div style={{ fontSize: 8, color: vwapAbove ? '#ff4466' : '#00ff88' }}>
                                          {vwapAbove ? 'ABOVE' : 'BELOW'}
                                        </div>
                                      </>
                                    ) : (
                                      <div style={{ fontSize: 11, color: '#666' }}>--</div>
                                    )}
                                  </div>
                                  <div style={{ textAlign: 'center', background: 'rgba(0,0,0,0.2)', borderRadius: 4, padding: 6 }}>
                                    <div style={{ fontSize: 7, color: '#666' }}>{upsidePotential >= 0 ? 'UPSIDE' : 'EXT HIGH'}</div>
                                    <div style={{ fontSize: 11, fontWeight: 600, color: upsidePotential >= 0 ? '#00ff88' : '#00aaff' }}>
                                      {upsidePotential >= 0 ? '+' : ''}{upsidePotential.toFixed(0)}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: 'center', background: 'rgba(0,0,0,0.2)', borderRadius: 4, padding: 6 }}>
                                    <div style={{ fontSize: 7, color: '#666' }}>{downsideRisk >= 0 ? 'DOWNSIDE' : 'EXT LOW'}</div>
                                    <div style={{ fontSize: 11, fontWeight: 600, color: downsideRisk >= 0 ? '#ff4466' : '#00aaff' }}>
                                      {downsideRisk >= 0 ? '-' : '+'}{Math.abs(downsideRisk).toFixed(0)}
                                    </div>
                                  </div>
                                </div>
                              </div>

                              {/* B: IB */}
                              <div style={{
                                background: isPostIB ? 'rgba(245,158,11,0.1)' : 'rgba(255,255,255,0.03)',
                                borderRadius: 8,
                                padding: 12,
                                border: `1px solid ${isPostIB ? 'rgba(245,158,11,0.2)' : 'rgba(255,255,255,0.08)'}`
                              }}>
                                <div style={{ fontSize: 10, fontWeight: 600, color: isPostIB ? '#F59E0B' : '#666', marginBottom: 8 }}>
                                  B. IB ‚Üí 9:30 {isPreIBLocal && <span style={{ color: '#666', fontWeight: 400 }}>(waiting)</span>}
                                  {isInIB && <span style={{ color: '#00aaff', fontWeight: 400 }}>(forming)</span>}
                                </div>
                                {isPostIB && biasBValid ? (
                                  <>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, marginBottom: 10 }}>
                                      <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 6, padding: 8, textAlign: 'center' }}>
                                        <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>IB RANGE</div>
                                        <div style={{ fontSize: 16, fontWeight: 700, color: '#F59E0B' }}>{ibRange.toFixed(0)}</div>
                                      </div>
                                      <div style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 6, padding: 8, textAlign: 'center' }}>
                                        <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>FROM IB HIGH</div>
                                        <div style={{ fontSize: 16, fontWeight: 700, color: aboveIBHigh ? '#00ff88' : '#ff4466' }}>
                                          {aboveIBHigh ? '+' : ''}{(currentPrice - ibHigh).toFixed(0)} pts
                                        </div>
                                      </div>
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 6 }}>
                                      <div style={{ textAlign: 'center', background: 'rgba(0,0,0,0.2)', borderRadius: 4, padding: 6 }}>
                                        <div style={{ fontSize: 7, color: '#666' }}>RTH VWAP</div>
                                        {rthVwap > 0 ? (
                                          <>
                                            <div style={{ fontSize: 11, fontWeight: 600, color: rthVwapAbove ? '#ff4466' : '#00ff88' }}>
                                              {rthVwapAbove ? '+' : '-'}{Math.abs(rthVwapDiff).toFixed(0)} pts
                                            </div>
                                            <div style={{ fontSize: 8, color: rthVwapAbove ? '#ff4466' : '#00ff88' }}>
                                              {rthVwapAbove ? 'ABOVE' : 'BELOW'}
                                            </div>
                                          </>
                                        ) : (
                                          <div style={{ fontSize: 11, color: '#666' }}>--</div>
                                        )}
                                      </div>
                                      <div style={{ textAlign: 'center', background: 'rgba(0,0,0,0.2)', borderRadius: 4, padding: 6 }}>
                                        <div style={{ fontSize: 7, color: '#666' }}>{ibUpsidePotential >= 0 ? 'UPSIDE' : 'EXT HIGH'}</div>
                                        <div style={{ fontSize: 11, fontWeight: 600, color: ibUpsidePotential >= 0 ? '#00ff88' : '#00aaff' }}>
                                          {ibUpsidePotential >= 0 ? '+' : ''}{ibUpsidePotential.toFixed(0)}
                                        </div>
                                      </div>
                                      <div style={{ textAlign: 'center', background: 'rgba(0,0,0,0.2)', borderRadius: 4, padding: 6 }}>
                                        <div style={{ fontSize: 7, color: '#666' }}>{ibDownsideRisk >= 0 ? 'EXT LOW' : 'DOWNSIDE'}</div>
                                        <div style={{ fontSize: 11, fontWeight: 600, color: ibDownsideRisk >= 0 ? '#ff4466' : '#00aaff' }}>
                                          {ibDownsideRisk >= 0 ? '-' : '+'}{Math.abs(ibDownsideRisk).toFixed(0)}
                                        </div>
                                      </div>
                                    </div>
                                  </>
                                ) : (
                                  <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    minHeight: 100,
                                    color: '#555'
                                  }}>
                                    <div style={{ fontSize: 24, marginBottom: 8, opacity: 0.5 }}>
                                      {isPreIBLocal ? '‚è≥' : 'üìä'}
                                    </div>
                                    <div style={{ fontSize: 11 }}>
                                      {isPreIBLocal ? 'Starts 8:20 ET' : `IB: ${ibRange.toFixed(0)} pts`}
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

              {/* NON-DISCRETIONARY ANALYSIS - Separate Collapsible Section */}
              <div style={{
                marginBottom: 12,
                marginTop: 12,
                background: 'rgba(0,0,0,0.2)',
                borderRadius: 10,
                border: '1px solid rgba(255,255,255,0.08)',
                overflow: 'hidden'
              }}>
                {/* Collapsible Header */}
                <div
                  onClick={() => setShowNonDiscAnalysis(!showNonDiscAnalysis)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px 16px',
                    cursor: 'pointer',
                    background: `linear-gradient(135deg, ${overallColor}15 0%, rgba(0,0,0,0.3) 100%)`,
                    borderBottom: showNonDiscAnalysis ? '1px solid rgba(255,255,255,0.08)' : 'none',
                    transition: 'all 0.2s ease'
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    <span style={{
                      fontSize: 11,
                      fontWeight: 600,
                      color: overallColor,
                      letterSpacing: '0.1em'
                    }}>
                      NON-DISCRETIONARY ANALYSIS
                    </span>
                    {!showNonDiscAnalysis && (
                      <span style={{
                        fontSize: 10,
                        color: '#666',
                        fontStyle: 'italic'
                      }}>
                        (Detailed reasoning for bias)
                      </span>
                    )}
                  </div>
                  <span style={{
                    fontSize: 16,
                    color: '#666',
                    transform: showNonDiscAnalysis ? 'rotate(180deg)' : 'rotate(0deg)',
                    transition: 'transform 0.2s ease'
                  }}>
                    ‚ñº
                  </span>
                </div>

                {/* Collapsible Content */}
                {showNonDiscAnalysis && (
                  <div style={{
                    padding: '14px 16px',
                    background: `linear-gradient(135deg, ${overallColor}08 0%, transparent 50%)`,
                  }}>
                    <div style={{ fontSize: isMobile ? 12 : 13, color: '#bbb', lineHeight: 1.85 }}>
                  {(() => {
                    const reasons = [];

                    // Monthly/Weekly context with factors
                    if (signals.monthly.bias !== 'NEUTRAL' || signals.weekly.bias !== 'NEUTRAL') {
                      // Weekly Analysis
                      if (signals.weekly.bias !== 'NEUTRAL') {
                        const weeklyFactorText = signals.weekly.factors?.length > 0
                          ? ` (${signals.weekly.factors.slice(0, 2).join(', ')})`
                          : '';
                        reasons.push(`Weekly bias is <span style="color:${signals.weekly.color};font-weight:600">${signals.weekly.bias}</span>${weeklyFactorText} based on week range, weekly open, and prior day position.`);
                      }
                      // Monthly Analysis
                      if (signals.monthly.bias !== 'NEUTRAL') {
                        const monthlyFactorText = signals.monthly.factors?.length > 0
                          ? ` (${signals.monthly.factors.slice(0, 2).join(', ')})`
                          : '';
                        reasons.push(`Monthly bias is <span style="color:${signals.monthly.color};font-weight:600">${signals.monthly.bias}</span>${monthlyFactorText} based on rolling 20-day range analysis.`);
                      }
                    }

                    // Day Open Analysis
                    if (signals.dayOpen.price > 0 && signals.dayOpen.bias !== 'NEUTRAL') {
                      if (signals.dayOpen.bias === 'BULLISH') {
                        reasons.push(`Price is <span style="color:#00ff88;font-weight:600">${Math.abs(signals.dayOpen.diff).toFixed(1)}pts BELOW</span> Day Open ($${signals.dayOpen.price.toFixed(2)}) - buying below the open adds bullish confidence.`);
                      } else {
                        reasons.push(`Price is <span style="color:#ff4466;font-weight:600">${Math.abs(signals.dayOpen.diff).toFixed(1)}pts ABOVE</span> Day Open ($${signals.dayOpen.price.toFixed(2)}) - selling above the open adds bearish confidence.`);
                      }
                    }

                    // Weekly Open Analysis
                    if (signals.weeklyOpen.price > 0 && signals.weeklyOpen.bias !== 'NEUTRAL') {
                      if (signals.weeklyOpen.bias === 'BULLISH') {
                        reasons.push(`Price is <span style="color:#00ff88;font-weight:600">${Math.abs(signals.weeklyOpen.diff).toFixed(1)}pts BELOW</span> Weekly Open ($${signals.weeklyOpen.price.toFixed(2)}) - buying below weekly open is a key bullish signal.`);
                      } else {
                        reasons.push(`Price is <span style="color:#ff4466;font-weight:600">${Math.abs(signals.weeklyOpen.diff).toFixed(1)}pts ABOVE</span> Weekly Open ($${signals.weeklyOpen.price.toFixed(2)}) - selling above weekly open is a key bearish signal.`);
                      }
                    }

                    // IB Analysis
                    if (signals.daily.ib.level !== '--' && signals.daily.ib.level !== 'FORMING') {
                      const ibExplanation = {
                        'LOW': `Initial Balance is <span style="color:#00ff88;font-weight:600">LOW</span> (${signals.daily.ib.pct}% of ADR) - expect range extension and directional move.`,
                        'MEDIUM': `Initial Balance is <span style="color:#ffaa00;font-weight:600">MEDIUM</span> (${signals.daily.ib.pct}% of ADR) - balanced day possible, watch for breakout.`,
                        'HIGH': `Initial Balance is <span style="color:#ff4466;font-weight:600">HIGH</span> (${signals.daily.ib.pct}% of ADR) - range may be set, rotational day likely.`
                      };
                      reasons.push(ibExplanation[signals.daily.ib.level] || '');
                    }

                    // PVA Location
                    if (signals.daily.pvaLocation.status !== '--') {
                      const pvaExplanations = {
                        'IN': `Price is <span style="color:#00aaff;font-weight:600">INSIDE</span> prior value area (${signals.daily.pvaLocation.detail}) - value acceptance, mean reversion favored.`,
                        'OUT': signals.daily.pvaLocation.detail?.includes('Above')
                          ? `Price is <span style="color:#00ff88;font-weight:600">ABOVE</span> prior value area (${signals.daily.pvaLocation.detail}) - bullish continuation if accepted.`
                          : `Price is <span style="color:#ff4466;font-weight:600">BELOW</span> prior value area (${signals.daily.pvaLocation.detail}) - bearish continuation if accepted.`,
                        'DYNAMIC': `Price is at <span style="color:#ffaa00;font-weight:600">DYNAMIC</span> boundary of prior value area - key decision point, watch for acceptance or rejection.`
                      };
                      reasons.push(pvaExplanations[signals.daily.pvaLocation.status] || '');
                    }

                    // Opening Type
                    if (signals.daily.opening.type !== '--' && signals.daily.opening.type !== 'DEV') {
                      const openExplanations = {
                        'OD': `Opening type is <span style="color:#00ff88;font-weight:600">Open Drive</span> - strong conviction, trend day likely, fade at your own risk.`,
                        'OTD': `Opening type is <span style="color:#88ff88;font-weight:600">Open Test Drive</span> - tested and confirmed direction, follow the trend.`,
                        'ORR': `Opening type is <span style="color:#ff8888;font-weight:600">Open Rejection Reverse</span> - initial move failed, expect reversal to dominate.`,
                        'OA': `Opening type is <span style="color:#ffaa00;font-weight:600">Open Auction</span> - balanced open, wait for value to establish before trading.`
                      };
                      reasons.push(openExplanations[signals.daily.opening.type] || '');
                    }

                    // AB Overlap
                    if (signals.critical.abOverlap.pct !== '--') {
                      const pct = parseFloat(signals.critical.abOverlap.pct);
                      if (pct < 33) {
                        reasons.push(`AB overlap is <span style="color:#00ff88;font-weight:600">${pct}%</span> (trending) - A and B periods show directional conviction, continuation expected.`);
                      } else if (pct <= 50) {
                        reasons.push(`AB overlap is <span style="color:#ffaa00;font-weight:600">${pct}%</span> (mixed) - some directional bias but not strong, be selective.`);
                      } else {
                        reasons.push(`AB overlap is <span style="color:#ff4466;font-weight:600">${pct}%</span> (rotational) - high overlap suggests balance, range-bound trading likely.`);
                      }
                    }

                    // Tails
                    if (signals.critical.buyingTail || signals.critical.sellingTail) {
                      if (signals.critical.buyingTail) {
                        reasons.push(`<span style="color:#00ff88;font-weight:600">Buying tail/excess</span> detected at lows - aggressive buyers defending, support is strong.`);
                      }
                      if (signals.critical.sellingTail) {
                        reasons.push(`<span style="color:#ff4466;font-weight:600">Selling tail/excess</span> detected at highs - aggressive sellers defending, resistance is strong.`);
                      }
                    }

                    // TPO Bias
                    if (signals.critical.tpoBias.direction !== '--') {
                      const tpoExplanations = {
                        'BULLISH': `TPO distribution is <span style="color:#00ff88;font-weight:600">BULLISH</span> - POC is above value area midpoint, buyers in control.`,
                        'BEARISH': `TPO distribution is <span style="color:#ff4466;font-weight:600">BEARISH</span> - POC is below value area midpoint, sellers in control.`,
                        'NEUTRAL': `TPO distribution is <span style="color:#ffaa00;font-weight:600">NEUTRAL</span> - balanced profile, no clear directional bias from structure.`
                      };
                      reasons.push(tpoExplanations[signals.critical.tpoBias.direction] || '');
                    }

                    // Final conclusion
                    const conclusion = overallDirection.includes('BULLISH')
                      ? `<strong style="color:#00ff88">Conclusion:</strong> Multiple factors align bullish. Look for long entries at support zones with proper risk management.`
                      : overallDirection.includes('BEARISH')
                      ? `<strong style="color:#ff4466">Conclusion:</strong> Multiple factors align bearish. Exercise caution on longs, consider short setups at resistance.`
                      : `<strong style="color:#ffaa00">Conclusion:</strong> Mixed signals present. Wait for clearer structure or trade both sides at extremes.`;

                    reasons.push(conclusion);

                    // Format each reason as a styled paragraph
                    const formattedHtml = reasons.map((r, i) => {
                      const isConclusion = i === reasons.length - 1;
                      const borderColor = isConclusion ? overallColor : 'rgba(255,255,255,0.1)';
                      const bg = isConclusion ? `${overallColor}10` : 'transparent';
                      const padding = isConclusion ? '10px 10px 10px 10px' : '2px 0 2px 10px';
                      const radius = isConclusion ? '6px' : '0';
                      const marginTop = isConclusion ? '16px' : '0';
                      return `<div style="margin-bottom: ${isConclusion ? '0' : '12px'}; margin-top: ${marginTop}; padding: ${padding}; border-left: 2px solid ${borderColor}; background: ${bg}; border-radius: ${radius};">${r}</div>`;
                    }).join('');

                    return <span dangerouslySetInnerHTML={{ __html: formattedHtml }} />;
                  })()}
                    </div>
                  </div>
                )}
              </div>
                  </>
                );
              })()}
            </div>
          );
        })()}

        {zoneData.buy_zones?.length > 0 ? (
          zoneData.buy_zones.map((zone, i) => (
            <ZoneCard key={zone.id} zone={zone} rank={i + 1} />
          ))
        ) : zoneData.all_zones?.length > 0 ? (
          // Show nearest zones in greyed-out "waiting" state when no actionable buy zones
          <>
            <div style={{
              background: 'rgba(100,100,100,0.1)',
              borderRadius: 8,
              padding: 12,
              marginBottom: 16,
              border: '1px dashed rgba(255,255,255,0.2)',
              textAlign: 'center'
            }}>
              <div style={{ fontSize: 12, color: '#888' }}>
                ‚è≥ Waiting for price to approach support zones
              </div>
              <div style={{ fontSize: 10, color: '#666', marginTop: 4 }}>
                Nearest zones shown below (greyed out until actionable)
              </div>
            </div>
            {/* Show top 3 nearest zones sorted by distance */}
            {[...zoneData.all_zones]
              .sort((a, b) => Math.abs(a.distance) - Math.abs(b.distance))
              .slice(0, 3)
              .map((zone, i) => (
                <div key={zone.id} style={{ opacity: 0.5, filter: 'grayscale(50%)' }}>
                  <ZoneCard zone={zone} rank={i + 1} isWaiting={true} />
                </div>
              ))
            }
          </>
        ) : (
          <div style={{
            background: 'rgba(20,20,28,0.9)',
            borderRadius: 12,
            padding: isMobile ? 24 : 40,
            textAlign: 'center',
            color: '#888',
          }}>
            <div style={{ fontSize: isMobile ? 36 : 48, marginBottom: 16 }}>üéØ</div>
            <div style={{ fontSize: isMobile ? 14 : 16, marginBottom: 8 }}>No zones available</div>
            <div style={{ fontSize: 12 }}>Waiting for zone data to load...</div>
          </div>
        )}
      </div>

      {/* Right: Price Ladder with all zones and trade status - Only when docked */}
      {(!priceLadderFloating || isMobile) && (
        <div
          onClick={() => !isMobile && setPriceLadderFloating(true)}
          style={{
            flex: isMobile ? 'none' : 1,
            minHeight: isMobile ? 300 : 0,
            height: isMobile ? 400 : 'auto',
            cursor: isMobile ? 'default' : 'pointer'
          }}
          title={isMobile ? '' : 'Click to minimize'}
        >
          <ZonePriceLadder
            zones={zoneData.all_zones}
            buyZones={zoneData.buy_zones}
            currentPrice={zoneData.current_price}
          />
        </div>
      )}
    </div>
  );
};

// ============================================
// TPO CANDLESTICK CHART (Lightweight Charts)
// ============================================
// ============================================
// MARKET PROFILE / TPO DASHBOARD
// ============================================
const MarketProfile = ({ selectedContract }) => {
  const [data, setData] = useState(null);
  const [connected, setConnected] = useState(false);
  const [selectedSession, setSelectedSession] = useState('1week'); // '1week', '1week_rth', '4week', '4week_rth'
  const [showAllSessions, setShowAllSessions] = useState(false);
  const [historicData, setHistoricData] = useState(null);
  const [loadingHistoric, setLoadingHistoric] = useState(false);
  const [showHistoric, setShowHistoric] = useState(false);
  const [showHistoricTable, setShowHistoricTable] = useState(false); // Toggle for data table visibility
  const [hoveredProfile, setHoveredProfile] = useState(null); // For custom tooltip
  const [hoveredDonut, setHoveredDonut] = useState(null); // For donut chart tooltip
  const [displayTickSize, setDisplayTickSize] = useState(0); // 0 = auto-fit, fits all prices on screen
  const [tpoExpanded, setTpoExpanded] = useState(false); // Expand TPO chart to full width
  const [tpoDisplayMode, setTpoDisplayMode] = useState('compact'); // 'compact' or 'expanded' block view
  const [tpoZoomed, setTpoZoomed] = useState(false); // Zoom: finer tick size for more detail
  const [hideNonIB, setHideNonIB] = useState(false); // Hide sessions without IB in 1-week charts
  const [chartCrosshair, setChartCrosshair] = useState({ show: false, x: 0, y: 0, price: 0, dayIdx: -1, day: null }); // Crosshair for 4-week chart
  const [chartTooltipPinned, setChartTooltipPinned] = useState(false); // Whether tooltip is pinned (click to show/hide)
  const chart1wInitialized = React.useRef(false);
  const chart4wInitialized = React.useRef(false);
  const chart1wRef = React.useRef(null);
  const chart4wRef = React.useRef(null);
  const { isMobile, isTablet } = useResponsive();

  // Scroll chart to current time (rightmost) and current price (center vertically)
  const scrollChartToCurrent = (currentPrice) => {
    // Reset init flags so scroll happens
    chart1wInitialized.current = false;
    chart4wInitialized.current = false;
    // Scroll after a brief delay to allow render
    setTimeout(() => {
      // Horizontal scroll to rightmost (current time)
      if (chart1wRef.current) {
        chart1wRef.current.scrollLeft = chart1wRef.current.scrollWidth - chart1wRef.current.clientWidth;
        // Vertical scroll to center of content (approximate current price area)
        const scrollTarget1w = (chart1wRef.current.scrollHeight - chart1wRef.current.clientHeight) / 2;
        chart1wRef.current.scrollTop = scrollTarget1w;
      }
      if (chart4wRef.current) {
        chart4wRef.current.scrollLeft = chart4wRef.current.scrollWidth - chart4wRef.current.clientWidth;
        // Vertical scroll to center of content
        const scrollTarget4w = (chart4wRef.current.scrollHeight - chart4wRef.current.clientHeight) / 2;
        chart4wRef.current.scrollTop = scrollTarget4w;
      }
      // Also sync the price scales
      const priceScale1w = document.getElementById('price-scale-1w');
      const priceScale4w = document.getElementById('price-scale-4w');
      if (priceScale1w && chart1wRef.current) {
        priceScale1w.scrollTop = chart1wRef.current.scrollTop;
      }
      if (priceScale4w && chart4wRef.current) {
        priceScale4w.scrollTop = chart4wRef.current.scrollTop;
      }
    }, 300);
  };

  // Auto-scroll to current time/price on contract change or first load
  const hasAutoScrolled = React.useRef(false);
  useEffect(() => {
    if (data?.current_price && !hasAutoScrolled.current) {
      scrollChartToCurrent(data.current_price);
      hasAutoScrolled.current = true;
    }
  }, [data?.current_price]);

  // Reset auto-scroll flag when contract changes
  useEffect(() => {
    hasAutoScrolled.current = false;
  }, [selectedContract]);

  // Helper: Convert TPO letter to period index (A=0, B=1, ... Z=25, AA=26, AB=27, etc.)
  const letterToIndex = (letter) => {
    if (letter.length === 1) return letter.charCodeAt(0) - 65;
    return 26 + (letter.charCodeAt(0) - 65) * 26 + (letter.charCodeAt(1) - 65);
  };

  // RTH period range (09:30-16:15 ET from 18:00 start)
  // 18:00 to 09:30 = 15.5 hours = 31 periods, 09:30 to 16:15 = 6.75 hours = ~14 periods
  const RTH_START_PERIOD = 31;
  const RTH_END_PERIOD = 44;

  // Filter profiles to only RTH hours
  const filterRTHProfile = (profiles) => {
    if (!profiles) return {};
    const filtered = {};
    for (const [price, letters] of Object.entries(profiles)) {
      const rthLetters = letters.filter(l => {
        const idx = letterToIndex(l);
        return idx >= RTH_START_PERIOD && idx <= RTH_END_PERIOD;
      });
      if (rthLetters.length > 0) filtered[price] = rthLetters;
    }
    return filtered;
  };

  // Calculate POC from profiles
  const calculatePOCFromProfiles = (profiles) => {
    if (!profiles || Object.keys(profiles).length === 0) return 0;
    let maxCount = 0;
    let pocPrice = 0;
    for (const [price, letters] of Object.entries(profiles)) {
      if (letters.length > maxCount) {
        maxCount = letters.length;
        pocPrice = parseFloat(price);
      }
    }
    return pocPrice;
  };

  // Calculate Value Area (70% of TPOs around POC)
  const calculateValueAreaFromProfiles = (profiles, poc, tickSize = 0.1) => {
    if (!profiles || Object.keys(profiles).length === 0) return { vah: 0, val: 0 };

    const sortedPrices = Object.keys(profiles).map(p => parseFloat(p)).sort((a, b) => b - a);
    const totalTPOs = Object.values(profiles).reduce((sum, letters) => sum + letters.length, 0);
    const targetTPOs = Math.ceil(totalTPOs * 0.7);

    let included = new Set();
    let currentTPOs = 0;

    // Start with POC
    const pocKey = poc.toFixed(1);
    if (profiles[pocKey]) {
      included.add(poc);
      currentTPOs += profiles[pocKey].length;
    }

    // Expand outward from POC
    let upIdx = sortedPrices.indexOf(poc) - 1;
    let downIdx = sortedPrices.indexOf(poc) + 1;

    while (currentTPOs < targetTPOs && (upIdx >= 0 || downIdx < sortedPrices.length)) {
      const upPrice = upIdx >= 0 ? sortedPrices[upIdx] : null;
      const downPrice = downIdx < sortedPrices.length ? sortedPrices[downIdx] : null;
      const upTPOs = upPrice ? (profiles[upPrice.toFixed(1)]?.length || 0) : 0;
      const downTPOs = downPrice ? (profiles[downPrice.toFixed(1)]?.length || 0) : 0;

      if (upTPOs >= downTPOs && upPrice !== null) {
        included.add(upPrice);
        currentTPOs += upTPOs;
        upIdx--;
      } else if (downPrice !== null) {
        included.add(downPrice);
        currentTPOs += downTPOs;
        downIdx++;
      } else {
        break;
      }
    }

    const includedPrices = Array.from(included);
    return {
      vah: Math.max(...includedPrices),
      val: Math.min(...includedPrices)
    };
  };

  // Build 4-week composite profile from historic data
  const build4WeekComposite = (historicProfiles, rthOnly = false) => {
    if (!historicProfiles || historicProfiles.length === 0) return null;

    const days = historicProfiles.slice(0, 20); // Last 20 trading days (~4 weeks)
    const tickSize = 2.0; // Coarser resolution for composite
    const profiles = {};
    let allHighs = [];
    let allLows = [];

    days.forEach((day, idx) => {
      const letter = idx < 26 ? String.fromCharCode(65 + idx) : 'A' + String.fromCharCode(65 + idx - 26);
      const high = rthOnly ? (day.ib_high || day.high) : day.high;
      const low = rthOnly ? (day.ib_low || day.low) : day.low;

      if (high && low) {
        allHighs.push(high);
        allLows.push(low);

        for (let p = Math.floor(low / tickSize) * tickSize; p <= high; p += tickSize) {
          const key = p.toFixed(1);
          if (!profiles[key]) profiles[key] = [];
          profiles[key].push(letter);
        }
      }
    });

    const poc = calculatePOCFromProfiles(profiles);
    const { vah, val } = calculateValueAreaFromProfiles(profiles, poc, tickSize);

    return {
      profiles,
      poc,
      vah,
      val,
      high: Math.max(...allHighs),
      low: Math.min(...allLows),
      period_count: days.length,
      current_letter: days.length > 0 ? (days.length < 26 ? String.fromCharCode(65 + days.length - 1) : 'T') : 'A',
      ib_high: null,
      ib_low: null,
      is_composite: true,
      days_included: days.length
    };
  };

  // Fetch TPO data - re-fetch when contract changes
  useEffect(() => {
    // Clear data immediately when contract changes
    setData(null);
    setConnected(false);

    // Wait for backend contract sync to complete before starting to poll
    const startPolling = async () => {
      // Initial delay to let contract sync complete
      await new Promise(resolve => setTimeout(resolve, 3000));

      const fetchTPOData = async () => {
        try {
          const response = await fetch(`${API_BASE}/market-profile`);
          if (response.ok) {
            const tpoData = await response.json();

            // Verify data matches expected contract by checking POC range
            // GC/NQ/ES/CL: POC < 20000, BTC: POC > 50000
            const isBTCContract = selectedContract === 'BTC-SPOT' || selectedContract?.startsWith('BTC');
            const pocValue = tpoData.poc || 0;
            const dataLooksLikeBTC = pocValue > 50000;

            // Only accept data if it matches the expected contract
            if (isBTCContract === dataLooksLikeBTC || pocValue === 0) {
              setData(tpoData);
              setConnected(true);
            } else {
              // Data is for wrong contract - backend still switching
              console.log(`Waiting for backend to switch - got POC ${pocValue} but expected ${isBTCContract ? 'BTC' : 'non-BTC'}`);
            }
          }
        } catch (e) {
          setConnected(false);
        }
      };

      fetchTPOData();
      return setInterval(fetchTPOData, 1000); // Poll every second
    };

    let intervalId;
    startPolling().then(id => { intervalId = id; });

    return () => { if (intervalId) clearInterval(intervalId); };
  }, [selectedContract]); // Re-fetch when contract changes

  // Fetch historic TPO data with localStorage caching (daily refresh, per contract)
  const HISTORIC_CACHE_VERSION = 10; // Fixed session view volume profile with backend data
  const getHistoricCacheKey = (contract) => `tpo_historic_cache_${contract || 'GC'}`;

  useEffect(() => {
    // Clear historic data when contract changes
    setHistoricData(null);

    const loadHistoricData = async () => {
      const cacheKey = getHistoricCacheKey(selectedContract);

      // Check localStorage cache first
      try {
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          const parsed = JSON.parse(cached);
          const today = new Date().toISOString().split('T')[0];
          // Only use cache if: version matches, date is today, has data, AND has actual profiles (or is BTC spot)
          const isBTCContract = selectedContract === 'BTC-SPOT' || selectedContract?.startsWith('BTC');
          const hasProfiles = parsed.data?.profiles?.length > 0;
          if (parsed.version === HISTORIC_CACHE_VERSION && parsed.date === today && parsed.data && (hasProfiles || isBTCContract)) {
            setHistoricData(parsed.data);
            return;
          } else if (!hasProfiles && !isBTCContract) {
            // Cached data is empty for non-spot contract - clear it
            localStorage.removeItem(cacheKey);
            console.log('Cleared stale cache with empty profiles');
          }
        }
      } catch (e) {
        console.warn('Invalid cache, fetching fresh data');
      }

      // Wait for backend contract sync to complete (backend needs ~10-15s to switch + load history)
      await new Promise(resolve => setTimeout(resolve, 12000));

      // Fetch fresh data with retry logic
      setLoadingHistoric(true);
      let retries = 3;
      let data = null;

      while (retries > 0) {
        try {
          const res = await fetch(`${API_BASE}/historic-tpo?days=40`);
          data = await res.json();

          // Check if data is valid (not empty spot response)
          const isBTCContract = selectedContract === 'BTC-SPOT' || selectedContract?.startsWith('BTC');
          const isSpotResponse = data.source === 'spot_no_history';

          if (isSpotResponse && !isBTCContract) {
            // Backend is still on wrong contract, wait and retry
            console.log(`Historic TPO: Backend still on spot, retrying in 5s... (${retries} left)`);
            retries--;
            await new Promise(resolve => setTimeout(resolve, 5000));
            continue;
          }

          // Data is valid - break out of retry loop
          break;
        } catch (e) {
          console.error('Failed to fetch historic TPO:', e);
          retries--;
          await new Promise(resolve => setTimeout(resolve, 3000));
        }
      }

      if (!data) {
        setLoadingHistoric(false);
        return;
      }

      // Only cache if we got actual data (profiles > 0 or it's a spot contract)
      const isBTCContract = selectedContract === 'BTC-SPOT' || selectedContract?.startsWith('BTC');
      if (data.profiles?.length > 0 || isBTCContract) {
        const cacheData = {
          version: HISTORIC_CACHE_VERSION,
          date: new Date().toISOString().split('T')[0],
          contract: selectedContract,
          data: data
        };
        try {
          localStorage.setItem(cacheKey, JSON.stringify(cacheData));
        } catch (e) {
          console.warn('Failed to cache historic data:', e);
        }
      }

      setHistoricData(data);
      setLoadingHistoric(false);
    };

    loadHistoricData();
  }, [selectedContract]); // Re-fetch when contract changes

  // For historic views (1-week and 4-week), allow rendering if historic data exists even without live connection
  const is1WeekView = selectedSession === '1week' || selectedSession === '1week_rth';
  const is4WeekView = selectedSession === '4week' || selectedSession === '4week_rth';
  const isHistoricView = is1WeekView || is4WeekView;

  if (!connected || !data) {
    // If it's a historic view and we have historic data, don't block - let it render
    if (isHistoricView && historicData?.profiles?.length > 0) {
      // Continue to render historic view
    } else {
      return (
        <div style={{ padding: 40, textAlign: 'center', color: '#8b8b8b' }}>
          <div style={{ fontSize: 48, marginBottom: 16 }}>üìä</div>
          <div style={{ fontSize: 18, marginBottom: 8 }}>Connecting to Market Profile...</div>
          <div style={{ fontSize: 13 }}>Waiting for TPO data from backend</div>
        </div>
      );
    }
  }

  // Get profile data based on selection
  const getActiveProfile = () => {
    // Return null if no data yet (prevents crashes during initial load)
    // Allow historic views to proceed with historicData
    if (!data && !isHistoricView) {
      return null;
    }

    // 1 Week and 4 Week views are rendered separately - return null for getActiveProfile
    if (isHistoricView) {
      return null;
    }

    if (selectedSession === 'day') {
      return {
        profiles: data.profiles,
        poc: data.poc,
        vah: data.vah,
        val: data.val,
        single_prints: data.single_prints || [],
        ib_high: data.ib_high,
        ib_low: data.ib_low,
        period_count: data.period_count,
        current_letter: data.current_letter,
        open_price: data.open_price,
        high: data.high || Math.max(...Object.keys(data.profiles || {}).map(p => parseFloat(p))),
        low: data.low || Math.min(...Object.keys(data.profiles || {}).map(p => parseFloat(p))),
        volume: data.volume
      };
    }

    // RTH: Filter full day profile to Regular Trading Hours only (09:30-16:15)
    if (selectedSession === 'rth') {
      const rthProfiles = filterRTHProfile(data.profiles);
      const rthPOC = calculatePOCFromProfiles(rthProfiles);
      const { vah, val } = calculateValueAreaFromProfiles(rthProfiles, rthPOC);
      const prices = Object.keys(rthProfiles).map(p => parseFloat(p));
      return {
        profiles: rthProfiles,
        poc: rthPOC,
        vah,
        val,
        single_prints: [],
        ib_high: data.ib_high,
        ib_low: data.ib_low,
        period_count: Object.values(rthProfiles).flat().filter((v, i, a) => a.indexOf(v) === i).length,
        current_letter: data.current_letter,
        open_price: data.rth_open || data.open_price,
        high: prices.length > 0 ? Math.max(...prices) : 0,
        low: prices.length > 0 ? Math.min(...prices) : 0,
        volume: data.volume
      };
    }

    // 4 Week Composite: Each day = one period
    if (selectedSession === '4week') {
      return build4WeekComposite(historicData?.profiles, false);
    }

    // 4 Week RTH Composite
    if (selectedSession === '4week_rth') {
      return build4WeekComposite(historicData?.profiles, true);
    }

    // Regular session
    const session = data.sessions?.[selectedSession];
    return session ? {
      profiles: session.profiles,
      poc: session.poc,
      vah: session.vah,
      val: session.val,
      single_prints: session.single_prints || [],
      ib_high: session.ib_high,
      ib_low: session.ib_low,
      period_count: session.period_count,
      current_letter: session.current_letter,
      high: session.high,
      low: session.low,
      volume: session.volume
    } : null;
  };

  const activeProfile = getActiveProfile();

  // Convert profiles object to sorted array for rendering, with optional aggregation
  const baseTickSize = data?.tick_size || 0.1;

  // Calculate auto-fit tick size based on price range
  const calculateAutoFitTickSize = (profiles) => {
    if (!profiles || Object.keys(profiles).length === 0) return 1;

    const prices = Object.keys(profiles).map(p => parseFloat(p));
    const minP = Math.min(...prices);
    const maxP = Math.max(...prices);
    const range = maxP - minP;

    // Target ~45 rows to fit on screen comfortably
    const targetRows = 45;
    const idealTickSize = range / targetRows;

    // Round to nice tick sizes
    if (idealTickSize <= 0.1) return 0.1;
    if (idealTickSize <= 0.5) return 0.5;
    if (idealTickSize <= 1) return 1;
    if (idealTickSize <= 2) return 2;
    if (idealTickSize <= 5) return 5;
    if (idealTickSize <= 10) return 10;
    return Math.ceil(idealTickSize / 10) * 10;
  };

  // Auto-calculate tick size if set to 'auto' (0)
  const effectiveTickSize = displayTickSize === 0
    ? calculateAutoFitTickSize(activeProfile?.profiles)
    : displayTickSize;

  const aggregateProfiles = (profiles, targetTickSize) => {
    if (!profiles || targetTickSize <= baseTickSize) {
      // No aggregation needed
      return Object.entries(profiles)
        .map(([price, letters]) => ({ price: parseFloat(price), letters }))
        .sort((a, b) => b.price - a.price);
    }

    // Aggregate into larger tick sizes
    const aggregated = {};
    Object.entries(profiles).forEach(([price, letters]) => {
      const p = parseFloat(price);
      const bucket = Math.floor(p / targetTickSize) * targetTickSize;
      if (!aggregated[bucket]) {
        aggregated[bucket] = new Set();
      }
      letters.forEach(l => aggregated[bucket].add(l));
    });

    return Object.entries(aggregated)
      .map(([price, letters]) => ({ price: parseFloat(price), letters: Array.from(letters) }))
      .sort((a, b) => b.price - a.price);
  };

  const profileEntries = activeProfile?.profiles
    ? aggregateProfiles(activeProfile.profiles, effectiveTickSize)
    : [];

  // Calculate price range
  const prices = profileEntries.map(e => e.price);
  const minPrice = Math.min(...prices) || 0;
  const maxPrice = Math.max(...prices) || 0;
  const priceRange = maxPrice - minPrice;

  // Day type colors
  const dayTypeColors = {
    'developing': '#8b8b8b',
    'normal': '#00aaff',
    'non_trend': '#888888',
    'normal_var': '#00ff88',
    'trend': '#ff6600',
    'double_dist': '#ff4466',
    'neutral': '#9370DB'
  };

  // Open type colors
  const openTypeColors = {
    'developing': '#8b8b8b',
    'OA': '#888888',
    'ORR': '#ffaa00',
    'OTD': '#00ff88',
    'OD': '#00aaff'
  };

  // Profile shape icons
  const shapeIcons = {
    'developing': '‚óØ',
    'D': 'D',
    'P': 'P',
    'b': 'b',
    'B': 'B'
  };

  // Display data - use yesterday's profile data when selected, otherwise live data
  const shapeDescriptions = {
    'D': { name: 'D-Shape', sentiment: 'Balanced', description: 'Normal distribution, fat middle, thin tails' },
    'P': { name: 'P-Shape', sentiment: 'Bullish', description: 'Fat top, thin bottom - buying pressure' },
    'b': { name: 'b-Shape', sentiment: 'Bearish', description: 'Thin top, fat bottom - selling pressure' },
    'B': { name: 'B-Shape', sentiment: 'Neutral', description: 'Double distribution - two bulges' }
  };
  const displayData = data || {};

  return (
    <div style={{
      display: isMobile ? 'flex' : 'grid',
      flexDirection: isMobile ? 'column' : undefined,
      gridTemplateColumns: isMobile ? undefined : (isTablet ? '1fr' : (tpoExpanded ? '1fr' : '280px 1fr 300px')),
      gap: isMobile ? 12 : 20,
      height: isMobile ? 'auto' : '100%',
      padding: isMobile ? 12 : 0,
      overflow: isMobile ? 'auto' : 'hidden',
    }}>
      {/* Left Sidebar - Session Selection & Key Levels */}
      {!tpoExpanded && <div style={{
        display: 'flex',
        flexDirection: isMobile ? 'row' : 'column',
        gap: isMobile ? 8 : 16,
        overflowX: isMobile ? 'auto' : undefined,
        flexWrap: isMobile ? 'nowrap' : undefined,
      }}>
        {/* Session Selector */}
        <div style={{
          background: 'rgba(20,20,28,0.9)',
          borderRadius: 12,
          border: '1px solid rgba(255,255,255,0.08)',
          padding: 16
        }}>
          {/* TPO RANGES - Sleek selector */}
          <div style={{ fontSize: 10, color: '#666', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 1 }}>TPO Ranges</div>

          {/* ETH / RTH Toggle */}
          <div style={{ display: 'flex', marginBottom: 12, background: 'rgba(20,20,30,0.8)', borderRadius: 8, padding: 3 }}>
            <button
              onClick={() => {
                const isRTH = selectedSession.includes('_rth');
                if (isRTH) setSelectedSession(selectedSession.replace('_rth', ''));
                scrollChartToCurrent();
              }}
              onMouseEnter={(e) => {
                const tooltip = e.currentTarget.querySelector('.tooltip');
                if (tooltip) tooltip.style.opacity = '1';
              }}
              onMouseLeave={(e) => {
                const tooltip = e.currentTarget.querySelector('.tooltip');
                if (tooltip) tooltip.style.opacity = '0';
              }}
              style={{
                flex: 1,
                padding: '8px 12px',
                background: !selectedSession.includes('_rth') ? 'linear-gradient(135deg, rgba(0,170,255,0.3) 0%, rgba(0,221,255,0.2) 100%)' : 'transparent',
                border: !selectedSession.includes('_rth') ? '1px solid rgba(0,221,255,0.5)' : '1px solid transparent',
                borderRadius: 6,
                color: !selectedSession.includes('_rth') ? '#00ddff' : '#666',
                fontSize: 11,
                fontWeight: 600,
                cursor: 'pointer',
                position: 'relative',
                transition: 'all 0.2s ease'
              }}
            >
              ETH
              <div className="tooltip" style={{
                position: 'absolute',
                bottom: '100%',
                left: '50%',
                transform: 'translateX(-50%)',
                marginBottom: 6,
                padding: '6px 10px',
                background: 'rgba(15,15,25,0.95)',
                border: '1px solid rgba(0,221,255,0.3)',
                borderRadius: 6,
                color: '#00ddff',
                fontSize: 10,
                fontWeight: 500,
                whiteSpace: 'nowrap',
                opacity: 0,
                transition: 'opacity 0.2s ease',
                pointerEvents: 'none',
                zIndex: 100
              }}>
                18:00 - 17:00 ET
              </div>
            </button>
            <button
              onClick={() => {
                const isRTH = selectedSession.includes('_rth');
                if (!isRTH) setSelectedSession(selectedSession + '_rth');
                scrollChartToCurrent();
              }}
              onMouseEnter={(e) => {
                const tooltip = e.currentTarget.querySelector('.tooltip');
                if (tooltip) tooltip.style.opacity = '1';
              }}
              onMouseLeave={(e) => {
                const tooltip = e.currentTarget.querySelector('.tooltip');
                if (tooltip) tooltip.style.opacity = '0';
              }}
              style={{
                flex: 1,
                padding: '8px 12px',
                background: selectedSession.includes('_rth') ? 'linear-gradient(135deg, rgba(0,255,136,0.3) 0%, rgba(0,200,100,0.2) 100%)' : 'transparent',
                border: selectedSession.includes('_rth') ? '1px solid rgba(0,255,136,0.5)' : '1px solid transparent',
                borderRadius: 6,
                color: selectedSession.includes('_rth') ? '#00ff88' : '#666',
                fontSize: 11,
                fontWeight: 600,
                cursor: 'pointer',
                position: 'relative',
                transition: 'all 0.2s ease'
              }}
            >
              RTH
              <div className="tooltip" style={{
                position: 'absolute',
                bottom: '100%',
                left: '50%',
                transform: 'translateX(-50%)',
                marginBottom: 6,
                padding: '6px 10px',
                background: 'rgba(15,15,25,0.95)',
                border: '1px solid rgba(0,255,136,0.3)',
                borderRadius: 6,
                color: '#00ff88',
                fontSize: 10,
                fontWeight: 500,
                whiteSpace: 'nowrap',
                opacity: 0,
                transition: 'opacity 0.2s ease',
                pointerEvents: 'none',
                zIndex: 100
              }}>
                09:30 - 16:15 ET
              </div>
            </button>
          </div>

          {/* 1 Week / 4 Week Buttons */}
          <div style={{ display: 'flex', gap: 6 }}>
            <button
              onClick={() => {
                const isRTH = selectedSession.includes('_rth');
                setSelectedSession(isRTH ? '1week_rth' : '1week');
                scrollChartToCurrent();
              }}
              style={{
                flex: 1,
                padding: '12px 8px',
                background: (selectedSession === '1week' || selectedSession === '1week_rth')
                  ? 'linear-gradient(135deg, rgba(147,112,219,0.25) 0%, rgba(100,80,180,0.15) 100%)'
                  : 'rgba(30,30,40,0.6)',
                border: (selectedSession === '1week' || selectedSession === '1week_rth')
                  ? '1px solid rgba(147,112,219,0.6)'
                  : '1px solid rgba(255,255,255,0.06)',
                borderRadius: 8,
                color: (selectedSession === '1week' || selectedSession === '1week_rth') ? '#ba68c8' : '#888',
                fontSize: 12,
                fontWeight: 600,
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
            >
              1 Week
            </button>
            <button
              onClick={() => {
                const isRTH = selectedSession.includes('_rth');
                setSelectedSession(isRTH ? '4week_rth' : '4week');
                scrollChartToCurrent();
              }}
              style={{
                flex: 1,
                padding: '12px 8px',
                background: (selectedSession === '4week' || selectedSession === '4week_rth')
                  ? 'linear-gradient(135deg, rgba(147,112,219,0.25) 0%, rgba(100,80,180,0.15) 100%)'
                  : 'rgba(30,30,40,0.6)',
                border: (selectedSession === '4week' || selectedSession === '4week_rth')
                  ? '1px solid rgba(147,112,219,0.6)'
                  : '1px solid rgba(255,255,255,0.06)',
                borderRadius: 8,
                color: (selectedSession === '4week' || selectedSession === '4week_rth') ? '#ba68c8' : '#888',
                fontSize: 12,
                fontWeight: 600,
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
            >
              4 Week
            </button>
          </div>
        </div>

        {/* Key Levels - Compact */}
        <div style={{
          background: 'rgba(20,20,28,0.9)',
          borderRadius: 10,
          border: '1px solid rgba(255,255,255,0.08)',
          padding: '10px 12px'
        }}>
          <div style={{ fontSize: 11, color: '#8b8b8b', marginBottom: 8, textTransform: 'uppercase', letterSpacing: 1 }}>
            Key Levels
          </div>

          {/* POC */}
          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
            <span style={{ color: '#ffaa00', fontWeight: 600, fontSize: 12 }}>POC</span>
            <span style={{ color: '#fff', fontFamily: 'monospace', fontSize: 12 }}>
              {activeProfile?.poc?.toFixed(2) || '--'}
            </span>
          </div>

          {/* VAH */}
          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
            <span style={{ color: '#00aaff', fontWeight: 600, fontSize: 12 }}>VAH</span>
            <span style={{ color: '#fff', fontFamily: 'monospace', fontSize: 12 }}>
              {activeProfile?.vah?.toFixed(2) || '--'}
            </span>
          </div>

          {/* VAL */}
          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
            <span style={{ color: '#00aaff', fontWeight: 600, fontSize: 12 }}>VAL</span>
            <span style={{ color: '#fff', fontFamily: 'monospace', fontSize: 12 }}>
              {activeProfile?.val?.toFixed(2) || '--'}
            </span>
          </div>

          {/* US IB High */}
          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
            <span style={{ color: '#9370DB', fontWeight: 600, fontSize: 12 }}>US IB High</span>
            <span style={{ color: '#fff', fontFamily: 'monospace', fontSize: 12 }}>
              {activeProfile?.ib_high?.toFixed(2) || '--'}
            </span>
          </div>

          {/* US IB Low */}
          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
            <span style={{ color: '#9370DB', fontWeight: 600, fontSize: 12 }}>US IB Low</span>
            <span style={{ color: '#fff', fontFamily: 'monospace', fontSize: 12 }}>
              {activeProfile?.ib_low?.toFixed(2) || '--'}
            </span>
          </div>

          {/* Single Prints Count */}
          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
            <span style={{ color: '#ff4466', fontWeight: 600, fontSize: 12 }}>Single Prints</span>
            <span style={{ color: '#ff4466', fontFamily: 'monospace', fontSize: 12 }}>
              {activeProfile?.single_prints?.length || 0}
            </span>
          </div>
        </div>

        {/* Confluence Score - TPO HTF Analysis Hierarchy */}
        {data?.confluence && (
          <div style={{
            background: 'rgba(20,20,28,0.9)',
            borderRadius: 10,
            border: '1px solid rgba(255,255,255,0.08)',
            padding: '10px 12px',
            marginTop: 8
          }}>
            <div style={{ fontSize: 11, color: '#8b8b8b', marginBottom: 8, textTransform: 'uppercase', letterSpacing: 1 }}>
              Confluence Score
            </div>

            {/* Total Score with color coding */}
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              padding: '8px 10px',
              background: data.confluence.total_score >= 8 ? 'rgba(0,255,136,0.15)' :
                         data.confluence.total_score >= 5 ? 'rgba(0,170,255,0.15)' :
                         data.confluence.total_score >= 2 ? 'rgba(255,170,0,0.15)' :
                         data.confluence.total_score >= -1 ? 'rgba(139,139,139,0.15)' :
                         'rgba(255,68,102,0.15)',
              borderRadius: 6,
              marginBottom: 8,
              border: `1px solid ${
                data.confluence.total_score >= 8 ? 'rgba(0,255,136,0.3)' :
                data.confluence.total_score >= 5 ? 'rgba(0,170,255,0.3)' :
                data.confluence.total_score >= 2 ? 'rgba(255,170,0,0.3)' :
                data.confluence.total_score >= -1 ? 'rgba(139,139,139,0.3)' :
                'rgba(255,68,102,0.3)'
              }`
            }}>
              <div>
                <div style={{
                  fontSize: 20,
                  fontWeight: 700,
                  color: data.confluence.total_score >= 8 ? '#00ff88' :
                         data.confluence.total_score >= 5 ? '#00aaff' :
                         data.confluence.total_score >= 2 ? '#ffaa00' :
                         data.confluence.total_score >= -1 ? '#8b8b8b' :
                         '#ff4466',
                  fontFamily: 'monospace'
                }}>
                  {data.confluence.total_score > 0 ? '+' : ''}{data.confluence.total_score}
                </div>
                <div style={{ fontSize: 11, color: '#8b8b8b', marginTop: 2 }}>
                  {data.confluence.confidence}
                </div>
              </div>
              <div style={{ textAlign: 'right' }}>
                <div style={{
                  fontSize: 14,
                  fontWeight: 600,
                  color: data.confluence.trade_direction === 'LONG' ? '#00ff88' :
                         data.confluence.trade_direction === 'SHORT' ? '#ff4466' : '#8b8b8b'
                }}>
                  {data.confluence.trade_direction === 'LONG' ? '‚Üë LONG' :
                   data.confluence.trade_direction === 'SHORT' ? '‚Üì SHORT' :
                   data.confluence.trade_direction}
                </div>
                <div style={{ fontSize: 11, color: '#8b8b8b', marginTop: 2 }}>
                  Size: {data.confluence.position_size_pct}%
                </div>
              </div>
            </div>

            {/* Action recommendation */}
            <div style={{
              padding: '8px 12px',
              background: 'rgba(30,30,40,0.6)',
              borderRadius: 6,
              marginBottom: 12,
              fontSize: 12,
              color: data.confluence.action?.includes('NO TRADE') || data.confluence.action?.includes('SKIP') ? '#ff4466' :
                     data.confluence.action?.includes('ADD') ? '#00ff88' : '#fff'
            }}>
              {data.confluence.action}
            </div>

            {/* Score breakdown with factor details */}
            <div style={{ fontSize: 11, color: '#8b8b8b' }}>
              {/* R1 Macro */}
              <div style={{ borderBottom: '1px solid rgba(255,255,255,0.04)', paddingBottom: 4, marginBottom: 4 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
                  <span style={{ color: '#00ff88' }}>R1 Macro</span>
                  <span style={{ color: data.confluence.rank1_score > 0 ? '#00ff88' : '#666' }}>
                    {data.confluence.rank1_score > 0 ? '+' : ''}{data.confluence.rank1_score}
                  </span>
                </div>
                {data.confluence.factors?.rank1_macro?.length > 0 && (
                  <div style={{ paddingLeft: 8, fontSize: 10, color: '#666' }}>
                    {data.confluence.factors.rank1_macro.map((f, i) => (
                      <div key={i} style={{ padding: '2px 0' }}>{f}</div>
                    ))}
                  </div>
                )}
              </div>

              {/* R2 Volume */}
              <div style={{ borderBottom: '1px solid rgba(255,255,255,0.04)', paddingBottom: 4, marginBottom: 4 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
                  <span style={{ color: '#00aaff' }}>R2 Volume</span>
                  <span style={{ color: data.confluence.rank2_score > 0 ? '#00aaff' : '#666' }}>
                    {data.confluence.rank2_score > 0 ? '+' : ''}{data.confluence.rank2_score}
                  </span>
                </div>
                {data.confluence.factors?.rank2_volume?.length > 0 && (
                  <div style={{ paddingLeft: 8, fontSize: 10, color: '#00aaff', opacity: 0.7 }}>
                    {data.confluence.factors.rank2_volume.map((f, i) => (
                      <div key={i} style={{ padding: '2px 0' }}>{f}</div>
                    ))}
                  </div>
                )}
              </div>

              {/* R3 Structure */}
              <div style={{ borderBottom: '1px solid rgba(255,255,255,0.04)', paddingBottom: 4, marginBottom: 4 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
                  <span style={{ color: '#ffaa00' }}>R3 Structure</span>
                  <span style={{ color: data.confluence.rank3_score > 0 ? '#ffaa00' : '#666' }}>
                    {data.confluence.rank3_score > 0 ? '+' : ''}{data.confluence.rank3_score}
                  </span>
                </div>
                {data.confluence.factors?.rank3_structure?.length > 0 && (
                  <div style={{ paddingLeft: 8, fontSize: 10, color: '#ffaa00', opacity: 0.7 }}>
                    {data.confluence.factors.rank3_structure.map((f, i) => (
                      <div key={i} style={{ padding: '2px 0' }}>{f}</div>
                    ))}
                  </div>
                )}
              </div>

              {/* R4 Timing */}
              <div style={{ borderBottom: '1px solid rgba(255,255,255,0.04)', paddingBottom: 4, marginBottom: 4 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
                  <span style={{ color: '#9370DB' }}>R4 Timing</span>
                  <span style={{ color: data.confluence.rank4_score > 0 ? '#9370DB' : '#666' }}>
                    {data.confluence.rank4_score > 0 ? '+' : ''}{data.confluence.rank4_score}
                  </span>
                </div>
                {data.confluence.factors?.rank4_timing?.length > 0 && (
                  <div style={{ paddingLeft: 8, fontSize: 10, color: '#9370DB', opacity: 0.7 }}>
                    {data.confluence.factors.rank4_timing.map((f, i) => (
                      <div key={i} style={{ padding: '2px 0' }}>{f}</div>
                    ))}
                  </div>
                )}
              </div>

              {/* Conflicts */}
              {(data.confluence.conflict_penalty !== 0 || data.confluence.factors?.conflicts?.length > 0) && (
                <div style={{ paddingBottom: 4 }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '4px 0' }}>
                    <span style={{ color: '#ff4466' }}>Conflicts</span>
                    <span style={{ color: '#ff4466' }}>
                      {data.confluence.conflict_penalty}
                    </span>
                  </div>
                  {data.confluence.factors?.conflicts?.length > 0 && (
                    <div style={{ paddingLeft: 8, fontSize: 10, color: '#ff4466', opacity: 0.7 }}>
                      {data.confluence.factors.conflicts.map((f, i) => (
                        <div key={i} style={{ padding: '2px 0' }}>{f}</div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Volume override warning */}
            {data.confluence.factors?.volume_override?.length > 0 && (
              <div style={{
                marginTop: 10,
                padding: '8px',
                background: 'rgba(255,170,0,0.1)',
                border: '1px solid rgba(255,170,0,0.3)',
                borderRadius: 6,
                fontSize: 10,
                color: '#ffaa00'
              }}>
                {data.confluence.factors.volume_override[0]}
              </div>
            )}

            {/* At key level indicator */}
            {data.confluence.level_type && (
              <div style={{
                marginTop: 8,
                fontSize: 11,
                color: '#8b8b8b'
              }}>
                At: <span style={{ color: '#00aaff', fontWeight: 600 }}>{data.confluence.level_type}</span>
                {data.confluence.at_key_level && (
                  <span style={{ color: '#fff', fontFamily: 'monospace', marginLeft: 6 }}>
                    {data.confluence.at_key_level.toFixed(2)}
                  </span>
                )}
              </div>
            )}
          </div>
        )}
      </div>}

      {/* Main TPO Grid */}
      <div style={{
        background: 'rgba(20,20,28,0.9)',
        borderRadius: 12,
        border: '1px solid rgba(255,255,255,0.08)',
        padding: 20,
        overflow: 'auto'
      }}>
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: 16
        }}>
          <div style={{ fontSize: 14, color: '#fff', fontWeight: 600 }}>
            TPO Profile - {selectedSession === 'day' ? 'Full Day' : data?.sessions?.[selectedSession]?.display}
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            {/* Zoom Toggle */}
            <button
              onClick={() => setTpoZoomed(!tpoZoomed)}
              style={{
                padding: '4px 10px',
                background: tpoZoomed ? 'rgba(0,170,255,0.25)' : 'rgba(30,30,40,0.8)',
                border: tpoZoomed ? '1px solid rgba(0,170,255,0.6)' : '1px solid rgba(255,255,255,0.1)',
                borderRadius: 6,
                color: tpoZoomed ? '#00aaff' : '#888',
                fontSize: 11,
                fontWeight: 600,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: 4
              }}
            >
              {tpoZoomed ? 'Zoomed' : 'Zoom'}
            </button>
            {/* Hide Non-IB Toggle */}
            <button
              onClick={() => setHideNonIB(!hideNonIB)}
              style={{
                padding: '4px 10px',
                background: hideNonIB ? 'rgba(255,170,0,0.25)' : 'rgba(30,30,40,0.8)',
                border: hideNonIB ? '1px solid rgba(255,170,0,0.6)' : '1px solid rgba(255,255,255,0.1)',
                borderRadius: 6,
                color: hideNonIB ? '#ffaa00' : '#888',
                fontSize: 11,
                fontWeight: 600,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: 4
              }}
            >
              {hideNonIB ? 'IB Only' : 'Hide Non-IB'}
            </button>
            <span style={{ fontSize: 12, color: '#8b8b8b', whiteSpace: 'nowrap' }}>
              Period: <span style={{ color: '#00ff88', fontWeight: 600 }}>{activeProfile?.current_letter || 'A'}</span>
            </span>
            {/* View Mode Toggle (Compact/Expanded) */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: 4,
              background: 'rgba(30,30,40,0.8)',
              borderRadius: 6,
              padding: '2px 4px',
              border: '1px solid rgba(255,255,255,0.1)'
            }}>
              <span style={{ fontSize: 10, color: '#8b8b8b', paddingLeft: 4 }}>View:</span>
              <button
                onClick={() => setTpoDisplayMode('compact')}
                style={{
                  padding: '4px 8px',
                  background: tpoDisplayMode === 'compact' ? 'rgba(0,255,136,0.2)' : 'transparent',
                  border: tpoDisplayMode === 'compact' ? '1px solid #00ff88' : '1px solid transparent',
                  borderRadius: 4,
                  color: tpoDisplayMode === 'compact' ? '#00ff88' : '#888',
                  fontSize: 10,
                  fontWeight: tpoDisplayMode === 'compact' ? 600 : 400,
                  cursor: 'pointer'
                }}
              >
                Compact
              </button>
              <button
                onClick={() => setTpoDisplayMode('expanded')}
                style={{
                  padding: '4px 8px',
                  background: tpoDisplayMode === 'expanded' ? 'rgba(0,255,136,0.2)' : 'transparent',
                  border: tpoDisplayMode === 'expanded' ? '1px solid #00ff88' : '1px solid transparent',
                  borderRadius: 4,
                  color: tpoDisplayMode === 'expanded' ? '#00ff88' : '#888',
                  fontSize: 10,
                  fontWeight: tpoDisplayMode === 'expanded' ? 600 : 400,
                  cursor: 'pointer'
                }}
              >
                Expanded
              </button>
            </div>
            {/* Expand Toggle */}
            <button
              onClick={() => setTpoExpanded(!tpoExpanded)}
              style={{
                padding: '4px 10px',
                background: tpoExpanded ? 'rgba(0,170,255,0.2)' : 'rgba(30,30,40,0.8)',
                border: tpoExpanded ? '1px solid #00aaff' : '1px solid rgba(255,255,255,0.1)',
                borderRadius: 6,
                color: tpoExpanded ? '#00aaff' : '#888',
                fontSize: 11,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: 4
              }}
              title={tpoExpanded ? 'Collapse TPO chart' : 'Expand TPO chart'}
            >
              {tpoExpanded ? '‚óÄ‚ñ∂' : '‚óÄ ‚ñ∂'}
            </button>
          </div>
        </div>

        {/* TPO Letter Grid - TradingView Style Market Profile */}
        <div style={{ fontFamily: 'monospace', fontSize: 10, position: 'relative' }}>
          {/* Loading state for historic views */}
          {isHistoricView && (!historicData || loadingHistoric) ? (
            <div style={{ textAlign: 'center', color: '#8b8b8b', padding: 60 }}>
              <div style={{ fontSize: 36, marginBottom: 16, animation: 'pulse 1.5s ease-in-out infinite' }}>üìä</div>
              <div style={{ fontSize: 16, marginBottom: 8, color: '#9370DB' }}>Loading Historic Data...</div>
              <div style={{ fontSize: 12 }}>Fetching {is1WeekView ? '1-week' : '4-week'} TPO profiles</div>
            </div>
          ) : isHistoricView && historicData?.profiles?.length === 0 ? (
            <div style={{ textAlign: 'center', color: '#8b8b8b', padding: 60 }}>
              <div style={{ fontSize: 36, marginBottom: 16 }}>üìà</div>
              <div style={{ fontSize: 16, marginBottom: 8 }}>No Historic Data Available</div>
              <div style={{ fontSize: 12 }}>Try refreshing or check backend connection</div>
            </div>
          ) : (selectedSession === '1week' || selectedSession === '1week_rth') && historicData?.profiles?.length > 0 ? (
            (() => {
              try {
              const isRTHView = selectedSession === '1week_rth';

              // Fixed tick sizes based on contract type and zoom state
              // BTC: default $50, zoomed $25 | GC: default $4, zoomed $2
              const sampleProfile = historicData.profiles[0];
              const sampleHigh = sampleProfile?.high || 5000;
              const isBTC = sampleHigh > 10000;
              const tickSize = isBTC
                ? (tpoZoomed ? 25 : 50)    // BTC: $50 default, $25 zoomed (finer than 4-week for more detail)
                : (tpoZoomed ? 2 : 4);     // GC: $4 default, $2 zoomed

              // Volume profile: tick size changes with zoom for more detail
              // BTC: $1 default ‚Üí $0.10 zoomed | GC: $0.30 default ‚Üí $0.05 zoomed
              const vpTickSize = isBTC
                ? (tpoZoomed ? 0.1 : 1)    // BTC: $1 normal, $0.10 zoomed
                : (tpoZoomed ? 0.05 : 0.3); // GC: $0.30 normal, $0.05 zoomed
              const vpSubRows = Math.max(2, Math.round(tickSize / vpTickSize)); // Sub-rows per price level
              const rowHeight = tpoZoomed ? 14 : 11; // Smaller rows when unzoomed to fit more on screen
              const letterWidth = tpoZoomed ? 11 : 10;
              const vpBarWidth = 45;
              const vpGap = 20; // Increased gap to prevent overlap

              // Session definitions (30-min periods from 18:00 start)
              // Full: Asia (18:00-03:00), London (03:00-08:20), US (08:20-15:00), Close (15:00-17:00)
              // RTH: US RTH (09:30-16:15), Close (15:00-17:00)
              const FULL_SESSIONS = [
                { key: 'asia', name: 'Asia', color: '#00ddff', start: 0, end: 17, time: '18:00-03:00' },
                { key: 'london', name: 'London', color: '#ffaa00', start: 18, end: 28, time: '03:00-08:20' },
                { key: 'us', name: 'US', color: '#00ff88', start: 28, end: 41, time: '08:20-15:00', hasIB: true, ibStart: 28, ibEnd: 30 }, // IB 08:20-09:30
                { key: 'close', name: 'Close', color: '#ba68c8', start: 42, end: 47, time: '15:00-17:00' }
              ];
              const RTH_SESSIONS = [
                { key: 'us_rth', name: 'US RTH', color: '#00ff88', start: 31, end: 44, time: '09:30-16:15', hasIB: true, ibStart: 31, ibEnd: 33 }, // IB 09:30-10:30
                { key: 'close', name: 'Close', color: '#ba68c8', start: 42, end: 47, time: '15:00-17:00' }
              ];
              const sessionDefs = isRTHView ? RTH_SESSIONS : FULL_SESSIONS;

              // Convert letter to period index
              const letterToIdx = (letter) => {
                if (letter.length === 1) return letter.charCodeAt(0) - 65;
                return 26 + (letter.charCodeAt(0) - 65) * 26 + (letter.charCodeAt(1) - 65);
              };

              // Calculate open_type from IB data for historic profiles
              const calculateOpenType = (d) => {
                if (d.open_type && d.open_type !== 'developing') return d.open_type;

                const ibHigh = d.ib_high;
                const ibLow = d.ib_low;
                const openPrice = d.open;
                const closePrice = d.close || d.high;

                if (!ibHigh || !ibLow || ibLow >= 999999 || !openPrice) return 'OA';

                const ibRange = ibHigh - ibLow;
                if (ibRange <= 0) return 'OA';

                const ibMid = (ibHigh + ibLow) / 2;
                const openPctInIB = ((openPrice - ibLow) / ibRange) * 100;

                if (openPctInIB <= 20 && closePrice > ibMid) return 'OD';
                if (openPctInIB >= 80 && closePrice < ibMid) return 'OD';
                if (openPrice > ibMid && d.low < ibLow && closePrice > ibHigh) return 'OTD';
                if (openPrice < ibMid && d.high > ibHigh && closePrice < ibLow) return 'OTD';
                if (d.high > ibHigh && closePrice < ibMid) return 'ORR';
                if (d.low < ibLow && closePrice > ibMid) return 'ORR';

                return 'OA';
              };

              // Get last 5 days (1 week of trading)
              const days = historicData.profiles.slice(0, 5).filter(d => d.tpo_profiles).reverse();

              // Convert period index to letter (A=0, B=1, ... Z=25, AA=26, etc.)
              const idxToLetter = (idx) => {
                if (idx < 26) return String.fromCharCode(65 + idx);
                return String.fromCharCode(65 + Math.floor(idx / 26) - 1) + String.fromCharCode(65 + (idx % 26));
              };

              // Build session columns
              const sessionColumns = [];
              days.forEach(day => {
                sessionDefs.forEach(sessDef => {
                  const profiles = day.tpo_profiles || {};
                  const backendPriceVolumes = day.price_volumes || {};
                  const backendDelta = day.delta_by_price || {};
                  const sessionProfiles = {};
                  const volumeByPrice = {};
                  const deltaByPrice = {};
                  let maxLetters = 0;
                  let maxPeriod = 0; // Now relative to session (0-based)
                  let sessHigh = 0, sessLow = 999999;
                  let ibHigh = null, ibLow = null;

                  // First pass: determine session's price range from TPO profiles
                  let tempHigh = 0, tempLow = 999999;
                  Object.entries(profiles).forEach(([priceKey, letters]) => {
                    const rawPrice = parseFloat(priceKey);
                    const sessLetters = letters.filter(l => {
                      const idx = letterToIdx(l);
                      return idx >= sessDef.start && idx <= sessDef.end;
                    });
                    if (sessLetters.length > 0) {
                      if (rawPrice > tempHigh) tempHigh = rawPrice;
                      if (rawPrice < tempLow) tempLow = rawPrice;
                    }
                  });

                  // Add padding for volume profile range
                  const vpPadding = isBTC ? 100 : 5;
                  const vpRangeHigh = tempHigh + vpPadding;
                  const vpRangeLow = tempLow - vpPadding;

                  // Process backend volume data within session's price range
                  Object.entries(backendPriceVolumes).forEach(([priceKey, vol]) => {
                    const rawPrice = parseFloat(priceKey);
                    // Only include if price is within session's price range (with padding)
                    if (rawPrice >= vpRangeLow && rawPrice <= vpRangeHigh) {
                      volumeByPrice[rawPrice] = (volumeByPrice[rawPrice] || 0) + vol;
                      const delta = backendDelta[priceKey] || backendDelta[rawPrice.toFixed(1)] || 0;
                      deltaByPrice[rawPrice] = (deltaByPrice[rawPrice] || 0) + delta;
                    }
                  });

                  Object.entries(profiles).forEach(([priceKey, letters]) => {
                    const rawPrice = parseFloat(priceKey);
                    const tpoPrice = Math.floor(rawPrice / tickSize) * tickSize;

                    const sessLetters = letters.filter(l => {
                      const idx = letterToIdx(l);
                      return idx >= sessDef.start && idx <= sessDef.end;
                    });

                    if (sessLetters.length > 0) {
                      if (!sessionProfiles[tpoPrice]) sessionProfiles[tpoPrice] = new Set();
                      sessLetters.forEach(l => {
                        // Remap letter to start from A for this session
                        const originalIdx = letterToIdx(l);
                        const sessionRelativeIdx = originalIdx - sessDef.start;
                        const remappedLetter = idxToLetter(sessionRelativeIdx);
                        sessionProfiles[tpoPrice].add(remappedLetter);
                        if (sessionRelativeIdx > maxPeriod) maxPeriod = sessionRelativeIdx;
                      });
                      if (rawPrice > sessHigh) sessHigh = rawPrice;
                      if (rawPrice < sessLow) sessLow = rawPrice;
                    }

                    // IB range calculation
                    if (sessDef.hasIB) {
                      const ibLetters = letters.filter(l => {
                        const idx = letterToIdx(l);
                        return idx >= sessDef.ibStart && idx <= sessDef.ibEnd;
                      });
                      if (ibLetters.length > 0) {
                        if (ibHigh === null || rawPrice > ibHigh) ibHigh = rawPrice;
                        if (ibLow === null || rawPrice < ibLow) ibLow = rawPrice;
                      }
                    }
                  });

                  Object.values(sessionProfiles).forEach(letters => {
                    if (letters.size > maxLetters) maxLetters = letters.size;
                  });

                  // Calculate max volume for this session
                  let maxVol = 0;
                  Object.values(volumeByPrice).forEach(vol => {
                    if (vol > maxVol) maxVol = vol;
                  });

                  if (Object.keys(sessionProfiles).length > 0) {
                    // Calculate TPO-based POC (price with most TPO blocks)
                    let sessPOC = 0, maxTPOCount = 0, pocPriceKey = null;
                    Object.entries(sessionProfiles).forEach(([priceKey, letters]) => {
                      if (letters.size > maxTPOCount) {
                        maxTPOCount = letters.size;
                        sessPOC = parseFloat(priceKey);
                        pocPriceKey = priceKey; // Store exact key for comparison
                      }
                    });

                    // Calculate TPO-based VAH/VAL (70% of TPOs)
                    const sortedPrices = Object.keys(sessionProfiles).map(p => parseFloat(p)).sort((a, b) => b - a);
                    const totalTPOs = Object.values(sessionProfiles).reduce((sum, s) => sum + s.size, 0);
                    let vaTPOs = 0, vaHigh = sessPOC, vaLow = sessPOC;
                    const pocIdx = sortedPrices.indexOf(Math.floor(sessPOC / tickSize) * tickSize);
                    if (pocIdx >= 0) {
                      vaTPOs = sessionProfiles[sortedPrices[pocIdx]]?.size || 0;
                      let hiIdx = pocIdx, loIdx = pocIdx;
                      while (vaTPOs < totalTPOs * 0.7 && (hiIdx > 0 || loIdx < sortedPrices.length - 1)) {
                        const hiTPOs = hiIdx > 0 ? (sessionProfiles[sortedPrices[hiIdx - 1]]?.size || 0) : 0;
                        const loTPOs = loIdx < sortedPrices.length - 1 ? (sessionProfiles[sortedPrices[loIdx + 1]]?.size || 0) : 0;
                        if (hiTPOs >= loTPOs && hiIdx > 0) { hiIdx--; vaTPOs += hiTPOs; }
                        else if (loIdx < sortedPrices.length - 1) { loIdx++; vaTPOs += loTPOs; }
                        else break;
                      }
                      vaHigh = sortedPrices[hiIdx] || sessPOC;
                      vaLow = sortedPrices[loIdx] || sessPOC;
                    }

                    // Calculate Volume POC (price with highest volume) - ACTUAL calculation, not placeholder
                    let sessionVPOC = sessPOC; // fallback to TPO POC
                    let maxVolForVPOC = 0;
                    Object.entries(volumeByPrice).forEach(([priceKey, vol]) => {
                      if (vol > maxVolForVPOC) {
                        maxVolForVPOC = vol;
                        sessionVPOC = parseFloat(priceKey);
                      }
                    });

                    // Calculate Volume-based VAH/VAL (70% of volume starting from Volume POC)
                    let volVAH = sessionVPOC, volVAL = sessionVPOC;
                    const volSortedPrices = Object.entries(volumeByPrice)
                      .map(([p, v]) => ({ price: parseFloat(p), vol: v }))
                      .sort((a, b) => a.price - b.price);
                    const totalVol = volSortedPrices.reduce((sum, p) => sum + p.vol, 0);
                    const targetVol = totalVol * 0.7;
                    if (volSortedPrices.length > 0) {
                      const vpocIdx = volSortedPrices.findIndex(p => Math.abs(p.price - sessionVPOC) < vpTickSize);
                      let vaVol = volSortedPrices[vpocIdx]?.vol || 0;
                      let vHiIdx = vpocIdx >= 0 ? vpocIdx : 0, vLoIdx = vpocIdx >= 0 ? vpocIdx : 0;
                      while (vaVol < targetVol && (vHiIdx < volSortedPrices.length - 1 || vLoIdx > 0)) {
                        const hiVol = vHiIdx < volSortedPrices.length - 1 ? volSortedPrices[vHiIdx + 1].vol : 0;
                        const loVol = vLoIdx > 0 ? volSortedPrices[vLoIdx - 1].vol : 0;
                        if (hiVol >= loVol && vHiIdx < volSortedPrices.length - 1) { vHiIdx++; vaVol += volSortedPrices[vHiIdx].vol; }
                        else if (vLoIdx > 0) { vLoIdx--; vaVol += volSortedPrices[vLoIdx].vol; }
                        else break;
                      }
                      volVAH = volSortedPrices[vHiIdx]?.price || sessionVPOC;
                      volVAL = volSortedPrices[vLoIdx]?.price || sessionVPOC;
                    }

                    const compactWidth = Math.max(maxLetters * letterWidth + vpGap + vpBarWidth + 40, 120);
                    const expandedWidth = Math.max((maxPeriod + 1) * letterWidth + vpGap + vpBarWidth + 40, 160);

                    // Calculate session-specific open and close from TPO data
                    // Open: single price level closest to middle of 'A' letter range
                    // Close: single price level closest to middle of last letter range
                    let sessOpen = null, sessClose = null;
                    let openPriceKey = null, closePriceKey = null;
                    const pricesWithA = [];
                    const lastLetterName = idxToLetter(maxPeriod);
                    const pricesWithLast = [];

                    Object.entries(sessionProfiles).forEach(([priceKey, letters]) => {
                      const price = parseFloat(priceKey);
                      if (letters.has('A')) pricesWithA.push({ price, key: priceKey });
                      if (letters.has(lastLetterName)) pricesWithLast.push({ price, key: priceKey });
                    });

                    if (pricesWithA.length > 0) {
                      const midOpen = (Math.max(...pricesWithA.map(p => p.price)) + Math.min(...pricesWithA.map(p => p.price))) / 2;
                      // Find the price key closest to the middle
                      let closestOpen = pricesWithA[0];
                      pricesWithA.forEach(p => {
                        if (Math.abs(p.price - midOpen) < Math.abs(closestOpen.price - midOpen)) closestOpen = p;
                      });
                      sessOpen = closestOpen.price;
                      openPriceKey = closestOpen.key;
                    }
                    if (pricesWithLast.length > 0) {
                      const midClose = (Math.max(...pricesWithLast.map(p => p.price)) + Math.min(...pricesWithLast.map(p => p.price))) / 2;
                      // Find the price key closest to the middle
                      let closestClose = pricesWithLast[0];
                      pricesWithLast.forEach(p => {
                        if (Math.abs(p.price - midClose) < Math.abs(closestClose.price - midClose)) closestClose = p;
                      });
                      sessClose = closestClose.price;
                      closePriceKey = closestClose.key;
                    }

                    // Calculate session-specific profile shape (P, b, D, B)
                    // P-shape: POC in upper third of range (bullish)
                    // b-shape: POC in lower third of range (bearish)
                    // D-shape: POC in middle third (balanced)
                    let sessProfileShape = 'D';
                    if (sessHigh > sessLow && sessPOC > 0) {
                      const range = sessHigh - sessLow;
                      const pocPosition = (sessPOC - sessLow) / range; // 0 = bottom, 1 = top
                      // Check for tail (thin area away from POC)
                      const upperThird = sessLow + range * 0.67;
                      const lowerThird = sessLow + range * 0.33;
                      if (pocPosition > 0.6) {
                        // POC in upper portion - check for downward tail
                        sessProfileShape = 'P'; // Fat top, tail down = bullish
                      } else if (pocPosition < 0.4) {
                        // POC in lower portion - check for upward tail
                        sessProfileShape = 'b'; // Fat bottom, tail up = bearish
                      } else {
                        sessProfileShape = 'D'; // Balanced
                      }
                    }

                    // Calculate AB Overlap % (overlap between A and B period ranges)
                    let abOverlap = null;
                    const pricesWithALetter = [];
                    const pricesWithBLetter = [];
                    Object.entries(sessionProfiles).forEach(([priceKey, letters]) => {
                      const price = parseFloat(priceKey);
                      if (letters.has('A')) pricesWithALetter.push(price);
                      if (letters.has('B')) pricesWithBLetter.push(price);
                    });
                    if (pricesWithALetter.length > 0 && pricesWithBLetter.length > 0) {
                      const aHigh = Math.max(...pricesWithALetter);
                      const aLow = Math.min(...pricesWithALetter);
                      const bHigh = Math.max(...pricesWithBLetter);
                      const bLow = Math.min(...pricesWithBLetter);
                      const aRange = aHigh - aLow;
                      const bRange = bHigh - bLow;
                      // Overlap = min(aHigh, bHigh) - max(aLow, bLow)
                      const overlapHigh = Math.min(aHigh, bHigh);
                      const overlapLow = Math.max(aLow, bLow);
                      const overlap = Math.max(0, overlapHigh - overlapLow);
                      const smallerRange = Math.min(aRange, bRange);
                      if (smallerRange > 0) {
                        abOverlap = Math.round((overlap / smallerRange) * 100);
                      } else if (overlap > 0) {
                        abOverlap = 100; // If ranges are 0 but there's overlap (same price)
                      } else {
                        abOverlap = 0;
                      }
                    }

                    sessionColumns.push({
                      date: day.date,
                      weekday: day.weekday,
                      sessKey: sessDef.key,
                      sessName: sessDef.name,
                      sessTime: sessDef.time,
                      color: sessDef.color,
                      lettersByPrice: sessionProfiles,
                      volumeByPrice,
                      deltaByPrice,
                      maxVol,
                      poc: sessPOC,
                      pocPriceKey, // Exact price key for POC row comparison
                      maxTPOCount, // Number of TPO blocks at POC
                      sessionVPOC, // Volume POC (price with highest volume) - for yellow VP highlight
                      vah: vaHigh,
                      val: vaLow,
                      volVAH,
                      volVAL,
                      high: sessHigh,
                      low: sessLow,
                      open: sessOpen,
                      close: sessClose,
                      openPriceKey, // Exact price key for Open block
                      closePriceKey, // Exact price key for Close block
                      ibHigh,
                      ibLow,
                      hasIB: sessDef.hasIB,
                      maxLetters,
                      maxPeriod,
                      sessStart: 0, // Letters now start from A (0-based) for each session
                      width: tpoDisplayMode === 'expanded' ? expandedWidth : compactWidth,
                      day_type: day.day_type,
                      open_type: calculateOpenType(day),
                      profile_shape: sessProfileShape,
                      abOverlap // AB Overlap percentage
                    });
                  }
                });
              });

              // Filter out sessions without IB if hideNonIB is enabled
              const filteredSessionColumns = hideNonIB
                ? sessionColumns.filter(s => s.hasIB && s.ibHigh && s.ibLow)
                : sessionColumns;

              if (filteredSessionColumns.length === 0) return <div style={{ textAlign: 'center', color: '#8b8b8b', padding: 40 }}>No session data{hideNonIB ? ' with IB' : ''}...</div>;

              // Calculate global price range with padding at top and bottom
              let globalHigh = 0, globalLow = 999999;
              filteredSessionColumns.forEach(s => {
                if (s.high > globalHigh) globalHigh = s.high;
                if (s.low < globalLow) globalLow = s.low;
              });
              // Add padding: 3 ticks at top and bottom for full visibility
              globalHigh = Math.ceil(globalHigh / tickSize) * tickSize + tickSize * 3;
              globalLow = Math.floor(globalLow / tickSize) * tickSize - tickSize * 3;

              const priceRows = [];
              for (let p = globalHigh; p >= globalLow; p -= tickSize) priceRows.push(p);

              // Calculate positions
              let cumX = 0;
              const sessPositions = filteredSessionColumns.map(s => {
                const pos = cumX;
                cumX += s.width;
                return pos;
              });
              const totalWidth = cumX;

              const handleMouseMove = (e, chartRef) => {
                if (!chartRef) return;
                const rect = chartRef.getBoundingClientRect();
                const scrollLeft = chartRef.scrollLeft;
                const scrollTop = chartRef.scrollTop;
                const x = e.clientX - rect.left;
                const xWithScroll = x + scrollLeft;
                const y = e.clientY - rect.top;
                const yInContent = y - 36 + scrollTop;
                let sessIdx = filteredSessionColumns.length - 1;
                for (let i = 0; i < filteredSessionColumns.length; i++) {
                  if (xWithScroll < sessPositions[i] + filteredSessionColumns[i].width) {
                    sessIdx = i;
                    break;
                  }
                }
                const rowIdx = Math.floor(yInContent / rowHeight);
                const price = priceRows[rowIdx] || 0;
                setChartCrosshair({
                  show: true, x, y,
                  clientX: e.clientX, clientY: e.clientY,
                  chartLeft: rect.left, chartTop: rect.top,
                  chartRight: rect.right, chartBottom: rect.bottom,
                  scrollLeft, scrollTop, price,
                  dayIdx: sessIdx, day: filteredSessionColumns[sessIdx]
                });
              };

              return (
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  height: 'calc(100vh - 340px)',
                  minHeight: 300,
                  maxHeight: 'calc(100vh - 340px)',
                  background: 'linear-gradient(180deg, rgba(12,12,20,0.98) 0%, rgba(8,8,14,0.98) 100%)',
                  borderRadius: 12,
                  border: '1px solid rgba(147,112,219,0.2)',
                  boxShadow: '0 8px 32px rgba(0,0,0,0.5)',
                  overflow: 'hidden',
                  position: 'relative'
                }}>
                  {/* Tooltip - Click to show/hide */}
                  {chartCrosshair.show && chartCrosshair.day && chartTooltipPinned && (
                    <div style={{
                      position: 'absolute',
                      left: chartCrosshair.x + 65,
                      top: Math.max(10, chartCrosshair.y - 140),
                      background: 'rgba(20,20,35,0.95)',
                      border: `1px solid ${chartCrosshair.day.color || 'rgba(147,112,219,0.5)'}`,
                      borderRadius: 8,
                      padding: '10px 14px',
                      zIndex: 100,
                      boxShadow: '0 4px 24px rgba(0,0,0,0.6)',
                      backdropFilter: 'blur(12px)',
                      pointerEvents: 'none',
                      minWidth: 180
                    }}>
                      <div style={{ fontSize: 12, color: chartCrosshair.day.color || '#ba68c8', fontWeight: 700, marginBottom: 4 }}>
                        {chartCrosshair.day.sessName} - {chartCrosshair.day.weekday} {chartCrosshair.day.date?.slice(5)}
                      </div>
                      <div style={{ fontSize: 9, color: '#666', marginBottom: 6 }}>{chartCrosshair.day.sessTime || '--'}</div>
                      <div style={{ fontSize: 10, color: '#888', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3px 16px' }}>
                        <span>Price:</span><span style={{ color: '#fff', fontWeight: 600 }}>{chartCrosshair.price?.toFixed(1) || '--'}</span>
                        <span>POC:</span><span style={{ color: '#ffaa00', fontWeight: 600 }}>{typeof chartCrosshair.day.poc === 'number' ? chartCrosshair.day.poc.toFixed(1) : '--'}</span>
                        <span>VAH:</span><span style={{ color: '#00ff88', fontWeight: 600 }}>{typeof chartCrosshair.day.vah === 'number' ? chartCrosshair.day.vah.toFixed(1) : '--'}</span>
                        <span>VAL:</span><span style={{ color: '#ff4466', fontWeight: 600 }}>{typeof chartCrosshair.day.val === 'number' ? chartCrosshair.day.val.toFixed(1) : '--'}</span>
                        <span>IB H:</span><span style={{ color: '#fff', fontWeight: 600 }}>{typeof chartCrosshair.day.ibHigh === 'number' ? chartCrosshair.day.ibHigh.toFixed(1) : '--'}</span>
                        <span>IB L:</span><span style={{ color: '#fff', fontWeight: 600 }}>{typeof chartCrosshair.day.ibLow === 'number' ? chartCrosshair.day.ibLow.toFixed(1) : '--'}</span>
                        <span>IB%:</span><span style={{ color: '#00aaff', fontWeight: 600 }}>{(typeof chartCrosshair.day.ibHigh === 'number' && typeof chartCrosshair.day.ibLow === 'number' && chartCrosshair.day.high > chartCrosshair.day.low) ? (((chartCrosshair.day.ibHigh - chartCrosshair.day.ibLow) / (chartCrosshair.day.high - chartCrosshair.day.low)) * 100).toFixed(0) + '%' : '--'}</span>
                      </div>
                      <div style={{ height: 1, background: 'rgba(255,255,255,0.1)', margin: '6px 0' }} />
                      <div style={{ fontSize: 10, color: '#888', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3px 12px' }}>
                        <span>VP VAH:</span><span style={{ color: '#00ff88', fontWeight: 600 }}>{typeof chartCrosshair.day.volVAH === 'number' ? chartCrosshair.day.volVAH.toFixed(1) : '--'}</span>
                        <span>VP VAL:</span><span style={{ color: '#ff4466', fontWeight: 600 }}>{typeof chartCrosshair.day.volVAL === 'number' ? chartCrosshair.day.volVAL.toFixed(1) : '--'}</span>
                        <span>Day Type:</span><span style={{ color: dayTypeColors[chartCrosshair.day?.day_type] || '#888', fontWeight: 600 }}>{chartCrosshair.day?.day_type?.replace('_', ' ') || '--'}</span>
                        <span>Open Type:</span><span style={{ color: '#00aaff', fontWeight: 600 }}>{chartCrosshair.day?.open_type?.replace('_', ' ') || '--'}</span>
                        <span>Shape:</span><span style={{ color: '#ba68c8', fontWeight: 600 }}>{chartCrosshair.day?.profile_shape?.replace('_', ' ') || '--'}</span>
                        <span>AB Overlap:</span><span style={{ color: chartCrosshair.day?.abOverlap >= 50 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{typeof chartCrosshair.day?.abOverlap === 'number' ? chartCrosshair.day.abOverlap + '%' : '--'}</span>
                      </div>
                    </div>
                  )}

                  {/* Chart Row: Price Scale + Main Chart */}
                  <div style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
                  {/* Price Scale */}
                  <div style={{ width: 58, flexShrink: 0, background: 'linear-gradient(90deg, rgba(18,18,30,0.98) 0%, rgba(12,12,22,0.95) 100%)', borderRight: '1px solid rgba(147,112,219,0.25)' }}>
                    <div style={{ height: 36, background: 'linear-gradient(180deg, rgba(147,112,219,0.12) 0%, rgba(147,112,219,0.05) 100%)', borderBottom: '1px solid rgba(147,112,219,0.25)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      <span style={{ fontSize: 8, color: 'rgba(147,112,219,0.6)', fontWeight: 600, letterSpacing: '0.5px' }}>PRICE</span>
                    </div>
                    <div style={{ overflow: 'hidden', height: 'calc(100% - 36px)' }} id="price-scale-1w">
                      {priceRows.map((price, idx) => {
                        const showLabel = price % 10 === 0;
                        const isMajor = price % 50 === 0;
                        return (
                          <div key={price} style={{
                            height: rowHeight,
                            fontSize: isMajor ? 10 : 9,
                            textAlign: 'center',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: isMajor ? 'rgba(147,112,219,0.9)' : showLabel ? '#666' : 'transparent',
                            fontWeight: isMajor ? 600 : 400,
                            borderBottom: isMajor ? '1px solid rgba(147,112,219,0.1)' : 'none'
                          }}>
                            {showLabel ? price.toFixed(0) : ''}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Main Chart */}
                  <div
                    className="tpo-scroll-container"
                    style={{ flex: 1, overflow: 'auto', position: 'relative', cursor: 'crosshair' }}
                    onScroll={(e) => {
                      const ps = document.getElementById('price-scale-1w');
                      const ts = document.getElementById('time-scale-1w');
                      if (ps) ps.scrollTop = e.target.scrollTop;
                      if (ts) ts.scrollLeft = e.target.scrollLeft;
                    }}
                    onMouseMove={(e) => handleMouseMove(e, e.currentTarget)}
                    onClick={() => setChartTooltipPinned(!chartTooltipPinned)}
                    onMouseLeave={() => { if (!chartTooltipPinned) setChartCrosshair({ ...chartCrosshair, show: false }); }}
                    ref={(el) => { chart1wRef.current = el; if (el && !chart1wInitialized.current && totalWidth > el.clientWidth) { el.scrollLeft = totalWidth - el.clientWidth; chart1wInitialized.current = true; } }}
                  >
                    {/* Crosshair Lines */}
                    {chartCrosshair.show && chartCrosshair.clientX && (
                      <>
                        <div style={{ position: 'fixed', left: chartCrosshair.chartLeft - 58, right: window.innerWidth - chartCrosshair.chartRight, height: 1, top: chartCrosshair.clientY, background: 'repeating-linear-gradient(90deg, rgba(186,104,200,0.6) 0px, rgba(186,104,200,0.6) 3px, transparent 3px, transparent 6px)', pointerEvents: 'none', zIndex: 50 }} />
                        <div style={{ position: 'fixed', left: chartCrosshair.clientX, top: chartCrosshair.chartTop, height: chartCrosshair.chartBottom - chartCrosshair.chartTop, width: 1, background: 'repeating-linear-gradient(180deg, rgba(186,104,200,0.6) 0px, rgba(186,104,200,0.6) 3px, transparent 3px, transparent 6px)', pointerEvents: 'none', zIndex: 50 }} />
                      </>
                    )}

                    {/* Session Headers */}
                    <div style={{ display: 'flex', position: 'sticky', top: 0, zIndex: 10, background: 'rgba(18,18,30,0.98)', borderBottom: '1px solid rgba(147,112,219,0.3)' }}>
                      {filteredSessionColumns.map((s, i) => (
                        <div key={`${s.date}-${s.sessKey}`} style={{
                          width: s.width, flexShrink: 0, textAlign: 'center', padding: '6px 2px',
                          borderRight: '1px solid rgba(147,112,219,0.06)', // Reduced opacity
                          borderLeft: s.sessKey === 'asia' || (isRTHView && s.sessKey === 'us_rth') ? '2px solid rgba(255,255,255,0.1)' : 'none', // Reduced opacity
                          background: chartCrosshair.dayIdx === i ? `${s.color}15` : 'transparent'
                        }}>
                          <div style={{ fontSize: 10, color: s.color, fontWeight: 700 }}>{s.sessName}</div>
                          <div style={{ fontSize: 8, color: '#666' }}>{s.weekday} {s.date?.slice(5)}</div>
                        </div>
                      ))}
                    </div>

                    {/* TPO Grid with Column Lines */}
                    <div style={{ position: 'relative', minHeight: 'calc(100% - 36px)' }}>
                      {/* Column Lines - span full grid height - reduced opacity */}
                      {filteredSessionColumns.map((s, i) => (
                        <div key={`col-line-${i}`} style={{
                          position: 'absolute',
                          left: sessPositions[i] + s.width - 1,
                          top: 0,
                          bottom: 0,
                          minHeight: priceRows.length * rowHeight,
                          width: 1,
                          background: 'rgba(147,112,219,0.06)',
                          pointerEvents: 'none',
                          zIndex: 1
                        }} />
                      ))}
                      {/* Day dividers - thicker lines at session boundaries - reduced opacity */}
                      {filteredSessionColumns.map((s, i) => (
                        (s.sessKey === 'asia' || (isRTHView && s.sessKey === 'us_rth')) ? (
                          <div key={`day-line-${i}`} style={{
                            position: 'absolute',
                            left: sessPositions[i],
                            top: 0,
                            bottom: 0,
                            minHeight: priceRows.length * rowHeight,
                            width: 2,
                            background: 'rgba(255,255,255,0.1)',
                            pointerEvents: 'none',
                            zIndex: 1
                          }} />
                        ) : null
                      ))}
                      {/* Price Rows */}
                      {priceRows.map(price => (
                        <div key={price} style={{ display: 'flex', height: rowHeight, background: chartCrosshair.price === price ? 'rgba(186,104,200,0.04)' : 'transparent' }}>
                          {filteredSessionColumns.map((s, sessIdx) => {
                            const letters = s.lettersByPrice[price] ? [...s.lettersByPrice[price]].sort() : [];
                            const isInVA = s.vah && s.val && price <= s.vah && price >= s.val;
                            const isIBHigh = s.hasIB && s.ibHigh && Math.abs(price - s.ibHigh) < tickSize;
                            const isIBLow = s.hasIB && s.ibLow && Math.abs(price - s.ibLow) < tickSize;

                            // Open: EXACT row match only (single block)
                            const isOpenRow = s.openPriceKey && price.toString() === s.openPriceKey;
                            // Close: EXACT row match only (single block)
                            const lastLetterName = s.maxPeriod >= 0 ? (s.maxPeriod < 26 ? String.fromCharCode(65 + s.maxPeriod) : 'A' + String.fromCharCode(65 + s.maxPeriod - 26)) : null;
                            const isCloseRow = s.closePriceKey && price.toString() === s.closePriceKey;

                            // Determine if close is up (green) or down (red)
                            const isUpClose = s.close && s.open && s.close >= s.open;
                            const closeColor = isUpClose ? '#00ff88' : '#ff4466'; // fluorescent green or red
                            // POC row detection - EXACT match only (one row)
                            const isPOCRow = s.pocPriceKey && price.toString() === s.pocPriceKey;

                            return (
                              <div key={`${s.date}-${s.sessKey}-${price}`} style={{
                                width: s.width, flexShrink: 0, height: rowHeight, display: 'flex', alignItems: 'center',
                                borderRight: 'none', // Removed TPO/VP divider
                                borderLeft: s.sessKey === 'asia' || (isRTHView && s.sessKey === 'us_rth') ? '2px solid rgba(255,255,255,0.1)' : 'none',
                                position: 'relative', paddingLeft: 21, paddingRight: vpBarWidth + vpGap + 19, // 7px more left for IB, 5px more right for VP
                                background: isIBHigh || isIBLow ? 'rgba(255,255,255,0.05)' : 'transparent'
                              }}>
                                {/* TPO Blocks */}
                                {tpoDisplayMode === 'expanded' ? (
                                  <div style={{ position: 'relative', width: Math.max((s.maxPeriod - s.sessStart + 1) * letterWidth, 50), height: rowHeight - 2, overflow: 'visible' }}>
                                    {letters.map((letter, i) => {
                                      const periodIdx = letterToIdx(letter) - s.sessStart;
                                      if (periodIdx < 0) return null;
                                      // Open: only 'A' block on the exact open row
                                      const isOpenBlock = letter === 'A' && isOpenRow;
                                      // Close: only last letter block on the exact close row
                                      const isCloseBlock = letter === lastLetterName && isCloseRow && !isOpenBlock;
                                      // Color logic: POC=white, Open=grey, Close=green/red based on candle direction
                                      const blockColor = isPOCRow ? '#000' : isOpenBlock ? '#fff' : isCloseBlock ? '#000' : isInVA ? closeColor : '#888';
                                      const blockBg = isPOCRow ? '#ffffff' : isOpenBlock ? 'rgba(100,100,100,0.6)' : isCloseBlock ? closeColor : isInVA ? `${closeColor}30` : 'rgba(136,136,136,0.25)';
                                      const blockBorder = isPOCRow ? '1px solid #fff' : isOpenBlock ? '1px solid #fff' : isCloseBlock ? `1px solid ${closeColor}` : isInVA ? `1px solid ${closeColor}50` : '1px solid rgba(136,136,136,0.4)';
                                      return (
                                        <span key={`${letter}-${i}`} style={{
                                          position: 'absolute',
                                          left: periodIdx * letterWidth,
                                          width: letter.length > 1 ? letterWidth + 4 : letterWidth - 1,
                                          height: rowHeight - 2,
                                          display: 'inline-flex', alignItems: 'center', justifyContent: 'center',
                                          fontSize: letter.length > 1 ? 7 : 9, fontWeight: 700,
                                          color: blockColor,
                                          background: blockBg,
                                          borderRadius: 2,
                                          border: blockBorder
                                        }}>{letter}</span>
                                      );
                                    })}
                                  </div>
                                ) : (
                                  letters.map((letter, i) => {
                                    // Open: only 'A' block on the exact open row
                                    const isOpenBlock = letter === 'A' && isOpenRow;
                                    // Close: only last letter block on the exact close row
                                    const isCloseBlock = letter === lastLetterName && isCloseRow && !isOpenBlock;
                                    // Color logic: POC=white, Open=grey, Close=green/red based on candle direction
                                    const blockColor = isPOCRow ? '#000' : isOpenBlock ? '#fff' : isCloseBlock ? '#000' : isInVA ? closeColor : '#888';
                                    const blockBg = isPOCRow ? '#ffffff' : isOpenBlock ? 'rgba(100,100,100,0.6)' : isCloseBlock ? closeColor : isInVA ? `${closeColor}30` : 'rgba(136,136,136,0.25)';
                                    const blockBorder = isPOCRow ? '1px solid #fff' : isOpenBlock ? '1px solid #fff' : isCloseBlock ? `1px solid ${closeColor}` : isInVA ? `1px solid ${closeColor}50` : '1px solid rgba(136,136,136,0.4)';
                                    return (
                                      <span key={`${letter}-${i}`} style={{
                                        minWidth: letter.length > 1 ? letterWidth + 4 : letterWidth,
                                        height: rowHeight - 2,
                                        display: 'inline-flex', alignItems: 'center', justifyContent: 'center',
                                        fontSize: letter.length > 1 ? 8 : 10, fontWeight: 700,
                                        color: blockColor,
                                        background: blockBg,
                                        borderRadius: 2, marginRight: 1,
                                        border: blockBorder,
                                        padding: letter.length > 1 ? '0 2px' : 0
                                      }}>{letter}</span>
                                    );
                                  })
                                )}
{/* Dense VP overlay rendered below */}
                              </div>
                            );
                          })}
                        </div>
                      ))}

                      {/* Dense Volume Profile Overlay for Sessions - iterate actual data */}
                      {filteredSessionColumns.map((s, sessIdx) => {
                        const xPos = sessPositions[sessIdx];
                        const totalHeight = priceRows.length * rowHeight;
                        const sessMid = (s.high + s.low) / 2;

                        // Calculate Y position for any price - aligned to TPO row grid
                        const priceToY = (price) => {
                          const rowPrice = Math.floor(price / tickSize) * tickSize;
                          const rowIndex = (globalHigh - rowPrice) / tickSize;
                          const offsetInRow = 1 - (price - rowPrice) / tickSize;
                          return (rowIndex + offsetInRow) * rowHeight;
                        };

                        // Use actual data keys - no lookup issues
                        const vpLevels = Object.entries(s.volumeByPrice || {}).map(([priceKey, vol]) => {
                          const price = parseFloat(priceKey);
                          const delta = s.deltaByPrice?.[priceKey] ?? s.deltaByPrice?.[price];
                          return { price, vol, delta };
                        }).filter(l => l.vol > 0).sort((a, b) => b.price - a.price);

                        const vpMaxVol = Math.max(...vpLevels.map(l => l.vol), 1);

                        return (
                          <div key={`vp-sess-${sessIdx}`} style={{
                            position: 'absolute',
                            left: xPos + s.width - vpBarWidth - 15, // 5px more from right edge
                            top: 0,
                            width: vpBarWidth,
                            height: totalHeight,
                            // Removed borderLeft - no divider between TPO and Volume Profile
                            overflow: 'hidden'
                          }}>
                            {vpLevels.map((level, i) => {
                              const yPos = priceToY(level.price);
                              const barHeight = 1;
                              // Use sessionVPOC (Volume POC) for yellow highlight - actual calculation, not TPO POC
                              const isVPOC = s.sessionVPOC && Math.abs(level.price - s.sessionVPOC) < 1;
                              const isVAH = s.volVAH && Math.abs(level.price - s.volVAH) < 1;
                              const isVAL = s.volVAL && Math.abs(level.price - s.volVAL) < 1;
                              const hasRealDelta = level.delta !== undefined && level.delta !== null && level.delta !== 0;
                              const isBuyDelta = hasRealDelta ? level.delta > 0 : (level.price > sessMid);

                              return (
                                <div key={i} style={{
                                  position: 'absolute',
                                  top: yPos,
                                  left: 4,
                                  width: `${Math.min((level.vol / vpMaxVol) * 95, 95)}%`,
                                  height: barHeight,
                                  background: isVPOC ? '#ff9900' : isVAH ? '#00ff88' : isVAL ? '#ff4466' : isBuyDelta ? '#00dd77' : '#cc3366',
                                  opacity: 0.9
                                }} />
                              );
                            })}
                          </div>
                        );
                      })}

                      {/* Markers - IB bars and VAH/VAL arrows */}
                      {filteredSessionColumns.map((s, sessIdx) => {
                        const calcY = (price) => {
                          const rowPrice = Math.floor(price / tickSize) * tickSize;
                          const rowIndex = (globalHigh - rowPrice) / tickSize;
                          const offsetInRow = 1 - (price - rowPrice) / tickSize;
                          return (rowIndex + offsetInRow) * rowHeight;
                        };
                        const xPos = sessPositions[sessIdx];

                        return (
                          <React.Fragment key={`markers-${s.date}-${s.sessKey}`}>
                            {/* IB vertical bar - thin white line from IB high to IB low */}
                            {s.hasIB && s.ibHigh && s.ibLow && (
                              <div style={{
                                position: 'absolute',
                                left: xPos + 7, // 7px from left edge for column divider spacing
                                top: calcY(s.ibHigh) + (rowHeight / 2),
                                width: 2,
                                height: calcY(s.ibLow) - calcY(s.ibHigh),
                                background: '#ffffff',
                                opacity: 0.8,
                                zIndex: 10,
                                pointerEvents: 'none'
                              }} />
                            )}
                            {/* VAH arrow - white down arrow to the right of VP */}
                            {s.vah && (
                              <div style={{
                                position: 'absolute',
                                left: xPos + s.width - 12,
                                top: calcY(s.vah) + (rowHeight / 2) - 6,
                                fontSize: 9,
                                color: '#ffffff',
                                fontWeight: 700,
                                zIndex: 15,
                                pointerEvents: 'none'
                              }}>‚ñº</div>
                            )}
                            {/* VAL arrow - white up arrow to the right of VP */}
                            {s.val && (
                              <div style={{
                                position: 'absolute',
                                left: xPos + s.width - 12,
                                top: calcY(s.val) + (rowHeight / 2) - 6,
                                fontSize: 9,
                                color: '#ffffff',
                                fontWeight: 700,
                                zIndex: 15,
                                pointerEvents: 'none'
                              }}>‚ñ≤</div>
                            )}
                          </React.Fragment>
                        );
                      })}
                    </div>
                  </div>
                  </div>
                  {/* Time Scale Footer - fixed at bottom */}
                  <div style={{ display: 'flex', flexShrink: 0, background: 'rgba(18,18,30,0.98)', borderTop: '1px solid rgba(147,112,219,0.2)' }}>
                    <div style={{ width: 58, flexShrink: 0, borderRight: '1px solid rgba(147,112,219,0.25)' }} />
                    <div id="time-scale-1w" style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
                      {filteredSessionColumns.map((s, i) => (
                        <div key={`time-${s.date}-${s.sessKey}`} style={{
                          width: s.width, flexShrink: 0, textAlign: 'center', padding: '2px 0',
                          borderRight: '1px solid rgba(147,112,219,0.06)',
                          borderLeft: s.sessKey === 'asia' || (isRTHView && s.sessKey === 'us_rth') ? '2px solid rgba(255,255,255,0.1)' : 'none',
                          background: chartCrosshair.dayIdx === i ? `${s.color}15` : 'transparent'
                        }}>
                          <div style={{ fontSize: 9, color: '#666' }}>{s.sessTime}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              );
              } catch (e) {
                console.error('1-Week chart error:', e);
                return <div style={{ padding: 40, textAlign: 'center', color: '#ff4466' }}>Error rendering 1-Week chart: {e.message}</div>;
              }
            })()
          ) : (selectedSession === '4week' || selectedSession === '4week_rth') && historicData?.profiles?.length > 0 ? (
            (() => {
              const isRTHView = selectedSession === '4week_rth';

              // RTH period filter: 09:30-16:15 ET
              // From 18:00 start: 09:30 = period 31, 16:15 = period 45
              const RTH_START_PERIOD = 31;
              const RTH_END_PERIOD = 45;

              // Convert letter to period index
              const letterToIdx = (letter) => {
                if (letter.length === 1) return letter.charCodeAt(0) - 65;
                return 26 + (letter.charCodeAt(0) - 65) * 26 + (letter.charCodeAt(1) - 65);
              };

              // Filter letters to RTH only
              const filterRTHLetters = (letters) => {
                if (!isRTHView) return letters;
                return letters.filter(l => {
                  const idx = letterToIdx(l);
                  return idx >= RTH_START_PERIOD && idx <= RTH_END_PERIOD;
                });
              };

              // Reverse to show oldest on left, newest on right
              // Merge current day's live data if today is in historic
              const today = new Date().toISOString().split('T')[0];
              const rawDays = historicData.profiles.slice(0, 20).filter(d => d.tpo_profiles);

              // Update today's entry with live data and filter for RTH if needed
              const days = rawDays.map(d => {
                let dayData = d;
                if (d.date === today && data) {
                  dayData = {
                    ...d,
                    poc: data.poc || d.poc,
                    vah: data.vah || d.vah,
                    val: data.val || d.val,
                    ib_high: data.ib_high || d.ib_high,
                    ib_low: data.ib_low || d.ib_low,
                    high: Math.max(data.high || 0, d.high || 0),
                    low: Math.min(data.low || 999999, d.low || 999999),
                    tpo_profiles: data.profiles || d.tpo_profiles,
                    // Use live day classification for today
                    day_type: data.day_type || d.day_type,
                    open_type: data.open_type || d.open_type,
                    profile_shape: data.profile_shape || d.profile_shape
                  };
                }

                // For RTH view, filter tpo_profiles to only RTH letters
                if (isRTHView && dayData.tpo_profiles) {
                  const filteredProfiles = {};
                  Object.entries(dayData.tpo_profiles).forEach(([price, letters]) => {
                    const rthLetters = filterRTHLetters(letters);
                    if (rthLetters.length > 0) {
                      filteredProfiles[price] = rthLetters;
                    }
                  });
                  dayData = { ...dayData, tpo_profiles: filteredProfiles };

                  // Use NY IB for RTH: 09:30-10:30 (periods 31-33)
                  // Recalculate high/low from filtered data
                  const prices = Object.keys(filteredProfiles).map(p => parseFloat(p));
                  if (prices.length > 0) {
                    dayData.high = Math.max(...prices);
                    dayData.low = Math.min(...prices);
                  }
                }

                return dayData;
              }).reverse();

              // Fixed tick sizes based on contract type and zoom state
              // BTC: default $100, zoomed $50 | GC: default $4, zoomed $2
              const allHighs = days.map(d => d.high || 0).filter(h => h > 0);
              const allLows = days.map(d => d.low || 999999).filter(l => l < 999999);
              const maxPrice = Math.max(...allHighs);
              const isBTC = maxPrice > 10000;
              const tpoTickSize = isBTC
                ? (tpoZoomed ? 50 : 100)   // BTC: $100 default, $50 zoomed
                : (tpoZoomed ? 2 : 4);     // GC: $4 default, $2 zoomed

              // Volume profile: tick size changes with zoom for more detail
              // BTC: $1 default ‚Üí $0.10 zoomed | GC: $0.30 default ‚Üí $0.05 zoomed
              const vpTickSize = isBTC
                ? (tpoZoomed ? 0.1 : 1)    // BTC: $1 normal, $0.10 zoomed
                : (tpoZoomed ? 0.05 : 0.3); // GC: $0.30 normal, $0.05 zoomed
              const vpSubRows = Math.max(2, Math.round(tpoTickSize / vpTickSize)); // Sub-rows per price level
              const rowHeight = tpoZoomed ? 14 : 11; // Smaller rows when unzoomed to fit more on screen
              const letterWidth = tpoZoomed ? 12 : 10; // Narrower blocks when unzoomed
              const vpBarWidth = 50; // Volume profile width per day
              const vpGap = 16; // Gap between TPO and volume profile

              // Convert 30-min letters to 1-hour blocks (merge pairs)
              const convertTo1Hour = (letters) => {
                const hourBlocks = new Set();
                letters.forEach(l => {
                  // A,B -> A (first hour), C,D -> B (second hour), etc.
                  let idx;
                  if (l.length === 1) {
                    idx = l.charCodeAt(0) - 65;
                  } else {
                    idx = 26 + (l.charCodeAt(0) - 65) * 26 + (l.charCodeAt(1) - 65);
                  }
                  const hourIdx = Math.floor(idx / 2); // Merge pairs
                  if (hourIdx < 26) {
                    hourBlocks.add(String.fromCharCode(65 + hourIdx));
                  } else {
                    hourBlocks.add(String.fromCharCode(65 + Math.floor((hourIdx - 26) / 26)) + String.fromCharCode(65 + (hourIdx - 26) % 26));
                  }
                });
                return [...hourBlocks].sort();
              };

              // Calculate open_type from IB data for historic profiles
              const calculateOpenType = (d) => {
                if (d.open_type && d.open_type !== 'developing') return d.open_type;

                const ibHigh = d.ib_high;
                const ibLow = d.ib_low;
                const openPrice = d.open;
                const closePrice = d.close || d.high; // Use close or high as proxy

                if (!ibHigh || !ibLow || ibLow >= 999999 || !openPrice) return 'OA';

                const ibRange = ibHigh - ibLow;
                if (ibRange <= 0) return 'OA';

                const ibMid = (ibHigh + ibLow) / 2;
                const openPctInIB = ((openPrice - ibLow) / ibRange) * 100;

                // OD: Open near IB extreme, strong one-way move
                if (openPctInIB <= 20 && closePrice > ibMid) return 'OD';
                if (openPctInIB >= 80 && closePrice < ibMid) return 'OD';

                // OTD: Tested one direction then drove opposite
                if (openPrice > ibMid && d.low < ibLow && closePrice > ibHigh) return 'OTD';
                if (openPrice < ibMid && d.high > ibHigh && closePrice < ibLow) return 'OTD';

                // ORR: Rejected at extreme and reversed
                if (d.high > ibHigh && closePrice < ibMid) return 'ORR';
                if (d.low < ibLow && closePrice > ibMid) return 'ORR';

                // OA: Balanced within IB
                return 'OA';
              };

              // Calculate data for each day with 1-hour blocks
              const dayData = days.map(d => {
                const dayProfiles = d.tpo_profiles || {};
                let maxLetters = 0;
                let maxPeriod = 0;
                const lettersByPrice = {}; // TPO at larger tick
                const volumeByPrice = {}; // Volume at finer tick
                const volumeByPriceCoarse = {}; // Volume at TPO tick for row coloring
                const deltaByPrice = {}; // Delta at each price for coloring

                // Always use actual volume data when available for smooth VP bars
                const hasActualVolume = d.price_volumes && Object.keys(d.price_volumes).length > 0;
                const backendDelta = d.delta_by_price || {};

                Object.entries(dayProfiles).forEach(([priceKey, letters]) => {
                  const rawPrice = parseFloat(priceKey);
                  // TPO uses coarse tick
                  const tpoPrice = Math.floor(rawPrice / tpoTickSize) * tpoTickSize;
                  if (!lettersByPrice[tpoPrice]) lettersByPrice[tpoPrice] = new Set();
                  const hourLetters = convertTo1Hour(letters);
                  hourLetters.forEach(l => {
                    lettersByPrice[tpoPrice].add(l);
                    const idx = letterToIdx(l);
                    if (idx > maxPeriod) maxPeriod = idx;
                  });

                  // Fallback: use TPO letter count as volume proxy when no actual volume data
                  if (!hasActualVolume) {
                    const vpPrice = Math.floor(rawPrice / vpTickSize) * vpTickSize;
                    volumeByPrice[vpPrice] = (volumeByPrice[vpPrice] || 0) + letters.length;
                    volumeByPriceCoarse[tpoPrice] = (volumeByPriceCoarse[tpoPrice] || 0) + letters.length;
                  }
                });

                // Use actual price_volumes when available for smooth granular VP bars
                if (hasActualVolume) {
                  Object.entries(d.price_volumes).forEach(([priceKey, vol]) => {
                    const rawPrice = parseFloat(priceKey);
                    const vpPrice = Math.floor(rawPrice / vpTickSize) * vpTickSize;
                    const tpoPrice = Math.floor(rawPrice / tpoTickSize) * tpoTickSize;
                    volumeByPrice[vpPrice] = (volumeByPrice[vpPrice] || 0) + vol;
                    volumeByPriceCoarse[tpoPrice] = (volumeByPriceCoarse[tpoPrice] || 0) + vol;
                    // Get delta from backend
                    const actualDelta = backendDelta[priceKey] || backendDelta[rawPrice.toFixed(1)] || 0;
                    deltaByPrice[vpPrice] = (deltaByPrice[vpPrice] || 0) + actualDelta;
                  });
                }

                // Calculate TPO-based POC (price level with most blocks)
                let tpoPOC = 0, maxTPOCount = 0, pocPriceKey = null;
                Object.entries(lettersByPrice).forEach(([priceKey, letters]) => {
                  if (letters.size > maxTPOCount) {
                    maxTPOCount = letters.size;
                    tpoPOC = parseFloat(priceKey);
                    pocPriceKey = priceKey;
                  }
                  if (letters.size > maxLetters) maxLetters = letters.size;
                });

                // Calculate day's volume POC (at fine tick)
                let dayVPOC = d.poc || tpoPOC, maxVol = 0;
                Object.entries(volumeByPrice).forEach(([p, v]) => {
                  if (v > maxVol) { maxVol = v; dayVPOC = parseFloat(p); }
                });

                // Calculate Volume-based Value Area (70% of volume starting from VPOC)
                let volVAH = dayVPOC, volVAL = dayVPOC;
                const sortedPrices = Object.entries(volumeByPrice)
                  .map(([p, v]) => ({ price: parseFloat(p), vol: v }))
                  .sort((a, b) => a.price - b.price);
                const totalVol = sortedPrices.reduce((sum, p) => sum + p.vol, 0);
                const targetVol = totalVol * 0.7;

                if (sortedPrices.length > 0) {
                  const vpocIdx = sortedPrices.findIndex(p => Math.abs(p.price - dayVPOC) < vpTickSize);
                  let vaVol = sortedPrices[vpocIdx]?.vol || 0;
                  let hiIdx = vpocIdx, loIdx = vpocIdx;

                  while (vaVol < targetVol && (hiIdx < sortedPrices.length - 1 || loIdx > 0)) {
                    const hiVol = hiIdx < sortedPrices.length - 1 ? sortedPrices[hiIdx + 1].vol : 0;
                    const loVol = loIdx > 0 ? sortedPrices[loIdx - 1].vol : 0;
                    if (hiVol >= loVol && hiIdx < sortedPrices.length - 1) {
                      hiIdx++;
                      vaVol += sortedPrices[hiIdx].vol;
                    } else if (loIdx > 0) {
                      loIdx--;
                      vaVol += sortedPrices[loIdx].vol;
                    } else break;
                  }
                  volVAH = sortedPrices[hiIdx]?.price || dayVPOC;
                  volVAL = sortedPrices[loIdx]?.price || dayVPOC;
                }

                // Calculate width based on display mode
                const compactWidth = Math.max(maxLetters * letterWidth + vpGap + vpBarWidth + 45, 130);
                const expandedWidth = Math.max((maxPeriod + 1) * letterWidth + vpGap + vpBarWidth + 45, 180);

                // Calculate Open/Close price keys (single block only)
                let openPriceKey = null, closePriceKey = null;
                const pricesWithA = [];
                const lastLetterIdx = maxPeriod;
                const lastLetterName = lastLetterIdx < 26 ? String.fromCharCode(65 + lastLetterIdx) : 'A' + String.fromCharCode(65 + lastLetterIdx - 26);
                const pricesWithLast = [];

                Object.entries(lettersByPrice).forEach(([priceKey, letters]) => {
                  const price = parseFloat(priceKey);
                  if (letters.has('A')) pricesWithA.push({ price, key: priceKey });
                  if (letters.has(lastLetterName)) pricesWithLast.push({ price, key: priceKey });
                });

                if (pricesWithA.length > 0) {
                  const midOpen = (Math.max(...pricesWithA.map(p => p.price)) + Math.min(...pricesWithA.map(p => p.price))) / 2;
                  let closestOpen = pricesWithA[0];
                  pricesWithA.forEach(p => {
                    if (Math.abs(p.price - midOpen) < Math.abs(closestOpen.price - midOpen)) closestOpen = p;
                  });
                  openPriceKey = closestOpen.key;
                }
                if (pricesWithLast.length > 0) {
                  const midClose = (Math.max(...pricesWithLast.map(p => p.price)) + Math.min(...pricesWithLast.map(p => p.price))) / 2;
                  let closestClose = pricesWithLast[0];
                  pricesWithLast.forEach(p => {
                    if (Math.abs(p.price - midClose) < Math.abs(closestClose.price - midClose)) closestClose = p;
                  });
                  closePriceKey = closestClose.key;
                }

                // Calculate AB Overlap % (overlap between A and B period ranges)
                let abOverlap = null;
                const pricesWithALetter = [];
                const pricesWithBLetter = [];
                Object.entries(lettersByPrice).forEach(([priceKey, letters]) => {
                  const price = parseFloat(priceKey);
                  if (letters.has('A')) pricesWithALetter.push(price);
                  if (letters.has('B')) pricesWithBLetter.push(price);
                });
                if (pricesWithALetter.length > 0 && pricesWithBLetter.length > 0) {
                  const aHigh = Math.max(...pricesWithALetter);
                  const aLow = Math.min(...pricesWithALetter);
                  const bHigh = Math.max(...pricesWithBLetter);
                  const bLow = Math.min(...pricesWithBLetter);
                  const aRange = aHigh - aLow;
                  const bRange = bHigh - bLow;
                  const overlapHigh = Math.min(aHigh, bHigh);
                  const overlapLow = Math.max(aLow, bLow);
                  const overlap = Math.max(0, overlapHigh - overlapLow);
                  const smallerRange = Math.min(aRange, bRange);
                  if (smallerRange > 0) {
                    abOverlap = Math.round((overlap / smallerRange) * 100);
                  } else if (overlap > 0) {
                    abOverlap = 100;
                  } else {
                    abOverlap = 0;
                  }
                }

                return {
                  ...d,
                  lettersByPrice,
                  volumeByPrice, // Fine tick volume
                  volumeByPriceCoarse, // Coarse tick volume
                  deltaByPrice, // Delta at each price for coloring
                  maxVol,
                  dayVPOC,
                  tpoPOC, // TPO-based POC (highest block count)
                  pocPriceKey, // Exact price key for POC row comparison
                  openPriceKey, // Exact price key for Open block
                  closePriceKey, // Exact price key for Close block
                  abOverlap, // AB Overlap percentage
                  volVAH, // Volume-based VAH
                  volVAL, // Volume-based VAL
                  maxLetters: Math.max(maxLetters, 1),
                  maxPeriod,
                  width: tpoDisplayMode === 'expanded' ? expandedWidth : compactWidth,
                  open_type: calculateOpenType(d) // Calculate from IB if not provided
                };
              });

              // Global price range (using TPO tick)
              let globalHigh = 0, globalLow = 999999;
              days.forEach(d => {
                if (d.high > globalHigh) globalHigh = d.high;
                if (d.low < globalLow) globalLow = d.low;
              });
              globalHigh = Math.ceil(globalHigh / tpoTickSize) * tpoTickSize + tpoTickSize * 3;
              globalLow = Math.floor(globalLow / tpoTickSize) * tpoTickSize - tpoTickSize * 3;

              const priceRows = [];
              for (let p = globalHigh; p >= globalLow; p -= tpoTickSize) priceRows.push(p);

              // No composite volume profile - each day has its own

              // Calculate cumulative X positions for each day
              let cumX = 0;
              const dayPositions = dayData.map(d => {
                const pos = cumX;
                cumX += d.width;
                return pos;
              });
              const totalWidth = cumX;

              // Store scroll position for crosshair
              let scrollLeftRef = 0;

              const handleMouseMove = (e, chartRef) => {
                if (!chartRef) return;
                const rect = chartRef.getBoundingClientRect();
                scrollLeftRef = chartRef.scrollLeft;
                const scrollTop = chartRef.scrollTop;
                const x = e.clientX - rect.left;
                const xWithScroll = x + scrollLeftRef;
                const y = e.clientY - rect.top;
                const yInContent = y - 36 + scrollTop;
                // Find which day based on x position
                let dayIdx = dayData.length - 1;
                for (let i = 0; i < dayData.length; i++) {
                  if (xWithScroll < dayPositions[i] + dayData[i].width) {
                    dayIdx = i;
                    break;
                  }
                }
                const rowIdx = Math.floor(yInContent / rowHeight);
                const price = priceRows[rowIdx] || 0;
                // Store clientX/clientY for fixed crosshair positioning
                setChartCrosshair({
                  show: true,
                  x, y,
                  clientX: e.clientX,
                  clientY: e.clientY,
                  chartLeft: rect.left,
                  chartTop: rect.top,
                  chartRight: rect.right,
                  chartBottom: rect.bottom,
                  scrollLeft: scrollLeftRef,
                  scrollTop,
                  price,
                  dayIdx,
                  day: dayData[dayIdx]
                });
              };

              return (
                <div style={{
                  display: 'flex',
                  height: 'calc(100vh - 340px)',
                  minHeight: 300,
                  maxHeight: 'calc(100vh - 340px)',
                  background: 'linear-gradient(180deg, rgba(12,12,20,0.98) 0%, rgba(8,8,14,0.98) 100%)',
                  borderRadius: 12,
                  border: '1px solid rgba(147,112,219,0.2)',
                  boxShadow: '0 8px 32px rgba(0,0,0,0.5)',
                  overflow: 'hidden',
                  position: 'relative'
                }}>
                  {/* Crosshair tooltip - Click to show/hide */}
                  {chartCrosshair.show && chartCrosshair.day && chartTooltipPinned && (
                    <div style={{
                      position: 'absolute',
                      left: chartCrosshair.x + 65,
                      top: Math.max(10, chartCrosshair.y - 140),
                      background: 'rgba(20,20,35,0.95)',
                      border: '1px solid rgba(147,112,219,0.5)',
                      borderRadius: 8,
                      padding: '10px 14px',
                      zIndex: 100,
                      boxShadow: '0 4px 24px rgba(0,0,0,0.6)',
                      backdropFilter: 'blur(12px)',
                      pointerEvents: 'none',
                      minWidth: 180
                    }}>
                      <div style={{ fontSize: 12, color: '#ba68c8', fontWeight: 700, marginBottom: 4 }}>
                        {chartCrosshair.day?.weekday} {chartCrosshair.day?.date}
                      </div>
                      <div style={{ fontSize: 9, color: '#666', marginBottom: 6 }}>{isRTHView ? '09:30 - 16:15 ET' : '18:00 - 17:00 ET'}</div>
                      <div style={{ fontSize: 10, color: '#888', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3px 16px' }}>
                        <span>Price:</span><span style={{ color: '#fff', fontWeight: 600 }}>{chartCrosshair.price?.toFixed(1) || '--'}</span>
                        <span>POC:</span><span style={{ color: '#ffaa00', fontWeight: 600 }}>{typeof chartCrosshair.day?.poc === 'number' ? chartCrosshair.day.poc.toFixed(1) : '--'}</span>
                        <span>VAH:</span><span style={{ color: '#00ff88', fontWeight: 600 }}>{typeof chartCrosshair.day?.vah === 'number' ? chartCrosshair.day.vah.toFixed(1) : '--'}</span>
                        <span>VAL:</span><span style={{ color: '#ff4466', fontWeight: 600 }}>{typeof chartCrosshair.day?.val === 'number' ? chartCrosshair.day.val.toFixed(1) : '--'}</span>
                        <span>IB H:</span><span style={{ color: '#fff', fontWeight: 600 }}>{typeof chartCrosshair.day?.ib_high === 'number' ? chartCrosshair.day.ib_high.toFixed(1) : '--'}</span>
                        <span>IB L:</span><span style={{ color: '#fff', fontWeight: 600 }}>{typeof chartCrosshair.day?.ib_low === 'number' ? chartCrosshair.day.ib_low.toFixed(1) : '--'}</span>
                        <span>IB%:</span><span style={{ color: '#00aaff', fontWeight: 600 }}>{(typeof chartCrosshair.day?.ib_high === 'number' && typeof chartCrosshair.day?.ib_low === 'number' && chartCrosshair.day?.high > chartCrosshair.day?.low) ? (((chartCrosshair.day.ib_high - chartCrosshair.day.ib_low) / (chartCrosshair.day.high - chartCrosshair.day.low)) * 100).toFixed(0) + '%' : '--'}</span>
                      </div>
                      <div style={{ height: 1, background: 'rgba(255,255,255,0.1)', margin: '6px 0' }} />
                      <div style={{ fontSize: 10, color: '#888', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3px 12px' }}>
                        <span>VP VAH:</span><span style={{ color: '#00ff88', fontWeight: 600 }}>{typeof chartCrosshair.day?.volVAH === 'number' ? chartCrosshair.day.volVAH.toFixed(1) : '--'}</span>
                        <span>VP VAL:</span><span style={{ color: '#ff4466', fontWeight: 600 }}>{typeof chartCrosshair.day?.volVAL === 'number' ? chartCrosshair.day.volVAL.toFixed(1) : '--'}</span>
                        <span>Day Type:</span><span style={{ color: dayTypeColors[chartCrosshair.day?.day_type] || '#888', fontWeight: 600 }}>{chartCrosshair.day?.day_type?.replace('_', ' ') || '--'}</span>
                        <span>Open Type:</span><span style={{ color: '#00aaff', fontWeight: 600 }}>{chartCrosshair.day?.open_type?.replace('_', ' ') || '--'}</span>
                        <span>Shape:</span><span style={{ color: '#ba68c8', fontWeight: 600 }}>{chartCrosshair.day?.profile_shape?.replace('_', ' ') || '--'}</span>
                        <span>AB Overlap:</span><span style={{ color: chartCrosshair.day?.abOverlap >= 50 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{typeof chartCrosshair.day?.abOverlap === 'number' ? chartCrosshair.day.abOverlap + '%' : '--'}</span>
                      </div>
                    </div>
                  )}

                  {/* Price Scale */}
                  <div style={{
                    width: 58,
                    flexShrink: 0,
                    background: 'linear-gradient(90deg, rgba(18,18,30,0.98) 0%, rgba(12,12,22,0.95) 100%)',
                    borderRight: '1px solid rgba(147,112,219,0.25)'
                  }}>
                    <div style={{ height: 36, background: 'linear-gradient(180deg, rgba(147,112,219,0.12) 0%, rgba(147,112,219,0.05) 100%)', borderBottom: '1px solid rgba(147,112,219,0.25)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      <span style={{ fontSize: 8, color: 'rgba(147,112,219,0.6)', fontWeight: 600, letterSpacing: '0.5px' }}>PRICE</span>
                    </div>
                    <div style={{ overflowY: 'hidden', height: 'calc(100% - 36px)' }} id="price-scale-4w">
                      {priceRows.map(price => {
                        const showLabel = price % 20 === 0;
                        const isMajor = price % 100 === 0;
                        return (
                          <div key={price} style={{
                            height: rowHeight,
                            fontSize: isMajor ? 10 : 9,
                            textAlign: 'center',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            color: isMajor ? 'rgba(147,112,219,0.9)' : showLabel ? '#666' : 'transparent',
                            fontWeight: isMajor ? 600 : 400,
                            borderBottom: isMajor ? '1px solid rgba(147,112,219,0.1)' : 'none'
                          }}>
                            {showLabel ? price.toFixed(0) : ''}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Main Chart with 1-Hour TPO Blocks + Per-Day Volume Profile */}
                  <div
                    id="tpo-chart-main"
                    className="tpo-scroll-container"
                    style={{ flex: 1, overflow: 'auto', position: 'relative', cursor: 'crosshair' }}
                    onScroll={(e) => {
                      const ps = document.getElementById('price-scale-4w');
                      if (ps) ps.scrollTop = e.target.scrollTop;
                    }}
                    onMouseMove={(e) => handleMouseMove(e, e.currentTarget)}
                    onClick={() => setChartTooltipPinned(!chartTooltipPinned)}
                    onMouseLeave={() => { if (!chartTooltipPinned) setChartCrosshair({ ...chartCrosshair, show: false }); }}
                    ref={(el) => {
                      chart4wRef.current = el;
                      // Auto-scroll to latest date (rightmost) on initial mount only
                      if (el && !chart4wInitialized.current && totalWidth > el.clientWidth) {
                        el.scrollLeft = totalWidth - el.clientWidth;
                        chart4wInitialized.current = true;
                      }
                    }}
                  >
                    {/* Dotted crosshair lines - positioned at cursor */}
                    {chartCrosshair.show && chartCrosshair.clientX && (
                      <>
                        {/* Horizontal line */}
                        <div style={{
                          position: 'fixed',
                          left: chartCrosshair.chartLeft + 50,
                          right: window.innerWidth - chartCrosshair.chartRight,
                          height: 1,
                          top: chartCrosshair.clientY,
                          background: 'repeating-linear-gradient(90deg, rgba(186,104,200,0.6) 0px, rgba(186,104,200,0.6) 3px, transparent 3px, transparent 6px)',
                          pointerEvents: 'none',
                          zIndex: 50
                        }} />
                        {/* Vertical line */}
                        <div style={{
                          position: 'fixed',
                          left: chartCrosshair.clientX,
                          top: chartCrosshair.chartTop,
                          height: chartCrosshair.chartBottom - chartCrosshair.chartTop,
                          width: 1,
                          background: 'repeating-linear-gradient(180deg, rgba(186,104,200,0.6) 0px, rgba(186,104,200,0.6) 3px, transparent 3px, transparent 6px)',
                          pointerEvents: 'none',
                          zIndex: 50
                        }} />
                      </>
                    )}

                    {/* Day Headers */}
                    <div style={{
                      display: 'flex',
                      position: 'sticky',
                      top: 0,
                      zIndex: 20,
                      background: 'rgba(18,18,30,0.98)',
                      borderBottom: '1px solid rgba(147,112,219,0.3)'
                    }}>
                      {dayData.map((d, i) => (
                        <div key={d.date} style={{
                          width: d.width,
                          flexShrink: 0,
                          textAlign: 'center',
                          padding: '6px 2px',
                          borderRight: '1px solid rgba(147,112,219,0.2)',
                          background: chartCrosshair.dayIdx === i ? 'rgba(186,104,200,0.2)' : 'transparent'
                        }}>
                          <div style={{ fontSize: 10, color: '#ba68c8', fontWeight: 700 }}>{d.weekday}</div>
                          <div style={{ fontSize: 8, color: '#666' }}>{d.date.slice(5)}</div>
                        </div>
                      ))}
                    </div>

                    {/* TPO Grid with 1-Hour Blocks + Per-Day Volume Profile (10 sub-rows) */}
                    <div style={{ position: 'relative' }}>
                      {priceRows.map((price, rowIdx) => (
                        <div key={price} style={{
                          display: 'flex',
                          height: rowHeight,
                          borderBottom: price % 20 === 0 ? '1px solid rgba(147,112,219,0.12)' : 'none',
                          background: chartCrosshair.price === price ? 'rgba(186,104,200,0.06)' : 'transparent'
                        }}>
                          {dayData.map((d, dayIdx) => {
                            const letters = d.lettersByPrice[price] ? [...d.lettersByPrice[price]].sort() : [];
                            const isInVA = d.vah && d.val && price <= d.vah && price >= d.val;
                            const dayMid = (d.high + d.low) / 2;
                            // Open: EXACT row match only (single block)
                            const isOpenRow = d.openPriceKey && price.toString() === d.openPriceKey;
                            // Close: EXACT row match only (single block)
                            const lastPeriodLetter = d.maxPeriod >= 0 ? (d.maxPeriod < 26 ? String.fromCharCode(65 + d.maxPeriod) : 'A' + String.fromCharCode(65 + d.maxPeriod - 26)) : null;
                            const isCloseRow = d.closePriceKey && price.toString() === d.closePriceKey;
                            // POC row detection - EXACT match only (one row)
                            const isPOCRow = d.pocPriceKey && price.toString() === d.pocPriceKey;
                            // Up/down close color
                            const isUpClose = d.close && d.open && d.close >= d.open;
                            const closeColor = isUpClose ? '#00ff88' : '#ff4466';

                            // Get volume sub-rows for this TPO row (10 bars within the row)
                            const subRowHeight = rowHeight / vpSubRows;
                            const vpSubBars = [];
                            for (let i = 0; i < vpSubRows; i++) {
                              const subPrice = price - (i * vpTickSize);
                              const vol = d.volumeByPrice[subPrice] || 0;
                              const isVPOC = d.dayVPOC && Math.abs(subPrice - d.dayVPOC) < vpTickSize;
                              // Use volume-based VAH/VAL for volume profile markers
                              const isVolVAH = d.volVAH && Math.abs(subPrice - d.volVAH) < vpTickSize;
                              const isVolVAL = d.volVAL && Math.abs(subPrice - d.volVAL) < vpTickSize;
                              const isBuyerZone = subPrice > dayMid;
                              vpSubBars.push({ vol, isVPOC, isVAH: isVolVAH, isVAL: isVolVAL, isBuyerZone, subPrice });
                            }

                            return (
                              <div key={`${d.date}-${price}`} style={{
                                width: d.width,
                                flexShrink: 0,
                                height: rowHeight,
                                display: 'flex',
                                alignItems: 'center',
                                borderRight: '1px solid rgba(147,112,219,0.15)',
                                position: 'relative',
                                paddingLeft: 14, // Space for markers
                                paddingRight: vpBarWidth + vpGap + 14 // Space for volume profile + right margin
                              }}>
                                {/* 1-Hour TPO Blocks - Compact or Expanded */}
                                {(() => {
                                  const lastLetter = letters.length > 0 ? letters[letters.length - 1] : null;
                                  return tpoDisplayMode === 'expanded' ? (
                                    // Expanded: position each letter by its period index
                                    <div style={{
                                      position: 'relative',
                                      width: (d.maxPeriod + 1) * letterWidth,
                                      height: rowHeight - 2
                                    }}>
                                      {letters.map((letter, i) => {
                                        const periodIdx = letter.length === 1
                                          ? letter.charCodeAt(0) - 65
                                          : 26 + (letter.charCodeAt(0) - 65) * 26 + (letter.charCodeAt(1) - 65);
                                        // Open: only 'A' block on the exact open row
                                        const isOpenBlock = letter === 'A' && isOpenRow;
                                        // Close: only last letter block on the exact close row
                                        const isCloseBlock = letter === lastPeriodLetter && isCloseRow && !isOpenBlock;
                                        // Color logic: POC=white, Open=grey, Close=green/red based on candle direction
                                        const blockColor = isPOCRow ? '#000' : isOpenBlock ? '#fff' : isCloseBlock ? '#000' : isInVA ? closeColor : '#888';
                                        const blockBg = isPOCRow ? '#ffffff' : isOpenBlock ? 'rgba(100,100,100,0.6)' : isCloseBlock ? closeColor : isInVA ? `${closeColor}30` : 'rgba(136,136,136,0.25)';
                                        const blockBorder = isPOCRow ? '1px solid #fff' : isOpenBlock ? '1px solid #fff' : isCloseBlock ? `1px solid ${closeColor}` : isInVA ? `1px solid ${closeColor}50` : '1px solid rgba(136,136,136,0.4)';
                                        return (
                                          <span key={i} style={{
                                            position: 'absolute',
                                            left: periodIdx * letterWidth,
                                            width: letterWidth - 1,
                                            height: rowHeight - 2,
                                            display: 'inline-flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: 9,
                                            fontWeight: 700,
                                            color: blockColor,
                                            background: blockBg,
                                            borderRadius: 2,
                                            border: blockBorder
                                          }}>
                                            {letter}
                                          </span>
                                        );
                                      })}
                                    </div>
                                  ) : (
                                    // Compact: stack letters together
                                    letters.map((letter, i) => {
                                      // Open: only 'A' block on the exact open row
                                      const isOpenBlock = letter === 'A' && isOpenRow;
                                      // Close: only last letter block on the exact close row
                                      const isCloseBlock = letter === lastPeriodLetter && isCloseRow && !isOpenBlock;
                                      // Color logic: POC=white, Open=grey, Close=green/red based on candle direction
                                      const blockColor = isPOCRow ? '#000' : isOpenBlock ? '#fff' : isCloseBlock ? '#000' : isInVA ? closeColor : '#888';
                                      const blockBg = isPOCRow ? '#ffffff' : isOpenBlock ? 'rgba(100,100,100,0.6)' : isCloseBlock ? closeColor : isInVA ? `${closeColor}30` : 'rgba(136,136,136,0.25)';
                                      const blockBorder = isPOCRow ? '1px solid #fff' : isOpenBlock ? '1px solid #fff' : isCloseBlock ? `1px solid ${closeColor}` : isInVA ? `1px solid ${closeColor}50` : '1px solid rgba(136,136,136,0.4)';
                                      return (
                                        <span key={i} style={{
                                          width: letterWidth,
                                          height: rowHeight - 2,
                                          display: 'inline-flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          fontSize: 10,
                                          fontWeight: 700,
                                          color: blockColor,
                                          background: blockBg,
                                          borderRadius: 2,
                                          marginRight: 1,
                                          border: blockBorder
                                        }}>
                                          {letter}
                                        </span>
                                      );
                                    })
                                  );
                                })()}
{/* Volume profile rendered as overlay below */}
                              </div>
                            );
                          })}
                        </div>
                      ))}

                      {/* Dense Volume Profile Overlay - iterate actual data */}
                      {dayData.map((d, dayIdx) => {
                        const xPos = dayPositions[dayIdx];
                        const totalHeight = priceRows.length * rowHeight;
                        const dayMid = (d.high + d.low) / 2;

                        // Calculate Y position for any price - aligned to TPO row grid
                        const priceToY = (price) => {
                          const rowPrice = Math.floor(price / tpoTickSize) * tpoTickSize;
                          const rowIndex = (globalHigh - rowPrice) / tpoTickSize;
                          const offsetInRow = 1 - (price - rowPrice) / tpoTickSize;
                          return (rowIndex + offsetInRow) * rowHeight;
                        };

                        // Use actual data keys - no lookup issues
                        const vpLevels = Object.entries(d.volumeByPrice || {}).map(([priceKey, vol]) => {
                          const price = parseFloat(priceKey);
                          const delta = d.deltaByPrice?.[priceKey] ?? d.deltaByPrice?.[price];
                          return { price, vol, delta };
                        }).filter(l => l.vol > 0).sort((a, b) => b.price - a.price);

                        const vpMaxVol = Math.max(...vpLevels.map(l => l.vol), 1);

                        return (
                          <React.Fragment key={`vp-${dayIdx}`}>
                            <div style={{
                              position: 'absolute',
                              left: xPos + d.width - vpBarWidth - 10,
                              top: 0,
                              width: vpBarWidth,
                              height: totalHeight,
                              borderLeft: '1px solid rgba(147,112,219,0.25)',
                              overflow: 'hidden'
                            }}>
                              {vpLevels.map((level, i) => {
                                const yPos = priceToY(level.price);
                                const barHeight = 1;
                                const isVPOC = d.dayVPOC && Math.abs(level.price - d.dayVPOC) < 1;
                                const isVAH = d.volVAH && Math.abs(level.price - d.volVAH) < 1;
                                const isVAL = d.volVAL && Math.abs(level.price - d.volVAL) < 1;
                                const hasRealDelta = level.delta !== undefined && level.delta !== null && level.delta !== 0;
                                const isBuyDelta = hasRealDelta ? level.delta > 0 : (level.price > dayMid);

                                return (
                                  <div key={i} style={{
                                    position: 'absolute',
                                    top: yPos,
                                    left: 4,
                                    width: `${Math.min((level.vol / vpMaxVol) * 95, 95)}%`,
                                    height: barHeight,
                                    background: isVPOC ? '#ff9900' : isVAH ? '#00ff88' : isVAL ? '#ff4466' : isBuyDelta ? '#00dd77' : '#cc3366',
                                    opacity: 0.85
                                  }} />
                                );
                              })}
                            </div>
                            {/* 4pm label to right of VP */}
                            <div style={{
                              position: 'absolute',
                              left: xPos + d.width - 8,
                              top: priceToY(d.close || d.low) - 5,
                              fontSize: 8,
                              color: '#666',
                              fontWeight: 500,
                              pointerEvents: 'none',
                              zIndex: 5
                            }}>
                              4pm
                            </div>
                          </React.Fragment>
                        );
                      })}

                      {/* Absolute positioned markers for exact price levels */}
                      {dayData.map((d, dayIdx) => {
                        // Calculate exact Y positions for each level - aligned to TPO row grid
                        const calcY = (price) => {
                          const rowPrice = Math.floor(price / tpoTickSize) * tpoTickSize;
                          const rowIndex = (globalHigh - rowPrice) / tpoTickSize;
                          const offsetInRow = 1 - (price - rowPrice) / tpoTickSize;
                          return (rowIndex + offsetInRow) * rowHeight;
                        };
                        const xPos = dayPositions[dayIdx];
                        const dayMid = (d.high + d.low) / 2;

                        // IB rendered as thin vertical bar (7px from left edge for column divider spacing)
                        return (
                          <React.Fragment key={`markers-${d.date}`}>
                            {/* IB vertical bar - thin white line from IB high to IB low */}
                            {d.ib_high && d.ib_low && (
                              <div style={{
                                position: 'absolute',
                                left: xPos + 7,
                                top: calcY(d.ib_high),
                                width: 2,
                                height: calcY(d.ib_low) - calcY(d.ib_high),
                                background: '#ffffff',
                                opacity: 0.8,
                                zIndex: 10,
                                pointerEvents: 'none'
                              }} />
                            )}
                            {/* VAH arrow - white down arrow to the right of VP */}
                            {d.volVAH && (
                              <div style={{
                                position: 'absolute',
                                left: xPos + d.width - 8,
                                top: calcY(d.volVAH) - 6,
                                fontSize: 9,
                                color: '#ffffff',
                                fontWeight: 700,
                                zIndex: 15,
                                pointerEvents: 'none'
                              }}>‚ñº</div>
                            )}
                            {/* VAL arrow - white up arrow to the right of VP */}
                            {d.volVAL && (
                              <div style={{
                                position: 'absolute',
                                left: xPos + d.width - 8,
                                top: calcY(d.volVAL) - 6,
                                fontSize: 9,
                                color: '#ffffff',
                                fontWeight: 700,
                                zIndex: 15,
                                pointerEvents: 'none'
                              }}>‚ñ≤</div>
                            )}
                          </React.Fragment>
                        );
                      })}
                    </div>
                  </div>

                  {/* Stats Footer */}
                  <div style={{
                    position: 'absolute',
                    bottom: 0,
                    left: 50,
                    right: 0,
                    height: 28,
                    background: 'linear-gradient(180deg, rgba(20,20,35,0.95) 0%, rgba(15,15,25,0.98) 100%)',
                    borderTop: '1px solid rgba(147,112,219,0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: 20,
                    fontSize: 9
                  }}>
                    <span style={{ color: '#666' }}>Range <span style={{ color: '#9370DB', fontWeight: 600 }}>{(globalHigh - globalLow).toFixed(0)}</span></span>
                    <span style={{ color: '#666' }}>Days <span style={{ color: '#00aaff', fontWeight: 600 }}>{days.length}</span></span>
                    <span style={{ color: '#fff', background: '#fff', padding: '0 4px', borderRadius: 2 }}><span style={{ color: '#000' }}>POC</span></span>
                    <span style={{ color: '#00aaff' }}>‚îÄ MID</span>
                    <span style={{ color: '#fff' }}>‚îÇ IB</span>
                    <span style={{ color: '#fff' }}>‚ñº VAH</span>
                    <span style={{ color: '#fff' }}>‚ñ≤ VAL</span>
                    <span style={{ color: '#fff' }}>‚óã Open</span>
                    <span style={{ color: '#00ff88' }}>‚óè Close‚Üë</span>
                    <span style={{ color: '#ff4466' }}>‚óè Close‚Üì</span>
                  </div>
                </div>
              );
            })()
          ) : selectedSession === 'session_view' && data?.sessions ? (
            /* Session View - Today's sessions as columns with 30-min blocks */
            (() => {
              const sessions = Object.entries(data?.sessions || {}).filter(([k, s]) => s.profiles && Object.keys(s.profiles).length > 0);
              if (sessions.length === 0) {
                return <div style={{ textAlign: 'center', color: '#8b8b8b', padding: 40 }}>No session data yet...</div>;
              }

              const tickSize = 0.5; // Fine tick for detail
              const rowHeight = 14;
              const letterWidth = 11;
              const vpBarWidth = 45;
              const vpGap = 16; // Increased gap between TPO and volume profile
              const columnWidth = 11; // For expanded time view

              // Letter to period index for expanded time view
              const sessLetterToIndex = (letter) => {
                if (letter.length === 1) return letter.charCodeAt(0) - 65;
                return 26 + (letter.charCodeAt(0) - 65) * 26 + (letter.charCodeAt(1) - 65);
              };

              // Calculate data for each session
              const sessionData = sessions.map(([key, session]) => {
                const sessionProfiles = session.profiles || {};
                let maxLetters = 0;
                let maxPeriod = 0;
                const lettersByPrice = {};
                const volumeByPrice = {};

                Object.entries(sessionProfiles).forEach(([priceKey, letters]) => {
                  const price = Math.floor(parseFloat(priceKey) / tickSize) * tickSize;
                  if (!lettersByPrice[price]) lettersByPrice[price] = new Set();
                  letters.forEach(l => {
                    lettersByPrice[price].add(l);
                    const idx = sessLetterToIndex(l);
                    if (idx > maxPeriod) maxPeriod = idx;
                  });
                  volumeByPrice[price] = (volumeByPrice[price] || 0) + letters.length;
                });

                Object.values(lettersByPrice).forEach(letters => {
                  if (letters.size > maxLetters) maxLetters = letters.size;
                });

                let sessionVPOC = session.poc, maxVol = 0;
                Object.entries(volumeByPrice).forEach(([p, v]) => {
                  if (v > maxVol) { maxVol = v; sessionVPOC = parseFloat(p); }
                });

                // Width depends on display mode
                const compactWidth = Math.max(maxLetters * letterWidth + vpGap + vpBarWidth + 16, 120);
                const expandedWidth = Math.max((maxPeriod + 1) * columnWidth + vpGap + vpBarWidth + 16, 150);

                return {
                  key,
                  ...session,
                  lettersByPrice,
                  volumeByPrice,
                  maxVol,
                  sessionVPOC,
                  maxLetters: Math.max(maxLetters, 1),
                  maxPeriod,
                  width: tpoDisplayMode === 'expanded' ? expandedWidth : compactWidth
                };
              });

              // Global price range across all sessions
              let globalHigh = 0, globalLow = 999999;
              sessions.forEach(([k, s]) => {
                if (s.high > globalHigh) globalHigh = s.high;
                if (s.low < globalLow) globalLow = s.low;
              });
              globalHigh = Math.ceil(globalHigh / tickSize) * tickSize + tickSize * 5;
              globalLow = Math.floor(globalLow / tickSize) * tickSize - tickSize * 5;

              const priceRows = [];
              for (let p = globalHigh; p >= globalLow; p -= tickSize) priceRows.push(p);

              // Calculate cumulative X positions
              let cumX = 0;
              const sessionPositions = sessionData.map(s => {
                const pos = cumX;
                cumX += s.width;
                return pos;
              });
              const totalWidth = cumX;

              // Mouse handling for crosshair
              let scrollLeftRef = 0;
              const handleMouseMove = (e, chartRef) => {
                if (!chartRef) return;
                const rect = chartRef.getBoundingClientRect();
                scrollLeftRef = chartRef.scrollLeft;
                const scrollTop = chartRef.scrollTop;
                const x = e.clientX - rect.left;
                const xWithScroll = x + scrollLeftRef;
                const y = e.clientY - rect.top;
                const yInContent = y - 36 + scrollTop;

                let sessIdx = sessionData.length - 1;
                for (let i = 0; i < sessionData.length; i++) {
                  if (xWithScroll < sessionPositions[i] + sessionData[i].width) {
                    sessIdx = i;
                    break;
                  }
                }
                const rowIdx = Math.floor(yInContent / rowHeight);
                const price = priceRows[rowIdx] || 0;
                setChartCrosshair({
                  show: true, x, y,
                  clientX: e.clientX, clientY: e.clientY,
                  chartLeft: rect.left, chartTop: rect.top,
                  chartRight: rect.right, chartBottom: rect.bottom,
                  scrollLeft: scrollLeftRef, scrollTop,
                  price, dayIdx: sessIdx, day: sessionData[sessIdx]
                });
              };

              return (
                <div style={{
                  display: 'flex',
                  height: 'calc(100vh - 340px)',
                  minHeight: 300,
                  maxHeight: 'calc(100vh - 340px)',
                  background: 'linear-gradient(180deg, rgba(12,12,20,0.98) 0%, rgba(8,8,14,0.98) 100%)',
                  borderRadius: 12,
                  border: '1px solid rgba(147,112,219,0.2)',
                  boxShadow: '0 8px 32px rgba(0,0,0,0.5)',
                  overflow: 'hidden',
                  position: 'relative'
                }}>
                  {/* Crosshair tooltip - Click to show/hide */}
                  {chartCrosshair.show && chartCrosshair.day && chartTooltipPinned && (
                    <div style={{
                      position: 'absolute',
                      left: Math.max(60, Math.min(chartCrosshair.x + 60, 500)),
                      top: Math.max(50, Math.min(chartCrosshair.y, 300)),
                      background: 'rgba(20,20,35,0.95)',
                      border: `1px solid ${chartCrosshair.day?.color || '#9370DB'}`,
                      borderRadius: 8,
                      padding: '10px 14px',
                      zIndex: 100,
                      boxShadow: '0 4px 24px rgba(0,0,0,0.6)',
                      pointerEvents: 'none'
                    }}>
                      <div style={{ fontSize: 12, color: chartCrosshair.day?.color || '#ba68c8', fontWeight: 700, marginBottom: 6 }}>
                        {chartCrosshair.day?.display}
                      </div>
                      <div style={{ fontSize: 10, color: '#888', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '3px 16px' }}>
                        <span>Price:</span><span style={{ color: '#fff', fontWeight: 600 }}>{chartCrosshair.price?.toFixed(1)}</span>
                        <span>POC:</span><span style={{ color: '#ffaa00', fontWeight: 600 }}>{chartCrosshair.day?.poc?.toFixed(1)}</span>
                        <span>VAH:</span><span style={{ color: '#00ff88', fontWeight: 600 }}>{chartCrosshair.day?.vah?.toFixed(1)}</span>
                        <span>VAL:</span><span style={{ color: '#ff4466', fontWeight: 600 }}>{chartCrosshair.day?.val?.toFixed(1)}</span>
                      </div>
                    </div>
                  )}

                  {/* Price Scale */}
                  <div style={{
                    width: 50,
                    flexShrink: 0,
                    background: 'rgba(15,15,25,0.95)',
                    borderRight: '1px solid rgba(147,112,219,0.2)'
                  }}>
                    <div style={{ height: 36, background: 'rgba(147,112,219,0.08)', borderBottom: '1px solid rgba(147,112,219,0.2)' }} />
                    <div style={{ overflowY: 'hidden', height: 'calc(100% - 36px)' }} id="price-scale-sess">
                      {priceRows.map(price => (
                        <div key={price} style={{
                          height: rowHeight,
                          fontSize: 9,
                          textAlign: 'right',
                          paddingRight: 4,
                          color: '#555',
                          lineHeight: `${rowHeight}px`
                        }}>
                          {price % 10 === 0 ? price.toFixed(0) : ''}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Main Chart */}
                  <div
                    id="tpo-session-main"
                    className="tpo-scroll-container"
                    style={{ flex: 1, overflow: 'auto', position: 'relative', cursor: 'crosshair' }}
                    onScroll={(e) => {
                      const ps = document.getElementById('price-scale-sess');
                      if (ps) ps.scrollTop = e.target.scrollTop;
                    }}
                    onMouseMove={(e) => handleMouseMove(e, e.currentTarget)}
                    onClick={() => setChartTooltipPinned(!chartTooltipPinned)}
                    onMouseLeave={() => { if (!chartTooltipPinned) setChartCrosshair({ ...chartCrosshair, show: false }); }}
                  >
                    {/* Crosshair lines */}
                    {chartCrosshair.show && chartCrosshair.clientX && (
                      <>
                        <div style={{
                          position: 'fixed',
                          left: chartCrosshair.chartLeft + 50,
                          right: window.innerWidth - chartCrosshair.chartRight,
                          height: 1,
                          top: chartCrosshair.clientY,
                          background: 'repeating-linear-gradient(90deg, rgba(186,104,200,0.6) 0px, rgba(186,104,200,0.6) 3px, transparent 3px, transparent 6px)',
                          pointerEvents: 'none',
                          zIndex: 50
                        }} />
                        <div style={{
                          position: 'fixed',
                          left: chartCrosshair.clientX,
                          top: chartCrosshair.chartTop,
                          height: chartCrosshair.chartBottom - chartCrosshair.chartTop,
                          width: 1,
                          background: 'repeating-linear-gradient(180deg, rgba(186,104,200,0.6) 0px, rgba(186,104,200,0.6) 3px, transparent 3px, transparent 6px)',
                          pointerEvents: 'none',
                          zIndex: 50
                        }} />
                      </>
                    )}

                    {/* Session Headers */}
                    <div style={{
                      display: 'flex',
                      position: 'sticky',
                      top: 0,
                      zIndex: 20,
                      background: 'rgba(18,18,30,0.98)',
                      borderBottom: '1px solid rgba(147,112,219,0.3)'
                    }}>
                      {sessionData.map((s, i) => (
                        <div key={s.key} style={{
                          width: s.width,
                          flexShrink: 0,
                          textAlign: 'center',
                          padding: '8px 4px',
                          borderRight: '1px solid rgba(147,112,219,0.2)',
                          background: chartCrosshair.dayIdx === i ? `${s.color}20` : 'transparent'
                        }}>
                          <div style={{ fontSize: 11, color: s.color, fontWeight: 700 }}>{s.display}</div>
                          <div style={{ fontSize: 8, color: '#666' }}>{s.period_count} periods</div>
                        </div>
                      ))}
                    </div>

                    {/* TPO Grid */}
                    <div style={{ position: 'relative' }}>
                      {priceRows.map((price, rowIdx) => (
                        <div key={price} style={{
                          display: 'flex',
                          height: rowHeight,
                          borderBottom: price % 10 === 0 ? '1px solid rgba(147,112,219,0.12)' : 'none',
                          background: chartCrosshair.price === price ? 'rgba(186,104,200,0.06)' : 'transparent'
                        }}>
                          {sessionData.map((s, sessIdx) => {
                            const letters = s.lettersByPrice[price] ? [...s.lettersByPrice[price]].sort() : [];
                            const vol = s.volumeByPrice[price] || 0;
                            const volPct = s.maxVol > 0 ? (vol / s.maxVol) * 100 : 0;
                            const isVPOC = s.sessionVPOC && Math.abs(price - s.sessionVPOC) < tickSize;
                            const isInVA = s.vah && s.val && price <= s.vah && price >= s.val;
                            // Use delta data for coloring - positive = buy aggression, negative = sell
                            const delta = s.deltaByPrice?.[price] || 0;
                            const hasRealDelta = s.deltaByPrice && Object.keys(s.deltaByPrice).length > 0;
                            const isBuyDelta = hasRealDelta ? delta >= 0 : (price > (s.high + s.low) / 2);

                            return (
                              <div key={`${s.key}-${price}`} style={{
                                width: s.width,
                                flexShrink: 0,
                                height: rowHeight,
                                display: 'flex',
                                alignItems: 'center',
                                borderRight: '1px solid rgba(147,112,219,0.1)',
                                position: 'relative',
                                paddingLeft: 14,
                                paddingRight: vpBarWidth + vpGap + 14
                              }}>
                                {/* TPO Blocks - Compact or Expanded */}
                                {tpoDisplayMode === 'expanded' ? (
                                  // Expanded: position each letter by its time period
                                  <div style={{
                                    display: 'flex',
                                    position: 'relative',
                                    width: (s.maxPeriod + 1) * columnWidth,
                                    height: rowHeight - 2
                                  }}>
                                    {letters.map((letter, i) => {
                                      const periodIdx = sessLetterToIndex(letter);
                                      return (
                                        <span key={i} style={{
                                          position: 'absolute',
                                          left: periodIdx * columnWidth,
                                          width: columnWidth - 1,
                                          height: rowHeight - 2,
                                          display: 'inline-flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          fontSize: 9,
                                          fontWeight: 700,
                                          color: isInVA ? '#00ee88' : s.color,
                                          background: `${s.color}30`,
                                          borderRadius: 2,
                                          border: `1px solid ${s.color}50`
                                        }}>
                                          {letter}
                                        </span>
                                      );
                                    })}
                                  </div>
                                ) : (
                                  // Compact: stack letters together
                                  letters.map((letter, i) => (
                                    <span key={i} style={{
                                      width: letterWidth,
                                      height: rowHeight - 2,
                                      display: 'inline-flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      fontSize: 9,
                                      fontWeight: 700,
                                      color: isInVA ? '#00ee88' : s.color,
                                      background: `${s.color}30`,
                                      borderRadius: 2,
                                      marginRight: 1,
                                      border: `1px solid ${s.color}50`
                                    }}>
                                      {letter}
                                    </span>
                                  ))
                                )}
                                {/* Volume Profile - thin line style with delta coloring */}
                                {vol > 0 && (
                                  <div style={{
                                    position: 'absolute',
                                    right: 12,
                                    width: vpBarWidth,
                                    height: rowHeight - 2,
                                    display: 'flex',
                                    alignItems: 'center',
                                    paddingLeft: vpGap,
                                    borderLeft: '1px solid rgba(147,112,219,0.15)'
                                  }}>
                                    <div style={{
                                      width: `${volPct}%`,
                                      height: 1,
                                      marginBottom: 1,
                                      opacity: 0.9,
                                      background: isVPOC ? '#ff9900' :
                                                 isBuyDelta ? '#00ee88' : '#ff2266',
                                      borderRadius: 0
                                    }} />
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      ))}

                      {/* Markers */}
                      {sessionData.map((s, sessIdx) => {
                        const calcY = (price) => {
                          const rowPrice = Math.floor(price / tickSize) * tickSize;
                          const rowIndex = (globalHigh - rowPrice) / tickSize;
                          const offsetInRow = 1 - (price - rowPrice) / tickSize;
                          return (rowIndex + offsetInRow) * rowHeight;
                        };
                        const xPos = sessionPositions[sessIdx];
                        const sessMid = (s.high + s.low) / 2;

                        const markers = [];
                        if (s.poc) markers.push({ price: s.poc, color: '#ffcc00', label: '‚óÜ', type: 'poc' }); // POC Yellow
                        markers.push({ price: sessMid, color: '#00aaff', label: '‚îÄ', type: 'mid' }); // MID Blue
                        if (s.vah) markers.push({ price: s.vah, color: '#00ff88', label: '‚ñ≤', type: 'vah' });
                        if (s.val) markers.push({ price: s.val, color: '#ff4466', label: '‚ñº', type: 'val' });

                        return markers.map((m) => (
                          <div key={`${s.key}-${m.type}`} style={{
                            position: 'absolute',
                            left: xPos + 1,
                            top: calcY(m.price) - 5,
                            color: m.color,
                            fontSize: m.type === 'mid' ? 10 : 8,
                            fontWeight: 700,
                            zIndex: 10,
                            textShadow: '0 0 3px rgba(0,0,0,0.8)',
                            pointerEvents: 'none'
                          }}>
                            {m.label}
                          </div>
                        ));
                      })}
                    </div>
                  </div>

                  {/* Stats Footer */}
                  <div style={{
                    position: 'absolute',
                    bottom: 0,
                    left: 50,
                    right: 0,
                    height: 28,
                    background: 'linear-gradient(180deg, rgba(20,20,35,0.95) 0%, rgba(15,15,25,0.98) 100%)',
                    borderTop: '1px solid rgba(147,112,219,0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: 20,
                    fontSize: 9
                  }}>
                    <span style={{ color: '#666' }}>Sessions <span style={{ color: '#ba68c8', fontWeight: 600 }}>{sessionData.length}</span></span>
                    <span style={{ color: '#ffcc00' }}>‚óÜ POC</span>
                    <span style={{ color: '#00aaff' }}>‚îÄ MID</span>
                    <span style={{ color: '#fff' }}>‚ñº VAH</span>
                    <span style={{ color: '#fff' }}>‚ñ≤ VAL</span>
                    <span style={{ color: '#fff' }}>‚óã Open</span>
                    <span style={{ color: '#00ff88' }}>‚óè Close‚Üë</span>
                    <span style={{ color: '#ff4466' }}>‚óè Close‚Üì</span>
                  </div>
                </div>
              );
            })()
          ) : profileEntries.length === 0 ? (
            <div style={{ textAlign: 'center', color: '#8b8b8b', padding: 40 }}>
              No TPO data yet. Waiting for trades...
            </div>
          ) : (
            <>
              {(() => {
                const maxCount = Math.max(...profileEntries.map(e => e.letters.length), 1);
                // Calculate max period index for expanded view
                const maxPeriod = Math.max(...profileEntries.flatMap(e => e.letters.map(l => letterToIndex(l))), 0);
                const columnWidth = 11; // Width of each column in expanded mode
                // Use effectiveTickSize for comparisons so POC/price shows at larger tick sizes
                const comparisonTolerance = effectiveTickSize || data?.tick_size || 0.1;

                // Find key price levels
                const openPrice = activeProfile?.open_price || data?.open_price;
                const highPrice = Math.max(...profileEntries.map(e => e.price));
                const lowPrice = Math.min(...profileEntries.map(e => e.price));
                const midPrice = (highPrice + lowPrice) / 2;

                return profileEntries.map(({ price, letters }) => {
                  const isPOC = activeProfile?.poc && Math.abs(price - activeProfile.poc) < comparisonTolerance;
                  const isVAH = activeProfile?.vah && Math.abs(price - activeProfile.vah) < comparisonTolerance;
                  const isVAL = activeProfile?.val && Math.abs(price - activeProfile.val) < comparisonTolerance;
                  const isInVA = activeProfile?.vah && activeProfile?.val && price <= activeProfile.vah && price >= activeProfile.val;
                  const isIB = activeProfile?.ib_high && activeProfile?.ib_low && price <= activeProfile.ib_high && price >= activeProfile.ib_low;
                  const isIBHigh = activeProfile?.ib_high && Math.abs(price - activeProfile.ib_high) < comparisonTolerance;
                  const isIBLow = activeProfile?.ib_low && Math.abs(price - activeProfile.ib_low) < comparisonTolerance;
                  const isSinglePrint = letters.length === 1;
                  const isCurrent = data?.current_price && Math.abs(price - data.current_price) < comparisonTolerance;
                  const isOpen = openPrice && Math.abs(price - openPrice) < comparisonTolerance;
                  const isMid = Math.abs(price - midPrice) < comparisonTolerance;
                  const isHigh = Math.abs(price - highPrice) < comparisonTolerance;
                  const isLow = Math.abs(price - lowPrice) < comparisonTolerance;

                  return (
                    <div
                      key={price}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        height: 16,
                        position: 'relative',
                        // IB zone background (cyan like TradingView)
                        background: isIB ? 'rgba(0, 188, 212, 0.08)' : 'transparent',
                      }}
                    >
                      {/* Price column */}
                      <div style={{
                        width: 55,
                        textAlign: 'right',
                        paddingRight: 6,
                        fontSize: 9,
                        color: isPOC ? '#fff' : isCurrent ? '#00ff88' : '#555',
                        fontWeight: isPOC || isCurrent ? 700 : 400,
                        flexShrink: 0
                      }}>
                        {price.toFixed(1)}
                      </div>

                      {/* Level markers column - POC label removed (now white blocks) */}
                      <div style={{
                        width: 40,
                        fontSize: 8,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'flex-end',
                        paddingRight: 4,
                        flexShrink: 0,
                        gap: 2
                      }}>
                        {isVAH && !isPOC && <span style={{ color: '#00aaff', fontSize: 7 }}>VAH</span>}
                        {isVAL && !isPOC && <span style={{ color: '#00aaff', fontSize: 7 }}>VAL</span>}
                        {isMid && !isPOC && <span style={{ color: '#ff9800', fontSize: 7 }}>Mid</span>}
                        {isOpen && !isPOC && <span style={{ color: '#888', fontSize: 7 }}>Open</span>}
                        {isCurrent && <span style={{ color: '#00ff88' }}>‚óÄ</span>}
                      </div>

                      {/* TPO Letter Blocks - POC white, VA purple, outside VA grey */}
                      <div style={{
                        flex: 1,
                        display: 'flex',
                        alignItems: 'center',
                        gap: tpoDisplayMode === 'compact' ? 1 : 0,
                        position: 'relative',
                        minHeight: 14,
                        minWidth: tpoDisplayMode === 'expanded' ? (maxPeriod + 1) * columnWidth : 'auto',
                        overflowX: tpoDisplayMode === 'expanded' ? 'visible' : 'hidden'
                      }}>
                        {tpoDisplayMode === 'compact' ? (
                          // Compact mode: letters displayed sequentially
                          letters.map((letter, idx) => {
                            // Open block = 'A', check if first letter
                            const isOpenBlock = letter === 'A' && isOpen;
                            return (
                              <div
                                key={`${price}-${letter}-${idx}`}
                                style={{
                                  width: 13,
                                  height: 13,
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  background: isPOC ? '#ffffff' :
                                             isOpenBlock ? 'rgba(100,100,100,0.6)' :
                                             isSinglePrint ? 'rgba(255,68,102,0.9)' :
                                             isInVA ? 'rgba(186, 104, 200, 0.85)' : 'rgba(102,102,102,0.6)',
                                  borderRadius: 1,
                                  fontSize: 8,
                                  fontWeight: 600,
                                  color: isPOC ? '#1a1a2e' : isOpenBlock ? '#fff' : '#fff',
                                  flexShrink: 0,
                                  border: isPOC ? 'none' : isOpenBlock ? '1px solid #fff' : isInVA ? '1px solid rgba(156, 39, 176, 0.3)' : '1px solid rgba(102,102,102,0.4)'
                                }}
                              >
                                {letter}
                              </div>
                            );
                          })
                        ) : (
                          // Expanded mode: each letter positioned by its period index
                          <div style={{
                            position: 'relative',
                            width: (maxPeriod + 1) * columnWidth,
                            height: 14
                          }}>
                            {letters.map((letter, idx) => {
                              const colIndex = letterToIndex(letter);
                              const isOpenBlock = letter === 'A' && isOpen;
                              return (
                                <div
                                  key={`${price}-${letter}-${idx}`}
                                  style={{
                                    position: 'absolute',
                                    left: colIndex * columnWidth,
                                    width: columnWidth - 1,
                                    height: 13,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    background: isPOC ? '#ffffff' :
                                               isOpenBlock ? 'rgba(100,100,100,0.6)' :
                                               isSinglePrint ? 'rgba(255,68,102,0.9)' :
                                               isInVA ? 'rgba(186, 104, 200, 0.85)' : 'rgba(102,102,102,0.6)',
                                    borderRadius: 1,
                                    fontSize: 7,
                                    fontWeight: 600,
                                    color: isPOC ? '#1a1a2e' : isOpenBlock ? '#fff' : '#fff',
                                    border: isPOC ? 'none' : isOpenBlock ? '1px solid #fff' : isInVA ? '1px solid rgba(156, 39, 176, 0.3)' : '1px solid rgba(102,102,102,0.4)'
                                  }}
                                >
                                  {letter}
                                </div>
                              );
                            })}
                          </div>
                        )}

                        {/* POC horizontal line removed - POC is now white blocks */}
                      </div>

                      {/* Volume histogram bar on right */}
                      <div style={{
                        width: 60,
                        height: 12,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'flex-start',
                        paddingLeft: 4,
                        flexShrink: 0
                      }}>
                        <div style={{
                          height: 10,
                          width: `${(letters.length / maxCount) * 100}%`,
                          background: isPOC ? 'rgba(255,255,255,0.6)' :
                                     isInVA ? 'rgba(186, 104, 200, 0.5)' :
                                     'rgba(100,100,120,0.4)',
                          borderRadius: 1
                        }} />
                      </div>

                    </div>
                  );
                });
              })()}

              {/* IB Range indicator at bottom */}
              {activeProfile?.ib_high && activeProfile?.ib_low && (
                <div style={{
                  marginTop: 8,
                  padding: '6px 10px',
                  background: 'rgba(0, 188, 212, 0.15)',
                  borderRadius: 4,
                  border: '1px solid rgba(0, 188, 212, 0.3)',
                  display: 'flex',
                  justifyContent: 'space-between',
                  fontSize: 10
                }}>
                  <span style={{ color: '#00bcd4' }}>IB Range</span>
                  <span style={{ color: '#fff' }}>
                    {activeProfile.ib_high?.toFixed(1)} - {activeProfile.ib_low?.toFixed(1)}
                    <span style={{ color: '#888', marginLeft: 8 }}>
                      ({((activeProfile.ib_high - activeProfile.ib_low) || 0).toFixed(1)} pts)
                    </span>
                  </span>
                </div>
              )}

              {/* TPO Stats Table */}
              <div style={{
                marginTop: 16,
                padding: 12,
                background: 'rgba(20,20,28,0.6)',
                borderRadius: 8,
                border: '1px solid rgba(255,255,255,0.06)'
              }}>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(5, 1fr)',
                  gap: 12,
                  fontSize: 11
                }}>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>HL range</div>
                    <div style={{ color: '#fff', fontFamily: 'monospace' }}>
                      {activeProfile?.high && activeProfile?.low
                        ? (activeProfile.high - activeProfile.low).toFixed(1)
                        : '--'}
                    </div>
                  </div>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>VA range</div>
                    <div style={{ color: '#fff', fontFamily: 'monospace' }}>
                      {activeProfile?.vah && activeProfile?.val
                        ? (activeProfile.vah - activeProfile.val).toFixed(1)
                        : '--'}
                    </div>
                  </div>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>VAH</div>
                    <div style={{ color: '#00ff88', fontFamily: 'monospace' }}>
                      {activeProfile?.vah?.toFixed(1) || '--'}
                    </div>
                  </div>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>VAL</div>
                    <div style={{ color: '#ff4466', fontFamily: 'monospace' }}>
                      {activeProfile?.val?.toFixed(1) || '--'}
                    </div>
                  </div>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>POC</div>
                    <div style={{ color: '#ffaa00', fontFamily: 'monospace' }}>
                      {activeProfile?.poc?.toFixed(1) || '--'}
                    </div>
                  </div>
                </div>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(4, 1fr)',
                  gap: 12,
                  fontSize: 11,
                  marginTop: 10,
                  paddingTop: 10,
                  borderTop: '1px solid rgba(255,255,255,0.06)'
                }}>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>Total vol</div>
                    <div style={{ color: '#fff', fontFamily: 'monospace' }}>
                      {activeProfile?.volume
                        ? (activeProfile.volume >= 1000 ? (activeProfile.volume / 1000).toFixed(2) + 'K' : activeProfile.volume)
                        : '--'}
                    </div>
                  </div>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>IB high</div>
                    <div style={{ color: '#00aaff', fontFamily: 'monospace' }}>
                      {activeProfile?.ib_high?.toFixed(1) || '--'}
                    </div>
                  </div>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>IB low</div>
                    <div style={{ color: '#00aaff', fontFamily: 'monospace' }}>
                      {activeProfile?.ib_low?.toFixed(1) || '--'}
                    </div>
                  </div>
                  <div>
                    <div style={{ color: '#666', fontSize: 9, marginBottom: 2 }}>IB range</div>
                    <div style={{ color: '#fff', fontFamily: 'monospace' }}>
                      {activeProfile?.ib_high && activeProfile?.ib_low
                        ? (activeProfile.ib_high - activeProfile.ib_low).toFixed(1)
                        : '--'}
                    </div>
                  </div>
                </div>
              </div>
            </>
          )}
        </div>
      </div>

      {/* Right Sidebar - Classifications */}
      {!tpoExpanded && <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
        {/* Day Type Classification */}
        <div style={{
          background: 'rgba(20,20,28,0.9)',
          borderRadius: 12,
          border: '1px solid rgba(255,255,255,0.08)',
          padding: 16
        }}>
          <div style={{ fontSize: 12, color: '#8b8b8b', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 1 }}>
            Day Type
          </div>

          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: 12,
            marginBottom: 12
          }}>
            <div style={{
              padding: '8px 16px',
              background: `${dayTypeColors[displayData.day_type] || '#888'}20`,
              border: `1px solid ${dayTypeColors[displayData.day_type] || '#888'}`,
              borderRadius: 8,
              color: dayTypeColors[displayData.day_type] || '#888',
              fontWeight: 700,
              fontSize: 14
            }}>
              {displayData.day_type_name || 'Developing'}
            </div>
            <div style={{ color: '#8b8b8b', fontSize: 12 }}>
              {displayData.day_type_confidence || 0}%
            </div>
          </div>

          {/* Day Type Scores */}
          {displayData.day_type_scores && Object.entries(displayData.day_type_scores).map(([type, score]) => (
            <div key={type} style={{ marginBottom: 6 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 11, marginBottom: 2 }}>
                <span style={{ color: '#aaa', textTransform: 'capitalize' }}>{type.replace('_', ' ')}</span>
                <span style={{ color: dayTypeColors[type] || '#888' }}>{score}%</span>
              </div>
              <div style={{ height: 4, background: 'rgba(255,255,255,0.1)', borderRadius: 2 }}>
                <div style={{
                  height: '100%',
                  width: `${Math.min(score, 100)}%`,
                  background: dayTypeColors[type] || '#888',
                  borderRadius: 2
                }} />
              </div>
            </div>
          ))}

          {/* Trade Setup */}
          {displayData.trade_setup && (
            <div style={{
              marginTop: 12,
              padding: 10,
              background: 'rgba(0,255,136,0.08)',
              borderRadius: 6,
              border: '1px solid rgba(0,255,136,0.2)'
            }}>
              <div style={{ fontSize: 10, color: '#00ff88', marginBottom: 4 }}>TRADE SETUP</div>
              <div style={{ fontSize: 12, color: '#ccc' }}>{displayData.trade_setup}</div>
            </div>
          )}
        </div>

        {/* Open Type Classification */}
        <div style={{
          background: 'rgba(20,20,28,0.9)',
          borderRadius: 12,
          border: '1px solid rgba(255,255,255,0.08)',
          padding: 16
        }}>
          <div style={{ fontSize: 12, color: '#8b8b8b', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 1 }}>
            Open Type (RTH)
          </div>

          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: 12,
            marginBottom: 12
          }}>
            <div style={{
              padding: '8px 16px',
              background: `${openTypeColors[displayData.open_type] || '#888'}20`,
              border: `1px solid ${openTypeColors[displayData.open_type] || '#888'}`,
              borderRadius: 8,
              color: openTypeColors[displayData.open_type] || '#888',
              fontWeight: 700,
              fontSize: 14
            }}>
              {displayData.open_type_info?.name || 'Developing'}
            </div>
          </div>

          {displayData.open_type_info && (
            <>
              <div style={{ fontSize: 12, color: '#aaa', marginBottom: 8 }}>
                {displayData.open_type_info.description}
              </div>
              <div style={{ display: 'flex', gap: 16, fontSize: 11 }}>
                <div>
                  <span style={{ color: '#8b8b8b' }}>Conviction: </span>
                  <span style={{ color: openTypeColors[displayData.open_type] || '#888', fontWeight: 600 }}>
                    {displayData.open_type_info?.conviction || 'N/A'}
                  </span>
                </div>
                {data?.open_direction && (
                  <div>
                    <span style={{ color: '#8b8b8b' }}>Direction: </span>
                    <span style={{ color: data?.open_direction === 'up' ? '#00ff88' : '#ff4466', fontWeight: 600 }}>
                      {data?.open_direction?.toUpperCase()}
                    </span>
                  </div>
                )}
              </div>
            </>
          )}

          {/* AB Overlap - only show when data exists */}
          {data?.ab_overlap !== undefined && (
            <div style={{ marginTop: 12, fontSize: 11 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                <span style={{ color: '#8b8b8b' }}>AB Overlap</span>
                <span style={{ color: data?.ab_overlap > 50 ? '#ffaa00' : '#00ff88' }}>{data?.ab_overlap}%</span>
              </div>
              <div style={{ height: 4, background: 'rgba(255,255,255,0.1)', borderRadius: 2 }}>
                <div style={{
                  height: '100%',
                  width: `${Math.min(data?.ab_overlap || 0, 100)}%`,
                  background: data?.ab_overlap > 50 ? '#ffaa00' : '#00ff88',
                  borderRadius: 2
                }} />
              </div>
            </div>
          )}
        </div>

        {/* Profile Shape */}
        <div style={{
          background: 'rgba(20,20,28,0.9)',
          borderRadius: 12,
          border: '1px solid rgba(255,255,255,0.08)',
          padding: 16
        }}>
          <div style={{ fontSize: 12, color: '#8b8b8b', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 1 }}>
            Profile Shape
          </div>

          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: 12,
            marginBottom: 8
          }}>
            <div style={{
              width: 48,
              height: 48,
              background: 'rgba(255,255,255,0.05)',
              borderRadius: 8,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: 28,
              fontWeight: 800,
              color: displayData.profile_shape_info?.sentiment === 'Bullish' ? '#00ff88' :
                     displayData.profile_shape_info?.sentiment === 'Bearish' ? '#ff4466' : '#888'
            }}>
              {shapeIcons[displayData.profile_shape] || '‚óØ'}
            </div>
            <div>
              <div style={{
                fontSize: 14,
                fontWeight: 600,
                color: displayData.profile_shape_info?.sentiment === 'Bullish' ? '#00ff88' :
                       displayData.profile_shape_info?.sentiment === 'Bearish' ? '#ff4466' : '#aaa'
              }}>
                {displayData.profile_shape_info?.name || 'Developing'}
              </div>
              <div style={{ fontSize: 11, color: '#8b8b8b' }}>
                {displayData.profile_shape_info?.sentiment || 'N/A'}
              </div>
            </div>
          </div>

          {displayData.profile_shape_info?.description && (
            <div style={{ fontSize: 11, color: '#888', lineHeight: 1.4 }}>
              {displayData.profile_shape_info.description}
            </div>
          )}
        </div>

        {/* Metrics */}
        <div style={{
          background: 'rgba(20,20,28,0.9)',
          borderRadius: 12,
          border: '1px solid rgba(255,255,255,0.08)',
          padding: 16
        }}>
          <div style={{ fontSize: 12, color: '#8b8b8b', marginBottom: 12, textTransform: 'uppercase', letterSpacing: 1 }}>
            Metrics
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 16 }}>
            <div>
              <div style={{ fontSize: 10, color: '#8b8b8b' }}>IB Range %</div>
              <div style={{ fontSize: 16, fontWeight: 700, color: '#fff' }}>
                {data?.ib_range ? ((data.ib_range / data.avg_daily_range) * 100).toFixed(0) : '--'}%
              </div>
            </div>
            <div>
              <div style={{ fontSize: 10, color: '#8b8b8b' }}>Range Ext %</div>
              <div style={{ fontSize: 16, fontWeight: 700, color: '#fff' }}>
                {data?.range_extension_pct?.toFixed(0) || '--'}%
              </div>
            </div>
          </div>

          {/* Price Prediction */}
          {data?.ib_high && data?.ib_low && data?.ib_range && (() => {
            // Calculate expected range extension based on day type and IB range
            // Typical extensions: Normal 1x IB, Normal Var 1.5x, Trend 2x+
            const ibRange = data.ib_range;
            const dayType = displayData.day_type || 'normal';
            const extMultiplier = dayType === 'trend' ? 2.0 : dayType === 'normal_var' ? 1.5 : dayType === 'neutral' ? 0.5 : 1.0;
            const expectedExt = ibRange * extMultiplier;

            // Current extension
            const currentHigh = data.high || data.ib_high;
            const currentLow = data.low || data.ib_low;
            const extUp = Math.max(0, currentHigh - data.ib_high);
            const extDown = Math.max(0, data.ib_low - currentLow);

            // Remaining potential extension
            const remainingUp = Math.max(0, expectedExt - extUp);
            const remainingDown = Math.max(0, expectedExt - extDown);

            // Target prices
            const targetHigh = data.ib_high + expectedExt;
            const targetLow = data.ib_low - expectedExt;

            return (
              <>
                <div style={{ height: 1, background: 'rgba(255,255,255,0.1)', marginBottom: 12 }} />
                <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 8, textTransform: 'uppercase', letterSpacing: 1 }}>
                  Price Targets
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                  <div style={{ background: 'rgba(0,255,136,0.1)', borderRadius: 6, padding: 8 }}>
                    <div style={{ fontSize: 9, color: '#00ff88', marginBottom: 2 }}>Upside Target</div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: '#00ff88' }}>${targetHigh.toFixed(1)}</div>
                    <div style={{ fontSize: 9, color: '#888' }}>+{remainingUp.toFixed(1)} pts remaining</div>
                  </div>
                  <div style={{ background: 'rgba(255,68,102,0.1)', borderRadius: 6, padding: 8 }}>
                    <div style={{ fontSize: 9, color: '#ff4466', marginBottom: 2 }}>Downside Target</div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: '#ff4466' }}>${targetLow.toFixed(1)}</div>
                    <div style={{ fontSize: 9, color: '#888' }}>-{remainingDown.toFixed(1)} pts remaining</div>
                  </div>
                </div>
                <div style={{ fontSize: 9, color: '#666', marginTop: 8, textAlign: 'center' }}>
                  Based on {extMultiplier}x IB ({dayType.replace('_', ' ')})
                </div>
              </>
            );
          })()}
        </div>
      </div>}

      {/* Historic TPO Section - Full Width Below Main Grid */}
      <div style={{ gridColumn: '1 / -1', marginTop: 20 }}>
        <div style={{
          background: 'rgba(20,20,28,0.9)',
          borderRadius: 12,
          border: '1px solid rgba(255,255,255,0.08)',
          overflow: 'hidden'
        }}>
          {/* Header with Toggle */}
          <button
            onClick={() => setShowHistoric(!showHistoric)}
            style={{
              width: '100%',
              padding: '16px 20px',
              background: 'transparent',
              border: 'none',
              borderBottom: showHistoric ? '1px solid rgba(255,255,255,0.08)' : 'none',
              color: '#fff',
              fontSize: 14,
              fontWeight: 600,
              cursor: 'pointer',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}
          >
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <span style={{ fontSize: 18 }}>üìÖ</span>
              <span>Historic TPO Profiles (Last 8 Weeks)</span>
              {historicData && (
                <span style={{ fontSize: 11, color: '#8b8b8b', fontWeight: 400 }}>
                  {historicData.days} trading days
                </span>
              )}
            </div>
            <span style={{ fontSize: 18, transform: showHistoric ? 'rotate(180deg)' : 'rotate(0)', transition: 'transform 0.2s' }}>
              ‚ñº
            </span>
          </button>

          {/* Historic Data Section */}
          {showHistoric && (
            <div style={{ padding: 20 }}>
              {loadingHistoric ? (
                <div style={{ textAlign: 'center', color: '#8b8b8b', padding: 40 }}>
                  <div style={{ fontSize: 24, marginBottom: 8 }}>‚è≥</div>
                  Loading historic TPO data...
                </div>
              ) : historicData?.profiles?.length > 0 ? (
                <div>
                  {/* Table Header with Toggle and Export */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    marginBottom: 12,
                    padding: '8px 12px',
                    background: 'rgba(30,30,40,0.6)',
                    borderRadius: 8
                  }}>
                    <button
                      onClick={() => setShowHistoricTable(!showHistoricTable)}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 8,
                        background: 'transparent',
                        border: 'none',
                        color: '#aaa',
                        cursor: 'pointer',
                        fontSize: 12,
                        fontWeight: 500
                      }}
                    >
                      <span style={{
                        display: 'inline-flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        width: 20,
                        height: 20,
                        borderRadius: 4,
                        background: showHistoricTable ? 'rgba(0,255,136,0.2)' : 'rgba(255,255,255,0.1)',
                        color: showHistoricTable ? '#00ff88' : '#888',
                        fontSize: 12,
                        fontWeight: 700
                      }}>
                        {showHistoricTable ? '‚àí' : '+'}
                      </span>
                      <span style={{ color: showHistoricTable ? '#fff' : '#888' }}>
                        {showHistoricTable ? 'Hide' : 'Show'} Data Table
                      </span>
                      <span style={{ fontSize: 10, color: '#666' }}>
                        ({historicData.profiles.length} rows)
                      </span>
                    </button>

                    <button
                      onClick={() => {
                        // Export to CSV
                        const headers = ['Date', 'Day', 'Open', 'High', 'Low', 'Close', 'POC', 'VAH', 'VAL', 'IB_High', 'IB_Low', 'IB_Range', 'Range', 'Day_Type', 'Shape'];
                        const rows = historicData.profiles.map(p => [
                          p.date,
                          p.weekday,
                          p.open?.toFixed(2) || '',
                          p.high?.toFixed(2) || '',
                          p.low?.toFixed(2) || '',
                          p.close?.toFixed(2) || '',
                          p.poc?.toFixed(2) || '',
                          p.vah?.toFixed(2) || '',
                          p.val?.toFixed(2) || '',
                          p.ib_high?.toFixed(2) || '',
                          p.ib_low?.toFixed(2) || '',
                          p.ib_range?.toFixed(2) || '',
                          p.range?.toFixed(2) || '',
                          p.day_type || '',
                          p.profile_shape || ''
                        ].join(','));
                        const csv = [headers.join(','), ...rows].join('\n');
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `tpo_historic_${new Date().toISOString().slice(0,10)}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                      }}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 6,
                        padding: '6px 12px',
                        background: 'rgba(0,170,255,0.15)',
                        border: '1px solid rgba(0,170,255,0.3)',
                        borderRadius: 6,
                        color: '#00aaff',
                        cursor: 'pointer',
                        fontSize: 11,
                        fontWeight: 600
                      }}
                    >
                      <span>üì•</span> Export CSV
                    </button>
                  </div>

                  {/* Collapsible Data Table */}
                  {showHistoricTable && (
                    <div style={{ overflowX: 'auto', marginBottom: 20 }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                        <thead>
                          <tr style={{ borderBottom: '2px solid rgba(255,255,255,0.15)' }}>
                            <th style={{ padding: '10px 8px', textAlign: 'left', color: '#8b8b8b', fontWeight: 500 }}>Date</th>
                            <th style={{ padding: '10px 8px', textAlign: 'center', color: '#8b8b8b', fontWeight: 500 }}>Day</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#ffaa00', fontWeight: 600 }}>POC</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#00aaff', fontWeight: 600 }}>VAH</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#00aaff', fontWeight: 600 }}>VAL</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#9370DB', fontWeight: 600 }}>IB H</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#9370DB', fontWeight: 600 }}>IB L</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#fff' }}>High</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#fff' }}>Low</th>
                            <th style={{ padding: '10px 8px', textAlign: 'right', color: '#8b8b8b' }}>Range</th>
                            <th style={{ padding: '10px 8px', textAlign: 'center', color: '#8b8b8b' }}>Type</th>
                            <th style={{ padding: '10px 8px', textAlign: 'center', color: '#8b8b8b' }}>Shape</th>
                          </tr>
                        </thead>
                    <tbody>
                      {historicData.profiles.map((profile, idx) => {
                        const dayTypeColors = {
                          'normal': '#00aaff',
                          'trend': '#ff6600',
                          'normal_var': '#00ff88',
                          'neutral': '#9370DB',
                          'non_trend': '#888888',
                          'double_dist': '#ff4466'
                        };
                        const dayTypeNames = {
                          'normal': 'Normal',
                          'trend': 'Trend',
                          'normal_var': 'NV',
                          'neutral': 'Neutral',
                          'non_trend': 'Non-Tr',
                          'double_dist': 'DD'
                        };
                        const shapeColors = {
                          'D': '#00aaff',
                          'P': '#00ff88',
                          'b': '#ff6600',
                          'B': '#ff4466'
                        };
                        return (
                          <tr
                            key={profile.date}
                            style={{
                              borderBottom: '1px solid rgba(255,255,255,0.06)',
                              background: idx === 0 ? 'rgba(0,255,136,0.05)' : 'transparent'
                            }}
                          >
                            <td style={{ padding: '10px 8px', color: '#fff', fontFamily: 'monospace' }}>
                              {profile.date}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'center', color: '#8b8b8b' }}>
                              {profile.weekday}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#ffaa00', fontFamily: 'monospace', fontWeight: 600 }}>
                              {profile.poc?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#00aaff', fontFamily: 'monospace' }}>
                              {profile.vah?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#00aaff', fontFamily: 'monospace' }}>
                              {profile.val?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#9370DB', fontFamily: 'monospace' }}>
                              {profile.ib_high?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#9370DB', fontFamily: 'monospace' }}>
                              {profile.ib_low?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#fff', fontFamily: 'monospace' }}>
                              {profile.high?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#fff', fontFamily: 'monospace' }}>
                              {profile.low?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'right', color: '#8b8b8b', fontFamily: 'monospace' }}>
                              ${profile.range?.toFixed(2) || '--'}
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                              <span style={{
                                padding: '2px 6px',
                                borderRadius: 4,
                                fontSize: 10,
                                fontWeight: 600,
                                background: `${dayTypeColors[profile.day_type] || '#888'}30`,
                                color: dayTypeColors[profile.day_type] || '#888',
                                border: `1px solid ${dayTypeColors[profile.day_type] || '#888'}50`
                              }}>
                                {dayTypeNames[profile.day_type] || profile.day_type}
                              </span>
                            </td>
                            <td style={{ padding: '10px 8px', textAlign: 'center' }}>
                              <span style={{
                                display: 'inline-block',
                                width: 22,
                                height: 22,
                                lineHeight: '22px',
                                textAlign: 'center',
                                borderRadius: 4,
                                fontSize: 12,
                                fontWeight: 700,
                                background: `${shapeColors[profile.profile_shape] || '#888'}20`,
                                color: shapeColors[profile.profile_shape] || '#888',
                                border: `1px solid ${shapeColors[profile.profile_shape] || '#888'}50`
                              }}>
                                {profile.profile_shape}
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                  </div>
                  )}

                  {/* Summary Stats */}
                  {(() => {
                    const profiles = historicData.profiles;
                    const avgPoc = profiles.reduce((sum, p) => sum + (p.poc || 0), 0) / profiles.length || 0;
                    const avgRange = profiles.reduce((sum, p) => sum + (p.range || 0), 0) / profiles.length || 0;
                    const ibProfiles = profiles.filter(p => p.ib_range);
                    const avgIbRange = ibProfiles.reduce((sum, p) => sum + p.ib_range, 0) / ibProfiles.length || 0;
                    const avgIbPct = avgRange > 0 ? (avgIbRange / avgRange) * 100 : 0;

                    return (
                      <div style={{
                        marginTop: 20,
                        padding: 16,
                        background: 'rgba(30,30,40,0.6)',
                        borderRadius: 8,
                        display: 'grid',
                        gridTemplateColumns: 'repeat(7, 1fr)',
                        gap: 16
                      }}>
                        <div>
                          <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>Avg POC</div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#ffaa00', fontFamily: 'monospace' }}>
                            ${avgPoc.toFixed(2)}
                          </div>
                        </div>
                        <div>
                          <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>Avg Range</div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#fff', fontFamily: 'monospace' }}>
                            ${avgRange.toFixed(2)}
                          </div>
                        </div>
                        <div>
                          <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>Avg IB Range</div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#9370DB', fontFamily: 'monospace' }}>
                            ${avgIbRange.toFixed(2)}
                          </div>
                        </div>
                        <div>
                          <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>Avg IB %</div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#00aaff', fontFamily: 'monospace' }}>
                            {avgIbPct.toFixed(1)}%
                          </div>
                        </div>
                        <div>
                          <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>Trend Days</div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#ff6600' }}>
                            {profiles.filter(p => p.day_type === 'trend').length}
                          </div>
                        </div>
                        <div>
                          <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>Normal Var</div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#00ff88' }}>
                            {profiles.filter(p => p.day_type === 'normal_var').length}
                          </div>
                        </div>
                        <div>
                          <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>Non-Trend</div>
                          <div style={{ fontSize: 14, fontWeight: 600, color: '#888' }}>
                            {profiles.filter(p => p.day_type === 'non_trend').length}
                          </div>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Day of Week Analysis Visualization */}
                  {(() => {
                    const profiles = historicData.profiles;
                    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                    const dayTypeColors = {
                      'normal': '#00aaff',
                      'non_trend': '#888888',
                      'normal_var': '#00ff88',
                      'trend': '#ff6600',
                      'double_dist': '#ff4466',
                      'neutral': '#9370DB'
                    };
                    const shapeColors = { 'D': '#00aaff', 'P': '#00ff88', 'b': '#ff6600', 'B': '#ff4466' };

                    // Group by day of week
                    const byDayOfWeek = {};
                    days.forEach(d => byDayOfWeek[d] = []);
                    profiles.forEach(p => {
                      if (byDayOfWeek[p.weekday]) {
                        byDayOfWeek[p.weekday].push(p);
                      }
                    });

                    // Calculate stats for each day
                    const dayStats = days.map(day => {
                      const dayProfiles = byDayOfWeek[day];
                      if (dayProfiles.length === 0) return { day, count: 0 };

                      const typeCounts = {};
                      const shapeCounts = {};
                      dayProfiles.forEach(p => {
                        typeCounts[p.day_type] = (typeCounts[p.day_type] || 0) + 1;
                        shapeCounts[p.profile_shape] = (shapeCounts[p.profile_shape] || 0) + 1;
                      });

                      const mostCommonType = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0];
                      const mostCommonShape = Object.entries(shapeCounts).sort((a, b) => b[1] - a[1])[0];
                      const avgRange = dayProfiles.reduce((s, p) => s + (p.range || 0), 0) / dayProfiles.length;
                      const avgIbRange = dayProfiles.filter(p => p.ib_range).reduce((s, p) => s + p.ib_range, 0) / dayProfiles.filter(p => p.ib_range).length || 0;
                      const ibPct = avgRange > 0 ? (avgIbRange / avgRange) * 100 : 0;

                      return {
                        day,
                        count: dayProfiles.length,
                        profiles: dayProfiles,
                        mostCommonType: mostCommonType ? mostCommonType[0] : 'N/A',
                        typePercent: mostCommonType ? Math.round((mostCommonType[1] / dayProfiles.length) * 100) : 0,
                        mostCommonShape: mostCommonShape ? mostCommonShape[0] : 'N/A',
                        shapePercent: mostCommonShape ? Math.round((mostCommonShape[1] / dayProfiles.length) * 100) : 0,
                        avgRange: avgRange.toFixed(2),
                        avgIbRange: avgIbRange.toFixed(2),
                        ibPct: ibPct.toFixed(1),
                        typeCounts,
                        shapeCounts
                      };
                    });

                    return (
                      <div style={{ marginTop: 24 }}>
                        <div style={{ fontSize: 14, fontWeight: 600, marginBottom: 16, color: '#fff', display: 'flex', alignItems: 'center', gap: 8 }}>
                          <span>üìä</span> Day of Week Analysis
                        </div>

                        {/* Day Cards Row */}
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 12, marginBottom: 20 }}>
                          {dayStats.map(stat => (
                            <div
                              key={stat.day}
                              style={{
                                background: 'rgba(30,30,40,0.8)',
                                borderRadius: 8,
                                padding: 12,
                                border: '1px solid rgba(255,255,255,0.1)',
                                transition: 'all 0.2s'
                              }}
                            >
                              <div style={{ fontSize: 16, fontWeight: 700, color: '#fff', marginBottom: 8 }}>{stat.day}</div>
                              <div style={{ fontSize: 10, color: '#8b8b8b', marginBottom: 4 }}>{stat.count} samples</div>

                              {stat.count > 0 && (
                                <>
                                  <div style={{ marginTop: 8, marginBottom: 6 }}>
                                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>Most Common Type</div>
                                    <div style={{
                                      display: 'inline-block',
                                      padding: '2px 8px',
                                      borderRadius: 4,
                                      background: `${dayTypeColors[stat.mostCommonType] || '#666'}22`,
                                      border: `1px solid ${dayTypeColors[stat.mostCommonType] || '#666'}`,
                                      color: dayTypeColors[stat.mostCommonType] || '#666',
                                      fontSize: 10,
                                      fontWeight: 600
                                    }}>
                                      {stat.mostCommonType === 'normal_var' ? 'N-Var' :
                                       stat.mostCommonType === 'double_dist' ? 'Dbl-D' :
                                       stat.mostCommonType === 'non_trend' ? 'Non-T' :
                                       stat.mostCommonType.charAt(0).toUpperCase() + stat.mostCommonType.slice(1)}
                                      <span style={{ marginLeft: 4, opacity: 0.7 }}>{stat.typePercent}%</span>
                                    </div>
                                  </div>

                                  <div style={{ marginBottom: 6 }}>
                                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>Shape</div>
                                    <div style={{
                                      display: 'inline-flex',
                                      alignItems: 'center',
                                      gap: 4,
                                      padding: '2px 8px',
                                      borderRadius: 4,
                                      background: `${shapeColors[stat.mostCommonShape] || '#666'}22`,
                                      border: `1px solid ${shapeColors[stat.mostCommonShape] || '#666'}44`,
                                      color: shapeColors[stat.mostCommonShape] || '#888',
                                      fontSize: 11,
                                      fontWeight: 700
                                    }}>
                                      {stat.mostCommonShape}
                                      <span style={{ fontSize: 9, fontWeight: 400, opacity: 0.7 }}>{stat.shapePercent}%</span>
                                    </div>
                                  </div>

                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 4, marginTop: 8 }}>
                                    <div>
                                      <div style={{ fontSize: 8, color: '#666' }}>Avg Range</div>
                                      <div style={{ fontSize: 11, color: '#fff', fontFamily: 'monospace' }}>${stat.avgRange}</div>
                                    </div>
                                    <div>
                                      <div style={{ fontSize: 8, color: '#666' }}>IB %</div>
                                      <div style={{ fontSize: 11, color: '#00aaff', fontFamily: 'monospace' }}>{stat.ibPct}%</div>
                                    </div>
                                  </div>
                                </>
                              )}
                            </div>
                          ))}
                        </div>

                        {/* Calendar Heatmap Style Grid */}
                        <div style={{
                          background: 'linear-gradient(135deg, rgba(20,20,35,0.9) 0%, rgba(30,25,45,0.9) 100%)',
                          borderRadius: 12,
                          padding: 20,
                          border: '1px solid rgba(255,255,255,0.08)',
                          boxShadow: '0 4px 24px rgba(0,0,0,0.3)'
                        }}>
                          <div style={{
                            fontSize: 12,
                            color: '#aaa',
                            marginBottom: 16,
                            display: 'flex',
                            alignItems: 'center',
                            gap: 8
                          }}>
                            <span style={{ fontSize: 16 }}>üìÖ</span>
                            Trading Day Heatmap
                            <span style={{ fontSize: 10, color: '#666', marginLeft: 'auto' }}>Most recent at top</span>
                          </div>

                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 20 }}>
                            {dayStats.map(stat => (
                              <div key={stat.day}>
                                <div style={{
                                  fontSize: 13,
                                  color: '#fff',
                                  marginBottom: 10,
                                  textAlign: 'center',
                                  fontWeight: 600,
                                  padding: '6px 0',
                                  background: 'rgba(255,255,255,0.05)',
                                  borderRadius: 6
                                }}>{stat.day}</div>
                                <div style={{
                                  display: 'grid',
                                  gridTemplateColumns: 'repeat(3, 1fr)',
                                  gap: 3,
                                  minHeight: 90
                                }}>
                                  {stat.profiles.slice(0, 12).map((p, idx) => {
                                    const vaRange = p.vah && p.val ? p.vah - p.val : 0;
                                    const vaPct = p.range > 0 ? (vaRange / p.range) * 100 : 0;
                                    const ibPct = p.range > 0 && p.ib_range ? (p.ib_range / p.range) * 100 : 0;
                                    const baseColor = dayTypeColors[p.day_type] || '#666';

                                    return (
                                      <div
                                        key={idx}
                                        style={{
                                          aspectRatio: '1',
                                          borderRadius: 4,
                                          background: `linear-gradient(135deg, ${baseColor} 0%, ${baseColor}99 100%)`,
                                          cursor: 'pointer',
                                          position: 'relative',
                                          display: 'flex',
                                          alignItems: 'center',
                                          justifyContent: 'center',
                                          boxShadow: `0 2px 8px ${baseColor}33`,
                                          transition: 'all 0.2s ease',
                                          border: `1px solid ${baseColor}44`
                                        }}
                                        onMouseEnter={(e) => {
                                          e.currentTarget.style.transform = 'scale(1.1)';
                                          e.currentTarget.style.boxShadow = `0 4px 20px ${baseColor}66`;
                                          e.currentTarget.style.zIndex = '10';
                                        }}
                                        onMouseMove={(e) => {
                                          setHoveredProfile({
                                            ...p,
                                            vaRange,
                                            vaPct,
                                            ibPct,
                                            baseColor,
                                            x: e.clientX,
                                            y: e.clientY
                                          });
                                        }}
                                        onMouseLeave={(e) => {
                                          e.currentTarget.style.transform = 'scale(1)';
                                          e.currentTarget.style.boxShadow = `0 2px 8px ${baseColor}33`;
                                          e.currentTarget.style.zIndex = '1';
                                          setHoveredProfile(null);
                                        }}
                                      >
                                        <span style={{
                                          fontSize: 9,
                                          fontWeight: 700,
                                          color: '#fff',
                                          textShadow: '0 1px 2px rgba(0,0,0,0.5)'
                                        }}>
                                          {p.profile_shape}
                                        </span>
                                        <span style={{
                                          position: 'absolute',
                                          bottom: 1,
                                          right: 2,
                                          fontSize: 7,
                                          color: 'rgba(255,255,255,0.6)'
                                        }}>
                                          {p.date?.slice(8)}
                                        </span>
                                      </div>
                                    );
                                  })}
                                </div>
                                {stat.count > 12 && (
                                  <div style={{ fontSize: 8, color: '#666', textAlign: 'center', marginTop: 4 }}>
                                    +{stat.count - 12} more
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>

                          {/* Legend */}
                          <div style={{
                            display: 'flex',
                            gap: 20,
                            marginTop: 20,
                            paddingTop: 16,
                            borderTop: '1px solid rgba(255,255,255,0.08)',
                            flexWrap: 'wrap',
                            justifyContent: 'center'
                          }}>
                            {Object.entries(dayTypeColors).map(([type, color]) => (
                              <div key={type} style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: 6,
                                padding: '4px 10px',
                                background: `${color}15`,
                                borderRadius: 20,
                                border: `1px solid ${color}33`
                              }}>
                                <div style={{
                                  width: 10,
                                  height: 10,
                                  borderRadius: '50%',
                                  background: `linear-gradient(135deg, ${color} 0%, ${color}aa 100%)`,
                                  boxShadow: `0 0 6px ${color}66`
                                }} />
                                <span style={{ fontSize: 10, color: '#bbb', fontWeight: 500 }}>
                                  {type === 'normal_var' ? 'Normal Var' :
                                   type === 'double_dist' ? 'Double Dist' :
                                   type === 'non_trend' ? 'Non-Trend' :
                                   type.charAt(0).toUpperCase() + type.slice(1)}
                                </span>
                              </div>
                            ))}
                          </div>

                          {/* Custom Beautiful Tooltip */}
                          {hoveredProfile && (() => {
                            const isBullish = hoveredProfile.close > hoveredProfile.open;
                            const candleColor = isBullish ? '#00ff88' : '#ff4466';
                            return (
                            <div style={{
                              position: 'fixed',
                              left: hoveredProfile.x + 15,
                              top: hoveredProfile.y + 15,
                              transform: hoveredProfile.x > window.innerWidth - 320 ? 'translateX(-100%)' : 'none',
                              background: 'linear-gradient(135deg, rgba(20,20,35,0.98) 0%, rgba(35,30,50,0.98) 100%)',
                              borderRadius: 12,
                              padding: 0,
                              minWidth: 260,
                              boxShadow: `0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px ${hoveredProfile.baseColor}44, 0 0 20px ${hoveredProfile.baseColor}22`,
                              zIndex: 9999,
                              pointerEvents: 'none',
                              overflow: 'hidden'
                            }}>
                              {/* Header */}
                              <div style={{
                                background: `linear-gradient(135deg, ${hoveredProfile.baseColor}33 0%, ${hoveredProfile.baseColor}11 100%)`,
                                borderBottom: `1px solid ${hoveredProfile.baseColor}44`,
                                padding: '10px 14px'
                              }}>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 8 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    <span style={{ fontSize: 16 }}>üìÖ</span>
                                    <div>
                                      <div style={{ fontSize: 13, fontWeight: 700, color: '#fff' }}>{hoveredProfile.date}</div>
                                      <div style={{ fontSize: 10, color: '#888' }}>{hoveredProfile.weekday}</div>
                                    </div>
                                  </div>
                                  <span style={{
                                    width: 26,
                                    height: 26,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    borderRadius: 6,
                                    fontSize: 13,
                                    fontWeight: 800,
                                    background: 'rgba(255,255,255,0.1)',
                                    color: '#fff'
                                  }}>{hoveredProfile.profile_shape}</span>
                                </div>
                                {/* Badges row */}
                                <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap' }}>
                                  <span style={{
                                    padding: '3px 8px',
                                    borderRadius: 4,
                                    fontSize: 9,
                                    fontWeight: 700,
                                    background: `${hoveredProfile.baseColor}33`,
                                    color: hoveredProfile.baseColor,
                                    border: `1px solid ${hoveredProfile.baseColor}55`,
                                    textTransform: 'uppercase'
                                  }}>{hoveredProfile.day_type?.replace('_', ' ')}</span>
                                  {hoveredProfile.open_type && hoveredProfile.open_type !== 'developing' && (
                                    <span style={{
                                      padding: '3px 8px',
                                      borderRadius: 4,
                                      fontSize: 9,
                                      fontWeight: 700,
                                      background: 'rgba(255,170,0,0.2)',
                                      color: '#ffaa00',
                                      border: '1px solid rgba(255,170,0,0.4)',
                                      textTransform: 'uppercase'
                                    }}>{hoveredProfile.open_type}</span>
                                  )}
                                </div>
                              </div>

                              {/* OHLC Section - Correlation matrix style */}
                              <div style={{
                                margin: '10px 14px',
                                padding: '10px 12px',
                                borderRadius: 8,
                                background: `${candleColor}15`,
                                border: `1px solid ${candleColor}30`
                              }}>
                                <div style={{
                                  fontSize: 10,
                                  color: candleColor,
                                  marginBottom: 8,
                                  fontWeight: 600,
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: 6
                                }}>
                                  <span>{isBullish ? '‚ñ≤' : '‚ñº'}</span>
                                  PRICE ACTION
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 }}>
                                  {[
                                    { label: 'O', value: hoveredProfile.open, color: '#fff' },
                                    { label: 'H', value: hoveredProfile.high, color: isBullish ? '#00ff88' : '#fff' },
                                    { label: 'L', value: hoveredProfile.low, color: !isBullish ? '#ff4466' : '#fff' },
                                    { label: 'C', value: hoveredProfile.close, color: '#fff' }
                                  ].map(item => (
                                    <div key={item.label} style={{ textAlign: 'center' }}>
                                      <div style={{ fontSize: 7, color: '#888', marginBottom: 2 }}>{item.label}</div>
                                      <div style={{ fontSize: 10, fontWeight: 600, color: item.color, fontFamily: 'monospace' }}>
                                        ${item.value?.toFixed(2)}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {/* Day Range with H/L on sides */}
                              <div style={{ padding: '0 14px 10px 14px' }}>
                                <div style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  marginBottom: 10
                                }}>
                                  <div style={{ textAlign: 'left' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>HIGH</div>
                                    <div style={{ fontSize: 11, fontWeight: 600, color: '#00ff88', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.high?.toFixed(2)}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>DAY RANGE</div>
                                    <div style={{ fontSize: 14, fontWeight: 700, color: '#fff', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.range?.toFixed(2)}
                                    </div>
                                    <div style={{ fontSize: 8, color: '#666', marginTop: 2 }}>100%</div>
                                  </div>
                                  <div style={{ textAlign: 'right' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>LOW</div>
                                    <div style={{ fontSize: 11, fontWeight: 600, color: '#ff4466', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.low?.toFixed(2)}
                                    </div>
                                  </div>
                                </div>

                                {/* IB Range - same format as Day Range */}
                                <div style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  marginBottom: 10,
                                  paddingTop: 6,
                                  borderTop: '1px solid rgba(255,255,255,0.06)'
                                }}>
                                  <div style={{ textAlign: 'left' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>IB HIGH</div>
                                    <div style={{ fontSize: 10, fontWeight: 600, color: '#9370DB', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.ib_high?.toFixed(2) || 'N/A'}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>IB RANGE</div>
                                    <div style={{ fontSize: 13, fontWeight: 700, color: '#9370DB', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.ib_range?.toFixed(2) || 'N/A'}
                                    </div>
                                    <div style={{ fontSize: 8, color: '#666', marginTop: 2 }}>{hoveredProfile.ibPct?.toFixed(0)}%</div>
                                  </div>
                                  <div style={{ textAlign: 'right' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>IB LOW</div>
                                    <div style={{ fontSize: 10, fontWeight: 600, color: '#9370DB', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.ib_low?.toFixed(2) || 'N/A'}
                                    </div>
                                  </div>
                                </div>

                                {/* VA Range - same format as Day Range */}
                                <div style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'space-between',
                                  paddingTop: 6,
                                  borderTop: '1px solid rgba(255,255,255,0.06)'
                                }}>
                                  <div style={{ textAlign: 'left' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>VAH</div>
                                    <div style={{ fontSize: 10, fontWeight: 600, color: '#00aaff', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.vah?.toFixed(2)}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>VA RANGE</div>
                                    <div style={{ fontSize: 13, fontWeight: 700, color: '#00aaff', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.vaRange?.toFixed(2)}
                                    </div>
                                    <div style={{ fontSize: 8, color: '#666', marginTop: 2 }}>{hoveredProfile.vaPct?.toFixed(0)}%</div>
                                  </div>
                                  <div style={{ textAlign: 'right' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>VAL</div>
                                    <div style={{ fontSize: 10, fontWeight: 600, color: '#00aaff', fontFamily: 'monospace' }}>
                                      ${hoveredProfile.val?.toFixed(2)}
                                    </div>
                                  </div>
                                </div>
                              </div>

                            </div>
                            );
                          })()}
                        </div>

                        {/* Donut Charts for Day Type Distribution */}
                        <div style={{
                          marginTop: 20,
                          background: 'linear-gradient(135deg, rgba(20,20,35,0.9) 0%, rgba(30,25,45,0.9) 100%)',
                          borderRadius: 12,
                          padding: 20,
                          border: '1px solid rgba(255,255,255,0.08)'
                        }}>
                          <div style={{
                            fontSize: 12,
                            color: '#aaa',
                            marginBottom: 16,
                            display: 'flex',
                            alignItems: 'center',
                            gap: 8
                          }}>
                            <span style={{ fontSize: 16 }}>üéØ</span>
                            Day Type Distribution by Weekday
                          </div>
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 16 }}>
                            {dayStats.map(stat => {
                              const total = stat.count;
                              let cumulativePercent = 0;
                              const segments = Object.entries(stat.typeCounts || {})
                                .sort((a, b) => b[1] - a[1])
                                .map(([type, count]) => {
                                  const percent = total > 0 ? (count / total) * 100 : 0;
                                  const startPercent = cumulativePercent;
                                  cumulativePercent += percent;
                                  return { type, count, percent, startPercent };
                                });

                              return (
                                <div key={stat.day} style={{ textAlign: 'center', position: 'relative' }}>
                                  <div style={{
                                    fontSize: 11,
                                    color: '#888',
                                    marginBottom: 8,
                                    fontWeight: 600
                                  }}>{stat.day}</div>

                                  {/* CSS Donut Chart */}
                                  <div
                                    style={{
                                      width: 70,
                                      height: 70,
                                      borderRadius: '50%',
                                      margin: '0 auto',
                                      background: total > 0 ? `conic-gradient(${
                                        segments.map(s =>
                                          `${dayTypeColors[s.type]} ${s.startPercent}% ${s.startPercent + s.percent}%`
                                        ).join(', ')
                                      })` : 'rgba(50,50,60,0.5)',
                                      position: 'relative',
                                      boxShadow: '0 2px 12px rgba(0,0,0,0.3)',
                                      cursor: 'pointer',
                                      transition: 'transform 0.2s ease, box-shadow 0.2s ease'
                                    }}
                                    onMouseEnter={(e) => {
                                      e.currentTarget.style.transform = 'scale(1.1)';
                                      e.currentTarget.style.boxShadow = '0 4px 20px rgba(0,0,0,0.5)';
                                    }}
                                    onMouseMove={(e) => {
                                      setHoveredDonut({
                                        day: stat.day,
                                        total,
                                        segments,
                                        avgRange: stat.avgRange,
                                        avgIbRange: stat.avgIbRange,
                                        ibPct: stat.ibPct,
                                        x: e.clientX,
                                        y: e.clientY
                                      });
                                    }}
                                    onMouseLeave={(e) => {
                                      e.currentTarget.style.transform = 'scale(1)';
                                      e.currentTarget.style.boxShadow = '0 2px 12px rgba(0,0,0,0.3)';
                                      setHoveredDonut(null);
                                    }}
                                  >
                                    <div style={{
                                      position: 'absolute',
                                      top: '50%',
                                      left: '50%',
                                      transform: 'translate(-50%, -50%)',
                                      width: 40,
                                      height: 40,
                                      borderRadius: '50%',
                                      background: 'linear-gradient(135deg, #1a1a2e 0%, #252540 100%)',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center',
                                      fontSize: 12,
                                      fontWeight: 700,
                                      color: '#fff'
                                    }}>
                                      {total}
                                    </div>
                                  </div>

                                  {/* Top type label */}
                                  {segments[0] && (
                                    <div style={{
                                      marginTop: 8,
                                      fontSize: 9,
                                      color: dayTypeColors[segments[0].type],
                                      fontWeight: 600
                                    }}>
                                      {segments[0].type === 'normal_var' ? 'N-Var' :
                                       segments[0].type === 'double_dist' ? 'Dbl-D' :
                                       segments[0].type === 'non_trend' ? 'Non-T' :
                                       segments[0].type?.charAt(0).toUpperCase() + segments[0].type?.slice(1)}
                                      <span style={{ color: '#666', marginLeft: 4 }}>
                                        {segments[0].percent.toFixed(0)}%
                                      </span>
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>

                          {/* Beautiful Donut Tooltip */}
                          {hoveredDonut && (
                            <div style={{
                              position: 'fixed',
                              left: hoveredDonut.x + 15,
                              top: hoveredDonut.y + 15,
                              transform: hoveredDonut.x > window.innerWidth - 260 ? 'translateX(-100%)' : 'none',
                              background: 'linear-gradient(135deg, rgba(20,20,35,0.98) 0%, rgba(35,30,50,0.98) 100%)',
                              borderRadius: 12,
                              padding: 0,
                              minWidth: 200,
                              boxShadow: '0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1)',
                              zIndex: 9999,
                              pointerEvents: 'none',
                              overflow: 'hidden'
                            }}>
                              {/* Header */}
                              <div style={{
                                background: 'rgba(255,255,255,0.05)',
                                borderBottom: '1px solid rgba(255,255,255,0.1)',
                                padding: '10px 14px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between'
                              }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                  <span style={{ fontSize: 16 }}>üìä</span>
                                  <span style={{ fontSize: 13, fontWeight: 700, color: '#fff' }}>{hoveredDonut.day}</span>
                                </div>
                                <span style={{
                                  fontSize: 11,
                                  color: '#888',
                                  background: 'rgba(255,255,255,0.1)',
                                  padding: '2px 8px',
                                  borderRadius: 10
                                }}>{hoveredDonut.total} days</span>
                              </div>

                              {/* Day Type Breakdown */}
                              <div style={{ padding: '12px 14px' }}>
                                <div style={{ fontSize: 9, color: '#666', marginBottom: 8, fontWeight: 600, textTransform: 'uppercase' }}>
                                  Day Type Distribution
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
                                  {hoveredDonut.segments.map((seg, idx) => {
                                    const typeName = seg.type === 'normal_var' ? 'Normal Var' :
                                                     seg.type === 'double_dist' ? 'Double Dist' :
                                                     seg.type === 'non_trend' ? 'Non-Trend' :
                                                     seg.type?.charAt(0).toUpperCase() + seg.type?.slice(1);
                                    return (
                                      <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                        <div style={{
                                          width: 10,
                                          height: 10,
                                          borderRadius: 3,
                                          background: dayTypeColors[seg.type],
                                          boxShadow: `0 0 6px ${dayTypeColors[seg.type]}66`
                                        }} />
                                        <span style={{ fontSize: 11, color: '#ccc', flex: 1 }}>{typeName}</span>
                                        <span style={{ fontSize: 11, fontWeight: 600, color: dayTypeColors[seg.type] }}>
                                          {seg.count}
                                        </span>
                                        <div style={{
                                          width: 50,
                                          height: 4,
                                          background: 'rgba(255,255,255,0.1)',
                                          borderRadius: 2,
                                          overflow: 'hidden'
                                        }}>
                                          <div style={{
                                            width: `${seg.percent}%`,
                                            height: '100%',
                                            background: dayTypeColors[seg.type],
                                            borderRadius: 2
                                          }} />
                                        </div>
                                        <span style={{ fontSize: 10, color: '#888', width: 32, textAlign: 'right' }}>
                                          {seg.percent.toFixed(0)}%
                                        </span>
                                      </div>
                                    );
                                  })}
                                </div>

                                {/* Stats */}
                                <div style={{
                                  marginTop: 12,
                                  paddingTop: 10,
                                  borderTop: '1px solid rgba(255,255,255,0.08)',
                                  display: 'grid',
                                  gridTemplateColumns: 'repeat(3, 1fr)',
                                  gap: 8
                                }}>
                                  <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>AVG RANGE</div>
                                    <div style={{ fontSize: 11, fontWeight: 600, color: '#fff', fontFamily: 'monospace' }}>
                                      ${hoveredDonut.avgRange}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>AVG IB</div>
                                    <div style={{ fontSize: 11, fontWeight: 600, color: '#9370DB', fontFamily: 'monospace' }}>
                                      ${hoveredDonut.avgIbRange}
                                    </div>
                                  </div>
                                  <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: 8, color: '#666', marginBottom: 2 }}>IB %</div>
                                    <div style={{ fontSize: 11, fontWeight: 600, color: '#00aaff', fontFamily: 'monospace' }}>
                                      {hoveredDonut.ibPct}%
                                    </div>
                                  </div>
                                </div>
                              </div>

                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })()}
                </div>
              ) : (
                <div style={{ textAlign: 'center', color: '#8b8b8b', padding: 40 }}>
                  No historic data available
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// ============================================
// LIVE DASHBOARD WITH REAL-TIME DATA
// ============================================
const LiveDashboard = ({ settings, onSettingsChange }) => {
  const [metrics, setMetrics] = useState({
    ticker: 'GC1!',
    current_price: 0,
    delta_5m: 0,
    delta_30m: 0,
    cumulative_delta: 0,
    ib_high: 0,
    ib_low: 0,
    ib_midpoint: 0,
    ib_range: 0,
    pdpoc: 0,
    pd_high: 0,
    pd_low: 0,
    vwap: 0,
    session_high: 0,
    session_low: 0,
    buying_imbalance_pct: 0,
    absorption_ratio: 0,
    stacked_buy_imbalances: 0,
    current_phase: 'CONNECTING...',
    conditions_met: 0,
    entry_signal: false,
    last_update: '',
    market_open: false,
    candle_30m_stats: {
      avg: { range: 0, volume: 0, buy_vol: 0, sell_vol: 0, delta: 0 },
      max: { range: 0, volume: 0, buy_vol: 0, sell_vol: 0, delta: 0 },
      min: { range: 0, volume: 0, buy_vol: 0, sell_vol: 0, delta: 0 }
    }
  });
  
  const [connected, setConnected] = useState(false);
  const [latency, setLatency] = useState(0);
  const [lastUpdate, setLastUpdate] = useState(new Date());
  const [alerts, setAlerts] = useState([]);
  const [gexData, setGexData] = useState({
    gamma_environment: 'UNKNOWN',
    gamma_regime: 'UNKNOWN',
    total_gex: 0,
    zero_gamma: 0,
    max_pain: 0,
    key_levels: [],
    gex_profile: [],    // Strike-by-strike GEX data for chart
    gex_levels: [],     // Key GEX levels (call wall, put wall, etc.)
    call_wall: 0,
    put_wall: 0,
    hvl: 0,
    gamma_flip: 0,
    beta_spx: 0,
    beta_dxy: 0,
    ib_locked: false,
    ib_session_name: '',
    pd_high: 0,
    pd_low: 0,
    pdpoc: 0,
    session_high: 0,
    session_low: 0,
    data_source: 'CONNECTING'
  });

  // ETF Flow and Institutional Data state
  const [etfFlowData, setEtfFlowData] = useState({
    etfs: [],
    total_flow_1d_mm: 0,
    total_flow_5d_mm: 0,
    timestamp: null
  });
  const [institutionalData, setInstitutionalData] = useState({
    gold: { overall_sentiment: 'neutral', signals: [] },
    bitcoin: { overall_sentiment: 'neutral', signals: [], etf_flow_1d: 0 },
    timestamp: null
  });
  const [deribitData, setDeribitData] = useState({
    btc_options: {
      put_call_ratio: 0,
      max_pain: 0,
      call_wall: 0,
      put_wall: 0,
      sentiment: 'neutral'
    }
  });
  const [fundingData, setFundingData] = useState({
    funding_rates: {
      average: 0,
      annualized: 0,
      sentiment: 'neutral'
    }
  });

  // Responsive breakpoints
  const { isMobile, isTablet } = useResponsive();

  // Live data polling with latency tracking
  useEffect(() => {
    const fetchLiveData = async () => {
      const startTime = performance.now();
      try {
        const response = await fetch(API_BASE);
        if (response.ok) {
          const data = await response.json();
          const endTime = performance.now();
          const latencyMs = Math.round(endTime - startTime);
          
          setMetrics(data);
          setGexData(prev => ({ ...prev, ...data }));
          setConnected(true);
          setLatency(latencyMs);
          setLastUpdate(new Date());
        } else {
          throw new Error('Backend error');
        }
      } catch (e) {
        setConnected(false);
        setLatency(0);
        setMetrics(prev => ({ ...prev, current_phase: 'DISCONNECTED' }));
        setGexData(prev => ({ ...prev, data_source: 'DISCONNECTED' }));
      }
    };
    
    fetchLiveData();
    const interval = setInterval(fetchLiveData, 300); // Poll every 300ms
    return () => clearInterval(interval);
  }, []);

  // Fetch ETF flow and institutional data (less frequently)
  useEffect(() => {
    const fetchInstitutionalData = async () => {
      try {
        // Only fetch for BTC-SPOT or when showing institutional panel
        const isBtcSpot = metrics?.contract === 'BTC-SPOT';

        // Fetch ETF flows (for Bitcoin)
        if (isBtcSpot) {
          const etfResponse = await fetch(`${API_BASE.replace('?', '/etf-flows?')}`);
          if (etfResponse.ok) {
            const etfData = await etfResponse.json();
            setEtfFlowData(etfData);
          }

          // Fetch Deribit options data
          const deribitResponse = await fetch(`${API_BASE.replace('?', '/deribit-options?')}`);
          if (deribitResponse.ok) {
            const deribitOpts = await deribitResponse.json();
            setDeribitData(deribitOpts);
          }

          // Fetch funding rates
          const fundingResponse = await fetch(`${API_BASE.replace('?', '/funding-rates?')}`);
          if (fundingResponse.ok) {
            const fundingRates = await fundingResponse.json();
            setFundingData(fundingRates);
          }
        }

        // Fetch institutional positions
        const instResponse = await fetch(`${API_BASE.replace('?', '/institutional?')}`);
        if (instResponse.ok) {
          const instData = await instResponse.json();
          setInstitutionalData(instData);
        }
      } catch (e) {
        console.error('Error fetching institutional data:', e);
      }
    };

    fetchInstitutionalData();
    const interval = setInterval(fetchInstitutionalData, 60000); // Poll every minute
    return () => clearInterval(interval);
  }, [metrics?.contract]);

  // Latency indicator color
  const getLatencyColor = (ms) => {
    if (ms === 0) return '#ff4466';
    if (ms < 100) return '#00ff88';
    if (ms < 500) return '#ffaa00';
    if (ms < 3000) return '#ff6600';
    return '#ff4466';
  };

  const getLatencyStatus = (ms) => {
    if (ms === 0) return 'OFFLINE';
    if (ms < 100) return 'EXCELLENT';
    if (ms < 500) return 'GOOD';
    if (ms < 3000) return 'SLOW';
    return 'CRITICAL';
  };

  // Price proximity highlighting - white text with glow when near current price
  // Use ¬±$2 for current session values (forming range is small)
  // Use ¬±$5 for static levels (IB, PD)
  const isNearCurrentPrice = (value, threshold = 5) => {
    if (!value || value <= 0 || !metrics.current_price || metrics.current_price <= 0) return false;
    return Math.abs(value - metrics.current_price) <= threshold;
  };

  const getPriceProximityStyle = (value, baseColor, threshold = 5) => {
    if (isNearCurrentPrice(value, threshold)) {
      return {
        color: '#ffffff',
        textShadow: '0 0 8px rgba(255,255,255,0.8), 0 0 16px rgba(255,255,255,0.5)',
        fontWeight: 700
      };
    }
    return { color: baseColor };
  };

  // Connection & Latency status bar
  const ConnectionStatus = () => (
    <div style={{
      display: 'flex',
      alignItems: 'center',
      gap: 16,
      padding: '10px 20px',
      borderRadius: 12,
      background: 'rgba(0,0,0,0.3)',
      border: `1px solid ${connected ? 'rgba(0,255,136,0.3)' : 'rgba(255,68,102,0.3)'}`
    }}>
      {/* Connection Status */}
      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
        <div style={{
          width: 10,
          height: 10,
          borderRadius: '50%',
          background: connected ? '#00ff88' : '#ff4466',
          boxShadow: connected ? '0 0 10px #00ff88' : 'none',
          animation: connected ? 'pulse 2s infinite' : 'none'
        }} />
        <span style={{ color: connected ? '#00ff88' : '#ff4466', fontSize: 12, fontWeight: 600 }}>
          {connected ? '‚óè LIVE' : '‚óã DISCONNECTED'}
        </span>
      </div>

      {/* Divider */}
      <div style={{ width: 1, height: 20, background: 'rgba(255,255,255,0.2)' }} />

      {/* Latency */}
      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
        <span style={{ color: '#888', fontSize: 11 }}>LATENCY:</span>
        <span style={{
          color: getLatencyColor(latency),
          fontSize: 14,
          fontWeight: 700,
          fontFamily: 'monospace',
          minWidth: 55,
          textAlign: 'right'
        }}>
          {connected ? `${latency}ms` : '---'}
        </span>
        <span style={{
          padding: '2px 8px',
          borderRadius: 4,
          fontSize: 10,
          fontWeight: 600,
          background: `${getLatencyColor(latency)}22`,
          color: getLatencyColor(latency),
          minWidth: 65,
          textAlign: 'center'
        }}>
          {getLatencyStatus(latency)}
        </span>
      </div>

      {/* Divider */}
      <div style={{ width: 1, height: 20, background: 'rgba(255,255,255,0.2)' }} />

      {/* Data Source */}
      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
        <span style={{ color: '#888', fontSize: 11 }}>SOURCE:</span>
        <span style={{ color: '#00aaff', fontSize: 12, fontWeight: 600 }}>
          {gexData.data_source || 'DATABENTO'}
        </span>
      </div>
    </div>
  );

  // Phase indicator with color coding
  // Updated PhaseIndicator with flight-board style - calculates session from ET time
  const PhaseIndicator = ({ phase }) => {
    // Session definitions with colors and times
    const sessionInfo = {
      'JAPAN_IB': { name: 'Japan IB', time: '19:00 - 20:00 ET', color: '#9370DB' },
      'JAPAN_IB_FORMING': { name: 'Japan IB', time: '19:00 - 20:00 ET', color: '#9370DB', forming: true },
      'CHINA': { name: 'China', time: '20:00 - 23:00 ET', color: '#8B5CF6' },
      'ASIA_CLOSING': { name: 'Asia Closing', time: '23:00 - 02:00 ET', color: '#4B5563' },
      'DEADZONE': { name: 'Deadzone', time: '02:00 - 03:00 ET', color: '#6B7280' },
      'LONDON': { name: 'London', time: '03:00 - 06:00 ET', color: '#3B82F6' },
      'LOW_VOLUME': { name: 'Low Volume', time: '06:00 - 08:20 ET', color: '#4B5563' },
      'US_IB': { name: 'US IB', time: '08:20 - 09:30 ET', color: '#F59E0B' },
      'US_IB_FORMING': { name: 'US IB', time: '08:20 - 09:30 ET', color: '#F59E0B', forming: true },
      'NY_1H': { name: 'NY 1H', time: '09:30 - 10:30 ET', color: '#10B981' },
      'NY_2H': { name: 'NY 2H', time: '10:30 - 11:30 ET', color: '#14B8A6' },
      'LUNCH': { name: 'Lunch', time: '11:30 - 13:30 ET', color: '#6B7280' },
      'NY_PM': { name: 'NY PM', time: '13:30 - 16:00 ET', color: '#EF4444' },
      'NY_CLOSE': { name: 'NY Close', time: '16:00 - 17:00 ET', color: '#4B5563' },
      'MARKET_CLOSED': { name: 'Market Closed', time: '17:00 - 18:00 ET', color: '#1F2937' },
      'PRE_ASIA': { name: 'Pre-Asia', time: '18:00 - 19:00 ET', color: '#4B5563' },
    };

    // Calculate current session from ET time (ignore backend phase)
    const getETSession = () => {
      const etTime = new Date().toLocaleString('en-US', { timeZone: 'America/New_York' });
      const et = new Date(etTime);
      const hours = et.getHours();
      const mins = et.getMinutes();
      const timeVal = hours * 100 + mins;

      if (timeVal >= 1900 && timeVal < 2000) return 'JAPAN_IB';
      if (timeVal >= 2000 && timeVal < 2300) return 'CHINA';
      if (timeVal >= 2300 || timeVal < 200) return 'ASIA_CLOSING';
      if (timeVal >= 200 && timeVal < 300) return 'DEADZONE';
      if (timeVal >= 300 && timeVal < 600) return 'LONDON';
      if (timeVal >= 600 && timeVal < 820) return 'LOW_VOLUME';
      if (timeVal >= 820 && timeVal < 930) return 'US_IB';
      if (timeVal >= 930 && timeVal < 1030) return 'NY_1H';
      if (timeVal >= 1030 && timeVal < 1130) return 'NY_2H';
      if (timeVal >= 1130 && timeVal < 1330) return 'LUNCH';
      if (timeVal >= 1330 && timeVal < 1600) return 'NY_PM';
      if (timeVal >= 1600 && timeVal < 1700) return 'NY_CLOSE';
      if (timeVal >= 1700 && timeVal < 1800) return 'MARKET_CLOSED';
      if (timeVal >= 1800 && timeVal < 1900) return 'PRE_ASIA';
      return 'UNKNOWN';
    };

    const currentSession = getETSession();
    const info = sessionInfo[currentSession] || { name: currentSession, time: '', color: '#888' };
    
    return (
      <div style={{
        padding: '16px 24px',
        borderRadius: 12,
        background: 'linear-gradient(180deg, rgba(20,20,30,0.9) 0%, rgba(10,10,15,0.95) 100%)',
        border: `2px solid ${info.color}50`,
        textAlign: 'center',
        boxShadow: `0 4px 20px ${info.color}20`
      }}>
        <div style={{ fontSize: 11, color: '#666', marginBottom: 8, letterSpacing: 2 }}>CURRENT SESSION</div>
        <div style={{ 
          fontSize: 28, 
          fontWeight: 700, 
          color: info.color,
          textShadow: `0 0 20px ${info.color}50`,
          fontFamily: "'JetBrains Mono', monospace",
          letterSpacing: 2,
          marginBottom: 8,
          animation: info.forming ? 'pulse 1.5s ease-in-out infinite' : 'none'
        }}>
          {info.name.toUpperCase()}
        </div>
        <div style={{
          fontSize: 13,
          color: '#888',
          fontFamily: 'monospace',
          padding: '4px 12px',
          background: 'rgba(255,255,255,0.05)',
          borderRadius: 4,
          display: 'inline-block'
        }}>
          üïê {info.time}
        </div>
        {info.forming && (
          <div style={{
            marginTop: 8,
            fontSize: 10,
            color: '#00ff88',
            fontWeight: 600,
            letterSpacing: 1,
            animation: 'pulse 1s ease-in-out infinite'
          }}>
            ‚óè IB FORMING
          </div>
        )}
      </div>
    );
  };

  // Entry signal alert
  const EntrySignalAlert = ({ active, conditionsMet }) => (
    <div style={{
      padding: 16,
      borderRadius: 12,
      background: active ? 'rgba(0,255,136,0.15)' : 'rgba(255,255,255,0.02)',
      border: `2px solid ${active ? '#00ff88' : 'rgba(255,255,255,0.1)'}`,
      textAlign: 'center',
      animation: active ? 'glow 1s infinite alternate' : 'none'
    }}>
      <div style={{ fontSize: 14, color: '#888', marginBottom: 8 }}>ENTRY SIGNAL</div>
      <div style={{ 
        fontSize: 36, 
        fontWeight: 700, 
        color: active ? '#00ff88' : '#444'
      }}>
        {active ? 'üéØ READY' : '‚è≥ WAITING'}
      </div>
      <div style={{ 
        fontSize: 14, 
        color: active ? '#00ff88' : '#666',
        marginTop: 8 
      }}>
        {conditionsMet}/6 Conditions Met
      </div>
    </div>
  );

  // Alert feed
  const AlertFeed = ({ alerts }) => (
    <div style={{
      background: 'rgba(255,255,255,0.02)',
      borderRadius: 12,
      padding: 16,
      maxHeight: 200,
      overflowY: 'auto'
    }}>
      <h4 style={{ margin: '0 0 12px 0', color: '#fff', fontSize: 14 }}>üì¢ Alert Feed</h4>
      {alerts.length === 0 ? (
        <div style={{ color: '#666', fontSize: 12 }}>No alerts yet...</div>
      ) : (
        alerts.slice().reverse().map((alert, idx) => (
          <div key={idx} style={{
            padding: '8px 12px',
            marginBottom: 8,
            borderRadius: 8,
            background: alert.type === 'ENTRY_SIGNAL' ? 'rgba(0,255,136,0.1)' : 
                        alert.type === 'PHASE_CHANGE' ? 'rgba(255,170,0,0.1)' : 'rgba(255,255,255,0.05)',
            borderLeft: `3px solid ${
              alert.type === 'ENTRY_SIGNAL' ? '#00ff88' : 
              alert.type === 'PHASE_CHANGE' ? '#ffaa00' : '#888'
            }`
          }}>
            <div style={{ fontSize: 10, color: '#666' }}>
              {new Date(alert.timestamp).toLocaleTimeString()}
            </div>
            <div style={{ fontSize: 12, color: '#fff' }}>{alert.message}</div>
            <div style={{ fontSize: 10, color: '#888' }}>@ ${alert.price?.toFixed(2)}</div>
          </div>
        ))
      )}
    </div>
  );

  return (
    <div style={{
      ...styles.liveDashboard,
      maxWidth: isMobile ? '100%' : '1000px',
      padding: isMobile ? '12px' : '0',
    }}>
      {/* Session Header with Round Containers */}
      <SessionHeader />

      {/* Entry Signal */}
      <div style={{ marginBottom: isMobile ? 16 : 24 }}>
        <EntrySignalAlert active={metrics.entry_signal} conditionsMet={metrics.conditions_met} />
      </div>

      {/* 4 IB Sessions - Each tracked independently */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        borderRadius: isMobile ? 12 : 16,
        padding: isMobile ? 12 : 20,
        marginBottom: isMobile ? 12 : 16
      }}>
        <h3 style={{ margin: '0 0 16px 0', color: '#888', fontSize: isMobile ? 12 : 14 }}>Initial Balance Sessions</h3>
        <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)', gap: 12 }}>
          {gexData.ibs && ['japan', 'london', 'us', 'ny'].map(ibKey => {
            const ib = gexData.ibs[ibKey];
            if (!ib) return null;
            const isActive = ib.status === 'ACTIVE';
            const isEnded = ib.status === 'ENDED';
            const hasData = ib.high > 0 && ib.low > 0;
            return (
              <div key={ibKey} style={{
                background: isActive ? 'rgba(0,255,136,0.05)' : 'rgba(255,255,255,0.02)',
                border: `2px solid ${isActive ? 'rgba(0,255,136,0.6)' : isEnded ? 'rgba(255,170,0,0.4)' : 'rgba(136,136,136,0.2)'}`,
                borderRadius: 12,
                padding: 12,
                position: 'relative'
              }}>
                {/* Header with name and status */}
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>
                  <div>
                    <div style={{
                      fontSize: 13,
                      fontWeight: 700,
                      color: isActive ? '#00ff88' : isEnded ? '#ffaa00' : '#666',
                      fontFamily: "'JetBrains Mono', monospace",
                      letterSpacing: 1
                    }}>
                      {ib.name}
                    </div>
                    <div style={{ fontSize: 10, color: '#666', marginTop: 2 }}>
                      {ib.start} - {ib.end} ET
                    </div>
                  </div>
                  <span style={{
                    padding: '4px 8px',
                    borderRadius: 4,
                    fontSize: 9,
                    fontWeight: 700,
                    letterSpacing: 1,
                    background: isActive ? '#001a00' : isEnded ? '#1a1000' : '#111',
                    color: isActive ? '#00ff88' : isEnded ? '#ffaa00' : '#666',
                    border: `1px solid ${isActive ? '#00ff88' : isEnded ? '#ffaa00' : '#333'}`,
                    animation: isActive ? 'pulse 1.5s ease-in-out infinite' : 'none'
                  }}>
                    {isActive ? '‚óè ACTIVE' : isEnded ? '‚ñ† ENDED' : '‚óã WAITING'}
                  </span>
                </div>
                {/* Values */}
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 6 }}>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>HIGH</div>
                    <div style={{
                      fontSize: 12,
                      fontWeight: 600,
                      fontFamily: 'monospace',
                      ...getPriceProximityStyle(hasData ? ib.high : 0, hasData ? '#ff4466' : '#444')
                    }}>
                      {hasData ? `$${ib.high.toFixed(2)}` : '--'}
                    </div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>MID</div>
                    <div style={{
                      fontSize: 12,
                      fontWeight: 600,
                      fontFamily: 'monospace',
                      ...getPriceProximityStyle(hasData ? ib.mid : 0, hasData ? '#ffaa00' : '#444')
                    }}>
                      {hasData ? `$${ib.mid.toFixed(2)}` : '--'}
                    </div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 9, color: '#666', marginBottom: 2 }}>LOW</div>
                    <div style={{
                      fontSize: 12,
                      fontWeight: 600,
                      fontFamily: 'monospace',
                      ...getPriceProximityStyle(hasData ? ib.low : 0, hasData ? '#00ff88' : '#444')
                    }}>
                      {hasData ? `$${ib.low.toFixed(2)}` : '--'}
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Previous Day Levels */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        border: '1px solid rgba(136,136,136,0.3)',
        borderRadius: 16,
        padding: 20,
        marginBottom: 16
      }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
          <h3 style={{ margin: 0, color: '#888', fontSize: 14 }}>üìå Previous Day Levels</h3>
          <span style={{
            padding: '4px 12px',
            borderRadius: 20,
            fontSize: 11,
            fontWeight: 600,
            background: 'rgba(136,136,136,0.15)',
            color: '#aaa',
            fontFamily: 'monospace'
          }}>
            {gexData.pd_date_range || 'Loading...'}
          </span>
        </div>
        <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : 'repeat(3, 1fr)', gap: isMobile ? 8 : 16 }}>
          <div style={styles.levelCard}>
            <div style={styles.levelLabel}>pd High</div>
            <div style={{ ...styles.levelValue, ...getPriceProximityStyle(gexData.pd_high, '#ff4466') }}>
              ${(gexData.pd_high && gexData.pd_high > 0) ? gexData.pd_high.toFixed(2) : '0.00'}
            </div>
          </div>
          <div style={styles.levelCard}>
            <div style={styles.levelLabel}>pdPOC</div>
            <div style={{ ...styles.levelValue, ...getPriceProximityStyle(gexData.pdpoc || metrics.pdpoc, '#ffaa00') }}>
              ${(gexData.pdpoc && gexData.pdpoc > 0) ? gexData.pdpoc.toFixed(2) : (metrics.pdpoc && metrics.pdpoc > 0) ? metrics.pdpoc.toFixed(2) : '0.00'}
            </div>
          </div>
          <div style={styles.levelCard}>
            <div style={styles.levelLabel}>pd Low</div>
            <div style={{ ...styles.levelValue, ...getPriceProximityStyle(gexData.pd_low, '#00ff88') }}>
              ${(gexData.pd_low && gexData.pd_low < 999999) ? gexData.pd_low.toFixed(2) : '0.00'}
            </div>
          </div>
        </div>
      </div>

      {/* Signal Matrix */}
      <SignalMatrix metrics={metrics} settings={settings} />

      {/* Fibonacci Levels & Range Location */}
      {(() => {
        // Use PD values when current day range is too small (new session just started)
        const rawDayHigh = metrics.dayHigh || metrics.day_high || 0;
        const rawDayLow = metrics.dayLow || metrics.day_low || 0;
        const rawDayRange = rawDayHigh - rawDayLow;
        const pdHigh = metrics.pd_high || 0;
        const pdLow = metrics.pd_low || 0;
        const pdRange = pdHigh - pdLow;

        // Use PD values if current day range < 100 points (new day just started)
        const usePD = rawDayRange < 100 && pdRange > 100;
        const dayHigh = usePD ? pdHigh : rawDayHigh;
        const dayLow = usePD ? pdLow : rawDayLow;
        const currentPrice = metrics.current_price || 0;
        const dayRange = dayHigh - dayLow;

        // Skip rendering only if we don't have valid day range
        // Show Fibonacci levels even when market closed (price = 0)
        if (dayRange <= 0) {
          return (
            <div style={{
              background: 'linear-gradient(135deg, rgba(249,115,22,0.05) 0%, rgba(255,68,102,0.05) 100%)',
              border: '1px solid rgba(249,115,22,0.3)',
              borderRadius: 16,
              padding: 20,
              marginTop: 20,
              textAlign: 'center'
            }}>
              <h3 style={{ margin: 0, color: '#f97316', fontSize: 14, marginBottom: 8 }}>üìê Fibonacci Levels & Range Analysis</h3>
              <div style={{ fontSize: 12, color: '#666' }}>Awaiting market data...</div>
            </div>
          );
        }

        // Determine day direction based on whether using PD values
        // When using PD: bearish if pd_close < pd_open (down day)
        // When using current day: bearish if current price < midpoint
        const dayMid = (dayHigh + dayLow) / 2;
        const pdClose = metrics.pd_close || 0;
        const pdOpen = metrics.pd_open || 0;
        const isBearishDay = usePD
          ? (pdClose > 0 && pdOpen > 0 ? pdClose < pdOpen : true)
          : (currentPrice > 0 ? currentPrice < dayMid : true);

        // Calculate Fibonacci retracement levels based on day direction
        // BEARISH day: Price went down, now retracing UP from low (0% at low, 100% at high)
        //   Extensions: 127% and 162% BELOW the low (beyond 100%)
        // BULLISH day: Price went up, now retracing DOWN from high (0% at high, 100% at low)
        //   Extensions: -27% and -62% ABOVE the high (beyond 0%)
        // TradingView convention:
        // BEARISH: 100% at High, 0% at Low, extensions -27%/-62% BELOW low
        // BULLISH: 0% at High, 100% at Low, extensions -27%/-62% ABOVE high
        const fibLevels = isBearishDay ? [
          { level: '100%', price: dayHigh, color: '#ff4466', desc: 'Day High' },
          { level: '78.6%', price: dayLow + (dayRange * 0.786), color: '#ff6b6b', desc: 'Deep Retracement' },
          { level: '61.8%', price: dayLow + (dayRange * 0.618), color: '#ffd93d', desc: 'Golden Ratio' },
          { level: '50%', price: dayLow + (dayRange * 0.5), color: '#f97316', desc: 'Mid Point' },
          { level: '38.2%', price: dayLow + (dayRange * 0.382), color: '#00bcd4', desc: 'Shallow Retracement' },
          { level: '23.6%', price: dayLow + (dayRange * 0.236), color: '#10B981', desc: 'Minor Retracement' },
          { level: '0%', price: dayLow, color: '#00ff88', desc: 'Day Low' },
          { level: '-27%', price: dayLow - (dayRange * 0.27), color: '#ff1744', desc: 'Extension' },
          { level: '-62%', price: dayLow - (dayRange * 0.618), color: '#d50000', desc: 'Deep Extension' },
        ] : [
          { level: '0%', price: dayHigh, color: '#ff4466', desc: 'Day High' },
          { level: '23.6%', price: dayHigh - (dayRange * 0.236), color: '#ff6b6b', desc: 'Minor Retracement' },
          { level: '38.2%', price: dayHigh - (dayRange * 0.382), color: '#ffd93d', desc: 'Shallow Retracement' },
          { level: '50%', price: dayHigh - (dayRange * 0.5), color: '#f97316', desc: 'Mid Point' },
          { level: '61.8%', price: dayHigh - (dayRange * 0.618), color: '#00bcd4', desc: 'Golden Ratio' },
          { level: '78.6%', price: dayHigh - (dayRange * 0.786), color: '#10B981', desc: 'Deep Retracement' },
          { level: '100%', price: dayLow, color: '#00ff88', desc: 'Day Low' },
          { level: '-27%', price: dayHigh + (dayRange * 0.27), color: '#00e676', desc: 'Extension' },
          { level: '-62%', price: dayHigh + (dayRange * 0.618), color: '#00c853', desc: 'Deep Extension' },
        ];

        // Swing Fibonacci from 5m candles (3-candle structure detection)
        const swing = metrics?.swing || {};
        const swingHigh = swing.swing_high || 0;
        const swingLow = swing.swing_low || 0;
        const swingDir = swing.swing_direction || 'neutral';
        const extDir = swing.extensions_direction || swingDir;
        const swingRange = swingHigh - swingLow;

        // Calculate current position in range (0 = low, 1 = high), clamped 0-1 for display
        const rawRangePosition = (currentPrice - dayLow) / dayRange;
        const rangePosition = Math.min(1, Math.max(0, rawRangePosition));

        // Determine range zone (inverted: high = premium, low = discount)
        // rawPos is the actual position (can be > 1 or < 0 if outside range)
        const getRangeZone = (pos, rawPos = pos) => {
          // Check if outside range (above 100% or below 0%)
          if (rawPos > 1 || rawPos < 0) return { zone: 'Outside Range', color: '#a855f7', bg: 'rgba(168,85,247,0.15)' };
          if (pos >= 0.75) return { zone: 'Highly Premium', color: '#ff4466', bg: 'rgba(255,68,102,0.15)' };
          if (pos >= 0.5) return { zone: 'Premium', color: '#f97316', bg: 'rgba(249,115,22,0.15)' };
          if (pos >= 0.25) return { zone: 'Discount', color: '#00bcd4', bg: 'rgba(0,188,212,0.15)' };
          return { zone: 'Highly Discount', color: '#00ff88', bg: 'rgba(0,255,136,0.15)' };
        };

        const dayZone = getRangeZone(rangePosition, rawRangePosition);

        // Session-specific ranges
        const ibHigh = metrics.ib_high || 0;
        const ibLow = metrics.ib_low || 0;
        const ibRange = ibHigh - ibLow;
        const ibPosition = ibRange > 0 ? (currentPrice - ibLow) / ibRange : null;
        const ibZone = ibPosition !== null ? getRangeZone(Math.min(1, Math.max(0, ibPosition)), ibPosition) : null;

        // Get current session based on time
        const now = new Date();
        const etHour = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"})).getHours();
        const etMin = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"})).getMinutes();
        const timeVal = etHour * 100 + etMin;

        // Session active checks
        const isLondonActive = timeVal >= 300 && timeVal < 600; // 3:00 AM - 6:00 AM ET
        const isUSIBActive = timeVal >= 820 && timeVal < 930; // 8:20 AM - 9:30 AM ET (US IB)
        const isNY1HActive = timeVal >= 930 && timeVal < 1030; // Same as IB
        const isNY2HActive = timeVal >= 1030 && timeVal < 1130; // 10:30 AM - 11:30 AM ET

        // Find nearest Fib level
        const nearestFib = fibLevels.reduce((nearest, fib) => {
          const dist = Math.abs(currentPrice - fib.price);
          return dist < nearest.dist ? { ...fib, dist } : nearest;
        }, { dist: Infinity });

        return (
          <div style={{
            background: 'linear-gradient(135deg, rgba(249,115,22,0.05) 0%, rgba(255,68,102,0.05) 100%)',
            border: '1px solid rgba(249,115,22,0.3)',
            borderRadius: 16,
            padding: 20,
            marginTop: 20
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
              <h3 style={{ margin: 0, color: '#f97316', fontSize: 14 }}>üìê Fibonacci Levels & Range Analysis</h3>
              <span style={{
                padding: '4px 12px',
                borderRadius: 20,
                fontSize: 11,
                fontWeight: 600,
                background: dayZone.bg,
                color: dayZone.color,
              }}>
                {dayZone.zone}
              </span>
            </div>

            {/* Day Range, Fibonacci & Session Range - Horizontal Layout */}
            <div style={{ display: 'flex', gap: 20 }}>
              {/* Left: Day Range Position */}
              <div style={{ flex: '0 0 auto' }}>
                <div style={{ fontSize: 10, color: '#888', marginBottom: 8 }}>Day Range</div>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>
                  <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'space-between', height: 420, fontSize: 7, textAlign: 'right', color: '#666' }}>
                    <span style={{ color: '#ff4466' }}>PREM</span>
                    <span>75%</span>
                    <span>50%</span>
                    <span>25%</span>
                    <span style={{ color: '#00ff88' }}>DISC</span>
                  </div>
                  <div style={{ position: 'relative', width: 12, height: 420, borderRadius: 6, overflow: 'hidden' }}>
                    <div style={{ position: 'absolute', inset: 0, background: 'linear-gradient(to bottom, #ff4466 0%, #f97316 25%, #666 50%, #00bcd4 75%, #00ff88 100%)', opacity: 0.5 }} />
                    <div style={{
                      position: 'absolute',
                      top: `${Math.min(100, Math.max(0, (1 - rangePosition) * 100))}%`,
                      left: '50%',
                      transform: 'translate(-50%, -50%)',
                      width: 18,
                      height: 4,
                      background: '#fff',
                      borderRadius: 2,
                      boxShadow: '0 0 6px #fff',
                      zIndex: 10
                    }} />
                  </div>
                  <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'space-between', height: 420, fontSize: 9 }}>
                    <div style={{ color: '#ff4466' }}>{dayHigh.toFixed(2)}</div>
                    <div style={{ padding: '4px 6px', background: dayZone.bg, borderRadius: 4, textAlign: 'center' }}>
                      <div style={{ fontSize: 8, color: dayZone.color, fontWeight: 600 }}>{dayZone.zone}</div>
                      <div style={{ fontSize: 9, color: '#fff' }}>{(rawRangePosition * 100).toFixed(0)}%</div>
                    </div>
                    <div style={{ color: '#00ff88' }}>{dayLow.toFixed(2)}</div>
                  </div>
                </div>
              </div>

              {/* Middle: Day Fibonacci Retracement */}
              <div style={{ flex: '0 0 auto' }}>
                <div style={{ fontSize: 10, color: '#888', marginBottom: 8 }}>Day Fibonacci {isBearishDay ? '(Bearish)' : '(Bullish)'}</div>
                <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>
                  <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'space-between', height: 420, fontSize: 8, textAlign: 'right', width: 28 }}>
                    {fibLevels.map((fib, i) => (
                      <span key={i} style={{ color: fib.color, fontWeight: 500, lineHeight: 1 }}>{fib.level}</span>
                    ))}
                  </div>
                  <div style={{ position: 'relative', width: 12, height: 420, borderRadius: 6, overflow: 'hidden' }}>
                    <div style={{ position: 'absolute', inset: 0, background: isBearishDay
                      ? 'linear-gradient(to bottom, #ff4466 0%, #ff6b6b 16%, #ffd93d 33%, #f97316 50%, #00bcd4 66%, #10B981 83%, #00ff88 100%)'
                      : 'linear-gradient(to bottom, #ff4466 0%, #ff6b6b 16%, #ffd93d 33%, #f97316 50%, #00bcd4 66%, #10B981 83%, #00ff88 100%)', opacity: 0.5 }} />
                    {fibLevels.map((fib, i) => (
                      <div key={i} style={{ position: 'absolute', top: `${(i / (fibLevels.length - 1)) * 100}%`, left: 0, width: '100%', height: 1, background: `${fib.color}80`, transform: 'translateY(-50%)' }} />
                    ))}
                    <div style={{
                      position: 'absolute',
                      top: `${Math.min(100, Math.max(0, (1 - rangePosition) * 100))}%`,
                      left: '50%',
                      transform: 'translate(-50%, -50%)',
                      width: 18,
                      height: 4,
                      background: '#fff',
                      borderRadius: 2,
                      boxShadow: '0 0 6px #fff',
                      zIndex: 10
                    }} />
                  </div>
                  <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'space-between', height: 420 }}>
                    {fibLevels.map((fib, i) => {
                      const isNear = Math.abs(currentPrice - fib.price) < (dayRange * 0.025);
                      return (
                        <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 4, lineHeight: 1 }}>
                          <span style={{ fontSize: 10, color: isNear ? '#fff' : '#777', fontWeight: isNear ? 600 : 400, background: isNear ? `${fib.color}30` : 'transparent', padding: isNear ? '1px 3px' : 0, borderRadius: 2 }}>{fib.price.toFixed(2)}</span>
                          <span style={{ fontSize: 7, color: '#555' }}>{fib.desc}</span>
                          {isNear && <span style={{ color: fib.color, fontSize: 8 }}>‚óÑ</span>}
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>

              {/* Swing Fibonacci Retracement */}
              {swingRange > 30 && (
                <div style={{ flex: '0 0 auto', borderLeft: '1px solid rgba(255,255,255,0.1)', paddingLeft: 16 }}>
                  <div style={{ fontSize: 10, color: '#A78BFA', marginBottom: 8 }}>Swing Fib {swingDir === 'up' ? '‚Üë' : swingDir === 'down' ? '‚Üì' : '‚Äî'}</div>
                  <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>
                    <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'space-between', height: 420, fontSize: 8, textAlign: 'right', width: 28 }}>
                      {(swingDir === 'up' ? [
                        // Uptrend: Extensions ABOVE swing high, retracement from high down
                        { level: '-62%', price: swingHigh + swingRange * 0.618, color: '#00E676' },
                        { level: '-27%', price: swingHigh + swingRange * 0.27, color: '#69F0AE' },
                        { level: '0%', price: swingHigh, color: '#A78BFA' },
                        { level: '23.6%', price: swingHigh - swingRange * 0.236, color: '#8B5CF6' },
                        { level: '38.2%', price: swingHigh - swingRange * 0.382, color: '#7C3AED' },
                        { level: '50%', price: swingHigh - swingRange * 0.5, color: '#6D28D9' },
                        { level: '61.8%', price: swingHigh - swingRange * 0.618, color: '#5B21B6' },
                        { level: '78.6%', price: swingHigh - swingRange * 0.786, color: '#4C1D95' },
                        { level: '100%', price: swingLow, color: '#3B0764' },
                      ] : [
                        // DOWN swing: 100% at HIGH, 0% at LOW, Extensions BELOW low (-27%, -62%)
                        { level: '100%', price: swingHigh, color: '#3B0764' },
                        { level: '78.6%', price: swingLow + swingRange * 0.786, color: '#4C1D95' },
                        { level: '61.8%', price: swingLow + swingRange * 0.618, color: '#5B21B6' },
                        { level: '50%', price: swingLow + swingRange * 0.5, color: '#6D28D9' },
                        { level: '38.2%', price: swingLow + swingRange * 0.382, color: '#7C3AED' },
                        { level: '23.6%', price: swingLow + swingRange * 0.236, color: '#8B5CF6' },
                        { level: '0%', price: swingLow, color: '#A78BFA' },
                        { level: '-27%', price: swingLow - swingRange * 0.27, color: '#ff1744' },
                        { level: '-62%', price: swingLow - swingRange * 0.618, color: '#d50000' },
                      ]).map((fib, i) => (
                        <span key={i} style={{ color: fib.color, fontWeight: 500, lineHeight: 1 }}>{fib.level}</span>
                      ))}
                    </div>
                    <div style={{ position: 'relative', width: 12, height: 420, borderRadius: 6, overflow: 'hidden' }}>
                      <div style={{ position: 'absolute', inset: 0, background: 'linear-gradient(to bottom, #A78BFA 0%, #6D28D9 40%, #3B0764 70%, #E040FB 85%, #AA00FF 100%)', opacity: 0.5 }} />
                      {(() => {
                        const swingPos = swingRange > 0 ? (currentPrice - swingLow) / swingRange : 0.5;
                        return (
                          <div style={{
                            position: 'absolute',
                            top: `${Math.min(100, Math.max(0, (1 - swingPos) * 100 * 0.78))}%`,
                            left: '50%',
                            transform: 'translate(-50%, -50%)',
                            width: 18,
                            height: 4,
                            background: '#fff',
                            borderRadius: 2,
                            boxShadow: '0 0 6px #A78BFA',
                            zIndex: 10
                          }} />
                        );
                      })()}
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', justifyContent: 'space-between', height: 420 }}>
                      {(swingDir === 'up' ? [
                        // UP swing: Extensions ABOVE swing high (-27%, -62%), retracement from high down
                        { level: '-62%', price: swingHigh + swingRange * 0.618, color: '#00E676', desc: 'Deep Ext' },
                        { level: '-27%', price: swingHigh + swingRange * 0.27, color: '#69F0AE', desc: 'Extension' },
                        { level: '0%', price: swingHigh, color: '#A78BFA', desc: 'Swing High' },
                        { level: '23.6%', price: swingHigh - swingRange * 0.236, color: '#8B5CF6', desc: '' },
                        { level: '38.2%', price: swingHigh - swingRange * 0.382, color: '#7C3AED', desc: '' },
                        { level: '50%', price: swingHigh - swingRange * 0.5, color: '#6D28D9', desc: '' },
                        { level: '61.8%', price: swingHigh - swingRange * 0.618, color: '#5B21B6', desc: 'Golden' },
                        { level: '78.6%', price: swingHigh - swingRange * 0.786, color: '#4C1D95', desc: '' },
                        { level: '100%', price: swingLow, color: '#3B0764', desc: 'Swing Low' },
                      ] : [
                        // DOWN swing: 100% at HIGH, 0% at LOW, Extensions BELOW low (-27%, -62%)
                        { level: '100%', price: swingHigh, color: '#3B0764', desc: 'Swing High' },
                        { level: '78.6%', price: swingLow + swingRange * 0.786, color: '#4C1D95', desc: '' },
                        { level: '61.8%', price: swingLow + swingRange * 0.618, color: '#5B21B6', desc: 'Golden' },
                        { level: '50%', price: swingLow + swingRange * 0.5, color: '#6D28D9', desc: '' },
                        { level: '38.2%', price: swingLow + swingRange * 0.382, color: '#7C3AED', desc: '' },
                        { level: '23.6%', price: swingLow + swingRange * 0.236, color: '#8B5CF6', desc: '' },
                        { level: '0%', price: swingLow, color: '#A78BFA', desc: 'Swing Low' },
                        { level: '-27%', price: swingLow - swingRange * 0.27, color: '#ff1744', desc: 'Extension' },
                        { level: '-62%', price: swingLow - swingRange * 0.618, color: '#d50000', desc: 'Deep Ext' },
                      ]).map((fib, i) => {
                        const isNear = Math.abs(currentPrice - fib.price) < (swingRange * 0.03);
                        return (
                          <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 4, lineHeight: 1 }}>
                            <span style={{ fontSize: 10, color: isNear ? '#fff' : '#777', fontWeight: isNear ? 600 : 400, background: isNear ? `${fib.color}30` : 'transparent', padding: isNear ? '1px 3px' : 0, borderRadius: 2 }}>{fib.price.toFixed(2)}</span>
                            <span style={{ fontSize: 7, color: '#555' }}>{fib.desc}</span>
                            {isNear && <span style={{ color: fib.color, fontSize: 8 }}>‚óÑ</span>}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}

              {/* Right: Session Range Location */}
              <div style={{ flex: 1, borderLeft: '1px solid rgba(255,255,255,0.1)', paddingLeft: 20 }}>
                <div style={{ fontSize: 10, color: '#888', marginBottom: 10 }}>Session Range Location</div>
                {(() => {
                  // Thin bar session card component
                  const SessionCard = ({ name, timeRange, color, isActive, high, low, hasData }) => {
                    const range = high - low;
                    const pos = range > 0 ? (currentPrice - low) / range : null;
                    const clamped = pos !== null ? Math.min(1, Math.max(0, pos)) : null;
                    const zone = pos !== null ? getRangeZone(clamped, pos) : null;
                    const showBar = hasData && high > 0 && low > 0 && range > 0;

                    return (
                      <div style={{
                        background: isActive ? `${color}12` : 'rgba(0,0,0,0.25)',
                        border: `1px solid ${isActive ? `${color}60` : 'rgba(255,255,255,0.06)'}`,
                        borderRadius: 8,
                        padding: '8px 10px',
                        flex: '1 1 0',
                        minWidth: 0
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 6 }}>
                          <div>
                            <div style={{ fontSize: 9, color: color, fontWeight: 600 }}>{name}</div>
                            <div style={{ fontSize: 7, color: '#555' }}>{timeRange}</div>
                          </div>
                          {isActive && <span style={{ fontSize: 6, background: color, color: '#000', padding: '2px 4px', borderRadius: 3, fontWeight: 700 }}>LIVE</span>}
                        </div>
                        {showBar ? (
                          <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>
                            <div style={{ position: 'relative', width: 6, height: 140, borderRadius: 3, overflow: 'hidden' }}>
                              <div style={{ position: 'absolute', inset: 0, background: 'linear-gradient(to bottom, #ff4466 0%, #f97316 25%, #666 50%, #00bcd4 75%, #00ff88 100%)', opacity: 0.5 }} />
                              <div style={{
                                position: 'absolute',
                                top: `${Math.min(100, Math.max(0, (1 - clamped) * 100))}%`,
                                left: '50%',
                                transform: 'translate(-50%, -50%)',
                                width: 10,
                                height: 3,
                                background: color,
                                borderRadius: 2,
                                boxShadow: `0 0 4px ${color}`,
                              }} />
                            </div>
                            <div style={{ flex: 1, fontSize: 8, display: 'flex', flexDirection: 'column', justifyContent: 'space-between', height: 140 }}>
                              <div style={{ color: '#ff4466', fontWeight: 500 }}>{high.toFixed(2)}</div>
                              <div>
                                <div style={{ color: zone?.color, fontWeight: 600, fontSize: 7 }}>{zone?.zone}</div>
                                <div style={{ color: '#888', fontSize: 7 }}>{(clamped * 100).toFixed(0)}%</div>
                              </div>
                              <div style={{ color: '#00ff88', fontWeight: 500 }}>{low.toFixed(2)}</div>
                            </div>
                          </div>
                        ) : (
                          <div style={{ fontSize: 8, color: '#444', textAlign: 'center', padding: '45px 0' }}>
                            {isActive ? 'Building...' : hasData ? 'No data' : 'Waiting'}
                          </div>
                        )}
                      </div>
                    );
                  };

                  // Get ended sessions and IBS from liveData (Databento)
                  // API returns snake_case: ended_sessions, ibs
                  const endedSessions = metrics.ended_sessions || metrics.endedSessions || {};
                  const ibs = metrics.ibs || {};

                  // London session data from Databento (3:00-6:00 ET)
                  const londonSession = endedSessions.london || {};
                  let londonHigh = londonSession.high || 0;
                  let londonLow = (londonSession.low && londonSession.low > 0 && londonSession.low < 999999) ? londonSession.low : 0;
                  // Also check London IB from ibs (03:00-04:00)
                  const londonIB = ibs.london || {};
                  if (londonIB.high > 0) londonHigh = Math.max(londonHigh, londonIB.high);
                  if (londonIB.low > 0 && londonIB.low < 999999) londonLow = londonLow > 0 ? Math.min(londonLow, londonIB.low) : londonIB.low;
                  // If still in London session, include current session
                  if (isLondonActive && metrics.sessionHigh > 0) {
                    londonHigh = Math.max(londonHigh, metrics.sessionHigh);
                  }
                  if (isLondonActive && metrics.sessionLow > 0 && metrics.sessionLow < 999999) {
                    londonLow = londonLow > 0 ? Math.min(londonLow, metrics.sessionLow) : metrics.sessionLow;
                  }

                  // NY 1H session data from Databento (9:30-10:30)
                  const ny1hSession = endedSessions.ny_1h || {};
                  const ny1hHigh = ny1hSession.high || (isNY1HActive ? metrics.sessionHigh : 0);
                  const ny1hLow = ny1hSession.low || (isNY1HActive ? metrics.sessionLow : 0);

                  // NY 2H session data from Databento (10:30-11:30)
                  const ny2hSession = endedSessions.ny_2h || {};
                  const ny2hHigh = ny2hSession.high || (isNY2HActive ? metrics.sessionHigh : 0);
                  const ny2hLow = ny2hSession.low || (isNY2HActive ? metrics.sessionLow : 0);

                  // US IB from Databento (08:20-09:30)
                  const usIB = ibs.us || {};
                  const usIBEnded = endedSessions.us_ib || {};
                  const usIBHigh = usIB.high || usIBEnded.high || 0;
                  const usIBLow = (usIB.low && usIB.low > 0 && usIB.low < 999999) ? usIB.low :
                                  (usIBEnded.low && usIBEnded.low > 0 ? usIBEnded.low : 0);

                  // Overnight: 18:00 - 8:20 ET (calculated from individual sessions)
                  // Combine: pre_asia, asia_open, asia_close, low_volume, london, pre_us
                  let overnightHigh = 0;
                  let overnightLow = 999999;
                  ['pre_asia', 'asia_open', 'asia_close', 'low_volume', 'london', 'pre_us'].forEach(sessId => {
                    const sess = endedSessions[sessId];
                    if (sess?.high > 0) overnightHigh = Math.max(overnightHigh, sess.high);
                    if (sess?.low > 0 && sess?.low < 999999) overnightLow = Math.min(overnightLow, sess.low);
                  });
                  // If still in overnight session, include current session high/low
                  const isOvernightActive = timeVal >= 1800 || timeVal < 820; // 18:00 to 8:20 ET
                  if (isOvernightActive && metrics.sessionHigh > 0) {
                    overnightHigh = Math.max(overnightHigh, metrics.sessionHigh);
                  }
                  if (isOvernightActive && metrics.sessionLow > 0 && metrics.sessionLow < 999999) {
                    overnightLow = Math.min(overnightLow, metrics.sessionLow);
                  }
                  if (overnightLow === 999999) overnightLow = 0;

                  // NY Session: 9:30 - 17:00 ET (combine ny_1h, ny_2h, lunch, ny_pm, ny_close)
                  // Calculate from ended sessions if available
                  let nySessionHigh = 0;
                  let nySessionLow = 999999;
                  ['ny_1h', 'ny_2h', 'lunch', 'ny_pm', 'ny_close'].forEach(sessId => {
                    const sess = endedSessions[sessId];
                    if (sess?.high > 0) nySessionHigh = Math.max(nySessionHigh, sess.high);
                    if (sess?.low > 0 && sess?.low < 999999) nySessionLow = Math.min(nySessionLow, sess.low);
                  });
                  // If still in NY session, use current session high/low
                  const isNYSessionActive = timeVal >= 930 && timeVal < 1700;
                  if (isNYSessionActive && metrics.sessionHigh > 0) {
                    nySessionHigh = Math.max(nySessionHigh, metrics.sessionHigh);
                  }
                  if (isNYSessionActive && metrics.sessionLow > 0 && metrics.sessionLow < 999999) {
                    nySessionLow = Math.min(nySessionLow, metrics.sessionLow);
                  }
                  if (nySessionLow === 999999) nySessionLow = 0;

                  return (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {/* Row 1: Overnight & NY Session */}
                      <div style={{ display: 'flex', gap: 8 }}>
                        <SessionCard name="Overnight" timeRange="18:00-8:20" color="#8b5cf6" isActive={isOvernightActive} high={overnightHigh} low={overnightLow} hasData={overnightHigh > 0} />
                        <SessionCard name="NY Session" timeRange="9:30-17:00" color="#f59e0b" isActive={isNYSessionActive} high={nySessionHigh} low={nySessionLow} hasData={nySessionHigh > 0} />
                      </div>
                      {/* Row 2: London, US IB, NY 1H, NY 2H */}
                      <div style={{ display: 'flex', gap: 8 }}>
                        <SessionCard name="London" timeRange="3:00-6:00" color="#a855f7" isActive={isLondonActive} high={londonHigh} low={londonLow} hasData={londonHigh > 0} />
                        <SessionCard name="US IB" timeRange="8:20-9:30" color="#ffaa00" isActive={isUSIBActive} high={usIBHigh} low={usIBLow} hasData={usIBHigh > 0} />
                        <SessionCard name="NY 1H" timeRange="9:30-10:30" color="#10B981" isActive={isNY1HActive} high={ny1hHigh} low={ny1hLow} hasData={ny1hHigh > 0} />
                        <SessionCard name="NY 2H" timeRange="10:30-11:30" color="#06B6D4" isActive={isNY2HActive} high={ny2hHigh} low={ny2hLow} hasData={ny2hHigh > 0} />
                      </div>
                    </div>
                  );
                })()}
              </div>
            </div>

            {/* Nearest Fib Level Callout */}
            {nearestFib.price && dayRange > 0 && (
              <div style={{
                marginTop: 16,
                padding: 12,
                background: `${nearestFib.color}15`,
                border: `1px solid ${nearestFib.color}50`,
                borderRadius: 10,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between'
              }}>
                <div>
                  <div style={{ fontSize: 10, color: '#888' }}>Nearest Fibonacci Level</div>
                  <div style={{ fontSize: 14, color: nearestFib.color, fontWeight: 700 }}>
                    {nearestFib.level} @ {nearestFib.price.toFixed(2)}
                  </div>
                </div>
                <div style={{ textAlign: 'right' }}>
                  <div style={{ fontSize: 10, color: '#888' }}>Distance</div>
                  <div style={{ fontSize: 14, color: currentPrice > nearestFib.price ? '#00ff88' : '#ff4466', fontWeight: 700 }}>
                    {currentPrice > nearestFib.price ? '+' : ''}{(currentPrice - nearestFib.price).toFixed(2)}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      })()}

      {/* Market Pulse - Gamma Regime & Volatility Analysis */}
      <div style={{ marginTop: 20 }}>
        <MarketPulse gexData={gexData} currentPrice={metrics.current_price} />
      </div>

      {/* Full GEX Profile Panel - ohmygamma style */}
      <div style={{ marginTop: 20 }}>
        <GEXPanel gexData={gexData} currentPrice={metrics.current_price} />
      </div>

      {/* Contract Rollover Indicator - Always show */}
      {(() => {
        const rollover = metrics.rollover || {};
        return (
        <div style={{
          marginTop: 20,
          padding: 16,
          background: 'linear-gradient(135deg, rgba(30,30,35,0.95) 0%, rgba(20,20,25,0.98) 100%)',
          borderRadius: 12,
          border: `1px solid ${
            rollover.roll_signal === 'ROLL' ? '#ef4444' :
            rollover.roll_signal === 'CONSIDER' ? '#f59e0b' : '#333'
          }`
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: 16 }}>üìä</span>
              <span style={{ fontSize: 12, fontWeight: 600, color: '#fff' }}>CONTRACT ROLLOVER</span>
            </div>
            <div style={{
              padding: '4px 12px',
              borderRadius: 6,
              fontSize: 11,
              fontWeight: 700,
              background: rollover.roll_signal === 'ROLL' ? 'rgba(239,68,68,0.2)' :
                         rollover.roll_signal === 'CONSIDER' ? 'rgba(245,158,11,0.2)' : 'rgba(34,197,94,0.2)',
              color: rollover.roll_signal === 'ROLL' ? '#ef4444' :
                     rollover.roll_signal === 'CONSIDER' ? '#f59e0b' : '#22c55e',
              border: `1px solid ${
                rollover.roll_signal === 'ROLL' ? '#ef4444' :
                rollover.roll_signal === 'CONSIDER' ? '#f59e0b' : '#22c55e'
              }40`
            }}>
              {rollover.roll_signal === 'ROLL' ? 'üîÑ ROLL NOW' :
               rollover.roll_signal === 'CONSIDER' ? '‚ö†Ô∏è CONSIDER ROLLING' : '‚úì HOLD'}
            </div>
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 80px 1fr', gap: 16, alignItems: 'center' }}>
            {/* Front Month */}
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>CURRENT</div>
              <div style={{ fontSize: 14, fontWeight: 700, color: '#00aaff' }}>
                {rollover.front_month || metrics.contract || 'GCG26'}
              </div>
              <div style={{ fontSize: 9, color: '#666', marginTop: 2 }}>
                {rollover.front_month_name || 'Gold Feb 2026'}
              </div>
              <div style={{ fontSize: 18, fontWeight: 700, color: rollover.front_month_oi > 0 ? '#fff' : '#555', marginTop: 8, fontFamily: 'monospace' }}>
                {rollover.front_month_oi > 0 ? rollover.front_month_oi.toLocaleString() : '‚Äî'}
              </div>
              <div style={{ fontSize: 9, color: '#888' }}>{rollover.front_month_oi > 0 ? 'Open Interest' : 'Loading OI...'}</div>
            </div>

            {/* Arrow & Ratio */}
            <div style={{ textAlign: 'center' }}>
              <div style={{
                fontSize: 24,
                color: rollover.oi_ratio >= 1 ? '#ef4444' :
                       rollover.oi_ratio >= 0.75 ? '#f59e0b' : '#22c55e'
              }}>
                {rollover.oi_ratio >= 1 ? '‚üπ' : '‚Üí'}
              </div>
              <div style={{
                fontSize: 16,
                fontWeight: 700,
                color: rollover.oi_ratio >= 1 ? '#ef4444' :
                       rollover.oi_ratio >= 0.75 ? '#f59e0b' : '#22c55e',
                fontFamily: 'monospace'
              }}>
                {((rollover.oi_ratio || 0) * 100).toFixed(0)}%
              </div>
              <div style={{ fontSize: 8, color: '#666' }}>Next/Current</div>
            </div>

            {/* Next Month */}
            <div style={{ textAlign: 'center' }}>
              <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>NEXT</div>
              <div style={{ fontSize: 14, fontWeight: 700, color: rollover.oi_ratio >= 1 ? '#ef4444' : '#f59e0b' }}>
                {rollover.next_month || 'GCJ26'}
              </div>
              <div style={{ fontSize: 9, color: '#666', marginTop: 2 }}>
                {rollover.next_month_name || 'Gold Apr 2026'}
              </div>
              <div style={{ fontSize: 18, fontWeight: 700, color: rollover.next_month_oi > 0 ? '#fff' : '#555', marginTop: 8, fontFamily: 'monospace' }}>
                {rollover.next_month_oi > 0 ? rollover.next_month_oi.toLocaleString() : '‚Äî'}
              </div>
              <div style={{ fontSize: 9, color: '#888' }}>{rollover.next_month_oi > 0 ? 'Open Interest' : 'Loading OI...'}</div>
            </div>
          </div>

          {/* Progress Bar */}
          <div style={{ marginTop: 16 }}>
            <div style={{
              height: 8,
              background: 'rgba(255,255,255,0.1)',
              borderRadius: 4,
              overflow: 'hidden',
              position: 'relative'
            }}>
              <div style={{
                width: `${Math.min((rollover.oi_ratio || 0) * 100, 100)}%`,
                height: '100%',
                background: rollover.oi_ratio >= 1 ?
                  'linear-gradient(90deg, #ef4444, #dc2626)' :
                  rollover.oi_ratio >= 0.75 ?
                  'linear-gradient(90deg, #f59e0b, #d97706)' :
                  'linear-gradient(90deg, #22c55e, #16a34a)',
                transition: 'width 0.5s ease'
              }} />
              {/* 75% marker */}
              <div style={{
                position: 'absolute',
                left: '75%',
                top: 0,
                bottom: 0,
                width: 2,
                background: '#f59e0b',
                opacity: 0.5
              }} />
              {/* 100% marker */}
              <div style={{
                position: 'absolute',
                left: '100%',
                top: 0,
                bottom: 0,
                width: 2,
                background: '#ef4444',
                opacity: 0.5
              }} />
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 4 }}>
              <span style={{ fontSize: 8, color: '#666' }}>0%</span>
              <span style={{ fontSize: 8, color: '#f59e0b' }}>75% Consider</span>
              <span style={{ fontSize: 8, color: '#ef4444' }}>100% Roll</span>
            </div>
          </div>

          {/* Last Update */}
          {rollover.last_update && (
            <div style={{ marginTop: 12, textAlign: 'center', fontSize: 9, color: '#555' }}>
              OI Updated: {rollover.last_update}
            </div>
          )}
        </div>
      );
      })()}
    </div>
  );
};

// Backtest Dashboard Component - Condensed Layout with Deep Analytics
const BacktestDashboard = ({ data, trades, dateRange, setDateRange, extendedData }) => {
  const [selectedYear, setSelectedYear] = useState(2025);
  const [pendingDateRange, setPendingDateRange] = useState(dateRange);
  const [activeSection, setActiveSection] = useState('overview');
  const [hoveredEquityPoint, setHoveredEquityPoint] = useState(null);
  const [hoveredTpo, setHoveredTpo] = useState(null);
  const [hoveredWyckoff, setHoveredWyckoff] = useState(null);

  // Extract extended data including feature statistics
  const { metadata, sessions, volumeProfiles, bigVolumeDays, supportResistance, seasonality, dailyCandles, featureStatistics, distributions } = extendedData || {};

  useEffect(() => {
    if (data.yearly_pnl?.length > 0 && !data.yearly_pnl.find(y => y.year === selectedYear)) {
      setSelectedYear(data.yearly_pnl[data.yearly_pnl.length - 1].year);
    }
  }, [data.yearly_pnl, selectedYear]);

  const handleApplyFilter = () => setDateRange(pendingDateRange);
  const handleResetFilter = () => {
    const defaultRange = { start: metadata?.data_range?.start || '2021-01-27', end: metadata?.data_range?.end || '2026-01-27' };
    setPendingDateRange(defaultRange);
    setDateRange(defaultRange);
  };

  // Calculate metrics
  const totalDays = sessions?.length || 0;
  const bullishDays = sessions?.filter(s => s.direction === 'bullish').length || 0;
  const bearishDays = sessions?.filter(s => s.direction === 'bearish').length || 0;
  const avgRange = sessions?.length ? (sessions.reduce((sum, s) => sum + (s.range || 0), 0) / sessions.length).toFixed(2) : 0;
  const avgVolume = sessions?.length ? Math.round(sessions.reduce((sum, s) => sum + (s.volume || 0), 0) / sessions.length) : 0;

  // Calculate equity curve with drawdown and profit metrics
  const equityData = useMemo(() => {
    if (!trades?.length) return [];
    let equity = 100000;
    let peak = equity;
    let maxDDSoFar = 0;  // Track worst drawdown experienced so far
    return trades.map((t, i) => {
      equity += t.pnl || 0;
      peak = Math.max(peak, equity);
      const fromPeak = peak - equity;  // Dollar amount below peak
      const drawdownPct = peak > 0 ? (fromPeak / peak) * 100 : 0;
      maxDDSoFar = Math.max(maxDDSoFar, drawdownPct);  // Track max DD seen
      const totalProfit = equity - 100000;  // Total profit from start
      const totalProfitPct = (totalProfit / 100000) * 100;
      return {
        date: t.date,
        equity,
        peak,
        fromPeak,  // $ below peak
        drawdown: drawdownPct,  // % below peak (0 when at peak)
        maxDrawdownSoFar: maxDDSoFar,  // Worst DD experienced up to this point
        totalProfit,
        totalProfitPct,
        pnl: t.pnl,
        trade: t,
        index: i
      };
    });
  }, [trades]);

  const maxDrawdown = equityData.length ? Math.max(...equityData.map(e => e.drawdown)) : 0;
  const finalEquity = equityData.length ? equityData[equityData.length - 1].equity : 100000;
  const totalReturn = ((finalEquity - 100000) / 100000) * 100;

  // Win/Loss analysis
  const winners = trades?.filter(t => t.pnl > 0) || [];
  const losers = trades?.filter(t => t.pnl <= 0) || [];
  const avgWin = winners.length ? winners.reduce((s, t) => s + t.pnl, 0) / winners.length : 0;
  const avgLoss = losers.length ? Math.abs(losers.reduce((s, t) => s + t.pnl, 0) / losers.length) : 0;
  const avgRisk = trades?.length ? trades.reduce((s, t) => s + Math.abs((t.entry || 0) - (t.stop_loss || 0)), 0) / trades.length * 100 : 0;

  // Section navigation
  const sections = [
    { id: 'overview', label: 'Overview', icon: 'üìä' },
    { id: 'analytics', label: 'Deep Analytics', icon: 'üî¨' },
    { id: 'features', label: 'Feature Analysis', icon: 'üéØ' },
    { id: 'phase', label: 'Phase Detection', icon: 'üîÑ' },
    { id: 'matrix', label: 'Matrix Analysis', icon: 'üßÆ' },
    { id: 'seasonality', label: 'Seasonality', icon: 'üìÖ' },
    { id: 'trades', label: 'Trade Log', icon: 'üìã' }
  ];

  // Helper to render metric card
  const MetricCard = ({ label, value, color, sub }) => (
    <div style={{ background: 'rgba(0,0,0,0.4)', borderRadius: 8, padding: '10px 12px', borderLeft: `3px solid ${color}` }}>
      <div style={{ fontSize: 9, color: '#666', textTransform: 'uppercase', letterSpacing: 0.5 }}>{label}</div>
      <div style={{ fontSize: 18, fontWeight: 700, color }}>{value}</div>
      {sub && <div style={{ fontSize: 9, color: '#555' }}>{sub}</div>}
    </div>
  );

  // TPO Card with cursor-following tooltip
  const TpoCard = ({ type, count, total, setHoveredTpo }) => {
    const tpoVisuals = {
      'P-shape': { desc: 'Rally Day - Close near high. Price spent most time in upper range, indicating buying pressure.', signal: 'Bullish', color: '#00ff88', svg: (
        <svg width="70" height="55" viewBox="0 0 70 55">
          <rect x="8" y="40" width="10" height="8" fill="#8b5cf6" opacity="0.3" rx="1"/>
          <rect x="20" y="28" width="10" height="18" fill="#8b5cf6" opacity="0.5" rx="1"/>
          <rect x="32" y="12" width="10" height="32" fill="#8b5cf6" opacity="0.8" rx="1"/>
          <rect x="44" y="6" width="10" height="22" fill="#8b5cf6" rx="1"/>
          <path d="M8 44 Q35 50 58 12" stroke="#00ff88" strokeWidth="2" fill="none" strokeLinecap="round"/>
          <circle cx="58" cy="12" r="3" fill="#00ff88"/>
        </svg>
      )},
      'b-shape': { desc: 'Selloff Day - Close near low. Price spent most time in lower range, indicating selling pressure.', signal: 'Bearish', color: '#ff4466', svg: (
        <svg width="70" height="55" viewBox="0 0 70 55">
          <rect x="8" y="6" width="10" height="22" fill="#8b5cf6" rx="1"/>
          <rect x="20" y="12" width="10" height="32" fill="#8b5cf6" opacity="0.8" rx="1"/>
          <rect x="32" y="28" width="10" height="18" fill="#8b5cf6" opacity="0.5" rx="1"/>
          <rect x="44" y="40" width="10" height="8" fill="#8b5cf6" opacity="0.3" rx="1"/>
          <path d="M8 12 Q35 6 58 44" stroke="#ff4466" strokeWidth="2" fill="none" strokeLinecap="round"/>
          <circle cx="58" cy="44" r="3" fill="#ff4466"/>
        </svg>
      )},
      'D-shape': { desc: 'Balanced Day - Normal bell curve distribution. Market in equilibrium, fair value found.', signal: 'Neutral', color: '#f97316', svg: (
        <svg width="70" height="55" viewBox="0 0 70 55">
          <rect x="8" y="35" width="10" height="10" fill="#8b5cf6" opacity="0.3" rx="1"/>
          <rect x="20" y="22" width="10" height="22" fill="#8b5cf6" opacity="0.6" rx="1"/>
          <rect x="32" y="10" width="10" height="35" fill="#8b5cf6" rx="1"/>
          <rect x="44" y="22" width="10" height="22" fill="#8b5cf6" opacity="0.6" rx="1"/>
          <line x1="5" y1="27" x2="65" y2="27" stroke="#f97316" strokeWidth="2" strokeDasharray="4,2"/>
          <text x="35" y="52" fontSize="8" fill="#f97316" textAnchor="middle">POC</text>
        </svg>
      )},
      'B-shape': { desc: 'Double Distribution - Two value areas formed. Often signals trend change or balance break.', signal: 'Reversal', color: '#f97316', svg: (
        <svg width="70" height="55" viewBox="0 0 70 55">
          <rect x="8" y="8" width="10" height="16" fill="#8b5cf6" rx="1"/>
          <rect x="20" y="14" width="10" height="8" fill="#8b5cf6" opacity="0.4" rx="1"/>
          <rect x="32" y="22" width="10" height="8" fill="#8b5cf6" opacity="0.2" rx="1"/>
          <rect x="44" y="32" width="10" height="16" fill="#8b5cf6" rx="1"/>
          <circle cx="13" cy="16" r="4" fill="none" stroke="#f97316" strokeWidth="2"/>
          <circle cx="49" cy="40" r="4" fill="none" stroke="#f97316" strokeWidth="2"/>
          <text x="35" y="52" fontSize="7" fill="#888" textAnchor="middle">2 Value Areas</text>
        </svg>
      )},
      'elongated_up': { desc: 'Strong Uptrend - Elongated profile showing sustained buying. Very bullish momentum.', signal: 'Very Bullish', color: '#00ff88', svg: (
        <svg width="70" height="55" viewBox="0 0 70 55">
          <rect x="15" y="6" width="40" height="10" fill="#00ff88" rx="2"/>
          <rect x="20" y="18" width="30" height="8" fill="#00ff88" opacity="0.7" rx="1"/>
          <rect x="25" y="28" width="20" height="6" fill="#00ff88" opacity="0.4" rx="1"/>
          <path d="M10 48 L60 8" stroke="#00ff88" strokeWidth="2.5" strokeLinecap="round"/>
          <polygon points="60,8 52,12 56,16" fill="#00ff88"/>
        </svg>
      )},
      'elongated_down': { desc: 'Strong Downtrend - Elongated profile showing sustained selling. Very bearish momentum.', signal: 'Very Bearish', color: '#ff4466', svg: (
        <svg width="70" height="55" viewBox="0 0 70 55">
          <rect x="25" y="6" width="20" height="6" fill="#ff4466" opacity="0.4" rx="1"/>
          <rect x="20" y="14" width="30" height="8" fill="#ff4466" opacity="0.7" rx="1"/>
          <rect x="15" y="24" width="40" height="10" fill="#ff4466" rx="2"/>
          <path d="M10 8 L60 48" stroke="#ff4466" strokeWidth="2.5" strokeLinecap="round"/>
          <polygon points="60,48 52,44 56,40" fill="#ff4466"/>
        </svg>
      )},
      'single_print': { desc: 'Single Print Gap - Low volume area indicating weak support/resistance. Often gets filled.', signal: 'Gap Fill', color: '#f97316', svg: (
        <svg width="70" height="55" viewBox="0 0 70 55">
          <rect x="20" y="6" width="30" height="14" fill="#8b5cf6" rx="2"/>
          <rect x="30" y="24" width="4" height="6" fill="#f97316" opacity="0.5"/>
          <rect x="20" y="34" width="30" height="14" fill="#8b5cf6" rx="2"/>
          <text x="35" y="29" fontSize="9" fill="#f97316" textAnchor="middle" fontWeight="bold">GAP</text>
          <path d="M50 20 L55 27 L50 34" stroke="#f97316" strokeWidth="1.5" fill="none" strokeDasharray="2"/>
        </svg>
      )}
    };
    const visual = tpoVisuals[type] || { desc: 'Market profile type', signal: 'N/A', color: '#888', svg: <svg width="70" height="55"><text x="35" y="30" fontSize="12" fill="#666" textAnchor="middle">?</text></svg> };
    const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;

    return (
      <div
        style={{ display: 'inline-block', cursor: 'context-menu' }}
        onContextMenu={(e) => {
          e.preventDefault();
          setHoveredTpo({ type, count, pct, visual, x: e.clientX, y: e.clientY });
        }}
      >
        <div style={{ background: 'rgba(139,92,246,0.1)', borderRadius: 8, padding: 10, textAlign: 'center', border: '1px solid rgba(139,92,246,0.3)' }}>
          <div style={{ fontSize: 18, fontWeight: 800, color: '#8b5cf6' }}>{count}</div>
          <div style={{ fontSize: 9, color: '#888' }}>{formatMetricName(type)}</div>
        </div>
      </div>
    );
  };

  // Wyckoff Card with cursor-following tooltip
  const WyckoffCard = ({ phase, count, total, setHoveredWyckoff }) => {
    const wyckoffVisuals = {
      'accumulation': { desc: 'Smart money buying at lows after downtrend. Price consolidates in range while institutions accumulate positions quietly.', signal: 'Bullish Setup', color: '#00ff88', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <path d="M5 8 L20 38" stroke="#ff4466" strokeWidth="2" fill="none"/>
          <rect x="20" y="32" width="50" height="14" fill="rgba(0,255,136,0.1)" stroke="#00ff88" strokeWidth="1.5" strokeDasharray="3" rx="2"/>
          <path d="M25 38 L35 35 L45 40 L55 36 L65 42" stroke="#888" strokeWidth="1.5" fill="none"/>
          <path d="M65 35 L75 15" stroke="#00ff88" strokeWidth="2" strokeDasharray="4" fill="none"/>
          <polygon points="75,15 70,22 73,20" fill="#00ff88"/>
        </svg>
      )},
      'distribution': { desc: 'Smart money selling at highs after uptrend. Price consolidates while institutions distribute positions to retail.', signal: 'Bearish Setup', color: '#ff4466', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <path d="M5 42 L20 12" stroke="#00ff88" strokeWidth="2" fill="none"/>
          <rect x="20" y="6" width="50" height="14" fill="rgba(255,68,102,0.1)" stroke="#ff4466" strokeWidth="1.5" strokeDasharray="3" rx="2"/>
          <path d="M25 12 L35 15 L45 10 L55 14 L65 8" stroke="#888" strokeWidth="1.5" fill="none"/>
          <path d="M65 15 L75 35" stroke="#ff4466" strokeWidth="2" strokeDasharray="4" fill="none"/>
          <polygon points="75,35 70,28 73,30" fill="#ff4466"/>
        </svg>
      )},
      'markup': { desc: 'Uptrend phase following accumulation. Strong buying pressure with higher highs and higher lows.', signal: 'Buy & Hold', color: '#00ff88', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <path d="M5 45 L20 38 L35 42 L50 30 L65 25 L75 10" stroke="#00ff88" strokeWidth="3" fill="none" strokeLinecap="round"/>
          <path d="M5 48 L75 20" stroke="#00ff88" strokeWidth="1" opacity="0.3" strokeDasharray="4"/>
          <polygon points="75,10 68,15 70,18" fill="#00ff88"/>
          <text x="40" y="48" fontSize="8" fill="#00ff88" textAnchor="middle" fontWeight="bold">MARKUP ‚Üë</text>
        </svg>
      )},
      'markdown': { desc: 'Downtrend phase following distribution. Strong selling pressure with lower highs and lower lows.', signal: 'Sell & Avoid', color: '#ff4466', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <path d="M5 10 L20 15 L35 12 L50 25 L65 30 L75 45" stroke="#ff4466" strokeWidth="3" fill="none" strokeLinecap="round"/>
          <path d="M5 7 L75 35" stroke="#ff4466" strokeWidth="1" opacity="0.3" strokeDasharray="4"/>
          <polygon points="75,45 68,40 70,37" fill="#ff4466"/>
          <text x="40" y="8" fontSize="8" fill="#ff4466" textAnchor="middle" fontWeight="bold">MARKDOWN ‚Üì</text>
        </svg>
      )},
      're_accumulation': { desc: 'Pause within uptrend for more accumulation. Institutions adding to long positions before next leg up.', signal: 'Continue Long', color: '#00bcd4', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <path d="M5 42 L22 28" stroke="#00ff88" strokeWidth="2" fill="none"/>
          <rect x="22" y="22" width="30" height="12" fill="rgba(0,188,212,0.15)" stroke="#00bcd4" strokeWidth="1.5" strokeDasharray="3" rx="2"/>
          <path d="M52 25 L75 8" stroke="#00ff88" strokeWidth="2" fill="none"/>
          <polygon points="75,8 68,12 70,15" fill="#00ff88"/>
        </svg>
      )},
      're_distribution': { desc: 'Pause within downtrend for more distribution. Institutions adding to short positions before next leg down.', signal: 'Continue Short', color: '#f97316', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <path d="M5 8 L22 22" stroke="#ff4466" strokeWidth="2" fill="none"/>
          <rect x="22" y="18" width="30" height="12" fill="rgba(249,115,22,0.15)" stroke="#f97316" strokeWidth="1.5" strokeDasharray="3" rx="2"/>
          <path d="M52 25 L75 42" stroke="#ff4466" strokeWidth="2" fill="none"/>
          <polygon points="75,42 68,38 70,35" fill="#ff4466"/>
        </svg>
      )},
      'trending': { desc: 'Clear directional movement with strong momentum. Follow the trend until signs of exhaustion.', signal: 'Follow Trend', color: '#00bcd4', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <path d="M5 40 L75 10" stroke="#00bcd4" strokeWidth="2.5" strokeLinecap="round"/>
          <path d="M5 44 L75 14" stroke="#00bcd4" strokeWidth="1" opacity="0.4"/>
          <path d="M5 36 L75 6" stroke="#00bcd4" strokeWidth="1" opacity="0.4"/>
          <polygon points="75,10 68,14 70,17" fill="#00bcd4"/>
        </svg>
      )},
      'consolidation': { desc: 'Sideways range-bound price action. Market undecided, wait for breakout direction.', signal: 'Wait for Break', color: '#888', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50">
          <line x1="5" y1="15" x2="75" y2="15" stroke="#666" strokeWidth="1.5" strokeDasharray="4"/>
          <line x1="5" y1="35" x2="75" y2="35" stroke="#666" strokeWidth="1.5" strokeDasharray="4"/>
          <path d="M8 25 L20 20 L32 28 L44 22 L56 30 L68 24 L75 26" stroke="#f97316" strokeWidth="2" fill="none"/>
          <text x="40" y="46" fontSize="7" fill="#888" textAnchor="middle">RANGE BOUND</text>
        </svg>
      )},
      'unknown': { desc: 'Unclear market structure. Avoid trading until clearer pattern emerges.', signal: 'No Trade', color: '#666', svg: (
        <svg width="80" height="50" viewBox="0 0 80 50"><text x="40" y="32" fontSize="24" fill="#666" textAnchor="middle">?</text></svg>
      )}
    };
    const visual = wyckoffVisuals[phase] || wyckoffVisuals['unknown'];
    const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;

    return (
      <div
        style={{ display: 'inline-block', cursor: 'context-menu' }}
        onContextMenu={(e) => {
          e.preventDefault();
          setHoveredWyckoff({ phase, count, pct, visual, x: e.clientX, y: e.clientY });
        }}
      >
        <div style={{ background: 'rgba(0,188,212,0.1)', borderRadius: 8, padding: 10, textAlign: 'center', border: '1px solid rgba(0,188,212,0.3)' }}>
          <div style={{ fontSize: 18, fontWeight: 800, color: '#00bcd4' }}>{count}</div>
          <div style={{ fontSize: 9, color: '#888' }}>{phase.replace(/_/g, ' ')}</div>
        </div>
      </div>
    );
  };

  // Format metric names properly
  const formatMetricName = (name) => {
    if (!name) return '';
    // Handle specific cases
    const nameMap = {
      'P-shape': 'P-Shape (Rally)',
      'b-shape': 'b-Shape (Selloff)',
      'D-shape': 'D-Shape (Balanced)',
      'B-shape': 'B-Shape (Double)',
      'elongated_up': 'Elongated Up',
      'elongated_down': 'Elongated Down',
      'single_print': 'Single Print',
      'no_demand': 'No Demand',
      'no_supply': 'No Supply',
      'climax_bullish': 'Bullish Climax',
      'climax_bearish': 'Bearish Climax',
      'high_volume': 'High Volume',
      'low_volume': 'Low Volume',
      'absorption': 'Absorption',
      'exhaustion': 'Exhaustion',
      'normal': 'Normal',
      'trending': 'Trending',
      'consolidation': 'Consolidation',
      'accumulation': 'Accumulation',
      'distribution': 'Distribution',
      'markup': 'Markup',
      'markdown': 'Markdown',
      're_accumulation': 'Re-Accumulation',
      're_distribution': 'Re-Distribution',
      'unknown': 'Unknown',
      'vsa_no_effort_result': 'VSA: No Effort Result',
      'vsa_effort_no_result': 'VSA: Effort No Result',
      'cvd_bearish_divergence': 'CVD Bearish Divergence',
      'cvd_bullish_divergence': 'CVD Bullish Divergence',
      'big_trade_bullish': 'Big Trade (Bullish)',
      'big_trade_bearish': 'Big Trade (Bearish)',
      'delta_imbalance_bullish': 'Delta Imbalance (Bull)',
      'delta_imbalance_bearish': 'Delta Imbalance (Bear)',
      'absorption_bullish': 'Absorption (Bullish)',
      'absorption_bearish': 'Absorption (Bearish)',
      'institutional_accumulation': 'Institutional Activity',
      'stop_hunt': 'Stop Hunt',
      'TARGET': 'Target Hit',
      'STOP_LOSS': 'Stop Loss',
      'TIME_EXIT': 'Time Exit',
    };
    return nameMap[name] || name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  };

  // Metric explanations for tooltips
  const metricTooltips = {
    // TPO Types
    'P-shape': 'Close near high, rally day. Often bullish continuation.',
    'b-shape': 'Close near low, selloff day. Often bearish continuation.',
    'D-shape': 'Balanced day, close near middle. Market in equilibrium.',
    'B-shape': 'Double distribution - two value areas. Trend change signal.',
    'elongated_up': 'Strong upward momentum, close in upper range.',
    'elongated_down': 'Strong downward momentum, close in lower range.',
    // Volume
    'no_demand': 'Low volume on up move - lack of buying interest.',
    'no_supply': 'Low volume on down move - lack of selling pressure.',
    'climax_bullish': 'Extreme volume on up move - potential exhaustion.',
    'climax_bearish': 'Extreme volume on down move - potential exhaustion.',
    'absorption': 'High volume, small range - large orders absorbed.',
    'exhaustion': 'Decreasing volume on trend - momentum fading.',
    'normal': 'Average volume with typical price action.',
    'high_volume': 'Above average volume - increased participation.',
    // Wyckoff
    'accumulation': 'Smart money buying at lows. Bullish setup forming.',
    'distribution': 'Smart money selling at highs. Bearish setup forming.',
    'markup': 'Uptrend phase - prices rising with momentum.',
    'markdown': 'Downtrend phase - prices falling with momentum.',
    're_accumulation': 'Pause in uptrend for more accumulation.',
    're_distribution': 'Pause in downtrend for more distribution.',
    // Order Flow Patterns
    'vsa_no_effort_result': 'Volume Spread Analysis: Price moved without matching volume effort.',
    'cvd_bearish_divergence': 'Cumulative Volume Delta diverges bearish from price.',
    'cvd_bullish_divergence': 'Cumulative Volume Delta diverges bullish from price.',
    'stop_hunt': 'Price spiked to trigger stop losses then reversed.',
    'absorption_bullish': 'Large buy orders absorbing selling pressure.',
    'absorption_bearish': 'Large sell orders absorbing buying pressure.',
    'institutional_accumulation': 'Signs of institutional buying activity.',
    'delta_imbalance_bullish': 'Strong buying pressure shown by delta imbalance.',
    'delta_imbalance_bearish': 'Strong selling pressure shown by delta imbalance.',
    'big_trade_bullish': 'Large institutional buy order detected.',
    'big_trade_bearish': 'Large institutional sell order detected.',
    // Exit Reasons
    'TARGET': 'Trade hit profit target - always a winner.',
    'STOP_LOSS': 'Trade hit stop loss - always a loss (risk management).',
    'TIME_EXIT': 'Trade closed at max holding period.',
  };

  // Helper to render feature stat bar with cursor-following tooltip
  const [hoveredFeature, setHoveredFeature] = useState(null);
  const FeatureBar = ({ label, wins, total, pnl, color }) => {
    const wr = total > 0 ? (wins / total * 100).toFixed(0) : 0;
    const formattedLabel = formatMetricName(label);
    const tooltip = metricTooltips[label];

    return (
      <div
        style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '8px 0', borderBottom: '1px solid rgba(255,255,255,0.05)', cursor: 'help' }}
        onMouseMove={(e) => setHoveredFeature({ label, formattedLabel, wr, total, pnl, color, tooltip, x: e.clientX, y: e.clientY })}
        onMouseLeave={() => setHoveredFeature(null)}
      >
        <div style={{ width: 150, fontSize: 11, color: '#ccc' }}>
          {formattedLabel}
        </div>
        <div style={{ flex: 1, background: 'rgba(255,255,255,0.05)', borderRadius: 4, height: 18, position: 'relative', overflow: 'hidden', minWidth: 80 }}>
          <div style={{ position: 'absolute', left: 0, top: 0, bottom: 0, width: `${wr}%`, background: color, borderRadius: 4 }} />
          <div style={{ position: 'absolute', left: 6, top: '50%', transform: 'translateY(-50%)', fontSize: 10, fontWeight: 600, color: '#fff' }}>{wr}%</div>
        </div>
        <div style={{ width: 40, fontSize: 10, color: '#888', textAlign: 'right' }}>{total}</div>
        <div style={{ width: 65, fontSize: 10, color: pnl >= 0 ? '#00ff88' : '#ff4466', textAlign: 'right', fontWeight: 600 }}>${(pnl/1000).toFixed(1)}K</div>
      </div>
    );
  };

  // Info tooltip for section headers - cursor following
  const [hoveredInfo, setHoveredInfo] = useState(null);
  const InfoTooltip = ({ id, title, content, color }) => (
    <span
      style={{ cursor: 'pointer', fontSize: 12, color: '#666', opacity: 0.7, marginLeft: 8 }}
      onMouseMove={(e) => setHoveredInfo({ id, title, content, color, x: e.clientX, y: e.clientY })}
      onMouseLeave={() => setHoveredInfo(null)}
    >‚ìò</span>
  );

  // Metric explanations
  const metricExplanations = {
    tpo: {
      title: 'TPO Profile Types',
      content: 'Time Price Opportunity (TPO) profiles show where price spent the most time. P-shape = rally day (close near high). b-shape = selloff day (close near low). D-shape = balanced day. B-shape = double distribution with two value areas.'
    },
    volume: {
      title: 'Volume Patterns',
      content: 'Volume analysis reveals institutional activity. Climax = extreme volume with large range. Absorption = high volume but small range (accumulation). No Demand/Supply = low volume indicating lack of interest. Exhaustion = decreasing volume on trend continuation.'
    },
    wyckoff: {
      title: 'Wyckoff Phases',
      content: 'Market cycle phases based on Wyckoff methodology. Accumulation = institutional buying at lows. Distribution = institutional selling at highs. Markup = uptrend phase. Markdown = downtrend phase. Re-accumulation/Re-distribution = pauses within trends.'
    },
    orderflow: {
      title: 'Order Flow Patterns',
      content: 'Order flow detects institutional footprints. Big Trades = large volume spikes indicating institutional activity. CVD Divergence = price vs cumulative delta mismatch. Delta Imbalance = strong directional buying/selling pressure. Stop Hunt = price spikes to trigger stops then reverses.'
    },
    exit: {
      title: 'Exit Reasons',
      content: 'How trades were closed. TARGET = price hit profit target (best outcome). TIME_EXIT = closed after max holding period. STOP_LOSS = protective stop triggered (controlled loss). Each exit type has different win rate implications.'
    }
  };

  return (
    <div style={{ background: '#0a0a0f', minHeight: '100vh', padding: 16 }}>
      {/* Compact Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, flexWrap: 'wrap', gap: 12 }}>
        <div>
          <h1 style={{ fontSize: 20, fontWeight: 800, color: '#fff', margin: 0 }}>Horizon Backtest Analytics</h1>
          <p style={{ fontSize: 11, color: '#666', margin: 0 }}>{metadata?.data_range?.start} to {metadata?.data_range?.end} | {trades?.length || 0} trades</p>
        </div>
        <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
          <input type="date" value={pendingDateRange.start} onChange={(e) => setPendingDateRange({ ...pendingDateRange, start: e.target.value })}
            style={{ background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: 6, padding: '6px 10px', color: '#fff', fontSize: 11 }} />
          <span style={{ color: '#666', fontSize: 11 }}>to</span>
          <input type="date" value={pendingDateRange.end} onChange={(e) => setPendingDateRange({ ...pendingDateRange, end: e.target.value })}
            style={{ background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.2)', borderRadius: 6, padding: '6px 10px', color: '#fff', fontSize: 11 }} />
          <button onClick={handleApplyFilter} style={{ background: '#00ff88', border: 'none', borderRadius: 6, padding: '6px 12px', color: '#000', fontWeight: 600, cursor: 'pointer', fontSize: 11 }}>Apply</button>
          <button onClick={handleResetFilter} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: 6, padding: '6px 12px', color: '#888', cursor: 'pointer', fontSize: 11 }}>Reset</button>
        </div>
      </div>

      {/* Top Metrics Strip - All in one row */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(10, 1fr)', gap: 8, marginBottom: 16 }}>
        <MetricCard label="Trades" value={trades?.length || 0} color="#00ff88" />
        <MetricCard label="Win Rate" value={`${((data.summary?.win_rate || 0) * 100).toFixed(1)}%`} color={(data.summary?.win_rate || 0) >= 0.5 ? '#00ff88' : '#ff4466'} sub={`${winners.length}W / ${losers.length}L`} />
        <MetricCard label="Profit Factor" value={(data.summary?.profit_factor || 0).toFixed(2)} color={data.summary?.profit_factor >= 1.5 ? '#00ff88' : '#ffaa00'} />
        <MetricCard label="Total P&L" value={`$${((data.summary?.total_pnl || 0) / 1000).toFixed(0)}K`} color={data.summary?.total_pnl >= 0 ? '#00ff88' : '#ff4466'} />
        <MetricCard label="Max DD" value={`${maxDrawdown.toFixed(1)}%`} color={maxDrawdown > 20 ? '#ff4466' : '#ffaa00'} />
        <MetricCard label="Avg Win" value={`$${(avgWin/1000).toFixed(1)}K`} color="#00ff88" />
        <MetricCard label="Avg Loss" value={`$${(avgLoss/1000).toFixed(1)}K`} color="#ff4466" />
        <MetricCard label="Avg R" value={`${(data.summary?.avg_r || 0).toFixed(2)}R`} color="#8b5cf6" />
        <MetricCard label="Return" value={`${totalReturn.toFixed(1)}%`} color={totalReturn >= 0 ? '#00ff88' : '#ff4466'} />
        <MetricCard label="Final Equity" value={`$${(finalEquity/1000).toFixed(0)}K`} color="#f97316" />
      </div>

      {/* Navigation Tabs */}
      <div style={{ display: 'flex', gap: 6, marginBottom: 16 }}>
        {sections.map(s => (
          <button key={s.id} onClick={() => setActiveSection(s.id)} style={{
            background: activeSection === s.id ? '#00ff88' : 'rgba(255,255,255,0.05)',
            border: 'none', borderRadius: 6, padding: '8px 16px',
            color: activeSection === s.id ? '#000' : '#888', fontWeight: 600, cursor: 'pointer', fontSize: 11
          }}>{s.icon} {s.label}</button>
        ))}
      </div>

      {/* OVERVIEW SECTION */}
      {activeSection === 'overview' && (
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
          {/* Interactive Equity Curve - Classy Thick Line */}
          <div style={{ background: 'linear-gradient(180deg, rgba(0,20,10,0.8) 0%, rgba(0,0,0,0.95) 100%)', borderRadius: 16, padding: 20, border: '1px solid rgba(0,255,136,0.15)', boxShadow: '0 4px 24px rgba(0,0,0,0.5)' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
              <h3 style={{ fontSize: 14, fontWeight: 700, color: '#fff', margin: 0, letterSpacing: 0.5 }}>Equity Curve</h3>
              <div style={{ fontSize: 10, color: '#666' }}>{equityData.length} trades</div>
            </div>
            <div style={{ height: 220, position: 'relative' }} onMouseLeave={() => setHoveredEquityPoint(null)}>
              {equityData.length > 0 ? (() => {
                const maxEq = Math.max(...equityData.map(e => e.equity));
                const minEq = Math.min(...equityData.map(e => e.equity));
                const range = maxEq - minEq || 1;
                const getY = (eq) => 200 - ((eq - minEq) / range) * 170;
                const getX = (i) => 20 + (i / (equityData.length - 1)) * 560;
                const linePath = equityData.map((e, i) => `${i === 0 ? 'M' : 'L'} ${getX(i)} ${getY(e.equity)}`).join(' ');
                const areaPath = `${linePath} L ${getX(equityData.length - 1)} 200 L 20 200 Z`;
                return (
                  <>
                    <svg width="100%" height="100%" viewBox="0 0 600 220" preserveAspectRatio="xMidYMid meet">
                      <defs>
                        <linearGradient id="eqGradPremium" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="0%" stopColor="#00ff88" stopOpacity="0.25" />
                          <stop offset="50%" stopColor="#00cc66" stopOpacity="0.1" />
                          <stop offset="100%" stopColor="#00ff88" stopOpacity="0" />
                        </linearGradient>
                        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                          <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                        </filter>
                        <linearGradient id="lineGrad" x1="0" y1="0" x2="1" y2="0">
                          <stop offset="0%" stopColor="#00cc66" />
                          <stop offset="50%" stopColor="#00ff88" />
                          <stop offset="100%" stopColor="#00ffaa" />
                        </linearGradient>
                      </defs>
                      {/* Grid lines */}
                      {[0.25, 0.5, 0.75].map(p => (
                        <line key={p} x1="20" y1={200 - p * 170} x2="580" y2={200 - p * 170} stroke="rgba(255,255,255,0.05)" strokeWidth="1" />
                      ))}
                      {/* Starting capital line */}
                      <line x1="20" y1={getY(100000)} x2="580" y2={getY(100000)} stroke="rgba(255,255,255,0.2)" strokeWidth="1" strokeDasharray="4,4" />
                      <text x="585" y={getY(100000) + 4} fontSize="8" fill="#666">$100K</text>
                      {/* Area fill */}
                      <path d={areaPath} fill="url(#eqGradPremium)" />
                      {/* Main line - THICK and classy with glow */}
                      <path d={linePath} fill="none" stroke="url(#lineGrad)" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" filter="url(#glow)" />
                      {/* Hover detection areas (invisible) */}
                      {equityData.map((e, i) => (
                        <rect key={i} x={getX(i) - 5} y={0} width={10} height={220} fill="transparent" style={{ cursor: 'crosshair' }}
                          onMouseEnter={() => setHoveredEquityPoint(i)} />
                      ))}
                      {/* Hover indicator dot */}
                      {hoveredEquityPoint !== null && (
                        <>
                          <line x1={getX(hoveredEquityPoint)} y1={0} x2={getX(hoveredEquityPoint)} y2={200} stroke="rgba(255,255,255,0.2)" strokeWidth="1" strokeDasharray="2,2" />
                          <circle cx={getX(hoveredEquityPoint)} cy={getY(equityData[hoveredEquityPoint].equity)} r={8} fill="none" stroke="#00ff88" strokeWidth="2" />
                          <circle cx={getX(hoveredEquityPoint)} cy={getY(equityData[hoveredEquityPoint].equity)} r={4} fill={equityData[hoveredEquityPoint].pnl >= 0 ? '#00ff88' : '#ff4466'} />
                        </>
                      )}
                      {/* Y-axis labels */}
                      <text x="5" y="15" fontSize="9" fill="#666">${(maxEq/1000).toFixed(0)}K</text>
                      <text x="5" y="200" fontSize="9" fill="#666">${(minEq/1000).toFixed(0)}K</text>
                    </svg>
                    {/* Premium hover tooltip */}
                    {hoveredEquityPoint !== null && equityData[hoveredEquityPoint] && (() => {
                      const pt = equityData[hoveredEquityPoint];
                      return (
                        <div style={{ position: 'absolute', top: 10, right: 10, background: 'linear-gradient(135deg, rgba(0,30,20,0.98) 0%, rgba(0,0,0,0.98) 100%)', border: '1px solid rgba(0,255,136,0.3)', borderRadius: 12, padding: 14, fontSize: 11, minWidth: 180, backdropFilter: 'blur(10px)', boxShadow: '0 8px 32px rgba(0,0,0,0.4)' }}>
                          <div style={{ fontWeight: 700, color: '#00ff88', marginBottom: 8, fontSize: 12, borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: 8 }}>{pt.date}</div>
                          <div style={{ display: 'grid', gap: 6 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ color: '#888' }}>Equity</span><span style={{ color: '#00ff88', fontWeight: 700 }}>${(pt.equity/1000).toFixed(1)}K</span></div>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ color: '#888' }}>Trade P&L</span><span style={{ color: pt.pnl >= 0 ? '#00ff88' : '#ff4466', fontWeight: 600 }}>{pt.pnl >= 0 ? '+' : ''}${pt.pnl?.toFixed(0)}</span></div>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ color: '#888' }}>Total Profit</span><span style={{ color: pt.totalProfit >= 0 ? '#00ff88' : '#ff4466', fontWeight: 700 }}>{pt.totalProfit >= 0 ? '+' : ''}${(pt.totalProfit/1000).toFixed(1)}K <span style={{ fontSize: 9, opacity: 0.7 }}>({pt.totalProfitPct >= 0 ? '+' : ''}{pt.totalProfitPct.toFixed(0)}%)</span></span></div>
                            <div style={{ borderTop: '1px solid rgba(255,255,255,0.1)', paddingTop: 6, marginTop: 2 }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ color: '#888' }}>Peak</span><span style={{ color: '#fff' }}>${(pt.peak/1000).toFixed(1)}K</span></div>
                              <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ color: '#888' }}>From Peak</span><span style={{ color: pt.fromPeak > 0 ? '#ff4466' : '#00ff88', fontWeight: 600 }}>{pt.fromPeak > 0 ? `-$${(pt.fromPeak/1000).toFixed(1)}K (${pt.drawdown.toFixed(1)}%)` : 'AT HIGH'}</span></div>
                              <div style={{ display: 'flex', justifyContent: 'space-between' }}><span style={{ color: '#888' }}>Max DD</span><span style={{ color: pt.maxDrawdownSoFar > 10 ? '#ff4466' : '#ffaa00', fontWeight: 600 }}>{pt.maxDrawdownSoFar.toFixed(1)}%</span></div>
                            </div>
                            <div style={{ fontSize: 9, color: '#555', textAlign: 'right', marginTop: 2 }}>Trade #{hoveredEquityPoint + 1}</div>
                          </div>
                        </div>
                      );
                    })()}
                  </>
                );
              })() : <div style={{ color: '#666', textAlign: 'center', paddingTop: 100 }}>No data</div>}
            </div>
          </div>

          {/* Yearly Performance Grid */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#fff', margin: 0, marginBottom: 12 }}>Yearly Performance</h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8 }}>
              {(data.yearly_pnl || []).map(y => (
                <div key={y.year} style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: 10, textAlign: 'center', border: selectedYear === y.year ? '2px solid #00ff88' : '1px solid transparent', cursor: 'pointer' }} onClick={() => setSelectedYear(y.year)}>
                  <div style={{ fontSize: 12, fontWeight: 700, color: '#fff' }}>{y.year}</div>
                  <div style={{ fontSize: 14, fontWeight: 800, color: y.pnl >= 0 ? '#00ff88' : '#ff4466' }}>${(y.pnl/1000).toFixed(0)}K</div>
                  <div style={{ fontSize: 9, color: '#666' }}>{y.trades} trades | {((y.win_rate || 0) * 100).toFixed(1)}%</div>
                </div>
              ))}
            </div>
          </div>

          {/* Win vs Loss Comparison */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#fff', margin: 0, marginBottom: 12 }}>Winners vs Losers</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
              <div style={{ background: 'rgba(0,255,136,0.1)', borderRadius: 8, padding: 12, border: '1px solid rgba(0,255,136,0.3)' }}>
                <div style={{ fontSize: 10, color: '#00ff88', marginBottom: 8 }}>WINNERS ({winners.length})</div>
                <div style={{ fontSize: 9, color: '#888', display: 'grid', gap: 4 }}>
                  <div>Avg P&L: <span style={{ color: '#00ff88', fontWeight: 600 }}>${avgWin.toFixed(0)}</span></div>
                  <div>Best: <span style={{ color: '#00ff88' }}>${Math.max(...winners.map(t => t.pnl || 0)).toFixed(0)}</span></div>
                  <div>Avg R: <span style={{ color: '#00ff88' }}>{(winners.reduce((s,t) => s + (t.r||0), 0) / winners.length).toFixed(2)}R</span></div>
                </div>
              </div>
              <div style={{ background: 'rgba(255,68,102,0.1)', borderRadius: 8, padding: 12, border: '1px solid rgba(255,68,102,0.3)' }}>
                <div style={{ fontSize: 10, color: '#ff4466', marginBottom: 8 }}>LOSERS ({losers.length})</div>
                <div style={{ fontSize: 9, color: '#888', display: 'grid', gap: 4 }}>
                  <div>Avg P&L: <span style={{ color: '#ff4466', fontWeight: 600 }}>-${avgLoss.toFixed(0)}</span></div>
                  <div>Worst: <span style={{ color: '#ff4466' }}>${Math.min(...losers.map(t => t.pnl || 0)).toFixed(0)}</span></div>
                  <div>Avg R: <span style={{ color: '#ff4466' }}>{(losers.reduce((s,t) => s + (t.r||0), 0) / losers.length).toFixed(2)}R</span></div>
                </div>
              </div>
            </div>
          </div>

          {/* Market Direction */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#fff', margin: 0, marginBottom: 12 }}>Market Direction (5Y)</h3>
            <div style={{ display: 'flex', gap: 4, marginBottom: 8 }}>
              <div style={{ flex: bullishDays, background: '#00ff88', height: 20, borderRadius: 4 }} />
              <div style={{ flex: bearishDays, background: '#ff4466', height: 20, borderRadius: 4 }} />
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10 }}>
              <span style={{ color: '#00ff88' }}>{bullishDays} Bullish ({((bullishDays/totalDays)*100).toFixed(1)}%)</span>
              <span style={{ color: '#ff4466' }}>{bearishDays} Bearish ({((bearishDays/totalDays)*100).toFixed(1)}%)</span>
            </div>
          </div>
        </div>
      )}

      {/* DEEP ANALYTICS SECTION */}
      {activeSection === 'analytics' && (
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>
          {/* TPO Profile Analysis */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#8b5cf6', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              TPO Profile Types
              <InfoTooltip id="tpo" title={metricExplanations.tpo.title} content={metricExplanations.tpo.content} color="#8b5cf6" />
            </h3>
            {Object.entries(featureStatistics?.by_tpo_type || {}).sort((a,b) => b[1].total - a[1].total).map(([type, stats]) => (
              <FeatureBar key={type} label={type} wins={stats.wins} total={stats.total} pnl={stats.pnl} color="#8b5cf6" />
            ))}
          </div>

          {/* Volume Pattern Analysis */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#f97316', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Volume Patterns
              <InfoTooltip id="volume" title={metricExplanations.volume.title} content={metricExplanations.volume.content} color="#f97316" />
            </h3>
            {Object.entries(featureStatistics?.by_volume_pattern || {}).sort((a,b) => b[1].total - a[1].total).slice(0, 8).map(([type, stats]) => (
              <FeatureBar key={type} label={type} wins={stats.wins} total={stats.total} pnl={stats.pnl} color="#f97316" />
            ))}
          </div>

          {/* Wyckoff Phase Analysis */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#00bcd4', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Wyckoff Phases
              <InfoTooltip id="wyckoff" title={metricExplanations.wyckoff.title} content={metricExplanations.wyckoff.content} color="#00bcd4" />
            </h3>
            {Object.entries(featureStatistics?.by_wyckoff_phase || {}).sort((a,b) => b[1].total - a[1].total).map(([type, stats]) => (
              <FeatureBar key={type} label={type} wins={stats.wins} total={stats.total} pnl={stats.pnl} color="#00bcd4" />
            ))}
          </div>

          {/* Order Flow Patterns */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)', gridColumn: 'span 2' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#ff4466', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Order Flow Patterns
              <InfoTooltip id="orderflow" title={metricExplanations.orderflow.title} content={metricExplanations.orderflow.content} color="#ff4466" />
            </h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px 32px' }}>
              {Object.entries(featureStatistics?.by_order_flow || {}).sort((a,b) => b[1].total - a[1].total).map(([type, stats]) => (
                <FeatureBar key={type} label={type} wins={stats.wins} total={stats.total} pnl={stats.pnl} color="#ff4466" />
              ))}
            </div>
          </div>

          {/* Exit Reason Analysis - Shows % of total trades */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#00ff88', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Exit Reasons
              <InfoTooltip id="exit" title={metricExplanations.exit.title} content={metricExplanations.exit.content} color="#00ff88" />
            </h3>
            {(() => {
              const exitStats = featureStatistics?.by_exit_reason || {};
              const totalAllTrades = Object.values(exitStats).reduce((sum, s) => sum + s.total, 0);
              return Object.entries(exitStats).sort((a,b) => b[1].total - a[1].total).map(([type, stats]) => {
                const pctOfTotal = totalAllTrades > 0 ? (stats.total / totalAllTrades * 100).toFixed(0) : 0;
                const formattedLabel = formatMetricName(type);
                const barColor = type === 'TARGET' ? '#00ff88' : type === 'STOP_LOSS' ? '#ff4466' : '#f97316';
                return (
                  <div key={type} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '8px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                    <div style={{ width: 100, fontSize: 11, color: '#ccc' }}>{formattedLabel}</div>
                    <div style={{ flex: 1, background: 'rgba(255,255,255,0.05)', borderRadius: 4, height: 18, position: 'relative', overflow: 'hidden', minWidth: 100 }}>
                      <div style={{ position: 'absolute', left: 0, top: 0, bottom: 0, width: `${pctOfTotal}%`, background: barColor, borderRadius: 4 }} />
                      <div style={{ position: 'absolute', left: 6, top: '50%', transform: 'translateY(-50%)', fontSize: 10, fontWeight: 600, color: '#fff' }}>{pctOfTotal}%</div>
                    </div>
                    <div style={{ width: 45, fontSize: 10, color: '#888', textAlign: 'right' }}>{stats.total}</div>
                    <div style={{ width: 70, fontSize: 10, color: stats.pnl >= 0 ? '#00ff88' : '#ff4466', textAlign: 'right', fontWeight: 600 }}>${(stats.pnl/1000).toFixed(1)}K</div>
                  </div>
                );
              });
            })()}
          </div>
        </div>
      )}

      {/* FEATURE ANALYSIS SECTION */}
      {activeSection === 'features' && (
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
          {/* TPO Distribution with Visual Tooltips */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#fff', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              TPO Type Distribution (All Sessions)
              <InfoTooltip id="tpo_dist" title="TPO Distribution" content="Total count of each TPO profile type across all trading sessions. TPO (Time Price Opportunity) profiles show where price spent the most time." color="#8b5cf6" />
            </h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 }}>
              {(() => {
                const totalTpo = Object.values(distributions?.tpo_types || {}).reduce((a,b) => a+b, 0);
                return Object.entries(distributions?.tpo_types || {}).sort((a,b) => b[1] - a[1]).map(([type, count]) => (
                  <TpoCard key={type} type={type} count={count} total={totalTpo} setHoveredTpo={setHoveredTpo} />
                ));
              })()}
            </div>
          </div>

          {/* Wyckoff Distribution */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#fff', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Wyckoff Phase Distribution
              <InfoTooltip id="wyckoff_dist" title="Wyckoff Distribution" content="Market cycle phases based on Wyckoff methodology. Shows institutional accumulation/distribution patterns." color="#00bcd4" />
            </h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 8 }}>
              {(() => {
                const totalWyckoff = Object.values(distributions?.wyckoff_phases || {}).reduce((a,b) => a+b, 0);
                return Object.entries(distributions?.wyckoff_phases || {}).sort((a,b) => b[1] - a[1]).map(([phase, count]) => (
                  <WyckoffCard key={phase} phase={phase} count={count} total={totalWyckoff} setHoveredWyckoff={setHoveredWyckoff} />
                ));
              })()}
            </div>
          </div>

          {/* Best/Worst Setups */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#00ff88', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Best Performing Setups
              <InfoTooltip id="best_setups" title="Best Setups" content="TPO profile types with the highest win rates (minimum 5 trades). These patterns historically produced the most consistent winning trades. Consider prioritizing entries during these market structures." color="#00ff88" />
            </h3>
            {Object.entries(featureStatistics?.by_tpo_type || {}).filter(([,s]) => s.total >= 5).sort((a,b) => b[1].win_rate - a[1].win_rate).slice(0, 5).map(([type, stats]) => (
              <div key={type} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.05)', fontSize: 11 }}>
                <span style={{ color: '#888' }}>{type}</span>
                <span style={{ color: '#00ff88', fontWeight: 600 }}>{stats.win_rate}% WR | ${(stats.pnl/1000).toFixed(1)}K</span>
              </div>
            ))}
          </div>

          {/* Worst Setups */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#ff4466', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Worst Performing Setups
              <InfoTooltip id="worst_setups" title="Worst Setups" content="TPO profile types with the lowest win rates (minimum 5 trades). These patterns historically produced more losing trades. Consider avoiding or using tighter stops when trading during these market structures." color="#ff4466" />
            </h3>
            {Object.entries(featureStatistics?.by_tpo_type || {}).filter(([,s]) => s.total >= 5).sort((a,b) => a[1].win_rate - b[1].win_rate).slice(0, 5).map(([type, stats]) => (
              <div key={type} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.05)', fontSize: 11 }}>
                <span style={{ color: '#888' }}>{type}</span>
                <span style={{ color: '#ff4466', fontWeight: 600 }}>{stats.win_rate}% WR | ${(stats.pnl/1000).toFixed(1)}K</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* PHASE DETECTION SECTION */}
      {activeSection === 'phase' && (
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
          {/* Wyckoff Phase Detection Summary */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#00bcd4', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Wyckoff Phase Detection
              <InfoTooltip id="phase_detect" title="Phase Detection" content="Market phases identified using Wyckoff methodology across 5 years of historical data. Shows how price moves through accumulation, markup, distribution, and markdown cycles." color="#00bcd4" />
            </h3>
            {(() => {
              const phases = distributions?.wyckoff_phases || {};
              const totalPhases = Object.values(phases).reduce((a,b) => a+b, 0);
              const phaseColors = {
                accumulation: '#00ff88', markup: '#22c55e', distribution: '#ff4466', markdown: '#ef4444',
                consolidation: '#f97316', trending: '#a855f7', re_accumulation: '#10b981', re_distribution: '#f43f5e', unknown: '#666'
              };
              return Object.entries(phases).sort((a,b) => b[1] - a[1]).map(([phase, count]) => {
                const pct = totalPhases > 0 ? (count / totalPhases * 100).toFixed(1) : 0;
                const color = phaseColors[phase] || '#888';
                return (
                  <div key={phase} style={{ marginBottom: 10 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                      <span style={{ fontSize: 11, color: '#ccc' }}>{formatMetricName(phase)}</span>
                      <span style={{ fontSize: 11, color, fontWeight: 600 }}>{count} ({pct}%)</span>
                    </div>
                    <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 4, height: 8, overflow: 'hidden' }}>
                      <div style={{ width: `${pct}%`, height: '100%', background: color, borderRadius: 4 }} />
                    </div>
                  </div>
                );
              });
            })()}
          </div>

          {/* Phase Performance Matrix */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#a855f7', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Phase Performance Analysis
              <InfoTooltip id="phase_perf" title="Phase Performance" content="Trading performance breakdown by Wyckoff phase. Shows win rate and P&L for each market phase to identify which phases are most profitable to trade." color="#a855f7" />
            </h3>
            {(() => {
              const phaseStats = featureStatistics?.by_wyckoff_phase || {};
              return Object.entries(phaseStats).sort((a,b) => b[1].pnl - a[1].pnl).map(([phase, stats]) => {
                const wr = stats.win_rate || 0;
                const color = wr >= 65 ? '#00ff88' : wr >= 50 ? '#f97316' : '#ff4466';
                return (
                  <div key={phase} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: '8px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                    <div style={{ width: 90, fontSize: 10, color: '#aaa' }}>{formatMetricName(phase)}</div>
                    <div style={{ width: 50, fontSize: 10, color, fontWeight: 600 }}>{wr.toFixed(0)}% WR</div>
                    <div style={{ flex: 1, background: 'rgba(255,255,255,0.05)', borderRadius: 4, height: 12, position: 'relative' }}>
                      <div style={{ position: 'absolute', left: 0, top: 0, bottom: 0, width: `${Math.min(100, wr)}%`, background: color, borderRadius: 4 }} />
                    </div>
                    <div style={{ width: 70, fontSize: 10, color: stats.pnl >= 0 ? '#00ff88' : '#ff4466', fontWeight: 600, textAlign: 'right' }}>
                      ${(stats.pnl/1000).toFixed(1)}K
                    </div>
                  </div>
                );
              });
            })()}
          </div>

          {/* Order Flow Pattern Detection */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#ff4466', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Order Flow Pattern Detection
              <InfoTooltip id="orderflow_detect" title="Order Flow Detection" content="Detected order flow patterns: CVD divergences, VSA no-effort results, delta imbalances, and absorption patterns identified across historical sessions." color="#ff4466" />
            </h3>
            {(() => {
              const ofStats = featureStatistics?.by_order_flow || {};
              const totalOF = Object.values(ofStats).reduce((sum, s) => sum + s.total, 0);
              const ofColors = {
                cvd_bullish_divergence: '#00ff88', cvd_bearish_divergence: '#ff4466', vsa_no_effort_result: '#f97316',
                delta_imbalance: '#a855f7', absorption: '#00bcd4', normal: '#666'
              };
              return Object.entries(ofStats).sort((a,b) => b[1].total - a[1].total).map(([pattern, stats]) => {
                const pct = totalOF > 0 ? (stats.total / totalOF * 100).toFixed(1) : 0;
                const color = ofColors[pattern] || '#888';
                return (
                  <div key={pattern} style={{ marginBottom: 10 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                      <span style={{ fontSize: 10, color: '#ccc' }}>{formatMetricName(pattern)}</span>
                      <span style={{ fontSize: 10, color: '#888' }}>{stats.total} trades ({pct}%)</span>
                    </div>
                    <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                      <div style={{ flex: 1, background: 'rgba(255,255,255,0.05)', borderRadius: 4, height: 8, overflow: 'hidden' }}>
                        <div style={{ width: `${pct}%`, height: '100%', background: color, borderRadius: 4 }} />
                      </div>
                      <span style={{ fontSize: 9, color: stats.win_rate >= 60 ? '#00ff88' : '#f97316', fontWeight: 600, width: 45 }}>{stats.win_rate.toFixed(0)}% WR</span>
                    </div>
                  </div>
                );
              });
            })()}
          </div>

          {/* Volume Pattern Detection */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#f97316', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Volume Pattern Detection
              <InfoTooltip id="volume_detect" title="Volume Patterns" content="Volume patterns detected using VSA (Volume Spread Analysis): climax, exhaustion, absorption, no demand/supply signals across 1,257 trading sessions." color="#f97316" />
            </h3>
            {(() => {
              const volPatterns = distributions?.volume_patterns || {};
              const totalVol = Object.values(volPatterns).reduce((a,b) => a+b, 0);
              const volColors = {
                climax_bullish: '#00ff88', climax_bearish: '#ff4466', exhaustion: '#f97316', absorption: '#a855f7',
                no_demand: '#ff6b6b', no_supply: '#22c55e', high_volume: '#00bcd4', low_volume: '#888', normal: '#666'
              };
              return Object.entries(volPatterns).sort((a,b) => b[1] - a[1]).map(([pattern, count]) => {
                const pct = totalVol > 0 ? (count / totalVol * 100).toFixed(1) : 0;
                const color = volColors[pattern] || '#888';
                return (
                  <div key={pattern} style={{ marginBottom: 8 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                      <span style={{ fontSize: 10, color: '#ccc' }}>{formatMetricName(pattern)}</span>
                      <span style={{ fontSize: 10, color, fontWeight: 600 }}>{count} ({pct}%)</span>
                    </div>
                    <div style={{ background: 'rgba(255,255,255,0.05)', borderRadius: 3, height: 6, overflow: 'hidden' }}>
                      <div style={{ width: `${pct}%`, height: '100%', background: color, borderRadius: 3 }} />
                    </div>
                  </div>
                );
              });
            })()}
          </div>

          {/* Historical GEX Regime Analysis */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)', gridColumn: 'span 2' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#22c55e', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Historical GEX Regime Analysis (Simulated from Price Action)
              <InfoTooltip id="gex_regime" title="GEX Regimes" content="GEX regime classification derived from historical price volatility and range patterns. High GEX (>$5B) correlates with mean-reverting conditions, Low GEX (<$1B) with trending/volatile markets." color="#22c55e" />
            </h3>
            {(() => {
              // Simulate GEX regimes based on session volatility
              const sessions = data?.daily_candles || [];
              let highGex = 0, medGex = 0, lowGex = 0, negGex = 0;
              sessions.forEach(s => {
                const range = s.high - s.low;
                const avgPrice = (s.high + s.low) / 2;
                const volatility = avgPrice > 0 ? (range / avgPrice * 100) : 0;
                // Classify based on volatility (inverse relationship with GEX)
                if (volatility < 0.5) highGex++;
                else if (volatility < 1.0) medGex++;
                else if (volatility < 2.0) lowGex++;
                else negGex++;
              });
              const total = highGex + medGex + lowGex + negGex || 1;
              const regimes = [
                { name: 'High GEX (>$5B)', count: highGex, pct: (highGex/total*100).toFixed(1), color: '#00ff88', desc: 'Mean-reverting, low volatility' },
                { name: 'Medium GEX ($1-5B)', count: medGex, pct: (medGex/total*100).toFixed(1), color: '#f97316', desc: 'Normal conditions' },
                { name: 'Low GEX (<$1B)', count: lowGex, pct: (lowGex/total*100).toFixed(1), color: '#ff4466', desc: 'Trending, higher volatility' },
                { name: 'Negative GEX', count: negGex, pct: (negGex/total*100).toFixed(1), color: '#a855f7', desc: 'Extreme volatility, dealer short gamma' }
              ];
              return (
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12 }}>
                  {regimes.map(r => (
                    <div key={r.name} style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 8, padding: 12, textAlign: 'center', borderTop: `3px solid ${r.color}` }}>
                      <div style={{ fontSize: 22, fontWeight: 800, color: r.color }}>{r.count}</div>
                      <div style={{ fontSize: 10, color: '#888', marginBottom: 4 }}>{r.name}</div>
                      <div style={{ fontSize: 18, fontWeight: 700, color: '#fff' }}>{r.pct}%</div>
                      <div style={{ fontSize: 8, color: '#666', marginTop: 4 }}>{r.desc}</div>
                    </div>
                  ))}
                </div>
              );
            })()}
          </div>
        </div>
      )}

      {/* MATRIX ANALYSIS SECTION */}
      {activeSection === 'matrix' && (
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
          {/* TPO-Wyckoff Correlation Matrix */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)', gridColumn: 'span 2' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#a855f7', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              TPO-Wyckoff Phase Correlation Matrix
              <InfoTooltip id="tpo_wyckoff_matrix" title="Correlation Matrix" content="Heat map showing which TPO profile types occur during which Wyckoff phases. Helps identify market structure patterns and optimal entry conditions." color="#a855f7" />
            </h3>
            {(() => {
              const tpoTypes = ['P-shape', 'b-shape', 'D-shape', 'B-shape', 'elongated_up', 'elongated_down', 'single_print'];
              const wyckoffPhases = ['accumulation', 'markup', 'distribution', 'markdown', 'consolidation', 'trending', 're_accumulation', 're_distribution'];
              // Build co-occurrence matrix from trades data
              const matrix = {};
              tpoTypes.forEach(t => { matrix[t] = {}; wyckoffPhases.forEach(w => { matrix[t][w] = 0; }); });
              // Count occurrences from trades
              (trades || []).forEach(trade => {
                const tpo = trade.tpo_type || 'unknown';
                const wyckoff = trade.wyckoff_phase || 'unknown';
                if (matrix[tpo] && matrix[tpo][wyckoff] !== undefined) {
                  matrix[tpo][wyckoff]++;
                }
              });
              // Find max for color scaling
              let maxCount = 1;
              tpoTypes.forEach(t => wyckoffPhases.forEach(w => { if (matrix[t][w] > maxCount) maxCount = matrix[t][w]; }));
              return (
                <div style={{ overflowX: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 10 }}>
                    <thead>
                      <tr>
                        <th style={{ padding: 6, textAlign: 'left', color: '#888', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>TPO / Phase</th>
                        {wyckoffPhases.map(w => (
                          <th key={w} style={{ padding: 6, textAlign: 'center', color: '#00bcd4', borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 8 }}>
                            {formatMetricName(w).split(' ')[0]}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {tpoTypes.map(tpo => (
                        <tr key={tpo}>
                          <td style={{ padding: 6, color: '#8b5cf6', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.05)' }}>{tpo}</td>
                          {wyckoffPhases.map(w => {
                            const count = matrix[tpo][w];
                            const intensity = count / maxCount;
                            const bg = count > 0 ? `rgba(168,85,247,${0.1 + intensity * 0.6})` : 'transparent';
                            return (
                              <td key={w} style={{ padding: 6, textAlign: 'center', background: bg, color: count > 0 ? '#fff' : '#333', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                {count > 0 ? count : '-'}
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              );
            })()}
          </div>

          {/* Win Rate Heatmap by TPO + Wyckoff */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)', gridColumn: 'span 2' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#00ff88', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Win Rate Matrix (TPO + Wyckoff Combinations)
              <InfoTooltip id="wr_matrix" title="Win Rate Matrix" content="Historical win rates for each TPO-Wyckoff combination. Green cells indicate high-probability setups (>65% WR), red cells indicate setups to avoid (<45% WR)." color="#00ff88" />
            </h3>
            {(() => {
              const tpoTypes = ['P-shape', 'b-shape', 'D-shape', 'B-shape', 'elongated_up', 'elongated_down'];
              const wyckoffPhases = ['accumulation', 'markup', 'distribution', 'markdown', 'consolidation', 'trending'];
              // Build win rate matrix
              const wrMatrix = {};
              tpoTypes.forEach(t => { wrMatrix[t] = {}; wyckoffPhases.forEach(w => { wrMatrix[t][w] = { wins: 0, total: 0 }; }); });
              (trades || []).forEach(trade => {
                const tpo = trade.tpo_type || 'unknown';
                const wyckoff = trade.wyckoff_phase || 'unknown';
                if (wrMatrix[tpo] && wrMatrix[tpo][wyckoff]) {
                  wrMatrix[tpo][wyckoff].total++;
                  if (trade.pnl > 0) wrMatrix[tpo][wyckoff].wins++;
                }
              });
              return (
                <div style={{ overflowX: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 10 }}>
                    <thead>
                      <tr>
                        <th style={{ padding: 6, textAlign: 'left', color: '#888', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>TPO / Phase</th>
                        {wyckoffPhases.map(w => (
                          <th key={w} style={{ padding: 6, textAlign: 'center', color: '#00bcd4', borderBottom: '1px solid rgba(255,255,255,0.1)', fontSize: 8 }}>
                            {formatMetricName(w).split(' ')[0]}
                          </th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {tpoTypes.map(tpo => (
                        <tr key={tpo}>
                          <td style={{ padding: 6, color: '#8b5cf6', fontWeight: 600, borderBottom: '1px solid rgba(255,255,255,0.05)' }}>{tpo}</td>
                          {wyckoffPhases.map(w => {
                            const { wins, total } = wrMatrix[tpo][w];
                            const wr = total > 0 ? (wins / total * 100).toFixed(0) : null;
                            const color = wr === null ? '#333' : wr >= 65 ? '#00ff88' : wr >= 50 ? '#f97316' : '#ff4466';
                            const bg = wr === null ? 'transparent' : wr >= 65 ? 'rgba(0,255,136,0.15)' : wr >= 50 ? 'rgba(249,115,22,0.1)' : 'rgba(255,68,102,0.15)';
                            return (
                              <td key={w} style={{ padding: 6, textAlign: 'center', background: bg, color, fontWeight: wr !== null ? 600 : 400, borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                {wr !== null ? `${wr}%` : '-'}
                                {total > 0 && <div style={{ fontSize: 7, color: '#666' }}>n={total}</div>}
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              );
            })()}
            <div style={{ marginTop: 12, display: 'flex', gap: 16, justifyContent: 'center', fontSize: 9 }}>
              <span><span style={{ display: 'inline-block', width: 12, height: 12, background: 'rgba(0,255,136,0.3)', borderRadius: 2, marginRight: 4, verticalAlign: 'middle' }}></span> High WR (65%+)</span>
              <span><span style={{ display: 'inline-block', width: 12, height: 12, background: 'rgba(249,115,22,0.3)', borderRadius: 2, marginRight: 4, verticalAlign: 'middle' }}></span> Medium WR (50-65%)</span>
              <span><span style={{ display: 'inline-block', width: 12, height: 12, background: 'rgba(255,68,102,0.3)', borderRadius: 2, marginRight: 4, verticalAlign: 'middle' }}></span> Low WR (&lt;50%)</span>
            </div>
          </div>

          {/* Order Flow + TPO Correlation */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#ff4466', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Best Order Flow + TPO Combinations
              <InfoTooltip id="of_tpo" title="Order Flow + TPO" content="Most profitable combinations of order flow signals with TPO profile types. These combinations showed the highest win rates in backtesting." color="#ff4466" />
            </h3>
            {(() => {
              // Calculate best combinations
              const combos = {};
              (trades || []).forEach(trade => {
                const key = `${trade.order_flow || 'normal'}|${trade.tpo_type || 'unknown'}`;
                if (!combos[key]) combos[key] = { wins: 0, total: 0, pnl: 0 };
                combos[key].total++;
                combos[key].pnl += trade.pnl || 0;
                if (trade.pnl > 0) combos[key].wins++;
              });
              return Object.entries(combos)
                .filter(([, s]) => s.total >= 5)
                .map(([key, s]) => ({ key, ...s, wr: (s.wins / s.total * 100) }))
                .sort((a, b) => b.wr - a.wr)
                .slice(0, 8)
                .map(c => {
                  const [of, tpo] = c.key.split('|');
                  return (
                    <div key={c.key} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                      <div style={{ flex: 1, fontSize: 10, color: '#ccc' }}>
                        <span style={{ color: '#ff4466' }}>{formatMetricName(of)}</span> + <span style={{ color: '#8b5cf6' }}>{tpo}</span>
                      </div>
                      <div style={{ fontSize: 10, color: c.wr >= 65 ? '#00ff88' : '#f97316', fontWeight: 600 }}>{c.wr.toFixed(0)}%</div>
                      <div style={{ fontSize: 9, color: '#666' }}>n={c.total}</div>
                    </div>
                  );
                });
            })()}
          </div>

          {/* Volume Pattern + Wyckoff Correlation */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#f97316', margin: 0, marginBottom: 12, display: 'flex', alignItems: 'center' }}>
              Best Volume + Wyckoff Combinations
              <InfoTooltip id="vol_wyckoff" title="Volume + Wyckoff" content="Most profitable combinations of volume patterns with Wyckoff phases. Identifies which volume signals work best in specific market cycles." color="#f97316" />
            </h3>
            {(() => {
              const combos = {};
              (trades || []).forEach(trade => {
                const key = `${trade.volume_pattern || 'normal'}|${trade.wyckoff_phase || 'unknown'}`;
                if (!combos[key]) combos[key] = { wins: 0, total: 0, pnl: 0 };
                combos[key].total++;
                combos[key].pnl += trade.pnl || 0;
                if (trade.pnl > 0) combos[key].wins++;
              });
              return Object.entries(combos)
                .filter(([, s]) => s.total >= 5)
                .map(([key, s]) => ({ key, ...s, wr: (s.wins / s.total * 100) }))
                .sort((a, b) => b.wr - a.wr)
                .slice(0, 8)
                .map(c => {
                  const [vol, wyckoff] = c.key.split('|');
                  return (
                    <div key={c.key} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '6px 0', borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                      <div style={{ flex: 1, fontSize: 10, color: '#ccc' }}>
                        <span style={{ color: '#f97316' }}>{formatMetricName(vol)}</span> + <span style={{ color: '#00bcd4' }}>{formatMetricName(wyckoff)}</span>
                      </div>
                      <div style={{ fontSize: 10, color: c.wr >= 65 ? '#00ff88' : '#f97316', fontWeight: 600 }}>{c.wr.toFixed(0)}%</div>
                      <div style={{ fontSize: 9, color: '#666' }}>n={c.total}</div>
                    </div>
                  );
                });
            })()}
          </div>
        </div>
      )}

      {/* SEASONALITY SECTION */}
      {activeSection === 'seasonality' && (
        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 16 }}>
          {/* Monthly */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#fff', margin: 0, marginBottom: 12 }}>Monthly Seasonality</h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: 8 }}>
              {['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].map(m => {
                const d = seasonality?.monthly?.[m] || { win_rate: 50, avg_return: 0 };
                return (
                  <div key={m} style={{ background: 'rgba(0,0,0,0.3)', borderRadius: 6, padding: 8, textAlign: 'center' }}>
                    <div style={{ fontSize: 9, color: '#666' }}>{m.slice(0,3)}</div>
                    <div style={{ fontSize: 14, fontWeight: 700, color: d.avg_return >= 0 ? '#00ff88' : '#ff4466' }}>{d.win_rate}%</div>
                    <div style={{ fontSize: 8, color: d.avg_return >= 0 ? '#00ff88' : '#ff4466' }}>{d.avg_return >= 0 ? '+' : ''}{d.avg_return.toFixed(2)}%</div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Day of Week */}
          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 12, padding: 16, border: '1px solid rgba(255,255,255,0.05)' }}>
            <h3 style={{ fontSize: 13, fontWeight: 700, color: '#fff', margin: 0, marginBottom: 12 }}>Day of Week</h3>
            {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(day => {
              const d = seasonality?.day_of_week?.[day] || { win_rate: 50, avg_return: 0 };
              return (
                <div key={day} style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>
                  <div style={{ width: 60, fontSize: 10, color: '#888' }}>{day.slice(0,3)}</div>
                  <div style={{ flex: 1, background: 'rgba(255,255,255,0.05)', borderRadius: 4, height: 18, position: 'relative' }}>
                    <div style={{ position: 'absolute', left: 0, top: 0, bottom: 0, width: `${d.win_rate}%`, background: d.avg_return >= 0 ? '#00ff88' : '#ff4466', borderRadius: 4 }} />
                    <span style={{ position: 'absolute', left: 6, top: '50%', transform: 'translateY(-50%)', fontSize: 9, color: '#fff', fontWeight: 600 }}>{d.win_rate}%</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* TRADE LOG SECTION */}
      {activeSection === 'trades' && (
        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 16 }}>
          <TradeLog trades={trades} dateRange={dateRange} />
          <PnLCalendar trades={trades} />
        </div>
      )}

      {/* Fixed Cursor-Following Tooltip for Feature Bars */}
      {hoveredFeature && (
        <div style={{
          position: 'fixed',
          left: hoveredFeature.x + 15,
          top: hoveredFeature.y + 15,
          transform: hoveredFeature.x > window.innerWidth - 340 ? 'translateX(-100%)' : 'none',
          background: 'linear-gradient(180deg, rgba(20,20,25,0.98) 0%, rgba(10,10,15,0.98) 100%)',
          border: `1px solid ${hoveredFeature.color}44`,
          borderRadius: 10,
          padding: '12px 14px',
          minWidth: 240,
          maxWidth: 320,
          boxShadow: `0 12px 32px rgba(0,0,0,0.8), 0 0 15px ${hoveredFeature.color}22`,
          zIndex: 9999,
          pointerEvents: 'none'
        }}>
          <div style={{ fontWeight: 700, color: hoveredFeature.color, marginBottom: 8, fontSize: 13 }}>{hoveredFeature.formattedLabel}</div>
          <div style={{ fontSize: 11, color: '#aaa', lineHeight: 1.6 }}>{hoveredFeature.tooltip || `Win rate: ${hoveredFeature.wr}% across ${hoveredFeature.total} trades with ${hoveredFeature.pnl >= 0 ? 'profit' : 'loss'} of $${(hoveredFeature.pnl/1000).toFixed(1)}K`}</div>
          <div style={{ marginTop: 10, padding: '6px 8px', background: 'rgba(255,255,255,0.05)', borderRadius: 6, fontSize: 10, display: 'flex', justifyContent: 'space-between' }}>
            <span style={{ color: '#666' }}>Win Rate</span>
            <span style={{ color: hoveredFeature.color, fontWeight: 700 }}>{hoveredFeature.wr}%</span>
          </div>
        </div>
      )}

      {/* Fixed Cursor-Following Tooltip for Info Icons */}
      {hoveredInfo && (
        <div style={{
          position: 'fixed',
          left: hoveredInfo.x + 15,
          top: hoveredInfo.y + 15,
          transform: hoveredInfo.x > window.innerWidth - 320 ? 'translateX(-100%)' : 'none',
          background: 'linear-gradient(135deg, rgba(15,15,20,0.98) 0%, rgba(5,5,10,0.98) 100%)',
          border: `1px solid ${hoveredInfo.color}40`,
          borderRadius: 12,
          padding: 16,
          width: 280,
          boxShadow: `0 8px 32px rgba(0,0,0,0.5), 0 0 20px ${hoveredInfo.color}20`,
          zIndex: 9999,
          pointerEvents: 'none'
        }}>
          <div style={{ fontSize: 12, fontWeight: 700, color: hoveredInfo.color, marginBottom: 10, borderBottom: `1px solid ${hoveredInfo.color}30`, paddingBottom: 8 }}>{hoveredInfo.title}</div>
          <div style={{ fontSize: 11, color: '#aaa', lineHeight: 1.6 }}>{hoveredInfo.content}</div>
        </div>
      )}

      {/* Click-anywhere overlay to dismiss TPO/Wyckoff tooltips */}
      {(hoveredTpo || hoveredWyckoff) && (
        <div
          onClick={() => { setHoveredTpo(null); setHoveredWyckoff(null); }}
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            zIndex: 9998,
            cursor: 'default'
          }}
        />
      )}

      {/* Fixed Cursor-Following Tooltip for TPO Cards - Right-click to show, Left-click to dismiss */}
      {hoveredTpo && (
        <div
          onClick={() => setHoveredTpo(null)}
          style={{
            position: 'fixed',
            left: hoveredTpo.x + 15,
            top: hoveredTpo.y + 15,
            transform: hoveredTpo.x > window.innerWidth - 280 ? 'translateX(-100%)' : 'none',
            background: 'linear-gradient(180deg, rgba(20,15,30,0.98) 0%, rgba(10,8,20,0.98) 100%)',
            border: '1px solid rgba(139,92,246,0.4)',
            borderRadius: 14,
            padding: 16,
            minWidth: 240,
            boxShadow: '0 12px 40px rgba(0,0,0,0.8), 0 0 20px rgba(139,92,246,0.2)',
            zIndex: 9999,
            cursor: 'pointer'
          }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 14, marginBottom: 12 }}>
            <div style={{ background: 'rgba(139,92,246,0.1)', borderRadius: 10, padding: 8, border: '1px solid rgba(139,92,246,0.2)' }}>{hoveredTpo.visual.svg}</div>
            <div>
              <div style={{ fontSize: 14, fontWeight: 700, color: '#8b5cf6', marginBottom: 4 }}>{formatMetricName(hoveredTpo.type)}</div>
              <div style={{ fontSize: 11, color: hoveredTpo.visual.color, fontWeight: 600, padding: '2px 8px', background: `${hoveredTpo.visual.color}22`, borderRadius: 4, display: 'inline-block' }}>{hoveredTpo.visual.signal}</div>
            </div>
          </div>
          <div style={{ fontSize: 11, color: '#bbb', lineHeight: 1.6, marginBottom: 12 }}>{hoveredTpo.visual.desc}</div>
          <div style={{ padding: '8px 10px', background: 'rgba(139,92,246,0.1)', borderRadius: 8, fontSize: 10, color: '#888', display: 'flex', justifyContent: 'space-between' }}>
            <span>Occurrences</span>
            <span><span style={{ color: '#8b5cf6', fontWeight: 700, fontSize: 12 }}>{hoveredTpo.count}</span> ({hoveredTpo.pct}%)</span>
          </div>
          <div style={{ fontSize: 9, color: '#555', textAlign: 'center', marginTop: 8 }}>Click anywhere to dismiss</div>
        </div>
      )}

      {/* Fixed Cursor-Following Tooltip for Wyckoff Cards - Right-click to show, Left-click to dismiss */}
      {hoveredWyckoff && (
        <div
          onClick={() => setHoveredWyckoff(null)}
          style={{
            position: 'fixed',
            left: hoveredWyckoff.x + 15,
            top: hoveredWyckoff.y + 15,
            transform: hoveredWyckoff.x > window.innerWidth - 300 ? 'translateX(-100%)' : 'none',
            background: 'linear-gradient(180deg, rgba(15,25,30,0.98) 0%, rgba(8,15,20,0.98) 100%)',
            border: '1px solid rgba(0,188,212,0.4)',
            borderRadius: 14,
            padding: 16,
            width: 260,
            boxShadow: '0 12px 40px rgba(0,0,0,0.8), 0 0 20px rgba(0,188,212,0.2)',
            zIndex: 9999,
            cursor: 'pointer'
          }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 14, marginBottom: 12 }}>
            <div style={{ background: 'rgba(0,188,212,0.1)', borderRadius: 10, padding: 8, border: '1px solid rgba(0,188,212,0.2)' }}>{hoveredWyckoff.visual.svg}</div>
            <div>
              <div style={{ fontSize: 14, fontWeight: 700, color: '#00bcd4', marginBottom: 4, textTransform: 'capitalize' }}>{hoveredWyckoff.phase.replace(/_/g, ' ')}</div>
              <div style={{ fontSize: 11, color: hoveredWyckoff.visual.color, fontWeight: 600, padding: '2px 8px', background: `${hoveredWyckoff.visual.color}22`, borderRadius: 4, display: 'inline-block' }}>{hoveredWyckoff.visual.signal}</div>
            </div>
          </div>
          <div style={{ fontSize: 11, color: '#bbb', lineHeight: 1.6, marginBottom: 12 }}>{hoveredWyckoff.visual.desc}</div>
          <div style={{ padding: '8px 10px', background: 'rgba(0,188,212,0.1)', borderRadius: 8, fontSize: 10, color: '#888', display: 'flex', justifyContent: 'space-between' }}>
            <span>Occurrences</span>
            <span><span style={{ color: '#00bcd4', fontWeight: 700, fontSize: 12 }}>{hoveredWyckoff.count}</span> ({hoveredWyckoff.pct}%)</span>
          </div>
          <div style={{ fontSize: 9, color: '#555', textAlign: 'center', marginTop: 8 }}>Click anywhere to dismiss</div>
        </div>
      )}
    </div>
  );
};

// Trade Log Component
const TradeLog = ({ trades, dateRange }) => {
  const filteredTrades = trades
    .filter(t => t.date >= dateRange.start && t.date <= dateRange.end)
    .sort((a, b) => new Date(b.date) - new Date(a.date));

  // Download as CSV
  const downloadCSV = () => {
    const headers = ['Date', 'Entry', 'Exit', 'Stop Loss', 'P&L', 'R-Multiple', 'Grade', 'Tier', 'Exit Reason', 'Delta', 'Contracts'];
    const rows = filteredTrades.map(t => [
      t.date,
      t.entry?.toFixed(2) || '',
      t.exit?.toFixed(2) || '',
      t.stop_loss?.toFixed(2) || '',
      t.pnl?.toFixed(2) || '',
      t.r?.toFixed(2) || '',
      t.grade || '',
      t.tier || '',
      t.exitReason || '',
      t.delta || '',
      t.contracts || ''
    ]);
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `trade_log_${dateRange.start}_to_${dateRange.end}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // Download as XLSX (using simple XML format)
  const downloadXLSX = () => {
    const headers = ['Date', 'Entry', 'Exit', 'Stop Loss', 'P&L', 'R-Multiple', 'Grade', 'Tier', 'Exit Reason', 'Delta', 'Contracts'];
    let xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
    xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
    xml += '<Worksheet ss:Name="Trades"><Table>';
    xml += '<Row>' + headers.map(h => `<Cell><Data ss:Type="String">${h}</Data></Cell>`).join('') + '</Row>';
    filteredTrades.forEach(t => {
      xml += '<Row>';
      xml += `<Cell><Data ss:Type="String">${t.date || ''}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.entry || 0}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.exit || 0}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.stop_loss || 0}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.pnl || 0}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.r || 0}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="String">${t.grade || ''}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.tier || 0}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="String">${t.exitReason || ''}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.delta || 0}</Data></Cell>`;
      xml += `<Cell><Data ss:Type="Number">${t.contracts || 0}</Data></Cell>`;
      xml += '</Row>';
    });
    xml += '</Table></Worksheet></Workbook>';
    const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `trade_log_${dateRange.start}_to_${dateRange.end}.xls`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const displayTrades = filteredTrades.slice(0, 50);

  return (
    <div style={styles.tradeLog}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
        <h2 style={styles.dashboardTitle}>Trade Log</h2>
        <div style={{ display: 'flex', gap: '8px' }}>
          <button
            onClick={downloadCSV}
            style={{
              background: 'rgba(0,255,136,0.1)',
              border: '1px solid #00ff88',
              color: '#00ff88',
              padding: '8px 16px',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '12px',
              fontWeight: '600'
            }}
          >
            üì• CSV ({filteredTrades.length})
          </button>
          <button
            onClick={downloadXLSX}
            style={{
              background: 'rgba(0,170,255,0.1)',
              border: '1px solid #00aaff',
              color: '#00aaff',
              padding: '8px 16px',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '12px',
              fontWeight: '600'
            }}
          >
            üìä Excel ({filteredTrades.length})
          </button>
        </div>
      </div>
      <p style={styles.tradeLogInfo}>Showing {displayTrades.length} of {filteredTrades.length} filtered trades (most recent first)</p>
      <table style={styles.tradeTable}>
        <thead>
          <tr>
            <th style={styles.th}>Date</th>
            <th style={styles.th}>Entry</th>
            <th style={styles.th}>Exit</th>
            <th style={styles.th}>P&L</th>
            <th style={styles.th}>R-Multiple</th>
            <th style={styles.th}>Grade</th>
            <th style={styles.th}>Tier</th>
            <th style={styles.th}>Exit Reason</th>
          </tr>
        </thead>
        <tbody>
          {displayTrades.map((trade) => (
            <tr key={trade.id} style={styles.tr}>
              <td style={styles.td}>{trade.date}</td>
              <td style={styles.td}>${trade.entry.toFixed(2)}</td>
              <td style={styles.td}>${trade.exit.toFixed(2)}</td>
              <td style={{ ...styles.td, color: trade.pnl >= 0 ? '#00ff88' : '#ff4466' }}>
                ${trade.pnl.toLocaleString()}
              </td>
              <td style={{ ...styles.td, color: trade.r >= 0 ? '#00ff88' : '#ff4466' }}>
                {trade.r.toFixed(1)}R
              </td>
              <td style={styles.td}>
                <span style={{
                  ...styles.gradeBadge,
                  background: trade.grade === 'A' ? '#00ff88' : trade.grade === 'B' ? '#ffaa00' : '#ff4466'
                }}>
                  {trade.grade}
                </span>
              </td>
              <td style={styles.td}>{trade.tier}</td>
              <td style={styles.td}>
                <span style={{
                  fontSize: '11px',
                  color: trade.exitReason === 'STOP_LOSS' ? '#ff4466' : '#00ff88'
                }}>
                  {trade.exitReason?.replace('_', ' ') || ''}
                </span>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

// Contract configurations
const CONTRACTS = {
  'BTC-SPOT': { symbol: 'BTC-SPOT', name: 'Bitcoin Spot 24/7', ticker: 'BTCUSDT', asset: 'BTC-SPOT', icon: '‚Çø', isSpot: true },
  'ESH26': { symbol: 'ESH26', name: 'E-mini S&P Mar 2026', ticker: 'ES1!', asset: 'ES', icon: 'üìä' },
  'NQH26': { symbol: 'NQH26', name: 'Nasdaq Mar 2026', ticker: 'NQ1!', asset: 'NQ', icon: 'üíª' },
  'GCJ26': { symbol: 'GCJ26', name: 'Gold Apr 2026', ticker: 'GC1!', asset: 'GC', icon: 'ü•á' },
  'BTCG26': { symbol: 'BTCG26', name: 'Bitcoin CME Feb 2026', ticker: 'BTC1!', asset: 'BTC', icon: 'üÖ±Ô∏è' },
  'CLG26': { symbol: 'CLG26', name: 'Crude Oil Feb 2026', ticker: 'CL1!', asset: 'CL', icon: 'üõ¢Ô∏è' },
};

// Beautiful Contract Dropdown Component
const ContractDropdown = ({ selectedContract, onContractChange, contracts, isMobile }) => {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef(null);
  const selected = contracts[selectedContract];

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <div ref={dropdownRef} style={{ position: 'relative' }}>
      {/* Selected Item Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: isMobile ? 6 : 10,
          padding: isMobile ? '6px 10px' : '10px 16px',
          background: 'linear-gradient(135deg, rgba(0,255,136,0.15) 0%, rgba(0,170,255,0.1) 100%)',
          border: '1px solid rgba(0,255,136,0.4)',
          borderRadius: 8,
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          outline: 'none',
        }}
      >
        <span style={{ fontSize: isMobile ? 14 : 18 }}>{selected?.icon || 'üìà'}</span>
        <div style={{ textAlign: 'left' }}>
          <div style={{
            fontSize: isMobile ? 12 : 14,
            fontWeight: 700,
            color: '#00ff88',
            fontFamily: "'JetBrains Mono', monospace",
            letterSpacing: 0.5
          }}>
            {selected?.symbol || 'SELECT'}
          </div>
          {!isMobile && (
            <div style={{ fontSize: 9, color: '#888', marginTop: 1 }}>
              {selected?.name?.split(' ').slice(0, 2).join(' ') || 'Contract'}
            </div>
          )}
        </div>
        <svg
          width={isMobile ? 10 : 12}
          height={isMobile ? 10 : 12}
          viewBox="0 0 12 12"
          fill="none"
          style={{
            marginLeft: isMobile ? 2 : 6,
            transform: isOpen ? 'rotate(180deg)' : 'rotate(0deg)',
            transition: 'transform 0.2s ease'
          }}
        >
          <path d="M2 4L6 8L10 4" stroke="#00ff88" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
        </svg>
      </button>

      {/* Dropdown Menu */}
      {isOpen && (
        <div style={{
          position: 'absolute',
          bottom: '100%',
          left: 0,
          marginBottom: 8,
          minWidth: isMobile ? 180 : 240,
          background: 'linear-gradient(180deg, rgba(20,20,30,0.98) 0%, rgba(10,10,18,0.99) 100%)',
          border: '1px solid rgba(0,255,136,0.3)',
          borderRadius: 12,
          overflow: 'hidden',
          boxShadow: '0 -10px 40px rgba(0,0,0,0.6), 0 0 20px rgba(0,255,136,0.1)',
          zIndex: 2000,
          animation: 'slideUp 0.2s ease'
        }}>
          {/* Header */}
          <div style={{
            padding: '10px 14px',
            borderBottom: '1px solid rgba(255,255,255,0.08)',
            background: 'rgba(0,255,136,0.05)'
          }}>
            <span style={{ fontSize: 10, color: '#888', letterSpacing: 1, textTransform: 'uppercase' }}>
              Select Contract
            </span>
          </div>

          {/* Contract List */}
          <div style={{ maxHeight: 280, overflowY: 'auto' }}>
            {Object.entries(contracts).map(([key, contract]) => {
              const isSelected = key === selectedContract;
              // Only GC and BTC-SPOT are fully supported
              const isSupported = key.startsWith('GC') || key === 'BTC-SPOT';
              const isComingSoon = !isSupported;

              return (
                <div
                  key={key}
                  onClick={() => {
                    if (!isComingSoon) {
                      onContractChange(key);
                      setIsOpen(false);
                    }
                  }}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12,
                    padding: '12px 14px',
                    cursor: isComingSoon ? 'not-allowed' : 'pointer',
                    opacity: isComingSoon ? 0.4 : 1,
                    background: isSelected
                      ? 'linear-gradient(90deg, rgba(0,255,136,0.2) 0%, transparent 100%)'
                      : 'transparent',
                    borderLeft: isSelected ? '3px solid #00ff88' : '3px solid transparent',
                    transition: 'all 0.15s ease',
                  }}
                  onMouseEnter={(e) => {
                    if (!isSelected && !isComingSoon) {
                      e.currentTarget.style.background = 'rgba(255,255,255,0.05)';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!isSelected && !isComingSoon) {
                      e.currentTarget.style.background = 'transparent';
                    }
                  }}
                >
                  {/* Icon */}
                  <div style={{
                    width: 36,
                    height: 36,
                    borderRadius: 8,
                    background: isSelected ? 'rgba(0,255,136,0.2)' : 'rgba(255,255,255,0.05)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: 18,
                    filter: isComingSoon ? 'grayscale(100%)' : 'none'
                  }}>
                    {contract.icon || 'üìà'}
                  </div>

                  {/* Contract Info */}
                  <div style={{ flex: 1 }}>
                    <div style={{
                      fontSize: 13,
                      fontWeight: 700,
                      color: isSelected ? '#00ff88' : (isComingSoon ? '#555' : '#fff'),
                      fontFamily: "'JetBrains Mono', monospace",
                      marginBottom: 2,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 8
                    }}>
                      {contract.symbol}
                      {isComingSoon && (
                        <span style={{
                          fontSize: 8,
                          padding: '2px 6px',
                          background: 'rgba(255,170,0,0.2)',
                          color: '#ffaa00',
                          borderRadius: 4,
                          fontWeight: 600,
                          letterSpacing: 0.5
                        }}>
                          COMING SOON
                        </span>
                      )}
                    </div>
                    <div style={{ fontSize: 10, color: isComingSoon ? '#444' : '#888' }}>
                      {contract.name}
                    </div>
                  </div>

                  {/* Selected Check */}
                  {isSelected && (
                    <div style={{
                      width: 20,
                      height: 20,
                      borderRadius: '50%',
                      background: '#00ff88',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                        <path d="M2 6L5 9L10 3" stroke="#000" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                      </svg>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Footer hint */}
          <div style={{
            padding: '8px 14px',
            borderTop: '1px solid rgba(255,255,255,0.05)',
            background: 'rgba(0,0,0,0.2)'
          }}>
            <span style={{ fontSize: 9, color: '#555' }}>
              Live data from Databento
            </span>
          </div>
        </div>
      )}

      {/* CSS Animation & Custom Scrollbars */}
      <style>{`
        @keyframes slideUp {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbars for Windows users */
        .tpo-scroll-container::-webkit-scrollbar {
          width: 10px;
          height: 10px;
        }

        .tpo-scroll-container::-webkit-scrollbar-track {
          background: rgba(20, 20, 28, 0.8);
          border-radius: 5px;
        }

        .tpo-scroll-container::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, rgba(100, 100, 120, 0.6) 0%, rgba(70, 70, 90, 0.6) 100%);
          border-radius: 5px;
          border: 2px solid rgba(20, 20, 28, 0.8);
        }

        .tpo-scroll-container::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, rgba(130, 130, 150, 0.8) 0%, rgba(100, 100, 120, 0.8) 100%);
        }

        .tpo-scroll-container::-webkit-scrollbar-corner {
          background: rgba(20, 20, 28, 0.8);
        }

        /* Firefox scrollbar support */
        .tpo-scroll-container {
          scrollbar-width: thin;
          scrollbar-color: rgba(100, 100, 120, 0.6) rgba(20, 20, 28, 0.8);
        }
      `}</style>
    </div>
  );
};

// Floating Footer Component - Shows contract, time, price (responsive)
const FloatingFooter = ({ globalData, selectedContract, onContractChange, contracts, isMobile }) => {
  // Check for any live or connected data source
  // LIVE = actively receiving data (DATABENTO_LIVE, BINANCE_WS, YFINANCE, etc.)
  // RECONNECTING = waiting for connection (RECONNECTING, WAITING_CONNECTION_SLOT, INITIALIZING)
  // OFFLINE = no connection possible
  const offlineStates = ['DISCONNECTED', 'NO_DATABENTO_LIB', 'NO_API_KEY', 'ERROR'];
  const waitingStates = ['INITIALIZING', 'SWITCHING...', 'WAITING_CONNECTION_SLOT', 'RESETTING...'];
  const isReconnecting = globalData?.data_source?.includes('RECONNECTING') ||
                         waitingStates.includes(globalData?.data_source);
  const isLive = globalData?.data_source &&
    !offlineStates.includes(globalData.data_source) &&
    !isReconnecting;

  // Connection status: LIVE (green), RECONNECTING (yellow), OFFLINE (red)
  const connectionStatus = isLive ? 'LIVE' : isReconnecting ? 'RECONNECTING' : 'OFFLINE';
  const statusColor = isLive ? '#00ff88' : isReconnecting ? '#ffaa00' : '#ff4466';

  // Mobile: Two-line footer with full info
  if (isMobile) {
    return (
      <div style={{
        position: 'fixed',
        bottom: 0,
        left: 0,
        right: 0,
        background: 'linear-gradient(180deg, rgba(10,10,15,0.98) 0%, rgba(5,5,10,1) 100%)',
        borderTop: '1px solid rgba(0,255,136,0.3)',
        padding: '8px 12px',
        zIndex: 1000,
        backdropFilter: 'blur(10px)',
      }}>
        {/* Row 1: Contract, Price, Time */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          marginBottom: 6,
        }}>
          <ContractDropdown
            selectedContract={selectedContract}
            onContractChange={onContractChange}
            contracts={contracts}
            isMobile={true}
          />

          <div style={{
            padding: '6px 14px',
            background: isLive ? 'rgba(0,255,136,0.15)' : isReconnecting ? 'rgba(255,170,0,0.1)' : 'rgba(255,255,255,0.03)',
            border: `1px solid ${isLive ? 'rgba(0,255,136,0.4)' : isReconnecting ? 'rgba(255,170,0,0.3)' : 'rgba(255,255,255,0.1)'}`,
            borderRadius: 8,
          }}>
            <span style={{
              fontSize: 16,
              fontWeight: 700,
              color: isLive ? '#00ff88' : isReconnecting ? '#ffaa00' : '#666',
              fontFamily: "'JetBrains Mono', monospace",
            }}>
              ${globalData?.current_price?.toFixed(2) || '----.--'}
            </span>
          </div>

          <div style={{
            padding: '6px 10px',
            background: 'rgba(255,255,255,0.03)',
            borderRadius: 6,
          }}>
            <span style={{
              fontSize: 12,
              fontWeight: 600,
              color: '#fff',
              fontFamily: "'JetBrains Mono', monospace",
            }}>
              {globalData?.current_et_time || '--:--'}
            </span>
          </div>
        </div>

        {/* Row 2: Status info */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: 12,
          padding: '4px 0',
          borderTop: '1px solid rgba(255,255,255,0.05)',
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
            <div style={{
              width: 6,
              height: 6,
              borderRadius: '50%',
              background: statusColor,
              boxShadow: `0 0 6px ${statusColor}`,
              animation: (isLive || isReconnecting) ? 'pulse 2s infinite' : 'none'
            }} />
            <span style={{ fontSize: 9, fontWeight: 700, color: statusColor }}>
              {connectionStatus}
            </span>
          </div>
          <span style={{ color: '#444', fontSize: 9 }}>|</span>
          <span style={{ fontSize: 9, color: '#666' }}>
            LATENCY: <span style={{ color: isLive ? '#00ff88' : '#666' }}>{isLive ? '~10ms' : isReconnecting ? '...' : '--'}</span>
          </span>
          <span style={{ color: '#444', fontSize: 9 }}>|</span>
          <span style={{ fontSize: 9, color: isLive ? '#00aaff' : isReconnecting ? '#ffaa00' : '#666' }}>
            {globalData?.data_source || 'DISCONNECTED'}
          </span>
        </div>
      </div>
    );
  }

  // Desktop: Full footer
  return (
    <div style={{
      position: 'fixed',
      bottom: 0,
      left: 0,
      right: 0,
      background: 'linear-gradient(180deg, rgba(10,10,15,0.95) 0%, rgba(5,5,10,0.98) 100%)',
      borderTop: '1px solid rgba(0,255,136,0.2)',
      padding: '12px 24px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      gap: 24,
      zIndex: 1000,
      backdropFilter: 'blur(10px)',
      boxShadow: '0 -4px 20px rgba(0,0,0,0.5)'
    }}>
      {/* Contract Selector */}
      <ContractDropdown
        selectedContract={selectedContract}
        onContractChange={onContractChange}
        contracts={contracts}
        isMobile={false}
      />

      {/* Separator */}
      <div style={{ width: 1, height: 30, background: 'rgba(255,255,255,0.1)' }} />

      {/* ET Time */}
      <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
        <div style={{
          padding: '8px 16px',
          background: 'rgba(255,255,255,0.03)',
          border: '1px solid rgba(255,255,255,0.1)',
          borderRadius: 6,
          display: 'flex',
          alignItems: 'center',
          gap: 8
        }}>
          <span style={{ fontSize: 11, color: '#666' }}>ET</span>
          <span style={{
            fontSize: 18,
            fontWeight: 700,
            color: '#fff',
            fontFamily: "'JetBrains Mono', monospace",
            letterSpacing: 1
          }}>
            {globalData?.current_et_time || '--:--:--'}
          </span>
        </div>
      </div>

      {/* Separator */}
      <div style={{ width: 1, height: 30, background: 'rgba(255,255,255,0.1)' }} />

      {/* Current Price */}
      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
        <span style={{ fontSize: 11, color: '#666', textTransform: 'uppercase', letterSpacing: 1 }}>Price</span>
        <div style={{
          padding: '8px 20px',
          background: isLive ? 'rgba(0,255,136,0.15)' : isReconnecting ? 'rgba(255,170,0,0.1)' : 'rgba(255,255,255,0.03)',
          border: `1px solid ${isLive ? 'rgba(0,255,136,0.4)' : isReconnecting ? 'rgba(255,170,0,0.3)' : 'rgba(255,255,255,0.1)'}`,
          borderRadius: 6,
          boxShadow: isLive ? '0 0 20px rgba(0,255,136,0.2)' : isReconnecting ? '0 0 15px rgba(255,170,0,0.15)' : 'none'
        }}>
          <span style={{
            fontSize: 20,
            fontWeight: 700,
            color: isLive ? '#00ff88' : isReconnecting ? '#ffaa00' : '#666',
            fontFamily: "'JetBrains Mono', monospace",
            textShadow: isLive ? '0 0 10px rgba(0,255,136,0.5)' : 'none'
          }}>
            ${globalData?.current_price?.toFixed(2) || '----.--'}
          </span>
        </div>
      </div>

      {/* Contract Name */}
      <div style={{
        padding: '6px 12px',
        background: 'rgba(255,255,255,0.02)',
        borderRadius: 4,
        fontSize: 11,
        color: '#888'
      }}>
        {contracts[selectedContract]?.name || 'Gold Apr 2026'}
      </div>

      {/* Separator */}
      <div style={{ width: 1, height: 30, background: 'rgba(255,255,255,0.1)' }} />

      {/* Data Connection Status */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: 12,
        padding: '6px 14px',
        background: 'rgba(0,0,0,0.3)',
        border: '1px solid rgba(255,255,255,0.1)',
        borderRadius: 6
      }}>
        {/* Live indicator dots */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
          <div style={{
            width: 6,
            height: 6,
            borderRadius: '50%',
            background: statusColor,
            boxShadow: `0 0 6px ${statusColor}`,
            animation: (isLive || isReconnecting) ? 'pulse 2s infinite' : 'none'
          }} />
          <div style={{
            width: 6,
            height: 6,
            borderRadius: '50%',
            background: statusColor,
            boxShadow: `0 0 6px ${statusColor}`,
            animation: (isLive || isReconnecting) ? 'pulse 2s infinite 0.3s' : 'none'
          }} />
          <span style={{
            fontSize: 11,
            fontWeight: 700,
            color: statusColor,
            marginLeft: 4,
            textTransform: 'uppercase',
            letterSpacing: 1
          }}>
            {connectionStatus}
          </span>
        </div>

        {/* Separator */}
        <div style={{ width: 1, height: 16, background: 'rgba(255,255,255,0.15)' }} />

        {/* Latency */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
          <span style={{ fontSize: 10, color: '#666', letterSpacing: 0.5 }}>LATENCY:</span>
          <span style={{ fontSize: 11, color: statusColor, fontWeight: 600, fontFamily: "'JetBrains Mono', monospace" }}>
            {isLive ? '~10ms' : isReconnecting ? '...' : '--'}
          </span>
          {isLive && (
            <span style={{
              fontSize: 9,
              padding: '2px 6px',
              background: 'rgba(0,255,136,0.2)',
              border: '1px solid rgba(0,255,136,0.3)',
              borderRadius: 3,
              color: '#00ff88',
              fontWeight: 600
            }}>
              EXCELLENT
            </span>
          )}
          {isReconnecting && (
            <span style={{
              fontSize: 9,
              padding: '2px 6px',
              background: 'rgba(255,170,0,0.2)',
              border: '1px solid rgba(255,170,0,0.3)',
              borderRadius: 3,
              color: '#ffaa00',
              fontWeight: 600
            }}>
              WAITING
            </span>
          )}
        </div>

        {/* Separator */}
        <div style={{ width: 1, height: 16, background: 'rgba(255,255,255,0.15)' }} />

        {/* Source */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
          <span style={{ fontSize: 10, color: '#666', letterSpacing: 0.5 }}>SOURCE:</span>
          <span style={{
            fontSize: 11,
            color: isLive ? '#00aaff' : isReconnecting ? '#ffaa00' : '#666',
            fontWeight: 600,
            fontFamily: "'JetBrains Mono', monospace"
          }}>
            {globalData?.data_source || 'DISCONNECTED'}
          </span>
        </div>
      </div>
    </div>
  );
};

// ============================================
// CLAWD BOT TRADE ANALYTICS
// Deep performance analysis of Clawd bot signals
// ============================================
const ClawdAnalytics = ({ selectedContract }) => {
  const [analytics, setAnalytics] = useState(null);
  const [comparison, setComparison] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedFilter, setSelectedFilter] = useState('all'); // all, high, medium
  const [viewMode, setViewMode] = useState('performance'); // performance, comparison
  const [dateFilter, setDateFilter] = useState('all'); // all, today, 7d, 30d, custom
  const [customDateRange, setCustomDateRange] = useState({ start: '', end: '' });
  const [tradeViewFilter, setTradeViewFilter] = useState('all'); // all, zone_aligned, mid_session
  const [tradesPage, setTradesPage] = useState(0); // Pagination for trades
  const TRADES_PER_PAGE = 20;
  const { isMobile } = useResponsive();

  // Mouse tracking removed - tooltip disabled for performance

  useEffect(() => {
    const fetchAnalytics = async () => {
      try {
        // Fetch both analytics and comparison data in parallel
        const [analyticsRes, comparisonRes] = await Promise.all([
          fetch(`${API_BASE}/trade-analytics?_t=${Date.now()}`),
          fetch(`${API_BASE}/zone-clawd-comparison?_t=${Date.now()}`)
        ]);

        if (analyticsRes.ok) {
          const data = await analyticsRes.json();
          setAnalytics(data);
          setError(null);
        } else {
          setError('Failed to fetch analytics');
        }

        if (comparisonRes.ok) {
          const compData = await comparisonRes.json();
          setComparison(compData);
        }
      } catch (e) {
        setError('Connection error: ' + e.message);
      }
      setLoading(false);
    };

    fetchAnalytics();
    const interval = setInterval(fetchAnalytics, 30000); // Refresh every 30s
    return () => clearInterval(interval);
  }, [selectedContract]); // Refresh when contract changes

  if (loading) {
    return (
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: 400, color: '#888' }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: 40, marginBottom: 16 }}>ü§ñ</div>
          <div>Loading Clawd Analytics...</div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div style={{ padding: 24, background: 'rgba(255,68,102,0.1)', border: '1px solid rgba(255,68,102,0.3)', borderRadius: 12, color: '#ff6b6b' }}>
        ‚ö†Ô∏è {error}
      </div>
    );
  }

  if (!analytics) return null;

  const { summary, by_confidence, by_direction, target_hit_rates, drawdown, trades } = analytics;

  // Filter trades based on selection
  const filteredTrades = selectedFilter === 'all' ? trades :
    trades.filter(t => t.confidence === selectedFilter.toUpperCase());

  // Calculate filtered stats
  const filteredStats = selectedFilter === 'all' ? summary : by_confidence[selectedFilter.toUpperCase()];

  return (
    <div style={{ maxWidth: 1400, margin: '0 auto', padding: isMobile ? 16 : 24 }}>
      {/* Header */}
      <div style={{ marginBottom: 24 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>
          <span style={{ fontSize: 28 }}>ü§ñ</span>
          <h1 style={{ fontSize: 24, fontWeight: 700, color: '#fff', margin: 0 }}>Clawd Bot Analytics</h1>
        </div>
        <p style={{ color: '#888', fontSize: 14 }}>Deep performance analysis of AI-generated trade signals</p>
      </div>

      {/* View Mode Toggle */}
      <div style={{ display: 'flex', gap: 8, marginBottom: 16 }}>
        <button
          onClick={() => setViewMode('performance')}
          style={{
            padding: '10px 20px',
            borderRadius: 8,
            border: viewMode === 'performance' ? '2px solid #00aaff' : '1px solid rgba(255,255,255,0.1)',
            background: viewMode === 'performance' ? 'rgba(0,170,255,0.15)' : 'transparent',
            color: viewMode === 'performance' ? '#00aaff' : '#888',
            fontSize: 14,
            fontWeight: 600,
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: 8,
          }}
        >
          üìä Performance
        </button>
        <button
          onClick={() => setViewMode('comparison')}
          style={{
            padding: '10px 20px',
            borderRadius: 8,
            border: viewMode === 'comparison' ? '2px solid #9370DB' : '1px solid rgba(255,255,255,0.1)',
            background: viewMode === 'comparison' ? 'rgba(147,112,219,0.15)' : 'transparent',
            color: viewMode === 'comparison' ? '#9370DB' : '#888',
            fontSize: 14,
            fontWeight: 600,
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: 8,
          }}
        >
          üéØ Zone vs Clawd
        </button>
      </div>

      {/* Filter Tabs - only show in performance view */}
      {viewMode === 'performance' && (
      <div style={{ display: 'flex', gap: 8, marginBottom: 24 }}>
        {[
          { id: 'all', label: 'All Signals', count: summary.evaluated },
          { id: 'high', label: 'HIGH Confidence', count: by_confidence.HIGH?.count || 0, color: '#00ff88' },
          { id: 'medium', label: 'MEDIUM Confidence', count: by_confidence.MEDIUM?.count || 0, color: '#ffaa00' },
        ].map(filter => (
          <button
            key={filter.id}
            onClick={() => setSelectedFilter(filter.id)}
            style={{
              padding: '10px 16px',
              borderRadius: 8,
              border: selectedFilter === filter.id ? `2px solid ${filter.color || '#00ff88'}` : '1px solid rgba(255,255,255,0.1)',
              background: selectedFilter === filter.id ? `${filter.color || '#00ff88'}15` : 'transparent',
              color: selectedFilter === filter.id ? (filter.color || '#00ff88') : '#888',
              fontSize: 13,
              fontWeight: 600,
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: 8,
            }}
          >
            {filter.label}
            <span style={{
              background: 'rgba(255,255,255,0.1)',
              padding: '2px 8px',
              borderRadius: 4,
              fontSize: 11,
            }}>{filter.count}</span>
          </button>
        ))}
      </div>
      )}

      {/* ============================================ */}
      {/* ZONE vs CLAWD COMPARISON VIEW */}
      {/* ============================================ */}
      {viewMode === 'comparison' && comparison && (
        <div>
          {/* Comparison Header */}
          <div style={{
            padding: 24,
            background: 'linear-gradient(135deg, rgba(147,112,219,0.1) 0%, rgba(100,80,180,0.05) 100%)',
            border: '2px solid rgba(147,112,219,0.3)',
            borderRadius: 16,
            marginBottom: 24
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 16 }}>
              <span style={{ fontSize: 28 }}>üéØ</span>
              <h2 style={{ fontSize: 20, fontWeight: 700, color: '#9370DB', margin: 0 }}>Zone Participation vs Clawd Bot</h2>
            </div>
            <p style={{ color: '#888', fontSize: 14, marginBottom: 16 }}>
              1:1 comparison of zone-aligned entries vs overall Clawd performance
            </p>

            {/* Key Insight Box */}
            <div style={{
              padding: 16,
              background: 'rgba(0,0,0,0.3)',
              borderRadius: 12,
              border: '1px solid rgba(255,255,255,0.1)'
            }}>
              <div style={{ fontSize: 12, color: '#9370DB', fontWeight: 600, marginBottom: 8 }}>üí° KEY INSIGHT</div>
              <div style={{ fontSize: 14, color: '#fff' }}>{comparison.insights?.zone_vs_random || 'Analyzing zone alignment...'}</div>
              <div style={{ fontSize: 12, color: '#888', marginTop: 8 }}>{comparison.insights?.recommendation || ''}</div>
            </div>
          </div>

          {/* Date Filter Controls */}
          <div style={{
            display: 'flex',
            flexWrap: 'wrap',
            gap: 8,
            marginBottom: 20,
            padding: 16,
            background: 'rgba(255,255,255,0.02)',
            borderRadius: 12,
            border: '1px solid rgba(255,255,255,0.08)',
            alignItems: 'center'
          }}>
            <span style={{ fontSize: 12, color: '#888', marginRight: 8 }}>üìÖ Filter by Date:</span>
            {[
              { id: 'all', label: 'All Time' },
              { id: 'today', label: 'Today' },
              { id: '7d', label: '7 Days' },
              { id: '30d', label: '30 Days' },
              { id: 'custom', label: 'Custom Range' },
            ].map(filter => (
              <button
                key={filter.id}
                onClick={() => setDateFilter(filter.id)}
                style={{
                  padding: '6px 12px',
                  borderRadius: 6,
                  border: dateFilter === filter.id ? '1px solid #9370DB' : '1px solid rgba(255,255,255,0.1)',
                  background: dateFilter === filter.id ? 'rgba(147,112,219,0.2)' : 'transparent',
                  color: dateFilter === filter.id ? '#9370DB' : '#888',
                  fontSize: 12,
                  fontWeight: 500,
                  cursor: 'pointer',
                }}
              >
                {filter.label}
              </button>
            ))}
            {/* Custom Date Range Inputs */}
            {dateFilter === 'custom' && (
              <div style={{ display: 'flex', gap: 8, alignItems: 'center', marginLeft: 12 }}>
                <input
                  type="date"
                  value={customDateRange.start}
                  onChange={(e) => setCustomDateRange(prev => ({ ...prev, start: e.target.value }))}
                  style={{
                    padding: '6px 10px',
                    borderRadius: 6,
                    border: '1px solid rgba(147,112,219,0.3)',
                    background: 'rgba(0,0,0,0.3)',
                    color: '#fff',
                    fontSize: 12,
                  }}
                />
                <span style={{ color: '#888', fontSize: 12 }}>to</span>
                <input
                  type="date"
                  value={customDateRange.end}
                  onChange={(e) => setCustomDateRange(prev => ({ ...prev, end: e.target.value }))}
                  style={{
                    padding: '6px 10px',
                    borderRadius: 6,
                    border: '1px solid rgba(147,112,219,0.3)',
                    background: 'rgba(0,0,0,0.3)',
                    color: '#fff',
                    fontSize: 12,
                  }}
                />
              </div>
            )}
          </div>

          {/* Zone Alignment Stats - Filtered by Date */}
          {(() => {
            // Filter trades by date first
            const filterByDate = (trades) => {
              if (!trades || dateFilter === 'all') return trades || [];
              const now = new Date();
              return trades.filter(trade => {
                if (!trade.timestamp) return true;
                const tradeDate = new Date(trade.timestamp * 1000);
                if (dateFilter === 'today') {
                  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                  return tradeDate >= today;
                } else if (dateFilter === '7d') {
                  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                  return tradeDate >= weekAgo;
                } else if (dateFilter === '30d') {
                  const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                  return tradeDate >= monthAgo;
                } else if (dateFilter === 'custom') {
                  if (customDateRange.start && tradeDate < new Date(customDateRange.start)) return false;
                  if (customDateRange.end) {
                    const endDate = new Date(customDateRange.end);
                    endDate.setHours(23, 59, 59, 999);
                    if (tradeDate > endDate) return false;
                  }
                }
                return true;
              });
            };

            const filteredTrades = filterByDate(comparison.trades);
            const zoneAligned = filteredTrades.filter(t => t.zone_aligned);
            const midSession = filteredTrades.filter(t => !t.zone_aligned);

            const zoneWins = zoneAligned.filter(t => t.result === 'WIN').length;
            const midWins = midSession.filter(t => t.result === 'WIN').length;
            const zoneWinRate = zoneAligned.length > 0 ? Math.round(zoneWins / zoneAligned.length * 100) : 0;
            const midWinRate = midSession.length > 0 ? Math.round(midWins / midSession.length * 100) : 0;
            const advantage = zoneWinRate - midWinRate;

            // Calculate avg Entry, SL, TP for comparison
            const avgZoneEntry = zoneAligned.length > 0 ? zoneAligned.reduce((sum, t) => sum + (t.entry_price || 0), 0) / zoneAligned.length : 0;
            const avgZoneSL = zoneAligned.length > 0 ? zoneAligned.reduce((sum, t) => sum + Math.abs((t.entry_price || 0) - (t.stop || 0)), 0) / zoneAligned.length : 0;
            const avgZoneTP = zoneAligned.length > 0 ? zoneAligned.reduce((sum, t) => sum + Math.abs((t.targets?.[0] || t.entry_price) - (t.entry_price || 0)), 0) / zoneAligned.length : 0;
            const avgZoneRR = avgZoneSL > 0 ? avgZoneTP / avgZoneSL : 0;

            const avgMidEntry = midSession.length > 0 ? midSession.reduce((sum, t) => sum + (t.entry_price || 0), 0) / midSession.length : 0;
            const avgMidSL = midSession.length > 0 ? midSession.reduce((sum, t) => sum + Math.abs((t.entry_price || 0) - (t.stop || 0)), 0) / midSession.length : 0;
            const avgMidTP = midSession.length > 0 ? midSession.reduce((sum, t) => sum + Math.abs((t.targets?.[0] || t.entry_price) - (t.entry_price || 0)), 0) / midSession.length : 0;
            const avgMidRR = avgMidSL > 0 ? avgMidTP / avgMidSL : 0;

            return (
              <>
          <div style={{
            display: 'grid',
            gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)',
            gap: 24,
            marginBottom: 24
          }}>
            {/* Zone-Aligned Trades */}
            <div style={{
              padding: 24,
              background: 'linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,180,100,0.05) 100%)',
              border: '2px solid rgba(0,255,136,0.3)',
              borderRadius: 16
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 20 }}>
                <div style={{ width: 12, height: 12, borderRadius: '50%', background: '#00ff88' }} />
                <span style={{ fontSize: 16, fontWeight: 700, color: '#00ff88' }}>Zone-Aligned Entries</span>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16, marginBottom: 16 }}>
                <div>
                  <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>TRADES</div>
                  <div style={{ fontSize: 28, fontWeight: 700, color: '#fff' }}>{zoneAligned.length}</div>
                </div>
                <div>
                  <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>WIN RATE</div>
                  <div style={{ fontSize: 28, fontWeight: 700, color: '#00ff88' }}>{zoneWinRate}%</div>
                </div>
              </div>
              {/* Entry/SL/TP Stats */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8, marginBottom: 12 }}>
                <div style={{ padding: 8, background: 'rgba(0,0,0,0.3)', borderRadius: 6, textAlign: 'center' }}>
                  <div style={{ fontSize: 9, color: '#888' }}>AVG SL</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#ff4466' }}>{avgZoneSL.toFixed(1)}pts</div>
                </div>
                <div style={{ padding: 8, background: 'rgba(0,0,0,0.3)', borderRadius: 6, textAlign: 'center' }}>
                  <div style={{ fontSize: 9, color: '#888' }}>AVG TP</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#00ff88' }}>{avgZoneTP.toFixed(1)}pts</div>
                </div>
                <div style={{ padding: 8, background: 'rgba(0,0,0,0.3)', borderRadius: 6, textAlign: 'center' }}>
                  <div style={{ fontSize: 9, color: '#888' }}>AVG R:R</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#00aaff' }}>{avgZoneRR.toFixed(1)}:1</div>
                </div>
              </div>
              <div style={{ padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                <div style={{ fontSize: 11, color: '#666' }}>Entries within 20pts of zone boundary</div>
              </div>
            </div>

            {/* Non Zone-Aligned Trades */}
            <div style={{
              padding: 24,
              background: 'linear-gradient(135deg, rgba(255,170,0,0.1) 0%, rgba(200,130,0,0.05) 100%)',
              border: '2px solid rgba(255,170,0,0.3)',
              borderRadius: 16
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 20 }}>
                <div style={{ width: 12, height: 12, borderRadius: '50%', background: '#ffaa00' }} />
                <span style={{ fontSize: 16, fontWeight: 700, color: '#ffaa00' }}>Mid-Session Entries (Clawd)</span>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16, marginBottom: 16 }}>
                <div>
                  <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>TRADES</div>
                  <div style={{ fontSize: 28, fontWeight: 700, color: '#fff' }}>{midSession.length}</div>
                </div>
                <div>
                  <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>WIN RATE</div>
                  <div style={{ fontSize: 28, fontWeight: 700, color: '#ffaa00' }}>{midWinRate}%</div>
                </div>
              </div>
              {/* Entry/SL/TP Stats */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8, marginBottom: 12 }}>
                <div style={{ padding: 8, background: 'rgba(0,0,0,0.3)', borderRadius: 6, textAlign: 'center' }}>
                  <div style={{ fontSize: 9, color: '#888' }}>AVG SL</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#ff4466' }}>{avgMidSL.toFixed(1)}pts</div>
                </div>
                <div style={{ padding: 8, background: 'rgba(0,0,0,0.3)', borderRadius: 6, textAlign: 'center' }}>
                  <div style={{ fontSize: 9, color: '#888' }}>AVG TP</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#00ff88' }}>{avgMidTP.toFixed(1)}pts</div>
                </div>
                <div style={{ padding: 8, background: 'rgba(0,0,0,0.3)', borderRadius: 6, textAlign: 'center' }}>
                  <div style={{ fontSize: 9, color: '#888' }}>AVG R:R</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: '#00aaff' }}>{avgMidRR.toFixed(1)}:1</div>
                </div>
              </div>
              <div style={{ padding: 12, background: 'rgba(0,0,0,0.2)', borderRadius: 8 }}>
                <div style={{ fontSize: 11, color: '#666' }}>{midSession.length === 0 ? 'No Clawd Bot signals in selected period' : 'Entries not aligned with zone boundaries'}</div>
              </div>
            </div>
          </div>

          {/* Win Rate Advantage */}
          {filteredTrades.length > 0 && (
            <div style={{
              padding: 20,
              background: advantage > 0 ? 'rgba(0,255,136,0.08)' : advantage < 0 ? 'rgba(255,68,102,0.08)' : 'rgba(255,255,255,0.05)',
              border: `2px solid ${advantage > 0 ? 'rgba(0,255,136,0.3)' : advantage < 0 ? 'rgba(255,68,102,0.3)' : 'rgba(255,255,255,0.2)'}`,
              borderRadius: 12,
              textAlign: 'center',
              marginBottom: 24
            }}>
              <div style={{ fontSize: 12, color: '#888', marginBottom: 8 }}>ZONE ALIGNMENT ADVANTAGE</div>
              <div style={{ fontSize: 40, fontWeight: 700, color: advantage > 0 ? '#00ff88' : advantage < 0 ? '#ff4466' : '#888' }}>
                {advantage > 0 ? '+' : ''}{advantage}%
              </div>
              <div style={{ fontSize: 13, color: '#888', marginTop: 8 }}>
                {midSession.length === 0
                  ? 'Add Clawd Bot signals to compare strategies'
                  : advantage > 0
                    ? 'Zone-aligned entries outperform mid-session entries'
                    : 'Mid-session entries currently performing better'}
              </div>
            </div>
          )}
              </>
            );
          })()}

          {/* Entry Accuracy Breakdown */}
          {comparison.entry_accuracy && (
            <div style={{
              padding: 24,
              background: 'rgba(0,170,255,0.05)',
              border: '1px solid rgba(0,170,255,0.2)',
              borderRadius: 16,
              marginBottom: 24
            }}>
              <div style={{ fontSize: 14, fontWeight: 600, color: '#00aaff', marginBottom: 16 }}>üéØ Entry Accuracy Analysis</div>
              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? 'repeat(2, 1fr)' : 'repeat(4, 1fr)', gap: 16 }}>
                <div style={{ textAlign: 'center', padding: 16, background: 'rgba(0,255,136,0.1)', borderRadius: 8 }}>
                  <div style={{ fontSize: 24, fontWeight: 700, color: '#00ff88' }}>{comparison.entry_accuracy.within_5pts || 0}</div>
                  <div style={{ fontSize: 11, color: '#888' }}>Within 5 pts</div>
                </div>
                <div style={{ textAlign: 'center', padding: 16, background: 'rgba(0,200,200,0.1)', borderRadius: 8 }}>
                  <div style={{ fontSize: 24, fontWeight: 700, color: '#00cccc' }}>{comparison.entry_accuracy.within_10pts || 0}</div>
                  <div style={{ fontSize: 11, color: '#888' }}>Within 10 pts</div>
                </div>
                <div style={{ textAlign: 'center', padding: 16, background: 'rgba(255,170,0,0.1)', borderRadius: 8 }}>
                  <div style={{ fontSize: 24, fontWeight: 700, color: '#ffaa00' }}>{comparison.entry_accuracy.within_20pts || 0}</div>
                  <div style={{ fontSize: 11, color: '#888' }}>Within 20 pts</div>
                </div>
                <div style={{ textAlign: 'center', padding: 16, background: 'rgba(255,68,102,0.1)', borderRadius: 8 }}>
                  <div style={{ fontSize: 24, fontWeight: 700, color: '#ff4466' }}>{comparison.entry_accuracy.missed || 0}</div>
                  <div style={{ fontSize: 11, color: '#888' }}>Missed Zone</div>
                </div>
              </div>
            </div>
          )}

          {/* Session Performance Breakdown */}
          {comparison.by_session && Object.keys(comparison.by_session).length > 0 && (
            <div style={{
              padding: 24,
              background: 'rgba(255,255,255,0.02)',
              border: '1px solid rgba(255,255,255,0.08)',
              borderRadius: 16,
              marginBottom: 24
            }}>
              <div style={{ fontSize: 14, fontWeight: 600, color: '#fff', marginBottom: 16 }}>üìÖ Performance by Session</div>
              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : 'repeat(3, 1fr)', gap: 12 }}>
                {Object.entries(comparison.by_session).map(([session, stats]) => (
                  <div key={session} style={{
                    padding: 16,
                    background: 'rgba(0,0,0,0.3)',
                    borderRadius: 8,
                    border: `1px solid ${stats.pnl >= 0 ? 'rgba(0,255,136,0.2)' : 'rgba(255,68,102,0.2)'}`
                  }}>
                    <div style={{ fontSize: 12, fontWeight: 600, color: '#00aaff', marginBottom: 8 }}>{session}</div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                      <span style={{ fontSize: 11, color: '#888' }}>Trades</span>
                      <span style={{ fontSize: 12, color: '#fff' }}>{stats.total}</span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                      <span style={{ fontSize: 11, color: '#888' }}>Win Rate</span>
                      <span style={{ fontSize: 12, color: stats.win_rate >= 50 ? '#00ff88' : '#ff4466' }}>{stats.win_rate}%</span>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: 11, color: '#888' }}>P&L</span>
                      <span style={{ fontSize: 12, fontWeight: 600, color: stats.pnl >= 0 ? '#00ff88' : '#ff4466' }}>
                        ${stats.pnl?.toLocaleString() || 0}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Best/Worst Session Insights */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)',
            gap: 16,
            marginBottom: 24
          }}>
            <div style={{
              padding: 20,
              background: 'rgba(0,255,136,0.05)',
              border: '1px solid rgba(0,255,136,0.2)',
              borderRadius: 12
            }}>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 8 }}>üèÜ BEST SESSION</div>
              <div style={{ fontSize: 14, fontWeight: 600, color: '#00ff88' }}>{comparison.insights?.best_session || 'N/A'}</div>
            </div>
            <div style={{
              padding: 20,
              background: 'rgba(255,68,102,0.05)',
              border: '1px solid rgba(255,68,102,0.2)',
              borderRadius: 12
            }}>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 8 }}>‚ö†Ô∏è NEEDS IMPROVEMENT</div>
              <div style={{ fontSize: 14, fontWeight: 600, color: '#ff4466' }}>{comparison.insights?.worst_session || 'N/A'}</div>
            </div>
          </div>

          {/* ============================================ */}
          {/* TRADE ENTRIES VISUALIZATION */}
          {/* ============================================ */}
          {comparison.trades && comparison.trades.length > 0 && (
            <div style={{
              padding: 24,
              background: 'rgba(255,255,255,0.02)',
              border: '1px solid rgba(255,255,255,0.08)',
              borderRadius: 16,
              marginBottom: 24
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                  <span style={{ fontSize: 20 }}>üìä</span>
                  <span style={{ fontSize: 16, fontWeight: 700, color: '#fff' }}>Trade Entries Comparison</span>
                  <span style={{ fontSize: 12, color: '#888' }}>({comparison.trades.length} trades)</span>
                </div>
                {/* Trade Type Filter */}
                <div style={{ display: 'flex', gap: 8 }}>
                  {[
                    { id: 'all', label: 'All', color: '#00aaff' },
                    { id: 'zone_aligned', label: 'Zone-Aligned', color: '#00ff88' },
                    { id: 'mid_session', label: 'Mid-Session', color: '#ffaa00' },
                  ].map(filter => (
                    <button
                      key={filter.id}
                      onClick={() => setTradeViewFilter(filter.id)}
                      style={{
                        padding: '4px 10px',
                        borderRadius: 4,
                        border: tradeViewFilter === filter.id ? `1px solid ${filter.color}` : '1px solid rgba(255,255,255,0.1)',
                        background: tradeViewFilter === filter.id ? `${filter.color}20` : 'transparent',
                        color: tradeViewFilter === filter.id ? filter.color : '#666',
                        fontSize: 11,
                        fontWeight: 500,
                        cursor: 'pointer',
                      }}
                    >
                      {filter.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Trades List with Pagination */}
              {(() => {
                const filteredTrades = comparison.trades.filter(trade => {
                  if (tradeViewFilter === 'zone_aligned' && !trade.zone_aligned) return false;
                  if (tradeViewFilter === 'mid_session' && trade.zone_aligned) return false;
                  if (dateFilter !== 'all' && trade.timestamp) {
                    const tradeDate = new Date(trade.timestamp * 1000);
                    const now = new Date();
                    if (dateFilter === 'today') {
                      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                      if (tradeDate < today) return false;
                    } else if (dateFilter === '7d') {
                      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                      if (tradeDate < weekAgo) return false;
                    } else if (dateFilter === '30d') {
                      const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                      if (tradeDate < monthAgo) return false;
                    } else if (dateFilter === 'custom') {
                      if (customDateRange.start && tradeDate < new Date(customDateRange.start)) return false;
                      if (customDateRange.end) {
                        const endDate = new Date(customDateRange.end);
                        endDate.setHours(23, 59, 59, 999);
                        if (tradeDate > endDate) return false;
                      }
                    }
                  }
                  return true;
                });
                const totalPages = Math.ceil(filteredTrades.length / TRADES_PER_PAGE);
                const paginatedTrades = filteredTrades.slice(tradesPage * TRADES_PER_PAGE, (tradesPage + 1) * TRADES_PER_PAGE);

                return (
                  <>
                    {/* Pagination Controls */}
                    {totalPages > 1 && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, padding: '8px 0' }}>
                        <span style={{ fontSize: 12, color: '#888' }}>
                          Showing {tradesPage * TRADES_PER_PAGE + 1}-{Math.min((tradesPage + 1) * TRADES_PER_PAGE, filteredTrades.length)} of {filteredTrades.length}
                        </span>
                        <div style={{ display: 'flex', gap: 8 }}>
                          <button
                            onClick={() => setTradesPage(Math.max(0, tradesPage - 1))}
                            disabled={tradesPage === 0}
                            style={{
                              padding: '6px 12px', borderRadius: 6, border: '1px solid rgba(255,255,255,0.1)',
                              background: tradesPage === 0 ? 'transparent' : 'rgba(147,112,219,0.2)',
                              color: tradesPage === 0 ? '#666' : '#9370DB', fontSize: 12, cursor: tradesPage === 0 ? 'not-allowed' : 'pointer'
                            }}
                          >‚Üê Prev</button>
                          <span style={{ fontSize: 12, color: '#888', alignSelf: 'center' }}>Page {tradesPage + 1} of {totalPages}</span>
                          <button
                            onClick={() => setTradesPage(Math.min(totalPages - 1, tradesPage + 1))}
                            disabled={tradesPage >= totalPages - 1}
                            style={{
                              padding: '6px 12px', borderRadius: 6, border: '1px solid rgba(255,255,255,0.1)',
                              background: tradesPage >= totalPages - 1 ? 'transparent' : 'rgba(147,112,219,0.2)',
                              color: tradesPage >= totalPages - 1 ? '#666' : '#9370DB', fontSize: 12, cursor: tradesPage >= totalPages - 1 ? 'not-allowed' : 'pointer'
                            }}
                          >Next ‚Üí</button>
                        </div>
                      </div>
                    )}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {paginatedTrades.map((trade, idx) => (
                        <div
                          key={`${tradesPage}-${idx}`}
                          style={{
                            padding: 16,
                            background: trade.zone_aligned ? 'rgba(0,255,136,0.05)' : 'rgba(255,170,0,0.05)',
                            border: `1px solid ${trade.zone_aligned ? 'rgba(0,255,136,0.2)' : 'rgba(255,170,0,0.2)'}`,
                            borderRadius: 12,
                          }}
                    >
                      {/* Trade Header */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                          <span style={{
                            fontSize: 14,
                            padding: '2px 8px',
                            borderRadius: 4,
                            background: trade.direction === 'LONG' ? 'rgba(0,200,100,0.2)' : 'rgba(255,100,100,0.2)',
                            color: trade.direction === 'LONG' ? '#00cc66' : '#ff6666',
                            fontWeight: 600
                          }}>
                            {trade.direction === 'LONG' ? 'üìà' : 'üìâ'} {trade.direction}
                          </span>
                          <span style={{ fontSize: 12, color: '#888' }}>{trade.signal_time}</span>
                          <span style={{
                            fontSize: 10,
                            padding: '2px 6px',
                            borderRadius: 4,
                            background: trade.source === 'ZONE' ? 'rgba(0,255,136,0.2)' : 'rgba(147,112,219,0.2)',
                            color: trade.source === 'ZONE' ? '#00ff88' : '#9370DB'
                          }}>
                            {trade.source === 'ZONE' ? 'üéØ Zone Idea' : 'ü§ñ Clawd Bot'}
                          </span>
                          <span style={{
                            fontSize: 10,
                            padding: '2px 6px',
                            borderRadius: 4,
                            background: trade.zone_aligned ? 'rgba(0,255,136,0.15)' : 'rgba(255,170,0,0.15)',
                            color: trade.zone_aligned ? '#00ff88' : '#ffaa00'
                          }}>
                            {trade.zone_aligned ? '‚úì Zone-Aligned' : '‚óã Mid-Session'}
                          </span>
                        </div>
                        <div style={{
                          padding: '4px 12px',
                          borderRadius: 6,
                          background: trade.result === 'WIN' ? 'rgba(0,255,136,0.2)' : 'rgba(255,68,102,0.2)',
                          color: trade.result === 'WIN' ? '#00ff88' : '#ff4466',
                          fontWeight: 700,
                          fontSize: 13
                        }}>
                          {trade.result} {trade.pnl_dollars >= 0 ? '+' : ''}${trade.pnl_dollars?.toLocaleString() || 0}
                        </div>
                      </div>

                      {/* Entry/SL/TP Row with Points */}
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 8, marginBottom: 8 }}>
                        <div style={{ textAlign: 'center', padding: 8, background: 'rgba(0,170,255,0.1)', borderRadius: 6 }}>
                          <div style={{ fontSize: 9, color: '#888', marginBottom: 2 }}>ENTRY IDEA</div>
                          <div style={{ fontSize: 13, fontWeight: 600, color: '#00aaff' }}>${trade.entry_price?.toFixed(2)}</div>
                        </div>
                        <div style={{ textAlign: 'center', padding: 8, background: 'rgba(255,68,102,0.1)', borderRadius: 6 }}>
                          <div style={{ fontSize: 9, color: '#888', marginBottom: 2 }}>STOP LOSS</div>
                          <div style={{ fontSize: 13, fontWeight: 600, color: '#ff4466' }}>${trade.stop?.toFixed(2)}</div>
                          <div style={{ fontSize: 9, color: '#ff6666' }}>-{trade.trade_framework?.risk_pts?.toFixed(0) || Math.abs(trade.entry_price - trade.stop).toFixed(0)}pts</div>
                        </div>
                        <div style={{ textAlign: 'center', padding: 8, background: 'rgba(0,255,136,0.1)', borderRadius: 6 }}>
                          <div style={{ fontSize: 9, color: '#888', marginBottom: 2 }}>T1 IDEA</div>
                          <div style={{ fontSize: 13, fontWeight: 600, color: trade.t1_hit ? '#00ff88' : '#666' }}>
                            ${trade.targets?.[0]?.toFixed(2) || '-'}
                            {trade.t1_hit && <span style={{ marginLeft: 2, fontSize: 9 }}>‚úì</span>}
                          </div>
                          {trade.targets?.[0] && <div style={{ fontSize: 9, color: '#00cc88' }}>+{Math.abs(trade.targets[0] - trade.entry_price).toFixed(0)}pts</div>}
                        </div>
                        <div style={{ textAlign: 'center', padding: 8, background: 'rgba(0,255,136,0.08)', borderRadius: 6 }}>
                          <div style={{ fontSize: 9, color: '#888', marginBottom: 2 }}>T2 IDEA</div>
                          <div style={{ fontSize: 13, fontWeight: 600, color: trade.t2_hit ? '#00ff88' : '#666' }}>
                            ${trade.targets?.[1]?.toFixed(2) || '-'}
                            {trade.t2_hit && <span style={{ marginLeft: 2, fontSize: 9 }}>‚úì</span>}
                          </div>
                          {trade.targets?.[1] && <div style={{ fontSize: 9, color: '#00cc88' }}>+{Math.abs(trade.targets[1] - trade.entry_price).toFixed(0)}pts</div>}
                        </div>
                        <div style={{ textAlign: 'center', padding: 8, background: 'rgba(0,255,136,0.05)', borderRadius: 6 }}>
                          <div style={{ fontSize: 9, color: '#888', marginBottom: 2 }}>T3 IDEA</div>
                          <div style={{ fontSize: 13, fontWeight: 600, color: trade.t3_hit ? '#00ff88' : '#666' }}>
                            ${trade.targets?.[2]?.toFixed(2) || '-'}
                            {trade.t3_hit && <span style={{ marginLeft: 2, fontSize: 9 }}>‚úì</span>}
                          </div>
                          {trade.targets?.[2] && <div style={{ fontSize: 9, color: '#00cc88' }}>+{Math.abs(trade.targets[2] - trade.entry_price).toFixed(0)}pts</div>}
                        </div>
                      </div>

                      {/* Zone Info */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 11, color: '#666' }}>
                        <span>
                          {trade.closest_zone ? `üìç ${trade.closest_zone}` : 'üìç No zone nearby'}
                          {trade.entry_distance_from_zone !== undefined && ` (${trade.entry_distance_from_zone}pts away)`}
                        </span>
                        <span>MAE: {trade.mae}pts | MFE: {trade.mfe}pts | R:R {trade.rr?.toFixed(1)}:1</span>
                      </div>

                    </div>
                  ))}
              </div>

              </>
            );
          })()}
            </div>
          )}

          {/* ============================================ */}
          {/* ACCURACY TRENDS ANALYSIS */}
          {/* ============================================ */}
          {comparison.trades && comparison.trades.length > 0 && (() => {
            // Calculate accuracy trends for highest performance scenarios
            const trades = comparison.trades;

            // Zone-aligned performance by session
            const zoneAlignedBySession = {};
            const midSessionBySession = {};

            trades.forEach(t => {
              const bucket = t.zone_aligned ? zoneAlignedBySession : midSessionBySession;
              if (!bucket[t.session]) bucket[t.session] = { wins: 0, losses: 0, pnl: 0 };
              if (t.result === 'WIN') bucket[t.session].wins++;
              else bucket[t.session].losses++;
              bucket[t.session].pnl += t.pnl_dollars || 0;
            });

            // Find best performing scenarios
            const scenarios = [];
            Object.entries(zoneAlignedBySession).forEach(([session, stats]) => {
              const total = stats.wins + stats.losses;
              if (total >= 2) {
                scenarios.push({
                  type: 'Zone-Aligned',
                  session,
                  winRate: Math.round(stats.wins / total * 100),
                  trades: total,
                  pnl: stats.pnl,
                  color: '#00ff88'
                });
              }
            });
            Object.entries(midSessionBySession).forEach(([session, stats]) => {
              const total = stats.wins + stats.losses;
              if (total >= 2) {
                scenarios.push({
                  type: 'Mid-Session',
                  session,
                  winRate: Math.round(stats.wins / total * 100),
                  trades: total,
                  pnl: stats.pnl,
                  color: '#ffaa00'
                });
              }
            });

            // Sort by win rate
            scenarios.sort((a, b) => b.winRate - a.winRate);
            const topScenarios = scenarios.slice(0, 5);
            const bottomScenarios = scenarios.slice(-3).reverse();

            return (
              <div style={{
                padding: 24,
                background: 'linear-gradient(135deg, rgba(147,112,219,0.08) 0%, rgba(100,80,180,0.02) 100%)',
                border: '1px solid rgba(147,112,219,0.2)',
                borderRadius: 16,
                marginBottom: 24
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 20 }}>
                  <span style={{ fontSize: 20 }}>üìà</span>
                  <span style={{ fontSize: 16, fontWeight: 700, color: '#9370DB' }}>Accuracy Trends Analysis</span>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: 24 }}>
                  {/* Best Performing Scenarios */}
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 600, color: '#00ff88', marginBottom: 12 }}>üèÜ Highest Win Rate Scenarios</div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {topScenarios.map((s, i) => (
                        <div key={i} style={{
                          padding: 12,
                          background: 'rgba(0,255,136,0.08)',
                          border: '1px solid rgba(0,255,136,0.2)',
                          borderRadius: 8,
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}>
                          <div>
                            <span style={{ color: s.color, fontWeight: 600, fontSize: 12 }}>{s.type}</span>
                            <span style={{ color: '#888', fontSize: 12 }}> + </span>
                            <span style={{ color: '#00aaff', fontWeight: 500, fontSize: 12 }}>{s.session}</span>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                            <span style={{ color: '#00ff88', fontWeight: 700, fontSize: 14 }}>{s.winRate}%</span>
                            <span style={{ color: '#666', fontSize: 11 }}>({s.trades} trades)</span>
                            <span style={{
                              color: s.pnl >= 0 ? '#00ff88' : '#ff4466',
                              fontWeight: 600,
                              fontSize: 12
                            }}>
                              {s.pnl >= 0 ? '+' : ''}${s.pnl.toLocaleString()}
                            </span>
                          </div>
                        </div>
                      ))}
                      {topScenarios.length === 0 && (
                        <div style={{ color: '#666', fontSize: 12, padding: 12 }}>Need more trade data to analyze trends</div>
                      )}
                    </div>
                  </div>

                  {/* Worst Performing Scenarios */}
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 600, color: '#ff4466', marginBottom: 12 }}>‚ö†Ô∏è Lowest Win Rate Scenarios</div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {bottomScenarios.map((s, i) => (
                        <div key={i} style={{
                          padding: 12,
                          background: 'rgba(255,68,102,0.08)',
                          border: '1px solid rgba(255,68,102,0.2)',
                          borderRadius: 8,
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}>
                          <div>
                            <span style={{ color: s.color, fontWeight: 600, fontSize: 12 }}>{s.type}</span>
                            <span style={{ color: '#888', fontSize: 12 }}> + </span>
                            <span style={{ color: '#00aaff', fontWeight: 500, fontSize: 12 }}>{s.session}</span>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                            <span style={{ color: '#ff4466', fontWeight: 700, fontSize: 14 }}>{s.winRate}%</span>
                            <span style={{ color: '#666', fontSize: 11 }}>({s.trades} trades)</span>
                            <span style={{
                              color: s.pnl >= 0 ? '#00ff88' : '#ff4466',
                              fontWeight: 600,
                              fontSize: 12
                            }}>
                              {s.pnl >= 0 ? '+' : ''}${s.pnl.toLocaleString()}
                            </span>
                          </div>
                        </div>
                      ))}
                      {bottomScenarios.length === 0 && (
                        <div style={{ color: '#666', fontSize: 12, padding: 12 }}>Need more trade data to analyze trends</div>
                      )}
                    </div>
                  </div>
                </div>

                {/* Recommendation based on trends */}
                {topScenarios.length > 0 && (
                  <div style={{
                    marginTop: 20,
                    padding: 16,
                    background: 'rgba(0,0,0,0.3)',
                    borderRadius: 12,
                    border: '1px solid rgba(147,112,219,0.2)'
                  }}>
                    <div style={{ fontSize: 12, color: '#9370DB', fontWeight: 600, marginBottom: 8 }}>üí° TREND RECOMMENDATION</div>
                    <div style={{ fontSize: 13, color: '#fff' }}>
                      Focus on <span style={{ color: topScenarios[0]?.color, fontWeight: 600 }}>{topScenarios[0]?.type}</span> entries during <span style={{ color: '#00aaff', fontWeight: 600 }}>{topScenarios[0]?.session}</span> session for highest probability setups ({topScenarios[0]?.winRate}% win rate).
                      {bottomScenarios.length > 0 && bottomScenarios[0]?.winRate < 40 && (
                        <span> Avoid <span style={{ color: '#ff4466' }}>{bottomScenarios[0]?.type} + {bottomScenarios[0]?.session}</span> ({bottomScenarios[0]?.winRate}% WR).</span>
                      )}
                    </div>
                  </div>
                )}
              </div>
            );
          })()}
        </div>
      )}

      {/* ============================================ */}
      {/* PERFORMANCE VIEW (Original Content) */}
      {/* ============================================ */}
      {viewMode === 'performance' && (
      <>
      {/* Summary Stats Grid */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: isMobile ? 'repeat(2, 1fr)' : 'repeat(5, 1fr)',
        gap: 16,
        marginBottom: 24
      }}>
        {/* Win Rate */}
        <div style={{
          padding: 20,
          background: 'linear-gradient(135deg, rgba(0,255,136,0.1) 0%, rgba(0,200,100,0.05) 100%)',
          border: '1px solid rgba(0,255,136,0.3)',
          borderRadius: 12,
        }}>
          <div style={{ fontSize: 11, color: '#888', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 8 }}>Win Rate</div>
          <div style={{ fontSize: 32, fontWeight: 700, color: '#00ff88' }}>{filteredStats?.win_rate || summary.win_rate}%</div>
          <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>
            {filteredStats?.wins || summary.wins}W - {filteredStats?.losses || summary.losses}L
          </div>
        </div>

        {/* Total P&L */}
        <div style={{
          padding: 20,
          background: summary.total_pnl >= 0 ? 'rgba(0,255,136,0.05)' : 'rgba(255,68,102,0.05)',
          border: `1px solid ${summary.total_pnl >= 0 ? 'rgba(0,255,136,0.2)' : 'rgba(255,68,102,0.2)'}`,
          borderRadius: 12,
        }}>
          <div style={{ fontSize: 11, color: '#888', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 8 }}>Total P&L</div>
          <div style={{ fontSize: 28, fontWeight: 700, color: summary.total_pnl >= 0 ? '#00ff88' : '#ff4466' }}>
            ${(filteredStats?.pnl || summary.total_pnl).toLocaleString()}
          </div>
          <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>
            {((filteredStats?.pnl || summary.total_pnl) / 10).toFixed(0)} pts
          </div>
        </div>

        {/* Avg R:R */}
        <div style={{
          padding: 20,
          background: 'rgba(0,170,255,0.05)',
          border: '1px solid rgba(0,170,255,0.2)',
          borderRadius: 12,
        }}>
          <div style={{ fontSize: 11, color: '#888', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 8 }}>Avg R:R</div>
          <div style={{ fontSize: 28, fontWeight: 700, color: '#00aaff' }}>
            {filteredStats?.avg_rr || 0}:1
          </div>
          <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>Risk/Reward</div>
        </div>

        {/* Avg MAE */}
        <div style={{
          padding: 20,
          background: 'rgba(255,170,0,0.05)',
          border: '1px solid rgba(255,170,0,0.2)',
          borderRadius: 12,
        }}>
          <div style={{ fontSize: 11, color: '#888', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 8 }}>Avg Drawdown</div>
          <div style={{ fontSize: 28, fontWeight: 700, color: '#ffaa00' }}>
            ${drawdown.avg_mae_dollars?.toLocaleString()}
          </div>
          <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>
            {drawdown.avg_mae_pts} pts MAE
          </div>
        </div>

        {/* Max Drawdown */}
        <div style={{
          padding: 20,
          background: 'rgba(255,68,102,0.05)',
          border: '1px solid rgba(255,68,102,0.2)',
          borderRadius: 12,
        }}>
          <div style={{ fontSize: 11, color: '#888', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 8 }}>Max Drawdown</div>
          <div style={{ fontSize: 28, fontWeight: 700, color: '#ff4466' }}>
            ${drawdown.max_mae_dollars?.toLocaleString()}
          </div>
          <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>Worst MAE</div>
        </div>
      </div>

      {/* Comparison: HIGH vs MEDIUM Confidence */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)',
        gap: 24,
        marginBottom: 24
      }}>
        {/* HIGH Confidence Box */}
        <div style={{
          padding: 24,
          background: 'linear-gradient(135deg, rgba(0,255,136,0.08) 0%, rgba(0,200,100,0.02) 100%)',
          border: '2px solid rgba(0,255,136,0.3)',
          borderRadius: 16,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 20 }}>
            <div style={{ width: 12, height: 12, borderRadius: '50%', background: '#00ff88' }} />
            <span style={{ fontSize: 16, fontWeight: 700, color: '#00ff88' }}>HIGH Confidence Trades</span>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16 }}>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>Count</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#fff' }}>{by_confidence.HIGH?.count || 0}</div>
            </div>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>Win Rate</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#00ff88' }}>{by_confidence.HIGH?.win_rate || 0}%</div>
            </div>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>P&L</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#00ff88' }}>${(by_confidence.HIGH?.pnl || 0).toLocaleString()}</div>
            </div>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>Avg R:R</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#00aaff' }}>{by_confidence.HIGH?.avg_rr || 0}:1</div>
            </div>
          </div>
        </div>

        {/* MEDIUM Confidence Box */}
        <div style={{
          padding: 24,
          background: 'linear-gradient(135deg, rgba(255,170,0,0.08) 0%, rgba(200,130,0,0.02) 100%)',
          border: '2px solid rgba(255,170,0,0.3)',
          borderRadius: 16,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 20 }}>
            <div style={{ width: 12, height: 12, borderRadius: '50%', background: '#ffaa00' }} />
            <span style={{ fontSize: 16, fontWeight: 700, color: '#ffaa00' }}>MEDIUM Confidence Trades</span>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16 }}>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>Count</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#fff' }}>{by_confidence.MEDIUM?.count || 0}</div>
            </div>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>Win Rate</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#ffaa00' }}>{by_confidence.MEDIUM?.win_rate || 0}%</div>
            </div>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>P&L</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#ffaa00' }}>${(by_confidence.MEDIUM?.pnl || 0).toLocaleString()}</div>
            </div>
            <div>
              <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>Avg R:R</div>
              <div style={{ fontSize: 24, fontWeight: 700, color: '#00aaff' }}>{by_confidence.MEDIUM?.avg_rr || 0}:1</div>
            </div>
          </div>
        </div>
      </div>

      {/* Direction Analysis + Target Hit Rates */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: isMobile ? '1fr' : 'repeat(3, 1fr)',
        gap: 16,
        marginBottom: 24
      }}>
        {/* LONG Performance */}
        <div style={{
          padding: 20,
          background: 'rgba(0,200,100,0.05)',
          border: '1px solid rgba(0,200,100,0.2)',
          borderRadius: 12,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
            <span style={{ fontSize: 20 }}>üìà</span>
            <span style={{ fontSize: 14, fontWeight: 600, color: '#00cc66' }}>LONG Trades</span>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 }}>
            <div>
              <div style={{ fontSize: 10, color: '#666' }}>Wins</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: '#00ff88' }}>{by_direction.LONG?.wins || 0}</div>
            </div>
            <div>
              <div style={{ fontSize: 10, color: '#666' }}>P&L</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: '#00ff88' }}>${(by_direction.LONG?.pnl || 0).toLocaleString()}</div>
            </div>
          </div>
        </div>

        {/* SHORT Performance */}
        <div style={{
          padding: 20,
          background: 'rgba(255,100,100,0.05)',
          border: '1px solid rgba(255,100,100,0.2)',
          borderRadius: 12,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
            <span style={{ fontSize: 20 }}>üìâ</span>
            <span style={{ fontSize: 14, fontWeight: 600, color: '#ff6666' }}>SHORT Trades</span>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 }}>
            <div>
              <div style={{ fontSize: 10, color: '#666' }}>Wins</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: '#00ff88' }}>{by_direction.SHORT?.wins || 0}</div>
            </div>
            <div>
              <div style={{ fontSize: 10, color: '#666' }}>P&L</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: '#00ff88' }}>${(by_direction.SHORT?.pnl || 0).toLocaleString()}</div>
            </div>
          </div>
        </div>

        {/* Target Hit Rates */}
        <div style={{
          padding: 20,
          background: 'rgba(0,170,255,0.05)',
          border: '1px solid rgba(0,170,255,0.2)',
          borderRadius: 12,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
            <span style={{ fontSize: 20 }}>üéØ</span>
            <span style={{ fontSize: 14, fontWeight: 600, color: '#00aaff' }}>Target Hit Rates</span>
          </div>
          <div style={{ display: 'flex', gap: 16, justifyContent: 'space-between' }}>
            {[
              { label: 'T1', rate: target_hit_rates.t1, color: '#00ff88' },
              { label: 'T2', rate: target_hit_rates.t2, color: '#00aaff' },
              { label: 'T3', rate: target_hit_rates.t3, color: '#ffaa00' },
            ].map(t => (
              <div key={t.label} style={{ textAlign: 'center', flex: 1 }}>
                <div style={{ fontSize: 10, color: '#666', marginBottom: 4 }}>{t.label}</div>
                <div style={{ fontSize: 22, fontWeight: 700, color: t.color }}>{t.rate}%</div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Trade Log Table */}
      <div style={{
        background: 'rgba(255,255,255,0.02)',
        border: '1px solid rgba(255,255,255,0.08)',
        borderRadius: 16,
        overflow: 'hidden',
      }}>
        <div style={{
          padding: '16px 20px',
          borderBottom: '1px solid rgba(255,255,255,0.08)',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
        }}>
          <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600, color: '#fff' }}>Trade Log</h3>
          <span style={{ fontSize: 12, color: '#888' }}>{filteredTrades.length} trades</span>
        </div>

        <div style={{ overflowX: 'auto' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: 900 }}>
            <thead>
              <tr style={{ background: 'rgba(0,0,0,0.3)' }}>
                {['Time', 'Contract', 'Dir', 'Conf', 'Entry', 'Result', 'P&L', 'MAE', 'MFE', 'R:R', 'T1', 'T2', 'T3'].map(h => (
                  <th key={h} style={{
                    padding: '12px 16px',
                    textAlign: 'left',
                    fontSize: 10,
                    color: '#666',
                    textTransform: 'uppercase',
                    letterSpacing: 1,
                    fontWeight: 600,
                    borderBottom: '1px solid rgba(255,255,255,0.05)',
                  }}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {filteredTrades.map((trade, idx) => (
                <tr key={idx} style={{
                  background: idx % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.01)',
                  transition: 'background 0.2s',
                }}>
                  <td style={{ padding: '12px 16px', fontSize: 12, color: '#888' }}>
                    {trade.signal_time || new Date(trade.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                  </td>
                  <td style={{ padding: '12px 16px', fontSize: 12, color: '#fff', fontWeight: 500 }}>{trade.contract}</td>
                  <td style={{ padding: '12px 16px' }}>
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 10,
                      fontWeight: 700,
                      background: trade.direction === 'LONG' ? 'rgba(0,200,100,0.2)' : 'rgba(255,100,100,0.2)',
                      color: trade.direction === 'LONG' ? '#00cc66' : '#ff6666',
                    }}>{trade.direction}</span>
                  </td>
                  <td style={{ padding: '12px 16px' }}>
                    <span style={{
                      padding: '3px 8px',
                      borderRadius: 4,
                      fontSize: 10,
                      fontWeight: 700,
                      background: trade.confidence === 'HIGH' ? 'rgba(0,255,136,0.2)' : 'rgba(255,170,0,0.2)',
                      color: trade.confidence === 'HIGH' ? '#00ff88' : '#ffaa00',
                    }}>{trade.confidence}</span>
                  </td>
                  <td style={{ padding: '12px 16px', fontSize: 13, color: '#fff', fontFamily: 'monospace' }}>
                    ${trade.entry?.toFixed(1)}
                  </td>
                  <td style={{ padding: '12px 16px' }}>
                    <span style={{
                      padding: '4px 10px',
                      borderRadius: 4,
                      fontSize: 11,
                      fontWeight: 700,
                      background: trade.result === 'WIN' ? 'rgba(0,255,136,0.2)' : 'rgba(255,68,102,0.2)',
                      color: trade.result === 'WIN' ? '#00ff88' : '#ff4466',
                    }}>{trade.result}</span>
                  </td>
                  <td style={{
                    padding: '12px 16px',
                    fontSize: 13,
                    fontWeight: 600,
                    color: trade.pnl_dollars >= 0 ? '#00ff88' : '#ff4466',
                    fontFamily: 'monospace',
                  }}>
                    {trade.pnl_dollars >= 0 ? '+' : ''}${trade.pnl_dollars?.toLocaleString()}
                  </td>
                  <td style={{ padding: '12px 16px', fontSize: 12, color: '#ff8866', fontFamily: 'monospace' }}>
                    {trade.mae?.toFixed(0)} pts
                  </td>
                  <td style={{ padding: '12px 16px', fontSize: 12, color: '#66ff88', fontFamily: 'monospace' }}>
                    {trade.mfe?.toFixed(0)} pts
                  </td>
                  <td style={{ padding: '12px 16px', fontSize: 12, color: '#00aaff', fontFamily: 'monospace' }}>
                    {trade.rr > 0 ? trade.rr.toFixed(1) : '-'}
                  </td>
                  <td style={{ padding: '12px 16px' }}>
                    {trade.t1_hit ? <span style={{ color: '#00ff88' }}>‚úì</span> : <span style={{ color: '#444' }}>-</span>}
                  </td>
                  <td style={{ padding: '12px 16px' }}>
                    {trade.t2_hit ? <span style={{ color: '#00ff88' }}>‚úì</span> : <span style={{ color: '#444' }}>-</span>}
                  </td>
                  <td style={{ padding: '12px 16px' }}>
                    {trade.t3_hit ? <span style={{ color: '#00ff88' }}>‚úì</span> : <span style={{ color: '#444' }}>-</span>}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Key Insights */}
      <div style={{
        marginTop: 24,
        padding: 20,
        background: 'linear-gradient(135deg, rgba(0,170,255,0.08) 0%, rgba(0,100,200,0.02) 100%)',
        border: '1px solid rgba(0,170,255,0.2)',
        borderRadius: 12,
      }}>
        <h3 style={{ margin: '0 0 16px', fontSize: 14, fontWeight: 600, color: '#00aaff' }}>üìä Key Insights</h3>
        <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : 'repeat(2, 1fr)', gap: 16, fontSize: 13, color: '#ccc' }}>
          <div>‚Ä¢ <strong style={{ color: '#00ff88' }}>HIGH confidence</strong> trades: {by_confidence.HIGH?.count || 0} signals, ${(by_confidence.HIGH?.pnl || 0).toLocaleString()} profit</div>
          <div>‚Ä¢ <strong style={{ color: '#ffaa00' }}>MEDIUM confidence</strong> trades: {by_confidence.MEDIUM?.count || 0} signals, ${(by_confidence.MEDIUM?.pnl || 0).toLocaleString()} profit</div>
          <div>‚Ä¢ Target 1 hit rate: <strong style={{ color: '#00ff88' }}>{target_hit_rates.t1}%</strong> - highly reliable first targets</div>
          <div>‚Ä¢ Avg MFE: <strong style={{ color: '#66ff88' }}>{drawdown.avg_mfe_pts} pts</strong> - maximum favorable excursion</div>
          <div>‚Ä¢ Avg MAE: <strong style={{ color: '#ff8866' }}>{drawdown.avg_mae_pts} pts</strong> - expect temporary drawdowns</div>
          <div>‚Ä¢ Max drawdown: <strong style={{ color: '#ff4466' }}>${drawdown.max_mae_dollars?.toLocaleString()}</strong> - worst case scenario</div>
        </div>
      </div>
      </>
      )}
    </div>
  );
};

// Main App Component
const App = () => {
  const { isMobile, isTablet } = useResponsive();
  const [user, setUser] = useLocalStorage('horizon_user', null);
  const [activeTab, setActiveTab] = useState('backtest');
  const [settings, setSettings] = useLocalStorage('horizon_settings', DEFAULT_SETTINGS);
  const [dateRange, setDateRange] = useState({ start: '2021-01-01', end: '2026-12-31' });
  const [selectedContract, setSelectedContract] = useLocalStorage('horizon_contract', 'GCJ26');

  // Sync contract to backend on page load (ensures backend matches frontend's saved contract)
  useEffect(() => {
    const syncContract = async () => {
      let assetClass;
      if (selectedContract === 'BTC-SPOT') assetClass = 'BTC-SPOT';
      else if (selectedContract.startsWith('BTC')) assetClass = 'BTC';
      else if (selectedContract.startsWith('GC')) assetClass = 'GC';
      else if (selectedContract.startsWith('NQ')) assetClass = 'NQ';
      else if (selectedContract.startsWith('ES')) assetClass = 'ES';
      else if (selectedContract.startsWith('CL')) assetClass = 'CL';
      else assetClass = 'GC';

      try {
        await fetch(`${API_BASE}/switch-contract`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contract: assetClass })
        });
        console.log(`Synced backend to ${selectedContract} (${assetClass})`);
      } catch (e) {
        console.error('Failed to sync contract on load:', e);
      }
    };
    syncContract();
  }, []); // Run once on mount

  // Connection status tracking for errno 54 and other network errors
  const [connectionStatus, setConnectionStatus] = useState({
    connected: false,
    lastError: null,
    errorCount: 0,
    lastSuccessTime: null,
    reconnectAttempts: 0
  });
  const connectionResetKey = useRef(0);

  const [globalData, setGlobalData] = useState({
    contract: 'GCJ26',
    contract_name: 'Gold Apr 2026',
    current_price: 0,
    current_et_time: '--:--:--',
    current_et_date: ''
  });

  // Horizon AI Chatbot state - single assistant (Claude-powered, unlabeled)
  const [chatOpen, setChatOpen] = useState(false);
  const [chatMessages, setChatMessages] = useState([
    { role: 'assistant', content: 'Welcome to Horizon AI! I can help you analyze market structure, interpret TPO profiles, and provide trading insights based on live data.' }
  ]);
  const [chatInput, setChatInput] = useState('');
  const [chatLoading, setChatLoading] = useState(false);
  const chatEndRef = useRef(null);

  // Auto-scroll chat to bottom
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatMessages]);

  // Initial preload on app mount - warm up caches for all common pages
  useEffect(() => {
    const warmupEndpoints = ['/live', '/tpo', '/zones', '/market-overview', '/historical-sessions?week=current'];
    console.log('Warming up caches...');
    warmupEndpoints.forEach(endpoint => {
      fetch(`${API_BASE}${endpoint}`)
        .then(() => console.log(`Warmed up ${endpoint}`))
        .catch(() => {});
    });
  }, []); // Only run once on mount

  // Preload data for likely next pages based on current tab
  // This makes page transitions feel instant
  useEffect(() => {
    const preloadEndpoints = {
      // When on backtest, preload live metrics
      backtest: ['/live'],
      // When on live, preload TPO and zones
      live: ['/tpo', '/zones'],
      // When on TPO, preload zones
      tpo: ['/zones'],
      // When on zones, preload price ladder data (uses /live)
      zones: ['/live'],
      // When on treemap (correlation matrix), it's already cached on backend
      treemap: [],
      // When on session analysis (vsi), data is cached in localStorage
      vsi: [],
      // When on price ladder, preload TPO
      priceladder: ['/tpo'],
    };

    const endpointsToPreload = preloadEndpoints[activeTab] || [];

    // Also always preload /market-overview for treemap when not on it
    if (activeTab !== 'treemap') {
      endpointsToPreload.push('/market-overview');
    }

    // Preload in the background after a short delay
    const preloadTimer = setTimeout(() => {
      endpointsToPreload.forEach(endpoint => {
        fetch(`${API_BASE}${endpoint}`)
          .then(() => console.log(`Preloaded ${endpoint}`))
          .catch(() => {}); // Ignore errors
      });
    }, 500); // Wait 500ms to not interfere with current page load

    return () => clearTimeout(preloadTimer);
  }, [activeTab]);

  // Send message to Horizon AI assistant
  const sendChatMessage = async () => {
    if (!chatInput.trim() || chatLoading) return;

    const userMessage = chatInput.trim();
    setChatInput('');
    setChatMessages(prev => [...prev, { role: 'user', content: userMessage }]);
    setChatLoading(true);

    // Fetch live metrics for context
    let liveMetrics = {};
    try {
      const metricsResp = await fetch(`${API_BASE}/live`);
      if (metricsResp.ok) {
        liveMetrics = await metricsResp.json();
      }
    } catch (e) { /* ignore */ }

    // Fetch session data for current week
    let sessionData = {};
    try {
      const sessionResp = await fetch(`${API_BASE}/session-ohlc?week=current`);
      if (sessionResp.ok) {
        sessionData = await sessionResp.json();
      }
    } catch (e) { /* ignore */ }

    const context = {
      currentPrice: globalData.current_price,
      contract: globalData.contract,
      contractName: globalData.contract_name,
      currentTime: globalData.current_et_time,
      // Live session metrics
      liveSession: liveMetrics.current_session || null,
      sessionHigh: liveMetrics.session_high || null,
      sessionLow: liveMetrics.session_low || null,
      dayHigh: liveMetrics.day_high || null,
      dayLow: liveMetrics.day_low || null,
      // Previous day levels
      pdHigh: liveMetrics.pd_high || null,
      pdLow: liveMetrics.pd_low || null,
      pdPOC: liveMetrics.pd_poc || null,
      // Volume & Delta
      cumulativeDelta: liveMetrics.cumulative_delta || null,
      buyVolume: liveMetrics.buy_volume || null,
      sellVolume: liveMetrics.sell_volume || null,
      // Session data summary
      sessionData: sessionData.days ? sessionData.days.slice(0, 2) : null // Last 2 days
    };

    try {
      const response = await fetch(`${API_BASE}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userMessage, context, provider: 'claude' })
      });
      if (response.ok) {
        const data = await response.json();
        setChatMessages(prev => [...prev, { role: 'assistant', content: data.response, error: false }]);
      } else {
        const err = await response.json();
        setChatMessages(prev => [...prev, { role: 'assistant', content: err.error || 'Sorry, I encountered an error. Please try again.', error: true }]);
      }
    } catch (e) {
      setChatMessages(prev => [...prev, { role: 'assistant', content: 'Connection error. Please check your connection and try again.', error: true }]);
    }

    setChatLoading(false);
  };

  // ROBUST CONNECTION: Poll for global data with auto-reconnect and near 100% uptime
  useEffect(() => {
    let consecutiveFailures = 0;
    let isAutoReconnecting = false;
    const MAX_CONSECUTIVE_FAILURES = 3;
    const BASE_POLL_INTERVAL = 1000;
    const MAX_POLL_INTERVAL = 5000;

    // Auto-reconnect function
    const triggerAutoReconnect = async () => {
      if (isAutoReconnecting) return;
      isAutoReconnecting = true;
      console.log('üîÑ Auto-reconnecting to backend...');

      try {
        const response = await fetch(`${API_BASE}/reconnect`, { method: 'POST' });
        if (response.ok) {
          console.log('‚úÖ Auto-reconnect triggered successfully');
        }
      } catch (e) {
        console.log('‚ö†Ô∏è Auto-reconnect request failed, backend may be restarting');
      }

      // Wait for backend to stabilize
      await new Promise(resolve => setTimeout(resolve, 2000));
      isAutoReconnecting = false;
    };

    const fetchGlobalData = async () => {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout

        const response = await fetch(API_BASE, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (response.ok) {
          const data = await response.json();

          // Check if data source is actually live (not just HTTP OK)
          const waitingStates = ['INITIALIZING', 'SWITCHING...', 'WAITING_CONNECTION_SLOT', 'RESETTING...', 'DISCONNECTED'];
          const isLiveData = data.data_source &&
                            !waitingStates.includes(data.data_source) &&
                            !data.data_source.includes('RECONNECTING');
          const isReconnecting = data.data_source &&
                                (data.data_source.includes('RECONNECTING') ||
                                 data.data_source === 'WAITING_CONNECTION_SLOT' ||
                                 data.data_source === 'INITIALIZING');

          setGlobalData({
            contract: data.contract || 'GCJ26',
            contract_name: data.contract_name || 'Gold Apr 2026',
            current_price: data.current_price || 0,
            current_et_time: data.current_et_time || '--:--:--',
            current_et_date: data.current_et_date || '',
            available_contracts: data.available_contracts || {},
            data_source: data.data_source || 'DISCONNECTED'
          });

          if (isLiveData) {
            consecutiveFailures = 0;
            setConnectionStatus(prev => ({
              ...prev,
              connected: true,
              lastSuccessTime: new Date().toISOString(),
              reconnectAttempts: 0,
              lastError: null
            }));
          } else {
            // HTTP OK but no live data
            // Don't trigger reconnect if backend is already reconnecting
            if (!isReconnecting) {
              consecutiveFailures++;
              if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES && !isAutoReconnecting) {
                triggerAutoReconnect();
              }
            }
            setConnectionStatus(prev => ({
              ...prev,
              connected: isReconnecting ? 'reconnecting' : false,
              lastError: `Data source: ${data.data_source || 'DISCONNECTED'}`,
              reconnectAttempts: isReconnecting ? prev.reconnectAttempts : prev.reconnectAttempts + 1
            }));
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (e) {
        consecutiveFailures++;
        const errorMsg = e.name === 'AbortError' ? 'Request timeout' : (e.message || 'Unknown error');
        const isNetworkError = errorMsg.includes('ECONNRESET') || errorMsg.includes('connection reset') ||
                              errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError') ||
                              errorMsg.includes('timeout');

        setConnectionStatus(prev => ({
          ...prev,
          connected: false,
          lastError: isNetworkError ? `Network: ${errorMsg}` : errorMsg,
          errorCount: prev.errorCount + 1,
          reconnectAttempts: prev.reconnectAttempts + 1
        }));

        // Auto-reconnect after consecutive failures
        if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES && !isAutoReconnecting) {
          triggerAutoReconnect();
        }
      }
    };

    // Initial fetch
    fetchGlobalData();

    // Adaptive polling - faster when connected, slower when disconnected
    let pollInterval = setInterval(fetchGlobalData, BASE_POLL_INTERVAL);

    // Health check every 30 seconds to ensure connection is still good
    const healthCheck = setInterval(() => {
      if (consecutiveFailures > 0) {
        console.log(`‚ö†Ô∏è Health check: ${consecutiveFailures} consecutive failures`);
      }
    }, 30000);

    return () => {
      clearInterval(pollInterval);
      clearInterval(healthCheck);
    };
  }, [connectionResetKey.current]);

  // Handle contract switch
  const handleContractSwitch = async (newContract) => {
    // Map dropdown value to asset class (e.g., GCG26 -> GC, NQH26 -> NQ, BTCG26 -> BTC)
    // Special case: BTC-SPOT is passed directly
    let assetClass;
    if (newContract === 'BTC-SPOT') assetClass = 'BTC-SPOT';
    else if (newContract.startsWith('BTC')) assetClass = 'BTC';
    else if (newContract.startsWith('GC')) assetClass = 'GC';
    else if (newContract.startsWith('NQ')) assetClass = 'NQ';
    else if (newContract.startsWith('ES')) assetClass = 'ES';
    else if (newContract.startsWith('CL')) assetClass = 'CL';
    else assetClass = CONTRACTS[newContract]?.asset || 'GC';

    // Update dropdown selection immediately
    setSelectedContract(newContract);

    // Show switching state in UI
    setGlobalData(prev => ({
      ...prev,
      data_source: 'SWITCHING...',
      current_price: 0
    }));

    try {
      const response = await fetch(`${API_BASE}/switch-contract`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contract: assetClass })
      });
      if (response.ok) {
        // Clear localStorage cache for TPO to force fresh fetch
        localStorage.removeItem('tpo_historic_cache');
        console.log(`Switched to ${newContract} (${assetClass})`);

        // Poll until we get data for the new contract (up to 10 seconds)
        const expectedContract = newContract === 'BTC-SPOT' ? 'BTC-SPOT' : CONTRACTS[newContract]?.symbol || newContract;
        let attempts = 0;
        const maxAttempts = 20;

        const pollForNewData = async () => {
          try {
            const dataResponse = await fetch(API_BASE);
            if (dataResponse.ok) {
              const data = await dataResponse.json();
              // Check if backend has switched to the new contract
              if (data.contract === expectedContract || data.asset_class === assetClass || attempts >= maxAttempts) {
                setGlobalData({
                  contract: data.contract || newContract,
                  contract_name: data.contract_name || CONTRACTS[newContract]?.name || newContract,
                  current_price: data.current_price || 0,
                  current_et_time: data.current_et_time || '--:--:--',
                  current_et_date: data.current_et_date || '',
                  available_contracts: data.available_contracts || {},
                  data_source: data.data_source || 'SWITCHING...'
                });
                return; // Done polling
              }
            }
          } catch (e) {
            console.log('Polling for new contract data...');
          }

          attempts++;
          if (attempts < maxAttempts) {
            setTimeout(pollForNewData, 500);
          }
        };

        // Start polling after a short delay to let backend switch
        setTimeout(pollForNewData, 500);
      }
    } catch (e) {
      console.error('Failed to switch contract:', e);
      // Revert to previous state on error
      setGlobalData(prev => ({
        ...prev,
        data_source: 'ERROR'
      }));
    }
  };

  // Reset connection - clears error state and triggers reconnect
  const handleResetConnection = async () => {
    // Reset frontend connection state
    setConnectionStatus({
      connected: false,
      lastError: null,
      errorCount: 0,
      lastSuccessTime: null,
      reconnectAttempts: 0
    });
    connectionResetKey.current += 1;
    console.log('Connection reset triggered');

    // Call backend /reconnect endpoint to force Databento reconnection
    try {
      const response = await fetch(`${API_BASE}/reconnect`, { method: 'POST' });
      if (response.ok) {
        const data = await response.json();
        console.log('Backend reconnect:', data.message);
      }
    } catch (e) {
      console.error('Failed to trigger backend reconnect:', e);
    }
  };

  // Load real backtest data from JSON file
  const {
    trades: realTrades,
    stats: realStats,
    source: dataSource,
    metadata: backtestMetadata,
    sessions: backtestSessions,
    volumeProfiles: backtestVolumeProfiles,
    bigVolumeDays: backtestBigVolumeDays,
    supportResistance: backtestSupportResistance,
    seasonality: backtestSeasonality,
    dailyCandles: backtestDailyCandles,
    hourlyCandles: backtestHourlyCandles,
    featureStatistics: backtestFeatureStats,
    distributions: backtestDistributions
  } = useBacktestData();

  // Extended data for backtest dashboard
  const backtestExtendedData = useMemo(() => ({
    metadata: backtestMetadata,
    sessions: backtestSessions,
    volumeProfiles: backtestVolumeProfiles,
    bigVolumeDays: backtestBigVolumeDays,
    supportResistance: backtestSupportResistance,
    seasonality: backtestSeasonality,
    dailyCandles: backtestDailyCandles,
    hourlyCandles: backtestHourlyCandles,
    featureStatistics: backtestFeatureStats,
    distributions: backtestDistributions
  }), [backtestMetadata, backtestSessions, backtestVolumeProfiles, backtestBigVolumeDays, backtestSupportResistance, backtestSeasonality, backtestDailyCandles, backtestHourlyCandles, backtestFeatureStats, backtestDistributions]);

  // Use real trades if available, otherwise generate mock
  const allTrades = useMemo(() => {
    if (realTrades && realTrades.length > 0) {
      return realTrades;
    }
    return generateMockTrades(settings);
  }, [realTrades, settings]);

  // Update date range based on actual data
  useEffect(() => {
    if (realTrades && realTrades.length > 0) {
      const dates = realTrades.map(t => t.date).sort();
      setDateRange({
        start: dates[0],
        end: dates[dates.length - 1]
      });
    }
  }, [realTrades]);

  const filteredTrades = useMemo(() => {
    return allTrades.filter(t => {
      // Date filter
      if (t.date < dateRange.start || t.date > dateRange.end) return false;

      // Delta threshold filter - trades must have delta at or below threshold (skip if no delta field)
      if (t.delta !== undefined && t.delta > settings.deltaThreshold) return false;

      // Buying imbalance filter - winning trades should meet the threshold (skip if no buyingImbalance field)
      if (t.pnl > 0 && t.buyingImbalance !== undefined && t.buyingImbalance < settings.buyingImbalancePct) return false;

      // Grade filter (A, B, C, F) - only filter out if explicitly set to false
      if (settings.filters?.grades && t.grade && settings.filters.grades[t.grade] === false) return false;

      // Tier filter (1, 2, 3) - only apply if trade has tier and filters are set
      if (settings.filters?.tiers && t.tier && !settings.filters.tiers[t.tier]) return false;

      // Min R-Multiple filter
      if (settings.filters?.minR !== undefined && t.r !== undefined && t.r < settings.filters.minR) return false;

      return true;
    });
  }, [allTrades, dateRange, settings.deltaThreshold, settings.buyingImbalancePct, settings.filters]);

  const backtestData = useMemo(() => calculateAnalytics(filteredTrades, settings), [filteredTrades, settings]);

  // Fallback metrics - all 0s, will be replaced by live Databento data
  const liveMetrics = {
    ticker: 'GC1!',
    current_price: 0,
    delta_5m: 0,
    delta_30m: 0,
    cumulative_delta: 0,
    ib_high: 0,
    ib_low: 0,
    ib_midpoint: 0,
    ib_range: 0,
    pdpoc: 0,
    pd_high: 0,
    pd_low: 0,
    vwap: 0,
    buying_imbalance_pct: 0,
    absorption_ratio: 0,
    stacked_buy_imbalances: 0,
    current_phase: 'LOADING',
    last_update: new Date().toISOString()
  };

  const handleLogin = (userData) => setUser(userData);
  const handleLogout = () => setUser(null);

  if (!user) {
    return <LoginPage onLogin={handleLogin} />;
  }

  return (
    <SettingsContext.Provider value={settings}>
      <AuthContext.Provider value={user}>
        <div style={styles.app}>
          <Navigation
            activeTab={activeTab}
            setActiveTab={setActiveTab}
            onLogout={handleLogout}
          />

          <main style={{ ...styles.main, padding: isMobile ? '12px' : '24px', paddingBottom: isMobile ? '85px' : '80px' }}>
            {activeTab === 'backtest' && (
              <BacktestDashboard
                data={backtestData}
                trades={filteredTrades}
                dateRange={dateRange}
                setDateRange={setDateRange}
                extendedData={backtestExtendedData}
              />
            )}
            {activeTab === 'live' && <LiveDashboard settings={settings} onSettingsChange={setSettings} />}
            {activeTab === 'tpo' && <MarketProfile selectedContract={selectedContract} />}
            {activeTab === 'zones' && <ZoneParticipation />}
            {activeTab === 'clawd' && <ClawdAnalytics selectedContract={selectedContract} />}
            {activeTab === 'treemap' && <CorrelationMatrix />}
            {activeTab === 'vsi' && <VSIAnalysis selectedContract={selectedContract} />}
            {activeTab === 'trades' && <TradeLog trades={allTrades} dateRange={dateRange} />}
            {activeTab === 'priceladder' && <PriceLadderWrapper selectedContract={selectedContract} />}
            {activeTab === 'settings' && (
              <SettingsPanel
                settings={settings}
                onSettingsChange={setSettings}
                trades={filteredTrades}
                dateRange={dateRange}
                connectionStatus={connectionStatus}
                onResetConnection={handleResetConnection}
              />
            )}
            {activeTab === 'redfolder' && <RedFolderDashboard />}
          </main>

          <footer style={styles.footer}>
            <span>Project Horizon v2.0 | Underground Setup Strategy</span>
            <span>{CONTRACTS[selectedContract]?.name || 'GC Futures'} | 2025 Market Regime</span>
          </footer>

          {/* Horizon AI Chatbot */}
          {chatOpen && (
            <div style={{
              position: 'fixed',
              bottom: isMobile ? 70 : 100,
              right: isMobile ? 10 : 24,
              left: isMobile ? 10 : 'auto',
              width: isMobile ? 'auto' : 380,
              height: isMobile ? 'calc(100vh - 150px)' : 500,
              maxHeight: isMobile ? '70vh' : 500,
              background: 'linear-gradient(180deg, rgba(12,12,18,0.98) 0%, rgba(8,8,14,1) 100%)',
              borderRadius: 16,
              border: '1px solid rgba(0,255,136,0.3)',
              boxShadow: '0 8px 32px rgba(0,0,0,0.6), 0 0 20px rgba(0,255,136,0.1)',
              display: 'flex',
              flexDirection: 'column',
              zIndex: 1000,
              overflow: 'hidden'
            }}>
              {/* Chat Header */}
              <div style={{
                padding: '16px 20px',
                borderBottom: '1px solid rgba(255,255,255,0.1)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                background: 'rgba(0,255,136,0.05)'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                  <div style={{
                    width: 32,
                    height: 32,
                    borderRadius: 8,
                    background: 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: 14,
                    fontWeight: 700,
                    color: '#000'
                  }}>H</div>
                  <div>
                    <div style={{ fontWeight: 600, fontSize: 14, color: '#fff' }}>Horizon AI</div>
                    <div style={{ fontSize: 10, color: '#00ff88' }}>Trading Assistant</div>
                  </div>
                </div>
                <button
                  onClick={() => setChatOpen(false)}
                  style={{
                    background: 'transparent',
                    border: 'none',
                    color: '#666',
                    fontSize: 20,
                    cursor: 'pointer',
                    padding: 4
                  }}
                >√ó</button>
              </div>

              {/* Chat Messages */}
              <div style={{
                flex: 1,
                overflowY: 'auto',
                padding: 16,
                display: 'flex',
                flexDirection: 'column',
                gap: 12
              }}>
                {chatMessages.map((msg, i) => (
                  <div key={i} style={{
                    alignSelf: msg.role === 'user' ? 'flex-end' : 'flex-start',
                    maxWidth: msg.role === 'user' ? '85%' : '95%',
                    width: msg.role === 'user' ? 'auto' : '95%'
                  }}>
                    <div style={{
                      padding: msg.role === 'assistant' ? '14px 16px' : '10px 14px',
                      borderRadius: msg.role === 'user' ? '14px 14px 4px 14px' : '14px 14px 14px 4px',
                      background: msg.role === 'user'
                        ? 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)'
                        : 'rgba(255,255,255,0.06)',
                      border: msg.role === 'user' ? 'none' : '1px solid rgba(255,255,255,0.1)',
                      color: msg.role === 'user' ? '#000' : msg.error ? '#ff6b6b' : '#e8e8e8',
                      fontSize: 13,
                      lineHeight: 1.6,
                      fontWeight: msg.role === 'user' ? 500 : 400
                    }}>
                      {msg.role === 'assistant' ? (
                        <div dangerouslySetInnerHTML={{
                          __html: msg.content
                            .replace(/\*\*(.+?)\*\*/g, '<strong style="color:#00ff88">$1</strong>')
                            .replace(/\*(.+?)\*/g, '<em>$1</em>')
                            .replace(/`(.+?)`/g, '<code style="background:rgba(0,255,136,0.15);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:12px">$1</code>')
                            .replace(/\n- /g, '<br/>‚Ä¢ ')
                            .replace(/\n\d+\. /g, (m) => '<br/>' + m.trim() + ' ')
                            .replace(/\n\n/g, '</p><p style="margin:8px 0">')
                            .replace(/\n/g, '<br/>')
                        }} />
                      ) : msg.content}
                    </div>
                  </div>
                ))}
                {chatLoading && (
                  <div style={{
                    alignSelf: 'flex-start',
                    width: '95%'
                  }}>
                    <div style={{
                      padding: '14px 16px',
                      borderRadius: '14px 14px 14px 4px',
                      background: 'rgba(255,255,255,0.06)',
                      border: '1px solid rgba(255,255,255,0.1)',
                      color: '#888',
                      fontSize: 13,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 8
                    }}>
                      <div style={{
                        width: 6,
                        height: 6,
                        borderRadius: '50%',
                        background: '#00ff88',
                        animation: 'pulse 1.5s ease-in-out infinite'
                      }} />
                      Analyzing...
                    </div>
                  </div>
                )}
                <div ref={chatEndRef} />
              </div>

              {/* Chat Input */}
              <div style={{
                padding: 12,
                borderTop: '1px solid rgba(255,255,255,0.1)',
                display: 'flex',
                gap: 8
              }}>
                <input
                  type="text"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
                  placeholder="Ask about trading..."
                  style={{
                    flex: 1,
                    padding: '10px 14px',
                    borderRadius: 10,
                    border: '1px solid rgba(255,255,255,0.15)',
                    background: 'rgba(0,0,0,0.3)',
                    color: '#fff',
                    fontSize: 13,
                    outline: 'none'
                  }}
                />
                <button
                  onClick={sendChatMessage}
                  disabled={chatLoading || !chatInput.trim()}
                  style={{
                    padding: '10px 16px',
                    borderRadius: 10,
                    border: 'none',
                    background: chatInput.trim() && !chatLoading ? 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)' : 'rgba(255,255,255,0.1)',
                    color: chatInput.trim() && !chatLoading ? '#000' : '#666',
                    fontWeight: 600,
                    fontSize: 13,
                    cursor: chatInput.trim() && !chatLoading ? 'pointer' : 'not-allowed'
                  }}
                >
                  Send
                </button>
              </div>
            </div>
          )}

          {/* Floating Horizon Button - positioned higher on mobile */}
          <button
            onClick={() => setChatOpen(!chatOpen)}
            style={{
              position: 'fixed',
              bottom: isMobile ? 75 : 24,
              right: isMobile ? 12 : 24,
              width: chatOpen ? 48 : 'auto',
              height: isMobile ? 40 : 48,
              padding: chatOpen ? 0 : isMobile ? '0 14px' : '0 20px',
              borderRadius: chatOpen ? '50%' : 24,
              border: 'none',
              background: 'linear-gradient(135deg, #00ff88 0%, #00cc6a 100%)',
              color: '#000',
              fontWeight: 700,
              fontSize: isMobile ? 12 : 14,
              cursor: 'pointer',
              boxShadow: '0 4px 20px rgba(0,255,136,0.4)',
              zIndex: 1001,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: 8,
              transition: 'all 0.2s ease'
            }}
          >
            {chatOpen ? '√ó' : (
              <>
                <span style={{ fontSize: 18 }}>H</span>
                <span>Horizon</span>
              </>
            )}
          </button>

          {/* Fixed Floating Footer */}
          <FloatingFooter
            globalData={globalData}
            selectedContract={selectedContract}
            onContractChange={handleContractSwitch}
            contracts={CONTRACTS}
            isMobile={isMobile}
          />

          {/* Vercel Speed Insights */}
          <SpeedInsights />
        </div>
      </AuthContext.Provider>
    </SettingsContext.Provider>
  );
};

// ============================================
// STYLES
// ============================================
const styles = {
  app: {
    minHeight: '100vh',
    background: 'linear-gradient(135deg, #0a0a0f 0%, #12121a 50%, #0a0a0f 100%)',
    color: '#e0e0e0',
    fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
    overflowX: 'hidden',
    width: '100%',
    maxWidth: '100vw',
  },
  main: {
    padding: '24px',
    paddingBottom: '80px', // Space for floating footer
    maxWidth: '1600px',
    margin: '0 auto',
    overflowX: 'hidden',
  },
  footer: {
    display: 'flex',
    justifyContent: 'space-between',
    padding: '16px 24px',
    paddingBottom: '70px', // Space for floating footer
    borderTop: '1px solid rgba(255,255,255,0.05)',
    fontSize: '12px',
    color: '#666',
  },
  loginContainer: {
    minHeight: '100vh',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    background: 'linear-gradient(135deg, #0a0a0f 0%, #12121a 50%, #0a0a0f 100%)',
    padding: '20px',
    fontFamily: "'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
  },
  loginCard: {
    width: '100%',
    maxWidth: '420px',
    background: 'rgba(20,20,28,0.95)',
    border: '1px solid rgba(255,255,255,0.08)',
    borderRadius: '16px',
    padding: '48px 40px',
    boxShadow: '0 25px 50px rgba(0,0,0,0.5)',
    fontFamily: "'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
  },
  loginHeader: { textAlign: 'center', marginBottom: '40px' },
  logo: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', marginBottom: '16px' },
  logoIcon: { width: '36px', height: '36px', display: 'flex', alignItems: 'center', justifyContent: 'center' },
  logoText: { fontSize: '22px', fontWeight: '700', color: '#fff', letterSpacing: '3px', fontFamily: "'Inter', 'SF Pro Display', -apple-system, sans-serif" },
  loginSubtitle: { color: '#888', fontSize: '13px', fontFamily: "'Inter', sans-serif", letterSpacing: '0.5px' },
  loginForm: { display: 'flex', flexDirection: 'column', gap: '20px' },
  inputGroup: { display: 'flex', flexDirection: 'column', gap: '8px' },
  inputLabel: { fontSize: '11px', color: '#888', textTransform: 'uppercase', letterSpacing: '1px', fontFamily: "'Inter', sans-serif" },
  input: { padding: '14px 16px', background: 'rgba(0,0,0,0.4)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '15px', outline: 'none', transition: 'border-color 0.2s', fontFamily: "'Inter', sans-serif" },
  error: { padding: '12px', background: 'rgba(255,68,102,0.1)', border: '1px solid rgba(255,68,102,0.3)', borderRadius: '8px', color: '#ff4466', fontSize: '13px', fontFamily: "'Inter', sans-serif" },
  loginButton: { padding: '16px', background: 'linear-gradient(135deg, #00ff88 0%, #00cc66 100%)', border: 'none', borderRadius: '8px', color: '#000', fontSize: '13px', fontWeight: '700', cursor: 'pointer', textTransform: 'uppercase', letterSpacing: '1px', transition: 'all 0.2s', fontFamily: "'Inter', sans-serif" },
  loginFooter: { textAlign: 'center', marginTop: '32px', paddingTop: '24px', borderTop: '1px solid rgba(255,255,255,0.05)' },
  footerText: { color: '#555', fontSize: '11px', margin: '4px 0', fontFamily: "'Inter', sans-serif" },
  nav: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '16px 24px', background: 'rgba(0,0,0,0.3)', borderBottom: '1px solid rgba(255,255,255,0.05)' },
  navBrand: { display: 'flex', alignItems: 'center', gap: '10px' },
  navLogo: { fontSize: '24px', color: '#00ff88' },
  navTitle: { fontSize: '16px', fontWeight: '700', color: '#fff', letterSpacing: '2px' },
  navTabs: { display: 'flex', gap: '8px' },
  navTab: {
    display: 'flex',
    alignItems: 'center',
    gap: 8,
    padding: '10px 18px',
    background: 'transparent',
    border: '1px solid transparent',
    borderRadius: 8,
    color: '#8b8b8b',
    fontSize: 13,
    fontWeight: 500,
    cursor: 'pointer',
    transition: 'all 0.2s ease'
  },
  navTabActive: { background: 'rgba(0,255,136,0.1)', borderColor: '#00ff88', color: '#00ff88' },
  logoutButton: {
    padding: '10px 20px',
    background: 'transparent',
    border: '1px solid rgba(255,68,102,0.5)',
    borderRadius: 8,
    color: '#ff4466',
    fontSize: 13,
    fontWeight: 600,
    cursor: 'pointer',
    transition: 'all 0.2s ease'
  },
  settingsPanel: { maxWidth: '1200px', margin: '0 auto' },
  settingsHeader: { marginBottom: '32px' },
  settingsSubtitle: { color: '#666', fontSize: '14px', marginTop: '8px' },
  settingsGrid: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '32px' },
  settingsCard: { padding: '16px', background: 'rgba(255,255,255,0.02)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '12px' },
  settingsCardTitle: { fontSize: '14px', fontWeight: '600', color: '#fff', marginBottom: '14px' },
  sliderGroup: { marginBottom: '16px' },
  sliderHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' },
  sliderLabel: { fontSize: '11px', color: '#aaa' },
  sliderValue: { fontSize: '13px', fontWeight: '700', color: '#00ff88' },
  slider: { width: '100%', height: '6px', borderRadius: '3px', background: 'rgba(255,255,255,0.1)', outline: 'none', cursor: 'pointer', WebkitAppearance: 'none' },
  sliderTicks: { display: 'flex', justifyContent: 'space-between', fontSize: '9px', color: '#555', marginTop: '4px' },
  allocationNote: { fontSize: '12px', color: '#888', marginBottom: '16px' },
  tierVisual: { display: 'flex', height: '8px', borderRadius: '4px', overflow: 'hidden', marginTop: '16px' },
  tierBar: { height: '100%', transition: 'width 0.3s' },
  tierLegend: { display: 'flex', justifyContent: 'space-around', fontSize: '11px', color: '#888', marginTop: '12px' },
  settingsActions: { display: 'flex', gap: '16px', justifyContent: 'center', marginBottom: '32px' },
  actionButton: { padding: '14px 32px', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer', transition: 'all 0.2s', border: 'none' },
  resetButton: { background: 'transparent', border: '1px solid rgba(255,255,255,0.2)', color: '#888' },
  applyButton: { background: 'linear-gradient(135deg, #00ff88 0%, #00cc66 100%)', color: '#000' },
  settingsInfo: { padding: '24px', background: 'rgba(0,170,255,0.05)', border: '1px solid rgba(0,170,255,0.2)', borderRadius: '12px' },
  infoTitle: { fontSize: '14px', color: '#00aaff', marginBottom: '16px' },
  infoList: { listStyle: 'none', padding: 0, margin: 0, fontSize: '13px', color: '#888', lineHeight: '1.8' },
  statsContainer: { marginBottom: '32px' },
  sectionTitle: { fontSize: '16px', fontWeight: '600', color: '#fff', marginBottom: '20px' },
  statsGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '16px', marginBottom: '24px' },
  statsCard: { padding: '20px', borderRadius: '12px', border: '1px solid rgba(255,255,255,0.05)' },
  statsTitle: { fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '8px' },
  statsValue: { fontSize: '24px', fontWeight: '700', color: '#fff' },
  statsSubtitle: { fontSize: '12px', color: '#666', marginTop: '4px' },
  statsTrend: { fontSize: '12px', marginTop: '8px', fontWeight: '600' },
  breakdownGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px' },
  breakdownCard: { padding: '20px', background: 'rgba(255,255,255,0.02)', border: '1px solid rgba(255,255,255,0.05)', borderRadius: '12px' },
  breakdownTitle: { fontSize: '12px', color: '#666', textTransform: 'uppercase', marginBottom: '16px' },
  breakdownRow: { display: 'flex', alignItems: 'center', gap: '12px', padding: '10px 0', borderBottom: '1px solid rgba(255,255,255,0.03)' },
  breakdownLabel: { flex: '0 0 100px', fontSize: '13px', color: '#888' },
  breakdownBarContainer: { flex: 1, height: '6px', background: 'rgba(255,255,255,0.05)', borderRadius: '3px', overflow: 'hidden' },
  breakdownBar: { height: '100%', borderRadius: '3px', transition: 'width 0.3s' },
  breakdownCount: { flex: '0 0 40px', textAlign: 'right', fontSize: '13px', color: '#fff' },
  gradeStats: { flex: 1, display: 'flex', justifyContent: 'flex-end', gap: '16px', fontSize: '13px' },
  drillDownContainer: { marginBottom: '32px' },
  yearGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' },
  yearCard: { padding: '20px', borderRadius: '12px', cursor: 'pointer', transition: 'all 0.2s' },
  yearLabel: { fontSize: '24px', fontWeight: '700', color: '#fff', marginBottom: '8px' },
  yearPnl: { fontSize: '20px', fontWeight: '600', marginBottom: '12px' },
  yearStats: { display: 'flex', justifyContent: 'space-between', fontSize: '12px', color: '#888' },
  weekContainer: { marginBottom: '32px' },
  weekGrid: { display: 'flex', gap: '8px', overflowX: 'auto', paddingBottom: '16px' },
  weekBar: { display: 'flex', flexDirection: 'column', alignItems: 'center', minWidth: '40px' },
  weekBarContainer: { width: '32px', height: '100px', background: 'rgba(255,255,255,0.03)', borderRadius: '4px', display: 'flex', alignItems: 'flex-end', overflow: 'hidden' },
  weekBarFill: { width: '100%', borderRadius: '4px 4px 0 0', transition: 'height 0.3s' },
  weekLabel: { fontSize: '10px', color: '#666', marginTop: '8px' },
  weekPnl: { fontSize: '10px', fontWeight: '600', marginTop: '4px' },
  liveDashboard: { maxWidth: '1000px', margin: '0 auto' },
  liveHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' },
  liveTitle: { display: 'flex', alignItems: 'center', gap: '12px', fontSize: '18px', fontWeight: '700', color: '#fff' },
  liveDot: { width: '10px', height: '10px', borderRadius: '50%', background: '#ff4466', animation: 'pulse 2s infinite' },
  liveUpdate: { fontSize: '12px', color: '#888', fontFamily: 'monospace', padding: '8px 12px', background: 'rgba(0,0,0,0.3)', borderRadius: '6px', whiteSpace: 'nowrap' },
  priceDisplay: { textAlign: 'center', padding: '32px', background: 'rgba(255,255,255,0.02)', borderRadius: '16px', marginBottom: '24px' },
  currentPrice: { fontSize: '48px', fontWeight: '700', color: '#fff' },
  deltaDisplay: { fontSize: '18px', marginTop: '8px' },
  levelsGrid: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', marginBottom: '24px' },
  levelCard: { padding: '16px', background: 'rgba(255,255,255,0.02)', border: '1px solid rgba(255,255,255,0.05)', borderRadius: '12px', textAlign: 'center' },
  levelLabel: { fontSize: '11px', color: '#666', textTransform: 'uppercase', marginBottom: '8px' },
  levelValue: { fontSize: '18px', fontWeight: '600', color: '#fff' },
  signalMatrix: { padding: '24px', background: 'rgba(255,255,255,0.02)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: '16px', marginBottom: '24px' },
  signalHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' },
  signalTitle: { fontSize: '14px', fontWeight: '600', color: '#fff', margin: 0 },
  signalCount: { fontSize: '14px', fontWeight: '600' },
  signalGrid: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', marginBottom: '20px' },
  signalItem: { display: 'flex', alignItems: 'center', gap: '10px', padding: '12px 16px', borderRadius: '8px', border: '1px solid' },
  signalIndicator: { width: '10px', height: '10px', borderRadius: '50%' },
  signalName: { fontSize: '12px', color: '#ddd' },
  criticalBadge: { marginLeft: 'auto', fontSize: '10px', fontWeight: '700', color: '#ffaa00', background: 'rgba(255,170,0,0.2)', padding: '2px 6px', borderRadius: '4px' },
  setupStatus: { display: 'flex', alignItems: 'center', gap: '12px', paddingTop: '16px', borderTop: '1px solid rgba(255,255,255,0.05)' },
  phaseLabel: { fontSize: '12px', color: '#666' },
  phaseValue: { fontSize: '14px', fontWeight: '700' },
  orderFlowGrid: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' },
  orderFlowCard: { padding: '20px', background: 'rgba(255,255,255,0.02)', border: '1px solid rgba(255,255,255,0.05)', borderRadius: '12px' },
  ofTitle: { fontSize: '12px', color: '#666', textTransform: 'uppercase', marginBottom: '16px' },
  ofRow: { display: 'flex', justifyContent: 'space-between', padding: '10px 0', borderBottom: '1px solid rgba(255,255,255,0.03)', fontSize: '14px' },
  dashboardHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', flexWrap: 'wrap', gap: '16px' },
  dashboardTitle: { fontSize: '20px', fontWeight: '700', color: '#fff', margin: 0 },
  dateFilter: { display: 'flex', alignItems: 'center', gap: '12px' },
  dateInput: { padding: '10px 14px', background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#fff', fontSize: '13px', cursor: 'pointer' },
  dateSeparator: { color: '#666', fontSize: '13px' },
  filterButton: { padding: '10px 16px', background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', color: '#888', fontSize: '12px', cursor: 'pointer', transition: 'all 0.2s' },
  filterInfo: { fontSize: '13px', color: '#666', marginBottom: '24px', padding: '12px 16px', background: 'rgba(255,255,255,0.02)', borderRadius: '8px', border: '1px solid rgba(255,255,255,0.05)' },
  tradeLog: { maxWidth: '1200px', margin: '0 auto' },
  tradeLogInfo: { fontSize: '13px', color: '#666', marginTop: '8px', marginBottom: '16px' },
  tradeTable: { width: '100%', borderCollapse: 'collapse', marginTop: '16px' },
  th: { padding: '14px 16px', textAlign: 'left', fontSize: '11px', color: '#666', textTransform: 'uppercase', letterSpacing: '1px', borderBottom: '1px solid rgba(255,255,255,0.1)' },
  tr: { transition: 'background 0.2s' },
  td: { padding: '14px 16px', fontSize: '14px', borderBottom: '1px solid rgba(255,255,255,0.03)' },
  gradeBadge: { display: 'inline-block', padding: '4px 10px', borderRadius: '4px', fontSize: '11px', fontWeight: '700', color: '#000' },
  backtestDashboard: { maxWidth: '1400px', margin: '0 auto' },
};

// Add keyframes for pulse animation and slider styling
const styleSheet = document.createElement('style');
styleSheet.textContent = `
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  input:focus {
    border-color: #00ff88 !important;
  }
  button:hover:not(:disabled) {
    transform: translateY(-1px);
  }
  tr:hover {
    background: rgba(255,255,255,0.02);
  }
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255,255,255,0.1);
    height: 8px;
    border-radius: 4px;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #00ff88;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0,255,136,0.5);
  }
  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #00ff88;
    cursor: pointer;
    border: none;
    box-shadow: 0 0 10px rgba(0,255,136,0.5);
  }
  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
  }
`;
document.head.appendChild(styleSheet);

export default App;

